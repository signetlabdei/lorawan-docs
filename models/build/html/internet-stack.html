
<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>16.1. Internet Stack &#8212; Model Library</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/default.css?v=bb97339c" />
    <script src="_static/documentation_options.js?v=316584e3"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="16.2. IPv4" href="ipv4.html" />
    <link rel="prev" title="16. Internet Models (IP, TCP, Routing, UDP)" href="internet-models.html" />
  <link rel="stylesheet" type="text/css"
    href="_static/ns3_stylesheet.css" />
    <link rel="icon" type="image/ico"
      href="_static/favicon.ico" />

  <script type="text/javascript" src="_static/drop-down-menu.js"></script>
  <script type="text/javascript" src="_static/ns3_version.js"></script>
  <script type="text/javascript">var ns3_builder="html";</script>
  <script type="text/javascript" src="_static/ns3_links.js"></script>


  </head><body>
    <div id="titlearea">
      <table cellspacing="0" cellpadding="0" width="100%">
        <tbody>
          <tr style="height: 56px;">
            <td id="projectlogo">
              <a id="ns3_home1"
                 href="http://www.nsnam.org/">
                 <img alt="ns-3 Logo" style="background-color: unset;"
                      src="_static/ns-3-inverted-notext-small.png"/>
              </a>
            </td>
            <td id="projecttext">
              <div id="projectbrief">A Discrete-Event Network Simulator</div>
              <span id="projectnumber"><script type="text/javascript">document.write(ns3_version)</script></span>
            </td>

            <td id="ns3-menu">
              <div class="menu">
                <ul >
                  <li style="background-image:none">
                    <a id="ns3_home2"
                         href="http://www.nsnam.org/"
                         >&nbsp;&nbsp;Home</a>
                  </li>
                  <li><span
                        onmouseover="mopen('mTuts')"
                        onmouseout="mclosetime()"
                          >Tutorials &nbsp;&#x25BC;</span>
                      <div id="mTuts"
                          onmouseover="mcancelclosetime()"
                          onmouseout="mclosetime()">
                        <a id="ns3_tut"
                           href="/docs/tutorial/html/index.html"
                            >English</a><br/>
                      </div>
                  </li>
                  <li><span
                        onmouseover="mopen('mDocs')"
                        onmouseout="mclosetime()"
                          >Documentation &nbsp;&#x25BC;</span>
                      <div id="mDocs"
                          onmouseover="mcancelclosetime()"
                          onmouseout="mclosetime()">
                        <a id="ns3_ins"
                           href="/docs/installation/html/index.html"
                           >Installation</a><br/>
                        <a id="ns3_man"
                           href="/docs/manual/html/index.html"
                           >Manual</a><br/>
                        <a id="ns3_mod"
                           href="/docs/models/html/index.html"
                           >Models</a><br/>
                        <a id="ns3_con"
                           href="/docs/contributing/html/index.html"
                           >Contributing</a><br/>
                        <a id="ns3_wiki"
                           href="http://www.nsnam.org/wiki"
                           >Wiki</a><br/>
                      </div>
                  </li>
                  <li><span
                        onmouseover="mopen('mDev')"
                        onmouseout="mclosetime()"
                          >Development &nbsp;&#x25BC;</span>
                      <div id="mDev"
                          onmouseover="mcancelclosetime()"
                          onmouseout="mclosetime()">
                        <a id="ns3_api"
                           href="/docs/doxygen/html/index.html"
                           >API Docs</a><br/>
                        <a id="ns3_bugs"
                         href="https://gitlab.com/nsnam/ns-3-dev/-/issues"
                           >Issue Tracker</a><br/>
                        <a id="ns3_merge"
                         href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests"
                           >Merge Requests</a><br/>
                      </div>
                  </li>
                </ul>
              </div>
            </td>

            <td id="projectsection">
              <span style="margin-right:10px">Models</span>
            </td>
          </tr>
        </tbody>
      </table>
      <script  type="text/javascript">ns3_write_links()</script>
    </div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ipv4.html" title="16.2. IPv4"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="internet-models.html" title="16. Internet Models (IP, TCP, Routing, UDP)"
             accesskey="P">previous</a> |</li>
    <li class="navelem"><a href="">ns-3</a><span class="navelem">&nbsp;</span></li>
    
        <li class="nav-item nav-item-0"><a href="index.html">Models</a><span class="navelem">&nbsp;</span></li>

          <li class="nav-item nav-item-1"><a href="internet-models.html" accesskey="U"><span class="section-number">16. </span>Internet Models (IP, TCP, Routing, UDP)</a><span class="navelem">&nbsp;</span></li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">16.1. </span>Internet Stack</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="internet-stack">
<h1><span class="section-number">16.1. </span>Internet Stack<a class="headerlink" href="#internet-stack" title="Link to this heading">¶</a></h1>
<section id="internet-stack-aggregation">
<h2><span class="section-number">16.1.1. </span>Internet stack aggregation<a class="headerlink" href="#internet-stack-aggregation" title="Link to this heading">¶</a></h2>
<p>A bare class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Node</span></code> is not very useful as-is; other objects must be
aggregated to it to provide useful node functionality.</p>
<p>The <em>ns-3</em> source code directory <code class="docutils literal notranslate"><span class="pre">src/internet</span></code> provides implementation
of TCP/IPv4- and IPv6-related components. These include IPv4, ARP, UDP, TCP,
IPv6, Neighbor Discovery, and other related protocols.</p>
<p>Internet Nodes are not subclasses of class Node; they are simply Nodes that have
had a bunch of IP-related objects aggregated to them. They can be put together
by hand, or via a helper function <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">InternetStackHelper::Install</span> <span class="pre">()</span></code>
which does the following to all nodes passed in as arguments:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">InternetStackHelper::Install</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_ipv4Enabled</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="cm">/* IPv4 stack */</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">NS_FATAL_ERROR</span><span class="p">(</span><span class="s">&quot;InternetStackHelper::Install(): Aggregating &quot;</span>
<span class="w">                         </span><span class="s">&quot;an InternetStack to a node with an existing Ipv4 object&quot;</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">      </span><span class="n">CreateAndAggregateObjectFromTypeId</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ns3::ArpL3Protocol&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="n">CreateAndAggregateObjectFromTypeId</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ns3::Ipv4L3Protocol&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="n">CreateAndAggregateObjectFromTypeId</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ns3::Icmpv4L4Protocol&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// Set routing</span>
<span class="w">      </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">      </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4RoutingProtocol</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4Routing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_routing</span><span class="o">-&gt;</span><span class="n">Create</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
<span class="w">      </span><span class="n">ipv4</span><span class="o">-&gt;</span><span class="n">SetRoutingProtocol</span><span class="p">(</span><span class="n">ipv4Routing</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_ipv6Enabled</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="cm">/* IPv6 stack */</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">Ipv6</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">NS_FATAL_ERROR</span><span class="p">(</span><span class="s">&quot;InternetStackHelper::Install(): Aggregating &quot;</span>
<span class="w">                         </span><span class="s">&quot;an InternetStack to a node with an existing Ipv6 object&quot;</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">      </span><span class="n">CreateAndAggregateObjectFromTypeId</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ns3::Ipv6L3Protocol&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="n">CreateAndAggregateObjectFromTypeId</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ns3::Icmpv6L4Protocol&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// Set routing</span>
<span class="w">      </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv6</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">Ipv6</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">      </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv6RoutingProtocol</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv6Routing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_routingv6</span><span class="o">-&gt;</span><span class="n">Create</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
<span class="w">      </span><span class="n">ipv6</span><span class="o">-&gt;</span><span class="n">SetRoutingProtocol</span><span class="p">(</span><span class="n">ipv6Routing</span><span class="p">);</span>

<span class="w">      </span><span class="cm">/* register IPv6 extensions and options */</span>
<span class="w">      </span><span class="n">ipv6</span><span class="o">-&gt;</span><span class="n">RegisterExtensions</span><span class="p">();</span>
<span class="w">      </span><span class="n">ipv6</span><span class="o">-&gt;</span><span class="n">RegisterOptions</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_ipv4Enabled</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m_ipv6Enabled</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="cm">/* UDP and TCP stacks */</span>
<span class="w">      </span><span class="n">CreateAndAggregateObjectFromTypeId</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ns3::UdpL4Protocol&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">AggregateObject</span><span class="p">(</span><span class="n">m_tcpFactory</span><span class="p">.</span><span class="n">Create</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">());</span>
<span class="w">      </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">PacketSocketFactory</span><span class="o">&gt;</span><span class="w"> </span><span class="n">factory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">PacketSocketFactory</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">      </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">AggregateObject</span><span class="p">(</span><span class="n">factory</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Where multiple implementations exist in <em>ns-3</em> (TCP, IP routing), these objects
are added by a factory object (TCP) or by a routing helper (m_routing).</p>
<p>Note that the routing protocol is configured and set outside this
function. By default, the following protocols are added:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">InternetStackHelper::Initialize</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">SetTcp</span><span class="p">(</span><span class="s">&quot;ns3::TcpL4Protocol&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">Ipv4StaticRoutingHelper</span><span class="w"> </span><span class="n">staticRouting</span><span class="p">;</span>
<span class="w">  </span><span class="n">Ipv4GlobalRoutingHelper</span><span class="w"> </span><span class="n">globalRouting</span><span class="p">;</span>
<span class="w">  </span><span class="n">Ipv4ListRoutingHelper</span><span class="w"> </span><span class="n">listRouting</span><span class="p">;</span>
<span class="w">  </span><span class="n">Ipv6ListRoutingHelper</span><span class="w"> </span><span class="n">listRoutingv6</span><span class="p">;</span>
<span class="w">  </span><span class="n">Ipv6StaticRoutingHelper</span><span class="w"> </span><span class="n">staticRoutingv6</span><span class="p">;</span>
<span class="w">  </span><span class="n">listRouting</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">staticRouting</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">listRouting</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">globalRouting</span><span class="p">,</span><span class="w"> </span><span class="mi">-10</span><span class="p">);</span>
<span class="w">  </span><span class="n">listRoutingv6</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">staticRoutingv6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">SetRoutingHelper</span><span class="p">(</span><span class="n">listRouting</span><span class="p">);</span>
<span class="w">  </span><span class="n">SetRoutingHelper</span><span class="p">(</span><span class="n">listRoutingv6</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>By default, IPv4 and IPv6 are enabled.</p>
<section id="internet-node-structure">
<h3><span class="section-number">16.1.1.1. </span>Internet Node structure<a class="headerlink" href="#internet-node-structure" title="Link to this heading">¶</a></h3>
<p>An IP-capable Node (an <em>ns-3</em> Node augmented by aggregation to have one or more
IP stacks) has the following internal structure.</p>
<section id="layer-3-protocols">
<h4><span class="section-number">16.1.1.1.1. </span>Layer-3 protocols<a class="headerlink" href="#layer-3-protocols" title="Link to this heading">¶</a></h4>
<p>At the lowest layer, sitting above the NetDevices, are the “layer 3” protocols,
including IPv4, IPv6, ARP and so on. The class
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Ipv4L3Protocol</span></code> is an implementation class whose public interface is
typically class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Ipv4</span></code>, but the
Ipv4L3Protocol public API is also used internally at present.</p>
<p>In class Ipv4L3Protocol, one method described below is <code class="docutils literal notranslate"><span class="pre">Receive</span> <span class="pre">()</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm">  * Lower layer calls this method after calling L3Demux::Lookup</span>
<span class="cm">  * The ARP subclass needs to know from which NetDevice this</span>
<span class="cm">  * packet is coming to:</span>
<span class="cm">  *    - implement a per-NetDevice ARP cache</span>
<span class="cm">  *    - send back arp replies on the right device</span>
<span class="cm">  */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">Receive</span><span class="p">(</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">Packet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">protocol</span><span class="p">,</span>
<span class="k">const</span><span class="w"> </span><span class="n">Address</span><span class="w"> </span><span class="o">&amp;</span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Address</span><span class="w"> </span><span class="o">&amp;</span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="n">NetDevice</span><span class="o">::</span><span class="n">PacketType</span><span class="w"> </span><span class="n">packetType</span><span class="p">);</span>
</pre></div>
</div>
<p>First, note that the <code class="docutils literal notranslate"><span class="pre">Receive</span> <span class="pre">()</span></code> function has a matching signature to the
ReceiveCallback in the class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Node</span></code>. This function pointer is
inserted into the Node’s protocol handler when <code class="docutils literal notranslate"><span class="pre">AddInterface</span> <span class="pre">()</span></code> is called.
The actual registration is done
with a statement such as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">RegisterProtocolHandler</span><span class="p">(</span><span class="w"> </span><span class="n">MakeCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Ipv4Protocol</span><span class="o">::</span><span class="n">Receive</span><span class="p">,</span><span class="w"> </span><span class="n">ipv4</span><span class="p">),</span>
<span class="w">                         </span><span class="n">Ipv4L3Protocol</span><span class="o">::</span><span class="n">PROT_NUMBER</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p>The Ipv4L3Protocol object is aggregated to the Node; there is only one such
Ipv4L3Protocol object. Higher-layer protocols that have a packet to send down to
the Ipv4L3Protocol object can call <code class="docutils literal notranslate"><span class="pre">GetObject&lt;Ipv4L3Protocol&gt;()</span></code> to obtain a
pointer, as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4L3Protocol</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_node</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">Ipv4L3Protocol</span><span class="o">&gt;</span><span class="p">();</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ipv4</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">ipv4</span><span class="o">-&gt;</span><span class="n">Send</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span><span class="w"> </span><span class="n">saddr</span><span class="p">,</span><span class="w"> </span><span class="n">daddr</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_NUMBER</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
<p>This class nicely demonstrates two techniques we exploit in <em>ns-3</em> to bind
objects together:  callbacks, and object aggregation.</p>
<p>Once IPv4 routing has determined that a packet is for the local node, it
forwards it up the stack.  This is done with the following function:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="n">Ipv4L3Protocol</span><span class="o">::</span><span class="n">LocalDeliver</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">Packet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">packet</span><span class="p">,</span><span class="w"> </span><span class="n">Ipv4Header</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="n">ip</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">iif</span><span class="p">)</span>
</pre></div>
</div>
<p>The first step is to find the right Ipv4L4Protocol object, based on IP protocol
number. For instance, TCP is registered in the demux as protocol number 6.
Finally, the <code class="docutils literal notranslate"><span class="pre">Receive()</span></code> function on the Ipv4L4Protocol (such as
<code class="docutils literal notranslate"><span class="pre">TcpL4Protocol::Receive</span></code> is called.</p>
<p>We have not yet introduced the class Ipv4Interface. Basically, each NetDevice is
paired with an IPv4 representation of such device. In Linux, this class
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Ipv4Interface</span></code> roughly corresponds to the <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">in_device</span></code>; the
main purpose is to provide address-family specific information (addresses) about
an interface.</p>
<p>All the classes have appropriate traces in order to track sent, received and lost packets.
The users is encouraged to use them so to find out if (and where) a packet is dropped. A
common mistake is to forget the effects of local queues when sending packets, e.g., the ARP
queue. This can be particularly puzzling when sending jumbo packets or packet bursts using UDP.
The ARP cache pending queue is limited (3 datagrams) and IP packets might be fragmented, easily
overfilling the ARP cache queue size. In those cases it is useful to increase the ARP cache
pending size to a proper value, e.g.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ArpCache::PendingQueueSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UintegerValue</span><span class="p">(</span><span class="n">MAX_BURST_SIZE</span><span class="o">/</span><span class="n">L2MTU</span><span class="o">*</span><span class="mi">3</span><span class="p">));</span>
</pre></div>
</div>
<p>The IPv6 implementation follows a similar architecture.  Dual-stacked nodes (one with
support for both IPv4 and IPv6) will allow an IPv6 socket to receive IPv4 connections
as a standard dual-stacked system does.  A socket bound and listening to an IPv6 endpoint
can receive an IPv4 connection and will return the remote address as an IPv4-mapped address.
Support for the IPV6_V6ONLY socket option does not currently exist.</p>
</section>
<section id="layer-4-protocols-and-sockets">
<h4><span class="section-number">16.1.1.1.2. </span>Layer-4 protocols and sockets<a class="headerlink" href="#layer-4-protocols-and-sockets" title="Link to this heading">¶</a></h4>
<p>We next describe how the transport protocols, sockets, and applications tie
together. In summary, each transport protocol implementation is a socket
factory. An application that needs a new socket</p>
<p>For instance, to create a UDP socket, an application would use a code snippet
such as the following:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Udp</span><span class="o">&gt;</span><span class="w"> </span><span class="n">udpSocketFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetNode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">Udp</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Socket</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socketFactory</span><span class="o">-&gt;</span><span class="n">CreateSocket</span><span class="p">();</span>
<span class="n">m_socket</span><span class="o">-&gt;</span><span class="n">Bind</span><span class="p">(</span><span class="n">m_local_address</span><span class="p">);</span>
<span class="p">...</span>
</pre></div>
</div>
<p>The above will query the node to get a pointer to its UDP socket factory, will
create one such socket, and will use the socket with an API similar to the
C-based sockets API, such as <code class="docutils literal notranslate"><span class="pre">Connect()</span></code> and <code class="docutils literal notranslate"><span class="pre">Send()</span></code>.  The address passed
to the <code class="docutils literal notranslate"><span class="pre">Bind()</span></code>, <code class="docutils literal notranslate"><span class="pre">Connect()</span></code>, or <code class="docutils literal notranslate"><span class="pre">Send()</span></code> functions may be a
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Ipv4Address</span></code>, <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Ipv6Address</span></code>, or <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Address</span></code>.
If a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Address</span></code> is passed in and contains anything other than
a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Ipv4Address</span></code> or <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Ipv6Address</span></code>, these functions will
return an error.  The <code class="docutils literal notranslate"><span class="pre">Bind()</span></code> and <code class="docutils literal notranslate"><span class="pre">Bind6()</span></code> functions bind to
“0.0.0.0” and “::” respectively.</p>
<p>The socket can also be bound to a specific NetDevice though the
<code class="docutils literal notranslate"><span class="pre">BindToNetDevice(Ptr&lt;NetDevice&gt;</span> <span class="pre">netdevice)</span></code> function.
<code class="docutils literal notranslate"><span class="pre">BindToNetDevice(Ptr&lt;NetDevice&gt;</span> <span class="pre">netdevice)</span></code> will bind the socket
to “0.0.0.0” and “::”(equivalent to calling <code class="docutils literal notranslate"><span class="pre">Bind()</span></code> and <code class="docutils literal notranslate"><span class="pre">Bind6()</span></code>,
unless the socket has been already bound to a specific address.
Summarizing, the correct sequence is:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Udp</span><span class="o">&gt;</span><span class="w"> </span><span class="n">udpSocketFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetNode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">Udp</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Socket</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socketFactory</span><span class="o">-&gt;</span><span class="n">CreateSocket</span><span class="p">();</span>
<span class="w"> </span><span class="n">m_socket</span><span class="o">-&gt;</span><span class="n">BindToNetDevice</span><span class="p">(</span><span class="n">n_netDevice</span><span class="p">);</span>
<span class="p">...</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Udp</span><span class="o">&gt;</span><span class="w"> </span><span class="n">udpSocketFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetNode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">Udp</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Socket</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socketFactory</span><span class="o">-&gt;</span><span class="n">CreateSocket</span><span class="p">();</span>
<span class="n">m_socket</span><span class="o">-&gt;</span><span class="n">Bind</span><span class="p">(</span><span class="n">m_local_address</span><span class="p">);</span>
<span class="n">m_socket</span><span class="o">-&gt;</span><span class="n">BindToNetDevice</span><span class="p">(</span><span class="n">n_netDevice</span><span class="p">);</span>
<span class="p">...</span>
</pre></div>
</div>
<p>The following raises an error:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Udp</span><span class="o">&gt;</span><span class="w"> </span><span class="n">udpSocketFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetNode</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">Udp</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Socket</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socketFactory</span><span class="o">-&gt;</span><span class="n">CreateSocket</span><span class="p">();</span>
<span class="n">m_socket</span><span class="o">-&gt;</span><span class="n">BindToNetDevice</span><span class="p">(</span><span class="n">n_netDevice</span><span class="p">);</span>
<span class="n">m_socket</span><span class="o">-&gt;</span><span class="n">Bind</span><span class="p">(</span><span class="n">m_local_address</span><span class="p">);</span>
<span class="p">...</span>
</pre></div>
</div>
<p>See the chapter on <em>ns-3</em> sockets for more information.</p>
<p>We have described so far a socket factory (e.g. <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">Udp</span></code>) and a socket,
which may be specialized (e.g., class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">UdpSocket</span></code>).  There are a few
more key objects that relate to the specialized task of demultiplexing a packet
to one or more receiving sockets.  The key object in this task is class
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Ipv4EndPointDemux</span></code>.  This demultiplexer stores objects of class
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Ipv4EndPoint</span></code>.  This class holds the addressing/port tuple (local
port, local address, destination port, destination address) associated with the
socket, and a receive callback. This receive callback has a receive function
registered by the socket. The <code class="docutils literal notranslate"><span class="pre">Lookup()</span></code> function to Ipv4EndPointDemux
returns a list of Ipv4EndPoint objects(there may be a list since more than one
socket may match the packet). The layer-4 protocol copies the packet to each
Ipv4EndPoint and calls its <code class="docutils literal notranslate"><span class="pre">ForwardUp()</span></code> method, which then calls the
<code class="docutils literal notranslate"><span class="pre">Receive()</span></code> function registered by the socket.</p>
<p>An issue that arises when working with the sockets API on real
systems is the need to manage the reading from a socket, using
some type of I/O (e.g., blocking, non-blocking, asynchronous, …).
<em>ns-3</em> implements an asynchronous model for socket I/O; the application
sets a callback to be notified of received data ready to be read, and the
callback is invoked by the transport protocol when data is available.
This callback is specified as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">Socket::SetRecvCallback</span><span class="p">(</span><span class="n">Callback</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Socket</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">                             </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Packet</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">                             </span><span class="k">const</span><span class="w"> </span><span class="n">Address</span><span class="o">&amp;&gt;</span><span class="w"> </span><span class="n">receivedData</span><span class="p">);</span>
</pre></div>
</div>
<p>The data being received is conveyed in the Packet data buffer.  An example
usage is in class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">PacketSink</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">m_socket</span><span class="o">-&gt;</span><span class="n">SetRecvCallback</span><span class="p">(</span><span class="n">MakeCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PacketSink</span><span class="o">::</span><span class="n">HandleRead</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">));</span>
</pre></div>
</div>
<p>To summarize, internally, the UDP implementation is organized as follows:</p>
<ul class="simple">
<li><p>a <code class="docutils literal notranslate"><span class="pre">UdpImpl</span></code> class that implements the UDP socket factory functionality</p></li>
<li><p>a <code class="docutils literal notranslate"><span class="pre">UdpL4Protocol</span></code> class that implements the protocol logic that is
socket-independent</p></li>
<li><p>a <code class="docutils literal notranslate"><span class="pre">UdpSocketImpl</span></code> class that implements socket-specific aspects of UDP</p></li>
<li><p>a class called <code class="docutils literal notranslate"><span class="pre">Ipv4EndPoint</span></code> that stores the addressing tuple (local port,
local address, destination port, destination address) associated with the
socket, and a receive callback for the socket.</p></li>
</ul>
</section>
</section>
<section id="ip-capable-node-interfaces">
<h3><span class="section-number">16.1.1.2. </span>IP-capable node interfaces<a class="headerlink" href="#ip-capable-node-interfaces" title="Link to this heading">¶</a></h3>
<p>Many of the implementation details, or internal objects themselves, of
IP-capable Node objects are not exposed at the simulator public API. This
allows for different implementations; for instance, replacing the native <em>ns-3</em>
models with ported TCP/IP stack code.</p>
<p>The C++ public APIs of all of these objects is found in the <code class="docutils literal notranslate"><span class="pre">src/network</span></code>
directory, including principally:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">address.h</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">socket.h</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">node.h</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">packet.h</span></code></p></li>
</ul>
<p>These are typically base class objects that implement the default values used in
the implementation, implement access methods to get/set state variables, host
attributes, and implement publicly-available methods exposed to clients such as
<code class="docutils literal notranslate"><span class="pre">CreateSocket</span></code>.</p>
</section>
<section id="example-path-of-a-packet">
<h3><span class="section-number">16.1.1.3. </span>Example path of a packet<a class="headerlink" href="#example-path-of-a-packet" title="Link to this heading">¶</a></h3>
<p>These two figures show an example stack trace of how packets flow through the
Internet Node objects.</p>
<figure class="align-default" id="id1">
<span id="internet-node-send"></span><img alt="_images/internet-node-send.png" src="_images/internet-node-send.png" />
<figcaption>
<p><span class="caption-text">Send path of a packet.</span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-default" id="id2">
<span id="internet-node-recv"></span><img alt="_images/internet-node-recv.png" src="_images/internet-node-recv.png" />
<figcaption>
<p><span class="caption-text">Receive path of a packet.</span><a class="headerlink" href="#id2" title="Link to this image">¶</a></p>
</figcaption>
</figure>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">16.1. Internet Stack</a><ul>
<li><a class="reference internal" href="#internet-stack-aggregation">16.1.1. Internet stack aggregation</a><ul>
<li><a class="reference internal" href="#internet-node-structure">16.1.1.1. Internet Node structure</a><ul>
<li><a class="reference internal" href="#layer-3-protocols">16.1.1.1.1. Layer-3 protocols</a></li>
<li><a class="reference internal" href="#layer-4-protocols-and-sockets">16.1.1.1.2. Layer-4 protocols and sockets</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ip-capable-node-interfaces">16.1.1.2. IP-capable node interfaces</a></li>
<li><a class="reference internal" href="#example-path-of-a-packet">16.1.1.3. Example path of a packet</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="internet-models.html"
                          title="previous chapter"><span class="section-number">16. </span>Internet Models (IP, TCP, Routing, UDP)</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="ipv4.html"
                          title="next chapter"><span class="section-number">16.2. </span>IPv4</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/internet-stack.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ipv4.html" title="16.2. IPv4"
             >next</a> |</li>
        <li class="right" >
          <a href="internet-models.html" title="16. Internet Models (IP, TCP, Routing, UDP)"
             >previous</a> |</li>
    <li class="navelem"><a href="">ns-3</a><span class="navelem">&nbsp;</span></li>
    
        <li class="nav-item nav-item-0"><a href="index.html">Models</a><span class="navelem">&nbsp;</span></li>

          <li class="nav-item nav-item-1"><a href="internet-models.html" ><span class="section-number">16. </span>Internet Models (IP, TCP, Routing, UDP)</a><span class="navelem">&nbsp;</span></li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">16.1. </span>Internet Stack</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2006-2019.
      Last updated on Nov 10, 2023 15:56.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>
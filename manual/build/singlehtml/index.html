
<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Manual</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/default.css" />
    <script src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <link rel="stylesheet" type="text/css"
    href="_static/ns3_stylesheet.css" />
    <link rel="icon" type="image/ico"
      href="_static/favicon.ico" />

  <script type="text/javascript" src="_static/drop-down-menu.js"></script>
  <script type="text/javascript" src="_static/ns3_version.js"></script>
  <script type="text/javascript">var ns3_builder="singlehtml";</script>
  <script type="text/javascript" src="_static/ns3_links.js"></script>


  </head><body>
    <div id="titlearea">
      <table cellspacing="0" cellpadding="0" width="100%">
        <tbody>
          <tr style="height: 56px;">
            <td id="projectlogo">
              <a id="ns3_home1"
                 href="http://www.nsnam.org/">
                 <img alt="ns-3 Logo" style="background-color: unset;"
                      src="_static/ns-3-inverted-notext-small.png"/>
              </a>
            </td>
            <td id="projecttext">
              <div id="projectbrief">A Discrete-Event Network Simulator</div>
              <span id="projectnumber"><script type="text/javascript">document.write(ns3_version)</script></span>
            </td>

            <td id="ns3-menu">
              <div class="menu">
                <ul >
                  <li style="background-image:none">
                    <a id="ns3_home2"
                         href="http://www.nsnam.org/"
                         >&nbsp;&nbsp;Home</a>
                  </li>
                  <li><span
                        onmouseover="mopen('mTuts')"
                        onmouseout="mclosetime()"
                          >Tutorials &nbsp;&#x25BC;</span>
                      <div id="mTuts"
                          onmouseover="mcancelclosetime()"
                          onmouseout="mclosetime()">
                        <a id="ns3_tut"
                           href="/docs/tutorial/html/index.html"
                            >English</a><br/>
                      </div>
                  </li>
                  <li><span
                        onmouseover="mopen('mDocs')"
                        onmouseout="mclosetime()"
                          >Documentation &nbsp;&#x25BC;</span>
                      <div id="mDocs"
                          onmouseover="mcancelclosetime()"
                          onmouseout="mclosetime()">
                        <a id="ns3_ins"
                           href="/docs/installation/html/index.html"
                           >Installation</a><br/>
                        <a id="ns3_man"
                           href="/docs/manual/html/index.html"
                           >Manual</a><br/>
                        <a id="ns3_mod"
                           href="/docs/models/html/index.html"
                           >Models</a><br/>
                        <a id="ns3_con"
                           href="/docs/contributing/html/index.html"
                           >Contributing</a><br/>
                        <a id="ns3_wiki"
                           href="http://www.nsnam.org/wiki"
                           >Wiki</a><br/>
                      </div>
                  </li>
                  <li><span
                        onmouseover="mopen('mDev')"
                        onmouseout="mclosetime()"
                          >Development &nbsp;&#x25BC;</span>
                      <div id="mDev"
                          onmouseover="mcancelclosetime()"
                          onmouseout="mclosetime()">
                        <a id="ns3_api"
                           href="/docs/doxygen/html/index.html"
                           >API Docs</a><br/>
                        <a id="ns3_bugs"
                         href="https://gitlab.com/nsnam/ns-3-dev/-/issues"
                           >Issue Tracker</a><br/>
                        <a id="ns3_merge"
                         href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests"
                           >Merge Requests</a><br/>
                      </div>
                  </li>
                </ul>
              </div>
            </td>

            <td id="projectsection">
              <span style="margin-right:10px">Manual</span>
            </td>
          </tr>
        </tbody>
      </table>
      <script  type="text/javascript">ns3_write_links()</script>
    </div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
    <li class="navelem"><a href="">ns-3</a><span class="navelem">&nbsp;</span></li>
    
        <li class="nav-item nav-item-0"><a href="#">Manual</a><span class="navelem">&nbsp;</span></li>

        <li class="nav-item nav-item-this"><a href="">Manual</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ns-3-manual">
<h1>ns-3 Manual<a class="headerlink" href="#ns-3-manual" title="Link to this heading">¶</a></h1>
<p>This is the <em>ns-3 Manual</em>. Primary documentation for the ns-3 project is organized as
follows:</p>
<ul class="simple">
<li><p>Several guides that are version controlled for each release (the
<a class="reference external" href="https://www.nsnam.org/documentation/latest/">latest release</a>) and
<a class="reference external" href="https://www.nsnam.org/ns-3-dev/documentation/">development tree</a>:</p>
<ul>
<li><p>Tutorial</p></li>
<li><p>Installation Guide</p></li>
<li><p>Manual <em>(this document)</em></p></li>
<li><p>Model Library</p></li>
<li><p>Contributing Guide</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://www.nsnam.org/docs/doxygen/index.html">ns-3 Doxygen</a>: Documentation of the public APIs of
the simulator</p></li>
<li><p><a class="reference external" href="https://www.nsnam.org/wiki/Main_Page">ns-3 wiki</a></p></li>
</ul>
<p>This document is written in <a class="reference external" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> for <a class="reference external" href="https://www.sphinx-doc.org/">Sphinx</a> and is maintained in the
<code class="docutils literal notranslate"><span class="pre">doc/manual</span></code> directory of ns-3’s source code.  Source file column width is 100 columns.</p>
<div class="toctree-wrapper compound">
<span id="document-organization"></span><section id="organization">
<h2><span class="section-number">1. </span>Organization<a class="headerlink" href="#organization" title="Link to this heading">¶</a></h2>
<p>This chapter describes the overall <em>ns-3</em> software organization and the
corresponding organization of this manual.</p>
<p><em>ns-3</em> is a discrete-event network simulator in which the simulation core
and models are implemented in C++. <em>ns-3</em> is built as a library which may be
statically or dynamically linked to a C++ main program that defines the
simulation topology and starts the simulator. <em>ns-3</em> also exports nearly all
of its API to Python, allowing Python programs to import an “ns3” module in
much the same way as the <em>ns-3</em> library is linked by executables in C++.</p>
<figure class="align-default" id="id1">
<span id="software-organization"></span><img alt="_images/software-organization.png" src="_images/software-organization.png" />
<figcaption>
<p><span class="caption-text">Software organization of <em>ns-3</em></span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>The source code for <em>ns-3</em> is mostly organized in the <code class="docutils literal notranslate"><span class="pre">src</span></code> directory and
can be described by the diagram in <a class="reference internal" href="#software-organization"><span class="std std-ref">Software organization of ns-3</span></a>. We will
work our way from the bottom up; in general, modules only have dependencies
on modules beneath them in the figure.</p>
<p>We first describe the core of the simulator; those components that are
common across all protocol, hardware, and environmental models.
The simulation core is implemented in <code class="docutils literal notranslate"><span class="pre">src/core</span></code>. Packets are
fundamental objects in a network simulator
and are implemented in <code class="docutils literal notranslate"><span class="pre">src/network</span></code>. These two simulation modules by
themselves are intended to comprise a generic simulation core that can be
used by different kinds of networks, not just Internet-based networks.  The
above modules of <em>ns-3</em> are independent of specific network and device
models, which are covered in subsequent parts of this manual.</p>
<p>In addition to the above <em>ns-3</em> core, we introduce, also in the initial
portion of the manual, two other modules that supplement the core C++-based
API.  <em>ns-3</em> programs may access
all of the API directly or may make use of a so-called <em>helper API</em> that
provides convenient wrappers or encapsulation of low-level API calls. The
fact that <em>ns-3</em> programs can be written to two APIs (or a combination
thereof) is a fundamental aspect of the simulator.
We also describe how Python is supported in <em>ns-3</em> before moving onto
specific models of relevance to network simulation.</p>
<p>The remainder of the manual is focused on documenting the models and
supporting capabilities.  The next part focuses on two fundamental objects in
<em>ns-3</em>:  the <code class="docutils literal notranslate"><span class="pre">Node</span></code> and <code class="docutils literal notranslate"><span class="pre">NetDevice</span></code>. Two special NetDevice types are
designed to support network emulation use cases, and emulation is described
next.  The following chapter is devoted to Internet-related models,
including the
sockets API used by Internet applications. The next chapter covers
applications, and the following chapter describes additional support for
simulation, such as animators and statistics.</p>
<p>The project maintains a manual section devoted to testing and validation
of <em>ns-3</em> code (see the <a class="reference external" href="https://www.nsnam.org/docs/manual/html/tests.html">tests section in the ns-3 manual</a>).</p>
</section>
<span id="document-simulator"></span><section id="simulator">
<h2><span class="section-number">2. </span>Simulator<a class="headerlink" href="#simulator" title="Link to this heading">¶</a></h2>
<p>This chapter explains some of the core ns-3 simulator concepts.</p>
<div class="toctree-wrapper compound">
<span id="document-events"></span><section id="events-and-simulator">
<h3><span class="section-number">2.1. </span>Events and Simulator<a class="headerlink" href="#events-and-simulator" title="Link to this heading">¶</a></h3>
<p><em>ns-3</em> is a discrete-event network simulator.  Conceptually, the simulator
keeps track of a number of events that are scheduled to execute at a
specified simulation time.  The job of the simulator is to execute the
events in sequential time order.  Once the completion of an event occurs,
the simulator will move to the next event (or will exit if there are no
more events in the event queue).  If, for example, an event scheduled
for simulation time “100 seconds” is executed, and the next event is not
scheduled until “200 seconds”, the simulator will immediately jump from
100 seconds to 200 seconds (of simulation time) to execute the next event.
This is what is meant by “discrete-event” simulator.</p>
<p>To make this all happen, the simulator needs a few things:</p>
<ol class="arabic simple">
<li><p>a simulator object that can access an event queue where events are
stored and that can manage the execution of events</p></li>
<li><p>a scheduler responsible for inserting and removing events from the queue</p></li>
<li><p>a way to represent simulation time</p></li>
<li><p>the events themselves</p></li>
</ol>
<p>This chapter of the manual describes these fundamental objects
(simulator, scheduler, time, event) and how they are used.</p>
<section id="event">
<h4><span class="section-number">2.1.1. </span>Event<a class="headerlink" href="#event" title="Link to this heading">¶</a></h4>
<p><em>To be completed</em></p>
</section>
<section id="simulator">
<h4><span class="section-number">2.1.2. </span>Simulator<a class="headerlink" href="#simulator" title="Link to this heading">¶</a></h4>
<p>The Simulator class is the public entry point to access event scheduling
facilities. Once a couple of events have been scheduled to start the
simulation, the user can start to execute them by entering the simulator
main loop (call <code class="docutils literal notranslate"><span class="pre">Simulator::Run</span></code>). Once the main loop starts running, it
will sequentially execute all scheduled events in order from oldest to
most recent until there are either no more events left in the event
queue or Simulator::Stop has been called.</p>
<p>To schedule events for execution by the simulator main loop, the
Simulator class provides the Simulator::Schedule* family of functions.</p>
<ol class="arabic simple">
<li><p>Handling event handlers with different signatures</p></li>
</ol>
<p>These functions are declared and implemented as C++ templates to handle
automatically the wide variety of C++ event handler signatures used in
the wild. For example, to schedule an event to execute 10 seconds in the
future, and invoke a C++ method or function with specific arguments, you
might write this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">handler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">arg0</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">arg1</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;handler called with argument arg0=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">arg0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; and</span>
<span class="w">     </span><span class="n">arg1</span><span class="o">=</span><span class="s">&quot; &lt;&lt; arg1 &lt;&lt; std::endl;</span>
<span class="p">}</span>

<span class="n">Simulator</span><span class="o">::</span><span class="n">Schedule</span><span class="p">(</span><span class="n">Seconds</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
</pre></div>
</div>
<p>Which will output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>handler called with argument arg0=10 and arg1=5
</pre></div>
</div>
<p>Of course, these C++ templates can also handle transparently member
methods on C++ objects:</p>
<p><em>To be completed:  member method example</em></p>
<p>Notes:</p>
<ul class="simple">
<li><p>the <em>ns-3</em> Schedule methods recognize automatically functions and
methods only if they take less than 5 arguments. If you need them to
support more arguments, please, file a bug report.</p></li>
<li><p>Readers familiar with the term ‘fully-bound functors’ will recognize
the Simulator::Schedule methods as a way to automatically construct such
objects.</p></li>
</ul>
<ol class="arabic simple" start="2">
<li><p>Common scheduling operations</p></li>
</ol>
<p>The Simulator API was designed to make it really simple to schedule most
events. It provides three variants to do so (ordered from most commonly
used to least commonly used):</p>
<ul class="simple">
<li><p>Schedule methods which allow you to schedule an event in the future
by providing the delay between the current simulation time and the
expiration date of the target event.</p></li>
<li><p>ScheduleNow methods which allow you to schedule an event for the
current simulation time: they will execute _after_ the current event is
finished executing but _before_ the simulation time is changed for the
next event.</p></li>
<li><p>ScheduleDestroy methods which allow you to hook in the shutdown
process of the Simulator to cleanup simulation resources: every
‘destroy’ event is executed when the user calls the Simulator::Destroy
method.</p></li>
</ul>
<ol class="arabic simple" start="3">
<li><p>Maintaining the simulation context</p></li>
</ol>
<p>There are two basic ways to schedule events, with and without <em>context</em>.
What does this mean?</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Simulator</span><span class="o">::</span><span class="n">Schedule</span><span class="p">(</span><span class="n">Time</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">MEM</span><span class="w"> </span><span class="n">mem_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">OBJ</span><span class="w"> </span><span class="n">obj</span><span class="p">);</span>
</pre></div>
</div>
<p>vs.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Simulator</span><span class="o">::</span><span class="n">ScheduleWithContext</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Time</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">MEM</span><span class="w"> </span><span class="n">mem_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">OBJ</span><span class="w"> </span><span class="n">obj</span><span class="p">);</span>
</pre></div>
</div>
<p>Readers who invest time and effort in developing or using a non-trivial
simulation model will know the value of the <em>ns-3</em> logging framework to
debug simple and complex simulations alike. One of the important
features that is provided by this logging framework is the automatic
display of the network node id associated with the ‘currently’ running
event.</p>
<p>The node id of the currently executing network node is in fact tracked
by the Simulator class. It can be accessed with the
Simulator::GetContext method which returns the ‘context’ (a 32-bit
integer) associated and stored in the currently-executing event. In some
rare cases, when an event is not associated with a specific network
node, its ‘context’ is set to 0xffffffff.</p>
<p>To associate a context to each event, the Schedule, and ScheduleNow
methods automatically reuse the context of the currently-executing event
as the context of the event scheduled for execution later.</p>
<p>In some cases, most notably when simulating the transmission of a packet
from a node to another, this behavior is undesirable since the expected
context of the reception event is that of the receiving node, not the
sending node. To avoid this problem, the Simulator class provides a
specific schedule method: ScheduleWithContext which allows one to
provide explicitly the node id of the receiving node associated with
the receive event.</p>
<p><em>XXX: code example</em></p>
<p>In some very rare cases, developers might need to modify or understand
how the context (node id) of the first event is set to that of its
associated node. This is accomplished by the NodeList class: whenever a
new node is created, the NodeList class uses ScheduleWithContext to
schedule a ‘initialize’ event for this node. The ‘initialize’ event thus executes
with a context set to that of the node id and can use the normal variety
of Schedule methods. It invokes the Node::Initialize method which propagates
the ‘initialize’ event by calling the DoInitialize method for each object
associated with the node. The DoInitialize method overridden in some of these
objects (most notably in the Application base class) will schedule some
events (most notably Application::StartApplication) which will in turn
scheduling traffic generation events which will in turn schedule
network-level events.</p>
<p>Notes:</p>
<ul class="simple">
<li><p>Users need to be careful to propagate DoInitialize methods across objects
by calling Initialize explicitly on their member objects</p></li>
<li><p>The context id associated with each ScheduleWithContext method has
other uses beyond logging: it is used by an experimental branch of <em>ns-3</em>
to perform parallel simulation on multicore systems using
multithreading.</p></li>
</ul>
<p>The Simulator::* functions do not know what the context is: they
merely make sure that whatever context you specify with
ScheduleWithContext is available when the corresponding event executes
with ::GetContext.</p>
<p>It is up to the models implemented on top of Simulator::* to interpret
the context value. In <em>ns-3</em>, the network models interpret the context
as the node id of the node which generated an event. This is why it is
important to call ScheduleWithContext in ns3::Channel subclasses
because we are generating an event from node i to node j and we want
to make sure that the event which will run on node j has the right
context.</p>
<section id="available-simulator-engines">
<h5><span class="section-number">2.1.2.1. </span>Available Simulator Engines<a class="headerlink" href="#available-simulator-engines" title="Link to this heading">¶</a></h5>
<p><em>ns-3</em> supplies two different types of basic simulator engine to manage
event execution.  These are derived from the abstract base class <cite>SimulatorImpl</cite>:</p>
<ul class="simple">
<li><p><cite>DefaultSimulatorImpl</cite>  This is a classic sequential discrete event
simulator engine which uses a single thread of execution.  This engine
executes events as fast as possible.</p></li>
<li><p><cite>DistributedSimulatorImpl</cite> This is a classic YAWNS distributed (“parallel”)
simulator engine. By labeling and instantiating your model components
appropriately this engine will execute the model in parallel across many
compute processes, yet in a time-synchronized way, as if the model had
executed sequentially. The two advantages are to execute models faster
and to execute models too large to fit in one compute node.  This engine also
attempts to execute as fast as possible.</p></li>
<li><p><cite>NullMessageSimulatorImpl</cite>  This implements a variant of the Chandy-
Misra-Bryant (CMB) null message algorithm for parallel simulation.
Like <cite>DistributedSimulatorImpl</cite> this requires appropriate labeling and
instantiation of model components. This engine attempts to execute
events as fast as possible.</p></li>
</ul>
<p>You can choose which simulator engine to use by setting a global variable,
for example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">GlobalValue</span><span class="o">::</span><span class="n">Bind</span><span class="p">(</span><span class="s">&quot;SimulatorImplementationType&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;ns3::DistributedSimulatorImpl&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>or by using a command line argument</p>
<div class="highlight-terminal notranslate"><div class="highlight"><pre><span></span>$ ./ns3 run &quot;...  -–SimulatorImplementationType=ns3::DistributedSimulatorImpl&quot;
</pre></div>
</div>
<p>In addition to the basic simulator engines there is a general facility used
to build “adapters” which provide small behavior modifications to one of
the core <cite>SimulatorImpl</cite> engines.  The adapter base class is
<cite>SimulatorAdapter</cite>, itself derived from <cite>SimulatorImpl</cite>.  <cite>SimluatorAdapter</cite>
uses the <a class="reference external" href="https://en.cppreference.com/w/cpp/language/pimpl">PIMPL (pointer to implementation)</a>
idiom to forward all calls to the configured base simulator engine.
This makes it easy to provide small customizations
just by overriding the specific Simulator calls needed, and allowing
<cite>SimulatorAdapter</cite> to handle the rest.</p>
<p>There are few places where adapters are used currently:</p>
<ul class="simple">
<li><p><cite>ReadltimeSimulatorImpl</cite>  This adapter attempts to execute in real time
by pacing the wall clock evolution.  This pacing is “best effort”,
meaning actual event execution may not occur exactly in sync, but
close to it. This engine is normally only used with the
<cite>DefaultSimulatorImpl</cite>, but it can be used to keep a distributed
simulation synchronized with real time.  See the <a class="reference internal" href="index.html#document-realtime"><span class="doc">RealTime</span></a> chapter.</p></li>
<li><p><cite>VisualSimulatorImpl</cite>  This adapter starts a live visualization of the
running simulation, showing the network graph and each packet traversing
the links.</p></li>
<li><p><cite>LocalTimeSimulatorImpl</cite>  This adapter enables attaching noisy local clocks
to <cite>Nodes</cite>, then scheduling events with respect to the local noisy clock,
instead of relative to the true simulator time.</p></li>
</ul>
<p>In addition to the PIMPL idiom of <cite>SimulatorAdapter</cite> there is a special
per-event customization hook:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">SimulatorImpl</span><span class="o">::</span><span class="n">PreEventHook</span><span class="p">(</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">EventId</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<p>One can use this to perform any housekeeping actions before the next event
actually executes.</p>
<p>The distinction between a core engine and an adapter is the following: there
can only ever be one core engine running, while there can be several adapters
chained up each providing a variation on the base engine execution.
For example one can use noisy local clocks with the real time adapter.</p>
<p>A single adapter can be added on top of the <cite>DefaultSimulatorImpl</cite> by the same
two methods above: binding the <cite>“SimulatorImplementationType”</cite> global value or
using the command line argument.  To chain multiple adapters a different
approach must be used; see the <cite>SimulatorAdapter::AddAdapter()</cite>
API documentation.</p>
<p>The simulator engine type can be set once, but must be set before the
first call to the <cite>Simulator()</cite> API.  In practice, since some models have
to schedule their start up events when they are constructed, this means
generally you should set the engine type before instantiating any other
model components.</p>
<p>The engine type can be changed after <cite>Simulator::Destroy()</cite> but before
any additional calls to the Simulator API, for instance when executing
multiple runs in a single <em>ns-3</em> invocation.</p>
</section>
</section>
<section id="time">
<h4><span class="section-number">2.1.3. </span>Time<a class="headerlink" href="#time" title="Link to this heading">¶</a></h4>
<p><em>ns-3</em> internally represents simulation times and durations as
64-bit signed integers (with the sign bit used for negative durations).
The time values are interpreted with respect to a “resolution” unit in the
customary SI units: fs, ps, ns, us, ms, s, min, h, d, y.
The unit defines the minimum Time value.
It can be changed once before any calls to <cite>Simulator::Run()</cite>.
It is not stored with the 64-bit time value itself.</p>
<p>Times can be constructed from all standard numeric types
(using the configured default unit)
or with explicit units (as in <cite>Time MicroSeconds (uint64_t value)</cite>).
Times can be compared, tested for sign or equality to zero, rounded to
a given unit, converted to standard numeric types in specific units.
All basic arithmetic operations are supported
(addition, subtraction, multiplication or division
by a scalar (numeric value)). Times can be written to/read from IO streams.
In the case of writing it is easy to choose the output unit, different
from the resolution unit.</p>
</section>
<section id="scheduler">
<h4><span class="section-number">2.1.4. </span>Scheduler<a class="headerlink" href="#scheduler" title="Link to this heading">¶</a></h4>
<p>The main job of the <cite>Scheduler</cite> classes is to maintain the priority queue of
future events.  The scheduler can be set with a global variable,
similar to choosing the <cite>SimulatorImpl</cite>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">GlobalValue</span><span class="o">::</span><span class="n">Bind</span><span class="p">(</span><span class="s">&quot;SchedulerType&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;ns3::DistributedSimulatorImpl&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>The scheduler can be changed at any time via <cite>Simulator::SetScheduler()</cite>.
The default scheduler is <cite>MapScheduler</cite> which uses a <cite>std::map&lt;&gt;</cite> to
store events in time order.</p>
<p>Because event distributions vary by model there is no one
best strategy for the priority queue, so <em>ns-3</em> has several options with
differing tradeoffs.  The example <cite>utils/bench-scheduler.c</cite> can be used
to test the performance for a user-supplied event distribution.
For modest execution times (less than an hour, say) the choice of priority
queue is usually not significant; configuring the build type to optimized
is much more important in reducing execution times.</p>
<p>The available scheduler types, and a summary of their time and space
complexity on <cite>Insert()</cite> and <cite>RemoveNext()</cite>, are listed in the
following table.  See the individual Scheduler API pages for details on the
complexity of the other API calls.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head" colspan="2"><p>Scheduler Type</p></th>
<th class="head" colspan="4"><p>Complexity</p></th>
</tr>
<tr class="row-even"><th class="head" rowspan="2"><p><cite>SchedulerImpl</cite> Type</p></th>
<th class="head" rowspan="2"><p>Method</p></th>
<th class="head" colspan="2"><p>Time</p></th>
<th class="head" colspan="2"><p>Space</p></th>
</tr>
<tr class="row-odd"><th class="head"><p>Insert()</p></th>
<th class="head"><p>RemoveNext()</p></th>
<th class="head"><p>Overhead</p></th>
<th class="head"><p>Per Event</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>CalendarScheduler</p></td>
<td><p><cite>&lt;std::list&gt; []</cite></p></td>
<td><p>Constant</p></td>
<td><p>Constant</p></td>
<td><p>24 bytes</p></td>
<td><p>16 bytes</p></td>
</tr>
<tr class="row-odd"><td><p>HeapScheduler</p></td>
<td><p>Heap on <cite>std::vector</cite></p></td>
<td><p>Logarithmic</p></td>
<td><p>Logarithmic</p></td>
<td><p>24 bytes</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p>ListScheduler</p></td>
<td><p><cite>std::list</cite></p></td>
<td><p>Linear</p></td>
<td><p>Constant</p></td>
<td><p>24 bytes</p></td>
<td><p>16 bytes</p></td>
</tr>
<tr class="row-odd"><td><p>MapScheduler</p></td>
<td><p><cite>st::map</cite></p></td>
<td><p>Logarithmic</p></td>
<td><p>Constant</p></td>
<td><p>40 bytes</p></td>
<td><p>32 bytes</p></td>
</tr>
<tr class="row-even"><td><p>PriorityQueueScheduler</p></td>
<td><p><cite>std::priority_queue&lt;,std::vector&gt;</cite></p></td>
<td><p>Logarithimc</p></td>
<td><p>Logarithims</p></td>
<td><p>24 bytes</p></td>
<td><p>0</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<span id="document-callbacks"></span><section id="callbacks">
<h3><span class="section-number">2.2. </span>Callbacks<a class="headerlink" href="#callbacks" title="Link to this heading">¶</a></h3>
<p>Some new users to <em>ns-3</em> are unfamiliar with an extensively used programming
idiom used throughout the code: the <em>ns-3 callback</em>. This chapter provides some
motivation on the callback, guidance on how to use it, and details on its
implementation.</p>
<section id="callbacks-motivation">
<h4><span class="section-number">2.2.1. </span>Callbacks Motivation<a class="headerlink" href="#callbacks-motivation" title="Link to this heading">¶</a></h4>
<p>Consider that you have two simulation models A and B, and you wish to have them
pass information between them during the simulation. One way that you can do
that is that you can make A and B each explicitly knowledgeable about the other,
so that they can invoke methods on each other:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">ReceiveInput</span><span class="p">(</span><span class="w"> </span><span class="cm">/* parameters */</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and in another source file:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">DoSomething</span><span class="p">();</span>
<span class="w">  </span><span class="p">...</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="n">A</span><span class="o">*</span><span class="w"> </span><span class="n">a_instance</span><span class="p">;</span><span class="w"> </span><span class="c1">// pointer to an A</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">B</span><span class="o">::</span><span class="n">DoSomething</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// Tell a_instance that something happened</span>
<span class="w">  </span><span class="n">a_instance</span><span class="o">-&gt;</span><span class="n">ReceiveInput</span><span class="p">(</span><span class="w"> </span><span class="cm">/* parameters */</span><span class="w"> </span><span class="p">);</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This certainly works, but it has the drawback that it introduces a dependency on
A and B to know about the other at compile time (this makes it harder to have
independent compilation units in the simulator) and is not generalized; if in a
later usage scenario, B needs to talk to a completely different C object, the
source code for B needs to be changed to add a <code class="docutils literal notranslate"><span class="pre">c_instance</span></code> and so forth. It
is easy to see that this is a brute force mechanism of communication that can
lead to programming cruft in the models.</p>
<p>This is not to say that objects should not know about one another if there is a
hard dependency between them, but that often the model can be made more flexible
if its interactions are less constrained at compile time.</p>
<p>This is not an abstract problem for network simulation research, but rather it
has been a source of problems in previous simulators, when researchers want to
extend or modify the system to do different things (as they are apt to do in
research). Consider, for example, a user who wants to add an IPsec security
protocol sublayer between TCP and IP:</p>
<p>If the simulator has made assumptions, and hard coded into the code, that IP
always talks to a transport protocol above, the user may be forced to hack the
system to get the desired interconnections. This is clearly not an optimal way
to design a generic simulator.</p>
</section>
<section id="callbacks-background">
<h4><span class="section-number">2.2.2. </span>Callbacks Background<a class="headerlink" href="#callbacks-background" title="Link to this heading">¶</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Readers familiar with programming callbacks may skip this tutorial
section.</p>
</div>
<p>The basic mechanism that allows one to address the problem above is known as a
<em>callback</em>. The ultimate goal is to allow one piece of code to call a function
(or method in C++) without any specific inter-module dependency.</p>
<p>This ultimately means you need some kind of indirection – you treat the address
of the called function as a variable.  This variable is called a
pointer-to-function variable. The relationship between function and
pointer-to-function pointer is really no different that that of object and
pointer-to-object.</p>
<p>In C the canonical example of a pointer-to-function is a
pointer-to-function-returning-integer (PFI). For a PFI taking one int parameter,
this could be declared like,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">pfi</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>What you get from this is a variable named simply <code class="docutils literal notranslate"><span class="pre">pfi</span></code> that is initialized to
the value 0. If you want to initialize this pointer to something meaningful, you
have to have a function with a matching signature. In this case:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">MyFunction</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
</pre></div>
</div>
<p>If you have this target, you can initialize the variable to point to your
function like:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">pfi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyFunction</span><span class="p">;</span>
</pre></div>
</div>
<p>You can then call MyFunction indirectly using the more suggestive form of the
call:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">pfi</span><span class="p">)(</span><span class="mi">1234</span><span class="p">);</span>
</pre></div>
</div>
<p>This is suggestive since it looks like you are dereferencing the function
pointer just like you would dereference any pointer. Typically, however, people
take advantage of the fact that the compiler knows what is going on and will
just use a shorter form:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pfi</span><span class="p">(</span><span class="mi">1234</span><span class="p">);</span>
</pre></div>
</div>
<p>Notice that the function pointer obeys value semantics, so you can pass it
around like any other value. Typically, when you use an asynchronous interface
you will pass some entity like this to a function which will perform an action
and <em>call back</em> to let you know it completed. It calls back by following the
indirection and executing the provided function.</p>
<p>In C++ you have the added complexity of objects. The analogy with the PFI above
means you have a pointer to a member function returning an int (PMI) instead of
the pointer to function returning an int (PFI).</p>
<p>The declaration of the variable providing the indirection looks only slightly
different:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="n">MyClass</span><span class="o">::*</span><span class="n">pmi</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>This declares a variable named <code class="docutils literal notranslate"><span class="pre">pmi</span></code> just as the previous example declared a
variable named <code class="docutils literal notranslate"><span class="pre">pfi</span></code>. Since the will be to call a method of an instance of a
particular class, one must declare that method in a class:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">MyMethod</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Given this class declaration, one would then initialize that variable like
this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">pmi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MyClass</span><span class="o">::</span><span class="n">MyMethod</span><span class="p">;</span>
</pre></div>
</div>
<p>This assigns the address of the code implementing the method to the variable,
completing the indirection. In order to call a method, the code needs a <code class="docutils literal notranslate"><span class="pre">this</span></code>
pointer. This, in turn, means there must be an object of MyClass to refer to. A
simplistic example of this is just calling a method indirectly (think virtual
function):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="n">MyClass</span><span class="o">::*</span><span class="n">pmi</span><span class="p">)(</span><span class="kt">int</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">   </span><span class="c1">// Declare a PMI</span>
<span class="n">pmi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">MyClass</span><span class="o">::</span><span class="n">MyMethod</span><span class="p">;</span><span class="w">           </span><span class="c1">// Point at the implementation code</span>

<span class="n">MyClass</span><span class="w"> </span><span class="n">myClass</span><span class="p">;</span><span class="w">                    </span><span class="c1">// Need an instance of the class</span>
<span class="p">(</span><span class="n">myClass</span><span class="p">.</span><span class="o">*</span><span class="n">pmi</span><span class="p">)(</span><span class="mi">1234</span><span class="p">);</span><span class="w">              </span><span class="c1">// Call the method with an object ptr</span>
</pre></div>
</div>
<p>Just like in the C example, you can use this in an asynchronous call to another
module which will <em>call back</em> using a method and an object pointer. The
straightforward extension one might consider is to pass a pointer to the object
and the PMI variable. The module would just do:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="n">objectPtr</span><span class="p">.</span><span class="o">*</span><span class="n">pmi</span><span class="p">)(</span><span class="mi">1234</span><span class="p">);</span>
</pre></div>
</div>
<p>to execute the callback on the desired object.</p>
<p>One might ask at this time, <em>what’s the point</em>? The called module will have to
understand the concrete type of the calling object in order to properly make the
callback. Why not just accept this, pass the correctly typed object pointer and
do <code class="docutils literal notranslate"><span class="pre">object-&gt;Method(1234)</span></code> in the code instead of the callback?  This is
precisely the problem described above. What is needed is a way to decouple the
calling function from the called class completely. This requirement led to the
development of the <em>Functor</em>.</p>
<p>A functor is the outgrowth of something invented in the 1960s called a closure.
It is basically just a packaged-up function call, possibly with some state.</p>
<p>A functor has two parts, a specific part and a generic part, related through
inheritance. The calling code (the code that executes the callback) will execute
a generic overloaded <code class="docutils literal notranslate"><span class="pre">operator()</span></code> of a generic functor to cause the callback
to be called. The called code (the code that wants to be called back) will have
to provide a specialized implementation of the <code class="docutils literal notranslate"><span class="pre">operator()</span></code> that performs the
class-specific work that caused the close-coupling problem above.</p>
<p>With the specific functor and its overloaded <code class="docutils literal notranslate"><span class="pre">operator()</span></code> created, the called
code then gives the specialized code to the module that will execute the
callback (the calling code).</p>
<p>The calling code will take a generic functor as a parameter, so an implicit cast
is done in the function call to convert the specific functor to a generic
functor.  This means that the calling module just needs to understand the
generic functor type. It is decoupled from the calling code completely.</p>
<p>The information one needs to make a specific functor is the object pointer and
the pointer-to-method address.</p>
<p>The essence of what needs to happen is that the system declares a generic part
of the functor:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Functor</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="k">operator</span><span class="p">()(</span><span class="n">T</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The caller defines a specific part of the functor that really is just there to
implement the specific <code class="docutils literal notranslate"><span class="pre">operator()</span></code> method:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">ARG</span><span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SpecificFunctor</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Functor</span><span class="o">&lt;</span><span class="n">ARG</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">SpecificFunctor</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="o">::*</span><span class="n">_pmi</span><span class="p">)(</span><span class="n">ARG</span><span class="w"> </span><span class="n">arg</span><span class="p">))</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">m_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="n">m_pmi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_pmi</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="k">operator</span><span class="p">()(</span><span class="n">ARG</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">m_p</span><span class="p">.</span><span class="o">*</span><span class="n">m_pmi</span><span class="p">)(</span><span class="n">arg</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="o">::*</span><span class="n">m_pmi</span><span class="p">)(</span><span class="n">ARG</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
<span class="w">  </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">m_p</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Here is an example of the usage:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="n">A</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a0</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="kt">int</span><span class="w"> </span><span class="n">Hello</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">b0</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Hello from A, a = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; b0 = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">b0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">A</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">  </span><span class="n">SpecificFunctor</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">A</span><span class="o">::</span><span class="n">Hello</span><span class="p">);</span>
<span class="w">  </span><span class="n">sf</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The previous code is not real ns-3 code.  It is simplistic example
code used only to illustrate the concepts involved and to help you understand
the system more.  Do not expect to find this code anywhere in the ns-3 tree.</p>
</div>
<p>Notice that there are two variables defined in the class above.  The m_p
variable is the object pointer and m_pmi is the variable containing the
address of the function to execute.</p>
<p>Notice that when <code class="docutils literal notranslate"><span class="pre">operator()</span></code> is called, it in turn calls the method provided
with the object pointer using the C++ PMI syntax.</p>
<p>To use this, one could then declare some model code that takes a generic functor
as a parameter:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">LibraryFunction</span><span class="p">(</span><span class="n">Functor</span><span class="w"> </span><span class="n">functor</span><span class="p">);</span>
</pre></div>
</div>
<p>The code that will talk to the model would build a specific functor and pass it to <code class="docutils literal notranslate"><span class="pre">LibraryFunction</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">MyClass</span><span class="w"> </span><span class="n">myClass</span><span class="p">;</span>
<span class="n">SpecificFunctor</span><span class="o">&lt;</span><span class="n">MyClass</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">functor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myclass</span><span class="p">,</span><span class="w"> </span><span class="n">MyClass</span><span class="o">::</span><span class="n">MyMethod</span><span class="p">);</span>
</pre></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">LibraryFunction</span></code> is done, it executes the callback using the
<code class="docutils literal notranslate"><span class="pre">operator()</span></code> on the generic functor it was passed, and in this particular
case, provides the integer argument:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">LibraryFunction</span><span class="p">(</span><span class="n">Functor</span><span class="w"> </span><span class="n">functor</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// Execute the library function</span>
<span class="w">  </span><span class="n">functor</span><span class="p">(</span><span class="mi">1234</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">LibraryFunction</span></code> is completely decoupled from the specific
type of the client.  The connection is made through the Functor polymorphism.</p>
<p>The Callback API in <em>ns-3</em> implements object-oriented callbacks using
the functor mechanism.  This callback API, being based on C++ templates, is
type-safe; that is, it performs static type checks to enforce proper signature
compatibility between callers and callees.  It is therefore more type-safe to
use than traditional function pointers, but the syntax may look imposing at
first.  This section is designed to walk you through the Callback system so
that you can be comfortable using it in <em>ns-3</em>.</p>
</section>
<section id="using-the-callback-api">
<h4><span class="section-number">2.2.3. </span>Using the Callback API<a class="headerlink" href="#using-the-callback-api" title="Link to this heading">¶</a></h4>
<p>The Callback API is fairly minimal, providing only two services:</p>
<p>1. callback type declaration: a way to declare a type of callback
with a given signature, and,</p>
<p>2. callback instantiation: a way to instantiate a
template-generated forwarding callback which can forward any calls
to another C++ class member method or C++ function.</p>
<p>This is best observed via walking through an example, based on
<code class="docutils literal notranslate"><span class="pre">samples/main-callback.cc</span></code>.</p>
<section id="using-the-callback-api-with-static-functions">
<h5><span class="section-number">2.2.3.1. </span>Using the Callback API with static functions<a class="headerlink" href="#using-the-callback-api-with-static-functions" title="Link to this heading">¶</a></h5>
<p>Consider a function:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">double</span>
<span class="nf">CbOne</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;invoke cbOne a=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, b=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Consider also the following main program snippet:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// return type: double</span>
<span class="w">  </span><span class="c1">// first arg type: double</span>
<span class="w">  </span><span class="c1">// second arg type: double</span>
<span class="w">  </span><span class="n">Callback</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">one</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is an example of a C-style callback – one which does not include or need
a <code class="docutils literal notranslate"><span class="pre">this</span></code> pointer.  The function template <code class="docutils literal notranslate"><span class="pre">Callback</span></code> is essentially the
declaration of the variable containing the pointer-to-function.  In the example
above, we explicitly showed a pointer to a function that returned an integer and
took a single integer as a parameter,  The <code class="docutils literal notranslate"><span class="pre">Callback</span></code> template function is
a generic version of that – it is used to declare the type of a callback.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Readers unfamiliar with C++ templates may consult <a class="reference external" href="http://www.cplusplus.com/doc/tutorial/templates/">http://www.cplusplus.com/doc/tutorial/templates/</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Callback</span></code> template requires one mandatory argument (the return type
of the function to be assigned to this callback) and up to five optional
arguments, which each specify the type of the arguments (if your particular
callback function has more than five arguments, then this can be handled
by extending the callback implementation).</p>
<p>So in the above example, we have a declared a callback named “one” that will
eventually hold a function pointer.  The signature of the function that it will
hold must return double and must support two double arguments.  If one tries
to pass a function whose signature does not match the declared callback,
a compilation error will occur.  Also, if one tries to assign to a callback
an incompatible one, compilation will succeed but a run-time
NS_FATAL_ERROR will be raised.  The sample program
<code class="docutils literal notranslate"><span class="pre">src/core/examples/main-callback.cc</span></code> demonstrates both of these error cases
at the end of the <code class="docutils literal notranslate"><span class="pre">main()</span></code> program.</p>
<p>Now, we need to tie together this callback instance and the actual target function
(CbOne).  Notice above that CbOne has the same function signature types as the
callback– this is important.  We can pass in any such properly-typed function
to this callback.  Let’s look at this more closely:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="nf">CbOne</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="w">           </span><span class="o">^</span><span class="w">             </span><span class="o">^</span><span class="w">         </span><span class="o">^</span>
<span class="w">           </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">         </span><span class="o">|</span>
<span class="w">           </span><span class="o">|</span><span class="w">             </span><span class="o">|</span><span class="w">         </span><span class="o">|</span>
<span class="n">Callback</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w">       </span><span class="kt">double</span><span class="p">,</span><span class="w">   </span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">one</span><span class="p">;</span>
</pre></div>
</div>
<p>You can only bind a function to a callback if they have the matching signature.
The first template argument is the return type, and the additional template
arguments are the types of the arguments of the function signature.</p>
<p>Now, let’s bind our callback “one” to the function that matches its signature:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// build callback instance which points to cbOne function</span>
<span class="n">one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MakeCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CbOne</span><span class="p">);</span>
</pre></div>
</div>
<p>This call to <code class="docutils literal notranslate"><span class="pre">MakeCallback</span></code> is, in essence, creating one of the specialized
functors mentioned above.  The variable declared using the <code class="docutils literal notranslate"><span class="pre">Callback</span></code>
template function is going to be playing the part of the generic functor.  The
assignment <code class="docutils literal notranslate"><span class="pre">one</span> <span class="pre">=</span> <span class="pre">MakeCallback(&amp;CbOne)</span></code> is the cast that converts the
specialized functor known to the callee to a generic functor known to the caller.</p>
<p>Then, later in the program, if the callback is needed, it can be used as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NS_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">one</span><span class="p">.</span><span class="n">IsNull</span><span class="p">());</span>

<span class="c1">// invoke cbOne function through callback instance</span>
<span class="kt">double</span><span class="w"> </span><span class="n">retOne</span><span class="p">;</span>
<span class="n">retOne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">one</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span><span class="w"> </span><span class="mf">20.0</span><span class="p">);</span>
</pre></div>
</div>
<p>The check for <code class="docutils literal notranslate"><span class="pre">IsNull()</span></code> ensures that the callback is not null – that there
is a function to call behind this callback.  Then, <code class="docutils literal notranslate"><span class="pre">one()</span></code> executes the
generic <code class="docutils literal notranslate"><span class="pre">operator()</span></code> which is really overloaded with a specific implementation
of <code class="docutils literal notranslate"><span class="pre">operator()</span></code> and returns the same result as if <code class="docutils literal notranslate"><span class="pre">CbOne()</span></code> had been
called directly.</p>
</section>
<section id="using-the-callback-api-with-member-functions">
<h5><span class="section-number">2.2.3.2. </span>Using the Callback API with member functions<a class="headerlink" href="#using-the-callback-api-with-member-functions" title="Link to this heading">¶</a></h5>
<p>Generally, you will not be calling static functions but instead public member
functions of an object.  In this case, an extra argument is needed to the
MakeCallback function, to tell the system on which object the function should be
invoked.  Consider this example, also from main-callback.cc:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyCb</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">CbTwo</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;invoke cbTwo a=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">-5</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="c1">// return type: int</span>
<span class="w">  </span><span class="c1">// first arg type: double</span>
<span class="w">  </span><span class="n">Callback</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">two</span><span class="p">;</span>
<span class="w">  </span><span class="n">MyCb</span><span class="w"> </span><span class="n">cb</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// build callback instance which points to MyCb::cbTwo</span>
<span class="w">  </span><span class="n">two</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MakeCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyCb</span><span class="o">::</span><span class="n">CbTwo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cb</span><span class="p">);</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, we pass an additional object pointer to the <code class="docutils literal notranslate"><span class="pre">MakeCallback&lt;&gt;</span></code> function.
Recall from the background section above that <code class="docutils literal notranslate"><span class="pre">Operator()</span></code> will use the pointer to
member syntax when it executes on an object:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">operator</span><span class="p">()(</span><span class="n">ARG</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="p">(</span><span class="o">*</span><span class="n">m_p</span><span class="p">.</span><span class="o">*</span><span class="n">m_pmi</span><span class="p">)(</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And so we needed to provide the two variables (<code class="docutils literal notranslate"><span class="pre">m_p</span></code> and <code class="docutils literal notranslate"><span class="pre">m_pmi</span></code>) when
we made the specific functor.  The line:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">two</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MakeCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyCb</span><span class="o">::</span><span class="n">CbTwo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cb</span><span class="p">);</span>
</pre></div>
</div>
<p>does precisely that.  In this case, when <code class="docutils literal notranslate"><span class="pre">two()</span></code> is invoked:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">two</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</pre></div>
</div>
<p>will result in a call to the <code class="docutils literal notranslate"><span class="pre">CbTwo</span></code> member function (method) on the object
pointed to by <code class="docutils literal notranslate"><span class="pre">&amp;cb</span></code>.</p>
</section>
<section id="building-null-callbacks">
<h5><span class="section-number">2.2.3.3. </span>Building Null Callbacks<a class="headerlink" href="#building-null-callbacks" title="Link to this heading">¶</a></h5>
<p>It is possible for callbacks to be null; hence it may be wise to
check before using them.  There is a special construct for a null
callback, which is preferable to simply passing “0” as an argument;
it is the <code class="docutils literal notranslate"><span class="pre">MakeNullCallback&lt;&gt;</span></code> construct:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">two</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MakeNullCallback</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">NS_ASSERT</span><span class="p">(</span><span class="n">two</span><span class="p">.</span><span class="n">IsNull</span><span class="p">());</span>
</pre></div>
</div>
<p>Invoking a null callback is just like invoking a null function pointer: it will
crash at runtime.</p>
</section>
</section>
<section id="bound-callbacks">
<h4><span class="section-number">2.2.4. </span>Bound Callbacks<a class="headerlink" href="#bound-callbacks" title="Link to this heading">¶</a></h4>
<p>A very useful extension to the functor concept is that of a Bound Callback.
Previously it was mentioned that closures were originally function calls
packaged up for later execution.  Notice that in all of the Callback
descriptions above, there is no way to package up any parameters for use
later – when the <code class="docutils literal notranslate"><span class="pre">Callback</span></code> is called via <code class="docutils literal notranslate"><span class="pre">operator()</span></code>.  All of
the parameters are provided by the calling function.</p>
<p>What if it is desired to allow the client function (the one that provides the
callback) to provide some of the parameters?
<a class="reference external" href="http://erdani.org/index.php/books/modern-c-design/index.html">Alexandrescu</a>
calls the process of allowing a client to specify one of the parameters <em>“binding”</em>.
One of the parameters of <code class="docutils literal notranslate"><span class="pre">operator()</span></code> has been bound (fixed) by the client.</p>
<p>Some of our pcap tracing code provides a nice example of this.  There is a
function that needs to be called whenever a packet is received.  This function
calls an object that actually writes the packet to disk in the pcap file
format.  The signature of one of these functions will be:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">DefaultSink</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">PcapFileWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">Packet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
</pre></div>
</div>
<p>The static keyword means this is a static function which does not need a
<code class="docutils literal notranslate"><span class="pre">this</span></code> pointer, so it will be using C-style callbacks.  We don’t want the
calling code to have to know about anything but the Packet.  What we want in
the calling code is just a call that looks like:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">m_promiscSnifferTrace</span><span class="p">(</span><span class="n">m_currentPkt</span><span class="p">);</span>
</pre></div>
</div>
<p>What we want to do is to <em>bind</em> the <code class="docutils literal notranslate"><span class="pre">Ptr&lt;PcapFileWriter&gt;</span> <span class="pre">file</span></code> to the
specific callback implementation when it is created and arrange for the
<code class="docutils literal notranslate"><span class="pre">operator()</span></code> of the Callback to provide that parameter for free.</p>
<p>We provide the <code class="docutils literal notranslate"><span class="pre">MakeBoundCallback</span></code> template function for that purpose.  It
takes the same parameters as the <code class="docutils literal notranslate"><span class="pre">MakeCallback</span></code> template function but also
takes the parameters to be bound.  In the case of the example above:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">MakeBoundCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DefaultSink</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">);</span>
</pre></div>
</div>
<p>will create a specific callback implementation that knows to add in the extra
bound arguments.  Conceptually, it extends the specific functor described above
with one or more bound arguments:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">ARG</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">BOUND_ARG</span><span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SpecificFunctor</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Functor</span>
<span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">SpecificFunctor</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="o">::*</span><span class="n">_pmi</span><span class="p">)(</span><span class="n">ARG</span><span class="w"> </span><span class="n">arg</span><span class="p">),</span><span class="w"> </span><span class="n">BOUND_ARG</span><span class="w"> </span><span class="n">boundArg</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">m_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">      </span><span class="n">m_pmi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pmi</span><span class="p">;</span>
<span class="w">      </span><span class="n">m_boundArg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boundArg</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="k">operator</span><span class="p">()(</span><span class="n">ARG</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="p">(</span><span class="o">*</span><span class="n">m_p</span><span class="p">.</span><span class="o">*</span><span class="n">m_pmi</span><span class="p">)(</span><span class="n">m_boundArg</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="o">::*</span><span class="n">m_pmi</span><span class="p">)(</span><span class="n">ARG</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
<span class="w">    </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">m_p</span><span class="p">;</span>
<span class="w">    </span><span class="n">BOUND_ARG</span><span class="w"> </span><span class="n">m_boundArg</span><span class="p">;</span>
<span class="w"> </span><span class="p">};</span>
</pre></div>
</div>
<p>You can see that when the specific functor is created, the bound argument is saved
in the functor / callback object itself.  When the <code class="docutils literal notranslate"><span class="pre">operator()</span></code> is invoked with
the single parameter, as in:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">m_promiscSnifferTrace</span><span class="p">(</span><span class="n">m_currentPkt</span><span class="p">);</span>
</pre></div>
</div>
<p>the implementation of <code class="docutils literal notranslate"><span class="pre">operator()</span></code> adds the bound parameter into the actual
function call:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="n">m_p</span><span class="p">.</span><span class="o">*</span><span class="n">m_pmi</span><span class="p">)(</span><span class="n">m_boundArg</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
</pre></div>
</div>
<p>It’s possible to bind two or three arguments as well.  Say we have a function with
signature:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">NotifyEvent</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">MyEventType</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</pre></div>
</div>
<p>One can create bound callback binding first two arguments like:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">MakeBoundCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NotifyEvent</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">b1</span><span class="p">);</span>
</pre></div>
</div>
<p>assuming <cite>a1</cite> and <cite>b1</cite> are objects of type <cite>A</cite> and <cite>B</cite> respectively.  Similarly for
three arguments one would have function with a signature:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">NotifyEvent</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">MyEventType</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
</pre></div>
</div>
<p>Binding three arguments in done with:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">MakeBoundCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NotifyEvent</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="n">c1</span><span class="p">);</span>
</pre></div>
</div>
<p>again assuming <cite>a1</cite>, <cite>b1</cite> and <cite>c1</cite> are objects of type <cite>A</cite>, <cite>B</cite> and <cite>C</cite> respectively.</p>
<p>This kind of binding can be used for exchanging information between objects in
simulation; specifically, bound callbacks can be used as traced callbacks, which will
be described in the next section.</p>
</section>
<section id="traced-callbacks">
<h4><span class="section-number">2.2.5. </span>Traced Callbacks<a class="headerlink" href="#traced-callbacks" title="Link to this heading">¶</a></h4>
<p><em>Placeholder subsection</em></p>
</section>
<section id="callback-locations-in-ns-3">
<h4><span class="section-number">2.2.6. </span>Callback locations in ns-3<a class="headerlink" href="#callback-locations-in-ns-3" title="Link to this heading">¶</a></h4>
<p>Where are callbacks frequently used in <em>ns-3</em>?  Here are some of the
more visible ones to typical users:</p>
<ul class="simple">
<li><p>Socket API</p></li>
<li><p>Layer-2/Layer-3 API</p></li>
<li><p>Tracing subsystem</p></li>
<li><p>API between IP and routing subsystems</p></li>
</ul>
</section>
<section id="implementation-details">
<h4><span class="section-number">2.2.7. </span>Implementation details<a class="headerlink" href="#implementation-details" title="Link to this heading">¶</a></h4>
<p>The code snippets above are simplistic and only designed to illustrate the mechanism
itself.  The actual Callback code is quite complicated and very template-intense and
a deep understanding of the code is not required.  If interested, expert users may
find the following useful.</p>
<p>The code was originally written based on the techniques described in
<a class="reference external" href="http://www.codeproject.com/cpp/TTLFunction.asp">http://www.codeproject.com/cpp/TTLFunction.asp</a>.
It was subsequently rewritten to follow the architecture outlined in
<a class="reference external" href="http://erdani.org/index.php/books/modern-c-design/index.html">Modern C++ Design, Generic Programming and Design Patterns Applied, Alexandrescu, chapter 5, Generalized Functors</a>.</p>
<p>This code uses:</p>
<ul class="simple">
<li><p>default template parameters to saves users from having to
specify empty parameters when the number of parameters
is smaller than the maximum supported number</p></li>
<li><p>the pimpl idiom: the Callback class is passed around by
value and delegates the crux of the work to its pimpl pointer.</p></li>
<li><p>two pimpl implementations which derive from CallbackImpl
FunctorCallbackImpl can be used with any functor-type
while MemPtrCallbackImpl can be used with pointers to
member functions.</p></li>
<li><p>a reference list implementation to implement the Callback’s
value semantics.</p></li>
</ul>
<p>This code most notably departs from the Alexandrescu implementation in that it
does not use type lists to specify and pass around the types of the callback
arguments. Of course, it also does not use copy-destruction semantics and
relies on a reference list rather than autoPtr to hold the pointer.</p>
</section>
</section>
<span id="document-object-model"></span><section id="object-model">
<span id="id1"></span><h3><span class="section-number">2.3. </span>Object model<a class="headerlink" href="#object-model" title="Link to this heading">¶</a></h3>
<p><em>ns-3</em> is fundamentally a C++ object system. Objects can be declared and
instantiated as usual, per C++ rules. <em>ns-3</em> also adds some features to
traditional C++ objects, as described below, to provide greater functionality
and features. This manual chapter is intended to introduce the reader to the
<em>ns-3</em> object model.</p>
<p>This section describes the C++ class design for <em>ns-3</em> objects. In brief,
several design patterns in use include classic object-oriented design
(polymorphic interfaces and implementations), separation of interface and
implementation, the non-virtual public interface design pattern, an object
aggregation facility, and reference counting for memory management. Those
familiar with component models such as COM or Bonobo will recognize elements of
the design in the <em>ns-3</em> object aggregation model, although the <em>ns-3</em> design is
not strictly in accordance with either.</p>
<section id="object-oriented-behavior">
<h4><span class="section-number">2.3.1. </span>Object-oriented behavior<a class="headerlink" href="#object-oriented-behavior" title="Link to this heading">¶</a></h4>
<p>C++ objects, in general, provide common object-oriented capabilities
(abstraction, encapsulation, inheritance, and polymorphism) that are part
of classic object-oriented design. <em>ns-3</em> objects make use of these
properties; for instance:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Address</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">Address</span><span class="p">();</span>
<span class="w">  </span><span class="n">Address</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="w">  </span><span class="n">Address</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Address</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">address</span><span class="p">);</span>
<span class="w">  </span><span class="n">Address</span><span class="w"> </span><span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Address</span><span class="w"> </span><span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
<span class="w">  </span><span class="p">...</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">m_type</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">m_len</span><span class="p">;</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="object-base-classes">
<h4><span class="section-number">2.3.2. </span>Object base classes<a class="headerlink" href="#object-base-classes" title="Link to this heading">¶</a></h4>
<p>There are three special base classes used in <em>ns-3</em>. Classes that inherit
from these base classes can instantiate objects with special properties.
These base classes are:</p>
<ul class="simple">
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ObjectBase</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">SimpleRefCount</span></code></p></li>
</ul>
<p>It is not required that <em>ns-3</em> objects inherit from these class, but
those that do get special properties. Classes deriving from
class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code> get the following properties.</p>
<ul class="simple">
<li><p>the <em>ns-3</em> type and attribute system (see <a class="reference internal" href="index.html#attributes"><span class="std std-ref">Configuration and Attributes</span></a>)</p></li>
<li><p>an object aggregation system</p></li>
<li><p>a smart-pointer reference counting system (class Ptr)</p></li>
</ul>
<p>Classes that derive from class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ObjectBase</span></code> get the first two
properties above, but do not get smart pointers. Classes that derive from class
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">SimpleRefCount</span></code>: get only the smart-pointer reference counting
system.</p>
<p>In practice, class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code> is the variant of the three above that
the <em>ns-3</em> developer will most commonly encounter.</p>
</section>
<section id="memory-management-and-class-ptr">
<span id="id2"></span><h4><span class="section-number">2.3.3. </span>Memory management and class Ptr<a class="headerlink" href="#memory-management-and-class-ptr" title="Link to this heading">¶</a></h4>
<p>Memory management in a C++ program is a complex process, and is often done
incorrectly or inconsistently. We have settled on a reference counting design
described as follows.</p>
<p>All objects using reference counting maintain an internal reference count to
determine when an object can safely delete itself. Each time that a pointer is
obtained to an interface, the object’s reference count is incremented by calling
<code class="docutils literal notranslate"><span class="pre">Ref()</span></code>. It is the obligation of the user of the pointer to explicitly
<code class="docutils literal notranslate"><span class="pre">Unref()</span></code> the pointer when done. When the reference count falls to zero, the
object is deleted.</p>
<ul class="simple">
<li><p>When the client code obtains a pointer from the object itself through object
creation, or via GetObject, it does not have to increment the reference count.</p></li>
<li><p>When client code obtains a pointer from another source (e.g., copying a
pointer) it must call <code class="docutils literal notranslate"><span class="pre">Ref()</span></code> to increment the reference count.</p></li>
<li><p>All users of the object pointer must call <code class="docutils literal notranslate"><span class="pre">Unref()</span></code> to release the
reference.</p></li>
</ul>
<p>The burden for calling <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">Unref()</span></code> is somewhat relieved by the use of
the reference counting smart pointer class described below.</p>
<p>Users using a low-level API who wish to explicitly allocate
non-reference-counted objects on the heap, using operator new, are responsible
for deleting such objects.</p>
<section id="reference-counting-smart-pointer-ptr">
<h5><span class="section-number">2.3.3.1. </span>Reference counting smart pointer (Ptr)<a class="headerlink" href="#reference-counting-smart-pointer-ptr" title="Link to this heading">¶</a></h5>
<p>Calling <code class="docutils literal notranslate"><span class="pre">Ref()</span></code> and <code class="docutils literal notranslate"><span class="pre">Unref()</span></code> all the time would be cumbersome, so <em>ns-3</em>
provides a smart pointer class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Ptr</span></code> similar to
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Boost::intrusive_ptr</span></code>. This smart-pointer class assumes that the
underlying type provides a pair of <code class="docutils literal notranslate"><span class="pre">Ref</span></code> and <code class="docutils literal notranslate"><span class="pre">Unref</span></code> methods that are
expected to increment and decrement the internal refcount of the object
instance.</p>
<p>This implementation allows you to manipulate the smart pointer as if it was a
normal pointer: you can compare it with zero, compare it against other pointers,
assign zero to it, etc.</p>
<p>It is possible to extract the raw pointer from this smart pointer with the
<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GetPointer()</span></code> and <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">PeekPointer()</span></code> methods.</p>
<p>If you want to store a newed object into a smart pointer, we recommend you to
use the CreateObject template functions to create the object and store it in a
smart pointer to avoid memory leaks. These functions are really small
convenience functions and their goal is just to save you a small bit of typing.</p>
</section>
</section>
<section id="createobject-and-create">
<h4><span class="section-number">2.3.4. </span>CreateObject and Create<a class="headerlink" href="#createobject-and-create" title="Link to this heading">¶</a></h4>
<p>Objects in C++ may be statically, dynamically, or automatically created.  This
holds true for <em>ns-3</em> also, but some objects in the system have some additional
frameworks available. Specifically, reference counted objects are usually
allocated using a templated Create or CreateObject method, as follows.</p>
<p>For objects deriving from class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">WifiNetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">WifiNetDevice</span><span class="o">&gt;</span><span class="p">();</span>
</pre></div>
</div>
<p>Please do not create such objects using <code class="docutils literal notranslate"><span class="pre">operator</span> <span class="pre">new</span></code>; create them using
<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">CreateObject()</span></code> instead.</p>
<p>For objects deriving from class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">SimpleRefCount</span></code>, or other objects
that support usage of the smart pointer class, a templated helper function is
available and recommended to be used:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Create</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="p">();</span>
</pre></div>
</div>
<p>This is simply a wrapper around operator new that correctly handles the
reference counting system.</p>
<p>In summary, use <code class="docutils literal notranslate"><span class="pre">Create&lt;B&gt;</span></code> if B is not an object but just uses reference
counting (e.g. <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Packet</span></code>), and use <code class="docutils literal notranslate"><span class="pre">CreateObject&lt;B&gt;</span></code> if B derives
from <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::Object</span></code>.</p>
</section>
<section id="aggregation">
<h4><span class="section-number">2.3.5. </span>Aggregation<a class="headerlink" href="#aggregation" title="Link to this heading">¶</a></h4>
<p>The <em>ns-3</em> object aggregation system is motivated in strong part by a recognition
that a common use case for <em>ns-2</em> has been the use of inheritance and
polymorphism to extend protocol models. For instance, specialized versions of
TCP such as RenoTcpAgent derive from (and override functions from) class
TcpAgent.</p>
<p>However, two problems that have arisen in the <em>ns-2</em> model are downcasts and
“weak base class.” Downcasting refers to the procedure of using a base class
pointer to an object and querying it at run time to find out type information,
used to explicitly cast the pointer to a subclass pointer so that the subclass
API can be used. Weak base class refers to the problems that arise when a class
cannot be effectively reused (derived from) because it lacks necessary
functionality, leading the developer to have to modify the base class and
causing proliferation of base class API calls, some of which may not be
semantically correct for all subclasses.</p>
<p><em>ns-3</em> is using a version of the query interface design pattern to avoid these
problems. This design is based on elements of the <a class="reference external" href="http://en.wikipedia.org/wiki/Component_Object_Model">Component Object Model</a> and <a class="reference external" href="http://en.wikipedia.org/wiki/Bonobo_(component_model)">GNOME Bonobo</a> although full
binary-level compatibility of replaceable components is not supported and we
have tried to simplify the syntax and impact on model developers.</p>
</section>
<section id="examples">
<h4><span class="section-number">2.3.6. </span>Examples<a class="headerlink" href="#examples" title="Link to this heading">¶</a></h4>
<section id="aggregation-example">
<h5><span class="section-number">2.3.6.1. </span>Aggregation example<a class="headerlink" href="#aggregation-example" title="Link to this heading">¶</a></h5>
<p><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Node</span></code> is a good example of the use of aggregation in <em>ns-3</em>.  Note
that there are not derived classes of Nodes in <em>ns-3</em> such as class
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">InternetNode</span></code>.  Instead, components (protocols) are aggregated to a
node. Let’s look at how some Ipv4 protocols are added to a node.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">AddIpv4Stack</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4L3Protocol</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">Ipv4L3Protocol</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">  </span><span class="n">ipv4</span><span class="o">-&gt;</span><span class="n">SetNode</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
<span class="w">  </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">AggregateObject</span><span class="p">(</span><span class="n">ipv4</span><span class="p">);</span>
<span class="w">  </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4Impl</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4Impl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">Ipv4Impl</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">  </span><span class="n">ipv4Impl</span><span class="o">-&gt;</span><span class="n">SetIpv4</span><span class="p">(</span><span class="n">ipv4</span><span class="p">);</span>
<span class="w">  </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">AggregateObject</span><span class="p">(</span><span class="n">ipv4Impl</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that the Ipv4 protocols are created using <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">CreateObject()</span></code>.
Then, they are aggregated to the node. In this manner, the Node base class does
not need to be edited to allow users with a base class Node pointer to access
the Ipv4 interface; users may ask the node for a pointer to its Ipv4 interface
at runtime. How the user asks the node is described in the next subsection.</p>
<p>Note that it is a programming error to aggregate more than one object of the
same type to an <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::Object</span></code>. So, for instance, aggregation is not
an option for storing all of the active sockets of a node.</p>
</section>
<section id="getobject-example">
<h5><span class="section-number">2.3.6.2. </span>GetObject example<a class="headerlink" href="#getobject-example" title="Link to this heading">¶</a></h5>
<p>GetObject is a type-safe way to achieve a safe downcasting and to allow
interfaces to be found on an object.</p>
<p>Consider a node pointer <code class="docutils literal notranslate"><span class="pre">m_node</span></code> that points to a Node object that has an
implementation of IPv4 previously aggregated to it. The client code wishes to
configure a default route. To do so, it must access an object within the node
that has an interface to the IP forwarding configuration. It performs the
following:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_node</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="p">();</span>
</pre></div>
</div>
<p>If the node in fact does not have an Ipv4 object aggregated to it, then the
method will return null. Therefore, it is good practice to check the return
value from such a function call. If successful, the user can now use the Ptr to
the Ipv4 object that was previously aggregated to the node.</p>
<p>Another example of how one might use aggregation is to add optional models to
objects. For instance, an existing Node object may have an “Energy Model” object
aggregated to it at run time (without modifying and recompiling the node class).
An existing model (such as a wireless net device) can then later “GetObject” for
the energy model and act appropriately if the interface has been either built in
to the underlying Node object or aggregated to it at run time.  However, other
nodes need not know anything about energy models.</p>
<p>We hope that this mode of programming will require much less need for developers
to modify the base classes.</p>
</section>
</section>
<section id="object-factories">
<h4><span class="section-number">2.3.7. </span>Object factories<a class="headerlink" href="#object-factories" title="Link to this heading">¶</a></h4>
<p>A common use case is to create lots of similarly configured objects. One can
repeatedly call <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">CreateObject()</span></code> but there is also a factory design
pattern in use in the <em>ns-3</em> system. It is heavily used in the “helper” API.</p>
<p>Class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ObjectFactory</span></code> can be used to instantiate objects and to
configure the attributes on those objects:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">SetTypeId</span><span class="p">(</span><span class="n">TypeId</span><span class="w"> </span><span class="n">tid</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">Set</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">AttributeValue</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Create</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p>The first method allows one to use the <em>ns-3</em> TypeId system to specify the type
of objects created. The second allows one to set attributes on the objects to be
created, and the third allows one to create the objects themselves.</p>
<p>For example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">ObjectFactory</span><span class="w"> </span><span class="n">factory</span><span class="p">;</span>
<span class="c1">// Make this factory create objects of type FriisPropagationLossModel</span>
<span class="n">factory</span><span class="p">.</span><span class="n">SetTypeId</span><span class="p">(</span><span class="s">&quot;ns3::FriisPropagationLossModel&quot;</span><span class="p">)</span>
<span class="c1">// Make this factory object change a default value of an attribute, for</span>
<span class="c1">// subsequently created objects</span>
<span class="n">factory</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="s">&quot;SystemLoss&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DoubleValue</span><span class="p">(</span><span class="mf">2.0</span><span class="p">));</span>
<span class="c1">// Create one such object</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factory</span><span class="p">.</span><span class="n">Create</span><span class="p">();</span>
<span class="n">factory</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="s">&quot;SystemLoss&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DoubleValue</span><span class="p">(</span><span class="mf">3.0</span><span class="p">));</span>
<span class="c1">// Create another object with a different SystemLoss</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factory</span><span class="p">.</span><span class="n">Create</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="downcasting">
<h4><span class="section-number">2.3.8. </span>Downcasting<a class="headerlink" href="#downcasting" title="Link to this heading">¶</a></h4>
<p>A question that has arisen several times is, “If I have a base class pointer
(Ptr) to an object and I want the derived class pointer, should I downcast (via
C++ dynamic cast) to get the derived pointer, or should I use the object
aggregation system to <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GetObject&lt;&gt;</span> <span class="pre">()</span></code> to find a Ptr to the interface
to the subclass API?”</p>
<p>The answer to this is that in many situations, both techniques will work.
<em>ns-3</em> provides a templated function for making the syntax of Object
dynamic casting much more user friendly:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T1</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">T2</span><span class="o">&gt;</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">T1</span><span class="o">&gt;</span>
<span class="n">DynamicCast</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">T2</span><span class="o">&gt;</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">T1</span><span class="o">&gt;</span><span class="p">(</span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">T1</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">PeekPointer</span><span class="p">(</span><span class="n">p</span><span class="p">)));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>DynamicCast works when the programmer has a base type pointer and is testing
against a subclass pointer. GetObject works when looking for different objects
aggregated, but also works with subclasses, in the same way as DynamicCast. If
unsure, the programmer should use GetObject, as it works in all cases. If the
programmer knows the class hierarchy of the object under consideration, it is
more direct to just use DynamicCast.</p>
</section>
</section>
<span id="document-attributes"></span><section id="configuration-and-attributes">
<span id="attributes"></span><h3><span class="section-number">2.4. </span>Configuration and Attributes<a class="headerlink" href="#configuration-and-attributes" title="Link to this heading">¶</a></h3>
<p>In <em>ns-3</em> simulations, there are two main aspects to configuration:</p>
<ul class="simple">
<li><p>The simulation topology and how objects are connected.</p></li>
<li><p>The values used by the models instantiated in the topology.</p></li>
</ul>
<p>This chapter focuses on the second item above: how the many values in use in
<em>ns-3</em> are organized, documented, and modifiable by <em>ns-3</em> users. The <em>ns-3</em>
attribute system is also the underpinning of how traces and statistics are
gathered in the simulator.</p>
<p>In the course of this chapter we will discuss the various ways to set or
modify the values used by <em>ns-3</em> model objects.  In increasing order of
specificity, these are:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Method</p></th>
<th class="head"><p>Scope</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Default Attribute values set when
Attributes are defined in
<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GetTypeId()</span></code>.</p></td>
<td><p>Affect all instances of the class.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">CommandLine</span></code>
<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">Config::SetDefault()</span></code>
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ConfigStore</span></code></p></td>
<td><p>Affect all future instances.</p></td>
</tr>
<tr class="row-even"><td><p><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ObjectFactory</span></code></p></td>
<td><p>Affects all instances created with
the factory.</p></td>
</tr>
<tr class="row-odd"><td><p>Helper methods with (string/
AttributeValue) parameter pairs</p></td>
<td><p>Affects all instances created by
the helper.</p></td>
</tr>
<tr class="row-even"><td><p><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MyClass::SetX()</span></code>
<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">Object::SetAttribute()</span></code>
<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">Config::Set()</span></code></p></td>
<td><p>Alters this particular instance.
Generally this is the only form
which can be scheduled to alter
an instance once the simulation
is running.</p></td>
</tr>
</tbody>
</table>
<p>By “specificity” we mean that methods in later rows in the table
override the values set by, and typically affect fewer instances than,
earlier methods.</p>
<p>Before delving into details of the attribute value system, it will help to
review some basic properties of class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code>.</p>
<section id="object-overview">
<h4><span class="section-number">2.4.1. </span>Object Overview<a class="headerlink" href="#object-overview" title="Link to this heading">¶</a></h4>
<p><em>ns-3</em> is fundamentally a C++ object-based system. By this we mean that new C++
classes (types) can be declared, defined, and subclassed as usual.</p>
<p>Many <em>ns-3</em> objects inherit from the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code> base class.  These
objects have some additional properties that we exploit for organizing the
system and improving the memory management of our objects:</p>
<ul class="simple">
<li><p>“Metadata” system that links the class name to a lot of meta-information
about the object, including:</p>
<ul>
<li><p>The base class of the subclass,</p></li>
<li><p>The set of accessible constructors in the subclass,</p></li>
<li><p>The set of “attributes” of the subclass,</p></li>
<li><p>Whether each attribute can be set, or is read-only,</p></li>
<li><p>The allowed range of values for each attribute.</p></li>
</ul>
</li>
<li><p>Reference counting smart pointer implementation, for memory management.</p></li>
</ul>
<p><em>ns-3</em> objects that use the attribute system derive from either
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code> or <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ObjectBase</span></code>. Most <em>ns-3</em> objects we
will discuss derive from <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code>, but a few that are outside
the smart pointer memory management framework derive from
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ObjectBase</span></code>.</p>
<p>Let’s review a couple of properties of these objects.</p>
<section id="smart-pointers">
<h5><span class="section-number">2.4.1.1. </span>Smart Pointers<a class="headerlink" href="#smart-pointers" title="Link to this heading">¶</a></h5>
<p>As introduced in the <em>ns-3</em> tutorial, <em>ns-3</em> objects are memory managed by a
<a class="reference external" href="http://en.wikipedia.org/wiki/Smart_pointer">reference counting smart pointer implementation</a>, class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Ptr</span></code>.</p>
<p>Smart pointers are used extensively in the <em>ns-3</em> APIs, to avoid passing
references to heap-allocated objects that may cause memory leaks.
For most basic usage (syntax), treat a smart pointer like a regular pointer:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">WifiNetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span>
<span class="n">nd</span><span class="o">-&gt;</span><span class="n">CallSomeFunction</span><span class="p">();</span>
<span class="c1">// etc.</span>
</pre></div>
</div>
<p>So how do you get a smart pointer to an object, as in the first line
of this example?</p>
<section id="createobject">
<h6><span class="section-number">2.4.1.1.1. </span>CreateObject<a class="headerlink" href="#createobject" title="Link to this heading">¶</a></h6>
<p>As we discussed above in <a class="reference internal" href="index.html#memory-management-and-class-ptr"><span class="std std-ref">Memory management and class Ptr</span></a>, at the
lowest-level API, objects of type <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code> are not instantiated
using <code class="docutils literal notranslate"><span class="pre">operator</span> <span class="pre">new</span></code> as usual but instead by a templated function called
<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">CreateObject()</span></code>.</p>
<p>A typical way to create such an object is as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">WifiNetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">WifiNetDevice</span><span class="o">&gt;</span><span class="p">();</span>
</pre></div>
</div>
<p>You can think of this as being functionally equivalent to:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">WifiNetDevice</span><span class="o">*</span><span class="w"> </span><span class="n">nd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">WifiNetDevice</span><span class="p">();</span>
</pre></div>
</div>
<p>Objects that derive from <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code> must be allocated on the heap
using <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">CreateObject()</span></code>. Those deriving from <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ObjectBase</span></code>,
such as <em>ns-3</em> helper functions and packet headers and trailers,
can be allocated on the stack.</p>
<p>In some scripts, you may not see a lot of <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">CreateObject()</span></code> calls
in the code; this is because there are some helper objects in effect
that are doing the <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">CreateObject()</span></code> calls for you.</p>
</section>
</section>
<section id="typeid">
<h5><span class="section-number">2.4.1.2. </span>TypeId<a class="headerlink" href="#typeid" title="Link to this heading">¶</a></h5>
<p><em>ns-3</em> classes that derive from class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code> can include
a metadata class called <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">TypeId</span></code> that records meta-information
about the class, for use in the object aggregation and component manager
systems:</p>
<ul class="simple">
<li><p>A unique string identifying the class.</p></li>
<li><p>The base class of the subclass, within the metadata system.</p></li>
<li><p>The set of accessible constructors in the subclass.</p></li>
<li><p>A list of publicly accessible properties (“attributes”) of the class.</p></li>
</ul>
</section>
<section id="object-summary">
<h5><span class="section-number">2.4.1.3. </span>Object Summary<a class="headerlink" href="#object-summary" title="Link to this heading">¶</a></h5>
<p>Putting all of these concepts together, let’s look at a specific
example: class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Node</span></code>.</p>
<p>The public header file <code class="docutils literal notranslate"><span class="pre">node.h</span></code> has a declaration that includes
a static <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GetTypeId()</span></code> function call:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Node</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Object</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">GetTypeId</span><span class="p">();</span>
<span class="w">  </span><span class="p">...</span>
</pre></div>
</div>
<p>This is defined in the <code class="docutils literal notranslate"><span class="pre">node.cc</span></code> file as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">TypeId</span>
<span class="nf">Node::GetTypeId</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeId</span><span class="p">(</span><span class="s">&quot;ns3::Node&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">SetParent</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">SetGroupName</span><span class="p">(</span><span class="s">&quot;Network&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddConstructor</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddAttribute</span><span class="p">(</span><span class="s">&quot;DeviceList&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="s">&quot;The list of devices associated to this Node.&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="n">ObjectVectorValue</span><span class="p">(),</span>
<span class="w">                  </span><span class="n">MakeObjectVectorAccessor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Node</span><span class="o">::</span><span class="n">m_devices</span><span class="p">),</span>
<span class="w">                  </span><span class="n">MakeObjectVectorChecker</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddAttribute</span><span class="p">(</span><span class="s">&quot;ApplicationList&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="s">&quot;The list of applications associated to this Node.&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="n">ObjectVectorValue</span><span class="p">(),</span>
<span class="w">                  </span><span class="n">MakeObjectVectorAccessor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Node</span><span class="o">::</span><span class="n">m_applications</span><span class="p">),</span>
<span class="w">                  </span><span class="n">MakeObjectVectorChecker</span><span class="o">&lt;</span><span class="n">Application</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddAttribute</span><span class="p">(</span><span class="s">&quot;Id&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="s">&quot;The id(unique integer) of this Node.&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="n">TypeId</span><span class="o">::</span><span class="n">ATTR_GET</span><span class="p">,</span><span class="w"> </span><span class="c1">// allow only getting it.</span>
<span class="w">                  </span><span class="n">UintegerValue</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="w">                  </span><span class="n">MakeUintegerAccessor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Node</span><span class="o">::</span><span class="n">m_id</span><span class="p">),</span>
<span class="w">                  </span><span class="n">MakeUintegerChecker</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">    </span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Consider the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">TypeId</span></code> of the <em>ns-3</em> <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code> class
as an extended form of run time type information (RTTI). The C++ language
includes a simple kind of RTTI in order to support <code class="docutils literal notranslate"><span class="pre">dynamic_cast</span></code> and
<code class="docutils literal notranslate"><span class="pre">typeid</span></code> operators.</p>
<p>The <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">SetParent&lt;Object&gt;()</span></code> call in the definition above is used in
conjunction with our object aggregation mechanisms to allow safe up- and
down-casting in inheritance trees during <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GetObject()</span></code>.
It also enables subclasses to inherit the Attributes of their parent class.</p>
<p>The <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">AddConstructor&lt;Node&gt;()</span></code> call is used in conjunction
with our abstract object factory mechanisms to allow us to construct
C++ objects without forcing a user to know the concrete class of
the object she is building.</p>
<p>The three calls to <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">AddAttribute()</span></code> associate a given string
with a strongly typed value in the class. Notice that you must provide
a help string which may be displayed, for example, <em>via</em> command line
processors. Each <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Attribute</span></code> is associated with mechanisms
for accessing the underlying member variable in the object (for example,
<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">MakeUintegerAccessor()</span></code> tells the generic <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Attribute</span></code>
code how to get to the node ID above). There are also “Checker” methods which
are used to validate values against range limitations, such as maximum
and minimum allowed values.</p>
<p>When users want to create Nodes, they will usually call some form of
<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">CreateObject()</span></code>,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="p">();</span>
</pre></div>
</div>
<p>or more abstractly, using an object factory, you can create a
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Node</span></code> object without even knowing the concrete C++ type:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">ObjectFactory</span><span class="w"> </span><span class="n">factory</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">typeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ns3::Node&#39;&#39;;</span>
<span class="n">factory</span><span class="p">.</span><span class="n">SetTypeId</span><span class="p">(</span><span class="n">typeId</span><span class="p">);</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factory</span><span class="p">.</span><span class="n">Create</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">();</span>
</pre></div>
</div>
<p>Both of these methods result in fully initialized attributes being available
in the resulting <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code> instances.</p>
<p>We next discuss how attributes (values associated with member variables or
functions of the class) are plumbed into the above <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">TypeId</span></code>.</p>
</section>
</section>
<section id="id1">
<h4><span class="section-number">2.4.2. </span>Attributes<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h4>
<p>The goal of the attribute system is to organize the access of
internal member objects of a simulation. This goal arises because,
typically in simulation, users will cut and paste/modify existing
simulation scripts, or will use higher-level simulation constructs,
but often will be interested in studying or tracing particular
internal variables.  For instance, use cases such as:</p>
<ul class="simple">
<li><p><em>“I want to trace the packets on the wireless interface only on the first
access point.”</em></p></li>
<li><p><em>“I want to trace the value of the TCP congestion window (every time it
changes) on a particular TCP socket.”</em></p></li>
<li><p><em>“I want a dump of all values that were used in my simulation.”</em></p></li>
</ul>
<p>Similarly, users may want fine-grained access to internal variables in the
simulation, or may want to broadly change the initial value used for a
particular parameter in all subsequently created objects. Finally, users may
wish to know what variables are settable and retrievable in a simulation
configuration. This is not just for direct simulation interaction on the command
line; consider also a (future) graphical user interface that would like to be
able to provide a feature whereby a user might right-click on an node on the
canvas and see a hierarchical, organized list of parameters that are settable on
the node and its constituent member objects, and help text and default values
for each parameter.</p>
<section id="available-attributevalue-types">
<h5><span class="section-number">2.4.2.1. </span>Available AttributeValue Types<a class="headerlink" href="#available-attributevalue-types" title="Link to this heading">¶</a></h5>
<ul>
<li><p>AddressValue</p></li>
<li><p>AttributeContainerValue</p></li>
<li><p>BooleanValue</p></li>
<li><p>BoxValue</p></li>
<li><p>CallbackValue</p></li>
<li><p>DataRateValue</p></li>
<li><p>DoubleValue</p></li>
<li><p>EmptyAttributeValue</p></li>
<li><p>EnumValue</p></li>
<li><p>IntegerValue</p></li>
<li><p>Ipv4AddressValue</p></li>
<li><p>Ipv4MaskValue</p></li>
<li><p>Ipv6AddressValue</p></li>
<li><p>Ipv6PrefixValue</p></li>
<li><p>LengthValue</p></li>
<li><p>Mac16AddressValue</p></li>
<li><p>Mac48AddressValue</p></li>
<li><p>Mac64AddressValue</p></li>
<li><p>ObjectFactoryValue</p></li>
<li><p>ObjectPtrContainerValue</p></li>
<li><p>PairValue&lt;A, B&gt;</p></li>
<li><p>PointerValue</p></li>
<li><p>PriomapValue</p></li>
<li><p>QueueSizeValue</p></li>
<li><p>RectangleValue</p></li>
<li><p>SsidValue</p></li>
<li><p>TimeValue</p></li>
<li><p>TupleValue&lt;Args…&gt;</p>
<p>A TupleValue is capable of storing values of different types, hence it is suitable for
structured data. A prominent example is the ChannelSettings attribute of WifiPhy, which
consists of channel number, channel width, PHY band and primary 20 MHz channel index.
In this case the values have to be mutually consistent, which makes it difficult to set them
as individual Attributes. Capturing them in a TupleValue simplifies this problem, see
<code class="docutils literal notranslate"><span class="pre">src/wifi/model/wifi-phy.cc</span></code>.</p>
<p>Values stored in a TupleValue object can be set/get through a std::tuple object or
can be serialized to/deserialized from a string containing a comma-separated sequence of
the values enclosed in a pair of curly braces (e.g., “{36, 20, BAND_5GHZ, 0}”).</p>
<p>The usage of the TupleValue attribute is illustrated in
<code class="docutils literal notranslate"><span class="pre">src/core/test/tuple-value-test-suite.cc</span></code>.</p>
</li>
<li><p>TypeIdValue</p></li>
<li><p>UanModesListValue</p></li>
<li><p>UintegerValue</p></li>
<li><p>Vector2DValue</p></li>
<li><p>Vector3DValue</p></li>
<li><p>WaypointValue</p></li>
<li><p>WifiModeValue</p></li>
</ul>
</section>
<section id="defining-attributes">
<h5><span class="section-number">2.4.2.2. </span>Defining Attributes<a class="headerlink" href="#defining-attributes" title="Link to this heading">¶</a></h5>
<p>We provide a way for users to access values deep in the system, without having
to plumb accessors (pointers) through the system and walk pointer chains to get
to them. Consider a class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">QueueBase</span></code> that has a member variable
<code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">m_maxSize</span></code> controlling the depth of the queue.</p>
<p>If we look at the declaration of <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">QueueBase</span></code>, we see
the following:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">QueueBase</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">GetTypeId</span><span class="p">();</span>
<span class="w">  </span><span class="p">...</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="n">QueueSize</span><span class="w"> </span><span class="n">m_maxSize</span><span class="p">;</span><span class="w">                </span><span class="c1">//!&lt; max queue size</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">QueueSize</span></code> is a special type in <em>ns-3</em> that allows size
to be represented in different units:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="nc">QueueSizeUnit</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">PACKETS</span><span class="p">,</span><span class="w">     </span><span class="cm">/**&lt; Use number of packets for queue size */</span>
<span class="w">  </span><span class="n">BYTES</span><span class="p">,</span><span class="w">       </span><span class="cm">/**&lt; Use number of bytes for queue size */</span>
<span class="p">};</span>

<span class="k">class</span><span class="w"> </span><span class="nc">QueueSize</span>
<span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="n">QueueSizeUnit</span><span class="w"> </span><span class="n">m_unit</span><span class="p">;</span><span class="w"> </span><span class="c1">//!&lt; unit</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">m_value</span><span class="p">;</span><span class="w">     </span><span class="c1">//!&lt; queue size [bytes or packets]</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Finally, the class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">DropTailQueue</span></code> inherits from this base
class and provides the semantics that packets that are submitted to
a full queue will be dropped from the back of the queue (“drop tail”).</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * \ingroup queue</span>
<span class="cm"> *</span>
<span class="cm"> * \brief A FIFO packet queue that drops tail-end packets on overflow</span>
<span class="cm"> */</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Item</span><span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DropTailQueue</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Queue</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Let’s consider things that a user may want to do with the value of
<code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">m_maxSize</span></code>:</p>
<ul class="simple">
<li><p>Set a default value for the system, such that whenever a new
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">DropTailQueue</span></code> is created, this member is initialized
to that default.</p></li>
<li><p>Set or get the value on an already instantiated queue.</p></li>
</ul>
<p>The above things typically require providing <code class="docutils literal notranslate"><span class="pre">Set()</span></code> and <code class="docutils literal notranslate"><span class="pre">Get()</span></code>
functions, and some type of global default value.</p>
<p>In the <em>ns-3</em> attribute system, these value definitions and accessor function
registrations are moved into the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">TypeId</span></code> class; <em>e.g</em>.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NS_OBJECT_ENSURE_REGISTERED</span><span class="p">(</span><span class="n">QueueBase</span><span class="p">);</span>

<span class="n">TypeId</span>
<span class="nf">QueueBase::GetTypeId</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeId</span><span class="p">(</span><span class="s">&quot;ns3::DropTailQueue&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">SetParent</span><span class="o">&lt;</span><span class="n">Queue</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">SetGroupName</span><span class="p">(</span><span class="s">&quot;Network&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddAttribute</span><span class="p">(</span><span class="s">&quot;MaxSize&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="s">&quot;The max queue size&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="n">QueueSizeValue</span><span class="p">(</span><span class="n">QueueSize</span><span class="p">(</span><span class="s">&quot;100p&quot;</span><span class="p">)),</span>
<span class="w">                  </span><span class="n">MakeQueueSizeAccessor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">QueueBase</span><span class="o">::</span><span class="n">SetMaxSize</span><span class="p">,</span>
<span class="w">                                        </span><span class="o">&amp;</span><span class="n">QueueBase</span><span class="o">::</span><span class="n">GetMaxSize</span><span class="p">),</span>
<span class="w">                  </span><span class="n">MakeQueueSizeChecker</span><span class="p">())</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="p">;</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">AddAttribute()</span></code> method is performing a number of things for the
<code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">m_maxSize</span></code> value:</p>
<ul class="simple">
<li><p>Binding the (usually private) member variable <code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">m_maxSize</span></code>
to a public string <code class="docutils literal notranslate"><span class="pre">&quot;MaxSize&quot;</span></code>.</p></li>
<li><p>Providing a default value (0 packets).</p></li>
<li><p>Providing some help text defining the meaning of the value.</p></li>
<li><p>Providing a “Checker” (not used in this example) that can be used to set
bounds on the allowable range of values.</p></li>
</ul>
<p>The key point is that now the value of this variable and its default value are
accessible in the attribute namespace, which is based on strings such as
<code class="docutils literal notranslate"><span class="pre">&quot;MaxSize&quot;</span></code> and <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">TypeId</span></code> name strings. In the next section,
we will provide an example script that shows how users may manipulate
these values.</p>
<p>Note that initialization of the attribute relies on the macro
<code class="docutils literal notranslate"><span class="pre">NS_OBJECT_ENSURE_REGISTERED(QueueBase)</span></code> being called; if you leave this
out of your new class implementation, your attributes will not be initialized
correctly.</p>
<p>While we have described how to create attributes, we still haven’t described how
to access and manage these values. For instance, there is no <code class="docutils literal notranslate"><span class="pre">globals.h</span></code>
header file where these are stored; attributes are stored with their classes.
Questions that naturally arise are how do users easily learn about all of the
attributes of their models, and how does a user access these attributes, or
document their values as part of the record of their simulation?</p>
<p>Detailed documentation of the actual attributes defined for a type,
and a global list of all defined attributes, are available in
the API documentation.  For the rest of this document we are going
to demonstrate the various ways of getting and setting attribute values.</p>
</section>
<section id="setting-default-values">
<h5><span class="section-number">2.4.2.3. </span>Setting Default Values<a class="headerlink" href="#setting-default-values" title="Link to this heading">¶</a></h5>
<section id="config-setdefault-and-commandline">
<h6><span class="section-number">2.4.2.3.1. </span>Config::SetDefault and CommandLine<a class="headerlink" href="#config-setdefault-and-commandline" title="Link to this heading">¶</a></h6>
<p>Let’s look at how a user script might access a specific attribute value.
We’re going to use the
<code class="docutils literal notranslate"><span class="pre">src/point-to-point/examples/main-attribute-value.cc</span></code>
script for illustration, with some details stripped out.  The <code class="docutils literal notranslate"><span class="pre">main</span></code>
function begins:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// This is a basic example of how to use the attribute system to</span>
<span class="c1">// set and get a value in the underlying system; namely, the maximum</span>
<span class="c1">// size of the FIFO queue in the PointToPointNetDevice</span>
<span class="c1">//</span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>

<span class="w">  </span><span class="c1">// Queues in ns-3 are objects that hold items (other objects) in</span>
<span class="w">  </span><span class="c1">// a queue structure.  The C++ implementation uses templates to</span>
<span class="w">  </span><span class="c1">// allow queues to hold various types of items, but the most</span>
<span class="w">  </span><span class="c1">// common is a pointer to a packet(Ptr&lt;Packet&gt;).</span>
<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="c1">// The maximum queue size can either be enforced in bytes (&#39;b&#39;) or</span>
<span class="w">  </span><span class="c1">// packets (&#39;p&#39;).  A special type called the ns3::QueueSize can</span>
<span class="w">  </span><span class="c1">// hold queue size values in either unit (bytes or packets).  The</span>
<span class="w">  </span><span class="c1">// queue base class ns3::QueueBase has a MaxSize attribute that can</span>
<span class="w">  </span><span class="c1">// be set to a QueueSize.</span>

<span class="w">  </span><span class="c1">// By default, the MaxSize attribute has a value of 100 packets (&#39;100p&#39;)</span>
<span class="w">  </span><span class="c1">// (this default can be observed in the function QueueBase::GetTypeId)</span>
<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="c1">// Here, we set it to 80 packets.  We could use one of two value types:</span>
<span class="w">  </span><span class="c1">// a string-based value or a QueueSizeValue value</span>
<span class="w">  </span><span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::QueueBase::MaxSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;80p&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="c1">// The below function call is redundant</span>
<span class="w">  </span><span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::QueueBase::MaxSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">QueueSizeValue</span><span class="p">(</span><span class="n">QueueSize</span><span class="p">(</span><span class="n">QueueSizeUnit</span><span class="o">::</span><span class="n">PACKETS</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">)));</span>
</pre></div>
</div>
<p>The main thing to notice in the above are the two equivalent calls to
<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">Config::SetDefault()</span></code>.  This is how we set the default value
for all subsequently instantiated <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">DropTailQueue</span></code>s.  We illustrate
that two types of <code class="docutils literal notranslate"><span class="pre">Value</span></code> classes, a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">StringValue</span></code> and
a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">QueueSizeValue</span></code> class, can be used to assign the value
to the attribute named by “ns3::QueueBase::MaxSize”.</p>
<p>It is also possible to manipulate Attributes using the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">CommandLine</span></code>;
we saw some examples early in the <em>ns-3</em> Tutorial.  In particular, it is
straightforward to add a shorthand argument name, such as <code class="docutils literal notranslate"><span class="pre">--maxSize</span></code>,
for an Attribute that is particular relevant for your model, in this case
<code class="docutils literal notranslate"><span class="pre">&quot;ns3::QueueBase::MaxSize&quot;</span></code>.  This has the additional feature that
the help string for the Attribute will be printed as part of the usage
message for the script.  For more information see
the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">CommandLine</span></code> API documentation.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Allow the user to override any of the defaults and the above</span>
<span class="c1">// SetDefaults() at run-time, via command-line arguments</span>
<span class="c1">// For example, via &quot;--ns3::QueueBase::MaxSize=80p&quot;</span>
<span class="n">CommandLine</span><span class="w"> </span><span class="n">cmd</span><span class="p">;</span>
<span class="c1">// This provides yet another way to set the value from the command line:</span>
<span class="n">cmd</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">&quot;maxSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ns3::QueueBase::MaxSize&quot;</span><span class="p">);</span>
<span class="n">cmd</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
</pre></div>
</div>
<p>Now, we will create a few objects using the low-level API.  Our
newly created queues will not have <code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">m_maxSize</span></code> initialized to
0 packets, as defined in the <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">QueueBase::GetTypeId()</span></code>
function, but to 80 packets, because of what we did above with
default values.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">n0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="p">();</span>

<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">PointToPointNetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">net0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">PointToPointNetDevice</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">n0</span><span class="o">-&gt;</span><span class="n">AddDevice</span><span class="p">(</span><span class="n">net0</span><span class="p">);</span>

<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Queue</span><span class="o">&lt;</span><span class="n">Packet</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">DropTailQueue</span><span class="o">&lt;</span><span class="n">Packet</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">();</span>
<span class="n">net0</span><span class="o">-&gt;</span><span class="n">AddQueue</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</pre></div>
</div>
<p>At this point, we have created a single <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Node</span></code> (<code class="docutils literal notranslate"><span class="pre">n0</span></code>)
and a single <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">PointToPointNetDevice</span></code> (<code class="docutils literal notranslate"><span class="pre">net0</span></code>),
added a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">DropTailQueue</span></code> (<code class="docutils literal notranslate"><span class="pre">q</span></code>) to <code class="docutils literal notranslate"><span class="pre">net0</span></code>,
which will be configured with a queue size limit of 80 packets.</p>
<p>As a final note, the <cite>Config::Set…()</cite> functions
will throw an error if the targeted Attribute does not exist at the path
given.  There are also “fail-safe” versions,
<cite>Config::Set…FailSafe()</cite>, if you can’t be sure the Attribute
exists.  The fail-safe versions return <cite>true</cite> if at least one instance
could be set.</p>
</section>
<section id="constructors-helpers-and-objectfactory">
<h6><span class="section-number">2.4.2.3.2. </span>Constructors, Helpers and ObjectFactory<a class="headerlink" href="#constructors-helpers-and-objectfactory" title="Link to this heading">¶</a></h6>
<p>Arbitrary combinations of attributes can be set and fetched from
the helper and low-level APIs; either from the constructors themselves:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">GridPositionAllocator</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="n">CreateObjectWithAttributes</span><span class="o">&lt;</span><span class="n">GridPositionAllocator</span><span class="o">&gt;</span>
<span class="w">   </span><span class="p">(</span><span class="s">&quot;MinX&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DoubleValue</span><span class="p">(</span><span class="mf">-100.0</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;MinY&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DoubleValue</span><span class="p">(</span><span class="mf">-100.0</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;DeltaX&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DoubleValue</span><span class="p">(</span><span class="mf">5.0</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;DeltaY&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DoubleValue</span><span class="p">(</span><span class="mf">20.0</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;GridWidth&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UintegerValue</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;LayoutType&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;RowFirst&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>or from the higher-level helper APIs, such as:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">mobility</span><span class="p">.</span><span class="n">SetPositionAllocator</span>
<span class="w">   </span><span class="p">(</span><span class="s">&quot;ns3::GridPositionAllocator&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;MinX&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DoubleValue</span><span class="p">(</span><span class="mf">-100.0</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;MinY&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DoubleValue</span><span class="p">(</span><span class="mf">-100.0</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;DeltaX&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DoubleValue</span><span class="p">(</span><span class="mf">5.0</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;DeltaY&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DoubleValue</span><span class="p">(</span><span class="mf">20.0</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;GridWidth&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UintegerValue</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;LayoutType&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;RowFirst&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>We don’t illustrate it here, but you can also configure an
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ObjectFactory</span></code> with new values for specific attributes.
Instances created by the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ObjectFactory</span></code> will have those
attributes set during construction.  This is very similar to using
one of the helper APIs for the class.</p>
<p>To review, there are several ways to set values for attributes for
class instances <em>to be created in the future:</em></p>
<ul class="simple">
<li><p><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">Config::SetDefault()</span></code></p></li>
<li><p><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">CommandLine::AddValue()</span></code></p></li>
<li><p><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">CreateObjectWithAttributes&lt;&gt;()</span></code></p></li>
<li><p>Various helper APIs</p></li>
</ul>
<p>But what if you’ve already created an instance, and you want
to change the value of the attribute?  In this example, how can we
manipulate the <code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">m_maxSize</span></code> value of the already instantiated
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">DropTailQueue</span></code>?  Here are various ways to do that.</p>
</section>
</section>
<section id="changing-values">
<h5><span class="section-number">2.4.2.4. </span>Changing Values<a class="headerlink" href="#changing-values" title="Link to this heading">¶</a></h5>
<section id="smartpointer">
<h6><span class="section-number">2.4.2.4.1. </span>SmartPointer<a class="headerlink" href="#smartpointer" title="Link to this heading">¶</a></h6>
<p>Assume that a smart pointer (<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Ptr</span></code>) to a relevant network device
is in hand; in the current example, it is the <code class="docutils literal notranslate"><span class="pre">net0</span></code> pointer.</p>
<p>One way to change the value is to access a pointer to the underlying queue and
modify its attribute.</p>
<p>First, we observe that we can get a pointer to the (base class)
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Queue</span></code> <em>via</em> the
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">PointToPointNetDevice</span></code> attributes, where it is called
<code class="docutils literal notranslate"><span class="pre">&quot;TxQueue&quot;</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">PointerValue</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span>
<span class="n">net0</span><span class="o">-&gt;</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;TxQueue&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">);</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Queue</span><span class="o">&lt;</span><span class="n">Packet</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">txQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">Get</span><span class="o">&lt;</span><span class="n">Queue</span><span class="o">&lt;</span><span class="n">Packet</span><span class="o">&gt;&gt;</span><span class="p">();</span>
</pre></div>
</div>
<p>Using the <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GetObject()</span></code> function, we can perform a safe downcast
to a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">DropTailQueue</span></code>.  The <cite>NS_ASSERT</cite> checks that the pointer is
valid.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">DropTailQueue</span><span class="o">&lt;</span><span class="n">Packet</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">dtq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">txQueue</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">DropTailQueue</span><span class="o">&lt;</span><span class="n">Packet</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="n">NS_ASSERT</span><span class="w"> </span><span class="p">(</span><span class="n">dtq</span><span class="p">);</span>
</pre></div>
</div>
<p>Next, we can get the value of an attribute on this queue.  We have introduced
wrapper <code class="docutils literal notranslate"><span class="pre">Value</span></code> classes for the underlying data types, similar
to Java wrappers around these types, since the attribute system stores values
serialized to strings, and not disparate types.  Here, the attribute value
method on this value produces the (unwrapped) <code class="docutils literal notranslate"><span class="pre">QueueSize</span></code>.  That is,
is assigned to a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">QueueSizeValue</span></code>, and the <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">Get()</span></code>
the variable <cite>limit</cite> is written into by the GetAttribute method.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">QueueSizeValue</span><span class="w"> </span><span class="n">limit</span><span class="p">;</span>
<span class="n">dtq</span><span class="o">-&gt;</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;MaxSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">);</span>
<span class="n">NS_LOG_INFO</span><span class="p">(</span><span class="s">&quot;1.  dtq limit: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">limit</span><span class="p">.</span><span class="n">Get</span><span class="p">());</span>
</pre></div>
</div>
<p>Note that the above downcast is not really needed; we could have gotten
the attribute value directly from <code class="docutils literal notranslate"><span class="pre">txQueue</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">txQueue</span><span class="o">-&gt;</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;MaxSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">);</span>
<span class="n">NS_LOG_INFO</span><span class="p">(</span><span class="s">&quot;2.  txQueue limit: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">limit</span><span class="p">.</span><span class="n">Get</span><span class="p">());</span>
</pre></div>
</div>
<p>Now, let’s set it to another value (60 packets).  Let’s also make
use of the StringValue shorthand notation to set the size by
passing in a string (the string must be a positive integer suffixed
by either the <cite>p</cite> or <cite>b</cite> character).</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">txQueue</span><span class="o">-&gt;</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&quot;MaxSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;60p&quot;</span><span class="p">));</span>
<span class="n">txQueue</span><span class="o">-&gt;</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;MaxSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">);</span>
<span class="n">NS_LOG_INFO</span><span class="p">(</span><span class="s">&quot;3.  txQueue limit changed: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">limit</span><span class="p">.</span><span class="n">Get</span><span class="p">());</span>
</pre></div>
</div>
</section>
<section id="config-namespace-path">
<h6><span class="section-number">2.4.2.4.2. </span>Config Namespace Path<a class="headerlink" href="#config-namespace-path" title="Link to this heading">¶</a></h6>
<p>An alternative way to get at the attribute is to use the configuration
namespace.  Here, this attribute resides on a known path in this namespace; this
approach is useful if one doesn’t have access to the underlying pointers and
would like to configure a specific attribute with a single statement.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Config</span><span class="o">::</span><span class="n">Set</span><span class="p">(</span><span class="s">&quot;/NodeList/0/DeviceList/0/TxQueue/MaxSize&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;25p&quot;</span><span class="p">));</span>
<span class="n">txQueue</span><span class="o">-&gt;</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;MaxSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">);</span>
<span class="n">NS_LOG_INFO</span><span class="p">(</span><span class="s">&quot;4.  txQueue limit changed through namespace: &quot;</span>
<span class="w">            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">limit</span><span class="p">.</span><span class="n">Get</span><span class="p">());</span>
</pre></div>
</div>
<p>The configuration path often has the form of
<code class="docutils literal notranslate"><span class="pre">&quot;.../&lt;container</span> <span class="pre">name&gt;/&lt;index&gt;/.../&lt;attribute&gt;/&lt;attribute&gt;&quot;</span></code>
to refer to a specific instance by index of an object in the container.
In this case the first container is the list of all <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Node</span></code>s;
the second container is the list of all <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">NetDevice</span></code>s on
the chosen <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Node</span></code>.  Finally, the configuration path usually
ends with a succession of member attributes, in this case the <code class="docutils literal notranslate"><span class="pre">&quot;MaxSize&quot;</span></code>
attribute of the <code class="docutils literal notranslate"><span class="pre">&quot;TxQueue&quot;</span></code> of the chosen <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">NetDevice</span></code>.</p>
<p>We could have also used wildcards to set this value for all nodes and all net
devices(which in this simple example has the same effect as the previous
<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">Config::Set()</span></code>):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Config</span><span class="o">::</span><span class="n">Set</span><span class="p">(</span><span class="s">&quot;/NodeList/*/DeviceList/*/TxQueue/MaxSize&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;15p&quot;</span><span class="p">));</span>
<span class="n">txQueue</span><span class="o">-&gt;</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;MaxSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">);</span>
<span class="n">NS_LOG_INFO</span><span class="p">(</span><span class="s">&quot;5.  txQueue limit changed through wildcarded namespace: &quot;</span>
<span class="w">            </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">limit</span><span class="p">.</span><span class="n">Get</span><span class="p">());</span>
</pre></div>
</div>
<p>If you run this program from the command line, you should see the following
output corresponding to the steps we took above:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>main-attribute-value
<span class="m">1</span>.<span class="w">  </span>dtq<span class="w"> </span>limit:<span class="w"> </span>80p
<span class="m">2</span>.<span class="w">  </span>txQueue<span class="w"> </span>limit:<span class="w"> </span>80p
<span class="m">3</span>.<span class="w">  </span>txQueue<span class="w"> </span>limit<span class="w"> </span>changed:<span class="w"> </span>60p
<span class="m">4</span>.<span class="w">  </span>txQueue<span class="w"> </span>limit<span class="w"> </span>changed<span class="w"> </span>through<span class="w"> </span>namespace:<span class="w"> </span>25p
<span class="m">5</span>.<span class="w">  </span>txQueue<span class="w"> </span>limit<span class="w"> </span>changed<span class="w"> </span>through<span class="w"> </span>wildcarded<span class="w"> </span>namespace:<span class="w"> </span>15p
</pre></div>
</div>
</section>
<section id="object-name-service">
<h6><span class="section-number">2.4.2.4.3. </span>Object Name Service<a class="headerlink" href="#object-name-service" title="Link to this heading">¶</a></h6>
<p>Another way to get at the attribute is to use the object name service facility.
The object name service allows us to add items to the configuration
namespace under the <code class="docutils literal notranslate"><span class="pre">&quot;/Names/&quot;</span></code> path with a user-defined name string.
This approach is useful if one doesn’t have access to the underlying
pointers and it is difficult to determine the required concrete configuration
namespace path.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;server&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">n0</span><span class="p">);</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;server/eth0&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">net0</span><span class="p">);</span>

<span class="p">...</span>

<span class="n">Config</span><span class="o">::</span><span class="n">Set</span><span class="p">(</span><span class="s">&quot;/Names/server/eth0/TxQueue/MaxPackets&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UintegerValue</span><span class="p">(</span><span class="mi">25</span><span class="p">));</span>
</pre></div>
</div>
<p>Here we’ve added the path elements <code class="docutils literal notranslate"><span class="pre">&quot;server&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;eth0&quot;</span></code> under
the <code class="docutils literal notranslate"><span class="pre">&quot;/Names/&quot;</span></code> namespace, then used the resulting configuration path
to set the attribute.</p>
<p>See <a class="reference internal" href="index.html#object-names"><span class="std std-ref">Object names</span></a> for a fuller treatment of the <em>ns-3</em> configuration namespace.</p>
</section>
</section>
</section>
<section id="implementation-details">
<h4><span class="section-number">2.4.3. </span>Implementation Details<a class="headerlink" href="#implementation-details" title="Link to this heading">¶</a></h4>
<section id="value-classes">
<h5><span class="section-number">2.4.3.1. </span>Value Classes<a class="headerlink" href="#value-classes" title="Link to this heading">¶</a></h5>
<p>Readers will note the <code class="docutils literal notranslate"><span class="pre">TypeValue</span></code> classes which are subclasses of the
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">AttributeValue</span></code> base class. These can be thought of as
intermediate classes which are used to convert from raw types to the
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">AttributeValue</span></code>s that are used by the attribute system.
Recall that this database is holding objects of many types serialized
to strings. Conversions to this type can either be done using
an intermediate class (such as <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">IntegerValue</span></code>,
or <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">DoubleValue</span></code> for floating point numbers)
or <em>via</em> strings. Direct implicit conversion of types to
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">AttributeValue</span></code> is not really practical.
So in the above, users have a choice of using strings or values:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">p</span><span class="o">-&gt;</span><span class="n">Set</span><span class="p">(</span><span class="s">&quot;cwnd&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;100&quot;</span><span class="p">));</span><span class="w"> </span><span class="c1">// string-based setter</span>
<span class="n">p</span><span class="o">-&gt;</span><span class="n">Set</span><span class="p">(</span><span class="s">&quot;cwnd&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">IntegerValue</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span><span class="w"> </span><span class="c1">// integer-based setter</span>
</pre></div>
</div>
<p>The system provides some macros that help users declare and define
new AttributeValue subclasses for new types that they want to introduce into
the attribute system:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ATTRIBUTE_HELPER_HEADER</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ATTRIBUTE_HELPER_CPP</span></code></p></li>
</ul>
<p>See the API documentation for these constructs for more information.</p>
</section>
<section id="initialization-order">
<h5><span class="section-number">2.4.3.2. </span>Initialization Order<a class="headerlink" href="#initialization-order" title="Link to this heading">¶</a></h5>
<p>Attributes in the system must not depend on the state of any other Attribute in
this system. This is because an ordering of Attribute initialization is not
specified, nor enforced, by the system. A specific example of this can be seen
in automated configuration programs such as <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ConfigStore</span></code>.
Although a given model may arrange it so that Attributes are initialized in a
particular order, another automatic configurator may decide independently to
change Attributes in, for example, alphabetic order.</p>
<p>Because of this non-specific ordering, no Attribute in the system may have any
dependence on any other Attribute. As a corollary, Attribute setters must never
fail due to the state of another Attribute. No Attribute setter may change (set)
any other Attribute value as a result of changing its value.</p>
<p>This is a very strong restriction and there are cases where Attributes must set
consistently to allow correct operation. To this end we do allow for consistency
checking <em>when the attribute is used</em> (<em>cf</em>. <code class="docutils literal notranslate"><span class="pre">NS_ASSERT_MSG</span></code>
or <code class="docutils literal notranslate"><span class="pre">NS_ABORT_MSG</span></code>).</p>
<p>In general, the attribute code to assign values to the underlying class member
variables is executed after an object is constructed. But what if you need the
values assigned before the constructor body executes, because you need them in
the logic of the constructor? There is a way to do this, used for example in the
class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ConfigStore</span></code>: call <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">ObjectBase::ConstructSelf()</span></code> as
follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">ConfigStore</span><span class="o">::</span><span class="n">ConfigStore</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">ObjectBase</span><span class="o">::</span><span class="n">ConstructSelf</span><span class="p">(</span><span class="n">AttributeConstructionList</span><span class="p">());</span>
<span class="w">  </span><span class="c1">// continue on with constructor.</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Beware that the object and all its derived classes must also implement
a <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GetInstanceTypeId()</span></code> method. Otherwise
the <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">ObjectBase::ConstructSelf()</span></code> will not be able to read
the attributes.</p>
</section>
<section id="adding-attributes">
<h5><span class="section-number">2.4.3.3. </span>Adding Attributes<a class="headerlink" href="#adding-attributes" title="Link to this heading">¶</a></h5>
<p>The <em>ns-3</em> system will place a number of internal values under the attribute
system, but undoubtedly users will want to extend this to pick up ones we have
missed, or to add their own classes to the system.</p>
<p>There are three typical use cases:</p>
<ul class="simple">
<li><p>Making an existing class data member accessible as an Attribute,
when it isn’t already.</p></li>
<li><p>Making a new class able to expose some data members as Attributes
by giving it a TypeId.</p></li>
<li><p>Creating an <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">AttributeValue</span></code> subclass for a new class
so that it can be accessed as an Attribute.</p></li>
</ul>
<section id="existing-member-variable">
<h6><span class="section-number">2.4.3.3.1. </span>Existing Member Variable<a class="headerlink" href="#existing-member-variable" title="Link to this heading">¶</a></h6>
<p>Consider this variable in <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">TcpSocket</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">m_cWnd</span><span class="p">;</span><span class="w">   </span><span class="c1">// Congestion window</span>
</pre></div>
</div>
<p>Suppose that someone working with TCP wanted to get or set the value of that
variable using the metadata system. If it were not already provided by <em>ns-3</em>,
the user could declare the following addition in the runtime metadata system (to
the <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GetTypeId()</span></code> definition for <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">TcpSocket</span></code>):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="p">.</span><span class="n">AddAttribute</span><span class="p">(</span><span class="s">&quot;Congestion window&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="s">&quot;Tcp congestion window(bytes)&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="n">UintegerValue</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="w">              </span><span class="n">MakeUintegerAccessor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TcpSocket</span><span class="o">::</span><span class="n">m_cWnd</span><span class="p">),</span>
<span class="w">              </span><span class="n">MakeUintegerChecker</span><span class="o">&lt;</span><span class="kt">uint16_t</span><span class="o">&gt;</span><span class="p">())</span>
</pre></div>
</div>
<p>Now, the user with a pointer to a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">TcpSocket</span></code> instance
can perform operations such as
setting and getting the value, without having to add these functions explicitly.
Furthermore, access controls can be applied, such as allowing the parameter to
be read and not written, or bounds checking on the permissible values can be
applied.</p>
</section>
<section id="new-class-typeid">
<h6><span class="section-number">2.4.3.3.2. </span>New Class TypeId<a class="headerlink" href="#new-class-typeid" title="Link to this heading">¶</a></h6>
<p>Here, we discuss the impact on a user who wants to add a new class to <em>ns-3</em>.
What additional things must be done to enable it to hold attributes?</p>
<p>Let’s assume our new class, called <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::MyMobility</span></code>,
is a type of mobility model.  First, the class should inherit from
its parent class, <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::MobilityModel</span></code>.
In the <code class="docutils literal notranslate"><span class="pre">my-mobility.h</span></code> header file:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">ns3</span><span class="w"> </span><span class="p">{</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyMobility</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">MobilityModel</span>
<span class="p">{</span>
</pre></div>
</div>
<p>This requires we declare the <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">GetTypeId()</span></code> function.
This is a one-line public function declaration:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   *  Register this type.</span>
<span class="cm">   *  \return The object TypeId.</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">GetTypeId</span><span class="p">();</span>
</pre></div>
</div>
<p>We’ve already introduced what a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">TypeId</span></code> definition will look like
in the <code class="docutils literal notranslate"><span class="pre">my-mobility.cc</span></code> implementation file:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NS_OBJECT_ENSURE_REGISTERED</span><span class="p">(</span><span class="n">MyMobility</span><span class="p">);</span>

<span class="n">TypeId</span>
<span class="nf">MyMobility::GetTypeId</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeId</span><span class="p">(</span><span class="s">&quot;ns3::MyMobility&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">SetParent</span><span class="o">&lt;</span><span class="n">MobilityModel</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">SetGroupName</span><span class="p">(</span><span class="s">&quot;Mobility&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddConstructor</span><span class="o">&lt;</span><span class="n">MyMobility</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddAttribute</span><span class="p">(</span><span class="s">&quot;Bounds&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="s">&quot;Bounds of the area to cruise.&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="n">RectangleValue</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">100.0</span><span class="p">,</span><span class="w"> </span><span class="mf">100.0</span><span class="p">)),</span>
<span class="w">                  </span><span class="n">MakeRectangleAccessor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyMobility</span><span class="o">::</span><span class="n">m_bounds</span><span class="p">),</span>
<span class="w">                  </span><span class="n">MakeRectangleChecker</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddAttribute</span><span class="p">(</span><span class="s">&quot;Time&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="s">&quot;Change current direction and speed after moving for this delay.&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="c1">// etc (more parameters).</span>
<span class="w">                  </span><span class="n">TimeValue</span><span class="p">(</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)),</span>
<span class="w">                  </span><span class="n">MakeTimeAccessor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyMobility</span><span class="o">::</span><span class="n">m_modeTime</span><span class="p">),</span>
<span class="w">                  </span><span class="n">MakeTimeChecker</span><span class="p">())</span>
<span class="w">    </span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If we don’t want to subclass from an existing class, in the header file
we just inherit from <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::Object</span></code>, and in the object file
we set the parent class to <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::Object</span></code> with
<code class="docutils literal notranslate"><span class="pre">.SetParent&lt;Object&gt;()</span></code>.</p>
<p>Typical mistakes here involve:</p>
<ul class="simple">
<li><p>Not calling <code class="docutils literal notranslate"><span class="pre">NS_OBJECT_ENSURE_REGISTERED()</span></code></p></li>
<li><p>Not calling the <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">SetParent()</span></code> method,
or calling it with the wrong type.</p></li>
<li><p>Not calling the <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">AddConstructor()</span></code> method,
or calling it with the wrong type.</p></li>
<li><p>Introducing a typographical error in the name of the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">TypeId</span></code>
in its constructor.</p></li>
<li><p>Not using the fully-qualified C++ typename of the enclosing C++ class as the
name of the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">TypeId</span></code>.  Note that <code class="docutils literal notranslate"><span class="pre">&quot;ns3::&quot;</span></code> is required.</p></li>
</ul>
<p>None of these mistakes can be detected by the <em>ns-3</em> codebase, so users
are advised to check carefully multiple times that they got these right.</p>
</section>
<section id="new-attributevalue-type">
<h6><span class="section-number">2.4.3.3.3. </span>New AttributeValue Type<a class="headerlink" href="#new-attributevalue-type" title="Link to this heading">¶</a></h6>
<p>From the perspective of the user who writes a new class in the system and wants
it to be accessible as an attribute, there is mainly the matter of writing the
conversions to/from strings and attribute values.  Most of this can be
copy/pasted with macro-ized code.  For instance, consider a class declaration
for <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Rectangle</span></code> in the <code class="docutils literal notranslate"><span class="pre">src/mobility/model</span></code> directory:</p>
<section id="header-file">
<h6 aria-level="7"><span class="section-number">2.4.3.3.3.1. </span>Header File<a class="headerlink" href="#header-file" title="Link to this heading">¶</a></h6>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * \brief a 2d rectangle</span>
<span class="cm"> */</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Rectangle</span>
<span class="p">{</span>
<span class="w">  </span><span class="p">...</span>

<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">xMin</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">xMax</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">yMin</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">yMax</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>One macro call and two operators, must be added below the class declaration in
order to turn a Rectangle into a value usable by the <code class="docutils literal notranslate"><span class="pre">Attribute</span></code> system:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="w"> </span><span class="o">&amp;</span><span class="k">operator</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="w"> </span><span class="o">&amp;</span><span class="n">os</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Rectangle</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rectangle</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="w"> </span><span class="o">&amp;</span><span class="k">operator</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="w"> </span><span class="o">&amp;</span><span class="n">is</span><span class="p">,</span><span class="w"> </span><span class="n">Rectangle</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rectangle</span><span class="p">);</span>

<span class="n">ATTRIBUTE_HELPER_HEADER</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="implementation-file">
<h6 aria-level="7"><span class="section-number">2.4.3.3.3.2. </span>Implementation File<a class="headerlink" href="#implementation-file" title="Link to this heading">¶</a></h6>
<p>In the class definition (<code class="docutils literal notranslate"><span class="pre">.cc</span></code> file), the code looks like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">ATTRIBUTE_HELPER_CPP</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">);</span>

<span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="w"> </span><span class="o">&amp;</span>
<span class="k">operator</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="w"> </span><span class="o">&amp;</span><span class="n">os</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Rectangle</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rectangle</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">os</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rectangle</span><span class="p">.</span><span class="n">xMin</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;|&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rectangle</span><span class="p">.</span><span class="n">xMax</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;|&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rectangle</span><span class="p">.</span><span class="n">yMin</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;|&quot;</span>
<span class="w">     </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">rectangle</span><span class="p">.</span><span class="n">yMax</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">os</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="w"> </span><span class="o">&amp;</span>
<span class="k">operator</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="w"> </span><span class="o">&amp;</span><span class="n">is</span><span class="p">,</span><span class="w"> </span><span class="n">Rectangle</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rectangle</span><span class="p">)</span>
<span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="p">;</span>
<span class="w">  </span><span class="n">is</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">rectangle</span><span class="p">.</span><span class="n">xMin</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">rectangle</span><span class="p">.</span><span class="n">xMax</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">rectangle</span><span class="p">.</span><span class="n">yMin</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">c3</span>
<span class="w">     </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">rectangle</span><span class="p">.</span><span class="n">yMax</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;|&#39;</span><span class="w"> </span><span class="o">||</span>
<span class="w">      </span><span class="n">c2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;|&#39;</span><span class="w"> </span><span class="o">||</span>
<span class="w">      </span><span class="n">c3</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;|&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">is</span><span class="p">.</span><span class="n">setstate</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ios_base</span><span class="o">::</span><span class="n">failbit</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">is</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>These stream operators simply convert from a string representation of the
Rectangle(<code class="docutils literal notranslate"><span class="pre">&quot;xMin|xMax|yMin|yMax&quot;</span></code>) to the underlying Rectangle.  The modeler
must specify these operators and the string syntactical representation of an
instance of the new class.</p>
</section>
</section>
</section>
</section>
<section id="configstore">
<h4><span class="section-number">2.4.4. </span>ConfigStore<a class="headerlink" href="#configstore" title="Link to this heading">¶</a></h4>
<p>Values for <em>ns-3</em> attributes can be stored in an ASCII or XML text file
and loaded into a future simulation run.  This feature is known as the
<em>ns-3</em> ConfigStore.  The <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ConfigStore</span></code> is a specialized database for attribute values and default values.</p>
<p>Although it is a separately maintained module in the
<code class="docutils literal notranslate"><span class="pre">src/config-store/</span></code> directory, we document it here because of its
sole dependency on <em>ns-3</em> core module and attributes.</p>
<p>We can explore this system by using an example from
<code class="docutils literal notranslate"><span class="pre">src/config-store/examples/config-store-save.cc</span></code>.</p>
<p>First, all users of the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ConfigStore</span></code> must include
the following statement:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/config-store-module.h&quot;</span>
</pre></div>
</div>
<p>Next, this program adds a sample object <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ConfigExample</span></code>
to show how the system is extended:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ConfigExample</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Object</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">GetTypeId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeId</span><span class="p">(</span><span class="s">&quot;ns3::A&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="n">SetParent</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">      </span><span class="p">.</span><span class="n">AddAttribute</span><span class="p">(</span><span class="s">&quot;TestInt16&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;help text&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">IntegerValue</span><span class="p">(</span><span class="mi">-2</span><span class="p">),</span>
<span class="w">                    </span><span class="n">MakeIntegerAccessor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">A</span><span class="o">::</span><span class="n">m_int16</span><span class="p">),</span>
<span class="w">                    </span><span class="n">MakeIntegerChecker</span><span class="o">&lt;</span><span class="kt">int16_t</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">      </span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">m_int16</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">NS_OBJECT_ENSURE_REGISTERED</span><span class="p">(</span><span class="n">ConfigExample</span><span class="p">);</span>
</pre></div>
</div>
<p>Next, we use the Config subsystem to override the defaults in a couple of
ways:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ConfigExample::TestInt16&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">IntegerValue</span><span class="p">(</span><span class="mi">-5</span><span class="p">));</span>

<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">ConfigExample</span><span class="o">&gt;</span><span class="w"> </span><span class="n">a_obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">ConfigExample</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">NS_ABORT_MSG_UNLESS</span><span class="p">(</span><span class="n">a_obj</span><span class="o">-&gt;</span><span class="n">m_int16</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-5</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;Cannot set ConfigExample&#39;s integer attribute via Config::SetDefault&quot;</span><span class="p">);</span>

<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">ConfigExample</span><span class="o">&gt;</span><span class="w"> </span><span class="n">a2_obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">ConfigExample</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">a2_obj</span><span class="o">-&gt;</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s">&quot;TestInt16&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">IntegerValue</span><span class="p">(</span><span class="mi">-3</span><span class="p">));</span>
<span class="n">IntegerValue</span><span class="w"> </span><span class="n">iv</span><span class="p">;</span>
<span class="n">a2_obj</span><span class="o">-&gt;</span><span class="n">GetAttribute</span><span class="p">(</span><span class="s">&quot;TestInt16&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">iv</span><span class="p">);</span>
<span class="n">NS_ABORT_MSG_UNLESS</span><span class="p">(</span><span class="n">iv</span><span class="p">.</span><span class="n">Get</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-3</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;Cannot set ConfigExample&#39;s integer attribute via SetAttribute&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>The next statement is necessary to make sure that (one of) the objects
created is rooted in the configuration namespace as an object instance.
This normally happens when you aggregate objects to a <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::Node</span></code>
or <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::Channel</span></code> instance,
but here, since we are working at the core level, we need to create a
new root namespace object:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Config</span><span class="o">::</span><span class="n">RegisterRootNamespaceObject</span><span class="p">(</span><span class="n">a2_obj</span><span class="p">);</span>
</pre></div>
</div>
<section id="writing">
<h5><span class="section-number">2.4.4.1. </span>Writing<a class="headerlink" href="#writing" title="Link to this heading">¶</a></h5>
<p>Next, we want to output the configuration store.  The examples show how
to do it in two formats, XML and raw text.  In practice, one should perform
this step just before calling <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">Simulator::Run()</span></code> to save the
final configuration just before running the simulation.</p>
<p>There are three Attributes that govern the behavior of the ConfigStore:
<code class="docutils literal notranslate"><span class="pre">&quot;Mode&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;Filename&quot;</span></code>, and <code class="docutils literal notranslate"><span class="pre">&quot;FileFormat&quot;</span></code>.  The Mode (default <code class="docutils literal notranslate"><span class="pre">&quot;None&quot;</span></code>)
configures whether <em>ns-3</em> should load configuration from a previously saved file
(specify <code class="docutils literal notranslate"><span class="pre">&quot;Mode=Load&quot;</span></code>) or save it to a file (specify <code class="docutils literal notranslate"><span class="pre">&quot;Mode=Save&quot;</span></code>).
The Filename (default <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code>) is where the ConfigStore should read or write
its data.  The FileFormat (default <code class="docutils literal notranslate"><span class="pre">&quot;RawText&quot;</span></code>) governs whether
the ConfigStore format is plain text or Xml (<code class="docutils literal notranslate"><span class="pre">&quot;FileFormat=Xml&quot;</span></code>)</p>
<p>The example shows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ConfigStore::Filename&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;output-attributes.xml&quot;</span><span class="p">));</span>
<span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ConfigStore::FileFormat&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;Xml&quot;</span><span class="p">));</span>
<span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ConfigStore::Mode&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;Save&quot;</span><span class="p">));</span>
<span class="n">ConfigStore</span><span class="w"> </span><span class="n">outputConfig</span><span class="p">;</span>
<span class="n">outputConfig</span><span class="p">.</span><span class="n">ConfigureDefaults</span><span class="p">();</span>
<span class="n">outputConfig</span><span class="p">.</span><span class="n">ConfigureAttributes</span><span class="p">();</span>

<span class="c1">// Output config store to txt format</span>
<span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ConfigStore::Filename&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;output-attributes.txt&quot;</span><span class="p">));</span>
<span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ConfigStore::FileFormat&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;RawText&quot;</span><span class="p">));</span>
<span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ConfigStore::Mode&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;Save&quot;</span><span class="p">));</span>
<span class="n">ConfigStore</span><span class="w"> </span><span class="n">outputConfig2</span><span class="p">;</span>
<span class="n">outputConfig2</span><span class="p">.</span><span class="n">ConfigureDefaults</span><span class="p">();</span>
<span class="n">outputConfig2</span><span class="p">.</span><span class="n">ConfigureAttributes</span><span class="p">();</span>

<span class="n">Simulator</span><span class="o">::</span><span class="n">Run</span><span class="p">();</span>

<span class="n">Simulator</span><span class="o">::</span><span class="n">Destroy</span><span class="p">();</span>
</pre></div>
</div>
<p>Note the placement of these statements just prior to the
values in place just prior to starting the simulation (<em>i.e</em>. after
all of the configuration has taken place).</p>
<p>After running, you can open the <code class="docutils literal notranslate"><span class="pre">output-attributes.txt</span></code> file and see:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>...
default ns3::ErrorModel::IsEnabled &quot;true&quot;
default ns3::RateErrorModel::ErrorUnit &quot;ERROR_UNIT_BYTE&quot;
default ns3::RateErrorModel::ErrorRate &quot;0&quot;
default ns3::RateErrorModel::RanVar &quot;ns3::UniformRandomVariable[Min=0.0|Max=1.0]&quot;
default ns3::BurstErrorModel::ErrorRate &quot;0&quot;
default ns3::BurstErrorModel::BurstStart &quot;ns3::UniformRandomVariable[Min=0.0|Max=1.0]&quot;
default ns3::BurstErrorModel::BurstSize &quot;ns3::UniformRandomVariable[Min=1|Max=4]&quot;
default ns3::PacketSocket::RcvBufSize &quot;131072&quot;
default ns3::PcapFileWrapper::CaptureSize &quot;65535&quot;
default ns3::PcapFileWrapper::NanosecMode &quot;false&quot;
default ns3::SimpleNetDevice::PointToPointMode &quot;false&quot;
default ns3::SimpleNetDevice::TxQueue &quot;ns3::DropTailQueue&lt;Packet&gt;&quot;
default ns3::SimpleNetDevice::DataRate &quot;0bps&quot;
default ns3::PacketSocketClient::MaxPackets &quot;100&quot;
default ns3::PacketSocketClient::Interval &quot;+1000000000.0ns&quot;
default ns3::PacketSocketClient::PacketSize &quot;1024&quot;
default ns3::PacketSocketClient::Priority &quot;0&quot;
default ns3::ConfigStore::Mode &quot;Save&quot;
default ns3::ConfigStore::Filename &quot;output-attributes.txt&quot;
default ns3::ConfigStore::FileFormat &quot;RawText&quot;
default ns3::ConfigExample::TestInt16 &quot;-5&quot;
global SimulatorImplementationType &quot;ns3::DefaultSimulatorImpl&quot;
global SchedulerType &quot;ns3::MapScheduler&quot;
global RngSeed &quot;1&quot;
global RngRun &quot;1&quot;
global ChecksumEnabled &quot;false&quot;
value /$ns3::ConfigExample/TestInt16 &quot;-3&quot;
</pre></div>
</div>
<p>In the above, several of the default values for attributes for the core
and network modules are shown.  Then, all the values for the <em>ns-3</em> global values
are recorded.  Finally, the value of the instance of <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ConfigExample</span></code>
that was rooted in the configuration namespace is shown.  In a real
<em>ns-3</em> program, many more models, attributes, and defaults would be shown.</p>
<p>An XML version also exists in <code class="docutils literal notranslate"><span class="pre">output-attributes.xml</span></code>:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;ns3&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::ErrorModel::IsEnabled&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::RateErrorModel::ErrorUnit&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;ERROR_UNIT_BYTE&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::RateErrorModel::ErrorRate&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::RateErrorModel::RanVar&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;ns3::UniformRandomVariable[Min=0.0|Max=1.0]&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::BurstErrorModel::ErrorRate&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::BurstErrorModel::BurstStart&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;ns3::UniformRandomVariable[Min=0.0|Max=1.0]&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::BurstErrorModel::BurstSize&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;ns3::UniformRandomVariable[Min=1|Max=4]&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::PacketSocket::RcvBufSize&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;131072&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::PcapFileWrapper::CaptureSize&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;65535&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::PcapFileWrapper::NanosecMode&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::SimpleNetDevice::PointToPointMode&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::SimpleNetDevice::TxQueue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;ns3::DropTailQueue&amp;lt;Packet&amp;gt;&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::SimpleNetDevice::DataRate&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0bps&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::PacketSocketClient::MaxPackets&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;100&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::PacketSocketClient::Interval&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;+1000000000.0ns&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::PacketSocketClient::PacketSize&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1024&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::PacketSocketClient::Priority&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::ConfigStore::Mode&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;Save&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::ConfigStore::Filename&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;output-attributes.xml&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::ConfigStore::FileFormat&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;Xml&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;default</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ns3::ConfigExample::TestInt16&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;-5&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;global</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;SimulatorImplementationType&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;ns3::DefaultSimulatorImpl&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;global</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;SchedulerType&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;ns3::MapScheduler&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;global</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;RngSeed&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;global</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;RngRun&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;global</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ChecksumEnabled&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>
<span class="w"> </span><span class="nt">&lt;value</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;/$ns3::ConfigExample/TestInt16&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;-3&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/ns3&gt;</span>
</pre></div>
</div>
<p>This file can be archived with your simulation script and output data.</p>
</section>
<section id="reading">
<h5><span class="section-number">2.4.4.2. </span>Reading<a class="headerlink" href="#reading" title="Link to this heading">¶</a></h5>
<p>Next, we discuss configuring simulations <em>via</em> a stored input
configuration file.  There are a couple of key differences
compared to writing the final simulation configuration.  First, we
need to place statements such as these at the beginning of the program,
before simulation configuration statements are written (so the values
are registered before being used in object construction).</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ConfigStore::Filename&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;input-defaults.xml&quot;</span><span class="p">));</span>
<span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ConfigStore::Mode&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;Load&quot;</span><span class="p">));</span>
<span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ConfigStore::FileFormat&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;Xml&quot;</span><span class="p">));</span>
<span class="n">ConfigStore</span><span class="w"> </span><span class="n">inputConfig</span><span class="p">;</span>
<span class="n">inputConfig</span><span class="p">.</span><span class="n">ConfigureDefaults</span><span class="p">();</span>
</pre></div>
</div>
<p>Next, note that loading of input configuration data is limited to Attribute
default (<em>i.e</em>. not instance) values, and global values.  Attribute instance
values are not supported because at this stage of the simulation, before
any objects are constructed, there are no such object instances around.
(Note, future enhancements to the config store may change this behavior).</p>
<p>Second, while the output of <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ConfigStore</span></code> state
will list everything in the database, the input file need only contain
the specific values to be overridden.  So, one way to use this class
for input file configuration is to generate an initial configuration
using the output (<code class="docutils literal notranslate"><span class="pre">&quot;Save&quot;</span></code>) <code class="docutils literal notranslate"><span class="pre">&quot;Mode&quot;</span></code> described above, extract from
that configuration file only the elements one wishes to change,
and move these minimal elements to a new configuration file
which can then safely be edited and loaded in a subsequent simulation run.</p>
<p>When the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ConfigStore</span></code> object is instantiated, its attributes
<code class="docutils literal notranslate"><span class="pre">&quot;Filename&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;Mode&quot;</span></code>, and <code class="docutils literal notranslate"><span class="pre">&quot;FileFormat&quot;</span></code> must be set,
either <em>via</em> command-line or <em>via</em> program statements.</p>
</section>
<section id="reading-writing-example">
<h5><span class="section-number">2.4.4.3. </span>Reading/Writing Example<a class="headerlink" href="#reading-writing-example" title="Link to this heading">¶</a></h5>
<p>As a more complicated example, let’s assume that we want to read in a
configuration of defaults from an input file named <code class="docutils literal notranslate"><span class="pre">input-defaults.xml</span></code>, and
write out the resulting attributes to a separate file called
<code class="docutils literal notranslate"><span class="pre">output-attributes.xml</span></code>.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/config-store-module.h&quot;</span>
<span class="p">...</span>
<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(...)</span>
<span class="p">{</span>

<span class="w">  </span><span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ConfigStore::Filename&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;input-defaults.xml&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ConfigStore::Mode&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;Load&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ConfigStore::FileFormat&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;Xml&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n">ConfigStore</span><span class="w"> </span><span class="n">inputConfig</span><span class="p">;</span>
<span class="w">  </span><span class="n">inputConfig</span><span class="p">.</span><span class="n">ConfigureDefaults</span><span class="p">();</span>

<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="c1">// Allow the user to override any of the defaults and the above Bind() at</span>
<span class="w">  </span><span class="c1">// run-time, viacommand-line arguments</span>
<span class="w">  </span><span class="c1">//</span>
<span class="w">  </span><span class="n">CommandLine</span><span class="w"> </span><span class="n">cmd</span><span class="p">;</span>
<span class="w">  </span><span class="n">cmd</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// setup topology</span>
<span class="w">  </span><span class="p">...</span>

<span class="w">  </span><span class="c1">// Invoke just before entering Simulator::Run()</span>
<span class="w">  </span><span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ConfigStore::Filename&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;output-attributes.xml&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n">Config</span><span class="o">::</span><span class="n">SetDefault</span><span class="p">(</span><span class="s">&quot;ns3::ConfigStore::Mode&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;Save&quot;</span><span class="p">));</span>
<span class="w">  </span><span class="n">ConfigStore</span><span class="w"> </span><span class="n">outputConfig</span><span class="p">;</span>
<span class="w">  </span><span class="n">outputConfig</span><span class="p">.</span><span class="n">ConfigureAttributes</span><span class="p">();</span>
<span class="w">  </span><span class="n">Simulator</span><span class="o">::</span><span class="n">Run</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="configstore-use-cases-pre-and-post-simulation">
<h5><span class="section-number">2.4.4.4. </span>ConfigStore use cases (pre- and post-simulation)<a class="headerlink" href="#configstore-use-cases-pre-and-post-simulation" title="Link to this heading">¶</a></h5>
<p>It is worth stressing that ConfigStore can be used for different purposes, and this is
reflected in where in the script ConfigStore is invoked.</p>
<p>The typical use-cases are:</p>
<ul class="simple">
<li><p>Change an Object default attributes</p></li>
<li><p>Inspect/change a <em>specific</em> Object attributes</p></li>
<li><p>Inspect the simulation Objects and their attributes</p></li>
</ul>
<p>As a matter of fact, some Objects might be created when the simulation starts.
Hence, ConfigStore will not “report” their attributes if invoked earlier in the code.</p>
<p>A typical workflow might involve running the simulation, calling ConfigStore
at the end of the simulation (after <code class="docutils literal notranslate"><span class="pre">Simulator::Run()</span></code> and before <code class="docutils literal notranslate"><span class="pre">Simulator::Destroy()</span></code>)
This will show all the attributes in the Objects, both those with default values, and those
with values changed during the simulation execution.</p>
<p>To change these values, you’ll need to either change the default (class-wide) attribute values
(in this case call ConfigStore before the Object creation), or  specific object attribute
(in this case call ConfigStore after the Object creation, typically just before <code class="docutils literal notranslate"><span class="pre">Simulator::Run()</span></code>.</p>
</section>
<section id="configstore-gui">
<h5><span class="section-number">2.4.4.5. </span>ConfigStore GUI<a class="headerlink" href="#configstore-gui" title="Link to this heading">¶</a></h5>
<p>There is a GTK-based front end for the ConfigStore.  This allows users to use a
GUI to access and change variables.</p>
<p>Some screenshots are presented here. They are the result of using GtkConfig on
<code class="docutils literal notranslate"><span class="pre">src/lte/examples/lena-dual-stripe.cc</span></code> after <code class="docutils literal notranslate"><span class="pre">Simulator::Run()</span></code>.</p>
<figure class="align-default" id="gtkconfig">
<img alt="_images/gtk-config-lena-dual-stripe-device-view.png" src="_images/gtk-config-lena-dual-stripe-device-view.png" />
</figure>
<figure class="align-default">
<img alt="_images/gtk-config-lena-dual-stripe-eNB-tx-power.png" src="_images/gtk-config-lena-dual-stripe-eNB-tx-power.png" />
</figure>
<p>To use this feature, one must install <code class="docutils literal notranslate"><span class="pre">libgtk-3-dev</span></code>; an example
Ubuntu installation command is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>libgtk-3-dev
</pre></div>
</div>
<p>On a MacOS it is possible to install GTK-3 using <a class="reference external" href="https://brew.sh">Homebrew</a>.
The installation command is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>brew<span class="w"> </span>install<span class="w"> </span>gtk+3<span class="w"> </span>adwaita-icon-theme
</pre></div>
</div>
<p>To check whether it is configured or not, check the output of the step:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>configure<span class="w"> </span>--enable-examples<span class="w"> </span>--enable-tests

----<span class="w"> </span>Summary<span class="w"> </span>of<span class="w"> </span>optional<span class="w"> </span>NS-3<span class="w"> </span>features:
Python<span class="w"> </span>Bindings<span class="w">               </span>:<span class="w"> </span>enabled
Python<span class="w"> </span>API<span class="w"> </span>Scanning<span class="w"> </span>Support<span class="w">   </span>:<span class="w"> </span>enabled
NS-3<span class="w"> </span>Click<span class="w"> </span>Integration<span class="w">        </span>:<span class="w"> </span>enabled
GtkConfigStore<span class="w">                </span>:<span class="w"> </span>not<span class="w"> </span>enabled<span class="w"> </span><span class="o">(</span>library<span class="w"> </span><span class="s1">&#39;gtk+-3.0 &gt;= 3.0&#39;</span><span class="w"> </span>not<span class="w"> </span>found<span class="o">)</span>
</pre></div>
</div>
<p>In the above example, it was not enabled, so it cannot be used until a suitable
version is installed and:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>configure<span class="w"> </span>--enable-examples<span class="w"> </span>--enable-tests
$<span class="w"> </span>./ns3
</pre></div>
</div>
<p>is rerun.</p>
<p>Usage is almost the same as the non-GTK-based version, but there
are no <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ConfigStore</span></code> attributes involved:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Invoke just before entering Simulator::Run()</span>
<span class="n">GtkConfigStore</span><span class="w"> </span><span class="n">config</span><span class="p">;</span>
<span class="n">config</span><span class="p">.</span><span class="n">ConfigureDefaults</span><span class="p">();</span>
<span class="n">config</span><span class="p">.</span><span class="n">ConfigureAttributes</span><span class="p">();</span>
</pre></div>
</div>
<p>Now, when you run the script, a GUI should pop up, allowing you to open menus of
attributes on different nodes/objects, and then launch the simulation execution
when you are done.</p>
<p>Note that “launch the simulation” means to proceed with the simulation script.
If GtkConfigStore has been called after <code class="docutils literal notranslate"><span class="pre">Simulator::Run()</span></code> the simulation will
not be started again - it will just end.</p>
</section>
</section>
</section>
<span id="document-object-names"></span><section id="object-names">
<span id="id1"></span><h3><span class="section-number">2.5. </span>Object names<a class="headerlink" href="#object-names" title="Link to this heading">¶</a></h3>
<p><em>Placeholder chapter</em></p>
</section>
<span id="document-realtime"></span><section id="realtime">
<h3><span class="section-number">2.6. </span>RealTime<a class="headerlink" href="#realtime" title="Link to this heading">¶</a></h3>
<p><em>ns-3</em> has been designed for integration into testbed and virtual machine
environments. To integrate with real network stacks and emit/consume packets, a
real-time scheduler is needed to try to lock the simulation clock with the
hardware clock. We describe here a component of this: the RealTime scheduler.</p>
<p>The purpose of the realtime scheduler is to cause the progression of the
simulation clock to occur synchronously with respect to some external time base.
Without the presence of an external time base (wall clock), simulation time
jumps instantly from one simulated time to the next.</p>
<section id="behavior">
<h4><span class="section-number">2.6.1. </span>Behavior<a class="headerlink" href="#behavior" title="Link to this heading">¶</a></h4>
<p>When using a non-realtime scheduler (the default in <em>ns-3</em>), the simulator
advances the simulation time to the next scheduled event. During event
execution, simulation time is frozen. With the realtime scheduler, the behavior
is similar from the perspective of simulation models (i.e., simulation time is
frozen during event execution), but between events, the simulator will attempt
to keep the simulation clock aligned with the machine clock.</p>
<p>When an event is finished executing, and the scheduler moves to the next event,
the scheduler compares the next event execution time with the machine clock.  If
the next event is scheduled for a future time, the simulator sleeps until that
realtime is reached and then executes the next event.</p>
<p>It may happen that, due to the processing inherent in the execution of
simulation events, that the simulator cannot keep up with realtime.  In such a
case, it is up to the user configuration what to do. There are two <em>ns-3</em>
attributes that govern the behavior. The first is
<code class="docutils literal notranslate"><span class="pre">ns3::RealTimeSimulatorImpl::SynchronizationMode</span></code>. The two entries possible
for this attribute are <code class="docutils literal notranslate"><span class="pre">BestEffort</span></code> (the default) or <code class="docutils literal notranslate"><span class="pre">HardLimit</span></code>. In
“BestEffort” mode, the simulator will just try to catch up to realtime by
executing events until it reaches a point where the next event is in the
(realtime) future, or else the simulation ends. In BestEffort mode, then, it is
possible for the simulation to consume more time than the wall clock time. The
other option “HardLimit” will cause the simulation to abort if the tolerance
threshold is exceeded.  This attribute is
<code class="docutils literal notranslate"><span class="pre">ns3::RealTimeSimulatorImpl::HardLimit</span></code> and the default is 0.1 seconds.</p>
<p>A different mode of operation is one in which simulated time is <strong>not</strong> frozen
during an event execution. This mode of realtime simulation was implemented but
removed from the <em>ns-3</em> tree because of questions of whether it would be useful.
If users are interested in a realtime simulator for which simulation time does
not freeze during event execution (i.e., every call to <code class="docutils literal notranslate"><span class="pre">Simulator::Now()</span></code>
returns the current wall clock time, not the time at which the event started
executing), please contact the ns-developers mailing list.</p>
</section>
<section id="usage">
<h4><span class="section-number">2.6.2. </span>Usage<a class="headerlink" href="#usage" title="Link to this heading">¶</a></h4>
<p>The usage of the realtime simulator is straightforward, from a scripting
perspective.  Users just need to set the attribute
<code class="docutils literal notranslate"><span class="pre">SimulatorImplementationType</span></code> to the Realtime simulator, such as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">GlobalValue</span><span class="o">::</span><span class="n">Bind</span><span class="p">(</span><span class="s">&quot;SimulatorImplementationType&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;ns3::RealtimeSimulatorImpl&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>There is a script in <code class="docutils literal notranslate"><span class="pre">examples/realtime/realtime-udp-echo.cc</span></code> that
has an example of how to configure the realtime behavior.  Try:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>realtime-udp-echo
</pre></div>
</div>
<p>Whether the simulator will work in a best effort or hard limit policy fashion is
governed by the attributes explained in the previous section.</p>
</section>
<section id="implementation">
<h4><span class="section-number">2.6.3. </span>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">¶</a></h4>
<p>The implementation is contained in the following files:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src/core/model/realtime-simulator-impl.{cc,h}</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/core/model/wall-clock-synchronizer.{cc,h}</span></code></p></li>
</ul>
<p>In order to create a realtime scheduler, to a first approximation you just want
to cause simulation time jumps to consume real time. We propose doing this using
a combination of sleep- and busy- waits. Sleep-waits cause the calling process
(thread) to yield the processor for some amount of time. Even though this
specified amount of time can be passed to nanosecond resolution, it is actually
converted to an OS-specific granularity. In Linux, the granularity is called a
Jiffy. Typically this resolution is insufficient for our needs (on the order of
a ten milliseconds), so we round down and sleep for some smaller number of
Jiffies. The process is then awakened after the specified number of Jiffies has
passed. At this time, we have some residual time to wait. This time is generally
smaller than the minimum sleep time, so we busy-wait for the remainder of the
time. This means that the thread just sits in a for loop consuming cycles until
the desired time arrives. After the combination of sleep- and busy-waits, the
elapsed realtime (wall) clock should agree with the simulation time of the next
event and the simulation proceeds.</p>
</section>
</section>
</div>
</section>
<span id="document-features"></span><section id="additional-tools">
<h2><span class="section-number">3. </span>Additional Tools<a class="headerlink" href="#additional-tools" title="Link to this heading">¶</a></h2>
<p>This chapter covers some additional features provided by ns-3 which can be useful in writing models and scripts.</p>
<div class="toctree-wrapper compound">
<span id="document-random-variables"></span><section id="random-variables">
<h3><span class="section-number">3.1. </span>Random Variables<a class="headerlink" href="#random-variables" title="Link to this heading">¶</a></h3>
<p><em>ns-3</em> contains a built-in pseudo-random number generator (PRNG). It is important
for serious users of the simulator to understand the functionality,
configuration, and usage of this PRNG, and to decide whether it is sufficient
for his or her research use.</p>
<section id="quick-overview">
<h4><span class="section-number">3.1.1. </span>Quick Overview<a class="headerlink" href="#quick-overview" title="Link to this heading">¶</a></h4>
<p><em>ns-3</em> random numbers are provided via instances of
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::RandomVariableStream</span></code>.</p>
<ul class="simple">
<li><p>by default, <em>ns-3</em> simulations use a fixed seed; if there is any randomness in
the simulation, each run of the program will yield identical results unless
the seed and/or run number is changed.</p></li>
<li><p>in <em>ns-3.3</em> and earlier, <em>ns-3</em> simulations used a random seed by default; this
marks a change in policy starting with <em>ns-3.4</em>.</p></li>
<li><p>in <em>ns-3.14</em> and earlier, <em>ns-3</em> simulations used a different wrapper class
called <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::RandomVariable</span></code>.  As of <em>ns-3.15</em>, this class has been
replaced by <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::RandomVariableStream</span></code>; the underlying pseudo-random
number generator has not changed.</p></li>
<li><p>to obtain randomness across multiple simulation runs, you must either set the
seed differently or set the run number differently.  To set a seed, call
<code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">ns3::RngSeedManager::SetSeed()</span></code> at the beginning of the program; to set
a run number with the same seed, call <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">ns3::RngSeedManager::SetRun()</span></code> at
the beginning of the program; see <a class="reference internal" href="#seeding-and-independent-replications"><span class="std std-ref">Creating random variables</span></a>.</p></li>
<li><p>each RandomVariableStream used in <em>ns-3</em> has a virtual random number generator
associated with it; all random variables use either a fixed or random seed
based on the use of the global seed (previous bullet);</p></li>
<li><p>if you intend to perform multiple runs of the same scenario, with different
random numbers, please be sure to read the section on how to perform
independent replications: <a class="reference internal" href="#seeding-and-independent-replications"><span class="std std-ref">Creating random variables</span></a>.</p></li>
</ul>
<p>Read further for more explanation about the random number facility for <em>ns-3</em>.</p>
</section>
<section id="background">
<h4><span class="section-number">3.1.2. </span>Background<a class="headerlink" href="#background" title="Link to this heading">¶</a></h4>
<p>Simulations use a lot of random numbers; one study
found that most network simulations spend as much as 50%
of the CPU generating random numbers.  Simulation users need
to be concerned with the quality of the (pseudo) random numbers and
the independence between different streams of random numbers.</p>
<p>Users need to be concerned with a few issues, such as:</p>
<ul class="simple">
<li><p>the seeding of the random number generator and whether a
simulation outcome is deterministic or not,</p></li>
<li><p>how to acquire different streams of random numbers that are
independent from one another, and</p></li>
<li><p>how long it takes for streams to cycle</p></li>
</ul>
<p>We will introduce a few terms here:  a RNG provides a long sequence
of (pseudo) random numbers.
The length of this sequence is called the <em>cycle length</em>
or <em>period</em>, after which the RNG will repeat itself.
This sequence can
be  partitioned into disjoint <em>streams</em>.  A stream of a
RNG is a contiguous subset or block of the RNG sequence.
For instance, if the
RNG period is of length N, and two streams are provided from this
RNG, then
the first stream might use the first N/2 values and the second
stream might produce the second N/2 values.  An important property
here is that the two streams are uncorrelated.  Likewise, each
stream can be partitioned disjointedly to a number of
uncorrelated <em>substreams</em>.  The underlying RNG hopefully
produces a pseudo-random sequence of numbers with a very long
cycle length, and partitions this into streams and substreams in an
efficient manner.</p>
<p><em>ns-3</em> uses the same underlying random number generator as does <em>ns-2</em>:  the
MRG32k3a generator from Pierre L’Ecuyer.  A detailed description can be found in
<a class="reference external" href="http://www.iro.umontreal.ca/~lecuyer/myftp/papers/streams00.pdf">http://www.iro.umontreal.ca/~lecuyer/myftp/papers/streams00.pdf</a>.  The MRG32k3a
generator provides <img class="math" src="_images/math/7bc755977774155c946c69cdcc441af1158e91a7.png" alt="1.8x10^{19}"/> independent streams of random numbers,
each of which consists of <img class="math" src="_images/math/31dc40610b46af3bcbd9eb68b6b5ec5350027bff.png" alt="2.3x10^{15}"/> substreams. Each substream has a
period (<em>i.e.</em>, the number of random numbers before overlap) of
<img class="math" src="_images/math/b221b0c74b72bae4e861a699b85b5964c8f01732.png" alt="7.6x10^{22}"/>. The period of the entire generator is <img class="math" src="_images/math/abeb4f688127a64818f66a29f6a61500bf02197d.png" alt="3.1x10^{57}"/>.</p>
<p>Class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::RandomVariableStream</span></code> is the public interface to this
underlying random number generator.  When users create new random variables
(such as <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::UniformRandomVariable</span></code>,
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::ExponentialRandomVariable</span></code>, etc.), they create an object that uses
one of the distinct, independent streams of the random number generator.
Therefore, each object of type <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::RandomVariableStream</span></code> has,
conceptually, its own “virtual” RNG.  Furthermore, each
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::RandomVariableStream</span></code> can be configured to use one of the set of
substreams drawn from the main stream.</p>
<p>An alternate implementation would be to allow each RandomVariable to have its
own (differently seeded) RNG.  However, we cannot guarantee as strongly that the
different sequences would be uncorrelated in such a case; hence, we prefer to
use a single RNG and streams and substreams from it.</p>
</section>
<section id="creating-random-variables">
<span id="seeding-and-independent-replications"></span><h4><span class="section-number">3.1.3. </span>Creating random variables<a class="headerlink" href="#creating-random-variables" title="Link to this heading">¶</a></h4>
<p><em>ns-3</em> supports a number of random variable objects from the base class
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">RandomVariableStream</span></code>.  These objects derive from
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::Object</span></code> and are handled by smart pointers.</p>
<p>The correct way to create these objects is to use the templated
<cite>CreateObject&lt;&gt;</cite> method, such as:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">UniformRandomVariable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">UniformRandomVariable</span><span class="o">&gt;</span><span class="p">();</span>
</pre></div>
</div>
<p>then you can access values by calling methods on the object such as:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">myRandomNo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">-&gt;</span><span class="n">GetInteger</span><span class="p">();</span>
</pre></div>
</div>
<p>If you try to instead do something like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">myRandomNo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UniformRandomVariable</span><span class="p">().</span><span class="n">GetInteger</span><span class="p">();</span>
</pre></div>
</div>
<p>your program will encounter a segmentation fault, because the implementation
relies on some attribute construction that occurs only when <cite>CreateObject</cite>
is called.</p>
<p>Much of the rest of this chapter now discusses the properties of the
stream of pseudo-random numbers generated from such objects, and how to
control the seeding of such objects.</p>
</section>
<section id="id1">
<h4><span class="section-number">3.1.4. </span>Seeding and independent replications<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h4>
<p><em>ns-3</em> simulations can be configured to produce deterministic or random results.
If the <em>ns-3</em> simulation is configured to use a fixed, deterministic seed with
the same run number, it should give the same output each time it is run.</p>
<p>By default, <em>ns-3</em> simulations use a fixed seed and run number.  These values
are stored in two <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::GlobalValue</span></code> instances: <code class="docutils literal notranslate"><span class="pre">g_rngSeed</span></code> and
<code class="docutils literal notranslate"><span class="pre">g_rngRun</span></code>.</p>
<p>A typical use case is to run a simulation as a sequence of independent trials,
so as to compute statistics on a large number of independent runs.  The user can
either change the global seed and rerun the simulation, or can advance the
substream state of the RNG, which is referred to as incrementing the run number.</p>
<p>A class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::RngSeedManager</span></code> provides an API to control the seeding and
run number behavior.  This seeding and substream state setting must be called
before any random variables are created; e.g:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">RngSeedManager</span><span class="o">::</span><span class="n">SetSeed</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w">  </span><span class="c1">// Changes seed from default of 1 to 3</span>
<span class="n">RngSeedManager</span><span class="o">::</span><span class="n">SetRun</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span><span class="w">   </span><span class="c1">// Changes run number from default of 1 to 7</span>
<span class="c1">// Now, create random variables</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">UniformRandomVariable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">UniformRandomVariable</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">ExponentialRandomVariable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">ExponentialRandomVarlable</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">...</span>
</pre></div>
</div>
<p>Which is better, setting a new seed or advancing the substream state?  There is
no guarantee that the streams produced by two random seeds will not overlap.
The only way to guarantee that two streams do not overlap is to use the
substream capability provided by the RNG implementation.  <em>Therefore, use the
substream capability to produce multiple independent runs of the same
simulation.</em> In other words, the more statistically rigorous way to configure
multiple independent replications is to use a fixed seed and to advance the run
number.  This implementation allows for a maximum of <img class="math" src="_images/math/31dc40610b46af3bcbd9eb68b6b5ec5350027bff.png" alt="2.3x10^{15}"/>
independent replications using the substreams.</p>
<p>For ease of use, it is not necessary to control the seed and run number from
within the program; the user can set the <code class="docutils literal notranslate"><span class="pre">NS_GLOBAL_VALUE</span></code> environment
variable as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nv">NS_GLOBAL_VALUE</span><span class="o">=</span><span class="s2">&quot;RngRun=3&quot;</span><span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>program-name
</pre></div>
</div>
<p>Another way to control this is by passing a command-line argument; since this is
an <em>ns-3</em> GlobalValue instance, it is equivalently done such as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>program-name<span class="w"> </span>--command-template<span class="o">=</span><span class="s2">&quot;%s --RngRun=3&quot;</span>
</pre></div>
</div>
<p>or, if you are running programs directly outside of ns3:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./build/optimized/scratch/program-name<span class="w"> </span>--RngRun<span class="o">=</span><span class="m">3</span>
</pre></div>
</div>
<p>The above command-line variants make it easy to run lots of different
runs from a shell script by just passing a different RngRun index.</p>
</section>
<section id="class-randomvariablestream">
<h4><span class="section-number">3.1.5. </span>Class RandomVariableStream<a class="headerlink" href="#class-randomvariablestream" title="Link to this heading">¶</a></h4>
<p>All random variables should derive from class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">RandomVariable</span></code>. This
base class provides a few methods for globally configuring the behavior
of the random number generator. Derived classes provide API for drawing random
variates from the particular distribution being supported.</p>
<p>Each RandomVariableStream created in the simulation is given a generator that is a
new RNGStream from the underlying PRNG. Used in this manner, the L’Ecuyer
implementation allows for a maximum of <img class="math" src="_images/math/ce00b567c62f520f9a3fec854af6e8ca530afbfd.png" alt="1.8x10^19"/> random variables.  Each
random variable in a single replication can produce up to <img class="math" src="_images/math/e91e442e51f610bd366686d760b40020dd85ee33.png" alt="7.6x10^22"/>
random numbers before overlapping.</p>
</section>
<section id="base-class-public-api">
<h4><span class="section-number">3.1.6. </span>Base class public API<a class="headerlink" href="#base-class-public-api" title="Link to this heading">¶</a></h4>
<p>Below are excerpted a few public methods of class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">RandomVariableStream</span></code>
that access the next value in the substream.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * \brief Returns a random double from the underlying distribution</span>
<span class="cm"> * \return A floating point random value</span>
<span class="cm"> */</span>
<span class="kt">double</span><span class="w"> </span><span class="nf">GetValue</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * \brief Returns a random integer from the underlying distribution</span>
<span class="cm"> * \return  Integer cast of ::GetValue()</span>
<span class="cm"> */</span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">GetInteger</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p>We have already described the seeding configuration above. Different
RandomVariable subclasses may have additional API.</p>
</section>
<section id="types-of-randomvariables">
<h4><span class="section-number">3.1.7. </span>Types of RandomVariables<a class="headerlink" href="#types-of-randomvariables" title="Link to this heading">¶</a></h4>
<p>The following types of random variables are provided, and are documented in the
<em>ns-3</em> Doxygen or by reading <code class="docutils literal notranslate"><span class="pre">src/core/model/random-variable-stream.h</span></code>.  Users
can also create their own custom random variables by deriving from class
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">RandomVariableStream</span></code>.</p>
<ul class="simple">
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">UniformRandomVariable</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ConstantRandomVariable</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">SequentialRandomVariable</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ExponentialRandomVariable</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ParetoRandomVariable</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">WeibullRandomVariable</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">NormalRandomVariable</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">LogNormalRandomVariable</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">GammaRandomVariable</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ErlangRandomVariable</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">TriangularRandomVariable</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ZipfRandomVariable</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ZetaRandomVariable</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">DeterministicRandomVariable</span></code></p></li>
<li><p>class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">EmpiricalRandomVariable</span></code></p></li>
</ul>
</section>
<section id="semantics-of-randomvariablestream-objects">
<h4><span class="section-number">3.1.8. </span>Semantics of RandomVariableStream objects<a class="headerlink" href="#semantics-of-randomvariablestream-objects" title="Link to this heading">¶</a></h4>
<p>RandomVariableStream objects derive from <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::Object</span></code> and are
handled by smart pointers.</p>
<p>RandomVariableStream instances can also be used in <em>ns-3</em> attributes, which means
that values can be set for them through the <em>ns-3</em> attribute system.
An example is in the propagation models for WifiNetDevice:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">TypeId</span>
<span class="nf">RandomPropagationDelayModel::GetTypeId</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeId</span><span class="p">(</span><span class="s">&quot;ns3::RandomPropagationDelayModel&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">SetParent</span><span class="o">&lt;</span><span class="n">PropagationDelayModel</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">SetGroupName</span><span class="p">(</span><span class="s">&quot;Propagation&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddConstructor</span><span class="o">&lt;</span><span class="n">RandomPropagationDelayModel</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddAttribute</span><span class="p">(</span><span class="s">&quot;Variable&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="s">&quot;The random variable which generates random delays (s).&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;ns3::UniformRandomVariable&quot;</span><span class="p">),</span>
<span class="w">                  </span><span class="n">MakePointerAccessor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RandomPropagationDelayModel</span><span class="o">::</span><span class="n">m_variable</span><span class="p">),</span>
<span class="w">                  </span><span class="n">MakePointerChecker</span><span class="o">&lt;</span><span class="n">RandomVariableStream</span><span class="o">&gt;</span><span class="p">())</span>
<span class="w">    </span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, the <em>ns-3</em> user can change the default random variable for this
delay model (which is a UniformRandomVariable ranging from 0 to 1) through
the attribute system.</p>
</section>
<section id="using-other-prng">
<h4><span class="section-number">3.1.9. </span>Using other PRNG<a class="headerlink" href="#using-other-prng" title="Link to this heading">¶</a></h4>
<p>There is presently no support for substituting a different underlying
random number generator (e.g., the GNU Scientific Library or the Akaroa
package).  Patches are welcome.</p>
</section>
<section id="setting-the-stream-number">
<h4><span class="section-number">3.1.10. </span>Setting the stream number<a class="headerlink" href="#setting-the-stream-number" title="Link to this heading">¶</a></h4>
<p>The underlying MRG32k3a generator provides 2^64 independent streams.
In ns-3, these are assigned sequentially starting from the first stream as
new RandomVariableStream instances make their first call to GetValue().</p>
<p>As a result of how these RandomVariableStream objects are assigned to
underlying streams, the assignment is sensitive to perturbations of
the simulation configuration.  The consequence is that if any aspect of the
simulation configuration is changed, the mapping of RandomVariables to
streams may (or may not) change.</p>
<p>As a concrete example, a user running a comparative study between routing
protocols may find that the act of changing one routing protocol for another
will notice that the underlying mobility pattern also changed.</p>
<p>Starting with ns-3.15, some control has been provided to users to allow
users to optionally fix the assignment of selected RandomVariableStream
objects to underlying streams.  This is the <code class="docutils literal notranslate"><span class="pre">Stream</span></code> attribute, part
of the base class RandomVariableStream.</p>
<p>By partitioning the existing sequence of streams from before:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;--------------------------------------------------------------------------&gt;
stream 0                                                   stream (2^64 - 1)
</pre></div>
</div>
<p>into two equal-sized sets:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;--------------------------------------------------------------------------&gt;
^                                    ^^                                    ^
|                                    ||                                    |
stream 0            stream (2^63 - 1)  stream 2^63         stream (2^64 - 1)
&lt;- automatically assigned -----------&gt;&lt;- assigned by user -----------------&gt;
</pre></div>
</div>
<p>The first 2^63 streams continue to be automatically assigned, while
the last 2^63 are given stream indices starting with zero up to
2^63-1.</p>
<p>The assignment of streams to a fixed stream number is optional; instances
of RandomVariableStream that do not have a stream value assigned will
be assigned the next one from the pool of automatic streams.</p>
<p>To fix a RandomVariableStream to a particular underlying stream, assign
its <code class="docutils literal notranslate"><span class="pre">Stream</span></code> attribute to a non-negative integer (the default value
of -1 means that a value will be automatically allocated).</p>
</section>
<section id="publishing-your-results">
<h4><span class="section-number">3.1.11. </span>Publishing your results<a class="headerlink" href="#publishing-your-results" title="Link to this heading">¶</a></h4>
<p>When you publish simulation results, a key piece of configuration
information that you should always state is how you used the
random number generator.</p>
<ul class="simple">
<li><p>what seeds you used,</p></li>
<li><p>what RNG you used if not the default,</p></li>
<li><p>how were independent runs performed,</p></li>
<li><p>for large simulations, how did you check that you did not cycle.</p></li>
</ul>
<p>It is incumbent on the researcher publishing results to include enough
information to allow others to reproduce his or her results. It is also
incumbent on the researcher to convince oneself that the random numbers used
were statistically valid, and to state in the paper why such confidence is
assumed.</p>
</section>
<section id="summary">
<h4><span class="section-number">3.1.12. </span>Summary<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h4>
<p>Let’s review what things you should do when creating a simulation.</p>
<ul class="simple">
<li><p>Decide whether you are running with a fixed seed or random seed; a fixed seed
is the default,</p></li>
<li><p>Decide how you are going to manage independent replications, if applicable,</p></li>
<li><p>Convince yourself that you are not drawing more random values than the cycle
length, if you are running a very long simulation, and</p></li>
<li><p>When you publish, follow the guidelines above about documenting your use of
the random number generator.</p></li>
</ul>
</section>
</section>
<span id="document-hash-functions"></span><section id="hash-functions">
<h3><span class="section-number">3.2. </span>Hash Functions<a class="headerlink" href="#hash-functions" title="Link to this heading">¶</a></h3>
<p><em>ns-3</em> provides a generic interface to general purpose hash functions.
In the simplest usage, the hash function returns the 32-bit or 64-bit
hash of a data buffer or string.  The default underlying hash function
is <a class="reference external" href="http://code.google.com/p/smhasher/wiki/MurmurHash3">murmur3</a>, chosen because it has good hash function properties and
offers a 64-bit version.  The venerable <a class="reference external" href="http://isthe.com/chongo/tech/comp/fnv/">FNV1a</a> hash is also available.</p>
<p>There is a straight-forward mechanism to
add (or provide at run time) alternative hash function implementations.</p>
<section id="basic-usage">
<h4><span class="section-number">3.2.1. </span>Basic Usage<a class="headerlink" href="#basic-usage" title="Link to this heading">¶</a></h4>
<p>The simplest way to get a hash value of a data buffer or string is just</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/hash.h&quot;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">ns3</span><span class="p">;</span>

<span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span>
<span class="kt">size_t</span><span class="w"> </span><span class="n">buffer_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span>

<span class="kt">uint32_t</span><span class="w"> </span><span class="n">buffer_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Hash32</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">buffer_size</span><span class="p">);</span>

<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="n">string_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Hash32</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</pre></div>
</div>
<p>Equivalent functions are defined for 64-bit hash values.</p>
</section>
<section id="incremental-hashing">
<h4><span class="section-number">3.2.2. </span>Incremental Hashing<a class="headerlink" href="#incremental-hashing" title="Link to this heading">¶</a></h4>
<p>In some situations it’s useful to compute the hash of multiple buffers,
as if they had been joined together.  (For example, you might want
the hash of a packet stream, but not want to assemble a single buffer
with the combined contents of all the packets.)</p>
<p>This is almost as straight-forward as the first example</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/hash.h&quot;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">ns3</span><span class="p">;</span>

<span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span>
<span class="kt">size_t</span><span class="w"> </span><span class="n">buffer_size</span><span class="p">;</span>

<span class="n">Hasher</span><span class="w"> </span><span class="n">hasher</span><span class="p">;</span><span class="w">  </span><span class="c1">// Use default hash function</span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="o">&lt;</span><span class="n">every</span><span class="w"> </span><span class="n">buffer</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_next_buffer</span><span class="p">();</span>
<span class="w">    </span><span class="n">hasher</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">buffer_size</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="n">combined_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">GetHash32</span><span class="p">();</span>
</pre></div>
</div>
<p>By default <code class="docutils literal notranslate"><span class="pre">Hasher</span></code> preserves internal state to enable incremental
hashing.  If you want to reuse a <code class="docutils literal notranslate"><span class="pre">Hasher</span></code> object (for example
because it’s configured with a non-default hash function), but don’t
want to add to the previously computed hash, you need to <code class="docutils literal notranslate"><span class="pre">clear()</span></code>
first</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">hasher</span><span class="p">.</span><span class="n">clear</span><span class="p">().</span><span class="n">GetHash32</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">buffer_size</span><span class="p">);</span>
</pre></div>
</div>
<p>This reinitializes the internal state before hashing the buffer.</p>
</section>
<section id="using-an-alternative-hash-function">
<h4><span class="section-number">3.2.3. </span>Using an Alternative Hash Function<a class="headerlink" href="#using-an-alternative-hash-function" title="Link to this heading">¶</a></h4>
<p>The default hash function is <a class="reference external" href="http://code.google.com/p/smhasher/wiki/MurmurHash3">murmur3</a>.  <a class="reference external" href="http://isthe.com/chongo/tech/comp/fnv/">FNV1a</a> is also available.  To specify
the hash function explicitly, use this constructor</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Hasher</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Hasher</span><span class="p">(</span><span class="n">Create</span><span class="o">&lt;</span><span class="n">Hash</span><span class="o">::</span><span class="n">Function</span><span class="o">::</span><span class="n">Fnv1a</span><span class="o">&gt;</span><span class="p">());</span>
</pre></div>
</div>
</section>
<section id="adding-new-hash-function-implementations">
<h4><span class="section-number">3.2.4. </span>Adding New Hash Function Implementations<a class="headerlink" href="#adding-new-hash-function-implementations" title="Link to this heading">¶</a></h4>
<p>To add the hash function <code class="docutils literal notranslate"><span class="pre">foo</span></code>, follow the <code class="docutils literal notranslate"><span class="pre">hash-murmur3.h</span></code>/<code class="docutils literal notranslate"><span class="pre">.cc</span></code> pattern:</p>
<blockquote>
<div><ul class="simple">
<li><p>Create a class declaration (<code class="docutils literal notranslate"><span class="pre">.h</span></code>) and definition (<code class="docutils literal notranslate"><span class="pre">.cc</span></code>) inheriting
from <code class="docutils literal notranslate"><span class="pre">Hash::Implementation</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">include</span></code> the declaration in <code class="docutils literal notranslate"><span class="pre">hash.h</span></code> (at the point where
<code class="docutils literal notranslate"><span class="pre">hash-murmur3.h</span></code> is included.</p></li>
<li><p>In your own code, instantiate a <code class="docutils literal notranslate"><span class="pre">Hasher</span></code> object via the constructor
<code class="docutils literal notranslate"><span class="pre">Hasher(Ptr&lt;Hash::Function::Foo&gt;())</span></code></p></li>
</ul>
</div></blockquote>
<p>If your hash function is a single function, e.g. <code class="docutils literal notranslate"><span class="pre">hashf</span></code>, you don’t
even need to create a new class derived from HashImplementation</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Hasher</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Hasher</span><span class="p">(</span><span class="n">Create</span><span class="o">&lt;</span><span class="n">Hash</span><span class="o">::</span><span class="n">Function</span><span class="o">::</span><span class="n">Hash32</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hashf</span><span class="p">));</span>
</pre></div>
</div>
<p>For this to compile, your <code class="docutils literal notranslate"><span class="pre">hashf</span></code> has to match one of the function pointer
signatures</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">Hash32Function_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="p">);</span>
<span class="k">typedef</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">Hash64Function_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="sources-for-hash-functions">
<h4><span class="section-number">3.2.5. </span>Sources for Hash Functions<a class="headerlink" href="#sources-for-hash-functions" title="Link to this heading">¶</a></h4>
<p>Sources for other hash function implementations include:</p>
<blockquote>
<div><ul class="simple">
<li><p>Peter Kankowski: <a class="reference external" href="http://www.strchr.com">http://www.strchr.com</a></p></li>
<li><p>Arash Partow:    <a class="reference external" href="http://www.partow.net/programming/hashfunctions/index.html">http://www.partow.net/programming/hashfunctions/index.html</a></p></li>
<li><p>SMHasher:        <a class="reference external" href="http://code.google.com/p/smhasher/">http://code.google.com/p/smhasher/</a></p></li>
<li><p>Sanmayce:        <a class="reference external" href="http://www.sanmayce.com/Fastest_Hash/index.html">http://www.sanmayce.com/Fastest_Hash/index.html</a></p></li>
</ul>
</div></blockquote>
</section>
</section>
<span id="document-tracing"></span><section id="tracing">
<h3><span class="section-number">3.3. </span>Tracing<a class="headerlink" href="#tracing" title="Link to this heading">¶</a></h3>
<p>The tracing subsystem is one of the most important mechanisms to understand in
<em>ns-3</em>. In most cases, <em>ns-3</em> users will have a brilliant idea for some new and
improved networking feature. In order to verify that this idea works, the
researcher will make changes to an existing system and then run experiments to
see how the new feature behaves by gathering statistics that capture the
behavior of the feature.</p>
<p>In other words, the whole point of running a simulation is to generate output
for further study. In <em>ns-3</em>, the subsystem that enables a researcher to do this
is the tracing subsystem.</p>
<section id="tracing-motivation">
<h4><span class="section-number">3.3.1. </span>Tracing Motivation<a class="headerlink" href="#tracing-motivation" title="Link to this heading">¶</a></h4>
<p>There are many ways to get information out of a program. The most
straightforward way is to just directly print the information to the standard
output, as in,</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="p">...</span>
<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;The value of x is &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is workable in small environments, but as your simulations get more and
more complicated, you end up with more and more prints and the task of parsing
and performing computations on the output begins to get harder and harder.</p>
<p>Another thing to consider is that every time a new tidbit is needed, the
software core must be edited and another print introduced. There is no
standardized way to control all of this output, so the amount of output tends to
grow without bounds. Eventually, the bandwidth required for simply outputting
this information begins to limit the running time of the simulation. The output
files grow to enormous sizes and parsing them becomes a problem.</p>
<p><em>ns-3</em> provides a simple mechanism for logging and providing some control over
output via <em>Log Components</em>, but the level of control is not very fine grained
at all. The logging module is a relatively blunt instrument.</p>
<p>It is desirable to have a facility that allows one to reach into the core system
and only get the information required without having to change and recompile the
core system. Even better would be a system that notified the user when an item
of interest changed or an interesting event happened.</p>
<p>The <em>ns-3</em> tracing system is designed to work along those lines and is
well-integrated with the Attribute and Config substems allowing for relatively
simple use scenarios.</p>
</section>
<section id="overview">
<h4><span class="section-number">3.3.2. </span>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h4>
<p>The tracing subsystem relies heavily on the <em>ns-3</em> Callback and Attribute
mechanisms. You should read and understand the corresponding sections of the
manual before attempting to understand the tracing system.</p>
<p>The <em>ns-3</em> tracing system is built on the concepts of independent tracing sources
and tracing sinks; along with a uniform mechanism for connecting sources to
sinks.</p>
<p>Trace sources are entities that can signal events that happen in a simulation
and provide access to interesting underlying data. For example, a trace source
could indicate when a packet is received by a net device and provide access to
the packet contents for interested trace sinks. A trace source might also
indicate when an interesting state change happens in a model. For example, the
congestion window of a TCP model is a prime candidate for a trace source.</p>
<p>Trace sources are not useful by themselves; they must be connected to other
pieces of code that actually do something useful with the information provided
by the source.  The entities that consume trace information are called trace
sinks. Trace sources are generators of events and trace sinks are consumers.</p>
<p>This explicit division allows for large numbers of trace sources to be scattered
around the system in places which model authors believe might be useful. Unless
a user connects a trace sink to one of these sources, nothing is output. This
arrangement allows relatively unsophisticated users to attach new types of sinks
to existing tracing sources, without requiring editing and recompiling the core
or models of the simulator.</p>
<p>There can be zero or more consumers of trace events generated by a trace source.
One can think of a trace source as a kind of point-to-multipoint information
link.</p>
<p>The “transport protocol” for this conceptual point-to-multipoint link is an
<em>ns-3</em> <code class="docutils literal notranslate"><span class="pre">Callback</span></code>.</p>
<p>Recall from the Callback Section that callback facility is a way to allow two
modules in the system to communicate via function calls while at the same time
decoupling the calling function from the called class completely. This is the
same requirement as outlined above for the tracing system.</p>
<p>Basically, a trace source <em>is</em> a callback to which multiple functions may be
registered. When a trace sink expresses interest in receiving trace events, it
adds a callback to a list of callbacks held by the trace source. When an
interesting event happens, the trace source invokes its <code class="docutils literal notranslate"><span class="pre">operator()</span></code> providing
zero or more parameters. This tells the source to go through its list of
callbacks invoking each one in turn. In this way, the parameter(s) are
communicated to the trace sinks, which are just functions.</p>
<section id="the-simplest-example">
<h5><span class="section-number">3.3.2.1. </span>The Simplest Example<a class="headerlink" href="#the-simplest-example" title="Link to this heading">¶</a></h5>
<p>It will be useful to go walk a quick example just to reinforce what we’ve
said.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/object.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/uinteger.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/traced-value.h&quot;</span><span class="c1">&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/trace-source-accessor.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">ns3</span><span class="p">;</span>
</pre></div>
</div>
<p>The first thing to do is include the required files. As mentioned above, the
trace system makes heavy use of the Object and Attribute systems. The first two
includes bring in the declarations for those systems. The file,
<code class="docutils literal notranslate"><span class="pre">traced-value.h</span></code> brings in the required declarations for tracing data that
obeys value semantics.</p>
<p>In general, value semantics just means that you can pass the object around, not
an address. In order to use value semantics at all you have to have an object
with an associated copy constructor and assignment operator available. We extend
the requirements to talk about the set of operators that are pre-defined for
plain-old-data (POD) types. Operator=, operator++, operator–, operator+,
operator==, etc.</p>
<p>What this all means is that you will be able to trace changes to an object
made using those operators.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyObject</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Object</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">GetTypeId</span><span class="p">()</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeId</span><span class="p">(</span><span class="s">&quot;MyObject&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="n">SetParent</span><span class="p">(</span><span class="n">Object</span><span class="o">::</span><span class="n">GetTypeId</span><span class="p">())</span>
<span class="w">      </span><span class="p">.</span><span class="n">AddConstructor</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">      </span><span class="p">.</span><span class="n">AddTraceSource</span><span class="p">(</span><span class="s">&quot;MyInteger&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;An integer value to trace.&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="n">MakeTraceSourceAccessor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyObject</span><span class="o">::</span><span class="n">m_myInt</span><span class="p">))</span>
<span class="w">      </span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">MyObject</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="n">TracedValue</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_myInt</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Since the tracing system is integrated with Attributes, and Attributes work with
Objects, there must be an <em>ns-3</em> <code class="docutils literal notranslate"><span class="pre">Object</span></code> for the trace source to live in. The
two important lines of code are the <code class="docutils literal notranslate"><span class="pre">.AddTraceSource</span></code> and the <code class="docutils literal notranslate"><span class="pre">TracedValue</span></code>
declaration.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">.AddTraceSource</span></code> provides the “hooks” used for connecting the trace
source to the outside world. The <code class="docutils literal notranslate"><span class="pre">TracedValue</span></code> declaration provides the
infrastructure that overloads the operators mentioned above and drives the
callback process.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">IntTrace</span><span class="p">(</span><span class="n">Int</span><span class="w"> </span><span class="n">oldValue</span><span class="p">,</span><span class="w"> </span><span class="n">Int</span><span class="w"> </span><span class="n">newValue</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Traced &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">oldValue</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; to &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">newValue</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is the definition of the trace sink. It corresponds directly to a callback
function. This function will be called whenever one of the operators of the
<code class="docutils literal notranslate"><span class="pre">TracedValue</span></code> is executed.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;</span><span class="w"> </span><span class="n">myObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">MyObject</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">  </span><span class="n">myObject</span><span class="o">-&gt;</span><span class="n">TraceConnectWithoutContext</span><span class="p">(</span><span class="s">&quot;MyInteger&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">MakeCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">IntTrace</span><span class="p">));</span>

<span class="w">  </span><span class="n">myObject</span><span class="o">-&gt;</span><span class="n">m_myInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1234</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In this snippet, the first thing that needs to be done is to create the object
in which the trace source lives.</p>
<p>The next step, the <code class="docutils literal notranslate"><span class="pre">TraceConnectWithoutContext</span></code>, forms the connection between
the trace source and the trace sink. Notice the <code class="docutils literal notranslate"><span class="pre">MakeCallback</span></code> template
function. Recall from the Callback section that this creates the specialized
functor responsible for providing the overloaded <code class="docutils literal notranslate"><span class="pre">operator()</span></code> used to “fire”
the callback. The overloaded operators (++, –, etc.) will use this
<code class="docutils literal notranslate"><span class="pre">operator()</span></code> to actually invoke the callback. The
<code class="docutils literal notranslate"><span class="pre">TraceConnectWithoutContext</span></code>, takes a string parameter that provides the name
of the Attribute assigned to the trace source. Let’s ignore the bit about
context for now since it is not important yet.</p>
<p>Finally, the line,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">myObject</span><span class="o">-&gt;</span><span class="n">m_myInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1234</span><span class="p">;</span>
</pre></div>
</div>
<p>should be interpreted as an invocation of <code class="docutils literal notranslate"><span class="pre">operator=</span></code> on the member variable
<code class="docutils literal notranslate"><span class="pre">m_myInt</span></code> with the integer <img class="math" src="_images/math/b648f8658ef578b3c1312db5aea9b2e8d436c232.png" alt="1234"/> passed as a parameter. It turns out
that this operator is defined (by <code class="docutils literal notranslate"><span class="pre">TracedValue</span></code>) to execute a callback that
returns void and takes two integer values as parameters – an old value and a
new value for the integer in question. That is exactly the function signature
for the callback function we provided – <code class="docutils literal notranslate"><span class="pre">IntTrace</span></code>.</p>
<p>To summarize, a trace source is, in essence, a variable that holds a list of
callbacks. A trace sink is a function used as the target of a callback. The
Attribute and object type information systems are used to provide a way to
connect trace sources to trace sinks. The act of “hitting” a trace source is
executing an operator on the trace source which fires callbacks. This results in
the trace sink callbacks registering interest in the source being called with
the parameters provided by the source.</p>
</section>
<section id="using-the-config-subsystem-to-connect-to-trace-sources">
<h5><span class="section-number">3.3.2.2. </span>Using the Config Subsystem to Connect to Trace Sources<a class="headerlink" href="#using-the-config-subsystem-to-connect-to-trace-sources" title="Link to this heading">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">TraceConnectWithoutContext</span></code> call shown above in the simple example is
actually very rarely used in the system. More typically, the <code class="docutils literal notranslate"><span class="pre">Config</span></code>
subsystem is used to allow selecting a trace source in the system using what is
called a <em>config path</em>.</p>
<p>For example, one might find something that looks like the following in the
system (taken from <code class="docutils literal notranslate"><span class="pre">examples/tcp-large-transfer.cc</span></code>):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">CwndTracer</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">oldval</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">newval</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="p">...</span>

<span class="n">Config</span><span class="o">::</span><span class="n">ConnectWithoutContext</span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;/NodeList/0/$ns3::TcpL4Protocol/SocketList/0/CongestionWindow&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">MakeCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CwndTracer</span><span class="p">));</span>
</pre></div>
</div>
<p>This should look very familiar. It is the same thing as the previous example,
except that a static member function of class <code class="docutils literal notranslate"><span class="pre">Config</span></code> is being called instead
of a method on <code class="docutils literal notranslate"><span class="pre">Object</span></code>; and instead of an <code class="docutils literal notranslate"><span class="pre">Attribute</span></code> name, a path is being
provided.</p>
<p>The first thing to do is to read the path backward. The last segment of the path
must be an <code class="docutils literal notranslate"><span class="pre">Attribute</span></code> of an <code class="docutils literal notranslate"><span class="pre">Object</span></code>. In fact, if you had a pointer to the
<code class="docutils literal notranslate"><span class="pre">Object</span></code> that has the “CongestionWindow” <code class="docutils literal notranslate"><span class="pre">Attribute</span></code> handy (call it
<code class="docutils literal notranslate"><span class="pre">theObject</span></code>), you could write this just like the previous example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">CwndTracer</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">oldval</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">newval</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="p">...</span>

<span class="n">theObject</span><span class="o">-&gt;</span><span class="n">TraceConnectWithoutContext</span><span class="p">(</span><span class="s">&quot;CongestionWindow&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">MakeCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CwndTracer</span><span class="p">));</span>
</pre></div>
</div>
<p>It turns out that the code for <code class="docutils literal notranslate"><span class="pre">Config::ConnectWithoutContext</span></code> does exactly
that. This function takes a path that represents a chain of <code class="docutils literal notranslate"><span class="pre">Object</span></code> pointers
and follows them until it gets to the end of the path and interprets the last
segment as an <code class="docutils literal notranslate"><span class="pre">Attribute</span></code> on the last object. Let’s walk through what
happens.</p>
<p>The leading “/” character in the path refers to a so-called namespace. One of the
predefined namespaces in the config system is “NodeList” which is a list of all of
the nodes in the simulation. Items in the list are referred to by indices into the
list, so “/NodeList/0” refers to the zeroth node in the list of nodes created by
the simulation. This node is actually a <code class="docutils literal notranslate"><span class="pre">Ptr&lt;Node&gt;</span></code> and so is a subclass of
an <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ns3::Object</span></code>.</p>
<p>As described in the <a class="reference internal" href="index.html#object-model"><span class="std std-ref">Object model</span></a> section, <em>ns-3</em> supports an object
aggregation model. The next path segment begins with the “$” character which
indicates a <code class="docutils literal notranslate"><span class="pre">GetObject</span></code> call should be made looking for the type that follows.
When a node is initialized by an <code class="docutils literal notranslate"><span class="pre">InternetStackHelper</span></code> a number of interfaces
are aggregated to the node. One of these is the TCP level four protocol. The
runtime type of this protocol object is <code class="docutils literal notranslate"><span class="pre">ns3::TcpL4Protocol''.</span> <span class="pre">When</span> <span class="pre">the</span>
<span class="pre">``GetObject</span></code> is executed, it returns a pointer to the object of this type.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TcpL4Protocol</span></code> class defines an Attribute called “SocketList” which is a
list of sockets.  Each socket is actually an <code class="docutils literal notranslate"><span class="pre">ns3::Object</span></code> with its own
<code class="docutils literal notranslate"><span class="pre">Attributes</span></code>.  The items in the list of sockets are referred to by index just
as in the NodeList, so “SocketList/0” refers to the zeroth socket in the list of
sockets on the zeroth node in the NodeList – the first node constructed in the
simulation.</p>
<p>This socket, the type of which turns out to be an <code class="docutils literal notranslate"><span class="pre">ns3::TcpSocketImpl</span></code> defines
an attribute called “CongestionWindow” which is a <code class="docutils literal notranslate"><span class="pre">TracedValue&lt;uint32_t&gt;</span></code>.
The <code class="docutils literal notranslate"><span class="pre">Config::ConnectWithoutContext</span></code> now does a,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">object</span><span class="o">-&gt;</span><span class="n">TraceConnectWithoutContext</span><span class="p">(</span><span class="s">&quot;CongestionWindow&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">MakeCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CwndTracer</span><span class="p">));</span>
</pre></div>
</div>
<p>using the object pointer from “SocketList/0” which makes the connection between
the trace source defined in the socket to the callback – <code class="docutils literal notranslate"><span class="pre">CwndTracer</span></code>.</p>
<p>Now, whenever a change is made to the <code class="docutils literal notranslate"><span class="pre">TracedValue&lt;uint32_t&gt;</span></code> representing the
congestion window in the TCP socket, the registered callback will be executed
and the function <code class="docutils literal notranslate"><span class="pre">CwndTracer</span></code> will be called printing out the old and new
values of the TCP congestion window.</p>
<p>As a final note, the <cite>Config::Connect…()</cite> functions
will throw an error if the targeted TraceSource does not exist at the path
given.  There are also “fail-safe” versions,
<cite>Config::Connect…FailSafe()</cite>, if you can’t be sure the TraceSource
exists.  The fail-safe versions return <cite>true</cite> if at least one connection
could be made.</p>
</section>
</section>
<section id="using-the-tracing-api">
<h4><span class="section-number">3.3.3. </span>Using the Tracing API<a class="headerlink" href="#using-the-tracing-api" title="Link to this heading">¶</a></h4>
<p>There are three levels of interaction with the tracing system:</p>
<ul class="simple">
<li><p>Beginning user can easily control which objects are participating in tracing;</p></li>
<li><p>Intermediate users can extend the tracing system to modify the output format
generated or use existing trace sources in different ways, without modifying
the core of the simulator;</p></li>
<li><p>Advanced users can modify the simulator core to add new tracing sources and
sinks.</p></li>
</ul>
</section>
<section id="using-trace-helpers">
<h4><span class="section-number">3.3.4. </span>Using Trace Helpers<a class="headerlink" href="#using-trace-helpers" title="Link to this heading">¶</a></h4>
<p>The <em>ns-3</em> trace helpers provide a rich environment for configuring and selecting
different trace events and writing them to files. In previous sections,
primarily “Building Topologies,” we have seen several varieties of the trace
helper methods designed for use inside other (device) helpers.</p>
<p>Perhaps you will recall seeing some of these variations:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">pointToPoint</span><span class="p">.</span><span class="n">EnablePcapAll</span><span class="p">(</span><span class="s">&quot;second&quot;</span><span class="p">);</span>
<span class="n">pointToPoint</span><span class="p">.</span><span class="n">EnablePcap</span><span class="p">(</span><span class="s">&quot;second&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p2pNodes</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetId</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="n">csma</span><span class="p">.</span><span class="n">EnablePcap</span><span class="p">(</span><span class="s">&quot;third&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">csmaDevices</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="n">pointToPoint</span><span class="p">.</span><span class="n">EnableAsciiAll</span><span class="p">(</span><span class="n">ascii</span><span class="p">.</span><span class="n">CreateFileStream</span><span class="p">(</span><span class="s">&quot;myfirst.tr&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>What may not be obvious, though, is that there is a consistent model for all of
the trace-related methods found in the system. We will now take a little time
and take a look at the “big picture”.</p>
<p>There are currently two primary use cases of the tracing helpers in <em>ns-3</em>:
Device helpers and protocol helpers. Device helpers look at the problem of
specifying which traces should be enabled through a node, device pair.  For
example, you may want to specify that pcap tracing should be enabled on a
particular device on a specific node. This follows from the <em>ns-3</em> device
conceptual model, and also the conceptual models of the various device helpers.
Following naturally from this, the files created follow a
&lt;prefix&gt;-&lt;node&gt;-&lt;device&gt; naming convention.</p>
<p>Protocol helpers look at the problem of specifying which traces should be
enabled through a protocol and interface pair. This follows from the <em>ns-3</em>
protocol stack conceptual model, and also the conceptual models of internet
stack helpers. Naturally, the trace files should follow a
&lt;prefix&gt;-&lt;protocol&gt;-&lt;interface&gt; naming convention.</p>
<p>The trace helpers therefore fall naturally into a two-dimensional taxonomy.
There are subtleties that prevent all four classes from behaving identically,
but we do strive to make them all work as similarly as possible; and whenever
possible there are analogs for all methods in all classes.</p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>pcap</p></th>
<th class="head"><p>ascii</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Device Helper</p></td>
<td><p><img class="math" src="_images/math/eb43d5592546eaaff233c50b390d221dc5c75cd9.png" alt="\checkmark"/></p></td>
<td><p><img class="math" src="_images/math/eb43d5592546eaaff233c50b390d221dc5c75cd9.png" alt="\checkmark"/></p></td>
</tr>
<tr class="row-odd"><td><p>Protocol Helper</p></td>
<td><p><img class="math" src="_images/math/eb43d5592546eaaff233c50b390d221dc5c75cd9.png" alt="\checkmark"/></p></td>
<td><p><img class="math" src="_images/math/eb43d5592546eaaff233c50b390d221dc5c75cd9.png" alt="\checkmark"/></p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>We use an approach called a <code class="docutils literal notranslate"><span class="pre">mixin</span></code> to add tracing functionality to our helper
classes. A <code class="docutils literal notranslate"><span class="pre">mixin</span></code> is a class that provides functionality to that is
inherited by a subclass. Inheriting from a mixin is not considered a form of
specialization but is really a way to collect functionality.</p>
<p>Let’s take a quick look at all four of these cases and their respective
<code class="docutils literal notranslate"><span class="pre">mixins</span></code>.</p>
<section id="pcap-tracing-device-helpers">
<h5><span class="section-number">3.3.4.1. </span>Pcap Tracing Device Helpers<a class="headerlink" href="#pcap-tracing-device-helpers" title="Link to this heading">¶</a></h5>
<p>The goal of these helpers is to make it easy to add a consistent pcap trace
facility to an <em>ns-3</em> device. We want all of the various flavors of pcap tracing
to work the same across all devices, so the methods of these helpers are
inherited by device helpers. Take a look at <code class="docutils literal notranslate"><span class="pre">src/network/helper/trace-helper.h</span></code> if you
want to follow the discussion while looking at real code.</p>
<p>The class <code class="docutils literal notranslate"><span class="pre">PcapHelperForDevice</span></code> is a <code class="docutils literal notranslate"><span class="pre">mixin</span></code> provides the high level
functionality for using pcap tracing in an <em>ns-3</em> device. Every device must
implement a single virtual method inherited from this class.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcapInternal</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">promiscuous</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>The signature of this method reflects the device-centric view of the situation
at this level. All of the public methods inherited from class
<code class="docutils literal notranslate"><span class="pre">PcapUserHelperForDevice</span></code> reduce to calling this single device-dependent
implementation method. For example, the lowest level pcap method,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcap</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">promiscuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">explicitFilename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
</pre></div>
</div>
<p>will call the device implementation of <code class="docutils literal notranslate"><span class="pre">EnablePcapInternal</span></code> directly. All
other public pcap tracing methods build on this implementation to provide
additional user-level functionality. What this means to the user is that all
device helpers in the system will have all of the pcap trace methods available;
and these methods will all work in the same way across devices if the device
implements <code class="docutils literal notranslate"><span class="pre">EnablePcapInternal</span></code> correctly.</p>
<section id="pcap-tracing-device-helper-methods">
<h6><span class="section-number">3.3.4.1.1. </span>Pcap Tracing Device Helper Methods<a class="headerlink" href="#pcap-tracing-device-helper-methods" title="Link to this heading">¶</a></h6>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcap</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd</span><span class="p">,</span>
<span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="n">promiscuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">explicitFilename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcap</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">ndName</span><span class="p">,</span>
<span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="n">promiscuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">explicitFilename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcap</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">NetDeviceContainer</span><span class="w"> </span><span class="n">d</span><span class="p">,</span>
<span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="n">promiscuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcap</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">NodeContainer</span><span class="w"> </span><span class="n">n</span><span class="p">,</span>
<span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="n">promiscuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcap</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nodeid</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">deviceid</span><span class="p">,</span>
<span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="n">promiscuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcapAll</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">promiscuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
</pre></div>
</div>
<p>In each of the methods shown above, there is a default parameter called
<code class="docutils literal notranslate"><span class="pre">promiscuous</span></code> that defaults to false. This parameter indicates that the trace
should not be gathered in promiscuous mode. If you do want your traces to
include all traffic seen by the device (and if the device supports a promiscuous
mode) simply add a true parameter to any of the calls above. For example,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnablePcap</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
</pre></div>
</div>
<p>will enable promiscuous mode captures on the <code class="docutils literal notranslate"><span class="pre">NetDevice</span></code> specified by <code class="docutils literal notranslate"><span class="pre">nd</span></code>.</p>
<p>The first two methods also include a default parameter called
<code class="docutils literal notranslate"><span class="pre">explicitFilename</span></code> that will be discussed below.</p>
<p>You are encouraged to peruse the Doxygen for class <code class="docutils literal notranslate"><span class="pre">PcapHelperForDevice</span></code> to
find the details of these methods; but to summarize …</p>
<p>You can enable pcap tracing on a particular node/net-device pair by providing a
<code class="docutils literal notranslate"><span class="pre">Ptr&lt;NetDevice&gt;</span></code> to an <code class="docutils literal notranslate"><span class="pre">EnablePcap</span></code> method. The <code class="docutils literal notranslate"><span class="pre">Ptr&lt;Node&gt;</span></code> is implicit
since the net device must belong to exactly one <code class="docutils literal notranslate"><span class="pre">Node</span></code>. For example,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnablePcap</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="p">);</span>
</pre></div>
</div>
<p>You can enable pcap tracing on a particular node/net-device pair by providing a
<code class="docutils literal notranslate"><span class="pre">std::string</span></code> representing an object name service string to an <code class="docutils literal notranslate"><span class="pre">EnablePcap</span></code>
method.  The <code class="docutils literal notranslate"><span class="pre">Ptr&lt;NetDevice&gt;</span></code> is looked up from the name string.  Again, the
<code class="docutils literal notranslate"><span class="pre">&lt;Node&gt;</span></code> is implicit since the named net device must belong to exactly one
<code class="docutils literal notranslate"><span class="pre">Node</span></code>.  For example,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;server&quot;</span><span class="w"> </span><span class="p">...);</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;server/eth0&quot;</span><span class="w"> </span><span class="p">...);</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnablePcap</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;server/ath0&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>You can enable pcap tracing on a collection of node/net-device pairs by
providing a <code class="docutils literal notranslate"><span class="pre">NetDeviceContainer</span></code>. For each <code class="docutils literal notranslate"><span class="pre">NetDevice</span></code> in the container the
type is checked.  For each device of the proper type (the same type as is
managed by the device helper), tracing is enabled. Again, the <code class="docutils literal notranslate"><span class="pre">&lt;Node&gt;</span></code> is
implicit since the found net device must belong to exactly one <code class="docutils literal notranslate"><span class="pre">Node</span></code>. For
example,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NetDeviceContainer</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnablePcap</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">);</span>
</pre></div>
</div>
<p>You can enable pcap tracing on a collection of node/net-device pairs by
providing a <code class="docutils literal notranslate"><span class="pre">NodeContainer</span></code>. For each <code class="docutils literal notranslate"><span class="pre">Node</span></code> in the <code class="docutils literal notranslate"><span class="pre">NodeContainer</span></code> its
attached <code class="docutils literal notranslate"><span class="pre">NetDevices</span></code> are iterated.  For each <code class="docutils literal notranslate"><span class="pre">NetDevice</span></code> attached to each
node in the container, the type of that device is checked.  For each device of
the proper type (the same type as is managed by the device helper), tracing is
enabled.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NodeContainer</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnablePcap</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</pre></div>
</div>
<p>You can enable pcap tracing on the basis of node ID and device ID as well as
with explicit <code class="docutils literal notranslate"><span class="pre">Ptr</span></code>. Each <code class="docutils literal notranslate"><span class="pre">Node</span></code> in the system has an integer node ID and
each device connected to a node has an integer device ID.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">helper</span><span class="p">.</span><span class="n">EnablePcap</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>Finally, you can enable pcap tracing for all devices in the system, with the
same type as that managed by the device helper.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">helper</span><span class="p">.</span><span class="n">EnablePcapAll</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="pcap-tracing-device-helper-filename-selection">
<h6><span class="section-number">3.3.4.1.2. </span>Pcap Tracing Device Helper Filename Selection<a class="headerlink" href="#pcap-tracing-device-helper-filename-selection" title="Link to this heading">¶</a></h6>
<p>Implicit in the method descriptions above is the construction of a complete
filename by the implementation method. By convention, pcap traces in the <em>ns-3</em>
system are of the form <code class="docutils literal notranslate"><span class="pre">&lt;prefix&gt;-&lt;node</span> <span class="pre">id&gt;-&lt;device</span> <span class="pre">id&gt;.pcap</span></code></p>
<p>As previously mentioned, every node in the system will have a system-assigned
node id; and every device will have an interface index (also called a device id)
relative to its node. By default, then, a pcap trace file created as a result
of enabling tracing on the first device of node 21 using the prefix “prefix”
would be <code class="docutils literal notranslate"><span class="pre">prefix-21-1.pcap</span></code>.</p>
<p>You can always use the <em>ns-3</em> object name service to make this more clear.  For
example, if you use the object name service to assign the name “server” to node
21, the resulting pcap trace file name will automatically become,
<code class="docutils literal notranslate"><span class="pre">prefix-server-1.pcap</span></code> and if you also assign the name “eth0” to the device,
your pcap file name will automatically pick this up and be called
<code class="docutils literal notranslate"><span class="pre">prefix-server-eth0.pcap</span></code>.</p>
<p>Finally, two of the methods shown above,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcap</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">promiscuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">explicitFilename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcap</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">ndName</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">promiscuous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">explicitFilename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
</pre></div>
</div>
<p>have a default parameter called <code class="docutils literal notranslate"><span class="pre">explicitFilename</span></code>. When set to true, this
parameter disables the automatic filename completion mechanism and allows you to
create an explicit filename. This option is only available in the methods which
enable pcap tracing on a single device.</p>
<p>For example, in order to arrange for a device helper to create a single
promiscuous pcap capture file of a specific name (<code class="docutils literal notranslate"><span class="pre">my-pcap-file.pcap</span></code>) on a
given device, one could:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnablePcap</span><span class="p">(</span><span class="s">&quot;my-pcap-file.pcap&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
</pre></div>
</div>
<p>The first <code class="docutils literal notranslate"><span class="pre">true</span></code> parameter enables promiscuous mode traces and the second
tells the helper to interpret the <code class="docutils literal notranslate"><span class="pre">prefix</span></code> parameter as a complete filename.</p>
</section>
</section>
<section id="ascii-tracing-device-helpers">
<h5><span class="section-number">3.3.4.2. </span>Ascii Tracing Device Helpers<a class="headerlink" href="#ascii-tracing-device-helpers" title="Link to this heading">¶</a></h5>
<p>The behavior of the ASCII trace helper <code class="docutils literal notranslate"><span class="pre">mixin</span></code> is substantially similar to
the pcap version. Take a look at <code class="docutils literal notranslate"><span class="pre">src/network/helper/trace-helper.h</span></code> if you want to
follow the discussion while looking at real code.</p>
<p>The class <code class="docutils literal notranslate"><span class="pre">AsciiTraceHelperForDevice</span></code> adds the high level functionality for
using ASCII tracing to a device helper class. As in the pcap case, every device
must implement a single virtual method inherited from the ASCII trace
<code class="docutils literal notranslate"><span class="pre">mixin</span></code>.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiInternal</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>The signature of this method reflects the device-centric view of the situation
at this level; and also the fact that the helper may be writing to a shared
output stream. All of the public ASCII-trace-related methods inherited from
class <code class="docutils literal notranslate"><span class="pre">AsciiTraceHelperForDevice</span></code> reduce to calling this single device-
dependent implementation method. For example, the lowest level ASCII trace
methods,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">EnableAscii</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAscii</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd</span><span class="p">);</span>
</pre></div>
</div>
<p>will call the device implementation of <code class="docutils literal notranslate"><span class="pre">EnableAsciiInternal</span></code> directly,
providing either a valid prefix or stream.  All other public ASCII tracing
methods will build on these low-level functions to provide additional user-level
functionality. What this means to the user is that all device helpers in the
system will have all of the ASCII trace methods available; and these methods
will all work in the same way across devices if the devices implement
<code class="docutils literal notranslate"><span class="pre">EnablAsciiInternal</span></code> correctly.</p>
<section id="ascii-tracing-device-helper-methods">
<h6><span class="section-number">3.3.4.2.1. </span>Ascii Tracing Device Helper Methods<a class="headerlink" href="#ascii-tracing-device-helper-methods" title="Link to this heading">¶</a></h6>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">EnableAscii</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAscii</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAscii</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">ndName</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAscii</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">ndName</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAscii</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">NetDeviceContainer</span><span class="w"> </span><span class="n">d</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAscii</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">NetDeviceContainer</span><span class="w"> </span><span class="n">d</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAscii</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">NodeContainer</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAscii</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">NodeContainer</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAscii</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nodeid</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">deviceid</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAscii</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nodeid</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">deviceid</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiAll</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiAll</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">);</span>
</pre></div>
</div>
<p>You are encouraged to peruse the Doxygen for class <code class="docutils literal notranslate"><span class="pre">TraceHelperForDevice</span></code> to
find the details of these methods; but to summarize …</p>
<p>There are twice as many methods available for ASCII tracing as there were for
pcap tracing. This is because, in addition to the pcap-style model where traces
from each unique node/device pair are written to a unique file, we support a
model in which trace information for many node/device pairs is written to a
common file.  This means that the &lt;prefix&gt;-&lt;node&gt;-&lt;device&gt; file name generation
mechanism is replaced by a mechanism to refer to a common file; and the number
of API methods is doubled to allow all combinations.</p>
<p>Just as in pcap tracing, you can enable ASCII tracing on a particular
node/net-device pair by providing a <code class="docutils literal notranslate"><span class="pre">Ptr&lt;NetDevice&gt;</span></code> to an <code class="docutils literal notranslate"><span class="pre">EnableAscii</span></code>
method. The <code class="docutils literal notranslate"><span class="pre">Ptr&lt;Node&gt;</span></code> is implicit since the net device must belong to
exactly one <code class="docutils literal notranslate"><span class="pre">Node</span></code>. For example,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAscii</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nd</span><span class="p">);</span>
</pre></div>
</div>
<p>In this case, no trace contexts are written to the ASCII trace file since they
would be redundant. The system will pick the file name to be created using the
same rules as described in the pcap section, except that the file will have the
suffix “.tr” instead of “.pcap”.</p>
<p>If you want to enable ASCII tracing on more than one net device and have all
traces sent to a single file, you can do that as well by using an object to
refer to a single file:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd1</span><span class="p">;</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd2</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asciiTraceHelper</span><span class="p">.</span><span class="n">CreateFileStream</span><span class="p">(</span><span class="s">&quot;trace-file-name.tr&quot;</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAscii</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">nd1</span><span class="p">);</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAscii</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">nd2</span><span class="p">);</span>
</pre></div>
</div>
<p>In this case, trace contexts are written to the ASCII trace file since they
are required to disambiguate traces from the two devices.  Note that since the
user is completely specifying the file name, the string should include the “.tr”
for consistency.</p>
<p>You can enable ASCII tracing on a particular node/net-device pair by providing a
<code class="docutils literal notranslate"><span class="pre">std::string</span></code> representing an object name service string to an
<code class="docutils literal notranslate"><span class="pre">EnablePcap</span></code> method.  The <code class="docutils literal notranslate"><span class="pre">Ptr&lt;NetDevice&gt;</span></code> is looked up from the name
string.  Again, the <code class="docutils literal notranslate"><span class="pre">&lt;Node&gt;</span></code> is implicit since the named net device must
belong to exactly one <code class="docutils literal notranslate"><span class="pre">Node</span></code>.  For example,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;client&quot;</span><span class="w"> </span><span class="p">...);</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;client/eth0&quot;</span><span class="w"> </span><span class="p">...);</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;server&quot;</span><span class="w"> </span><span class="p">...);</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;server/eth0&quot;</span><span class="w"> </span><span class="p">...);</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAscii</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;client/eth0&quot;</span><span class="p">);</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAscii</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;server/eth0&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>This would result in two files named <code class="docutils literal notranslate"><span class="pre">prefix-client-eth0.tr</span></code> and
<code class="docutils literal notranslate"><span class="pre">prefix-server-eth0.tr</span></code> with traces for each device in the respective trace
file. Since all of the EnableAscii functions are overloaded to take a stream
wrapper, you can use that form as well:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;client&quot;</span><span class="w"> </span><span class="p">...);</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;client/eth0&quot;</span><span class="w"> </span><span class="p">...);</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;server&quot;</span><span class="w"> </span><span class="p">...);</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;server/eth0&quot;</span><span class="w"> </span><span class="p">...);</span>
<span class="p">...</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asciiTraceHelper</span><span class="p">.</span><span class="n">CreateFileStream</span><span class="p">(</span><span class="s">&quot;trace-file-name.tr&quot;</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAscii</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;client/eth0&quot;</span><span class="p">);</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAscii</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;server/eth0&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>This would result in a single trace file called <code class="docutils literal notranslate"><span class="pre">trace-file-name.tr</span></code> that
contains all of the trace events for both devices. The events would be
disambiguated by trace context strings.</p>
<p>You can enable ASCII tracing on a collection of node/net-device pairs by
providing a <code class="docutils literal notranslate"><span class="pre">NetDeviceContainer</span></code>. For each <code class="docutils literal notranslate"><span class="pre">NetDevice</span></code> in the container the
type is checked. For each device of the proper type (the same type as is managed
by the device helper), tracing is enabled. Again, the <code class="docutils literal notranslate"><span class="pre">&lt;Node&gt;</span></code> is implicit
since the found net device must belong to exactly one <code class="docutils literal notranslate"><span class="pre">Node</span></code>.  For example,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NetDeviceContainer</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAscii</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">);</span>
</pre></div>
</div>
<p>This would result in a number of ASCII trace files being created, each of which
follows the &lt;prefix&gt;-&lt;node id&gt;-&lt;device id&gt;.tr convention. Combining all of the
traces into a single file is accomplished similarly to the examples above:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NetDeviceContainer</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span>
<span class="p">...</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asciiTraceHelper</span><span class="p">.</span><span class="n">CreateFileStream</span><span class="p">(</span><span class="s">&quot;trace-file-name.tr&quot;</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAscii</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">);</span>
</pre></div>
</div>
<p>You can enable ascii tracing on a collection of node/net-device pairs by
providing a <code class="docutils literal notranslate"><span class="pre">NodeContainer</span></code>. For each <code class="docutils literal notranslate"><span class="pre">Node</span></code> in the <code class="docutils literal notranslate"><span class="pre">NodeContainer</span></code> its
attached <code class="docutils literal notranslate"><span class="pre">NetDevices</span></code> are iterated.  For each <code class="docutils literal notranslate"><span class="pre">NetDevice</span></code> attached to each
node in the container, the type of that device is checked.  For each device of
the proper type (the same type as is managed by the device helper), tracing is
enabled.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NodeContainer</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAscii</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</pre></div>
</div>
<p>This would result in a number of ASCII trace files being created, each of which
follows the &lt;prefix&gt;-&lt;node id&gt;-&lt;device id&gt;.tr convention. Combining all of the
traces into a single file is accomplished similarly to the examples above:</p>
<p>You can enable pcap tracing on the basis of node ID and device ID as well as
with explicit <code class="docutils literal notranslate"><span class="pre">Ptr</span></code>. Each <code class="docutils literal notranslate"><span class="pre">Node</span></code> in the system has an integer node ID and
each device connected to a node has an integer device ID.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">helper</span><span class="p">.</span><span class="n">EnableAscii</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>Of course, the traces can be combined into a single file as shown above.</p>
<p>Finally, you can enable pcap tracing for all devices in the system, with the
same type as that managed by the device helper.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">helper</span><span class="p">.</span><span class="n">EnableAsciiAll</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>This would result in a number of ASCII trace files being created, one for
every device in the system of the type managed by the helper. All of these
files will follow the &lt;prefix&gt;-&lt;node id&gt;-&lt;device id&gt;.tr convention. Combining
all of the traces into a single file is accomplished similarly to the examples
above.</p>
</section>
<section id="ascii-tracing-device-helper-filename-selection">
<h6><span class="section-number">3.3.4.2.2. </span>Ascii Tracing Device Helper Filename Selection<a class="headerlink" href="#ascii-tracing-device-helper-filename-selection" title="Link to this heading">¶</a></h6>
<p>Implicit in the prefix-style method descriptions above is the construction of
the complete filenames by the implementation method. By convention, ASCII traces
in the <em>ns-3</em> system are of the form <code class="docutils literal notranslate"><span class="pre">&lt;prefix&gt;-&lt;node</span> <span class="pre">id&gt;-&lt;device</span> <span class="pre">id&gt;.tr</span></code>.</p>
<p>As previously mentioned, every node in the system will have a system-assigned
node id; and every device will have an interface index (also called a device id)
relative to its node.  By default, then, an ASCII trace file created as a result
of enabling tracing on the first device of node 21, using the prefix “prefix”,
would be <code class="docutils literal notranslate"><span class="pre">prefix-21-1.tr</span></code>.</p>
<p>You can always use the <em>ns-3</em> object name service to make this more clear.  For
example, if you use the object name service to assign the name “server” to node
21, the resulting ASCII trace file name will automatically become,
<code class="docutils literal notranslate"><span class="pre">prefix-server-1.tr</span></code> and if you also assign the name “eth0” to the device,
your ASCII trace file name will automatically pick this up and be called
<code class="docutils literal notranslate"><span class="pre">prefix-server-eth0.tr</span></code>.</p>
</section>
</section>
<section id="pcap-tracing-protocol-helpers">
<h5><span class="section-number">3.3.4.3. </span>Pcap Tracing Protocol Helpers<a class="headerlink" href="#pcap-tracing-protocol-helpers" title="Link to this heading">¶</a></h5>
<p>The goal of these <code class="docutils literal notranslate"><span class="pre">mixins</span></code> is to make it easy to add a consistent pcap trace
facility to protocols. We want all of the various flavors of pcap tracing to
work the same across all protocols, so the methods of these helpers are
inherited by stack helpers. Take a look at <code class="docutils literal notranslate"><span class="pre">src/network/helper/trace-helper.h</span></code> if you
want to follow the discussion while looking at real code.</p>
<p>In this section we will be illustrating the methods as applied to the protocol
<code class="docutils literal notranslate"><span class="pre">Ipv4</span></code>.  To specify traces in similar protocols, just substitute the
appropriate type.  For example, use a <code class="docutils literal notranslate"><span class="pre">Ptr&lt;Ipv6&gt;</span></code> instead of a <code class="docutils literal notranslate"><span class="pre">Ptr&lt;Ipv4&gt;</span></code>
and call <code class="docutils literal notranslate"><span class="pre">EnablePcapIpv6</span></code> instead of <code class="docutils literal notranslate"><span class="pre">EnablePcapIpv4</span></code>.</p>
<p>The class <code class="docutils literal notranslate"><span class="pre">PcapHelperForIpv4</span></code> provides the high level functionality for using
pcap tracing in the <code class="docutils literal notranslate"><span class="pre">Ipv4</span></code> protocol.  Each protocol helper enabling these
methods must implement a single virtual method inherited from this class.  There
will be a separate implementation for <code class="docutils literal notranslate"><span class="pre">Ipv6</span></code>, for example, but the only
difference will be in the method names and signatures.  Different method names
are required to disambiguate class <code class="docutils literal notranslate"><span class="pre">Ipv4</span></code> from <code class="docutils literal notranslate"><span class="pre">Ipv6</span></code> which are both derived
from class <code class="docutils literal notranslate"><span class="pre">Object</span></code>, and methods that share the same signature.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcapIpv4Internal</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interface</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>The signature of this method reflects the protocol and interface-centric view of
the situation at this level. All of the public methods inherited from class
<code class="docutils literal notranslate"><span class="pre">PcapHelperForIpv4</span></code> reduce to calling this single device-dependent
implementation method.  For example, the lowest level pcap method,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcapIpv4</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interface</span><span class="p">);</span>
</pre></div>
</div>
<p>will call the device implementation of <code class="docutils literal notranslate"><span class="pre">EnablePcapIpv4Internal</span></code> directly.  All
other public pcap tracing methods build on this implementation to provide
additional user-level functionality. What this means to the user is that all
protocol helpers in the system will have all of the pcap trace methods
available; and these methods will all work in the same way across protocols if
the helper implements <code class="docutils literal notranslate"><span class="pre">EnablePcapIpv4Internal</span></code> correctly.</p>
<section id="pcap-tracing-protocol-helper-methods">
<h6><span class="section-number">3.3.4.3.1. </span>Pcap Tracing Protocol Helper Methods<a class="headerlink" href="#pcap-tracing-protocol-helper-methods" title="Link to this heading">¶</a></h6>
<p>These methods are designed to be in one-to-one correspondence with the <code class="docutils literal notranslate"><span class="pre">Node</span></code>-
and <code class="docutils literal notranslate"><span class="pre">NetDevice</span></code>- centric versions of the device versions. Instead of
<code class="docutils literal notranslate"><span class="pre">Node</span></code> and <code class="docutils literal notranslate"><span class="pre">NetDevice</span></code> pair constraints, we use protocol and interface
constraints.</p>
<p>Note that just like in the device version, there are six methods:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcapIpv4</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interface</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcapIpv4</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">ipv4Name</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interface</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcapIpv4</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">Ipv4InterfaceContainer</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcapIpv4</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">NodeContainer</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcapIpv4</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nodeid</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interface</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnablePcapIpv4All</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">);</span>
</pre></div>
</div>
<p>You are encouraged to peruse the Doxygen for class <code class="docutils literal notranslate"><span class="pre">PcapHelperForIpv4</span></code> to find
the details of these methods; but to summarize …</p>
<p>You can enable pcap tracing on a particular protocol/interface pair by providing
a <code class="docutils literal notranslate"><span class="pre">Ptr&lt;Ipv4&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">interface</span></code> to an <code class="docutils literal notranslate"><span class="pre">EnablePcap</span></code> method.  For example,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnablePcapIpv4</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ipv4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p>You can enable pcap tracing on a particular node/net-device pair by providing a
<code class="docutils literal notranslate"><span class="pre">std::string</span></code> representing an object name service string to an <code class="docutils literal notranslate"><span class="pre">EnablePcap</span></code>
method.  The <code class="docutils literal notranslate"><span class="pre">Ptr&lt;Ipv4&gt;</span></code> is looked up from the name string.  For example,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;serverIPv4&quot;</span><span class="w"> </span><span class="p">...);</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnablePcapIpv4</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;serverIpv4&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>You can enable pcap tracing on a collection of protocol/interface pairs by
providing an <code class="docutils literal notranslate"><span class="pre">Ipv4InterfaceContainer</span></code>. For each <code class="docutils literal notranslate"><span class="pre">Ipv4</span></code> / interface pair in
the container the protocol type is checked. For each protocol of the proper type
(the same type as is managed by the device helper), tracing is enabled for the
corresponding interface.  For example,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NodeContainer</span><span class="w"> </span><span class="n">nodes</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">NetDeviceContainer</span><span class="w"> </span><span class="n">devices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deviceHelper</span><span class="p">.</span><span class="n">Install</span><span class="p">(</span><span class="n">nodes</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">Ipv4AddressHelper</span><span class="w"> </span><span class="n">ipv4</span><span class="p">;</span>
<span class="n">ipv4</span><span class="p">.</span><span class="n">SetBase</span><span class="p">(</span><span class="s">&quot;10.1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;255.255.255.0&quot;</span><span class="p">);</span>
<span class="n">Ipv4InterfaceContainer</span><span class="w"> </span><span class="n">interfaces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ipv4</span><span class="p">.</span><span class="n">Assign</span><span class="p">(</span><span class="n">devices</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnablePcapIpv4</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">interfaces</span><span class="p">);</span>
</pre></div>
</div>
<p>You can enable pcap tracing on a collection of protocol/interface pairs by
providing a <code class="docutils literal notranslate"><span class="pre">NodeContainer</span></code>. For each <code class="docutils literal notranslate"><span class="pre">Node</span></code> in the <code class="docutils literal notranslate"><span class="pre">NodeContainer</span></code> the
appropriate protocol is found. For each protocol, its interfaces are enumerated
and tracing is enabled on the resulting pairs. For example,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NodeContainer</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnablePcapIpv4</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</pre></div>
</div>
<p>You can enable pcap tracing on the basis of node ID and interface as well. In
this case, the node-id is translated to a <code class="docutils literal notranslate"><span class="pre">Ptr&lt;Node&gt;</span></code> and the appropriate
protocol is looked up in the node. The resulting protocol and interface are used
to specify the resulting trace source.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">helper</span><span class="p">.</span><span class="n">EnablePcapIpv4</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>Finally, you can enable pcap tracing for all interfaces in the system, with
associated protocol being the same type as that managed by the device helper.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">helper</span><span class="p">.</span><span class="n">EnablePcapIpv4All</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="pcap-tracing-protocol-helper-filename-selection">
<h6><span class="section-number">3.3.4.3.2. </span>Pcap Tracing Protocol Helper Filename Selection<a class="headerlink" href="#pcap-tracing-protocol-helper-filename-selection" title="Link to this heading">¶</a></h6>
<p>Implicit in all of the method descriptions above is the construction of the
complete filenames by the implementation method. By convention, pcap traces
taken for devices in the <em>ns-3</em> system are of the form <code class="docutils literal notranslate"><span class="pre">&lt;prefix&gt;-&lt;node</span>
<span class="pre">id&gt;-&lt;device</span> <span class="pre">id&gt;.pcap</span></code>. In the case of protocol traces, there is a one-to-one
correspondence between protocols and <code class="docutils literal notranslate"><span class="pre">Nodes</span></code>. This is because protocol
<code class="docutils literal notranslate"><span class="pre">Objects</span></code> are aggregated to <code class="docutils literal notranslate"><span class="pre">Node</span> <span class="pre">Objects</span></code>. Since there is no global
protocol id in the system, we use the corresponding node id in file naming.
Therefore there is a possibility for file name collisions in automatically
chosen trace file names. For this reason, the file name convention is changed
for protocol traces.</p>
<p>As previously mentioned, every node in the system will have a system-assigned
node id. Since there is a one-to-one correspondence between protocol instances
and node instances we use the node id. Each interface has an interface id
relative to its protocol. We use the convention “&lt;prefix&gt;-n&lt;node id&gt;-i&lt;interface
id&gt;.pcap” for trace file naming in protocol helpers.</p>
<p>Therefore, by default, a pcap trace file created as a result of enabling tracing
on interface 1 of the Ipv4 protocol of node 21 using the prefix “prefix”
would be “prefix-n21-i1.pcap”.</p>
<p>You can always use the <em>ns-3</em> object name service to make this more clear.
For example, if you use the object name service to assign the name “serverIpv4”
to the Ptr&lt;Ipv4&gt; on node 21, the resulting pcap trace file name will
automatically become, “prefix-nserverIpv4-i1.pcap”.</p>
</section>
</section>
<section id="ascii-tracing-protocol-helpers">
<h5><span class="section-number">3.3.4.4. </span>Ascii Tracing Protocol Helpers<a class="headerlink" href="#ascii-tracing-protocol-helpers" title="Link to this heading">¶</a></h5>
<p>The behavior of the ASCII trace helpers is substantially similar to the pcap
case.  Take a look at <code class="docutils literal notranslate"><span class="pre">src/network/helper/trace-helper.h</span></code> if you want to follow the
discussion while looking at real code.</p>
<p>In this section we will be illustrating the methods as applied to the protocol
<code class="docutils literal notranslate"><span class="pre">Ipv4</span></code>. To specify traces in similar protocols, just substitute the
appropriate type. For example, use a <code class="docutils literal notranslate"><span class="pre">Ptr&lt;Ipv6&gt;</span></code> instead of a <code class="docutils literal notranslate"><span class="pre">Ptr&lt;Ipv4&gt;</span></code>
and call <code class="docutils literal notranslate"><span class="pre">EnableAsciiIpv6</span></code> instead of <code class="docutils literal notranslate"><span class="pre">EnableAsciiIpv4</span></code>.</p>
<p>The class <code class="docutils literal notranslate"><span class="pre">AsciiTraceHelperForIpv4</span></code> adds the high level functionality for
using ASCII tracing to a protocol helper. Each protocol that enables these
methods must implement a single virtual method inherited from this class.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiIpv4Internal</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interface</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>The signature of this method reflects the protocol- and interface-centric view
of the situation at this level; and also the fact that the helper may be writing
to a shared output stream.  All of the public methods inherited from class
<code class="docutils literal notranslate"><span class="pre">PcapAndAsciiTraceHelperForIpv4</span></code> reduce to calling this single device-
dependent implementation method. For example, the lowest level ascii trace
methods,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiIpv4</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interface</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiIpv4</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interface</span><span class="p">);</span>
</pre></div>
</div>
<p>will call the device implementation of <code class="docutils literal notranslate"><span class="pre">EnableAsciiIpv4Internal</span></code> directly,
providing either the prefix or the stream. All other public ascii tracing
methods will build on these low-level functions to provide additional user-level
functionality. What this means to the user is that all device helpers in the
system will have all of the ascii trace methods available; and these methods
will all work in the same way across protocols if the protocols implement
<code class="docutils literal notranslate"><span class="pre">EnablAsciiIpv4Internal</span></code> correctly.</p>
<section id="id1">
<h6><span class="section-number">3.3.4.4.1. </span>Ascii Tracing Device Helper Methods<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h6>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiIpv4</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interface</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiIpv4</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interface</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiIpv4</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">ipv4Name</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interface</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiIpv4</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">ipv4Name</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interface</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiIpv4</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">Ipv4InterfaceContainer</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiIpv4</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">Ipv4InterfaceContainer</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiIpv4</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="n">NodeContainer</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiIpv4</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">NodeContainer</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiIpv4</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nodeid</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">deviceid</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiIpv4</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nodeid</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interface</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiIpv4All</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">prefix</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">EnableAsciiIpv4All</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">);</span>
</pre></div>
</div>
<p>You are encouraged to peruse the Doxygen for class <code class="docutils literal notranslate"><span class="pre">PcapAndAsciiHelperForIpv4</span></code>
to find the details of these methods; but to summarize …</p>
<p>There are twice as many methods available for ASCII tracing as there were for
pcap tracing. This is because, in addition to the pcap-style model where traces
from each unique protocol/interface pair are written to a unique file, we
support a model in which trace information for many protocol/interface pairs is
written to a common file. This means that the &lt;prefix&gt;-n&lt;node id&gt;-&lt;interface&gt;
file name generation mechanism is replaced by a mechanism to refer to a common
file; and the number of API methods is doubled to allow all combinations.</p>
<p>Just as in pcap tracing, you can enable ASCII tracing on a particular
protocol/interface pair by providing a <code class="docutils literal notranslate"><span class="pre">Ptr&lt;Ipv4&gt;</span></code> and an <code class="docutils literal notranslate"><span class="pre">interface</span></code> to an
<code class="docutils literal notranslate"><span class="pre">EnableAscii</span></code> method.  For example,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAsciiIpv4</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ipv4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>In this case, no trace contexts are written to the ASCII trace file since they
would be redundant. The system will pick the file name to be created using the
same rules as described in the pcap section, except that the file will have the
suffix “.tr” instead of “.pcap”.</p>
<p>If you want to enable ASCII tracing on more than one interface and have all
traces sent to a single file, you can do that as well by using an object to
refer to a single file. We have already something similar to this in the “cwnd”
example above:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">protocol1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node1</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">protocol2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node2</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">...</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asciiTraceHelper</span><span class="p">.</span><span class="n">CreateFileStream</span><span class="p">(</span><span class="s">&quot;trace-file-name.tr&quot;</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAsciiIpv4</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">protocol1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAsciiIpv4</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">protocol2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>In this case, trace contexts are written to the ASCII trace file since they are
required to disambiguate traces from the two interfaces. Note that since the
user is completely specifying the file name, the string should include the “.tr”
for consistency.</p>
<p>You can enable ASCII tracing on a particular protocol by providing a
<code class="docutils literal notranslate"><span class="pre">std::string</span></code> representing an object name service string to an <code class="docutils literal notranslate"><span class="pre">EnablePcap</span></code>
method.  The <code class="docutils literal notranslate"><span class="pre">Ptr&lt;Ipv4&gt;</span></code> is looked up from the name string.  The <code class="docutils literal notranslate"><span class="pre">&lt;Node&gt;</span></code> in
the resulting filenames is implicit since there is a one-to-one correspondence
between protocol instances and nodes, For example,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;node1Ipv4&quot;</span><span class="w"> </span><span class="p">...);</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;node2Ipv4&quot;</span><span class="w"> </span><span class="p">...);</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAsciiIpv4</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;node1Ipv4&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAsciiIpv4</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;node2Ipv4&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>This would result in two files named “prefix-nnode1Ipv4-i1.tr” and
“prefix-nnode2Ipv4-i1.tr” with traces for each interface in the respective
trace file. Since all of the EnableAscii functions are overloaded to take a
stream wrapper, you can use that form as well:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;node1Ipv4&quot;</span><span class="w"> </span><span class="p">...);</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;node2Ipv4&quot;</span><span class="w"> </span><span class="p">...);</span>
<span class="p">...</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asciiTraceHelper</span><span class="p">.</span><span class="n">CreateFileStream</span><span class="p">(</span><span class="s">&quot;trace-file-name.tr&quot;</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAsciiIpv4</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;node1Ipv4&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAsciiIpv4</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;node2Ipv4&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>This would result in a single trace file called “trace-file-name.tr” that
contains all of the trace events for both interfaces. The events would be
disambiguated by trace context strings.</p>
<p>You can enable ASCII tracing on a collection of protocol/interface pairs by
providing an <code class="docutils literal notranslate"><span class="pre">Ipv4InterfaceContainer</span></code>. For each protocol of the proper type
(the same type as is managed by the device helper), tracing is enabled for the
corresponding interface.  Again, the <code class="docutils literal notranslate"><span class="pre">&lt;Node&gt;</span></code> is implicit since there is a
one-to-one correspondence between each protocol and its node. For example,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NodeContainer</span><span class="w"> </span><span class="n">nodes</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">NetDeviceContainer</span><span class="w"> </span><span class="n">devices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deviceHelper</span><span class="p">.</span><span class="n">Install</span><span class="p">(</span><span class="n">nodes</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">Ipv4AddressHelper</span><span class="w"> </span><span class="n">ipv4</span><span class="p">;</span>
<span class="n">ipv4</span><span class="p">.</span><span class="n">SetBase</span><span class="p">(</span><span class="s">&quot;10.1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;255.255.255.0&quot;</span><span class="p">);</span>
<span class="n">Ipv4InterfaceContainer</span><span class="w"> </span><span class="n">interfaces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ipv4</span><span class="p">.</span><span class="n">Assign</span><span class="p">(</span><span class="n">devices</span><span class="p">);</span>
<span class="p">...</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAsciiIpv4</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">interfaces</span><span class="p">);</span>
</pre></div>
</div>
<p>This would result in a number of ASCII trace files being created, each of which
follows the &lt;prefix&gt;-n&lt;node id&gt;-i&lt;interface&gt;.tr convention. Combining all of the
traces into a single file is accomplished similarly to the examples above:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NodeContainer</span><span class="w"> </span><span class="n">nodes</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">NetDeviceContainer</span><span class="w"> </span><span class="n">devices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deviceHelper</span><span class="p">.</span><span class="n">Install</span><span class="p">(</span><span class="n">nodes</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">Ipv4AddressHelper</span><span class="w"> </span><span class="n">ipv4</span><span class="p">;</span>
<span class="n">ipv4</span><span class="p">.</span><span class="n">SetBase</span><span class="p">(</span><span class="s">&quot;10.1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;255.255.255.0&quot;</span><span class="p">);</span>
<span class="n">Ipv4InterfaceContainer</span><span class="w"> </span><span class="n">interfaces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ipv4</span><span class="p">.</span><span class="n">Assign</span><span class="p">(</span><span class="n">devices</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">OutputStreamWrapper</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">asciiTraceHelper</span><span class="p">.</span><span class="n">CreateFileStream</span><span class="p">(</span><span class="s">&quot;trace-file-name.tr&quot;</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAsciiIpv4</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span><span class="w"> </span><span class="n">interfaces</span><span class="p">);</span>
</pre></div>
</div>
<p>You can enable ASCII tracing on a collection of protocol/interface pairs by
providing a <code class="docutils literal notranslate"><span class="pre">NodeContainer</span></code>. For each <code class="docutils literal notranslate"><span class="pre">Node</span></code> in the <code class="docutils literal notranslate"><span class="pre">NodeContainer</span></code> the
appropriate protocol is found.  For each protocol, its interfaces are enumerated
and tracing is enabled on the resulting pairs. For example,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NodeContainer</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">helper</span><span class="p">.</span><span class="n">EnableAsciiIpv4</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</pre></div>
</div>
<p>This would result in a number of ASCII trace files being created, each of which
follows the &lt;prefix&gt;-&lt;node id&gt;-&lt;device id&gt;.tr convention. Combining all of the
traces into a single file is accomplished similarly to the examples above:</p>
<p>You can enable pcap tracing on the basis of node ID and device ID as well. In
this case, the node-id is translated to a <code class="docutils literal notranslate"><span class="pre">Ptr&lt;Node&gt;</span></code> and the appropriate
protocol is looked up in the node.  The resulting protocol and interface are
used to specify the resulting trace source.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">helper</span><span class="p">.</span><span class="n">EnableAsciiIpv4</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>Of course, the traces can be combined into a single file as shown above.</p>
<p>Finally, you can enable ASCII tracing for all interfaces in the system, with
associated protocol being the same type as that managed by the device helper.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">helper</span><span class="p">.</span><span class="n">EnableAsciiIpv4All</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>This would result in a number of ASCII trace files being created, one for
every interface in the system related to a protocol of the type managed by the
helper. All of these files will follow the &lt;prefix&gt;-n&lt;node id&gt;-i&lt;interface.tr
convention. Combining all of the traces into a single file is accomplished
similarly to the examples above.</p>
</section>
<section id="id2">
<h6><span class="section-number">3.3.4.4.2. </span>Ascii Tracing Device Helper Filename Selection<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h6>
<p>Implicit in the prefix-style method descriptions above is the construction of
the complete filenames by the implementation method. By convention, ASCII traces
in the <em>ns-3</em> system are of the form “&lt;prefix&gt;-&lt;node id&gt;-&lt;device id&gt;.tr.”</p>
<p>As previously mentioned, every node in the system will have a system-assigned
node id. Since there is a one-to-one correspondence between protocols and nodes
we use to node-id to identify the protocol identity. Every interface on a given
protocol will have an interface index (also called simply an interface) relative
to its protocol. By default, then, an ASCII trace file created as a result of
enabling tracing on the first device of node 21, using the prefix “prefix”,
would be “prefix-n21-i1.tr”. Use the prefix to disambiguate multiple protocols
per node.</p>
<p>You can always use the <em>ns-3</em> object name service to make this more clear.
For example, if you use the object name service to assign the name “serverIpv4”
to the protocol on node 21, and also specify interface one, the resulting ASCII
trace file name will automatically become, “prefix-nserverIpv4-1.tr”.</p>
</section>
</section>
</section>
<section id="tracing-implementation-details">
<h4><span class="section-number">3.3.5. </span>Tracing implementation details<a class="headerlink" href="#tracing-implementation-details" title="Link to this heading">¶</a></h4>
</section>
</section>
<span id="document-data-collection"></span><section id="data-collection">
<h3><span class="section-number">3.4. </span>Data Collection<a class="headerlink" href="#data-collection" title="Link to this heading">¶</a></h3>
<p>This chapter describes the ns-3 Data Collection Framework (DCF), which
provides capabilities to obtain data generated by models in the simulator,
to perform on-line reduction and data processing, and to marshal raw
or transformed data into various output formats.</p>
<p>The framework presently supports standalone ns-3 runs that don’t rely on
any external program execution control.  The objects provided by the
DCF may be hooked to <em>ns-3</em> trace sources to enable data processing.</p>
<p>The source code for the classes lives in the directory <code class="docutils literal notranslate"><span class="pre">src/stats</span></code>.</p>
<p>This chapter is organized as follows.  First, an overview of the architecture
is presented.  Next, the helpers for these classes are presented; this
initial treatment should allow basic use of the data collection framework
for many use cases.  Users who wish to produce output outside of the
scope of the current helpers, or who wish to create their own data
collection objects, should read the remainder of the chapter, which
goes into detail about all of the basic DCF object types and provides
low-level coding examples.</p>
<div class="toctree-wrapper compound">
<span id="document-data-collection-overview"></span><section id="design">
<h4><span class="section-number">3.4.1. </span>Design<a class="headerlink" href="#design" title="Link to this heading">¶</a></h4>
<p>The DCF consists of three basic classes:</p>
<ul class="simple">
<li><p><em>Probe</em> is a mechanism to instrument and control the output of
simulation data that is used to monitor interesting events. It
produces output in the form of one or more <em>ns-3</em> trace sources.
Probe objects are hooked up to one or more trace <em>sinks</em> (called
<em>Collectors</em>), which process samples on-line and prepare them for
output.</p></li>
<li><p><em>Collector</em> consumes the data generated by one or more Probe objects.
It performs transformations on the data, such as normalization, reduction, and
the computation of basic statistics. Collector objects do not produce
data that is directly output by the ns-3 run; instead, they output data
downstream to another type of object, called <em>Aggregator</em>, which performs
that function.  Typically, Collectors output their data in the form of
trace sources as well, allowing collectors to be chained in series.</p></li>
<li><p><em>Aggregator</em> is the end point of the data collected by a network of Probes and Collectors.
The main responsibility of the Aggregator is to marshal data and their
corresponding metadata, into different output
formats such as plain text files, spreadsheet files, or databases.</p></li>
</ul>
<p>All three of these classes provide the capability to dynamically turn themselves on or off throughout a simulation.</p>
<p>Any standalone <em>ns-3</em> simulation run that uses the DCF will typically create
at least one instance of each of the three classes above.</p>
<figure class="align-default" id="id1">
<span id="dcf-overview"></span><img alt="_images/dcf-overview.png" src="_images/dcf-overview.png" />
<figcaption>
<p><span class="caption-text">Data Collection Framework overview</span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>The overall flow of data processing is depicted in <a class="reference internal" href="#dcf-overview"><span class="std std-ref">Data Collection Framework overview</span></a>.  On
the left side, a running <em>ns-3</em> simulation is depicted.  In the course
of running the simulation, data is made available by models through
trace sources, or via other means.  The diagram depicts that probes
can be connected to these trace sources to receive data asynchronously,
or probes can poll for data.  Data is then passed to a collector object
that transforms the data.  Finally, an aggregator can be connected
to the outputs of the collector, to generate plots, files, or databases.</p>
<figure class="align-default" id="id2">
<span id="dcf-overview-with-aggregation"></span><img alt="_images/dcf-overview-with-aggregation.png" src="_images/dcf-overview-with-aggregation.png" />
<figcaption>
<p><span class="caption-text">Data Collection Framework aggregation</span><a class="headerlink" href="#id2" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>A variation on the above figure is provided
in <a class="reference internal" href="#dcf-overview-with-aggregation"><span class="std std-ref">Data Collection Framework aggregation</span></a>.
This second figure illustrates that the DCF objects may be chained
together in a manner that downstream objects take inputs from multiple
upstream objects.  The figure conceptually shows that multiple probes
may generate output that is fed into a single collector; as an example,
a collector that outputs a ratio of two counters would typically acquire
each counter data from separate probes.  Multiple collectors can also
feed into a single aggregator, which (as its name implies) may collect
a number of data streams for inclusion into a single plot, file, or
database.</p>
</section>
<span id="document-data-collection-helpers"></span><section id="data-collection-helpers">
<h4><span class="section-number">3.4.2. </span>Data Collection Helpers<a class="headerlink" href="#data-collection-helpers" title="Link to this heading">¶</a></h4>
<p>The full flexibility of the data collection framework is provided by
the interconnection of probes, collectors, and aggregators.  Performing
all of these interconnections leads to many configuration statements
in user programs.  For ease of use, some of the most common operations
can be combined and encapsulated in helper functions.  In addition,
some statements involving <em>ns-3</em> trace sources do not have Python
bindings, due to limitations in the bindings.</p>
<section id="data-collection-helpers-overview">
<h5><span class="section-number">3.4.2.1. </span>Data Collection Helpers Overview<a class="headerlink" href="#data-collection-helpers-overview" title="Link to this heading">¶</a></h5>
<p>In this section, we provide an overview of some helper classes that
have been created to ease the configuration of the data collection
framework for some common use cases.  The helpers allow users to form
common operations with only a few statements in their C++ or Python
programs.  But, this ease of use comes at the cost of significantly
less flexibility than low-level configuration can provide, and the
need to explicitly code support for new Probe types into the helpers
(to work around an issue described below).</p>
<p>The emphasis on the current helpers is to marshal data out of <em>ns-3</em>
trace sources into gnuplot plots or text files, without a high degree
of output customization or statistical processing (initially).  Also,
the use is constrained to the available probe types in <em>ns-3</em>.  Later
sections of this documentation will go into more detail about creating
new Probe types, as well as details about hooking together Probes,
Collectors, and Aggregators in custom arrangements.</p>
<p>To date, two Data Collection helpers have been implemented:</p>
<ul class="simple">
<li><p>GnuplotHelper</p></li>
<li><p>FileHelper</p></li>
</ul>
</section>
<section id="gnuplothelper">
<h5><span class="section-number">3.4.2.2. </span>GnuplotHelper<a class="headerlink" href="#gnuplothelper" title="Link to this heading">¶</a></h5>
<p>The GnuplotHelper is a helper class for producing output files used to
make gnuplots.  The overall goal is to provide the ability for users
to quickly make plots from data exported in <em>ns-3</em> trace sources.  By
default, a minimal amount of data transformation is performed; the
objective is to generate plots with as few (default) configuration
statements as possible.</p>
<section id="gnuplothelper-overview">
<h6><span class="section-number">3.4.2.2.1. </span>GnuplotHelper Overview<a class="headerlink" href="#gnuplothelper-overview" title="Link to this heading">¶</a></h6>
<p>The GnuplotHelper will create 3 different files at the end of the
simulation:</p>
<ul class="simple">
<li><p>A space separated gnuplot data file</p></li>
<li><p>A gnuplot control file</p></li>
<li><p>A shell script to generate the gnuplot</p></li>
</ul>
<p>There are two configuration statements that are needed to produce plots.
The first statement configures the plot (filename, title, legends, and
output type, where the output type defaults to PNG if unspecified):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">ConfigurePlot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">outputFileNameWithoutExtension</span><span class="p">,</span>
<span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">title</span><span class="p">,</span>
<span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">xLegend</span><span class="p">,</span>
<span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">yLegend</span><span class="p">,</span>
<span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">terminalType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;.png&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>The second statement hooks the trace source of interest:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">PlotProbe</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">typeId</span><span class="p">,</span>
<span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">path</span><span class="p">,</span>
<span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">probeTraceSource</span><span class="p">,</span>
<span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">title</span><span class="p">);</span>
</pre></div>
</div>
<p>The arguments are as follows:</p>
<ul class="simple">
<li><p>typeId:  The <em>ns-3</em> TypeId of the Probe</p></li>
<li><p>path:  The path in the <em>ns-3</em> configuration namespace to one or more trace sources</p></li>
<li><p>probeTraceSource:  Which output of the probe (itself a trace source) should be plotted</p></li>
<li><p>title:  The title to associate with the dataset(s) (in the gnuplot legend)</p></li>
</ul>
<p>A variant on the PlotProbe above is to specify a fifth optional argument
that controls where in the plot the key (legend) is placed.</p>
<p>A fully worked example (from <code class="docutils literal notranslate"><span class="pre">seventh.cc</span></code>) is shown below:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create the gnuplot helper.</span>
<span class="n">GnuplotHelper</span><span class="w"> </span><span class="n">plotHelper</span><span class="p">;</span>

<span class="c1">// Configure the plot.</span>
<span class="c1">// Configure the plot.  The first argument is the file name prefix</span>
<span class="c1">// for the output files generated.  The second, third, and fourth</span>
<span class="c1">// arguments are, respectively, the plot title, x-axis, and y-axis labels</span>
<span class="n">plotHelper</span><span class="p">.</span><span class="n">ConfigurePlot</span><span class="p">(</span><span class="s">&quot;seventh-packet-byte-count&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="s">&quot;Packet Byte Count vs. Time&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="s">&quot;Time(Seconds)&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="s">&quot;Packet Byte Count&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="s">&quot;png&quot;</span><span class="p">);</span>

<span class="c1">// Specify the probe type, trace source path (in configuration namespace), and</span>
<span class="c1">// probe output trace source (&quot;OutputBytes&quot;) to plot.  The fourth argument</span>
<span class="c1">// specifies the name of the data series label on the plot.  The last</span>
<span class="c1">// argument formats the plot by specifying where the key should be placed.</span>
<span class="n">plotHelper</span><span class="p">.</span><span class="n">PlotProbe</span><span class="p">(</span><span class="n">probeType</span><span class="p">,</span>
<span class="w">                     </span><span class="n">tracePath</span><span class="p">,</span>
<span class="w">                     </span><span class="s">&quot;OutputBytes&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="s">&quot;Packet Byte Count&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="n">GnuplotAggregator</span><span class="o">::</span><span class="n">KEY_BELOW</span><span class="p">);</span>
</pre></div>
</div>
<p>In this example, the <code class="docutils literal notranslate"><span class="pre">probeType</span></code> and <code class="docutils literal notranslate"><span class="pre">tracePath</span></code> are as follows (for IPv4):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">probeType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ns3::Ipv4PacketProbe&quot;</span><span class="p">;</span>
<span class="n">tracePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/NodeList/*/$ns3::Ipv4L3Protocol/Tx&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>The probeType is a key parameter for this helper to work.  This TypeId
must be registered in the system, and the signature on the Probe’s trace
sink must match that of the trace source it is being hooked to.  Probe
types are pre-defined for a number of data types corresponding to <em>ns-3</em>
traced values, and for a few other trace source signatures such as the
‘Tx’ trace source of <code class="docutils literal notranslate"><span class="pre">ns3::Ipv4L3Protocol</span></code> class.</p>
<p>Note that the trace source path specified may contain wildcards.
In this case, multiple
datasets are plotted on one plot; one for each matched path.</p>
<p>The main output produced will be three files:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">seventh</span><span class="o">-</span><span class="n">packet</span><span class="o">-</span><span class="n">byte</span><span class="o">-</span><span class="n">count</span><span class="p">.</span><span class="n">dat</span>
<span class="n">seventh</span><span class="o">-</span><span class="n">packet</span><span class="o">-</span><span class="n">byte</span><span class="o">-</span><span class="n">count</span><span class="p">.</span><span class="n">plt</span>
<span class="n">seventh</span><span class="o">-</span><span class="n">packet</span><span class="o">-</span><span class="n">byte</span><span class="o">-</span><span class="n">count</span><span class="p">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>At this point, users can either hand edit the .plt file for further
customizations, or just run it through gnuplot.  Running
<cite>sh seventh-packet-byte-count.sh</cite> simply runs the plot through gnuplot,
as shown below.</p>
<figure class="align-default" id="id3">
<span id="seventh-packet-byte-count"></span><img alt="_images/seventh-packet-byte-count.png" src="_images/seventh-packet-byte-count.png" />
<figcaption>
<p><span class="caption-text">2-D Gnuplot Created by seventh.cc Example.</span><a class="headerlink" href="#id3" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>It can be seen that the key elements (legend, title, legend placement,
xlabel, ylabel, and path for the data) are all placed on the plot.
Since there were two matches to the configuration path provided, the
two data series are shown:</p>
<ul class="simple">
<li><p>Packet Byte Count-0 corresponds to /NodeList/0/$ns3::Ipv4L3Protocol/Tx</p></li>
<li><p>Packet Byte Count-1 corresponds to /NodeList/1/$ns3::Ipv4L3Protocol/Tx</p></li>
</ul>
</section>
<section id="gnuplothelper-configureplot">
<h6><span class="section-number">3.4.2.2.2. </span>GnuplotHelper ConfigurePlot<a class="headerlink" href="#gnuplothelper-configureplot" title="Link to this heading">¶</a></h6>
<p>The GnuplotHelper’s <code class="docutils literal notranslate"><span class="pre">ConfigurePlot()</span></code> function can be used
to configure plots.</p>
<p>It has the following prototype:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="n">ConfigurePlot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">outputFileNameWithoutExtension</span><span class="p">,</span>
<span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">title</span><span class="p">,</span>
<span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">xLegend</span><span class="p">,</span>
<span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">yLegend</span><span class="p">,</span>
<span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">terminalType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;.png&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>It has the following arguments:</p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>outputFileNameWithoutExtension</p></td>
<td><p>Name of gnuplot related files
to write with no extension.</p></td>
</tr>
<tr class="row-odd"><td><p>title</p></td>
<td><p>Plot title string to use for
this plot.</p></td>
</tr>
<tr class="row-even"><td><p>xLegend</p></td>
<td><p>The legend for the x
horizontal axis.</p></td>
</tr>
<tr class="row-odd"><td><p>yLegend</p></td>
<td><p>The legend for the y
vertical axis.</p></td>
</tr>
<tr class="row-even"><td><p>terminalType</p></td>
<td><p>Terminal type setting string
for output.  The default
terminal type is “png”.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The GnuplotHelper’s <code class="docutils literal notranslate"><span class="pre">ConfigurePlot()</span></code> function configures plot
related parameters for this gnuplot helper so
that it will create a space separated gnuplot data file named
outputFileNameWithoutExtension + “.dat”, a gnuplot control file
named outputFileNameWithoutExtension + “.plt”, and a shell script
to generate the gnuplot named outputFileNameWithoutExtension +
“.sh”.</p>
<p>An example of how to use this function can be seen in the
<code class="docutils literal notranslate"><span class="pre">seventh.cc</span></code> code described above where it was used as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">plotHelper</span><span class="p">.</span><span class="n">ConfigurePlot</span><span class="p">(</span><span class="s">&quot;seventh-packet-byte-count&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="s">&quot;Packet Byte Count vs. Time&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="s">&quot;Time(Seconds)&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="s">&quot;Packet Byte Count&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="s">&quot;png&quot;</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="gnuplothelper-plotprobe">
<h6><span class="section-number">3.4.2.2.3. </span>GnuplotHelper PlotProbe<a class="headerlink" href="#gnuplothelper-plotprobe" title="Link to this heading">¶</a></h6>
<p>The GnuplotHelper’s <code class="docutils literal notranslate"><span class="pre">PlotProbe()</span></code> function can be used
to plot values generated by probes.</p>
<p>It has the following prototype:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">PlotProbe</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">typeId</span><span class="p">,</span>
<span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">path</span><span class="p">,</span>
<span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">probeTraceSource</span><span class="p">,</span>
<span class="w">               </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">title</span><span class="p">,</span>
<span class="w">               </span><span class="k">enum</span><span class="w"> </span><span class="nc">GnuplotAggregator</span><span class="o">::</span><span class="n">KeyLocation</span><span class="w"> </span><span class="n">keyLocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GnuplotAggregator</span><span class="o">::</span><span class="n">KEY_INSIDE</span><span class="p">);</span>
</pre></div>
</div>
<p>It has the following arguments:</p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>typeId</p></td>
<td><p>The type ID for the probe
created by this helper.</p></td>
</tr>
<tr class="row-odd"><td><p>path</p></td>
<td><p>Config path to access the
trace source.</p></td>
</tr>
<tr class="row-even"><td><p>probeTraceSource</p></td>
<td><p>The probe trace source to
access.</p></td>
</tr>
<tr class="row-odd"><td><p>title</p></td>
<td><p>The title to be associated
to this dataset</p></td>
</tr>
<tr class="row-even"><td><p>keyLocation</p></td>
<td><p>The location of the key in
the plot.  The default
location is inside.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The GnuplotHelper’s <code class="docutils literal notranslate"><span class="pre">PlotProbe()</span></code> function
plots a dataset generated by hooking the <em>ns-3</em> trace source with a
probe created by the helper, and then plotting the values from the
probeTraceSource.
The dataset will have the provided title, and will consist of
the ‘newValue’ at each timestamp.</p>
<p>If the config path has more than one match in the system because
there is a wildcard, then one dataset for each match will
be plotted.  The dataset titles will be suffixed with the matched
characters for each of the wildcards in the config path,
separated by spaces.  For example, if the proposed dataset title
is the string “bytes”, and there are two wildcards in the path,
then dataset titles like “bytes-0 0” or “bytes-12 9” will be
possible as labels for the datasets that are plotted.</p>
<p>An example of how to use this function can be seen in the
<code class="docutils literal notranslate"><span class="pre">seventh.cc</span></code> code described above where it was used (with
variable substitution) as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">plotHelper</span><span class="p">.</span><span class="n">PlotProbe</span><span class="p">(</span><span class="s">&quot;ns3::Ipv4PacketProbe&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="s">&quot;/NodeList/*/$ns3::Ipv4L3Protocol/Tx&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="s">&quot;OutputBytes&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="s">&quot;Packet Byte Count&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="n">GnuplotAggregator</span><span class="o">::</span><span class="n">KEY_BELOW</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="other-examples">
<h6><span class="section-number">3.4.2.2.4. </span>Other Examples<a class="headerlink" href="#other-examples" title="Link to this heading">¶</a></h6>
<section id="gnuplot-helper-example">
<h6 aria-level="7"><span class="section-number">3.4.2.2.4.1. </span>Gnuplot Helper Example<a class="headerlink" href="#gnuplot-helper-example" title="Link to this heading">¶</a></h6>
<p>A slightly simpler example than the <code class="docutils literal notranslate"><span class="pre">seventh.cc</span></code> example can be
found in <code class="docutils literal notranslate"><span class="pre">src/stats/examples/gnuplot-helper-example.cc</span></code>.  The
following 2-D gnuplot was created using the example.</p>
<figure class="align-default" id="id4">
<span id="id1"></span><img alt="_images/gnuplot-helper-example.png" src="_images/gnuplot-helper-example.png" />
<figcaption>
<p><span class="caption-text">2-D Gnuplot Created by gnuplot-helper-example.cc Example.</span><a class="headerlink" href="#id4" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>In this example, there is an Emitter object that increments
its counter according to a Poisson process and then emits the counter’s
value as a trace source.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Emitter</span><span class="o">&gt;</span><span class="w"> </span><span class="n">emitter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">Emitter</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;/Names/Emitter&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="p">);</span>
</pre></div>
</div>
<p>Note that because there are no wildcards in the path
used below, only 1 datastream was drawn in the plot.
This single datastream in the plot is simply labeled
“Emitter Count”, with no extra suffixes like one would
see if there were wildcards in the path.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create the gnuplot helper.</span>
<span class="n">GnuplotHelper</span><span class="w"> </span><span class="n">plotHelper</span><span class="p">;</span>

<span class="c1">// Configure the plot.</span>
<span class="n">plotHelper</span><span class="p">.</span><span class="n">ConfigurePlot</span><span class="p">(</span><span class="s">&quot;gnuplot-helper-example&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="s">&quot;Emitter Counts vs. Time&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="s">&quot;Time(Seconds)&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="s">&quot;Emitter Count&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="s">&quot;png&quot;</span><span class="p">);</span>

<span class="c1">// Plot the values generated by the probe.  The path that we provide</span>
<span class="c1">// helps to disambiguate the source of the trace.</span>
<span class="n">plotHelper</span><span class="p">.</span><span class="n">PlotProbe</span><span class="p">(</span><span class="s">&quot;ns3::Uinteger32Probe&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="s">&quot;/Names/Emitter/Counter&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="s">&quot;Output&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="s">&quot;Emitter Count&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="n">GnuplotAggregator</span><span class="o">::</span><span class="n">KEY_INSIDE</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="filehelper">
<h5><span class="section-number">3.4.2.3. </span>FileHelper<a class="headerlink" href="#filehelper" title="Link to this heading">¶</a></h5>
<p>The FileHelper is a helper class used to put data values into a file.
The overall goal is to provide the ability for users
to quickly make formatted text files from data exported in <em>ns-3</em>
trace sources.  By default, a minimal amount of data transformation is
performed; the objective is to generate files with as few (default)
configuration statements as possible.</p>
<section id="filehelper-overview">
<h6><span class="section-number">3.4.2.3.1. </span>FileHelper Overview<a class="headerlink" href="#filehelper-overview" title="Link to this heading">¶</a></h6>
<p>The FileHelper will create 1 or more text files at the end of the
simulation.</p>
<p>The FileHelper can create 4 different types of text files:</p>
<ul class="simple">
<li><p>Formatted</p></li>
<li><p>Space separated (the default)</p></li>
<li><p>Comma separated</p></li>
<li><p>Tab separated</p></li>
</ul>
<p>Formatted files use C-style format strings and the sprintf() function
to print their values in the file being written.</p>
<p>The following text file with 2 columns of formatted values named
<code class="docutils literal notranslate"><span class="pre">seventh-packet-byte-count-0.txt</span></code> was created using more new
code that was added to the original <em>ns-3</em> Tutorial example’s code.
Only the first 10 lines of this file are shown here for brevity.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Time (Seconds) = 1.000e+00    Packet Byte Count = 40
Time (Seconds) = 1.004e+00    Packet Byte Count = 40
Time (Seconds) = 1.004e+00    Packet Byte Count = 576
Time (Seconds) = 1.009e+00    Packet Byte Count = 576
Time (Seconds) = 1.009e+00    Packet Byte Count = 576
Time (Seconds) = 1.015e+00    Packet Byte Count = 512
Time (Seconds) = 1.017e+00    Packet Byte Count = 576
Time (Seconds) = 1.017e+00    Packet Byte Count = 544
Time (Seconds) = 1.025e+00    Packet Byte Count = 576
Time (Seconds) = 1.025e+00    Packet Byte Count = 544

...
</pre></div>
</div>
<p>The following different text file with 2 columns of formatted
values named <code class="docutils literal notranslate"><span class="pre">seventh-packet-byte-count-1.txt</span></code> was also
created using the same new code that was added to the original
<em>ns-3</em> Tutorial example’s code.  Only the first 10 lines of this
file are shown here for brevity.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Time (Seconds) = 1.002e+00    Packet Byte Count = 40
Time (Seconds) = 1.007e+00    Packet Byte Count = 40
Time (Seconds) = 1.013e+00    Packet Byte Count = 40
Time (Seconds) = 1.020e+00    Packet Byte Count = 40
Time (Seconds) = 1.028e+00    Packet Byte Count = 40
Time (Seconds) = 1.036e+00    Packet Byte Count = 40
Time (Seconds) = 1.045e+00    Packet Byte Count = 40
Time (Seconds) = 1.053e+00    Packet Byte Count = 40
Time (Seconds) = 1.061e+00    Packet Byte Count = 40
Time (Seconds) = 1.069e+00    Packet Byte Count = 40

...
</pre></div>
</div>
<p>The new code that was added to produce the two text files is below.
More details about this API will be covered in a later section.</p>
<p>Note that because there were 2 matches for the wildcard in the path,
2 separate text files were created.  The first text file, which is
named “seventh-packet-byte-count-0.txt”, corresponds to the
wildcard match with the “*” replaced with “0”.  The second text file,
which is named “seventh-packet-byte-count-1.txt”, corresponds to
the wildcard match with the “*” replaced with “1”.  Also, note that
the function call to <code class="docutils literal notranslate"><span class="pre">WriteProbe()</span></code> will give an error message if
there are no matches for a path that contains wildcards.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create the file helper.</span>
<span class="n">FileHelper</span><span class="w"> </span><span class="n">fileHelper</span><span class="p">;</span>

<span class="c1">// Configure the file to be written.</span>
<span class="n">fileHelper</span><span class="p">.</span><span class="n">ConfigureFile</span><span class="p">(</span><span class="s">&quot;seventh-packet-byte-count&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="n">FileAggregator</span><span class="o">::</span><span class="n">FORMATTED</span><span class="p">);</span>

<span class="c1">// Set the labels for this formatted output file.</span>
<span class="n">fileHelper</span><span class="p">.</span><span class="n">Set2dFormat</span><span class="p">(</span><span class="s">&quot;Time (Seconds) = %.3e</span><span class="se">\t</span><span class="s">Packet Byte Count = %.0f&quot;</span><span class="p">);</span>

<span class="c1">// Write the values generated by the probe.</span>
<span class="n">fileHelper</span><span class="p">.</span><span class="n">WriteProbe</span><span class="p">(</span><span class="s">&quot;ns3::Ipv4PacketProbe&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;/NodeList/*/$ns3::Ipv4L3Protocol/Tx&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;OutputBytes&quot;</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="filehelper-configurefile">
<h6><span class="section-number">3.4.2.3.2. </span>FileHelper ConfigureFile<a class="headerlink" href="#filehelper-configurefile" title="Link to this heading">¶</a></h6>
<p>The FileHelper’s <code class="docutils literal notranslate"><span class="pre">ConfigureFile()</span></code> function can be used
to configure text files.</p>
<p>It has the following prototype:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">ConfigureFile</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">outputFileNameWithoutExtension</span><span class="p">,</span>
<span class="w">                   </span><span class="k">enum</span><span class="w"> </span><span class="nc">FileAggregator</span><span class="o">::</span><span class="n">FileType</span><span class="w"> </span><span class="n">fileType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FileAggregator</span><span class="o">::</span><span class="n">SPACE_SEPARATED</span><span class="p">);</span>
</pre></div>
</div>
<p>It has the following arguments:</p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>outputFileNameWithoutExtension</p></td>
<td><p>Name of output file to write
with no extension.</p></td>
</tr>
<tr class="row-odd"><td><p>fileType</p></td>
<td><p>Type of file to write.  The
default type of file is space
separated.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The FileHelper’s <code class="docutils literal notranslate"><span class="pre">ConfigureFile()</span></code> function configures text file
related parameters for the file helper so that
it will create a file named outputFileNameWithoutExtension plus
possible extra information from wildcard matches plus “.txt” with
values printed as specified by fileType.  The default file type
is space-separated.</p>
<p>An example of how to use this function can be seen in the
<code class="docutils literal notranslate"><span class="pre">seventh.cc</span></code> code described above where it was used as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">fileHelper</span><span class="p">.</span><span class="n">ConfigureFile</span><span class="p">(</span><span class="s">&quot;seventh-packet-byte-count&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="n">FileAggregator</span><span class="o">::</span><span class="n">FORMATTED</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="filehelper-writeprobe">
<h6><span class="section-number">3.4.2.3.3. </span>FileHelper WriteProbe<a class="headerlink" href="#filehelper-writeprobe" title="Link to this heading">¶</a></h6>
<p>The FileHelper’s <code class="docutils literal notranslate"><span class="pre">WriteProbe()</span></code> function can be used
to write values generated by probes to text files.</p>
<p>It has the following prototype:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">WriteProbe</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">typeId</span><span class="p">,</span>
<span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">path</span><span class="p">,</span>
<span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">probeTraceSource</span><span class="p">);</span>
</pre></div>
</div>
<p>It has the following arguments:</p>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Argument</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>typeId</p></td>
<td><p>The type ID for the probe
to be created.</p></td>
</tr>
<tr class="row-odd"><td><p>path</p></td>
<td><p>Config path to access the
trace source.</p></td>
</tr>
<tr class="row-even"><td><p>probeTraceSource</p></td>
<td><p>The probe trace source to
access.</p></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The FileHelper’s <code class="docutils literal notranslate"><span class="pre">WriteProbe()</span></code> function
creates output text files generated by hooking the ns-3 trace source
with a probe created by the helper, and then writing the values from the
probeTraceSource. The output file names will have the text stored
in the member variable  m_outputFileNameWithoutExtension plus “.txt”,
and will consist of the ‘newValue’ at each timestamp.</p>
<p>If the config path has more than one match in the system because
there is a wildcard, then one output file for each match
will be created.  The output file names will contain the text in
m_outputFileNameWithoutExtension plus the matched characters for
each of the wildcards in the config path, separated by dashes,
plus “.txt”.  For example, if the value in
m_outputFileNameWithoutExtension is the string
“packet-byte-count”, and there are two wildcards in the path,
then output file names like “packet-byte-count-0-0.txt” or
“packet-byte-count-12-9.txt” will be possible as names for the
files that will be created.</p>
<p>An example of how to use this function can be seen in the
<code class="docutils literal notranslate"><span class="pre">seventh.cc</span></code> code described above where it was used as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">fileHelper</span><span class="p">.</span><span class="n">WriteProbe</span><span class="p">(</span><span class="s">&quot;ns3::Ipv4PacketProbe&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;/NodeList/*/$ns3::Ipv4L3Protocol/Tx&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;OutputBytes&quot;</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="id2">
<h6><span class="section-number">3.4.2.3.4. </span>Other Examples<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h6>
<section id="file-helper-example">
<h6 aria-level="7"><span class="section-number">3.4.2.3.4.1. </span>File Helper Example<a class="headerlink" href="#file-helper-example" title="Link to this heading">¶</a></h6>
<p>A slightly simpler example than the <code class="docutils literal notranslate"><span class="pre">seventh.cc</span></code> example can be
found in <code class="docutils literal notranslate"><span class="pre">src/stats/examples/file-helper-example.cc</span></code>.
This example only uses the FileHelper.</p>
<p>The following text file with 2 columns of formatted values named
<code class="docutils literal notranslate"><span class="pre">file-helper-example.txt</span></code> was created using the example.
Only the first 10 lines of this file are shown here for brevity.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Time (Seconds) = 0.203  Count = 1
Time (Seconds) = 0.702  Count = 2
Time (Seconds) = 1.404  Count = 3
Time (Seconds) = 2.368  Count = 4
Time (Seconds) = 3.364  Count = 5
Time (Seconds) = 3.579  Count = 6
Time (Seconds) = 5.873  Count = 7
Time (Seconds) = 6.410  Count = 8
Time (Seconds) = 6.472  Count = 9
...
</pre></div>
</div>
<p>In this example, there is an Emitter object that increments
its counter according to a Poisson process and then emits the counter’s
value as a trace source.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Emitter</span><span class="o">&gt;</span><span class="w"> </span><span class="n">emitter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">Emitter</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;/Names/Emitter&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="p">);</span>
</pre></div>
</div>
<p>Note that because there are no wildcards in the path
used below, only 1 text file was created.
This single text file is simply named
“file-helper-example.txt”, with no extra suffixes like
you would see if there were wildcards in the path.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create the file helper.</span>
<span class="n">FileHelper</span><span class="w"> </span><span class="n">fileHelper</span><span class="p">;</span>

<span class="c1">// Configure the file to be written.</span>
<span class="n">fileHelper</span><span class="p">.</span><span class="n">ConfigureFile</span><span class="p">(</span><span class="s">&quot;file-helper-example&quot;</span><span class="p">,</span>
<span class="w">                         </span><span class="n">FileAggregator</span><span class="o">::</span><span class="n">FORMATTED</span><span class="p">);</span>

<span class="c1">// Set the labels for this formatted output file.</span>
<span class="n">fileHelper</span><span class="p">.</span><span class="n">Set2dFormat</span><span class="p">(</span><span class="s">&quot;Time (Seconds) = %.3e</span><span class="se">\t</span><span class="s">Count = %.0f&quot;</span><span class="p">);</span>

<span class="c1">// Write the values generated by the probe.  The path that we</span>
<span class="c1">// provide helps to disambiguate the source of the trace.</span>
<span class="n">fileHelper</span><span class="p">.</span><span class="n">WriteProbe</span><span class="p">(</span><span class="s">&quot;ns3::Uinteger32Probe&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;/Names/Emitter/Counter&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;Output&quot;</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="scope-and-limitations">
<h5><span class="section-number">3.4.2.4. </span>Scope and Limitations<a class="headerlink" href="#scope-and-limitations" title="Link to this heading">¶</a></h5>
<p>Currently, only these Probes have been implemented and connected
to the GnuplotHelper and to the FileHelper:</p>
<ul class="simple">
<li><p>BooleanProbe</p></li>
<li><p>DoubleProbe</p></li>
<li><p>Uinteger8Probe</p></li>
<li><p>Uinteger16Probe</p></li>
<li><p>Uinteger32Probe</p></li>
<li><p>TimeProbe</p></li>
<li><p>PacketProbe</p></li>
<li><p>ApplicationPacketProbe</p></li>
<li><p>Ipv4PacketProbe</p></li>
</ul>
<p>These Probes, therefore, are the only TypeIds available to be used
in <code class="docutils literal notranslate"><span class="pre">PlotProbe()</span></code> and <code class="docutils literal notranslate"><span class="pre">WriteProbe()</span></code>.</p>
<p>In the next few sections, we cover each of the fundamental object
types (Probe, Collector, and Aggregator) in more detail, and show
how they can be connected together using lower-level API.</p>
</section>
</section>
<span id="document-probe"></span><section id="probes">
<h4><span class="section-number">3.4.3. </span>Probes<a class="headerlink" href="#probes" title="Link to this heading">¶</a></h4>
<p>This section details the functionalities provided by the Probe class
to an <em>ns-3</em> simulation, and gives examples on how to code them in a
program. This section is meant for users interested in developing
simulations with the <em>ns-3</em> tools and using the Data Collection
Framework, of which the Probe class is a part, to generate data output
with their simulation’s results.</p>
<section id="probe-overview">
<h5><span class="section-number">3.4.3.1. </span>Probe Overview<a class="headerlink" href="#probe-overview" title="Link to this heading">¶</a></h5>
<p>A Probe object is supposed to be connected to a variable from the
simulation whose values throughout the experiment are relevant to the user.
The Probe will record what were values assumed by the variable throughout
the simulation and pass such data to another member of the Data Collection
Framework.  While it is out of this section’s scope to discuss what happens
after the Probe produces its output, it is sufficient to say that, by the
end of the simulation, the user will have detailed information about what
values were stored inside the variable being probed during the simulation.</p>
<p>Typically, a Probe is connected to an <em>ns-3</em> trace source.  In this manner,
whenever the trace source exports a new value, the Probe consumes the
value (and exports it downstream to another object via its own trace source).</p>
<p>The Probe can be thought of as kind of a filter on trace sources.  The
main reasons for possibly hooking to a Probe rather than directly to a
trace source are as follows:</p>
<ul>
<li><p>Probes may be dynamically turned on and off during the simulation
with calls to <code class="docutils literal notranslate"><span class="pre">Enable()</span></code> and <code class="docutils literal notranslate"><span class="pre">Disable()</span></code>.  For example, the
outputting of data may be turned off during the simulation warmup
phase.</p></li>
<li><p>Probes may perform operations on the data to extract values from more
complicated structures; for instance, outputting the packet size value
from a received ns3::Packet.</p></li>
<li><p>Probes register a name in the ns3::Config namespace (using
<code class="docutils literal notranslate"><span class="pre">Names::Add()</span></code>) so that other objects may refer to them.</p></li>
<li><p>Probes provide a static method that allows one to manipulate a Probe
by name, such as what is done in ns2measure <a class="reference internal" href="index.html#cic06" id="id1"><span>[Cic06]</span></a></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Stat</span><span class="o">::</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;my_metric&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">sample</span><span class="p">);</span>
</pre></div>
</div>
<p>The ns-3 equivalent of the above ns2measure code is, e.g.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">DoubleProbe</span><span class="o">::</span><span class="n">SetValueByPath</span><span class="p">(</span><span class="s">&quot;/path/to/probe&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sample</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ul>
<section id="creation">
<h6><span class="section-number">3.4.3.1.1. </span>Creation<a class="headerlink" href="#creation" title="Link to this heading">¶</a></h6>
<p>Note that a Probe base class object can not be created because it
is an abstract base class, i.e. it has pure virtual functions that
have not been implemented.  An object of type DoubleProbe,
which is a subclass of the Probe class, will be created here to
show what needs to be done.</p>
<p>One declares a DoubleProbe in dynamic memory by using the smart pointer class
(Ptr&lt;T&gt;). To create a DoubleProbe in dynamic memory with smart pointers, one
just needs to call the <em>ns-3</em> method <code class="docutils literal notranslate"><span class="pre">CreateObject()</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="w"> </span><span class="n">myprobe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="p">();</span>
</pre></div>
</div>
<p>The declaration above creates DoubleProbes using the default values for its
attributes.  There are four attributes in the DoubleProbe class; two in the
base class object DataCollectionObject, and two in the Probe base class:</p>
<ul class="simple">
<li><p>“Name” (DataCollectionObject), a StringValue</p></li>
<li><p>“Enabled” (DataCollectionObject), a BooleanValue</p></li>
<li><p>“Start” (Probe), a TimeValue</p></li>
<li><p>“Stop” (Probe), a TimeValue</p></li>
</ul>
<p>One can set such attributes at object creation by using the following
method:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="w"> </span><span class="n">myprobe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObjectWithAttributes</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;Name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">StringValue</span><span class="p">(</span><span class="s">&quot;myprobe&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;Enabled&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">BooleanValue</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;Start&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">TimeValue</span><span class="p">(</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">100.0</span><span class="p">)),</span>
<span class="w">    </span><span class="s">&quot;Stop&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">TimeValue</span><span class="p">(</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">1000.0</span><span class="p">)));</span>
</pre></div>
</div>
<p>Start and Stop are Time variables which determine the interval of action
of the Probe. The Probe will only output data if the current time of the
Simulation is inside of that interval.  The special time value of 0 seconds
for Stop will disable this attribute (i.e. keep the Probe on for the whole
simulation).  Enabled is a flag that turns the
Probe on or off, and must be set to true for the Probe to export data.
The Name is the object’s name in the DCF framework.</p>
</section>
<section id="importing-and-exporting-data">
<h6><span class="section-number">3.4.3.1.2. </span>Importing and exporting data<a class="headerlink" href="#importing-and-exporting-data" title="Link to this heading">¶</a></h6>
<p><em>ns-3</em> trace sources are strongly typed, so the mechanisms for hooking
Probes to a trace source and for exporting data belong to its
subclasses.  For instance, the default distribution of <em>ns-3</em> provides
a class DoubleProbe that is designed to hook to a trace source
exporting a double value.  We’ll next detail the operation of the
DoubleProbe, and then discuss how other Probe classes may be defined
by the user.</p>
</section>
</section>
<section id="doubleprobe-overview">
<h5><span class="section-number">3.4.3.2. </span>DoubleProbe Overview<a class="headerlink" href="#doubleprobe-overview" title="Link to this heading">¶</a></h5>
<p>The DoubleProbe connects to a double-valued <em>ns-3</em> trace source, and itself
exports a different double-valued <em>ns-3</em> trace source.</p>
<p>The following code, drawn from
<code class="docutils literal notranslate"><span class="pre">src/stats/examples/double-probe-example.cc</span></code>, shows the basic
operations of plumbing the DoubleProbe into a simulation, where it is
probing a Counter exported by an emitter object (class Emitter).</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Emitter</span><span class="o">&gt;</span><span class="w"> </span><span class="n">emitter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">Emitter</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;/Names/Emitter&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="p">);</span>
<span class="p">...</span>

<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="w"> </span><span class="n">probe1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="p">();</span>

<span class="c1">// Connect the probe to the emitter&#39;s Counter</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">probe1</span><span class="o">-&gt;</span><span class="n">ConnectByObject</span><span class="p">(</span><span class="s">&quot;Counter&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="p">);</span>
</pre></div>
</div>
<p>The following code is probing the same Counter exported by the same
emitter object.  This DoubleProbe, however, is using a path in the
configuration namespace to make the connection.  Note that the emitter
registered itself in the configuration namespace after it was created;
otherwise, the ConnectByPath would not work.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="w"> </span><span class="n">probe2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="p">();</span>

<span class="c1">// Note, no return value is checked here</span>
<span class="n">probe2</span><span class="o">-&gt;</span><span class="n">ConnectByPath</span><span class="p">(</span><span class="s">&quot;/Names/Emitter/Counter&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>The next DoubleProbe shown that is shown below will have its value set using
its path in the configuration namespace.  Note that this time the
DoubleProbe registered itself in the configuration namespace after it was
created.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="w"> </span><span class="n">probe3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">probe3</span><span class="o">-&gt;</span><span class="n">SetName</span><span class="p">(</span><span class="s">&quot;StaticallyAccessedProbe&quot;</span><span class="p">);</span>

<span class="c1">// We must add it to the config database</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;/Names/Probes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">probe3</span><span class="o">-&gt;</span><span class="n">GetName</span><span class="p">(),</span><span class="w"> </span><span class="n">probe3</span><span class="p">);</span>
</pre></div>
</div>
<p>The emitter’s Count() function is now able to set the value for this DoubleProbe as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">Emitter::Count</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="n">m_counter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">DoubleProbe</span><span class="o">::</span><span class="n">SetValueByPath</span><span class="p">(</span><span class="s">&quot;/Names/StaticallyAccessedProbe&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m_counter</span><span class="p">);</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The above example shows how the code calling the Probe does not have to
have an explicit reference to the Probe, but can direct the value
setting through the Config namespace.  This is similar in functionality
to the <cite>Stat::Put</cite> method introduced by ns2measure paper <a class="reference internal" href="index.html#cic06" id="id2"><span>[Cic06]</span></a>, and allows
users to temporarily insert Probe statements like <cite>printf</cite> statements within
existing <em>ns-3</em> models.  Note that in order to be able to use the DoubleProbe in this example like this, 2 things were necessary:</p>
<ol class="arabic simple">
<li><p>the stats module header file was included in the example .cc file</p></li>
<li><p>the example was made dependent on the stats module in its CMakeLists.txt file.</p></li>
</ol>
<p>Analogous things need to be done in order to add other Probes in other places in the <em>ns-3</em> code base.</p>
<p>The values for the DoubleProbe can also be set using the function
DoubleProbe::SetValue(), while the values for the DoubleProbe can be gotten
using the function DoubleProbe::GetValue().</p>
<p>The DoubleProbe exports double values in its “Output” trace source;
a downstream object can hook a trace sink (NotifyViaProbe) to this as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">probe1</span><span class="o">-&gt;</span><span class="n">TraceConnect</span><span class="p">(</span><span class="s">&quot;Output&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">probe1</span><span class="o">-&gt;</span><span class="n">GetName</span><span class="p">(),</span><span class="w"> </span><span class="n">MakeCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NotifyViaProbe</span><span class="p">));</span>
</pre></div>
</div>
</section>
<section id="other-probes">
<h5><span class="section-number">3.4.3.3. </span>Other probes<a class="headerlink" href="#other-probes" title="Link to this heading">¶</a></h5>
<p>Besides the DoubleProbe, the following Probes are also available:</p>
<ul class="simple">
<li><p>Uinteger8Probe connects to an <em>ns-3</em> trace source exporting an uint8_t.</p></li>
<li><p>Uinteger16Probe connects to an <em>ns-3</em> trace source exporting an uint16_t.</p></li>
<li><p>Uinteger32Probe connects to an <em>ns-3</em> trace source exporting an uint32_t.</p></li>
<li><p>PacketProbe connects to an <em>ns-3</em> trace source exporting a packet.</p></li>
<li><p>ApplicationPacketProbe connects to an <em>ns-3</em> trace source exporting a packet and a socket address.</p></li>
<li><p>Ipv4PacketProbe connects to an <em>ns-3</em> trace source exporting a packet, an IPv4 object, and an interface.</p></li>
</ul>
</section>
<section id="creating-new-probe-types">
<h5><span class="section-number">3.4.3.4. </span>Creating new Probe types<a class="headerlink" href="#creating-new-probe-types" title="Link to this heading">¶</a></h5>
<p>To create a new Probe type, you need to perform the following steps:</p>
<ul class="simple">
<li><p>Be sure that your new Probe class is derived from the Probe base class.</p></li>
<li><p>Be sure that the pure virtual functions that your new Probe class
inherits from the Probe base class are implemented.</p></li>
<li><p>Find an existing Probe class that uses a trace source that is
closest in type to the type of trace source your Probe will be
using.</p></li>
<li><p>Copy that existing Probe class’s header file (.h) and implementation
file (.cc) to two new files with names matching your new Probe.</p></li>
<li><p>Replace the types, arguments, and variables in the copied files with
the appropriate type for your Probe.</p></li>
<li><p>Make necessary modifications to make the code compile and to make it
behave as you would like.</p></li>
</ul>
</section>
<section id="examples">
<h5><span class="section-number">3.4.3.5. </span>Examples<a class="headerlink" href="#examples" title="Link to this heading">¶</a></h5>
<p>Two examples will be discussed in detail here:</p>
<ul class="simple">
<li><p>Double Probe Example</p></li>
<li><p>IPv4 Packet Plot Example</p></li>
</ul>
<section id="double-probe-example">
<h6><span class="section-number">3.4.3.5.1. </span>Double Probe Example<a class="headerlink" href="#double-probe-example" title="Link to this heading">¶</a></h6>
<p>The double probe example has been discussed previously.  The example
program can be found in
<code class="docutils literal notranslate"><span class="pre">src/stats/examples/double-probe-example.cc</span></code>.  To
summarize what occurs in this program, there is an emitter that
exports a counter that increments according to a Poisson process.  In
particular, two ways of emitting data are shown:</p>
<ol class="arabic">
<li><p>through a traced variable hooked to one Probe:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">TracedValue</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_counter</span><span class="p">;</span><span class="w">  </span><span class="c1">// normally this would be integer type</span>
</pre></div>
</div>
</li>
<li><p>through a counter whose value is posted to a second Probe, referenced by its name in the Config system:</p></li>
</ol>
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">Emitter::Count</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">NS_LOG_FUNCTION</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">  </span><span class="n">NS_LOG_DEBUG</span><span class="p">(</span><span class="s">&quot;Counting at &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">Simulator</span><span class="o">::</span><span class="n">Now</span><span class="p">().</span><span class="n">GetSeconds</span><span class="p">());</span>
<span class="w">  </span><span class="n">m_counter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">DoubleProbe</span><span class="o">::</span><span class="n">SetValueByPath</span><span class="p">(</span><span class="s">&quot;/Names/StaticallyAccessedProbe&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m_counter</span><span class="p">);</span>
<span class="w">  </span><span class="n">Simulator</span><span class="o">::</span><span class="n">Schedule</span><span class="p">(</span><span class="n">Seconds</span><span class="p">(</span><span class="n">m_var</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">()),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Emitter</span><span class="o">::</span><span class="n">Count</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>Let’s look at the Probe more carefully.  Probes can receive their values
in a multiple ways:</p>
<ol class="arabic simple">
<li><p>by the Probe accessing the trace source directly and connecting
a trace sink to it</p></li>
<li><p>by the Probe accessing the trace source through the config namespace
and connecting a trace sink to it</p></li>
<li><p>by the calling code explicitly calling the Probe’s <cite>SetValue()</cite> method</p></li>
<li><p>by the calling code explicitly calling <cite>SetValueByPath (“/path/through/Config/namespace”, …)</cite></p></li>
</ol>
<p>The first two techniques are expected to be the most common.  Also in the
example, the hooking of a normal callback function is shown,
as is typically done in <em>ns-3</em>.  This callback function is not associated
with a Probe object.  We’ll call this case 0) below.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// This is a function to test hooking a raw function to the trace source</span>
<span class="kt">void</span>
<span class="nf">NotifyViaTraceSource</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">oldVal</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">newVal</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">NS_LOG_DEBUG</span><span class="p">(</span><span class="s">&quot;context: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; old &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">oldVal</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; new &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">newVal</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>First, the emitter needs to be setup:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Emitter</span><span class="o">&gt;</span><span class="w"> </span><span class="n">emitter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">Emitter</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;/Names/Emitter&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="p">);</span>

<span class="c1">// The Emitter object is not associated with an ns-3 node, so</span>
<span class="c1">// it won&#39;t get started automatically, so we need to do this ourselves</span>
<span class="n">Simulator</span><span class="o">::</span><span class="n">Schedule</span><span class="p">(</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Emitter</span><span class="o">::</span><span class="n">Start</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="p">);</span>
</pre></div>
</div>
<p>The various DoubleProbes interact with the emitter in the example as
shown below.</p>
<p>Case 0):</p>
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// The below shows typical functionality without a probe</span>
<span class="c1">// (connect a sink function to a trace source)</span>
<span class="c1">//</span>
<span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emitter</span><span class="o">-&gt;</span><span class="n">TraceConnect</span><span class="p">(</span><span class="s">&quot;Counter&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sample context&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">MakeCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NotifyViaTraceSource</span><span class="p">));</span>
<span class="n">NS_ASSERT_MSG</span><span class="p">(</span><span class="n">connected</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Trace source not connected&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<p>case 1):</p>
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">//</span>
<span class="c1">// Probe1 will be hooked directly to the Emitter trace source object</span>
<span class="c1">//</span>

<span class="c1">// probe1 will be hooked to the Emitter trace source</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="w"> </span><span class="n">probe1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="p">();</span>
<span class="c1">// the probe&#39;s name can serve as its context in the tracing</span>
<span class="n">probe1</span><span class="o">-&gt;</span><span class="n">SetName</span><span class="p">(</span><span class="s">&quot;ObjectProbe&quot;</span><span class="p">);</span>

<span class="c1">// Connect the probe to the emitter&#39;s Counter</span>
<span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">probe1</span><span class="o">-&gt;</span><span class="n">ConnectByObject</span><span class="p">(</span><span class="s">&quot;Counter&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="p">);</span>
<span class="n">NS_ASSERT_MSG</span><span class="p">(</span><span class="n">connected</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Trace source not connected to probe1&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<p>case 2):</p>
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">//</span>
<span class="c1">// Probe2 will be hooked to the Emitter trace source object by</span>
<span class="c1">// accessing it by path name in the Config database</span>
<span class="c1">//</span>

<span class="c1">// Create another similar probe; this will hook up via a Config path</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="w"> </span><span class="n">probe2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">probe2</span><span class="o">-&gt;</span><span class="n">SetName</span><span class="p">(</span><span class="s">&quot;PathProbe&quot;</span><span class="p">);</span>

<span class="c1">// Note, no return value is checked here</span>
<span class="n">probe2</span><span class="o">-&gt;</span><span class="n">ConnectByPath</span><span class="p">(</span><span class="s">&quot;/Names/Emitter/Counter&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<p>case 4)(case 3 is not shown in this example):</p>
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">//</span>
<span class="c1">// Probe3 will be called by the emitter directly through the</span>
<span class="c1">// static method SetValueByPath().</span>
<span class="c1">//</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="w"> </span><span class="n">probe3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">DoubleProbe</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">probe3</span><span class="o">-&gt;</span><span class="n">SetName</span><span class="p">(</span><span class="s">&quot;StaticallyAccessedProbe&quot;</span><span class="p">);</span>
<span class="c1">// We must add it to the config database</span>
<span class="n">Names</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="s">&quot;/Names/Probes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">probe3</span><span class="o">-&gt;</span><span class="n">GetName</span><span class="p">(),</span><span class="w"> </span><span class="n">probe3</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<p>And finally, the example shows how the probes can be hooked to
generate output:</p>
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// The probe itself should generate output.  The context that we provide</span>
<span class="c1">// to this probe (in this case, the probe name) will help to disambiguate</span>
<span class="c1">// the source of the trace</span>
<span class="n">connected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">probe3</span><span class="o">-&gt;</span><span class="n">TraceConnect</span><span class="p">(</span><span class="s">&quot;Output&quot;</span><span class="p">,</span>
<span class="w">                                 </span><span class="s">&quot;/Names/Probes/StaticallyAccessedProbe/Output&quot;</span><span class="p">,</span>
<span class="w">                                 </span><span class="n">MakeCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NotifyViaProbe</span><span class="p">));</span>
<span class="n">NS_ASSERT_MSG</span><span class="p">(</span><span class="n">connected</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Trace source not .. connected to probe3 Output&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<p>The following callback is hooked to the Probe in this example for
illustrative purposes; normally, the Probe would be hooked to a
Collector object.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// This is a function to test hooking it to the probe output</span>
<span class="kt">void</span>
<span class="nf">NotifyViaProbe</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">oldVal</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">newVal</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">NS_LOG_DEBUG</span><span class="p">(</span><span class="s">&quot;context: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; old &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">oldVal</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; new &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">newVal</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="ipv4-packet-plot-example">
<h6><span class="section-number">3.4.3.5.2. </span>IPv4 Packet Plot Example<a class="headerlink" href="#ipv4-packet-plot-example" title="Link to this heading">¶</a></h6>
<p>The IPv4 packet plot example is based on the fifth.cc example from the <em>ns-3</em>
Tutorial.  It can be found in
<code class="docutils literal notranslate"><span class="pre">src/stats/examples/ipv4-packet-plot-example.cc</span></code>.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>      node 0                 node 1
+----------------+    +----------------+
|    ns-3 TCP    |    |    ns-3 TCP    |
+----------------+    +----------------+
|    10.1.1.1    |    |    10.1.1.2    |
+----------------+    +----------------+
| point-to-point |    | point-to-point |
+----------------+    +----------------+
        |                     |
        +---------------------+
</pre></div>
</div>
<p>We’ll just look at the Probe, as it illustrates that Probes may also
unpack values from structures (in this case, packets) and report
those values as trace source outputs, rather than just passing through
the same type of data.</p>
<p>There are other aspects of this example that will be explained later in
the documentation.  The two types of data that are exported are the packet
itself (<cite>Output</cite>) and a count of the number of bytes in the packet
(<cite>OutputBytes</cite>).</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">TypeId</span>
<span class="nf">Ipv4PacketProbe::GetTypeId</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeId</span><span class="p">(</span><span class="s">&quot;ns3::Ipv4PacketProbe&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">SetParent</span><span class="o">&lt;</span><span class="n">Probe</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddConstructor</span><span class="o">&lt;</span><span class="n">Ipv4PacketProbe</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddTraceSource</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;Output&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="s">&quot;The packet plus its IPv4 object and interface that serve as the output for this probe&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="n">MakeTraceSourceAccessor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Ipv4PacketProbe</span><span class="o">::</span><span class="n">m_output</span><span class="p">))</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddTraceSource</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;OutputBytes&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="s">&quot;The number of bytes in the packet&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="n">MakeTraceSourceAccessor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Ipv4PacketProbe</span><span class="o">::</span><span class="n">m_outputBytes</span><span class="p">))</span>
<span class="w">  </span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When the Probe’s trace sink gets a packet, if the Probe is enabled, then
it will output the packet on its <cite>Output</cite> trace source, but it will also
output the number of bytes on the <cite>OutputBytes</cite> trace source.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">Ipv4PacketProbe::TraceSink</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">Packet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">packet</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Ipv4</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ipv4</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">NS_LOG_FUNCTION</span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">packet</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ipv4</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">interface</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsEnabled</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">m_packet</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">packet</span><span class="p">;</span>
<span class="w">      </span><span class="n">m_ipv4</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">ipv4</span><span class="p">;</span>
<span class="w">      </span><span class="n">m_interface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">interface</span><span class="p">;</span>
<span class="w">      </span><span class="n">m_output</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span><span class="w"> </span><span class="n">ipv4</span><span class="p">,</span><span class="w"> </span><span class="n">interface</span><span class="p">);</span>

<span class="w">      </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">packetSizeNew</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">GetSize</span><span class="p">();</span>
<span class="w">      </span><span class="n">m_outputBytes</span><span class="p">(</span><span class="n">m_packetSizeOld</span><span class="p">,</span><span class="w"> </span><span class="n">packetSizeNew</span><span class="p">);</span>
<span class="w">      </span><span class="n">m_packetSizeOld</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packetSizeNew</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="references">
<h5><span class="section-number">3.4.3.6. </span>References<a class="headerlink" href="#references" title="Link to this heading">¶</a></h5>
<div role="list" class="citation-list">
<div class="citation" id="cic06" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>Cic06<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id1">1</a>,<a role="doc-backlink" href="#id2">2</a>)</span>
<p>Claudio Cicconetti, Enzo Mingozzi, Giovanni Stea, “An Integrated
Framework for Enabling Effective Data Collection and Statistical
Analysis with ns2, Workshop on ns-2 (WNS2), Pisa, Italy, October 2006.</p>
</div>
</div>
</section>
</section>
<span id="document-collector"></span><section id="collectors">
<h4><span class="section-number">3.4.4. </span>Collectors<a class="headerlink" href="#collectors" title="Link to this heading">¶</a></h4>
<p>This section is a placeholder to detail the functionalities provided by
the Collector
class to an <em>ns-3</em> simulation, and gives examples on how to code them
in a program.</p>
<p><strong>Note:</strong> As of ns-3.18, Collectors are still under development and
not yet provided as part of the framework.</p>
</section>
<span id="document-aggregator"></span><section id="aggregators">
<h4><span class="section-number">3.4.5. </span>Aggregators<a class="headerlink" href="#aggregators" title="Link to this heading">¶</a></h4>
<p>This section details the functionalities provided by the Aggregator
class to an <em>ns-3</em> simulation. This section is meant for users
interested in developing simulations with the <em>ns-3</em> tools and using
the Data Collection Framework, of which the Aggregator class is a
part, to generate data output with their simulation’s results.</p>
<section id="aggregator-overview">
<h5><span class="section-number">3.4.5.1. </span>Aggregator Overview<a class="headerlink" href="#aggregator-overview" title="Link to this heading">¶</a></h5>
<p>An Aggregator object is supposed to be hooked to one or more trace
sources in order to receive input. Aggregators are the end point of
the data collected by the network of Probes and Collectors during the
simulation.  It is the Aggregator’s job to take these values and
transform them into their final output format such as plain text
files, spreadsheet files, plots, or databases.</p>
<p>Typically, an aggregator is connected to one or more Collectors.  In
this manner, whenever the Collectors’ trace sources export new values,
the Aggregator can process the value so that it can be used in the
final output format where the data values will reside after the
simulation.</p>
<p>Note the following about Aggregators:</p>
<ul class="simple">
<li><p>Aggregators may be dynamically turned on and off during the
simulation with calls to <code class="docutils literal notranslate"><span class="pre">Enable()</span></code> and <code class="docutils literal notranslate"><span class="pre">Disable()</span></code>.  For
example, the aggregating of data may be turned off during the
simulation warmup phase, which means those values won’t be included
in the final output medium.</p></li>
<li><p>Aggregators receive data from Collectors via callbacks. When a
Collector is associated to an aggregator, a call to TraceConnect is
made to establish the Aggregator’s trace sink method as a callback.</p></li>
</ul>
<p>To date, two Aggregators have been implemented:</p>
<ul class="simple">
<li><p>GnuplotAggregator</p></li>
<li><p>FileAggregator</p></li>
</ul>
</section>
<section id="gnuplotaggregator">
<h5><span class="section-number">3.4.5.2. </span>GnuplotAggregator<a class="headerlink" href="#gnuplotaggregator" title="Link to this heading">¶</a></h5>
<p>The GnuplotAggregator produces output files used to make gnuplots.</p>
<p>The GnuplotAggregator will create 3 different files at the end of the
simulation:</p>
<ul class="simple">
<li><p>A space separated gnuplot data file</p></li>
<li><p>A gnuplot control file</p></li>
<li><p>A shell script to generate the gnuplot</p></li>
</ul>
<section id="creation">
<h6><span class="section-number">3.4.5.2.1. </span>Creation<a class="headerlink" href="#creation" title="Link to this heading">¶</a></h6>
<p>An object of type GnuplotAggregator will be created here to show what needs
to be done.</p>
<p>One declares a GnuplotAggregator in dynamic memory by using the smart
pointer class (Ptr&lt;T&gt;). To create a GnuplotAggregator in dynamic
memory with smart pointers, one just needs to call the <em>ns-3</em> method
<code class="docutils literal notranslate"><span class="pre">CreateObject()</span></code>.  The following code from
<code class="docutils literal notranslate"><span class="pre">src/stats/examples/gnuplot-aggregator-example.cc</span></code> shows
how to do this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">string</span><span class="w"> </span><span class="n">fileNameWithoutExtension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;gnuplot-aggregator&quot;</span><span class="p">;</span>

<span class="c1">// Create an aggregator.</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">GnuplotAggregator</span><span class="o">&gt;</span><span class="w"> </span><span class="n">aggregator</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">GnuplotAggregator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">fileNameWithoutExtension</span><span class="p">);</span>
</pre></div>
</div>
<p>The first argument for the constructor, fileNameWithoutExtension, is
the name of the gnuplot related files to write with no extension.
This GnuplotAggregator will create a space separated gnuplot data file
named “gnuplot-aggregator.dat”, a gnuplot control file named
“gnuplot-aggregator.plt”, and a shell script to generate the gnuplot
named + “gnuplot-aggregator.sh”.</p>
<p>The gnuplot that is created can have its key in 4 different locations:</p>
<ul class="simple">
<li><p>No key</p></li>
<li><p>Key inside the plot (the default)</p></li>
<li><p>Key above the plot</p></li>
<li><p>Key below the plot</p></li>
</ul>
<p>The following gnuplot key location enum values are allowed to specify the key’s position:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="nc">KeyLocation</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">NO_KEY</span><span class="p">,</span>
<span class="w">  </span><span class="n">KEY_INSIDE</span><span class="p">,</span>
<span class="w">  </span><span class="n">KEY_ABOVE</span><span class="p">,</span>
<span class="w">  </span><span class="n">KEY_BELOW</span>
<span class="p">};</span>
</pre></div>
</div>
<p>If it was desired to have the key below rather than the default position of inside, then you could do the following.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">aggregator</span><span class="o">-&gt;</span><span class="n">SetKeyLocation</span><span class="p">(</span><span class="n">GnuplotAggregator</span><span class="o">::</span><span class="n">KEY_BELOW</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="examples">
<h6><span class="section-number">3.4.5.2.2. </span>Examples<a class="headerlink" href="#examples" title="Link to this heading">¶</a></h6>
<p>One example will be discussed in detail here:</p>
<ul class="simple">
<li><p>Gnuplot Aggregator Example</p></li>
</ul>
<section id="gnuplot-aggregator-example">
<h6 aria-level="7"><span class="section-number">3.4.5.2.2.1. </span>Gnuplot Aggregator Example<a class="headerlink" href="#gnuplot-aggregator-example" title="Link to this heading">¶</a></h6>
<p>An example that exercises the GnuplotAggregator can be found in
<code class="docutils literal notranslate"><span class="pre">src/stats/examples/gnuplot-aggregator-example.cc</span></code>.</p>
<p>The following 2-D gnuplot was created using the example.</p>
<figure class="align-default" id="id3">
<span id="gnuplot-aggregator"></span><img alt="_images/gnuplot-aggregator.png" src="_images/gnuplot-aggregator.png" />
<figcaption>
<p><span class="caption-text">2-D Gnuplot Created by gnuplot-aggregator-example.cc Example.</span><a class="headerlink" href="#id3" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>This code from the example shows how to construct the
GnuplotAggregator as was discussed above.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">Create2dPlot</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">fileNameWithoutExtension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;gnuplot-aggregator&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">plotTitle</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Gnuplot Aggregator Plot&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">plotXAxisHeading</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Time(seconds)&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">plotYAxisHeading</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Double Values&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">plotDatasetLabel</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Data Values&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">datasetContext</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Dataset/Context/String&quot;</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Create an aggregator.</span>
<span class="w">  </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">GnuplotAggregator</span><span class="o">&gt;</span><span class="w"> </span><span class="n">aggregator</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">GnuplotAggregator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">fileNameWithoutExtension</span><span class="p">);</span>
</pre></div>
</div>
<p>Various GnuplotAggregator attributes are set including the 2-D dataset
that will be plotted.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Set the aggregator&#39;s properties.</span>
<span class="n">aggregator</span><span class="o">-&gt;</span><span class="n">SetTerminal</span><span class="p">(</span><span class="s">&quot;png&quot;</span><span class="p">);</span>
<span class="n">aggregator</span><span class="o">-&gt;</span><span class="n">SetTitle</span><span class="p">(</span><span class="n">plotTitle</span><span class="p">);</span>
<span class="n">aggregator</span><span class="o">-&gt;</span><span class="n">SetLegend</span><span class="p">(</span><span class="n">plotXAxisHeading</span><span class="p">,</span><span class="w"> </span><span class="n">plotYAxisHeading</span><span class="p">);</span>

<span class="c1">// Add a data set to the aggregator.</span>
<span class="n">aggregator</span><span class="o">-&gt;</span><span class="n">Add2dDataset</span><span class="p">(</span><span class="n">datasetContext</span><span class="p">,</span><span class="w"> </span><span class="n">plotDatasetLabel</span><span class="p">);</span>

<span class="c1">// aggregator must be turned on</span>
<span class="n">aggregator</span><span class="o">-&gt;</span><span class="n">Enable</span><span class="p">();</span>
</pre></div>
</div>
<p>Next, the 2-D values are calculated, and each one is individually
written to the GnuplotAggregator using the <code class="docutils literal notranslate"><span class="pre">Write2d()</span></code> function.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Create the 2-D dataset.</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-5.0</span><span class="p">;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">+</span><span class="mf">5.0</span><span class="p">;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Calculate the 2-D curve</span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="c1">//                   2</span>
<span class="w">      </span><span class="c1">//     value  =  time   .</span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Add this point to the plot.</span>
<span class="w">      </span><span class="n">aggregator</span><span class="o">-&gt;</span><span class="n">Write2d</span><span class="p">(</span><span class="n">datasetContext</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Disable logging of data for the aggregator.</span>
<span class="w">  </span><span class="n">aggregator</span><span class="o">-&gt;</span><span class="n">Disable</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="fileaggregator">
<h5><span class="section-number">3.4.5.3. </span>FileAggregator<a class="headerlink" href="#fileaggregator" title="Link to this heading">¶</a></h5>
<p>The FileAggregator sends the values it receives to a file.</p>
<p>The FileAggregator can create 4 different types of files:</p>
<ul class="simple">
<li><p>Formatted</p></li>
<li><p>Space separated (the default)</p></li>
<li><p>Comma separated</p></li>
<li><p>Tab separated</p></li>
</ul>
<p>Formatted files use C-style format strings and the sprintf() function
to print their values in the file being written.</p>
<section id="id1">
<h6><span class="section-number">3.4.5.3.1. </span>Creation<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h6>
<p>An object of type FileAggregator will be created here to show what needs
to be done.</p>
<p>One declares a FileAggregator in dynamic memory by using the smart
pointer class (Ptr&lt;T&gt;). To create a FileAggregator in dynamic memory
with smart pointers, one just needs to call the <em>ns-3</em> method
CreateObject.  The following code from
<code class="docutils literal notranslate"><span class="pre">src/stats/examples/file-aggregator-example.cc</span></code> shows how
to do this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">string</span><span class="w"> </span><span class="n">fileName</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;file-aggregator-formatted-values.txt&quot;</span><span class="p">;</span>

<span class="c1">// Create an aggregator that will have formatted values.</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">FileAggregator</span><span class="o">&gt;</span><span class="w"> </span><span class="n">aggregator</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">FileAggregator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="w"> </span><span class="n">FileAggregator</span><span class="o">::</span><span class="n">FORMATTED</span><span class="p">);</span>
</pre></div>
</div>
<p>The first argument for the constructor, filename, is the name of the
file to write; the second argument, fileType, is type of file to
write. This FileAggregator will create a file named
“file-aggregator-formatted-values.txt” with its values printed as
specified by fileType, i.e., formatted in this case.</p>
<p>The following file type enum values are allowed:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="nc">FileType</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">FORMATTED</span><span class="p">,</span>
<span class="w">  </span><span class="n">SPACE_SEPARATED</span><span class="p">,</span>
<span class="w">  </span><span class="n">COMMA_SEPARATED</span><span class="p">,</span>
<span class="w">  </span><span class="n">TAB_SEPARATED</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="id2">
<h6><span class="section-number">3.4.5.3.2. </span>Examples<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h6>
<p>One example will be discussed in detail here:</p>
<ul class="simple">
<li><p>File Aggregator Example</p></li>
</ul>
<section id="file-aggregator-example">
<h6 aria-level="7"><span class="section-number">3.4.5.3.2.1. </span>File Aggregator Example<a class="headerlink" href="#file-aggregator-example" title="Link to this heading">¶</a></h6>
<p>An example that exercises the FileAggregator can be found in
<code class="docutils literal notranslate"><span class="pre">src/stats/examples/file-aggregator-example.cc</span></code>.</p>
<p>The following text file with 2 columns of values separated by commas
was created using the example.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="mi">-5</span><span class="p">,</span><span class="mi">25</span>
<span class="mi">-4</span><span class="p">,</span><span class="mi">16</span>
<span class="mi">-3</span><span class="p">,</span><span class="mi">9</span>
<span class="mi">-2</span><span class="p">,</span><span class="mi">4</span>
<span class="mi">-1</span><span class="p">,</span><span class="mi">1</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
<span class="mi">1</span><span class="p">,</span><span class="mi">1</span>
<span class="mi">2</span><span class="p">,</span><span class="mi">4</span>
<span class="mi">3</span><span class="p">,</span><span class="mi">9</span>
<span class="mi">4</span><span class="p">,</span><span class="mi">16</span>
<span class="mi">5</span><span class="p">,</span><span class="mi">25</span>
</pre></div>
</div>
<p>This code from the example shows how to construct the
FileAggregator as was discussed above.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">CreateCommaSeparatedFile</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">fileName</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;file-aggregator-comma-separated.txt&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">datasetContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Dataset/Context/String&quot;</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Create an aggregator.</span>
<span class="w">  </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">FileAggregator</span><span class="o">&gt;</span><span class="w"> </span><span class="n">aggregator</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">FileAggregator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="w"> </span><span class="n">FileAggregator</span><span class="o">::</span><span class="n">COMMA_SEPARATED</span><span class="p">);</span>
</pre></div>
</div>
<p>FileAggregator attributes are set.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// aggregator must be turned on</span>
<span class="n">aggregator</span><span class="o">-&gt;</span><span class="n">Enable</span><span class="p">();</span>
</pre></div>
</div>
<p>Next, the 2-D values are calculated, and each one is individually
written to the FileAggregator using the <code class="docutils literal notranslate"><span class="pre">Write2d()</span></code> function.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Create the 2-D dataset.</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-5.0</span><span class="p">;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">+</span><span class="mf">5.0</span><span class="p">;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Calculate the 2-D curve</span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="c1">//                   2</span>
<span class="w">      </span><span class="c1">//     value  =  time   .</span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Add this point to the plot.</span>
<span class="w">      </span><span class="n">aggregator</span><span class="o">-&gt;</span><span class="n">Write2d</span><span class="p">(</span><span class="n">datasetContext</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Disable logging of data for the aggregator.</span>
<span class="w">  </span><span class="n">aggregator</span><span class="o">-&gt;</span><span class="n">Disable</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The following text file with 2 columns of formatted values was also
created using the example.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-5.000e+00</span><span class="w">  </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">25</span>
<span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-4.000e+00</span><span class="w">  </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span>
<span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.000e+00</span><span class="w">  </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span>
<span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.000e+00</span><span class="w">  </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>
<span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.000e+00</span><span class="w">  </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.000e+00</span><span class="w">   </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.000e+00</span><span class="w">   </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.000e+00</span><span class="w">   </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span>
<span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.000e+00</span><span class="w">   </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span>
<span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4.000e+00</span><span class="w">   </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span>
<span class="n">Time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.000e+00</span><span class="w">   </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">25</span>
</pre></div>
</div>
<p>This code from the example shows how to construct the
FileAggregator as was discussed above.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">CreateFormattedFile</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">fileName</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;file-aggregator-formatted-values.txt&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">datasetContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Dataset/Context/String&quot;</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Create an aggregator that will have formatted values.</span>
<span class="w">  </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">FileAggregator</span><span class="o">&gt;</span><span class="w"> </span><span class="n">aggregator</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">FileAggregator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="w"> </span><span class="n">FileAggregator</span><span class="o">::</span><span class="n">FORMATTED</span><span class="p">);</span>
</pre></div>
</div>
<p>FileAggregator attributes are set, including the C-style format string
to use.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Set the format for the values.</span>
<span class="n">aggregator</span><span class="o">-&gt;</span><span class="n">Set2dFormat</span><span class="p">(</span><span class="s">&quot;Time = %.3e</span><span class="se">\t</span><span class="s">Value = %.0f&quot;</span><span class="p">);</span>

<span class="c1">// aggregator must be turned on</span>
<span class="n">aggregator</span><span class="o">-&gt;</span><span class="n">Enable</span><span class="p">();</span>
</pre></div>
</div>
<p>Next, the 2-D values are calculated, and each one is individually
written to the FileAggregator using the <code class="docutils literal notranslate"><span class="pre">Write2d()</span></code> function.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Create the 2-D dataset.</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-5.0</span><span class="p">;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">+</span><span class="mf">5.0</span><span class="p">;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Calculate the 2-D curve</span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="c1">//                   2</span>
<span class="w">      </span><span class="c1">//     value  =  time   .</span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Add this point to the plot.</span>
<span class="w">      </span><span class="n">aggregator</span><span class="o">-&gt;</span><span class="n">Write2d</span><span class="p">(</span><span class="n">datasetContext</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Disable logging of data for the aggregator.</span>
<span class="w">  </span><span class="n">aggregator</span><span class="o">-&gt;</span><span class="n">Disable</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>
</section>
<span id="document-adaptor"></span><section id="adaptors">
<h4><span class="section-number">3.4.6. </span>Adaptors<a class="headerlink" href="#adaptors" title="Link to this heading">¶</a></h4>
<p>This section details the functionalities provided by the Adaptor
class to an <em>ns-3</em> simulation. This section is meant for users
interested in developing simulations with the <em>ns-3</em> tools and using
the Data Collection Framework, of which the Adaptor class is a
part, to generate data output with their simulation’s results.</p>
<p>Note:  the term ‘adaptor’ may also be spelled ‘adapter’; we chose
the spelling aligned with the C++ standard.</p>
<section id="adaptor-overview">
<h5><span class="section-number">3.4.6.1. </span>Adaptor Overview<a class="headerlink" href="#adaptor-overview" title="Link to this heading">¶</a></h5>
<p>An Adaptor is used to make connections between different types of DCF
objects.</p>
<p>To date, one Adaptor has been implemented:</p>
<ul class="simple">
<li><p>TimeSeriesAdaptor</p></li>
</ul>
</section>
<section id="time-series-adaptor">
<h5><span class="section-number">3.4.6.2. </span>Time Series Adaptor<a class="headerlink" href="#time-series-adaptor" title="Link to this heading">¶</a></h5>
<p>The TimeSeriesAdaptor lets Probes connect directly to Aggregators
without needing any Collector in between.</p>
<p>Both of the implemented DCF helpers utilize TimeSeriesAdaptors
in order to take probed values of different types and output the
current time plus the value with both converted to doubles.</p>
<p>The role of the TimeSeriesAdaptor class is that of an adaptor, which
takes raw-valued probe data of different types and outputs a tuple of
two double values.  The first is a timestamp, which may be set to
different resolutions (e.g. Seconds, Milliseconds, etc.) in the future
but which is presently hardcoded to Seconds.
The second is the conversion of a non-double
value to a double value (possibly with loss of precision).</p>
</section>
</section>
<span id="document-scope-and-limitations"></span><section id="scope-limitations">
<h4><span class="section-number">3.4.7. </span>Scope/Limitations<a class="headerlink" href="#scope-limitations" title="Link to this heading">¶</a></h4>
<p>This section discusses the scope and limitations of the Data
Collection Framework.</p>
<p>Currently, only these Probes have been implemented in DCF:</p>
<ul class="simple">
<li><p>BooleanProbe</p></li>
<li><p>DoubleProbe</p></li>
<li><p>Uinteger8Probe</p></li>
<li><p>Uinteger16Probe</p></li>
<li><p>Uinteger32Probe</p></li>
<li><p>TimeProbe</p></li>
<li><p>PacketProbe</p></li>
<li><p>ApplicationPacketProbe</p></li>
<li><p>Ipv4PacketProbe</p></li>
</ul>
<p>Currently, no Collectors are available in the DCF, although a
BasicStatsCollector is under development.</p>
<p>Currently, only these Aggregators have been implemented in DCF:</p>
<ul class="simple">
<li><p>GnuplotAggregator</p></li>
<li><p>FileAggregator</p></li>
</ul>
<p>Currently, only this Adaptor has been implemented in DCF:</p>
<p>Time-Series Adaptor.</p>
<section id="future-work">
<h5><span class="section-number">3.4.7.1. </span>Future Work<a class="headerlink" href="#future-work" title="Link to this heading">¶</a></h5>
<p>This section discusses the future work to be done on the Data
Collection Framework.</p>
<p>Here are some things that still need to be done:</p>
<ul class="simple">
<li><p>Hook up more trace sources in <em>ns-3</em> code to get more values out of the simulator.</p></li>
<li><p>Implement more types of Probes than there currently are.</p></li>
<li><p>Implement more than just the single current 2-D Collector, BasicStatsCollector.</p></li>
<li><p>Implement more Aggregators.</p></li>
<li><p>Implement more than just Adaptors.</p></li>
</ul>
</section>
</section>
</div>
</section>
<span id="document-statistics"></span><section id="statistical-framework">
<h3><span class="section-number">3.5. </span>Statistical Framework<a class="headerlink" href="#statistical-framework" title="Link to this heading">¶</a></h3>
<p>This chapter outlines work on simulation data collection and the
statistical framework for ns-3.</p>
<p>The source code for the statistical framework lives in the directory
<code class="docutils literal notranslate"><span class="pre">src/stats</span></code>.</p>
<section id="goals">
<h4><span class="section-number">3.5.1. </span>Goals<a class="headerlink" href="#goals" title="Link to this heading">¶</a></h4>
<p>Primary objectives for this effort are the following:</p>
<ul class="simple">
<li><p>Provide functionality to record, calculate, and present data and statistics for analysis of network simulations.</p></li>
<li><p>Boost simulation performance by reducing the need to generate extensive trace logs in order to collect data.</p></li>
<li><p>Enable simulation control via online statistics, e.g. terminating simulations or repeating trials.</p></li>
</ul>
<p>Derived sub-goals and other target features include the following:</p>
<ul class="simple">
<li><p>Integration with the existing ns-3 tracing system as the basic instrumentation framework of the internal simulation engine, e.g. network stacks, net devices, and channels.</p></li>
<li><p>Enabling users to utilize the statistics framework without requiring use of the tracing system.</p></li>
<li><p>Helping users create, aggregate, and analyze data over multiple trials.</p></li>
<li><p>Support for user created instrumentation, e.g. of application specific events and measures.</p></li>
<li><p>Low memory and CPU overhead when the package is not in use.</p></li>
<li><p>Leveraging existing analysis and output tools as much as possible.  The framework may provide some basic statistics, but the focus is on collecting data and making it accessible for manipulation in established tools.</p></li>
<li><p>Eventual support for distributing independent replications is important but not included in the first round of features.</p></li>
</ul>
</section>
<section id="overview">
<h4><span class="section-number">3.5.2. </span>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h4>
<p>The statistics framework includes the following features:</p>
<ul class="simple">
<li><p>The core framework and two basic data collectors: A counter, and a min/max/avg/total observer.</p></li>
<li><p>Extensions of those to easily work with times and packets.</p></li>
<li><p>Plaintext output formatted for <a class="reference external" href="http://www.omnetpp.org">OMNet++</a>.</p></li>
<li><p>Database output using <a class="reference external" href="http://www.sqlite.org">SQLite</a>, a standalone, lightweight, high performance SQL engine.</p></li>
<li><p>Mandatory and open ended metadata for describing and working with runs.</p></li>
<li><p>An example based on the notional experiment of examining the properties of NS-3’s default ad hoc WiFi performance.  It incorporates the following:</p>
<ul>
<li><p>Constructs of a two node ad hoc WiFi network, with the nodes a parameterized distance apart.</p></li>
<li><p>UDP traffic source and sink applications with slightly different behavior and measurement hooks than the stock classes.</p></li>
<li><p>Data collection from the NS-3 core via existing trace signals, in particular data on frames transmitted and received by the WiFi MAC objects.</p></li>
<li><p>Instrumentation of custom applications by connecting new trace signals to the stat framework, as well as via direct updates.  Information is recorded about total packets sent and received, bytes transmitted, and end-to-end delay.</p></li>
<li><p>An example of using packet tags to track end-to-end delay.</p></li>
<li><p>A simple control script which runs a number of trials of the experiment at varying distances and queries the resulting database to produce a graph using GNUPlot.</p></li>
</ul>
</li>
</ul>
</section>
<section id="to-do">
<h4><span class="section-number">3.5.3. </span>To-Do<a class="headerlink" href="#to-do" title="Link to this heading">¶</a></h4>
<p>High priority items include:</p>
<ul class="simple">
<li><p>Inclusion of online statistics code, e.g. for memory efficient confidence intervals.</p></li>
<li><p>Provisions in the data collectors for terminating runs, i.e. when a threshold or confidence is met.</p></li>
<li><p>Data collectors for logging samples over time, and output to the various formats.</p></li>
<li><p>Demonstrate writing simple cyclic event glue to regularly poll some value.</p></li>
</ul>
<p>Each of those should prove straightforward to incorporate in the current framework.</p>
</section>
<section id="approach">
<h4><span class="section-number">3.5.4. </span>Approach<a class="headerlink" href="#approach" title="Link to this heading">¶</a></h4>
<p>The framework is based around the following core principles:</p>
<ul class="simple">
<li><p>One experiment trial is conducted by one instance of a simulation program, whether in parallel or serially.</p></li>
<li><p>A control script executes instances of the simulation, varying parameters as necessary.</p></li>
<li><p>Data is collected and stored for plotting and analysis using external scripts and existing tools.</p></li>
<li><p>Measures within the ns-3 core are taken by connecting the stat framework to existing trace signals.</p></li>
<li><p>Trace signals or direct manipulation of the framework may be used to instrument custom simulation code.</p></li>
</ul>
<p>Those basic components of the framework and their interactions are depicted in the following figure.</p>
<img alt="_images/Stat-framework-arch.png" src="_images/Stat-framework-arch.png" />
</section>
<section id="example">
<h4><span class="section-number">3.5.5. </span>Example<a class="headerlink" href="#example" title="Link to this heading">¶</a></h4>
<p>This section goes through the process of constructing an experiment in the framework and producing data for analysis (graphs) from it, demonstrating the structure and API along the way.</p>
<section id="question">
<h5><span class="section-number">3.5.5.1. </span>Question<a class="headerlink" href="#question" title="Link to this heading">¶</a></h5>
<p>‘’What is the (simulated) performance of ns-3’s WiFi NetDevices (using the default settings)?  How far apart can wireless nodes be in a simulation before they cannot communicate reliably?’’</p>
<ul class="simple">
<li><p>Hypothesis: Based on knowledge of real life performance, the nodes should communicate reasonably well to at least 100m apart.  Communication beyond 200m shouldn’t be feasible.</p></li>
</ul>
<p>Although not a very common question in simulation contexts, this is an important property of which simulation developers should have a basic understanding.  It is also a common study done on live hardware.</p>
</section>
<section id="simulation-program">
<h5><span class="section-number">3.5.5.2. </span>Simulation Program<a class="headerlink" href="#simulation-program" title="Link to this heading">¶</a></h5>
<p>The first thing to do in implementing this experiment is developing the simulation program.  The code for this example can be found in <code class="docutils literal notranslate"><span class="pre">examples/stats/wifi-example-sim.cc</span></code>.  It does the following main steps.</p>
<ul>
<li><p>Declaring parameters and parsing the command line using <code class="docutils literal notranslate"><span class="pre">ns3::CommandLine</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">50.0</span><span class="p">;</span>
<span class="n">string</span><span class="w"> </span><span class="n">format</span><span class="p">(</span><span class="s">&quot;OMNet++&quot;</span><span class="p">);</span>
<span class="n">string</span><span class="w"> </span><span class="n">experiment</span><span class="p">(</span><span class="s">&quot;wifi-distance-test&quot;</span><span class="p">);</span>
<span class="n">string</span><span class="w"> </span><span class="n">strategy</span><span class="p">(</span><span class="s">&quot;wifi-default&quot;</span><span class="p">);</span>
<span class="n">string</span><span class="w"> </span><span class="n">runID</span><span class="p">;</span>

<span class="n">CommandLine</span><span class="w"> </span><span class="nf">cmd</span><span class="p">(</span><span class="n">__FILE__</span><span class="p">);</span>
<span class="n">cmd</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">&quot;distance&quot;</span><span class="p">,</span><span class="w">   </span><span class="s">&quot;Distance apart to place nodes(in meters).&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">distance</span><span class="p">);</span>
<span class="n">cmd</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">&quot;format&quot;</span><span class="p">,</span><span class="w">     </span><span class="s">&quot;Format to use for data output.&quot;</span><span class="p">,</span><span class="w">             </span><span class="n">format</span><span class="p">);</span>
<span class="n">cmd</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">&quot;experiment&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Identifier for experiment.&quot;</span><span class="p">,</span><span class="w">                 </span><span class="n">experiment</span><span class="p">);</span>
<span class="n">cmd</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">&quot;strategy&quot;</span><span class="p">,</span><span class="w">   </span><span class="s">&quot;Identifier for strategy.&quot;</span><span class="p">,</span><span class="w">                   </span><span class="n">strategy</span><span class="p">);</span>
<span class="n">cmd</span><span class="p">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s">&quot;run&quot;</span><span class="p">,</span><span class="w">        </span><span class="s">&quot;Identifier for run.&quot;</span><span class="p">,</span><span class="w">                        </span><span class="n">runID</span><span class="p">);</span>
<span class="n">cmd</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Creating nodes and network stacks using <code class="docutils literal notranslate"><span class="pre">ns3::NodeContainer</span></code>, <code class="docutils literal notranslate"><span class="pre">ns3::WiFiHelper</span></code>, and <code class="docutils literal notranslate"><span class="pre">ns3::InternetStackHelper</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NodeContainer</span><span class="w"> </span><span class="n">nodes</span><span class="p">;</span>
<span class="n">nodes</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="n">WifiHelper</span><span class="w"> </span><span class="n">wifi</span><span class="p">;</span>
<span class="n">wifi</span><span class="p">.</span><span class="n">SetMac</span><span class="p">(</span><span class="s">&quot;ns3::AdhocWifiMac&quot;</span><span class="p">);</span>
<span class="n">wifi</span><span class="p">.</span><span class="n">SetPhy</span><span class="p">(</span><span class="s">&quot;ns3::WifiPhy&quot;</span><span class="p">);</span>
<span class="n">NetDeviceContainer</span><span class="w"> </span><span class="n">nodeDevices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wifi</span><span class="p">.</span><span class="n">Install</span><span class="p">(</span><span class="n">nodes</span><span class="p">);</span>

<span class="n">InternetStackHelper</span><span class="w"> </span><span class="n">internet</span><span class="p">;</span>
<span class="n">internet</span><span class="p">.</span><span class="n">Install</span><span class="p">(</span><span class="n">nodes</span><span class="p">);</span>
<span class="n">Ipv4AddressHelper</span><span class="w"> </span><span class="n">ipAddrs</span><span class="p">;</span>
<span class="n">ipAddrs</span><span class="p">.</span><span class="n">SetBase</span><span class="p">(</span><span class="s">&quot;192.168.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;255.255.255.0&quot;</span><span class="p">);</span>
<span class="n">ipAddrs</span><span class="p">.</span><span class="n">Assign</span><span class="p">(</span><span class="n">nodeDevices</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Positioning the nodes using <code class="docutils literal notranslate"><span class="pre">ns3::MobilityHelper</span></code>.  By default the nodes have static mobility and won’t move, but must be positioned the given distance apart.  There are several ways to do this; it is done here using <code class="docutils literal notranslate"><span class="pre">ns3::ListPositionAllocator</span></code>, which draws positions from a given list.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">MobilityHelper</span><span class="w"> </span><span class="n">mobility</span><span class="p">;</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">ListPositionAllocator</span><span class="o">&gt;</span><span class="w"> </span><span class="n">positionAlloc</span><span class="w"> </span><span class="o">=</span>
<span class="w">  </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">ListPositionAllocator</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">positionAlloc</span><span class="o">-&gt;</span><span class="n">Add</span><span class="p">(</span><span class="n">Vector</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">));</span>
<span class="n">positionAlloc</span><span class="o">-&gt;</span><span class="n">Add</span><span class="p">(</span><span class="n">Vector</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">distance</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">));</span>
<span class="n">mobility</span><span class="p">.</span><span class="n">SetPositionAllocator</span><span class="p">(</span><span class="n">positionAlloc</span><span class="p">);</span>
<span class="n">mobility</span><span class="p">.</span><span class="n">Install</span><span class="p">(</span><span class="n">nodes</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Installing a traffic generator and a traffic sink.  The stock <code class="docutils literal notranslate"><span class="pre">Applications</span></code> could be used, but the example includes custom objects in <code class="docutils literal notranslate"><span class="pre">src/test/test02-apps.(cc|h)</span></code>.  These have a simple behavior, generating a given number of packets spaced at a given interval.  As there is only one of each they are installed manually; for a larger set the <code class="docutils literal notranslate"><span class="pre">ns3::ApplicationHelper</span></code> class could be used.  The commented-out <code class="docutils literal notranslate"><span class="pre">Config::Set</span></code> line changes the destination of the packets, set to broadcast by default in this example.  Note that in general WiFi may have different performance for broadcast and unicast frames due to different rate control and MAC retransmission policies.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">appSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NodeList</span><span class="o">::</span><span class="n">GetNode</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Sender</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">Sender</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">appSource</span><span class="o">-&gt;</span><span class="n">AddApplication</span><span class="p">(</span><span class="n">sender</span><span class="p">);</span>
<span class="n">sender</span><span class="o">-&gt;</span><span class="n">Start</span><span class="p">(</span><span class="n">Seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span><span class="w"> </span><span class="n">appSink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NodeList</span><span class="o">::</span><span class="n">GetNode</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Receiver</span><span class="o">&gt;</span><span class="w"> </span><span class="n">receiver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">Receiver</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">appSink</span><span class="o">-&gt;</span><span class="n">AddApplication</span><span class="p">(</span><span class="n">receiver</span><span class="p">);</span>
<span class="n">receiver</span><span class="o">-&gt;</span><span class="n">Start</span><span class="p">(</span><span class="n">Seconds</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

<span class="c1">//  Config::Set(&quot;/NodeList/*/ApplicationList/*/$Sender/Destination&quot;,</span>
<span class="c1">//              Ipv4AddressValue(&quot;192.168.0.2&quot;));</span>
</pre></div>
</div>
</li>
<li><p>Configuring the data and statistics to be collected.  The basic paradigm is that an <code class="docutils literal notranslate"><span class="pre">ns3::DataCollector</span></code> object is created to hold information about this particular run, to which observers and calculators are attached to actually generate data.  Importantly, run information includes labels for the ‘’experiment’’, ‘’strategy’’, ‘’input’’, and ‘’run’’.  These are used to later identify and easily group data from multiple trials.</p>
<ul class="simple">
<li><p>The experiment is the study of which this trial is a member.  Here it is on WiFi performance and distance.</p></li>
<li><p>The strategy is the code or parameters being examined in this trial.  In this example it is fixed, but an obvious extension would be to investigate different WiFi bit rates, each of which would be a different strategy.</p></li>
<li><p>The input is the particular problem given to this trial.  Here it is simply the distance between the two nodes.</p></li>
<li><p>The runID is a unique identifier for this trial with which it’s information is tagged for identification in later analysis.  If no run ID is given the example program makes a (weak) run ID using the current time.</p></li>
</ul>
<p>Those four pieces of metadata are required, but more may be desired.  They may be added to the record using the <code class="docutils literal notranslate"><span class="pre">ns3::DataCollector::AddMetadata()</span></code> method.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">DataCollector</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="n">data</span><span class="p">.</span><span class="n">DescribeRun</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span><span class="w"> </span><span class="n">strategy</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">runID</span><span class="p">);</span>
<span class="n">data</span><span class="p">.</span><span class="n">AddMetadata</span><span class="p">(</span><span class="s">&quot;author&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tjkopena&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Actual observation and calculating is done by <code class="docutils literal notranslate"><span class="pre">ns3::DataCalculator</span></code> objects, of which several different types exist.  These are created by the simulation program, attached to reporting or sampling code, and then registered with the <code class="docutils literal notranslate"><span class="pre">ns3::DataCollector</span></code> so they will be queried later for their output.  One easy observation mechanism is to use existing trace sources, for example to instrument objects in the ns-3 core without changing their code.  Here a counter is attached directly to a trace signal in the WiFi MAC layer on the target node.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">PacketCounterCalculator</span><span class="o">&gt;</span><span class="w"> </span><span class="n">totalRx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">PacketCounterCalculator</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">totalRx</span><span class="o">-&gt;</span><span class="n">SetKey</span><span class="p">(</span><span class="s">&quot;wifi-rx-frames&quot;</span><span class="p">);</span>
<span class="n">Config</span><span class="o">::</span><span class="n">Connect</span><span class="p">(</span><span class="s">&quot;/NodeList/1/DeviceList/*/$ns3::WifiNetDevice/Rx&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">MakeCallback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PacketCounterCalculator</span><span class="o">::</span><span class="n">FrameUpdate</span><span class="p">,</span><span class="w"> </span><span class="n">totalRx</span><span class="p">));</span>
<span class="n">data</span><span class="p">.</span><span class="n">AddDataCalculator</span><span class="p">(</span><span class="n">totalRx</span><span class="p">);</span>
</pre></div>
</div>
<p>Calculators may also be manipulated directly.  In this example, a counter is created and passed to the traffic sink application to be updated when packets are received.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">CounterCalculator</span><span class="o">&lt;&gt;&gt;</span><span class="w"> </span><span class="n">appRx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">CounterCalculator</span><span class="o">&lt;&gt;&gt;</span><span class="p">();</span>
<span class="n">appRx</span><span class="o">-&gt;</span><span class="n">SetKey</span><span class="p">(</span><span class="s">&quot;receiver-rx-packets&quot;</span><span class="p">);</span>
<span class="n">receiver</span><span class="o">-&gt;</span><span class="n">SetCounter</span><span class="p">(</span><span class="n">appRx</span><span class="p">);</span>
<span class="n">data</span><span class="p">.</span><span class="n">AddDataCalculator</span><span class="p">(</span><span class="n">appRx</span><span class="p">);</span>
</pre></div>
</div>
<p>To increment the count, the sink’s packet processing code then calls one of the calculator’s update methods.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">m_calc</span><span class="o">-&gt;</span><span class="n">Update</span><span class="p">();</span>
</pre></div>
</div>
<p>The program includes several other examples as well, using both the primitive calculators such as <code class="docutils literal notranslate"><span class="pre">ns3::CounterCalculator</span></code> and those adapted for observing packets and times.  In <code class="docutils literal notranslate"><span class="pre">src/test/test02-apps.(cc|h)</span></code> it also creates a simple custom tag which it uses to track end-to-end delay for generated packets, reporting results to a <code class="docutils literal notranslate"><span class="pre">ns3::TimeMinMaxAvgTotalCalculator</span></code> data calculator.</p>
</li>
<li><p>Running the simulation, which is very straightforward once constructed.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Simulator</span><span class="o">::</span><span class="n">Run</span><span class="p">();</span>
</pre></div>
</div>
</li>
<li><p>Generating either <a class="reference external" href="http://www.omnetpp.org">OMNet++</a> or <a class="reference external" href="http://www.sqlite.org">SQLite</a> output, depending on the command line arguments.  To do this a <code class="docutils literal notranslate"><span class="pre">ns3::DataOutputInterface</span></code> object is created and configured.  The specific type of this will determine the output format.  This object is then given the <code class="docutils literal notranslate"><span class="pre">ns3::DataCollector</span></code> object which it interrogates to produce the output.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">DataOutputInterface</span><span class="o">&gt;</span><span class="w"> </span><span class="n">output</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">format</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;OMNet++&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">NS_LOG_INFO</span><span class="p">(</span><span class="s">&quot;Creating OMNet++ formatted data output.&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">OmnetDataOutput</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="cp">#   ifdef STAT_USE_DB</span>
<span class="w">    </span><span class="n">NS_LOG_INFO</span><span class="p">(</span><span class="s">&quot;Creating SQLite formatted data output.&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="o">&lt;</span><span class="n">SqliteDataOutput</span><span class="o">&gt;</span><span class="p">();</span>
<span class="cp">#   endif</span>
<span class="p">}</span>

<span class="n">output</span><span class="o">-&gt;</span><span class="n">Output</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Freeing any memory used by the simulation.  This should come at the end of the main function for the example.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Simulator</span><span class="o">::</span><span class="n">Destroy</span><span class="p">();</span>
</pre></div>
</div>
</li>
</ul>
<section id="logging">
<h6><span class="section-number">3.5.5.2.1. </span>Logging<a class="headerlink" href="#logging" title="Link to this heading">¶</a></h6>
<p>To see what the example program, applications, and stat framework are doing in detail, set the <code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code> variable appropriately.  The following will provide copious output from all three.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span>WiFiDistanceExperiment:WiFiDistanceApps
</pre></div>
</div>
<p>Note that this slows down the simulation extraordinarily.</p>
</section>
<section id="sample-output">
<h6><span class="section-number">3.5.5.2.2. </span>Sample Output<a class="headerlink" href="#sample-output" title="Link to this heading">¶</a></h6>
<p>Compiling and simply running the test program will append <a class="reference external" href="http://www.omnetpp.org">OMNet++</a> formatted output such as the following to <code class="docutils literal notranslate"><span class="pre">data.sca</span></code>.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>run run-1212239121

attr experiment &quot;wifi-distance-test&quot;
attr strategy &quot;wifi-default&quot;
attr input &quot;50&quot;
attr description &quot;&quot;

attr &quot;author&quot; &quot;tjkopena&quot;

scalar wifi-tx-frames count 30
scalar wifi-rx-frames count 30
scalar sender-tx-packets count 30
scalar receiver-rx-packets count 30
scalar tx-pkt-size count 30
scalar tx-pkt-size total 1920
scalar tx-pkt-size average 64
scalar tx-pkt-size max 64
scalar tx-pkt-size min 64
scalar delay count 30
scalar delay total 5884980ns
scalar delay average 196166ns
scalar delay max 196166ns
scalar delay min 196166ns
</pre></div>
</div>
</section>
</section>
<section id="control-script">
<h5><span class="section-number">3.5.5.3. </span>Control Script<a class="headerlink" href="#control-script" title="Link to this heading">¶</a></h5>
<p>In order to automate data collection at a variety of inputs (distances), a simple Bash script is used to execute a series of simulations.  It can be found at <code class="docutils literal notranslate"><span class="pre">examples/stats/wifi-example-db.sh</span></code>.  The script is meant to be run from the <code class="docutils literal notranslate"><span class="pre">examples/stats/</span></code> directory.</p>
<p>The script runs through a set of distances, collecting the results into an <a class="reference external" href="http://www.sqlite.org">SQLite</a> database.  At each distance five trials are conducted to give a better picture of expected performance.  The entire experiment takes only a few dozen seconds to run on a low end machine as there is no output during the simulation and little traffic is generated.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="nv">DISTANCES</span><span class="o">=</span><span class="s2">&quot;25 50 75 100 125 145 147 150 152 155 157 160 162 165 167 170 172 175 177 180&quot;</span>
<span class="nv">TRIALS</span><span class="o">=</span><span class="s2">&quot;1 2 3 4 5&quot;</span>

<span class="nb">echo</span><span class="w"> </span>WiFi<span class="w"> </span>Experiment<span class="w"> </span>Example

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-e<span class="w"> </span>data.db<span class="w"> </span><span class="o">]</span>
<span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span>Kill<span class="w"> </span>data.db?
<span class="w">  </span><span class="nb">read</span><span class="w"> </span>ANS
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ANS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="w"> </span>-o<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ANS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;y&quot;</span><span class="w"> </span><span class="o">]</span>
<span class="w">  </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>Deleting<span class="w"> </span>database
<span class="w">    </span>rm<span class="w"> </span>data.db
<span class="w">  </span><span class="k">fi</span>
<span class="k">fi</span>

<span class="k">for</span><span class="w"> </span>trial<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$TRIALS</span>
<span class="k">do</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span>distance<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$DISTANCES</span>
<span class="w">  </span><span class="k">do</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span>Trial<span class="w"> </span><span class="nv">$trial</span>,<span class="w"> </span>distance<span class="w"> </span><span class="nv">$distance</span>
<span class="w">    </span>./bin/test02<span class="w"> </span>--format<span class="o">=</span>db<span class="w"> </span>--distance<span class="o">=</span><span class="nv">$distance</span><span class="w"> </span>--run<span class="o">=</span>run-<span class="nv">$distance</span>-<span class="nv">$trial</span>
<span class="w">  </span><span class="k">done</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="analysis-and-conclusion">
<h5><span class="section-number">3.5.5.4. </span>Analysis and Conclusion<a class="headerlink" href="#analysis-and-conclusion" title="Link to this heading">¶</a></h5>
<p>Once all trials have been conducted, the script executes a simple SQL query over the database using the <a class="reference external" href="http://www.sqlite.org">SQLite</a> command line program.  The query computes average packet loss in each set of trials associated with each distance.  It does not take into account different strategies, but the information is present in the database to make some simple extensions and do so.  The collected data is then passed to GNUPlot for graphing.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">CMD</span><span class="o">=</span><span class="ss">&quot;select exp.input,avg(100-((rx.value*100)/tx.value)) \</span>
<span class="ss">    from Singletons rx, Singletons tx, Experiments exp \</span>
<span class="ss">    where rx.run = tx.run AND \</span>
<span class="ss">          rx.run = exp.run AND \</span>
<span class="ss">          rx.name=&#39;receiver-rx-packets&#39; AND \</span>
<span class="ss">          tx.name=&#39;sender-tx-packets&#39; \</span>
<span class="ss">    group by exp.input \</span>
<span class="ss">    order by abs(exp.input) ASC;&quot;</span>

<span class="n">sqlite3</span><span class="w"> </span><span class="o">-</span><span class="n">noheader</span><span class="w"> </span><span class="k">data</span><span class="p">.</span><span class="n">db</span><span class="w"> </span><span class="ss">&quot;$CMD&quot;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">wifi</span><span class="o">-</span><span class="k">default</span><span class="p">.</span><span class="k">data</span>
<span class="n">sed</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="ss">&quot;s/|/   /&quot;</span><span class="w"> </span><span class="n">wifi</span><span class="o">-</span><span class="k">default</span><span class="p">.</span><span class="k">data</span>
<span class="n">gnuplot</span><span class="w"> </span><span class="n">wifi</span><span class="o">-</span><span class="n">example</span><span class="p">.</span><span class="n">gnuplot</span>
</pre></div>
</div>
<p>The GNUPlot script found at <code class="docutils literal notranslate"><span class="pre">examples/stats/wifi-example.gnuplot</span></code> simply defines the output format and some basic formatting for the graph.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="w"> </span>terminal<span class="w"> </span>postscript<span class="w"> </span>portrait<span class="w"> </span>enhanced<span class="w"> </span>lw<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="s2">&quot;Helvetica&quot;</span><span class="w"> </span><span class="m">14</span>

<span class="nb">set</span><span class="w"> </span>size<span class="w"> </span><span class="m">1</span>.0,<span class="w"> </span><span class="m">0</span>.66

<span class="c1">#-------------------------------------------------------</span>
<span class="nb">set</span><span class="w"> </span>out<span class="w"> </span><span class="s2">&quot;wifi-default.eps&quot;</span>
<span class="c1">#set title &quot;Packet Loss Over Distance&quot;</span>
<span class="nb">set</span><span class="w"> </span>xlabel<span class="w"> </span><span class="s2">&quot;Distance (m) --- average of 5 trials per point&quot;</span>
<span class="nb">set</span><span class="w"> </span>xrange<span class="w"> </span><span class="o">[</span><span class="m">0</span>:200<span class="o">]</span>
<span class="nb">set</span><span class="w"> </span>ylabel<span class="w"> </span><span class="s2">&quot;% Packet Loss&quot;</span>
<span class="nb">set</span><span class="w"> </span>yrange<span class="w"> </span><span class="o">[</span><span class="m">0</span>:110<span class="o">]</span>

plot<span class="w"> </span><span class="s2">&quot;wifi-default.data&quot;</span><span class="w"> </span>with<span class="w"> </span>lines<span class="w"> </span>title<span class="w"> </span><span class="s2">&quot;WiFi Defaults&quot;</span>
</pre></div>
</div>
<section id="end-result">
<h6><span class="section-number">3.5.5.4.1. </span>End Result<a class="headerlink" href="#end-result" title="Link to this heading">¶</a></h6>
<p>The resulting graph provides no evidence that the default WiFi model’s performance is necessarily unreasonable and lends some confidence to an at least token faithfulness to reality.  More importantly, this simple investigation has been carried all the way through using the statistical framework.  Success!</p>
<img alt="_images/Wifi-default.png" src="_images/Wifi-default.png" />
</section>
</section>
</section>
</section>
<span id="document-helpers"></span><section id="helpers">
<h3><span class="section-number">3.6. </span>Helpers<a class="headerlink" href="#helpers" title="Link to this heading">¶</a></h3>
<p>The above chapters introduced you to various <em>ns-3</em> programming concepts such as
smart pointers for reference-counted memory management, attributes, namespaces,
callbacks, etc. Users who work at this low-level API can interconnect <em>ns-3</em>
objects with fine granularity. However, a simulation program written entirely
using the low-level API would be quite long and tedious to code. For this
reason, a separate so-called “helper API” has been overlaid on the core <em>ns-3</em>
API. If you have read the <em>ns-3</em> tutorial, you will already be familiar with the
helper API, since it is the API that new users are typically introduced to
first.  In this chapter, we introduce the design philosophy of the helper API
and contrast it to the low-level API. If you become a heavy user of <em>ns-3</em>, you
will likely move back and forth between these APIs even in the same program.</p>
<p>The helper API has a few goals:</p>
<ol class="arabic simple">
<li><p>the rest of <code class="docutils literal notranslate"><span class="pre">src/</span></code> has no dependencies on the helper API; anything that can
be done with the helper API can be coded also at the low-level API</p></li>
<li><p><strong>Containers:</strong> Often simulations will need to do a number of identical
actions to groups of objects. The helper API makes heavy use of containers of
similar objects to which similar or identical operations can be performed.</p></li>
<li><p>The helper API is not generic; it does not strive to maximize code reuse. So,
programming constructs such as polymorphism and templates that achieve code
reuse are not as prevalent. For instance, there are separate CsmaNetDevice
helpers and PointToPointNetDevice helpers but they do not derive from a
common NetDevice base class.</p></li>
<li><p>The helper API typically works with stack-allocated (vs. heap-allocated)
objects. For some programs, <em>ns-3</em> users may not need to worry about any low
level Object Create or Ptr handling; they can make do with containers of
objects and stack-allocated helpers that operate on them.</p></li>
</ol>
<p>The helper API is really all about making <em>ns-3</em> programs easier to write and
read, without taking away the power of the low-level interface. The rest of this
chapter provides some examples of the programming conventions of the helper API.</p>
</section>
<span id="document-gnuplot"></span><section id="making-plots-using-the-gnuplot-class">
<h3><span class="section-number">3.7. </span>Making Plots using the Gnuplot Class<a class="headerlink" href="#making-plots-using-the-gnuplot-class" title="Link to this heading">¶</a></h3>
<p>There are 2 common methods to make a plot using <em>ns-3</em> and gnuplot (<a class="reference external" href="http://www.gnuplot.info">http://www.gnuplot.info</a>):</p>
<ol class="arabic simple">
<li><p>Create a gnuplot control file using <em>ns-3</em>’s Gnuplot class.</p></li>
<li><p>Create a gnuplot data file using values generated by <em>ns-3</em>.</p></li>
</ol>
<p>This section is about method 1, i.e. it is about how to make a plot using <em>ns-3</em>’s Gnuplot class.  If you are interested in method 2, see the “A Real Example” subsection under the “Tracing” section in the <em>ns-3</em> <a class="reference external" href="https://www.nsnam.org/docs/tutorial/html/index.html">Tutorial</a>.</p>
<section id="creating-plots-using-the-gnuplot-class">
<h4><span class="section-number">3.7.1. </span>Creating Plots Using the Gnuplot Class<a class="headerlink" href="#creating-plots-using-the-gnuplot-class" title="Link to this heading">¶</a></h4>
<p>The following steps must be taken in order to create a plot using <em>ns-3</em>’s Gnuplot class:</p>
<ol class="arabic simple">
<li><p>Modify your code so that is uses the Gnuplot class and its functions.</p></li>
<li><p>Run your code so that it creates a gnuplot control file.</p></li>
<li><p>Call gnuplot with the name of the gnuplot control file.</p></li>
<li><p>View the graphics file that was produced in your favorite graphics viewer.</p></li>
</ol>
<p>See the code from the example plots that are discussed below for details on step 1.</p>
</section>
<section id="an-example-program-that-uses-the-gnuplot-class">
<h4><span class="section-number">3.7.2. </span>An Example Program that Uses the Gnuplot Class<a class="headerlink" href="#an-example-program-that-uses-the-gnuplot-class" title="Link to this heading">¶</a></h4>
<p>An example program that uses <em>ns-3</em>’s Gnuplot class can be found here:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>src/stats/examples/gnuplot-example.cc
</pre></div>
</div>
<p>In order to run this example, do the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>src/stats/examples/gnuplot-example
</pre></div>
</div>
<p>This should produce the following gnuplot control files:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>plot-2d.plt
plot-2d-with-error-bars.plt
plot-3d.plt
</pre></div>
</div>
<p>In order to process these gnuplot control files, do the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>gnuplot<span class="w"> </span>plot-2d.plt
$<span class="w"> </span>gnuplot<span class="w"> </span>plot-2d-with-error-bars.plt
$<span class="w"> </span>gnuplot<span class="w"> </span>plot-3d.plt
</pre></div>
</div>
<p>This should produce the following graphics files:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>plot-2d.png
plot-2d-with-error-bars.png
plot-3d.png
</pre></div>
</div>
<p>You can view these graphics files in your favorite graphics viewer.  If you have gimp installed on your machine, for example, you can do this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>gimp<span class="w"> </span>plot-2d.png
$<span class="w"> </span>gimp<span class="w"> </span>plot-2d-with-error-bars.png
$<span class="w"> </span>gimp<span class="w"> </span>plot-3d.png
</pre></div>
</div>
</section>
<section id="an-example-2-dimensional-plot">
<h4><span class="section-number">3.7.3. </span>An Example 2-Dimensional Plot<a class="headerlink" href="#an-example-2-dimensional-plot" title="Link to this heading">¶</a></h4>
<p>The following 2-Dimensional plot</p>
<figure class="align-default" id="plot-2d">
<img alt="_images/plot-2d.png" src="_images/plot-2d.png" />
</figure>
<p>was created using the following code from gnuplot-example.cc:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">fileNameWithNoExtension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;plot-2d&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">graphicsFileName</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">fileNameWithNoExtension</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.png&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">plotFileName</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="n">fileNameWithNoExtension</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.plt&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">plotTitle</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;2-D Plot&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">dataTitle</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;2-D Data&quot;</span><span class="p">;</span>

<span class="c1">// Instantiate the plot and set its title.</span>
<span class="n">Gnuplot</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="n">graphicsFileName</span><span class="p">);</span>
<span class="n">plot</span><span class="p">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="n">plotTitle</span><span class="p">);</span>

<span class="c1">// Make the graphics file, which the plot file will create when it</span>
<span class="c1">// is used with Gnuplot, be a PNG file.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">SetTerminal</span><span class="p">(</span><span class="s">&quot;png&quot;</span><span class="p">);</span>

<span class="c1">// Set the labels for each axis.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">SetLegend</span><span class="p">(</span><span class="s">&quot;X Values&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Y Values&quot;</span><span class="p">);</span>

<span class="c1">// Set the range for the x axis.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">AppendExtra</span><span class="p">(</span><span class="s">&quot;set xrange [-6:+6]&quot;</span><span class="p">);</span>

<span class="c1">// Instantiate the dataset, set its title, and make the points be</span>
<span class="c1">// plotted along with connecting lines.</span>
<span class="n">Gnuplot2dDataset</span><span class="w"> </span><span class="n">dataset</span><span class="p">;</span>
<span class="n">dataset</span><span class="p">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="n">dataTitle</span><span class="p">);</span>
<span class="n">dataset</span><span class="p">.</span><span class="n">SetStyle</span><span class="p">(</span><span class="n">Gnuplot2dDataset</span><span class="o">::</span><span class="n">LINES_POINTS</span><span class="p">);</span>

<span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>

<span class="c1">// Create the 2-D dataset.</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-5.0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">+</span><span class="mf">5.0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Calculate the 2-D curve</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">//            2</span>
<span class="w">    </span><span class="c1">//     y  =  x   .</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Add this point.</span>
<span class="w">    </span><span class="n">dataset</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">// Add the dataset to the plot.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">AddDataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">);</span>

<span class="c1">// Open the plot file.</span>
<span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="w"> </span><span class="nf">plotFile</span><span class="p">(</span><span class="n">plotFileName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

<span class="c1">// Write the plot file.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">GenerateOutput</span><span class="p">(</span><span class="n">plotFile</span><span class="p">);</span>

<span class="c1">// Close the plot file.</span>
<span class="n">plotFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="an-example-2-dimensional-plot-with-error-bars">
<h4><span class="section-number">3.7.4. </span>An Example 2-Dimensional Plot with Error Bars<a class="headerlink" href="#an-example-2-dimensional-plot-with-error-bars" title="Link to this heading">¶</a></h4>
<p>The following 2-Dimensional plot with error bars in the x and y directions</p>
<figure class="align-default" id="plot-2d-with-error-bars">
<img alt="_images/plot-2d-with-error-bars.png" src="_images/plot-2d-with-error-bars.png" />
</figure>
<p>was created using the following code from gnuplot-example.cc:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">fileNameWithNoExtension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;plot-2d-with-error-bars&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">graphicsFileName</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">fileNameWithNoExtension</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.png&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">plotFileName</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="n">fileNameWithNoExtension</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.plt&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">plotTitle</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;2-D Plot With Error Bars&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">dataTitle</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;2-D Data With Error Bars&quot;</span><span class="p">;</span>

<span class="c1">// Instantiate the plot and set its title.</span>
<span class="n">Gnuplot</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="n">graphicsFileName</span><span class="p">);</span>
<span class="n">plot</span><span class="p">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="n">plotTitle</span><span class="p">);</span>

<span class="c1">// Make the graphics file, which the plot file will create when it</span>
<span class="c1">// is used with Gnuplot, be a PNG file.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">SetTerminal</span><span class="p">(</span><span class="s">&quot;png&quot;</span><span class="p">);</span>

<span class="c1">// Set the labels for each axis.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">SetLegend</span><span class="p">(</span><span class="s">&quot;X Values&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Y Values&quot;</span><span class="p">);</span>

<span class="c1">// Set the range for the x axis.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">AppendExtra</span><span class="p">(</span><span class="s">&quot;set xrange [-6:+6]&quot;</span><span class="p">);</span>

<span class="c1">// Instantiate the dataset, set its title, and make the points be</span>
<span class="c1">// plotted with no connecting lines.</span>
<span class="n">Gnuplot2dDataset</span><span class="w"> </span><span class="n">dataset</span><span class="p">;</span>
<span class="n">dataset</span><span class="p">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="n">dataTitle</span><span class="p">);</span>
<span class="n">dataset</span><span class="p">.</span><span class="n">SetStyle</span><span class="p">(</span><span class="n">Gnuplot2dDataset</span><span class="o">::</span><span class="n">POINTS</span><span class="p">);</span>

<span class="c1">// Make the dataset have error bars in both the x and y directions.</span>
<span class="n">dataset</span><span class="p">.</span><span class="n">SetErrorBars</span><span class="p">(</span><span class="n">Gnuplot2dDataset</span><span class="o">::</span><span class="n">XY</span><span class="p">);</span>

<span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">xErrorDelta</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">yErrorDelta</span><span class="p">;</span>

<span class="c1">// Create the 2-D dataset.</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-5.0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">+</span><span class="mf">5.0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Calculate the 2-D curve</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">//            2</span>
<span class="w">    </span><span class="c1">//     y  =  x   .</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Make the uncertainty in the x direction be constant and make</span>
<span class="w">    </span><span class="c1">// the uncertainty in the y direction be a constant fraction of</span>
<span class="w">    </span><span class="c1">// y&#39;s value.</span>
<span class="w">    </span><span class="n">xErrorDelta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.25</span><span class="p">;</span>
<span class="w">    </span><span class="n">yErrorDelta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Add this point with uncertainties in both the x and y</span>
<span class="w">    </span><span class="c1">// direction.</span>
<span class="w">    </span><span class="n">dataset</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">xErrorDelta</span><span class="p">,</span><span class="w"> </span><span class="n">yErrorDelta</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">// Add the dataset to the plot.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">AddDataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">);</span>

<span class="c1">// Open the plot file.</span>
<span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="w"> </span><span class="nf">plotFile</span><span class="p">(</span><span class="n">plotFileName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

<span class="c1">// Write the plot file.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">GenerateOutput</span><span class="p">(</span><span class="n">plotFile</span><span class="p">);</span>

<span class="c1">// Close the plot file.</span>
<span class="n">plotFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="an-example-3-dimensional-plot">
<h4><span class="section-number">3.7.5. </span>An Example 3-Dimensional Plot<a class="headerlink" href="#an-example-3-dimensional-plot" title="Link to this heading">¶</a></h4>
<p>The following 3-Dimensional plot</p>
<figure class="align-default" id="plot-3d">
<img alt="_images/plot-3d.png" src="_images/plot-3d.png" />
</figure>
<p>was created using the following code from gnuplot-example.cc:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">fileNameWithNoExtension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;plot-3d&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">graphicsFileName</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">fileNameWithNoExtension</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.png&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">plotFileName</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="n">fileNameWithNoExtension</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.plt&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">plotTitle</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;3-D Plot&quot;</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">dataTitle</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;3-D Data&quot;</span><span class="p">;</span>

<span class="c1">// Instantiate the plot and set its title.</span>
<span class="n">Gnuplot</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="n">graphicsFileName</span><span class="p">);</span>
<span class="n">plot</span><span class="p">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="n">plotTitle</span><span class="p">);</span>

<span class="c1">// Make the graphics file, which the plot file will create when it</span>
<span class="c1">// is used with Gnuplot, be a PNG file.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">SetTerminal</span><span class="p">(</span><span class="s">&quot;png&quot;</span><span class="p">);</span>

<span class="c1">// Rotate the plot 30 degrees around the x axis and then rotate the</span>
<span class="c1">// plot 120 degrees around the new z axis.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">AppendExtra</span><span class="p">(</span><span class="s">&quot;set view 30, 120, 1.0, 1.0&quot;</span><span class="p">);</span>

<span class="c1">// Make the zero for the z-axis be in the x-axis and y-axis plane.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">AppendExtra</span><span class="p">(</span><span class="s">&quot;set ticslevel 0&quot;</span><span class="p">);</span>

<span class="c1">// Set the labels for each axis.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">AppendExtra</span><span class="p">(</span><span class="s">&quot;set xlabel &#39;X Values&#39;&quot;</span><span class="p">);</span>
<span class="n">plot</span><span class="p">.</span><span class="n">AppendExtra</span><span class="p">(</span><span class="s">&quot;set ylabel &#39;Y Values&#39;&quot;</span><span class="p">);</span>
<span class="n">plot</span><span class="p">.</span><span class="n">AppendExtra</span><span class="p">(</span><span class="s">&quot;set zlabel &#39;Z Values&#39;&quot;</span><span class="p">);</span>

<span class="c1">// Set the ranges for the x and y axis.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">AppendExtra</span><span class="p">(</span><span class="s">&quot;set xrange [-5:+5]&quot;</span><span class="p">);</span>
<span class="n">plot</span><span class="p">.</span><span class="n">AppendExtra</span><span class="p">(</span><span class="s">&quot;set yrange [-5:+5]&quot;</span><span class="p">);</span>

<span class="c1">// Instantiate the dataset, set its title, and make the points be</span>
<span class="c1">// connected by lines.</span>
<span class="n">Gnuplot3dDataset</span><span class="w"> </span><span class="n">dataset</span><span class="p">;</span>
<span class="n">dataset</span><span class="p">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="n">dataTitle</span><span class="p">);</span>
<span class="n">dataset</span><span class="p">.</span><span class="n">SetStyle</span><span class="p">(</span><span class="s">&quot;with lines&quot;</span><span class="p">);</span>

<span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="kt">double</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>

<span class="c1">// Create the 3-D dataset.</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-5.0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">+</span><span class="mf">5.0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-5.0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">+</span><span class="mf">5.0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Calculate the 3-D surface</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">//            2      2</span>
<span class="w">        </span><span class="c1">//     z  =  x   *  y   .</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Add this point.</span>
<span class="w">        </span><span class="n">dataset</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// The blank line is necessary at the end of each x value&#39;s data</span>
<span class="w">    </span><span class="c1">// points for the 3-D surface grid to work.</span>
<span class="w">    </span><span class="n">dataset</span><span class="p">.</span><span class="n">AddEmptyLine</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="c1">// Add the dataset to the plot.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">AddDataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">);</span>

<span class="c1">// Open the plot file.</span>
<span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="w"> </span><span class="nf">plotFile</span><span class="p">(</span><span class="n">plotFileName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

<span class="c1">// Write the plot file.</span>
<span class="n">plot</span><span class="p">.</span><span class="n">GenerateOutput</span><span class="p">(</span><span class="n">plotFile</span><span class="p">);</span>

<span class="c1">// Close the plot file.</span>
<span class="n">plotFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</pre></div>
</div>
</section>
</section>
<span id="document-python"></span><section id="using-python-to-run-ns3">
<h3><span class="section-number">3.8. </span>Using Python to Run <em>ns-3</em><a class="headerlink" href="#using-python-to-run-ns3" title="Link to this heading">¶</a></h3>
<p>Python bindings allow the C++ code in <em>ns-3</em> to be called from Python.</p>
<p>This chapter shows you how to create a Python script that can run <em>ns-3</em> and also the process of creating Python bindings for a C++ <em>ns-3</em> module.</p>
<p>Python bindings are also needed to run the Pyviz visualizer.</p>
<section id="introduction">
<h4><span class="section-number">3.8.1. </span>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h4>
<p>Python bindings provide support for importing <em>ns-3</em> model libraries as Python
modules.  Coverage of most of the <em>ns-3</em> C++ API is provided.  The intent
has been to allow the programmer to write complete simulation scripts in
Python, to allow integration of <em>ns-3</em> with other Python tools and workflows.
The intent is not to provide a different language choice to author new
<em>ns-3</em> models implemented in Python.</p>
<p>As of ns-3.37 release or later,
Python bindings for <em>ns-3</em> use a tool called Cppyy (<a class="reference external" href="https://cppyy.readthedocs.io/en/latest/">https://cppyy.readthedocs.io/en/latest/</a>)
to create a Python module from the C++ libraries built by CMake. The Python bindings that Cppyy
uses are built at runtime, by importing the C++ libraries and headers for each <em>ns-3</em> module.
This means that even if the C++ API changes, the Python bindings will adapt to them
without requiring any preprocessing or scanning.</p>
<p>If a user is not interested in Python, no action is needed; the Python bindings
are only built on-demand by Cppyy, and only if the user enables them in the
configuration of <em>ns-3</em>.</p>
<p>Due to an <a class="reference external" href="https://github.com/wlav/cppyy/issues/150">upstream limitation with Cppyy</a>, Python bindings do not work on macOS machines with Apple silicon (M1 and M2 processors).</p>
<p>Prior to ns-3.37, the previous Python bindings framework was based on
<a class="reference external" href="https://github.com/gjcarneiro/pybindgen">Pybindgen</a>.</p>
</section>
<section id="an-example-python-script-that-runs-ns3">
<h4><span class="section-number">3.8.2. </span>An Example Python Script that Runs <em>ns-3</em><a class="headerlink" href="#an-example-python-script-that-runs-ns3" title="Link to this heading">¶</a></h4>
<p>Here is some example code that is written in Python and that runs <em>ns-3</em>, which is written in C++.  This Python example can be found in <code class="docutils literal notranslate"><span class="pre">examples/tutorial/first.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ns</span> <span class="kn">import</span> <span class="n">ns</span>

<span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">LogComponentEnable</span><span class="p">(</span><span class="s2">&quot;UdpEchoClientApplication&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">LOG_LEVEL_INFO</span><span class="p">)</span>
<span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">LogComponentEnable</span><span class="p">(</span><span class="s2">&quot;UdpEchoServerApplication&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">LOG_LEVEL_INFO</span><span class="p">)</span>

<span class="n">nodes</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">NodeContainer</span><span class="p">()</span>
<span class="n">nodes</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">pointToPoint</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">point_to_point</span><span class="o">.</span><span class="n">PointToPointHelper</span><span class="p">()</span>
<span class="n">pointToPoint</span><span class="o">.</span><span class="n">SetDeviceAttribute</span><span class="p">(</span><span class="s2">&quot;DataRate&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">StringValue</span><span class="p">(</span><span class="s2">&quot;5Mbps&quot;</span><span class="p">))</span>
<span class="n">pointToPoint</span><span class="o">.</span><span class="n">SetChannelAttribute</span><span class="p">(</span><span class="s2">&quot;Delay&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">StringValue</span><span class="p">(</span><span class="s2">&quot;2ms&quot;</span><span class="p">))</span>

<span class="n">devices</span> <span class="o">=</span> <span class="n">pointToPoint</span><span class="o">.</span><span class="n">Install</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

<span class="n">stack</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">internet</span><span class="o">.</span><span class="n">InternetStackHelper</span><span class="p">()</span>
<span class="n">stack</span><span class="o">.</span><span class="n">Install</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

<span class="n">address</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">internet</span><span class="o">.</span><span class="n">Ipv4AddressHelper</span><span class="p">()</span>
<span class="n">address</span><span class="o">.</span><span class="n">SetBase</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">Ipv4Address</span><span class="p">(</span><span class="s2">&quot;10.1.1.0&quot;</span><span class="p">),</span>
                <span class="n">ns</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">Ipv4Mask</span><span class="p">(</span><span class="s2">&quot;255.255.255.0&quot;</span><span class="p">))</span>

<span class="n">interfaces</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span>

<span class="n">echoServer</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">UdpEchoServerHelper</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>

<span class="n">serverApps</span> <span class="o">=</span> <span class="n">echoServer</span><span class="o">.</span><span class="n">Install</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">serverApps</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
<span class="n">serverApps</span><span class="o">.</span><span class="n">Stop</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span>

<span class="n">address</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">GetAddress</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ConvertTo</span><span class="p">()</span>
<span class="n">echoClient</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">UdpEchoClientHelper</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">echoClient</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s2">&quot;MaxPackets&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">UintegerValue</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">echoClient</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s2">&quot;Interval&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">TimeValue</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)))</span>
<span class="n">echoClient</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s2">&quot;PacketSize&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">UintegerValue</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>

<span class="n">clientApps</span> <span class="o">=</span> <span class="n">echoClient</span><span class="o">.</span><span class="n">Install</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="n">clientApps</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
<span class="n">clientApps</span><span class="o">.</span><span class="n">Stop</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span>

<span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Simulator</span><span class="o">.</span><span class="n">Run</span><span class="p">()</span>
<span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Simulator</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="running-python-scripts">
<h4><span class="section-number">3.8.3. </span>Running Python Scripts<a class="headerlink" href="#running-python-scripts" title="Link to this heading">¶</a></h4>
<p>For users that want to change upstream modules in C++ and got a copy of
ns-3 by Git cloning the ns-3-dev repository, or downloaded the
ns3-allinone package, or is using bake, continue to the next section.</p>
<p><cite>Note: models implemented in Python are not available from C++. If you want
your model to be available for both C++ and Python users, you must implement
it in C++.</cite></p>
<p>For users that want to exclusively run simulation scenarios and implement
simple modules in python, jump to the <a class="reference internal" href="#using-the-pip-wheel">Using the pip wheel</a> section.</p>
<section id="using-the-bindings-from-the-ns-3-source">
<h5><span class="section-number">3.8.3.1. </span>Using the bindings from the ns-3 source<a class="headerlink" href="#using-the-bindings-from-the-ns-3-source" title="Link to this heading">¶</a></h5>
<p>The main prerequisite is to install <cite>cppyy</cite>, with version no later than 2.4.2.
Depending on how you may manage
Python extensions, the installation instructions may vary, but you can first
check if it installed by seeing if the <cite>cppyy</cite> module can be
successfully imported and the version is no later than 2.4.2:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python3
Python<span class="w"> </span><span class="m">3</span>.8.10<span class="w"> </span><span class="o">(</span>default,<span class="w"> </span>Jun<span class="w"> </span><span class="m">22</span><span class="w"> </span><span class="m">2022</span>,<span class="w"> </span><span class="m">20</span>:18:18<span class="o">)</span>
<span class="o">[</span>GCC<span class="w"> </span><span class="m">9</span>.4.0<span class="o">]</span><span class="w"> </span>on<span class="w"> </span>linux
Type<span class="w"> </span><span class="s2">&quot;help&quot;</span>,<span class="w"> </span><span class="s2">&quot;copyright&quot;</span>,<span class="w"> </span><span class="s2">&quot;credits&quot;</span><span class="w"> </span>or<span class="w"> </span><span class="s2">&quot;license&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>more<span class="w"> </span>information.
&gt;&gt;&gt;<span class="w"> </span>import<span class="w"> </span>cppyy
&gt;&gt;&gt;<span class="w"> </span>print<span class="o">(</span><span class="s2">&quot;%s&quot;</span><span class="w"> </span>%<span class="w"> </span>cppyy.__version<span class="o">)</span>
<span class="m">2</span>.4.2
&gt;&gt;&gt;
</pre></div>
</div>
<p>If not, you may try to install via <cite>pip</cite> or whatever other manager you are
using; e.g.:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--user<span class="w"> </span><span class="nv">cppyy</span><span class="o">==</span><span class="m">2</span>.4.2
</pre></div>
</div>
<p>First, we need to enable the build of Python bindings:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>configure<span class="w"> </span>--enable-python-bindings
</pre></div>
</div>
<p>Other options such as <code class="docutils literal notranslate"><span class="pre">--enable-examples</span></code> may be passed to the above command.
ns3 contains some options that automatically update the python path to find the ns3 module.
To run example programs, there are two ways to use ns3 to take care of this.  One is to run a ns3 shell; e.g.:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>shell
$<span class="w"> </span>python3<span class="w"> </span>examples/wireless/mixed-wired-wireless.py
</pre></div>
</div>
<p>and the other is to use the ‘run’ option to ns3:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>examples/wireless/mixed-wired-wireless.py
</pre></div>
</div>
<p>Use the <code class="docutils literal notranslate"><span class="pre">--no-build</span></code> option to run the program without invoking a project rebuild.
This option may be useful to improve execution time when running the same program
repeatedly but with different arguments, such as from scripts.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>--no-build<span class="w"> </span>examples/wireless/mixed-wired-wireless.py
</pre></div>
</div>
<p>To run a python script under the C debugger:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>shell
$<span class="w"> </span>gdb<span class="w"> </span>--args<span class="w"> </span>python3<span class="w"> </span>examples/wireless/mixed-wired-wireless.py
</pre></div>
</div>
<p>To run your own Python script that calls <em>ns-3</em> and that has this path, <code class="docutils literal notranslate"><span class="pre">/path/to/your/example/my-script.py</span></code>, do the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>shell
$<span class="w"> </span>python3<span class="w"> </span>/path/to/your/example/my-script.py
</pre></div>
</div>
</section>
<section id="using-the-pip-wheel">
<h5><span class="section-number">3.8.3.2. </span>Using the pip wheel<a class="headerlink" href="#using-the-pip-wheel" title="Link to this heading">¶</a></h5>
<p>Starting from ns-3.38, we provide a pip wheel for Python users using Linux.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--user<span class="w"> </span>ns3
</pre></div>
</div>
<p>You can select a specific ns-3 version by specifying the wheel version.
Specifying a nonexistent version will result in an error message listing the available versions.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--user<span class="w"> </span><span class="nv">ns3</span><span class="o">==</span><span class="m">3</span>.37
Defaulting<span class="w"> </span>to<span class="w"> </span>user<span class="w"> </span>installation<span class="w"> </span>because<span class="w"> </span>normal<span class="w"> </span>site-packages<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>writeable
ERROR:<span class="w"> </span>Could<span class="w"> </span>not<span class="w"> </span>find<span class="w"> </span>a<span class="w"> </span>version<span class="w"> </span>that<span class="w"> </span>satisfies<span class="w"> </span>the<span class="w"> </span>requirement<span class="w"> </span><span class="nv">ns3</span><span class="o">==</span><span class="m">3</span>.37<span class="w"> </span><span class="o">(</span>from<span class="w"> </span>versions:<span class="w"> </span><span class="m">3</span>.37.post415<span class="o">)</span>
ERROR:<span class="w"> </span>No<span class="w"> </span>matching<span class="w"> </span>distribution<span class="w"> </span>found<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">ns3</span><span class="o">==</span><span class="m">3</span>.37
</pre></div>
</div>
<p>You can also specify you want at least a specific version (e.g. which shipped a required feature).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--user<span class="w"> </span>ns3&gt;<span class="o">=</span><span class="m">3</span>.37
Defaulting<span class="w"> </span>to<span class="w"> </span>user<span class="w"> </span>installation<span class="w"> </span>because<span class="w"> </span>normal<span class="w"> </span>site-packages<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>writeable
Requirement<span class="w"> </span>already<span class="w"> </span>satisfied:<span class="w"> </span><span class="nv">ns3</span><span class="o">==</span><span class="m">3</span>.37.post415<span class="w"> </span><span class="k">in</span><span class="w"> </span>/home/username/.local/lib/python3.10/site-packages<span class="w"> </span><span class="o">(</span><span class="m">3</span>.37.post415<span class="o">)</span>
Requirement<span class="w"> </span>already<span class="w"> </span>satisfied:<span class="w"> </span>cppyy<span class="w"> </span><span class="k">in</span><span class="w"> </span>/home/username/.local/lib/python3.10/site-packages<span class="w"> </span><span class="o">(</span>from<span class="w"> </span><span class="nv">ns3</span><span class="o">==</span><span class="m">3</span>.37.post415<span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="m">2</span>.4.2<span class="o">)</span>
Requirement<span class="w"> </span>already<span class="w"> </span>satisfied:<span class="w"> </span>cppyy-backend<span class="o">==</span><span class="m">1</span>.14.10<span class="w"> </span><span class="k">in</span><span class="w"> </span>/home/username/.local/lib/python3.10/site-packages<span class="w"> </span><span class="o">(</span>from<span class="w"> </span>cppyy-&gt;ns3<span class="o">==</span><span class="m">3</span>.37.post415<span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="m">1</span>.14.10<span class="o">)</span>
Requirement<span class="w"> </span>already<span class="w"> </span>satisfied:<span class="w"> </span><span class="nv">CPyCppyy</span><span class="o">==</span><span class="m">1</span>.12.12<span class="w"> </span><span class="k">in</span><span class="w"> </span>/home/username/.local/lib/python3.10/site-packages<span class="w"> </span><span class="o">(</span>from<span class="w"> </span>cppyy-&gt;ns3<span class="o">==</span><span class="m">3</span>.37.post415<span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="m">1</span>.12.12<span class="o">)</span>
Requirement<span class="w"> </span>already<span class="w"> </span>satisfied:<span class="w"> </span>cppyy-cling<span class="o">==</span><span class="m">6</span>.27.1<span class="w"> </span><span class="k">in</span><span class="w"> </span>/home/username/.local/lib/python3.10/site-packages<span class="w"> </span><span class="o">(</span>from<span class="w"> </span>cppyy-&gt;ns3<span class="o">==</span><span class="m">3</span>.37.post415<span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="m">6</span>.27.1<span class="o">)</span>
</pre></div>
</div>
<p>To check if the pip wheel was installed, use the pip freeze command to list the installed packages,
then grep ns3 to filter the line of interest.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pip<span class="w"> </span>freeze<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>ns3
<span class="nv">ns3</span><span class="o">==</span><span class="m">3</span>.37.post415
</pre></div>
</div>
<p>The available versions are also listed on the Pypi page for the <a class="reference external" href="https://pypi.org/project/ns3/#history">ns3 wheel</a>.</p>
<p>After installing it, you can start using ns-3 right away. For example, using the following script.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ns</span> <span class="kn">import</span> <span class="n">ns</span>

<span class="n">ns</span><span class="o">.</span><span class="n">cppyy</span><span class="o">.</span><span class="n">cppdef</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        using namespace ns3;</span>

<span class="s2">        Callback&lt;void,Ptr&lt;const Packet&gt;,const Address&amp;,const Address&amp;&gt;</span>
<span class="s2">        make_sinktrace_callback(void(*func)(Ptr&lt;Packet&gt;,Address,Address))</span>
<span class="s2">        {</span>
<span class="s2">            return MakeCallback(func);</span>
<span class="s2">        }</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Define the trace callback</span>
<span class="k">def</span> <span class="nf">SinkTracer</span><span class="p">(</span><span class="n">packet</span><span class="p">:</span> <span class="n">ns</span><span class="o">.</span><span class="n">Packet</span><span class="p">,</span> <span class="n">src_address</span><span class="p">:</span> <span class="n">ns</span><span class="o">.</span><span class="n">Address</span><span class="p">,</span> <span class="n">dst_address</span><span class="p">:</span> <span class="n">ns</span><span class="o">.</span><span class="n">Address</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;At </span><span class="si">{</span><span class="n">ns</span><span class="o">.</span><span class="n">Simulator</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">GetSeconds</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">s, &#39;</span><span class="si">{</span><span class="n">dst_address</span><span class="si">}</span><span class="s2">&#39; received packet&quot;</span>
          <span class="sa">f</span><span class="s2">&quot; with </span><span class="si">{</span><span class="n">packet</span><span class="o">.</span><span class="n">__deref__</span><span class="p">()</span><span class="o">.</span><span class="n">GetSerializedSize</span><span class="p">()</span><span class="si">}</span><span class="s2"> bytes from &#39;</span><span class="si">{</span><span class="n">src_address</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

<span class="c1"># Create two nodes</span>
<span class="n">csmaNodes</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">NodeContainer</span><span class="p">()</span>
<span class="n">csmaNodes</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Connect the two nodes</span>
<span class="n">csma</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">csma</span><span class="o">.</span><span class="n">CsmaHelper</span><span class="p">()</span>
<span class="n">csma</span><span class="o">.</span><span class="n">SetChannelAttribute</span><span class="p">(</span><span class="s2">&quot;DataRate&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">StringValue</span><span class="p">(</span><span class="s2">&quot;100Mbps&quot;</span><span class="p">))</span>
<span class="n">csma</span><span class="o">.</span><span class="n">SetChannelAttribute</span><span class="p">(</span><span class="s2">&quot;Delay&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">TimeValue</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">NanoSeconds</span><span class="p">(</span><span class="mi">6560</span><span class="p">)))</span>
<span class="n">csmaDevices</span> <span class="o">=</span> <span class="n">csma</span><span class="o">.</span><span class="n">Install</span><span class="p">(</span><span class="n">csmaNodes</span><span class="p">)</span>

<span class="c1"># Install the internet stack</span>
<span class="n">stack</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">internet</span><span class="o">.</span><span class="n">InternetStackHelper</span><span class="p">()</span>
<span class="n">stack</span><span class="o">.</span><span class="n">Install</span><span class="p">(</span><span class="n">csmaNodes</span><span class="p">)</span>

<span class="c1"># Assign Ipv4 addresses</span>
<span class="n">address</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">internet</span><span class="o">.</span><span class="n">Ipv4AddressHelper</span><span class="p">()</span>
<span class="n">address</span><span class="o">.</span><span class="n">SetBase</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">Ipv4Address</span><span class="p">(</span><span class="s2">&quot;10.1.2.0&quot;</span><span class="p">),</span> <span class="n">ns</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">Ipv4Mask</span><span class="p">(</span><span class="s2">&quot;255.255.255.0&quot;</span><span class="p">))</span>
<span class="n">csmaInterfaces</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span><span class="n">csmaDevices</span><span class="p">)</span>

<span class="c1"># Setup applications</span>
<span class="n">echoServer</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">UdpEchoServerHelper</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>

<span class="n">serverApps</span> <span class="o">=</span> <span class="n">echoServer</span><span class="o">.</span><span class="n">Install</span><span class="p">(</span><span class="n">csmaNodes</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="n">serverApps</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
<span class="n">serverApps</span><span class="o">.</span><span class="n">Stop</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span>

<span class="n">echoClient</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">UdpEchoClientHelper</span><span class="p">(</span><span class="n">csmaInterfaces</span><span class="o">.</span><span class="n">GetAddress</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ConvertTo</span><span class="p">(),</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">echoClient</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s2">&quot;MaxPackets&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">UintegerValue</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">echoClient</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s2">&quot;Interval&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">TimeValue</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)))</span>
<span class="n">echoClient</span><span class="o">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s2">&quot;PacketSize&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">UintegerValue</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>

<span class="n">clientApps</span> <span class="o">=</span> <span class="n">echoClient</span><span class="o">.</span><span class="n">Install</span><span class="p">(</span><span class="n">csmaNodes</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">clientApps</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
<span class="n">clientApps</span><span class="o">.</span><span class="n">Stop</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span>

<span class="c1"># Populate routing tables</span>
<span class="n">ns</span><span class="o">.</span><span class="n">internet</span><span class="o">.</span><span class="n">Ipv4GlobalRoutingHelper</span><span class="o">.</span><span class="n">PopulateRoutingTables</span><span class="p">()</span>

<span class="c1"># Setup the trace callback</span>
<span class="n">sinkTraceCallback</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">cppyy</span><span class="o">.</span><span class="n">gbl</span><span class="o">.</span><span class="n">make_sinktrace_callback</span><span class="p">(</span><span class="n">SinkTracer</span><span class="p">)</span>
<span class="n">serverApps</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">__deref__</span><span class="p">()</span><span class="o">.</span><span class="n">TraceConnectWithoutContext</span><span class="p">(</span><span class="s2">&quot;RxWithAddresses&quot;</span><span class="p">,</span> <span class="n">sinkTraceCallback</span><span class="p">);</span>

<span class="c1"># Set the simulation duration to 11 seconds</span>
<span class="n">ns</span><span class="o">.</span><span class="n">Simulator</span><span class="o">.</span><span class="n">Stop</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">Seconds</span><span class="p">(</span><span class="mi">11</span><span class="p">))</span>

<span class="c1"># Run the simulator</span>
<span class="n">ns</span><span class="o">.</span><span class="n">Simulator</span><span class="o">.</span><span class="n">Run</span><span class="p">()</span>
<span class="n">ns</span><span class="o">.</span><span class="n">Simulator</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
</pre></div>
</div>
<p>Which should print:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>At<span class="w"> </span>2s,<span class="w"> </span><span class="s1">&#39;04-07-00:00:00:00:09:00:00&#39;</span><span class="w"> </span>received<span class="w"> </span>packet<span class="w"> </span>with<span class="w"> </span><span class="m">60</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="s1">&#39;04-07-0a:01:02:02:01:c0:00&#39;</span>
At<span class="w"> </span>3s,<span class="w"> </span><span class="s1">&#39;04-07-00:00:00:00:09:00:00&#39;</span><span class="w"> </span>received<span class="w"> </span>packet<span class="w"> </span>with<span class="w"> </span><span class="m">60</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="s1">&#39;04-07-0a:01:02:02:01:c0:00&#39;</span>
At<span class="w"> </span>4s,<span class="w"> </span><span class="s1">&#39;04-07-00:00:00:00:09:00:00&#39;</span><span class="w"> </span>received<span class="w"> </span>packet<span class="w"> </span>with<span class="w"> </span><span class="m">60</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="s1">&#39;04-07-0a:01:02:02:01:c0:00&#39;</span>
At<span class="w"> </span>5s,<span class="w"> </span><span class="s1">&#39;04-07-00:00:00:00:09:00:00&#39;</span><span class="w"> </span>received<span class="w"> </span>packet<span class="w"> </span>with<span class="w"> </span><span class="m">60</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="s1">&#39;04-07-0a:01:02:02:01:c0:00&#39;</span>
At<span class="w"> </span>6s,<span class="w"> </span><span class="s1">&#39;04-07-00:00:00:00:09:00:00&#39;</span><span class="w"> </span>received<span class="w"> </span>packet<span class="w"> </span>with<span class="w"> </span><span class="m">60</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="s1">&#39;04-07-0a:01:02:02:01:c0:00&#39;</span>
At<span class="w"> </span>7s,<span class="w"> </span><span class="s1">&#39;04-07-00:00:00:00:09:00:00&#39;</span><span class="w"> </span>received<span class="w"> </span>packet<span class="w"> </span>with<span class="w"> </span><span class="m">60</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="s1">&#39;04-07-0a:01:02:02:01:c0:00&#39;</span>
At<span class="w"> </span>8s,<span class="w"> </span><span class="s1">&#39;04-07-00:00:00:00:09:00:00&#39;</span><span class="w"> </span>received<span class="w"> </span>packet<span class="w"> </span>with<span class="w"> </span><span class="m">60</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="s1">&#39;04-07-0a:01:02:02:01:c0:00&#39;</span>
At<span class="w"> </span>9s,<span class="w"> </span><span class="s1">&#39;04-07-00:00:00:00:09:00:00&#39;</span><span class="w"> </span>received<span class="w"> </span>packet<span class="w"> </span>with<span class="w"> </span><span class="m">60</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="s1">&#39;04-07-0a:01:02:02:01:c0:00&#39;</span>
</pre></div>
</div>
</section>
</section>
<section id="caveats">
<h4><span class="section-number">3.8.4. </span>Caveats<a class="headerlink" href="#caveats" title="Link to this heading">¶</a></h4>
<p>Some of the limitations of the Cppyy-based bindings are listed here.</p>
<section id="incomplete-coverage">
<h5><span class="section-number">3.8.4.1. </span>Incomplete Coverage<a class="headerlink" href="#incomplete-coverage" title="Link to this heading">¶</a></h5>
<p>First of all, keep in mind that not 100% of the API is supported in Python.  Some of the reasons are:</p>
<section id="memory-management-issues">
<h6><span class="section-number">3.8.4.1.1. </span>Memory-management issues<a class="headerlink" href="#memory-management-issues" title="Link to this heading">¶</a></h6>
<p>Some of the APIs involve pointers, which require knowledge of what kind of memory passing semantics (who owns what memory).
Such knowledge is not part of the function signatures, and is either documented or sometimes not even documented.
You may need to workaround these issues by instantiating variables on the C++ side with a Just-In-Time (JIT) compiled function.</p>
<p>For example, when handling command-line arguments, we could set additional parameters like in the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import the ns-3 C++ modules with Cppyy</span>
<span class="kn">from</span> <span class="nn">ns</span> <span class="kn">import</span> <span class="n">ns</span>

<span class="c1"># To pass the addresses of the Python variables to c++, we need to use ctypes</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">c_bool</span><span class="p">,</span> <span class="n">c_int</span><span class="p">,</span> <span class="n">c_double</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">create_string_buffer</span>
<span class="n">verbose</span> <span class="o">=</span> <span class="n">c_bool</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">nCsma</span> <span class="o">=</span> <span class="n">c_int</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">throughputKbps</span> <span class="o">=</span> <span class="n">c_double</span><span class="p">(</span><span class="mf">3.1415</span><span class="p">)</span>
<span class="n">BUFFLEN</span> <span class="o">=</span> <span class="mi">4096</span>
<span class="n">outputFileBuffer</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;default_output_file.xml&quot;</span><span class="p">,</span> <span class="n">BUFFLEN</span><span class="p">)</span>
<span class="n">outputFile</span> <span class="o">=</span> <span class="n">c_char_p</span><span class="p">(</span><span class="n">outputFileBuffer</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>

<span class="c1"># Cppyy will transform the ctype types into the appropriate reference or raw pointers</span>
<span class="n">cmd</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">CommandLine</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="n">cmd</span><span class="o">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="s2">&quot;Tell echo applications to log if true&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
<span class="n">cmd</span><span class="o">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s2">&quot;nCsma&quot;</span><span class="p">,</span> <span class="s2">&quot;Number of extra CSMA nodes/devices&quot;</span><span class="p">,</span> <span class="n">nCsma</span><span class="p">)</span>
<span class="n">cmd</span><span class="o">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s2">&quot;throughputKbps&quot;</span><span class="p">,</span> <span class="s2">&quot;Throughput of nodes&quot;</span><span class="p">,</span> <span class="n">throughputKbps</span><span class="p">)</span>
<span class="n">cmd</span><span class="o">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s2">&quot;outputFile&quot;</span><span class="p">,</span> <span class="s2">&quot;Output file name&quot;</span><span class="p">,</span> <span class="n">outputFile</span><span class="p">,</span> <span class="n">BUFFLEN</span><span class="p">)</span>
<span class="n">cmd</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>

<span class="c1"># Printing values of the different ctypes passed as arguments post parsing</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Verbose:&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nCsma:&quot;</span><span class="p">,</span> <span class="n">nCsma</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;throughputKbps:&quot;</span><span class="p">,</span> <span class="n">throughputKbps</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;outputFile:&quot;</span><span class="p">,</span> <span class="n">outputFile</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the variables are passed as references or raw pointers. Reassigning them on the Python side
(e.g. <code class="docutils literal notranslate"><span class="pre">verbose</span> <span class="pre">=</span> <span class="pre">verbose.value</span></code>) can result in the Python garbage collector destroying the object
since its only reference has been overwritten, allowing the garbage collector to reclaim that memory space.
The C++ side will then have a dangling reference to the variable, which can be overwritten with
unexpected values, which can be read later, causing ns-3 to behave erratically due to the memory corruption.</p>
<p>String values are problematic since Python and C++ string lifetimes are handled differently.
To workaround that, we need to use null-terminated C strings (<code class="docutils literal notranslate"><span class="pre">char*</span></code>) to exchange strings between
the bindings and ns-3 module libraries. However, C strings are particularly dangerous, since
overwriting the null-terminator can also result in memory corruption. When passing a C string, remember
to allocate a large buffer and perform bounds checking whenever possible. The CommandLine::AddValue
variant for <code class="docutils literal notranslate"><span class="pre">char*</span></code> performs bounds checking and aborts the execution in case the parsed value
does not fit in the buffer. Make sure to pass the complete size of the buffer, including the null terminator.</p>
<p>There is an example below demonstrating how the memory corruption could happen in case there was
no bounds checking in CommandLine::AddValue variant for <code class="docutils literal notranslate"><span class="pre">char*</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ns</span> <span class="kn">import</span> <span class="n">ns</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">c_char</span><span class="p">,</span> <span class="n">create_string_buffer</span><span class="p">,</span> <span class="n">byref</span><span class="p">,</span> <span class="n">cast</span>

<span class="c1"># The following buffer represent the memory contents</span>
<span class="c1"># of a program containing two adjacent C strings</span>
<span class="c1"># This could be the result of two subsequent variables</span>
<span class="c1"># on the stack or dynamically allocated</span>
<span class="n">memoryContents</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;SHORT_STRING_CONTENTS</span><span class="se">\0</span><span class="s2">&quot;</span><span class="o">+</span><span class="sa">b</span><span class="s2">&quot;DoNotWriteHere_&quot;</span><span class="o">*</span><span class="mi">5</span><span class="o">+</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">lenShortString</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;SHORT_STRING_CONTENTS</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># In the next lines, we pick pointers to these two C strings</span>
<span class="n">shortStringBuffer</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">memoryContents</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">c_char_p</span><span class="p">)</span>
<span class="n">victimBuffer</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">byref</span><span class="p">(</span><span class="n">memoryContents</span><span class="p">,</span> <span class="n">lenShortString</span><span class="p">),</span> <span class="n">c_char_p</span><span class="p">)</span>

<span class="n">cmd</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">CommandLine</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="c1"># in the real implementation, the buffer size of 21+1 bytes containing SHORT_STRING_CONTENTS\0 is passed</span>
<span class="n">cmd</span><span class="o">.</span><span class="n">AddValue</span><span class="p">(</span><span class="s2">&quot;shortString&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">shortStringBuffer</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Memory contents before the memory corruption&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Full Memory contents&quot;</span><span class="p">,</span> <span class="n">memoryContents</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shortStringBuffer contents: &quot;</span><span class="p">,</span> <span class="n">shortStringBuffer</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;victimBuffer contents: &quot;</span><span class="p">,</span> <span class="n">victimBuffer</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="c1"># The following block should print to the terminal.</span>
<span class="c1"># Note that the strings are correctly</span>
<span class="c1"># identified due to the null terminator (\x00)</span>
<span class="c1">#</span>
<span class="c1"># Memory contents before the memory corruption</span>
<span class="c1"># Full Memory contents b&#39;SHORT_STRING_CONTENTS\x00DoNotWriteHere_DoNotWriteHere_DoNotWriteHere_DoNotWriteHere_DoNotWriteHere_\x00\x00&#39;</span>
<span class="c1"># shortStringBuffer size=21, contents: b&#39;SHORT_STRING_CONTENTS&#39;</span>
<span class="c1"># victimBuffer size=75, contents: b&#39;DoNotWriteHere_DoNotWriteHere_DoNotWriteHere_DoNotWriteHere_DoNotWriteHere_&#39;</span>

<span class="c1"># Write a very long string to a small buffer of size lenShortString = 22</span>
<span class="n">cmd</span><span class="o">.</span><span class="n">Parse</span><span class="p">([</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;--shortString=&quot;</span><span class="o">+</span><span class="p">(</span><span class="s2">&quot;OkToWrite&quot;</span><span class="o">*</span><span class="n">lenShortString</span><span class="p">)[:</span><span class="n">lenShortString</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;CORRUPTED_&quot;</span><span class="o">*</span><span class="mi">3</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Memory contents after the memory corruption&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Full Memory contents&quot;</span><span class="p">,</span> <span class="n">memoryContents</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shortStringBuffer contents: &quot;</span><span class="p">,</span> <span class="n">shortStringBuffer</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;victimBuffer contents: &quot;</span><span class="p">,</span> <span class="n">victimBuffer</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="c1"># The following block should print to the terminal.</span>
<span class="c1">#</span>
<span class="c1"># Memory contents after the memory corruption</span>
<span class="c1"># Full Memory contents b&#39;OkToWriteOkToWriteOkToCORRUPTED_CORRUPTED_CORRUPTED_\x00oNotWriteHere_DoNotWriteHere_DoNotWriteHere_\x00\x00&#39;</span>
<span class="c1"># shortStringBuffer size=52, contents: b&#39;OkToWriteOkToWriteOkToCORRUPTED_CORRUPTED_CORRUPTED_&#39;</span>
<span class="c1"># victimBuffer size=30, contents: b&#39;CORRUPTED_CORRUPTED_CORRUPTED_&#39;</span>
<span class="c1">#</span>
<span class="c1"># Note that shortStringBuffer invaded the victimBuffer since the</span>
<span class="c1"># string being written was bigger than the shortStringBuffer.</span>
<span class="c1">#</span>
<span class="c1"># Since no bounds checks were performed, the adjacent memory got</span>
<span class="c1"># overwritten and both buffers are now corrupted.</span>
<span class="c1">#</span>
<span class="c1"># We also have a memory leak of the final block in the memory</span>
<span class="c1"># &#39;oNotWriteHere_DoNotWriteHere_DoNotWriteHere_\x00\x00&#39;, caused</span>
<span class="c1"># by the null terminator written at the middle of the victimBuffer.</span>
</pre></div>
</div>
<p>If you find a segmentation violation, be sure to wait for the stacktrace provided by Cppyy
and try to find the root cause of the issue. If you have multiple cores, the number of
stacktraces will correspond to the number of threads being executed by Cppyy. To limit them,
define the environment variable <cite>OPENBLAS_NUM_THREADS=1</cite>.</p>
</section>
<section id="operators">
<h6><span class="section-number">3.8.4.1.2. </span>Operators<a class="headerlink" href="#operators" title="Link to this heading">¶</a></h6>
<p>Cppyy may fail to map C++ operators due to the implementation style used by <em>ns-3</em>.
This happens for the fundamental type <cite>Time</cite>. To provide the expected behavior, we
redefine these operators from the Python side during the setup of the <em>ns-3</em> bindings
module (<cite>ns-3-dev/bindings/python/ns__init__.py</cite>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Redefine Time operators</span>
<span class="n">cppyy</span><span class="o">.</span><span class="n">cppdef</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    using namespace ns3;</span>
<span class="s2">    bool Time_ge(Time&amp; a, Time&amp; b){ return a &gt;= b;}</span>
<span class="s2">    bool Time_eq(Time&amp; a, Time&amp; b){ return a == b;}</span>
<span class="s2">    bool Time_ne(Time&amp; a, Time&amp; b){ return a != b;}</span>
<span class="s2">    bool Time_le(Time&amp; a, Time&amp; b){ return a &lt;= b;}</span>
<span class="s2">    bool Time_gt(Time&amp; a, Time&amp; b){ return a &gt; b;}</span>
<span class="s2">    bool Time_lt(Time&amp; a, Time&amp; b){ return a &lt; b;}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">cppyy</span><span class="o">.</span><span class="n">gbl</span><span class="o">.</span><span class="n">ns3</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="fm">__ge__</span> <span class="o">=</span> <span class="n">cppyy</span><span class="o">.</span><span class="n">gbl</span><span class="o">.</span><span class="n">Time_ge</span>
<span class="n">cppyy</span><span class="o">.</span><span class="n">gbl</span><span class="o">.</span><span class="n">ns3</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="fm">__eq__</span> <span class="o">=</span> <span class="n">cppyy</span><span class="o">.</span><span class="n">gbl</span><span class="o">.</span><span class="n">Time_eq</span>
<span class="n">cppyy</span><span class="o">.</span><span class="n">gbl</span><span class="o">.</span><span class="n">ns3</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="fm">__ne__</span> <span class="o">=</span> <span class="n">cppyy</span><span class="o">.</span><span class="n">gbl</span><span class="o">.</span><span class="n">Time_ne</span>
<span class="n">cppyy</span><span class="o">.</span><span class="n">gbl</span><span class="o">.</span><span class="n">ns3</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="fm">__le__</span> <span class="o">=</span> <span class="n">cppyy</span><span class="o">.</span><span class="n">gbl</span><span class="o">.</span><span class="n">Time_le</span>
<span class="n">cppyy</span><span class="o">.</span><span class="n">gbl</span><span class="o">.</span><span class="n">ns3</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="fm">__gt__</span> <span class="o">=</span> <span class="n">cppyy</span><span class="o">.</span><span class="n">gbl</span><span class="o">.</span><span class="n">Time_gt</span>
<span class="n">cppyy</span><span class="o">.</span><span class="n">gbl</span><span class="o">.</span><span class="n">ns3</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="fm">__lt__</span> <span class="o">=</span> <span class="n">cppyy</span><span class="o">.</span><span class="n">gbl</span><span class="o">.</span><span class="n">Time_lt</span>
</pre></div>
</div>
<p>A different operator used by <em>ns-3</em> is <cite>operator Address()</cite>, used to
convert different types of Addresses into the generic type Address.
This is not supported by Cppyy and requires explicit conversion.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Explicitly convert the InetSocketAddress to Address using InetSocketAddress.ConvertTo()</span>
<span class="n">sink</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">InetSocketAddress</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">Ipv4Address</span><span class="o">.</span><span class="n">GetAny</span><span class="p">(),</span> <span class="mi">80</span><span class="p">)</span><span class="o">.</span><span class="n">ConvertTo</span><span class="p">())</span>
</pre></div>
</div>
<p>Most of the missing APIs can be wrapped, given enough time, patience, and expertise, and will likely be wrapped if bug reports are submitted.
However, don’t file a bug report saying “bindings are incomplete”, because the project does not have maintainers to maintain every API.</p>
</section>
</section>
<section id="tracing">
<h5><span class="section-number">3.8.4.2. </span>Tracing<a class="headerlink" href="#tracing" title="Link to this heading">¶</a></h5>
<p>Callback based tracing is not yet properly supported for Python, as new <em>ns-3</em> API needs to be provided for this to be supported.</p>
<p>Pcap file writing is supported via the normal API.</p>
<p>ASCII tracing is supported via the normal C++ API translated to Python.
However, ASCII tracing requires the creation of an ostream object to pass into the ASCII tracing methods.
In Python, the C++ std::ofstream has been minimally wrapped to allow this.  For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ascii</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">ofstream</span><span class="p">(</span><span class="s2">&quot;wifi-ap.tr&quot;</span><span class="p">)</span> <span class="c1"># create the file</span>
<span class="n">ns</span><span class="o">.</span><span class="n">YansWifiPhyHelper</span><span class="o">.</span><span class="n">EnableAsciiAll</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
<span class="n">ns</span><span class="o">.</span><span class="n">Simulator</span><span class="o">.</span><span class="n">Run</span><span class="p">()</span>
<span class="n">ns</span><span class="o">.</span><span class="n">Simulator</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
<span class="n">ascii</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># close the file</span>
</pre></div>
</div>
<p>There is one caveat: you must not allow the file object to be garbage collected while <em>ns-3</em> is still using it.
That means that the ‘ascii’ variable above must not be allowed to go out of scope or else the program will crash.</p>
</section>
</section>
<section id="working-with-python-bindings">
<h4><span class="section-number">3.8.5. </span>Working with Python Bindings<a class="headerlink" href="#working-with-python-bindings" title="Link to this heading">¶</a></h4>
<section id="overview">
<h5><span class="section-number">3.8.5.1. </span>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h5>
<p>The python bindings are generated into an ‘ns’ namespace.  Examples:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ns</span> <span class="kn">import</span> <span class="n">ns</span>
<span class="n">n1</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ns</span> <span class="kn">import</span><span class="o">*</span>
<span class="n">n1</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">Node</span><span class="p">()</span>
</pre></div>
</div>
<p>The best way to explore the bindings is to look at the various example
programs provided in <em>ns-3</em>; some C++ examples have a corresponding Python
example.  There is no structured documentation for the Python bindings
like there is Doxygen for the C++ API, but the Doxygen can be consulted
to understand how the C++ API works.</p>
<p>To inspect what function and classes are available, you can use
the <code class="docutils literal notranslate"><span class="pre">dir</span></code> function. Examples below:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt;<span class="w"> </span>print<span class="o">(</span>dir<span class="o">(</span>ns.Simulator<span class="o">))</span>
<span class="o">[</span><span class="s1">&#39;Cancel&#39;</span>,<span class="w"> </span><span class="s1">&#39;Destroy&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetContext&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetDelayLeft&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetEventCount&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetImplementation&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetMaximumSimulationTime&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetSystemId&#39;</span>,<span class="w"> </span><span class="s1">&#39;IsExpired&#39;</span>,<span class="w"> </span><span class="s1">&#39;IsFinished&#39;</span>,<span class="w"> </span><span class="s1">&#39;NO_CONTEXT&#39;</span>,<span class="w"> </span><span class="s1">&#39;Now&#39;</span>,<span class="w"> </span><span class="s1">&#39;Remove&#39;</span>,<span class="w"> </span><span class="s1">&#39;Run&#39;</span>,<span class="w"> </span><span class="s1">&#39;Schedule&#39;</span>,<span class="w"> </span><span class="s1">&#39;ScheduleDestroy&#39;</span>,<span class="w"> </span><span class="s1">&#39;ScheduleNow&#39;</span>,<span class="w"> </span><span class="s1">&#39;ScheduleWithContext&#39;</span>,<span class="w"> </span><span class="s1">&#39;SetImplementation&#39;</span>,<span class="w"> </span><span class="s1">&#39;SetScheduler&#39;</span>,<span class="w"> </span><span class="s1">&#39;Stop&#39;</span>,<span class="w"> </span><span class="s1">&#39;__add__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__assign__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__bool__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__class__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__delattr__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__destruct__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__dict__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__dir__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__dispatch__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__doc__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__eq__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__format__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__ge__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__getattribute__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__getitem__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__gt__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__hash__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__init__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__init_subclass__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__invert__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__le__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__lt__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__module__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__mul__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__ne__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__neg__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__new__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__pos__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__python_owns__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__radd__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__reduce__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__reduce_ex__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__repr__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__reshape__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__rmul__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__rsub__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__rtruediv__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__setattr__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__sizeof__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__smartptr__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__str__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__sub__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__subclasshook__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__truediv__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__weakref__&#39;</span><span class="o">]</span>
&gt;&gt;&gt;<span class="w"> </span>print<span class="o">(</span>dir<span class="o">(</span>ns.DefaultSimulatorImpl<span class="o">))</span>
<span class="o">[</span><span class="s1">&#39;AggregateObject&#39;</span>,<span class="w"> </span><span class="s1">&#39;Cancel&#39;</span>,<span class="w"> </span><span class="s1">&#39;Destroy&#39;</span>,<span class="w"> </span><span class="s1">&#39;Dispose&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetAggregateIterator&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetAttribute&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetAttributeFailSafe&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetContext&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetDelayLeft&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetEventCount&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetInstanceTypeId&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetMaximumSimulationTime&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetObject&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetReferenceCount&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetSystemId&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetTypeId&#39;</span>,<span class="w"> </span><span class="s1">&#39;Initialize&#39;</span>,<span class="w"> </span><span class="s1">&#39;IsExpired&#39;</span>,<span class="w"> </span><span class="s1">&#39;IsFinished&#39;</span>,<span class="w"> </span><span class="s1">&#39;IsInitialized&#39;</span>,<span class="w"> </span><span class="s1">&#39;Now&#39;</span>,<span class="w"> </span><span class="s1">&#39;PreEventHook&#39;</span>,<span class="w"> </span><span class="s1">&#39;Ref&#39;</span>,<span class="w"> </span><span class="s1">&#39;Remove&#39;</span>,<span class="w"> </span><span class="s1">&#39;Run&#39;</span>,<span class="w"> </span><span class="s1">&#39;Schedule&#39;</span>,<span class="w"> </span><span class="s1">&#39;ScheduleDestroy&#39;</span>,<span class="w"> </span><span class="s1">&#39;ScheduleNow&#39;</span>,<span class="w"> </span><span class="s1">&#39;ScheduleWithContext&#39;</span>,<span class="w"> </span><span class="s1">&#39;SetAttribute&#39;</span>,<span class="w"> </span><span class="s1">&#39;SetAttributeFailSafe&#39;</span>,<span class="w"> </span><span class="s1">&#39;SetScheduler&#39;</span>,<span class="w"> </span><span class="s1">&#39;Stop&#39;</span>,<span class="w"> </span><span class="s1">&#39;TraceConnect&#39;</span>,<span class="w"> </span><span class="s1">&#39;TraceConnectWithoutContext&#39;</span>,<span class="w"> </span><span class="s1">&#39;TraceDisconnect&#39;</span>,<span class="w"> </span><span class="s1">&#39;TraceDisconnectWithoutContext&#39;</span>,<span class="w"> </span><span class="s1">&#39;Unref&#39;</span>,<span class="w"> </span><span class="s1">&#39;__add__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__assign__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__bool__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__class__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__delattr__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__destruct__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__dict__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__dir__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__dispatch__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__doc__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__eq__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__format__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__ge__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__getattribute__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__getitem__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__gt__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__hash__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__init__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__init_subclass__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__invert__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__le__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__lt__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__module__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__mul__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__ne__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__neg__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__new__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__pos__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__python_owns__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__radd__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__reduce__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__reduce_ex__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__repr__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__reshape__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__rmul__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__rsub__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__rtruediv__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__setattr__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__sizeof__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__smartptr__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__str__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__sub__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__subclasshook__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__truediv__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__weakref__&#39;</span><span class="o">]</span>
&gt;&gt;&gt;<span class="w"> </span>print<span class="o">(</span>dir<span class="o">(</span>ns.Time<span class="o">))</span>
<span class="o">[</span><span class="s1">&#39;AUTO&#39;</span>,<span class="w"> </span><span class="s1">&#39;As&#39;</span>,<span class="w"> </span><span class="s1">&#39;Compare&#39;</span>,<span class="w"> </span><span class="s1">&#39;D&#39;</span>,<span class="w"> </span><span class="s1">&#39;FS&#39;</span>,<span class="w"> </span><span class="s1">&#39;From&#39;</span>,<span class="w"> </span><span class="s1">&#39;FromDouble&#39;</span>,<span class="w"> </span><span class="s1">&#39;FromInteger&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetDays&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetDouble&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetFemtoSeconds&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetHours&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetInteger&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetMicroSeconds&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetMilliSeconds&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetMinutes&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetNanoSeconds&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetPicoSeconds&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetResolution&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetSeconds&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetTimeStep&#39;</span>,<span class="w"> </span><span class="s1">&#39;GetYears&#39;</span>,<span class="w"> </span><span class="s1">&#39;H&#39;</span>,<span class="w"> </span><span class="s1">&#39;IsNegative&#39;</span>,<span class="w"> </span><span class="s1">&#39;IsPositive&#39;</span>,<span class="w"> </span><span class="s1">&#39;IsStrictlyNegative&#39;</span>,<span class="w"> </span><span class="s1">&#39;IsStrictlyPositive&#39;</span>,<span class="w"> </span><span class="s1">&#39;IsZero&#39;</span>,<span class="w"> </span><span class="s1">&#39;LAST&#39;</span>,<span class="w"> </span><span class="s1">&#39;MIN&#39;</span>,<span class="w"> </span><span class="s1">&#39;MS&#39;</span>,<span class="w"> </span><span class="s1">&#39;Max&#39;</span>,<span class="w"> </span><span class="s1">&#39;Min&#39;</span>,<span class="w"> </span><span class="s1">&#39;NS&#39;</span>,<span class="w"> </span><span class="s1">&#39;PS&#39;</span>,<span class="w"> </span><span class="s1">&#39;RoundTo&#39;</span>,<span class="w"> </span><span class="s1">&#39;S&#39;</span>,<span class="w"> </span><span class="s1">&#39;SetResolution&#39;</span>,<span class="w"> </span><span class="s1">&#39;StaticInit&#39;</span>,<span class="w"> </span><span class="s1">&#39;To&#39;</span>,<span class="w"> </span><span class="s1">&#39;ToDouble&#39;</span>,<span class="w"> </span><span class="s1">&#39;ToInteger&#39;</span>,<span class="w"> </span><span class="s1">&#39;US&#39;</span>,<span class="w"> </span><span class="s1">&#39;Y&#39;</span>,<span class="w"> </span><span class="s1">&#39;__add__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__assign__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__bool__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__class__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__delattr__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__destruct__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__dict__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__dir__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__dispatch__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__doc__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__eq__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__format__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__ge__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__getattribute__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__getitem__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__gt__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__hash__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__init__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__init_subclass__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__invert__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__le__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__lt__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__module__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__mul__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__ne__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__neg__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__new__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__pos__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__python_owns__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__radd__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__reduce__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__reduce_ex__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__repr__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__reshape__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__rmul__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__rsub__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__rtruediv__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__setattr__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__sizeof__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__smartptr__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__str__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__sub__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__subclasshook__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__truediv__&#39;</span>,<span class="w"> </span><span class="s1">&#39;__weakref__&#39;</span><span class="o">]</span>
</pre></div>
</div>
<p>To get more information about expected arguments, you can use the <code class="docutils literal notranslate"><span class="pre">help</span></code>
function.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt;<span class="w"> </span>help<span class="o">(</span>ns.DefaultSimulatorImpl<span class="o">)</span>
class<span class="w"> </span>DefaultSimulatorImpl<span class="o">(</span>SimulatorImpl<span class="o">)</span>
<span class="p">|</span><span class="w">  </span>Method<span class="w"> </span>resolution<span class="w"> </span>order:
<span class="p">|</span><span class="w">      </span>DefaultSimulatorImpl
<span class="p">|</span><span class="w">      </span>SimulatorImpl
<span class="p">|</span><span class="w">      </span>Object
<span class="p">|</span><span class="w">      </span>SimpleRefCount&lt;ns3::Object,ns3::ObjectBase,ns3::ObjectDeleter&gt;
<span class="p">|</span><span class="w">      </span>ObjectBase
<span class="p">|</span><span class="w">      </span>cppyy.gbl.CPPInstance
<span class="p">|</span><span class="w">      </span>builtins.object
<span class="p">|</span>
<span class="p">|</span><span class="w">  </span>Methods<span class="w"> </span>defined<span class="w"> </span>here:
<span class="p">|</span>
<span class="p">|</span><span class="w">  </span>Cancel<span class="o">(</span>...<span class="o">)</span>
<span class="p">|</span><span class="w">      </span>void<span class="w"> </span>ns3::DefaultSimulatorImpl::Cancel<span class="o">(</span>const<span class="w"> </span>ns3::EventId<span class="p">&amp;</span><span class="w"> </span>id<span class="o">)</span>
<span class="p">|</span>
<span class="p">|</span><span class="w">  </span>Destroy<span class="o">(</span>...<span class="o">)</span>
<span class="p">|</span><span class="w">      </span>void<span class="w"> </span>ns3::DefaultSimulatorImpl::Destroy<span class="o">()</span>
<span class="p">|</span>
<span class="p">|</span><span class="w">  </span>GetContext<span class="o">(</span>...<span class="o">)</span>
<span class="p">|</span><span class="w">      </span>unsigned<span class="w"> </span>int<span class="w"> </span>ns3::DefaultSimulatorImpl::GetContext<span class="o">()</span>
<span class="p">|</span>
<span class="p">|</span><span class="w">  </span>GetDelayLeft<span class="o">(</span>...<span class="o">)</span>
<span class="p">|</span><span class="w">      </span>ns3::Time<span class="w"> </span>ns3::DefaultSimulatorImpl::GetDelayLeft<span class="o">(</span>const<span class="w"> </span>ns3::EventId<span class="p">&amp;</span><span class="w"> </span>id<span class="o">)</span>
<span class="p">|</span>
<span class="p">|</span><span class="w">  </span>GetEventCount<span class="o">(</span>...<span class="o">)</span>
<span class="p">|</span><span class="w">      </span>unsigned<span class="w"> </span>long<span class="w"> </span>ns3::DefaultSimulatorImpl::GetEventCount<span class="o">()</span>
<span class="p">|</span>
<span class="p">|</span><span class="w">  </span>GetMaximumSimulationTime<span class="o">(</span>...<span class="o">)</span>
<span class="p">|</span><span class="w">      </span>ns3::Time<span class="w"> </span>ns3::DefaultSimulatorImpl::GetMaximumSimulationTime<span class="o">()</span>
<span class="p">|</span>
<span class="p">|</span><span class="w">  </span>GetSystemId<span class="o">(</span>...<span class="o">)</span>
<span class="p">|</span><span class="w">      </span>unsigned<span class="w"> </span>int<span class="w"> </span>ns3::DefaultSimulatorImpl::GetSystemId<span class="o">()</span>
<span class="p">|</span>
<span class="p">|</span><span class="w">  </span>GetTypeId<span class="o">(</span>...<span class="o">)</span>
<span class="p">|</span><span class="w">      </span>static<span class="w"> </span>ns3::TypeId<span class="w"> </span>ns3::DefaultSimulatorImpl::GetTypeId<span class="o">()</span>
<span class="p">|</span>
<span class="p">|</span><span class="w">  </span>IsExpired<span class="o">(</span>...<span class="o">)</span>
<span class="p">|</span><span class="w">      </span>bool<span class="w"> </span>ns3::DefaultSimulatorImpl::IsExpired<span class="o">(</span>const<span class="w"> </span>ns3::EventId<span class="p">&amp;</span><span class="w"> </span>id<span class="o">)</span>
<span class="p">|</span>
<span class="p">|</span><span class="w">  </span>IsFinished<span class="o">(</span>...<span class="o">)</span>
<span class="p">|</span><span class="w">      </span>bool<span class="w"> </span>ns3::DefaultSimulatorImpl::IsFinished<span class="o">()</span>
<span class="p">|</span>
<span class="p">|</span><span class="w">  </span>Now<span class="o">(</span>...<span class="o">)</span>
<span class="p">|</span><span class="w">      </span>ns3::Time<span class="w"> </span>ns3::DefaultSimulatorImpl::Now<span class="o">()</span>
<span class="p">|</span>
<span class="p">|</span><span class="w">  </span>Remove<span class="o">(</span>...<span class="o">)</span>
<span class="p">|</span><span class="w">      </span>void<span class="w"> </span>ns3::DefaultSimulatorImpl::Remove<span class="o">(</span>const<span class="w"> </span>ns3::EventId<span class="p">&amp;</span><span class="w"> </span>id<span class="o">)</span>
<span class="p">|</span>
<span class="p">|</span><span class="w">  </span>Run<span class="o">(</span>...<span class="o">)</span>
<span class="p">|</span><span class="w">      </span>void<span class="w"> </span>ns3::DefaultSimulatorImpl::Run<span class="o">()</span>
</pre></div>
</div>
</section>
</section>
<section id="pip-wheel-packaging">
<h4><span class="section-number">3.8.6. </span>Pip wheel packaging<a class="headerlink" href="#pip-wheel-packaging" title="Link to this heading">¶</a></h4>
<p>This section is meant exclusively for ns-3 maintainers and ns-3
users that want to redistribute their work as wheels for python.</p>
<p>The packaging process is defined in the following GitLab job.
The job is split into blocks explained below.</p>
<p>The manylinux image provides an old glibc compatible with most modern Linux
distributions, resulting on a pip wheel that is compatible across distributions.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">.manylinux-pip-wheel</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/pypa/manylinux_2_28_x86_64</span>
</pre></div>
</div>
<p>Then we install the required toolchain and dependencies necessary for both
ns-3 (e.g. libxml2, gsl, sqlite, gtk, etc) and for the bindings and packaging
(e.g. setuptools, wheel, auditwheel, cmake-build-extension, cppyy).</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install minimal toolchain</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yum install -y libxml2-devel gsl-devel sqlite-devel gtk3-devel boost-devel</span>
<span class="c1"># Create Python venv</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON -m venv ./venv</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">. ./venv/bin/activate</span>
<span class="c1"># Upgrade the pip version to reuse the pre-build cppyy</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON -m pip install pip --upgrade</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON -m pip install setuptools setuptools_scm --upgrade</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON -m pip install wheel auditwheel cmake-build-extension cppyy</span>
</pre></div>
</div>
<p>The project is then configured loading the configuration settings defined
in the <code class="docutils literal notranslate"><span class="pre">ns-3-dev/setup.py</span></code> file.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configure and build wheel</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON setup.py bdist_wheel build_ext &quot;-DNS3_USE_LIB64=TRUE&quot;</span>
</pre></div>
</div>
<p>At this point, we have a wheel that only works in the current system,
since external libraries are not shipped.</p>
<p>Auditwheel needs to be called resolve and copy external libraries
that we need to ship along the ns-3 module libraries (e.g. libxml2, sqlite3,
gtk, gsl, etc). However, we need to prevent auditwheel from shipping copies of
the libraries built by the ns-3 project. A list of excluded libraries is generated
by the script <code class="docutils literal notranslate"><span class="pre">ns-3-dev/build-support/pip-wheel/auditwheel-exclude-list.py</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">export EXCLUDE_INTERNAL_LIBRARIES=`$PYTHON ./build-support/pip-wheel/auditwheel-exclude-list.py`</span>
<span class="c1"># Bundle in shared libraries that were not explicitly packaged or depended upon</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON -m auditwheel repair ./dist/*whl -L /lib64 $EXCLUDE_INTERNAL_LIBRARIES</span>
</pre></div>
</div>
<p>At this point, we should have our final wheel ready, but we need to check if it works
before submitting it to Pypi servers.</p>
<p>We first clean the environment and uninstall the packages previously installed.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clean the build directory</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./ns3 clean</span>
<span class="c1"># Clean up the environment</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deactivate</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rm -R ./venv</span>
<span class="c1"># Delete toolchain to check if required headers/libraries were really packaged</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yum remove -y libxml2-devel gsl-devel sqlite-devel gtk3-devel boost-devel</span>
</pre></div>
</div>
<p>Then we can install our newly built wheel and test it.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install wheel</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON -m pip install ./wheelhouse/*whl</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON -m pip install matplotlib numpy</span>
<span class="c1"># Test the bindings</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./utils/python-unit-tests.py</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./examples/realtime/realtime-udp-echo.py</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./examples/routing/simple-routing-ping6.py</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./examples/tutorial/first.py</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./examples/tutorial/second.py</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./examples/tutorial/third.py</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./examples/wireless/wifi-ap.py</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./examples/wireless/mixed-wired-wireless.py</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./src/bridge/examples/csma-bridge.py</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./src/brite/examples/brite-generic-example.py</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./src/core/examples/sample-simulator.py</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./src/core/examples/sample-rng-plot.py --not-blocking</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./src/click/examples/nsclick-simple-lan.py</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./src/flow-monitor/examples/wifi-olsr-flowmon.py</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./src/flow-monitor/examples/flowmon-parse-results.py output.xml</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$PYTHON ./src/openflow/examples/openflow-switch.py</span>
</pre></div>
</div>
<p>If all programs finish normally, the bindings are working as expected,
and will be saved as an artifact.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">artifacts</span><span class="p">:</span>
<span class="w">  </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wheelhouse/*.whl</span>
</pre></div>
</div>
<p>One can use <code class="docutils literal notranslate"><span class="pre">gitlab-ci-local</span></code> to build the pip wheels locally. After that, the wheels
will be stored in <code class="docutils literal notranslate"><span class="pre">.gitlab-ci-local/artifacts/manylinux-pip-wheel-py3Lg10/wheelhouse</span></code>
(for Python 3.10).</p>
<p>The wheel names are based on the number of commits since the latest release.
For example, a wheel built 415 after the release 3.37 will be named
<code class="docutils literal notranslate"><span class="pre">ns3-3.37.post415-cp310-cp310-manylinux_2_28_x86_64.whl</span></code>.</p>
<p>The wheel name (<code class="docutils literal notranslate"><span class="pre">ns3</span></code>) is defined in the <code class="docutils literal notranslate"><span class="pre">/ns-3-dev/setup.cfg</span></code> file, and that
name should match the build prefix specified in <code class="docutils literal notranslate"><span class="pre">/ns-3-dev/setup.py</span></code> file.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">cp310-cp310</span></code> indicates that this wheel is compatible from Python 3.10 and up to Python 3.10.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">manylinux_2_28</span></code> indicates that this is a manylinux wheel targeting glibc 2.28.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">x86_64</span></code> indicates that this is a 64-bit build targeting Intel/AMD processors.</p>
<p>After packaging, we can either deploy that wheel locally or upload the wheel to Pypi for general availability.</p>
</section>
<section id="local-deployment">
<h4><span class="section-number">3.8.7. </span>Local deployment<a class="headerlink" href="#local-deployment" title="Link to this heading">¶</a></h4>
<p>To deploy a wheel locally, simply share the wheel file across the desired machines.
Then install the wheel and its dependencies running the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>*.whl
</pre></div>
</div>
</section>
<section id="publishing-the-pip-wheel-via-pypi">
<h4><span class="section-number">3.8.8. </span>Publishing the pip wheel via Pypi<a class="headerlink" href="#publishing-the-pip-wheel-via-pypi" title="Link to this heading">¶</a></h4>
<p>Publishing a pip wheel requires a <a class="reference external" href="https://pypi.org/account/register/">Pypi</a> account.</p>
<p>After creating your account, install <a class="reference external" href="https://twine.readthedocs.io/en/stable/">Twine</a>, an utility to upload the wheel to Pypi.</p>
<p>Then run twine to upload the wheel to the Pypi servers.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>twine<span class="w"> </span>upload<span class="w"> </span>.gitlab-ci-local/artifacts/manylinux-pip-wheel-py3Lg10/wheelhouse/*.whl
</pre></div>
</div>
<p>Enter your Pypi username and password as requested.</p>
<p>Your wheel should be up and running. Give it a try just to make sure.</p>
<p>For the upstream pip wheel, try:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>ns3
$<span class="w"> </span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;from ns import ns; print(ns.Simulator.Now())&quot;</span>
</pre></div>
</div>
</section>
<section id="historical-information">
<h4><span class="section-number">3.8.9. </span>Historical Information<a class="headerlink" href="#historical-information" title="Link to this heading">¶</a></h4>
<p>If you are a developer and need more background information on <em>ns-3</em>’s Python bindings,
please see the <a class="reference external" href="http://www.nsnam.org/wiki/NS-3_Python_Bindings">Python Bindings wiki page</a>.
Please note, however, that some information on that page is stale.</p>
</section>
</section>
</div>
</section>
<span id="document-develop"></span><section id="developer-tools">
<h2><span class="section-number">4. </span>Developer Tools<a class="headerlink" href="#developer-tools" title="Link to this heading">¶</a></h2>
<p>This chapter describes the development ecosystem generally used to create new modules.</p>
<div class="toctree-wrapper compound">
<span id="document-working-with-git"></span><section id="working-with-git-as-a-user">
<span id="working-with-git"></span><h3><span class="section-number">4.1. </span>Working with Git as a user<a class="headerlink" href="#working-with-git-as-a-user" title="Link to this heading">¶</a></h3>
<p>The ns-3 project used Mercurial in the past as its source code control system, but it has moved to Git in December 2018. Git is a VCS like Mercurial, Subversion or CVS, and it is used to maintain many open-source (and closed-source) projects. While Git and mercurial have a lot of common properties, if you are new to Git you should read first an introduction to it. The most up-to-date guide is the Git Book, at <a class="reference external" href="https://git-scm.com/book/en/v2/Getting-Started-Git-Basics">https://git-scm.com/book/en/v2/Getting-Started-Git-Basics</a>.</p>
<p>The ns-3 project is officially hosted on GitLab.com at <a class="reference external" href="https://gitlab.com/nsnam/">https://gitlab.com/nsnam/</a>.  For convenience and historical reasons, ns-3-dev mirrors are currently posted on Bitbucket.com and GitHub.com, and kept in sync with the official repository periodically via cron jobs.  We recommend that users who have been working from one of these mirrors repoint their remotes so that they pull origin or upstream from GitLab.com (see below explanation about how to configure remotes).</p>
<p>This section of the manual provides common tips for both users and maintainers. Since the first part is shared, in this manual section we will start with a personal repository and then explain what to do in some typical cases. ns-3 users often combine ns-3-dev with other repositories (netanim, apps from the app store).  This manual chapter does not cover this use case; it only focuses on the single ns-3-dev repository.  See other project documentation such as the ns-3 tutorial for descriptions on bundled releases distributed as source archives, or on the bake build tool for managing multiple repositories.  The guidelines listed below also largely pertain to the user who is using (and cloning) bake from the GitLab.com repository.</p>
<section id="ns-3-s-git-workflow-in-a-nutshell">
<h4><span class="section-number">4.1.1. </span>ns-3’s Git workflow in a nutshell<a class="headerlink" href="#ns-3-s-git-workflow-in-a-nutshell" title="Link to this heading">¶</a></h4>
<p>Experienced Git users will not necessarily need instruction on how to set up personal repositories (below).  However, they should be aware of the project’s workflow:</p>
<ul class="simple">
<li><p>The main repository’s <code class="docutils literal notranslate"><span class="pre">master</span></code> branch is the main development branch.  The project maintains only this one branch and strives to maintain a mostly linear history on it.</p></li>
<li><p>Releases are made by creating a branch from the <code class="docutils literal notranslate"><span class="pre">master</span></code> branch and tagging the branch with the release number when ready, and then merging the release branch back to the <code class="docutils literal notranslate"><span class="pre">master</span></code> branch.  Releases can be identified by a Git tag, and a modified <code class="docutils literal notranslate"><span class="pre">VERSION</span></code> file in the branch.  However, the modified <code class="docutils literal notranslate"><span class="pre">VERSION</span></code> file is not merged back to <code class="docutils literal notranslate"><span class="pre">master</span></code>.</p>
<ul>
<li><p>If a hotfix release must be made to update a past release, a new hotfix support branch will be created by branching from the tip of the last relevant release.  Changesets from <code class="docutils literal notranslate"><span class="pre">master</span></code> branch (such as bug fixes) may be cherry-picked to the hotfix branch.  The hotfix release is tagged with the hotfix version number, and merged back to the <code class="docutils literal notranslate"><span class="pre">master</span></code> branch.</p></li>
</ul>
</li>
<li><p>Merges to the ns-3 <code class="docutils literal notranslate"><span class="pre">master</span></code> branch are fast forwarded when possible, and commits can be squashed as appropriate, to maintain a clean linear history.  Merge commits can be avoided in simple cases.</p>
<ul>
<li><p>More complicated merges might not be able to be fast forwarded, with the result that there will be a merge commit upon the merge.</p></li>
</ul>
</li>
<li><p>Maintainers can commit obvious non-critical fixes (documentation improvements, typos etc.) directly into the <code class="docutils literal notranslate"><span class="pre">master</span></code> branch.  Users who are not maintainers can create GitLab.com Merge Requests for small items such as these, for maintainers to review.</p></li>
<li><p>Maintainers can directly commit bug fixes to their maintained modules without review/approval by other maintainers, although a review phase is recommended for non-trivial fixes.  Larger commits that touch multiple modules should be reviewed and approved by the set of affected maintainers.</p></li>
<li><p>When proposing code (new features, bug fixes, etc.) for a module maintained by someone else, the typical workflow will be to fork the <code class="docutils literal notranslate"><span class="pre">nsnam/ns-3-dev.git</span></code> repository, create a local feature branch on your fork, and use GitLab.com to generate a Merge Request towards <code class="docutils literal notranslate"><span class="pre">nsnam/ns-3-dev.git</span></code> when ready.  The Merge Request will then be reviewed, and in response to changes requested or comments from maintainers, authors are are asked to modify their feature branch and rebase to the tip of <code class="docutils literal notranslate"><span class="pre">ns-3-dev.git</span></code> as needed.</p></li>
</ul>
</section>
<section id="setup-of-a-personal-repository">
<h4><span class="section-number">4.1.2. </span>Setup of a personal repository<a class="headerlink" href="#setup-of-a-personal-repository" title="Link to this heading">¶</a></h4>
<p>We will provide two ways, one anonymous (but will impede the creation of merge requests) and the other, preferred, that include forking the repository through the GitLab.com web interface.</p>
<section id="directly-cloning-ns-3-dev">
<span id="id1"></span><h5><span class="section-number">4.1.2.1. </span>Directly cloning ns-3-dev<a class="headerlink" href="#directly-cloning-ns-3-dev" title="Link to this heading">¶</a></h5>
<p>If you go to the official ns-3-dev page, hosted at <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev">https://gitlab.com/nsnam/ns-3-dev</a>, you can find a button that says <code class="docutils literal notranslate"><span class="pre">Clone</span></code>. If you are not logged in, then you will see only the option of cloning the repository through HTTPS, with this command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://gitlab.com/nsnam/ns-3-dev.git
</pre></div>
</div>
<p>If this command exits successfully, you will have a newly created <cite>ns-3-dev</cite> directory with all the source code.</p>
</section>
<section id="forking-ns-3-dev-on-gitlab-com">
<h5><span class="section-number">4.1.2.2. </span>Forking ns-3-dev on GitLab.com<a class="headerlink" href="#forking-ns-3-dev-on-gitlab-com" title="Link to this heading">¶</a></h5>
<p>Assume that you are the user <em>john</em> on GitLab.com and that you want to create a new repository that is synced with nsnam/ns-3-dev.</p>
<ol class="arabic simple">
<li><p>Log into GitLab.com</p></li>
<li><p>Navigate to <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev">https://gitlab.com/nsnam/ns-3-dev</a></p></li>
<li><p>In the top-right corner of the page, click <code class="docutils literal notranslate"><span class="pre">Fork</span></code>.</p></li>
</ol>
<p>Note that you may only do this once; if you try to fork again, Gitlab will take you to the page of the original fork. So, if you are planning to maintain two or more separate forks (for example, one for your private work, another for maintenance, etc.), you are doing a mistake. Instead, you should add these forks as a remote of your existing directory (see below for adding remotes). Usually, it is a good thing to add the maintainer’s repository as remotes, because it can happen that “bleeding edge” features will appear there before landing in ns-3-dev.</p>
<p>For more information on forking with Gilab, there is plenty of visual documentation (<a class="reference external" href="https://docs.gitlab.com/ee/user/project/repository/forking_workflow.html">https://docs.gitlab.com/ee/user/project/repository/forking_workflow.html</a>). To work with your forked repository, you have two ways: one is a clean clone while the other is meant to re-use an existing ns-3 Git repository.</p>
<section id="clone-your-forked-repository-on-your-machine">
<h6><span class="section-number">4.1.2.2.1. </span>Clone your forked repository on your machine<a class="headerlink" href="#clone-your-forked-repository-on-your-machine" title="Link to this heading">¶</a></h6>
<p>Git is a distributed versioning system. This means that <em>nobody</em> will touch your personal repository, until you do something. Please note that every gitlab user has, at least, two repositories: the first is represented by the repository hosted on gitlab servers, which will be called in the following <code class="docutils literal notranslate"><span class="pre">origin</span></code>. Then, you have your clone on your machine. This means that you could have many clones, on different machines, which points to <code class="docutils literal notranslate"><span class="pre">origin</span></code>.</p>
<p>To clone the newly created fork to your system, go to the homepage of your fork (that should be in the form <cite>https://gitlab.com/your-user-name/ns-3-dev</cite>) and click the <cite>Clone</cite> button. Then, go to your computer’s terminal, and issue the command (please refer to <a class="reference external" href="https://docs.gitlab.com/ee/gitlab-basics/command-line-commands.html#clone-your-project">https://docs.gitlab.com/ee/gitlab-basics/command-line-commands.html#clone-your-project</a> for more documentation):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://gitlab.com/your-user-name/ns-3-dev
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>ns-3-dev
</pre></div>
</div>
<p>In this example we used the HTTPS address because in some place the git + ssh address is blocked by firewalls. If you are not under this constraint, it is recommended to use the git + ssh address to avoid the username/password typing at each request.</p>
</section>
<section id="naming-conventions">
<h6><span class="section-number">4.1.2.2.2. </span>Naming conventions<a class="headerlink" href="#naming-conventions" title="Link to this heading">¶</a></h6>
<p>Git is able to fetch and push changes to several repositories, each of them is called <code class="docutils literal notranslate"><span class="pre">remote</span></code>. With time, you probably will have many remotes, each one with many branches. To avoid confusion, it is recommended to give meaningful names to the remotes. Following the Git terminology, we will use <code class="docutils literal notranslate"><span class="pre">origin</span></code> to indicate the ns-3-dev repository in your personal namespace (your forked version, server-side) and <code class="docutils literal notranslate"><span class="pre">upstream</span></code> to indicate the ns-3-dev repository in the nsnam namespace, server-side.</p>
</section>
</section>
</section>
<section id="add-the-official-ns-3-repository-as-remote-upstream">
<h4><span class="section-number">4.1.3. </span>Add the official ns-3 repository as remote upstream<a class="headerlink" href="#add-the-official-ns-3-repository-as-remote-upstream" title="Link to this heading">¶</a></h4>
<p>You could have already used Git in the past, and therefore already having a ns-3 Git repository somewhere. Or, instead, you could have it cloned for the first time in the step above. In both cases, when you fork/clone a repository, your history is no more bound to the repository itself. At this point, it is your duty to sync your fork with the original repository. The first remote repository we have encountered is <code class="docutils literal notranslate"><span class="pre">origin</span></code>; we must add the official ns-3 repo as another remote repository:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>remote<span class="w"> </span>add<span class="w"> </span>upstream<span class="w"> </span>https://gitlab.com/nsnam/ns-3-dev
</pre></div>
</div>
<p>With the command above, we added a remote repository, named upstream, which links to the official ns-3 repo. To show your remote repositories:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>remote<span class="w"> </span>show
</pre></div>
</div>
<p>To see what <code class="docutils literal notranslate"><span class="pre">origin</span></code> is linking to:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>remote<span class="w"> </span>show<span class="w"> </span>origin
</pre></div>
</div>
<p>Many options are available; please refer to the Git manual for more.</p>
</section>
<section id="add-your-forked-repository-as-remote">
<h4><span class="section-number">4.1.4. </span>Add your forked repository as remote<a class="headerlink" href="#add-your-forked-repository-as-remote" title="Link to this heading">¶</a></h4>
<p>If you were a user of the old github mirror, you probably have an existing Git repository installed somewhere. In your case, it is not necessary to clone your fork and to port all your work in the new directory; you can add the fork as new remote:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>remote<span class="w"> </span>rename<span class="w"> </span>origin<span class="w"> </span>old-origin
$<span class="w"> </span>git<span class="w"> </span>remote<span class="w"> </span>add<span class="w"> </span>origin<span class="w"> </span>https://gitlab.com/your-user-name/ns-3-dev
</pre></div>
</div>
<p>After these two commands, you will have a remote, named origin, that points
to your forked repository on gitlab.</p>
</section>
<section id="keep-in-sync-your-repository-with-latest-ns-3-dev-updates">
<h4><span class="section-number">4.1.5. </span>Keep in sync your repository with latest ns-3-dev updates<a class="headerlink" href="#keep-in-sync-your-repository-with-latest-ns-3-dev-updates" title="Link to this heading">¶</a></h4>
<p>We assume, from now to the end of this document, that you will not make commits on top of the master branch. It should be kept clean from <em>any</em> personal modifications: all the works must be done in branches. Therefore, to move the current HEAD of the master branch to the latest commit in ns-3-dev, you should do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>master
$<span class="w"> </span>git<span class="w"> </span>fetch<span class="w"> </span>upstream
$<span class="w"> </span>git<span class="w"> </span>pull<span class="w"> </span>upstream<span class="w"> </span>master
</pre></div>
</div>
<p>If you tried a pull which resulted in a conflict and you would like to start over, you can recover with Git reset (but this never happens if you do not commit over master).</p>
</section>
<section id="start-a-new-branch-to-do-some-work">
<h4><span class="section-number">4.1.6. </span>Start a new branch to do some work<a class="headerlink" href="#start-a-new-branch-to-do-some-work" title="Link to this heading">¶</a></h4>
<p>Look at the available branches:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>branch<span class="w"> </span>-a
</pre></div>
</div>
<p>you should see something like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>*<span class="w"> </span>master
<span class="w">  </span>remotes/origin/master
<span class="w">  </span>remotes/upstream/master
</pre></div>
</div>
<p>The branch master is your local master branch; remotes/origin/master point at the master branch on your repository located in the Gitlab server, while remotes/nsnam/master points to the official master branch.</p>
<p>Before entering in details on how to create a new branch, we have to explain why it is recommended to do it. First of all, if you put all your work in a separate branch, you can easily see the diff between ns-3 mainline and your feature branch (with <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">diff</span> <span class="pre">master</span></code>). Also, you can integrate more easily the upstream advancements in your work, and when you wish, you can create a <em>conflict-free</em> merge request, that will ease the maintainer’s job in reviewing your work.</p>
<p>To create a new branch, starting from master, the command is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>master
$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span><span class="o">[</span>name_of_your_new_branch<span class="o">]</span>
</pre></div>
</div>
<p>To switch between branches, remove the -b option. You should now see:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>branch<span class="w"> </span>-a
<span class="w"> </span>*<span class="w"> </span>master
<span class="w">  </span><span class="o">[</span>name_of_your_new_branch<span class="o">]</span>
<span class="w">  </span>remotes/origin/master
<span class="w">  </span>remotes/upstream/master
</pre></div>
</div>
</section>
<section id="edit-and-commit-the-modifications">
<h4><span class="section-number">4.1.7. </span>Edit and commit the modifications<a class="headerlink" href="#edit-and-commit-the-modifications" title="Link to this heading">¶</a></h4>
<p>After you edit some file, you should commit the difference. As a policy, Git users love small and incremental patches. So, commit early, and commit often: you could rewrite your history later.</p>
<p>Suppose we edited <code class="docutils literal notranslate"><span class="pre">src/internet/model/tcp-socket-base.cc</span></code>. With Git status, we can see the repository status:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>status
<span class="w">   </span>On<span class="w"> </span>branch<span class="w"> </span>tcp-next
<span class="w">   </span>Your<span class="w"> </span>branch<span class="w"> </span>is<span class="w"> </span>up-to-date<span class="w"> </span>with<span class="w"> </span><span class="s1">&#39;mirror/tcp-next&#39;</span>.
<span class="w">   </span>Changes<span class="w"> </span>not<span class="w"> </span>staged<span class="w"> </span><span class="k">for</span><span class="w"> </span>commit:
<span class="w">     </span>modified:<span class="w">   </span>src/internet/model/tcp-socket-base.cc
</pre></div>
</div>
<p>and we can see the edits with git diff:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ git diff

nat@miyamoto ~/Work/ns-3-dev-git (tcp-next)$ git diff
diff --git i/src/internet/model/tcp-socket-base.cc w/src/internet/model/tcp-socket-base.cc
index 1bf0f69..e2298b0 100644
--- i/src/internet/model/tcp-socket-base.cc
+++ w/src/internet/model/tcp-socket-base.cc
@@ -1439,6 +1439,10 @@ TcpSocketBase::ReceivedAck (Ptr&lt;Packet&gt; packet, const TcpHeader&amp; tcpHeader)
       // There is a DupAck
       ++m_dupAckCount;

+      // I&#39;m introducing a subtle bug!
+
+      m_tcb-&gt;m_cWnd = m_tcb-&gt;m_ssThresh;
+
       if (m_tcb-&gt;m_congState == TcpSocketState::CA_OPEN)
         {
           // From Open we go Disorder
</pre></div>
</div>
<p>To create a commit, select the file you want to add to the commit with git add:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>src/internet/model/tcp-socket-base.cc
</pre></div>
</div>
<p>and then commit the result:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;My new TCP broken&quot;</span>
</pre></div>
</div>
<p>Of course, it would be better to have some rules for the commit message: they will be reported in the next subsection.</p>
<section id="commit-message-guidelines">
<h5><span class="section-number">4.1.7.1. </span>Commit message guidelines<a class="headerlink" href="#commit-message-guidelines" title="Link to this heading">¶</a></h5>
<p>The commit title should not go over the 80 char limit. It should be prefixed by the name of the module you are working on, and if it fixes a bug, it should reference it in the commit title. For instance, a good commit title would be:</p>
<blockquote>
<div><p>tcp: My new TCP broken</p>
</div></blockquote>
<p>Another example is:</p>
<blockquote>
<div><p>tcp: (fixes #2322) Corrected the uint32_t wraparound during recovery</p>
</div></blockquote>
<p>In the body message, try to explain what the problem was, and how you resolved that. If it is a new feature, try to describe it at a very high level, and highlight any modifications that changed the behaviour or the interface towards the users or other modules.</p>
</section>
<section id="commit-log">
<h5><span class="section-number">4.1.7.2. </span>Commit log<a class="headerlink" href="#commit-log" title="Link to this heading">¶</a></h5>
<p>You can see the history of the commits with git log. To show a particular commit, copy the sha-id and use <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">show</span> <span class="pre">&lt;sha-id&gt;</span></code>. The ID is unique, so it can be referenced in emails or in issues. The next step is useful if you plan to contribute back your changes, but also to keep your feature branch updated with the latest changes from ns-3-dev.</p>
</section>
</section>
<section id="rebase-your-branch-on-top-of-master">
<h4><span class="section-number">4.1.8. </span>Rebase your branch on top of master<a class="headerlink" href="#rebase-your-branch-on-top-of-master" title="Link to this heading">¶</a></h4>
<p>Meanwhile you were busy with your branch, the upstream master could have changed. To rebase your work with the now new master, first of all sync your master branch (pulling the upstream/master branch into your local master branch) as explained before; then</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span><span class="o">[</span>name_of_your_new_branch<span class="o">]</span>
$<span class="w"> </span>git<span class="w"> </span>rebase<span class="w"> </span>master
</pre></div>
</div>
<p>The last command will rewind your work, update the HEAD of your branch to the actual master, and then re-apply all your work. If some of your work conflicts with the actual master, you will be asked to fix these conflicts if automatic merge fails.</p>
</section>
<section id="pushing-your-changes-to-origin">
<h4><span class="section-number">4.1.9. </span>Pushing your changes to origin<a class="headerlink" href="#pushing-your-changes-to-origin" title="Link to this heading">¶</a></h4>
<p>After you have done some work on a branch, if you would like to share it with others, there is nothing better than pushing your work to your origin repository, on Gitlab servers.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span><span class="o">[</span>name_of_your_new_branch<span class="o">]</span>
$<span class="w"> </span>git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span><span class="o">[</span>name_of_your_new_branch<span class="o">]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span></code> command can be used every time you need to push something from your computer to a remote repository, except when you propose changes to the main ns-3-dev repository: your changes must pass a review stage.</p>
<p>Please note that for older Git version, the push command looks like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>push<span class="w"> </span>-u<span class="w"> </span>origin<span class="w"> </span><span class="o">[</span>name_of_your_new_branch<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="submit-work-for-review">
<h4><span class="section-number">4.1.10. </span>Submit work for review<a class="headerlink" href="#submit-work-for-review" title="Link to this heading">¶</a></h4>
<p>After you push your branch to origin, you can follow the instructions here <a class="reference external" href="https://docs.gitlab.com/ee/user/project/merge_requests/creating_merge_requests.html">https://docs.gitlab.com/ee/user/project/merge_requests/creating_merge_requests.html</a>
to create a merge request.</p>
<p>It is strongly suggested to rebase your branch on top of upstream/master (or master, if you kept it synced) before submitting your work.
This helps reviewing the code changes proposed in the branch. merge it without conflicts, and it increase the speed of the GitLab CI.</p>
<section id="gitlab-ci-continuous-integration">
<h5><span class="section-number">4.1.10.1. </span>GitLab CI (Continuous Integration)<a class="headerlink" href="#gitlab-ci-continuous-integration" title="Link to this heading">¶</a></h5>
<p>GitLab provides a CI (Continuous Integration) feature. Shortly put, after every push the code is built and tests are run in one of the GitLab servers.</p>
<p>Merge requests are expected to pass the CI, as is to not generate errors or warnings during compilation, to have all the tests passing, and to not generate warnings on the documentation.
Hence, the CI is very important for the workflow. However, sometimes running the Ci is superfluous, for example:</p>
<ul class="simple">
<li><p>You are in the middle of some work (and perhaps you know that there are errors),</p></li>
<li><p>Your changes are not tested by the CI (e.g., changes to the AUTHORS),</p></li>
<li><p>Etc.</p></li>
</ul>
<p>In these cases it is useful to skip the CI to save time, CI runners quota, and energy. This is possible by using the <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">ci.skip</span></code> option:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>push<span class="w"> </span>-o<span class="w"> </span>ci.skip
</pre></div>
</div>
</section>
<section id="gitlab-ci-optimization">
<h5><span class="section-number">4.1.10.2. </span>GitLab CI optimization<a class="headerlink" href="#gitlab-ci-optimization" title="Link to this heading">¶</a></h5>
<p>The GitLab Ci jobs are optimized to take advantage of caches (this is done automatically).</p>
<p>In order to take full advantage of the caches, it is suggested to rebase your branches on top of upstream/master (or your own ‘master’ branch if you keep it synced with the latest commits from upstream/master).</p>
</section>
</section>
<section id="porting-patches-from-mercurial-repositories-to-git">
<h4><span class="section-number">4.1.11. </span>Porting patches from mercurial repositories to Git<a class="headerlink" href="#porting-patches-from-mercurial-repositories-to-git" title="Link to this heading">¶</a></h4>
<p><em>Placeholder section; please improve it.</em></p>
</section>
</section>
<section id="working-with-git-as-a-maintainer">
<h3><span class="section-number">4.2. </span>Working with Git as a maintainer<a class="headerlink" href="#working-with-git-as-a-maintainer" title="Link to this heading">¶</a></h3>
<p>As a maintainer, you are a person who has write access to the main nsnam repository. You could push your own work (without passing from code review) or push someone else’s work. Let’s investigate the two cases.</p>
<section id="pushing-your-own-work">
<h4><span class="section-number">4.2.1. </span>Pushing your own work<a class="headerlink" href="#pushing-your-own-work" title="Link to this heading">¶</a></h4>
<p>Since you have been added to the Developer list on Gitlab (if not, please open an issue) you can use the git + ssh address when adding nsnam as remote. Once you have done that, you can do your modifications to a local branch, then update the master to point to the latest changes of the nsnam repo, and then:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>master
$<span class="w"> </span>git<span class="w"> </span>pull<span class="w"> </span>upstream<span class="w"> </span>master
$<span class="w"> </span>git<span class="w"> </span>merge<span class="w"> </span><span class="o">[</span>your_branch_name<span class="o">]</span>
$<span class="w"> </span>git<span class="w"> </span>push<span class="w"> </span>upstream<span class="w"> </span>master
</pre></div>
</div>
<p>Please note that if you want to keep track of your branch, you can use as command <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">merge</span> <span class="pre">--no-ff</span> <span class="pre">[your_branch_name]</span></code>. It is always recommended to rebase your branch before merging, to have a clean history. That is not a requirement, though: Git perfectly handles a master with parallel merged branches.</p>
</section>
<section id="review-and-merge-someone-else-s-work">
<h4><span class="section-number">4.2.2. </span>Review and merge someone else’s work<a class="headerlink" href="#review-and-merge-someone-else-s-work" title="Link to this heading">¶</a></h4>
<p>Gitlab.com has a plenty of documentation on how to handle merge requests. Please take a look here: <a class="reference external" href="https://docs.gitlab.com/ee/user/project/merge_requests/creating_merge_requests.html">https://docs.gitlab.com/ee/user/project/merge_requests/creating_merge_requests.html</a>.</p>
<p>If you are committing a patch from someone else, and it is not coming through a Merge Request process, you can use the –author=’’ argument to ‘git commit’ to assign authorship to another email address (such as we have done in the past with the Mercurial -u option).</p>
</section>
<section id="making-a-release">
<h4><span class="section-number">4.2.3. </span>Making a release<a class="headerlink" href="#making-a-release" title="Link to this heading">¶</a></h4>
<p>As stated above, the project has adopted a workflow to aim for a mostly
linear history on a single <code class="docutils literal notranslate"><span class="pre">master</span></code> branch.  Releases are branches from
this <code class="docutils literal notranslate"><span class="pre">master</span></code> branch but the branches themselves are not long-lived;
the release branches are merged back to <code class="docutils literal notranslate"><span class="pre">master</span></code> in a special way.  However,
the release branches can be checked out by using the Git tag facility;
a named release such as ‘ns-3.30’ can be checked out on a branch by specifying
the release name ‘ns-3.30’ (or ‘ns-3.30.1’ etc.).</p>
<p>A compact way to represent a Git history is the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>log<span class="w"> </span>--graph<span class="w"> </span>--decorate<span class="w"> </span>--oneline<span class="w"> </span>--all
</pre></div>
</div>
<p>At the point just before the ns-3.34 release, the log looked like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>*<span class="w"> </span>9df8ef4<span class="w"> </span><span class="o">(</span>HEAD<span class="w"> </span>-&gt;<span class="w"> </span>master<span class="o">)</span><span class="w"> </span>doc:<span class="w"> </span>Update<span class="w"> </span>ns-3<span class="w"> </span>version<span class="w"> </span><span class="k">in</span><span class="w"> </span>tutorial<span class="w"> </span>examples
*<span class="w"> </span>9319cdd<span class="w"> </span><span class="o">(</span>origin/master,<span class="w"> </span>origin/HEAD<span class="o">)</span><span class="w"> </span>Update<span class="w"> </span>CHANGES.html<span class="w"> </span>and<span class="w"> </span>RELEASE_NOTES
*<span class="w"> </span>8da68b5<span class="w"> </span>wifi:<span class="w"> </span>Fix<span class="w"> </span>typo<span class="w"> </span><span class="k">in</span><span class="w"> </span>channel<span class="w"> </span>access<span class="w"> </span>manager<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>We want the release to create a small branch that is merged (in a special
way) back to the mainline, yielding something like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>*<span class="w"> </span>4b27025<span class="w"> </span><span class="o">(</span>master<span class="o">)</span><span class="w"> </span>Update<span class="w"> </span>release<span class="w"> </span>files<span class="w"> </span>to<span class="w"> </span>start<span class="w"> </span>next<span class="w"> </span>release
*<span class="w">   </span>fd075f6<span class="w"> </span>Merge<span class="w"> </span>ns-3.34-release<span class="w"> </span>branch
<span class="p">|</span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>*<span class="w"> </span>3fab3cf<span class="w"> </span><span class="o">(</span>HEAD,<span class="w"> </span>tag:<span class="w"> </span>ns-3.34<span class="o">)</span><span class="w"> </span>Update<span class="w"> </span>availability<span class="w"> </span><span class="k">in</span><span class="w"> </span>RELEASE_NOTES
<span class="p">|</span><span class="w"> </span>*<span class="w"> </span>c50aaf7<span class="w"> </span>Update<span class="w"> </span>VERSION<span class="w"> </span>and<span class="w"> </span>documentation<span class="w"> </span>tags<span class="w"> </span><span class="k">for</span><span class="w"> </span>ns-3.34<span class="w"> </span>release
<span class="p">|</span>/
*<span class="w"> </span>9df8ef4<span class="w"> </span>doc:<span class="w"> </span>Update<span class="w"> </span>ns-3<span class="w"> </span>version<span class="w"> </span><span class="k">in</span><span class="w"> </span>tutorial<span class="w"> </span>examples
*<span class="w"> </span>9319cdd<span class="w"> </span><span class="o">(</span>origin/master,<span class="w"> </span>origin/HEAD<span class="o">)</span><span class="w"> </span>Update<span class="w"> </span>CHANGES.html<span class="w"> </span>and<span class="w"> </span>RELEASE_NOTES
</pre></div>
</div>
<p>The first commit on the release branch changes the ‘3-dev’ string in VERSION
and the various documentation conf.py files to ‘3.34’.  The second commit
on the release branch updates RELEASE_NOTES to state the URL of the release.</p>
<p>Starting with commit 9df8ef4, the following steps were taken to create the
ns-3.34 release.  First, this commit hash ‘9df8ef4’ will be used later in
the merge process.</p>
<p>First, create a new release branch locally:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span><span class="s1">&#39;ns-3.34-release&#39;</span>
Switched<span class="w"> </span>to<span class="w"> </span>a<span class="w"> </span>new<span class="w"> </span>branch<span class="w"> </span><span class="s1">&#39;ns-3.34-release&#39;</span>
</pre></div>
</div>
<p>We change the VERSION field from ‘3-dev’ to ‘3.34’:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/3-dev/3.34/g&#39;</span><span class="w"> </span>VERSION
$<span class="w"> </span>cat<span class="w"> </span>VERSION
<span class="m">3</span>.34
</pre></div>
</div>
<p>We next change the file conf.py in the contributing, tutorial, manual, and models directories
to change the strings ‘ns-3-dev’ to ns-3.34.</p>
<p>When you are done, the ‘git diff –stat’ command should show:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>VERSION<span class="w">                         </span><span class="p">|</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>+-
doc/contributing/source/conf.py<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>++--
doc/manual/source/conf.py<span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>++--
doc/models/source/conf.py<span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>++--
doc/tutorial/source/conf.py<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">4</span><span class="w"> </span>++--
<span class="m">5</span><span class="w"> </span>files<span class="w"> </span>changed,<span class="w"> </span><span class="m">9</span><span class="w"> </span>insertions<span class="o">(</span>+<span class="o">)</span>,<span class="w"> </span><span class="m">9</span><span class="w"> </span>deletions<span class="o">(</span>-<span class="o">)</span>
</pre></div>
</div>
<p>Make a commit of these files:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-a<span class="w"> </span>-m<span class="s2">&quot;Update VERSION and documentation tags for ns-3.34 release&quot;</span>
</pre></div>
</div>
<p>Next, make the following change to RELEASE_NOTES.md and commit it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>-Release<span class="w"> </span><span class="m">3</span>-dev
--------------
+Release<span class="w"> </span><span class="m">3</span>.34
+------------
+
+###<span class="w"> </span>Availability
+
+This<span class="w"> </span>release<span class="w"> </span>is<span class="w"> </span>available<span class="w"> </span>from:
+&lt;https://www.nsnam.org/release/ns-allinone-3.34.tar.bz2&gt;
</pre></div>
</div>
<p>Commit this change:</p>
<blockquote>
<div><p>$ git commit -m”Update availability in RELEASE_NOTES.md” RELEASE_NOTES.md</p>
</div></blockquote>
<p>Finally, add a Git annotated tag:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>tag<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;ns-3.34&#39;</span><span class="w"> </span>-m<span class="s2">&quot;ns-3.34 release&quot;</span>
</pre></div>
</div>
<p>Now, let’s merge back to <code class="docutils literal notranslate"><span class="pre">master</span></code>.  However, we want to avoid touching
the <code class="docutils literal notranslate"><span class="pre">VERSION</span></code> and <code class="docutils literal notranslate"><span class="pre">conf.py</span></code> files on <code class="docutils literal notranslate"><span class="pre">master</span></code>; we want the RELEASE_NOTES
change and new tag.  We can accomplish this with a special merge as follows.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>master
$<span class="w"> </span>git<span class="w"> </span>merge<span class="w"> </span>--no-commit<span class="w"> </span>--no-ff<span class="w"> </span>ns-3.34-release
Automatic<span class="w"> </span>merge<span class="w"> </span>went<span class="w"> </span>well<span class="p">;</span><span class="w"> </span>stopped<span class="w"> </span>before<span class="w"> </span>committing<span class="w"> </span>as<span class="w"> </span>requested
</pre></div>
</div>
<p>Now, we want to reset VERSION to the previous string, which existed before
we branched.  We can use <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">reset</span></code> on this file and then finish the merge.
Recall its commit hash of <code class="docutils literal notranslate"><span class="pre">9df8ef4</span></code> from above.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>reset<span class="w"> </span>9df8ef4<span class="w"> </span>VERSION
Unstaged<span class="w"> </span>changes<span class="w"> </span>after<span class="w"> </span>reset:
M<span class="w"> </span>VERSION
$<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/3.34/3-dev/g&#39;</span><span class="w"> </span>VERSION
$<span class="w"> </span>cat<span class="w"> </span>VERSION
<span class="m">3</span>-dev
</pre></div>
</div>
<p>Repeat the above resets and change back to <code class="docutils literal notranslate"><span class="pre">3-dev</span></code> for each conf.py file.</p>
<p>Finally, commit the branch and delete our local release branch.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="s2">&quot;Merge ns-3.34-release branch&quot;</span>
$<span class="w"> </span>git<span class="w"> </span>branch<span class="w"> </span>-d<span class="w"> </span>ns-3.34-release
</pre></div>
</div>
<p>The Git history now looks like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>log<span class="w"> </span>--graph<span class="w"> </span>--decorate<span class="w"> </span>--oneline<span class="w"> </span>--all
*<span class="w">   </span>fd075f6<span class="w"> </span><span class="o">(</span>HEAD<span class="w"> </span>-&gt;<span class="w"> </span>master<span class="o">)</span><span class="w"> </span>Merge<span class="w"> </span>ns-3.34-release<span class="w"> </span>branch
<span class="p">|</span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>*<span class="w"> </span>3fab3cf<span class="w"> </span><span class="o">(</span>HEAD,<span class="w"> </span>tag:<span class="w"> </span>ns-3.34<span class="o">)</span><span class="w"> </span>Update<span class="w"> </span>availability<span class="w"> </span><span class="k">in</span><span class="w"> </span>RELEASE_NOTES
<span class="p">|</span><span class="w"> </span>*<span class="w"> </span>c50aaf7<span class="w"> </span>Update<span class="w"> </span>VERSION<span class="w"> </span>and<span class="w"> </span>documentation<span class="w"> </span>tags<span class="w"> </span><span class="k">for</span><span class="w"> </span>ns-3.34<span class="w"> </span>release
<span class="p">|</span>/
*<span class="w"> </span>9df8ef4<span class="w"> </span>doc:<span class="w"> </span>Update<span class="w"> </span>ns-3<span class="w"> </span>version<span class="w"> </span><span class="k">in</span><span class="w"> </span>tutorial<span class="w"> </span>examples
*<span class="w"> </span>9319cdd<span class="w"> </span><span class="o">(</span>origin/master,<span class="w"> </span>origin/HEAD<span class="o">)</span><span class="w"> </span>Update<span class="w"> </span>CHANGES.html<span class="w"> </span>and<span class="w"> </span>RELEASE_NOTES
</pre></div>
</div>
<p>This may now be pushed to <code class="docutils literal notranslate"><span class="pre">nsnam/ns-3-dev.git</span></code> and development can continue.</p>
<p><strong>Important:</strong>  When pushing to the remote, don’t forget to push the tags:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>push<span class="w"> </span>--follow-tags
</pre></div>
</div>
<p>Future users who want to check out the ns-3.34 release will do something like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>my-local-ns-3.34<span class="w"> </span>ns-3.34
Switched<span class="w"> </span>to<span class="w"> </span>a<span class="w"> </span>new<span class="w"> </span>branch<span class="w"> </span><span class="s1">&#39;my-local-ns-3.34&#39;</span>
</pre></div>
</div>
<p><strong>Note:</strong>  It is a good idea to avoid naming the new branch the same as the tag
name; in this case, ‘ns-3.34’.</p>
<p>Let’s assume now that master evolves with new features and bugfixes.  They
are committed to <code class="docutils literal notranslate"><span class="pre">master</span></code> on <code class="docutils literal notranslate"><span class="pre">nsnam/ns-3-dev.git</span></code> as usual:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>master
...<span class="w"> </span><span class="o">(</span>some<span class="w"> </span>changes<span class="o">)</span>
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="s2">&quot;make some changes&quot;</span><span class="w"> </span>-a
$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;d&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>d
$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>d
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="s2">&quot;Add new feature&quot;</span><span class="w"> </span>d
...<span class="w"> </span><span class="o">(</span>some<span class="w"> </span>more<span class="w"> </span>changes<span class="o">)</span>
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="s2">&quot;some more changes&quot;</span><span class="w"> </span>-a
...<span class="w"> </span><span class="o">(</span>now<span class="w"> </span>fix<span class="w"> </span>a<span class="w"> </span>really<span class="w"> </span>important<span class="w"> </span>bug<span class="o">)</span>
$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;abc&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>a
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="s2">&quot;Fix missing abc bug on file a&quot;</span><span class="w"> </span>a
</pre></div>
</div>
<p>Now the tree looks like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>log<span class="w"> </span>--graph<span class="w"> </span>--decorate<span class="w"> </span>--oneline<span class="w"> </span>--all
*<span class="w"> </span>ee37d41<span class="w"> </span><span class="o">(</span>HEAD<span class="w"> </span>-&gt;<span class="w"> </span>master<span class="o">)</span><span class="w"> </span>Fix<span class="w"> </span>missing<span class="w"> </span>abc<span class="w"> </span>bug<span class="w"> </span>on<span class="w"> </span>file<span class="w"> </span>a
*<span class="w"> </span>9a3432a<span class="w"> </span>some<span class="w"> </span>more<span class="w"> </span>changes
*<span class="w"> </span>ba28d6d<span class="w"> </span>Add<span class="w"> </span>new<span class="w"> </span>feature
*<span class="w"> </span>e50015a<span class="w"> </span>make<span class="w"> </span>some<span class="w"> </span>changes
*<span class="w">   </span>fd075f6<span class="w"> </span>Merge<span class="w"> </span>ns-3.34-release<span class="w"> </span>branch
<span class="p">|</span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>*<span class="w"> </span>3fab3cf<span class="w"> </span><span class="o">(</span>tag:<span class="w"> </span>ns-3.34<span class="o">)</span><span class="w"> </span>Update<span class="w"> </span>availability<span class="w"> </span><span class="k">in</span><span class="w"> </span>RELEASE_NOTES
<span class="p">|</span><span class="w"> </span>*<span class="w"> </span>c50aaf7<span class="w"> </span>Update<span class="w"> </span>VERSION<span class="w"> </span>and<span class="w"> </span>documentation<span class="w"> </span>tags<span class="w"> </span><span class="k">for</span><span class="w"> </span>ns-3.34<span class="w"> </span>release
<span class="p">|</span>/
*<span class="w"> </span>9df8ef4<span class="w"> </span>doc:<span class="w"> </span>Update<span class="w"> </span>ns-3<span class="w"> </span>version<span class="w"> </span><span class="k">in</span><span class="w"> </span>tutorial<span class="w"> </span>examples
*<span class="w"> </span>9319cdd<span class="w"> </span>Update<span class="w"> </span>CHANGES.html<span class="w"> </span>and<span class="w"> </span>RELEASE_NOTES
</pre></div>
</div>
<p>Let’s assume that the changeset <code class="docutils literal notranslate"><span class="pre">ee37d41</span></code> is considered important to fix in
the ns-3.34 release, but we don’t want the other changes introduced since then.
The solution will be to create a new branch for a hotfix release, and follow
similar steps.  The branch for the hotfix should come from commit <code class="docutils literal notranslate"><span class="pre">3fab3cf</span></code>,
and should cherry-pick commit <code class="docutils literal notranslate"><span class="pre">ee37d41</span></code> (which may require merge if it
doesn’t apply cleanly), and then the hotfix branch can be tagged and merged
as was done before.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>ns-3.34.1-release<span class="w"> </span>ns-3.34
$<span class="w"> </span>git<span class="w"> </span>cherry-pick<span class="w"> </span>ee37d41
...<span class="w"> </span><span class="o">(</span>resolve<span class="w"> </span>any<span class="w"> </span>conflicts<span class="o">)</span>
$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>a
$<span class="w"> </span>git<span class="w"> </span>commit
$<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span><span class="s1">&#39;s/3.34/3.34.1/g&#39;</span><span class="w"> </span>VERSION
$<span class="w"> </span>cat<span class="w"> </span>VERSION
<span class="m">3</span>.34.1
$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="s2">&quot;Update VERSION to 3.34.1&quot;</span><span class="w"> </span>VERSION
$<span class="w"> </span>git<span class="w"> </span>tag<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;ns-3.34.1&#39;</span><span class="w"> </span>-m<span class="s2">&quot;ns-3.34.1 release&quot;</span>
</pre></div>
</div>
<p>Now the merge:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>master
$<span class="w"> </span>git<span class="w"> </span>merge<span class="w"> </span>--no-commit<span class="w"> </span>--no-ff<span class="w"> </span>ns-3.34.1-release
</pre></div>
</div>
<p>This time we may see something like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Auto-merging<span class="w"> </span>a
CONFLICT<span class="w"> </span><span class="o">(</span>content<span class="o">)</span>:<span class="w"> </span>Merge<span class="w"> </span>conflict<span class="w"> </span><span class="k">in</span><span class="w"> </span>a
Auto-merging<span class="w"> </span>VERSION
CONFLICT<span class="w"> </span><span class="o">(</span>content<span class="o">)</span>:<span class="w"> </span>Merge<span class="w"> </span>conflict<span class="w"> </span><span class="k">in</span><span class="w"> </span>VERSION
Automatic<span class="w"> </span>merge<span class="w"> </span>failed<span class="p">;</span><span class="w"> </span>fix<span class="w"> </span>conflicts<span class="w"> </span>and<span class="w"> </span><span class="k">then</span><span class="w"> </span>commit<span class="w"> </span>the<span class="w"> </span>result.
</pre></div>
</div>
<p>And we can then do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>reset<span class="w"> </span>ee37d41<span class="w"> </span>a
$<span class="w"> </span>git<span class="w"> </span>reset<span class="w"> </span>ee37d41<span class="w"> </span>VERSION
</pre></div>
</div>
<p>Which leaves us with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Unstaged<span class="w"> </span>changes<span class="w"> </span>after<span class="w"> </span>reset:
M<span class="w"> </span>VERSION
M<span class="w"> </span>a
</pre></div>
</div>
<p>We can next hand-edit these files to restore them to original state, so that:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>status
On<span class="w"> </span>branch<span class="w"> </span>master
Your<span class="w"> </span>branch<span class="w"> </span>is<span class="w"> </span>ahead<span class="w"> </span>of<span class="w"> </span><span class="s1">&#39;origin/master&#39;</span><span class="w"> </span>by<span class="w"> </span><span class="m">8</span><span class="w"> </span>commits.
<span class="w">  </span><span class="o">(</span>use<span class="w"> </span><span class="s2">&quot;git push&quot;</span><span class="w"> </span>to<span class="w"> </span>publish<span class="w"> </span>your<span class="w"> </span><span class="nb">local</span><span class="w"> </span>commits<span class="o">)</span>

All<span class="w"> </span>conflicts<span class="w"> </span>fixed<span class="w"> </span>but<span class="w"> </span>you<span class="w"> </span>are<span class="w"> </span>still<span class="w"> </span>merging.
<span class="w">  </span><span class="o">(</span>use<span class="w"> </span><span class="s2">&quot;git commit&quot;</span><span class="w"> </span>to<span class="w"> </span>conclude<span class="w"> </span>merge<span class="o">)</span>

$<span class="w"> </span>git<span class="w"> </span>commit
$<span class="w"> </span>git<span class="w"> </span>branch<span class="w"> </span>-d<span class="w"> </span>ns-3.34.1-release
</pre></div>
</div>
<p>The new log should show something like the below, with parallel Git
history paths until the merge back again:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>log<span class="w"> </span>--graph<span class="w"> </span>--decorate<span class="w"> </span>--oneline<span class="w"> </span>--all
*<span class="w">   </span>815ce6e<span class="w"> </span><span class="o">(</span>HEAD<span class="w"> </span>-&gt;<span class="w"> </span>master<span class="o">)</span><span class="w"> </span>Merge<span class="w"> </span>branch<span class="w"> </span><span class="s1">&#39;ns-3.34.1-release&#39;</span>
<span class="p">|</span><span class="se">\</span>
<span class="p">|</span><span class="w"> </span>*<span class="w"> </span>12a29ca<span class="w"> </span><span class="o">(</span>tag:<span class="w"> </span>ns-3.34.1<span class="o">)</span><span class="w"> </span>Update<span class="w"> </span>VERSION<span class="w"> </span>to<span class="w"> </span><span class="m">3</span>.34.1
<span class="p">|</span><span class="w"> </span>*<span class="w"> </span>21ebdbf<span class="w"> </span>Fix<span class="w"> </span>missing<span class="w"> </span>abc<span class="w"> </span>bug<span class="w"> </span>on<span class="w"> </span>file<span class="w"> </span>a
*<span class="w"> </span><span class="p">|</span><span class="w"> </span>ee37d41<span class="w"> </span>Fix<span class="w"> </span>missing<span class="w"> </span>abc<span class="w"> </span>bug<span class="w"> </span>on<span class="w"> </span>file<span class="w"> </span>a
*<span class="w"> </span><span class="p">|</span><span class="w"> </span>9a3432a<span class="w"> </span>some<span class="w"> </span>more<span class="w"> </span>changes
*<span class="w"> </span><span class="p">|</span><span class="w"> </span>ba28d6d<span class="w"> </span>Add<span class="w"> </span>new<span class="w"> </span>feature
*<span class="w"> </span><span class="p">|</span><span class="w"> </span>e50015a<span class="w"> </span>make<span class="w"> </span>some<span class="w"> </span>changes
*<span class="w"> </span><span class="p">|</span><span class="w">   </span>fd075f6<span class="w"> </span>Merge<span class="w"> </span>ns-3.34-release<span class="w"> </span>branch
<span class="p">|</span><span class="se">\ \</span>
<span class="p">|</span><span class="w"> </span><span class="p">|</span>/
<span class="p">|</span><span class="w"> </span>*<span class="w"> </span>3fab3cf<span class="w"> </span><span class="o">(</span>tag:<span class="w"> </span>ns-3.34<span class="o">)</span><span class="w"> </span>Update<span class="w"> </span>availability<span class="w"> </span><span class="k">in</span><span class="w"> </span>RELEASE_NOTES
<span class="p">|</span><span class="w"> </span>*<span class="w"> </span>c50aaf7<span class="w"> </span>Update<span class="w"> </span>VERSION<span class="w"> </span>and<span class="w"> </span>documentation<span class="w"> </span>tags<span class="w"> </span><span class="k">for</span><span class="w"> </span>ns-3.34<span class="w"> </span>release
<span class="p">|</span>/
*<span class="w"> </span>9df8ef4<span class="w"> </span>doc:<span class="w"> </span>Update<span class="w"> </span>ns-3<span class="w"> </span>version<span class="w"> </span><span class="k">in</span><span class="w"> </span>tutorial<span class="w"> </span>examples
*<span class="w"> </span>9319cdd<span class="w"> </span>Update<span class="w"> </span>CHANGES.html<span class="w"> </span>and<span class="w"> </span>RELEASE_NOTES

$<span class="w"> </span>git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>master:master<span class="w"> </span>--follow-tags
</pre></div>
</div>
<p>And we can continue to commit on top of master going forward.  The two
tags should be found in the <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">tag</span></code> output (among other tags):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>git<span class="w"> </span>tag
ns-3.34
ns-3.34.1
</pre></div>
</div>
</section>
</section>
<span id="document-working-with-cmake"></span><section id="working-with-cmake">
<span id="id1"></span><h3><span class="section-number">4.3. </span>Working with CMake<a class="headerlink" href="#working-with-cmake" title="Link to this heading">¶</a></h3>
<p>The <em>ns-3</em> project used Waf build system in the past, but it has moved to
CMake for the ns-3.36 release.</p>
<p>CMake is very verbose and commands can be very long for basic operations.</p>
<p>The wrapper script <code class="docutils literal notranslate"><span class="pre">ns3</span></code> hides most of verbosity from CMake and provide a
Waf-like interface for command-line users.</p>
<p>It is the recommended way to work on <em>ns-3</em>, except if you are using an
IDE that supports projects that can be generated with CMake or CMake projects.</p>
<p>Here is a non-exhaustive list of IDEs that can be used:</p>
<ul class="simple">
<li><p>Support CMake projects:</p>
<ul>
<li><p>JetBrains’s <a class="reference external" href="https://www.jetbrains.com/clion/">CLion</a></p></li>
<li><p>Microsoft <a class="reference external" href="https://visualstudio.microsoft.com/">Visual Studio</a> and Visual Studio <a class="reference external" href="https://code.visualstudio.com/Download">Code</a></p></li>
</ul>
</li>
<li><p>Supported IDEs via <a class="reference external" href="https://cmake.org/cmake/help/latest/manual/cmake-generators.7.html">CMake generated</a> projects:</p>
<ul>
<li><p>Apple’s <a class="reference external" href="https://developer.apple.com/xcode/">XCode</a> : <code class="docutils literal notranslate"><span class="pre">ns3</span> <span class="pre">configure</span> <span class="pre">-G</span> <span class="pre">Xcode</span></code></p></li>
<li><p><a class="reference external" href="https://www.codeblocks.org/">CodeBlocks</a> : <code class="docutils literal notranslate"><span class="pre">ns3</span> <span class="pre">configure</span> <span class="pre">-G</span> <span class="pre">&quot;CodeBlocks</span> <span class="pre">-</span> <span class="pre">Ninja&quot;</span></code></p></li>
<li><p><a class="reference external" href="https://www.eclipse.org/cdt/">Eclipse</a> CDT4 : <code class="docutils literal notranslate"><span class="pre">ns3</span> <span class="pre">configure</span> <span class="pre">-G</span> <span class="pre">&quot;Eclipse</span> <span class="pre">CDT4</span> <span class="pre">-</span> <span class="pre">Ninja&quot;</span></code></p></li>
</ul>
</li>
</ul>
<p>Note: Ninja was used for brevity.
Both CodeBlocks and Eclipse have additional <a class="reference external" href="https://cmake.org/cmake/help/latest/manual/cmake-generators.7.html">generator options</a>.</p>
<p>General instructions on how to setup and use IDEs are available
in the Tutorial and will not be detailed here.</p>
<section id="configuring-the-project">
<h4><span class="section-number">4.3.1. </span>Configuring the project<a class="headerlink" href="#configuring-the-project" title="Link to this heading">¶</a></h4>
<p>After getting the code, either cloning the ns-3-dev repository or
downloading the release tarball, you will need to configure the
project to work on it.</p>
<p>There are two ways to configure the project: the easiest way
is using the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> script and the other way directly with CMake.</p>
<section id="configuring-the-project-with-ns3">
<h5><span class="section-number">4.3.1.1. </span>Configuring the project with <code class="docutils literal notranslate"><span class="pre">ns3</span></code><a class="headerlink" href="#configuring-the-project-with-ns3" title="Link to this heading">¶</a></h5>
<p>Navigate to the ns-3-dev directory, then run <code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">configure</span> <span class="pre">--help</span></code> to
print the configuration options:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ cd ns-3-dev</span>
<span class="go">~/ns-3-dev$ ./ns3 configure --help</span>
<span class="go">usage: ns3 configure [-h] [-d {debug,release,optimized}] [-G G]</span>
<span class="go">                   [--cxx-standard CXX_STANDARD] [--enable-asserts]</span>
<span class="go">                   [--disable-asserts] [--enable-examples]</span>
<span class="go">                   [--disable-examples] [--enable-logs]</span>
<span class="go">                   [--disable-logs] [--enable-tests]</span>
<span class="go">                   [--disable-tests] [--enable-verbose]</span>
<span class="go">                   [--disable-verbose]</span>
<span class="go">                   ...</span>

<span class="go">positional arguments:</span>
<span class="go">  configure</span>

<span class="go">optional arguments:</span>
<span class="go">  -h, --help            show this help message and exit</span>
<span class="go">  -d {debug,release,optimized}, --build-profile {debug,release,optimized}</span>
<span class="go">                        Build profile</span>
<span class="go">  -G G                  CMake generator (e.g.</span>
<span class="go">                        https://cmake.org/cmake/help/latest/manual/cmake-</span>
<span class="go">                        generators.7.html)</span>
<span class="go">  ...</span>
</pre></div>
</div>
<p>Note: the command output was trimmed to the most used options.</p>
<p>To configure <em>ns-3</em> in release mode, while enabling examples and tests,
run <code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">configure</span> <span class="pre">-d</span> <span class="pre">release</span> <span class="pre">--enable-examples</span> <span class="pre">--enable-tests</span></code>.
To check what underlying commands dare being executed, add the
<code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> option:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 --dry-run configure -d release --enable-examples --enable-tests</span>
<span class="go">The following commands would be executed:</span>
<span class="go">mkdir cmake-cache</span>
<span class="go">cd cmake-cache; /usr/bin/cmake -DCMAKE_BUILD_TYPE=release -DNS3_NATIVE_OPTIMIZATIONS=OFF -DNS3_EXAMPLES=ON -DNS3_TESTS=ON -G Unix Makefiles .. ; cd ..</span>
</pre></div>
</div>
<p>Now we run it for real:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 configure -d release --enable-examples --enable-tests</span>
<span class="go">-- CCache is enabled. Precompiled headers are disabled by default.</span>
<span class="go">-- The CXX compiler identification is GNU 11.2.0</span>
<span class="go">-- The C compiler identification is GNU 11.2.0</span>
<span class="go">-- Detecting CXX compiler ABI info</span>
<span class="go">-- Detecting CXX compiler ABI info - done</span>
<span class="go">-- Check for working CXX compiler: /usr/bin/c++ - skipped</span>
<span class="go">-- Detecting CXX compile features</span>
<span class="go">-- Detecting CXX compile features - done</span>
<span class="go">...</span>
<span class="go">-- Processing src/wifi</span>
<span class="go">-- Processing src/wimax</span>
<span class="go">-- ---- Summary of optional ns-3 features:</span>
<span class="go">Build profile                 : release</span>
<span class="go">Build directory               : /ns-3-dev/build</span>
<span class="go">...</span>
<span class="go">Examples                      : ON</span>
<span class="go">...</span>
<span class="go">Tests                         : ON</span>
<span class="go">Threading Primitives          : ON</span>


<span class="go">Modules configured to be built:</span>
<span class="go">antenna                   aodv                      applications</span>
<span class="go">bridge                    buildings                 config-store</span>
<span class="go">core                      csma                      csma-layout</span>
<span class="go">...</span>
<span class="go">wifi                      wimax</span>

<span class="go">Modules that cannot be built:</span>
<span class="go">brite                     click                     openflow</span>
<span class="go">visualizer</span>


<span class="go">-- Configuring done</span>
<span class="go">-- Generating done</span>
<span class="go">-- Build files have been written to: /ns-3-dev/cmake-cache</span>
<span class="go">Finished executing the following commands:</span>
<span class="go">mkdir cmake-cache</span>
<span class="go">cd cmake-cache; /usr/bin/cmake -DCMAKE_BUILD_TYPE=release -DNS3_NATIVE_OPTIMIZATIONS=OFF -DNS3_EXAMPLES=ON -DNS3_TESTS=ON -G Unix Makefiles .. ; cd ..</span>
</pre></div>
</div>
<p>Notice that CCache is automatically used (if installed) for your convenience.</p>
<p>The summary with enabled feature shows both the <code class="docutils literal notranslate"><span class="pre">release</span></code> build type, along with
enabled examples and tests.</p>
<p>Below is a list of enabled modules and modules that cannot be built.</p>
<p>At the end, notice we print the same commands from <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code>. This is done
to familiarize Waf users with CMake and how the options names changed.</p>
<p>The mapping of the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> build profiles into the CMake build types is the following:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head" colspan="4"><p>Equivalent build profiles</p></th>
</tr>
<tr class="row-even"><th class="head" rowspan="2"><p><code class="docutils literal notranslate"><span class="pre">ns3</span> <span class="pre">--build-profile</span></code></p></th>
<th class="head" colspan="2"><p>CMake</p></th>
<th class="head"><p>Equivalent GCC compiler flags</p></th>
</tr>
<tr class="row-odd"><th class="head"><p>CMAKE_BUILD_TYPE</p></th>
<th class="head"><p>Additional flags</p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>debug</p></td>
<td><p>debug</p></td>
<td></td>
<td><p>-g</p></td>
</tr>
<tr class="row-odd"><td><p>default</p></td>
<td><p>default</p></td>
<td></td>
<td><p>-O2 -g</p></td>
</tr>
<tr class="row-even"><td><p>release</p></td>
<td><p>release</p></td>
<td></td>
<td><p>-O3</p></td>
</tr>
<tr class="row-odd"><td><p>optimized</p></td>
<td><p>release</p></td>
<td><p>-DNS3_NATIVE_OPTIMIZATIONS=ON</p></td>
<td><p>-O3 -march=native -mtune=native</p></td>
</tr>
<tr class="row-even"><td><p>minsizerel</p></td>
<td><p>minsizerel</p></td>
<td></td>
<td><p>-Os</p></td>
</tr>
</tbody>
</table>
<p>In addition to setting compiler flags each build type also controls whether certain features are enabled or not:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">ns3</span> <span class="pre">--build-profile</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">NS3_ASSERT</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">NS3_LOG</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">NS3_WARNINGS_AS_ERRORS</span></code></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>debug</p></td>
<td><p>ON</p></td>
<td><p>ON</p></td>
<td><p>ON</p></td>
</tr>
<tr class="row-odd"><td><p>default</p></td>
<td><p>ON</p></td>
<td><p>ON</p></td>
<td><p>OFF</p></td>
</tr>
<tr class="row-even"><td><p>release</p></td>
<td><p>OFF</p></td>
<td><p>OFF</p></td>
<td><p>OFF</p></td>
</tr>
<tr class="row-odd"><td><p>optimized</p></td>
<td><p>OFF</p></td>
<td><p>OFF</p></td>
<td><p>OFF</p></td>
</tr>
<tr class="row-even"><td><p>minsizerel</p></td>
<td><p>OFF</p></td>
<td><p>OFF</p></td>
<td><p>OFF</p></td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">NS3_ASSERT</span></code> and <code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code> control whether the assert or logging macros
are functional or compiled out.
<code class="docutils literal notranslate"><span class="pre">NS3_WARNINGS_AS_ERRORS</span></code> controls whether compiler warnings are treated
as errors and stop the build, or whether they are only warnings and
allow the build to continue.</p>
</section>
<section id="configuring-the-project-with-cmake">
<h5><span class="section-number">4.3.1.2. </span>Configuring the project with CMake<a class="headerlink" href="#configuring-the-project-with-cmake" title="Link to this heading">¶</a></h5>
<p>Navigate to the ns-3-dev directory, create a CMake cache folder,
navigate to it and run <a class="reference external" href="https://cmake.org/cmake/help/latest/manual/cmake.1.html">CMake</a> pointing to the ns-3-dev folder.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ cd ns-3-dev</span>
<span class="go">~/ns-3-dev$ mkdir cmake-cache</span>
<span class="go">~/ns-3-dev$ cd cmake-cache</span>
<span class="go">~/ns-3-dev/cmake-cache$ cmake ..</span>
</pre></div>
</div>
<p>You can pass additional arguments to the CMake command, to configure it. To change variable values,
you should use the -D option followed by the variable name.</p>
<p>As an example, the build type is stored in the variable named <a class="reference external" href="https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html">CMAKE_BUILD_TYPE</a>. Setting it to one
of the CMake build types shown in the table below will change compiler settings associated with those
build types and output executable and libraries names, which will receive a suffix.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>CMAKE_BUILD_TYPE</p></th>
<th class="head"><p><a class="reference external" href="https://github.com/Kitware/CMake/blob/master/Modules/Compiler/GNU.cmake">Effects (g++)</a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>DEBUG</p></td>
<td><p>-g</p></td>
</tr>
<tr class="row-odd"><td><p>DEFAULT</p></td>
<td><p>-O2 -g -DNDEBUG</p></td>
</tr>
<tr class="row-even"><td><p>RELWITHDEBINFO</p></td>
<td><p>-O2 -g -DNDEBUG</p></td>
</tr>
<tr class="row-odd"><td><p>RELEASE</p></td>
<td><p>-O3 -DNDEBUG</p></td>
</tr>
<tr class="row-even"><td><p>MINSIZEREL</p></td>
<td><p>-Os -DNDEBUG</p></td>
</tr>
</tbody>
</table>
<p>You can set the build type with the following command, which assumes your terminal is inside the cache folder
created previously.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ cmake -DCMAKE_BUILD_TYPE=DEBUG ..</span>
</pre></div>
</div>
<p>Another common option to change is the <a class="reference external" href="https://cmake.org/cmake/help/latest/manual/cmake-generators.7.html">generator</a>, which is the real underlying build system called by CMake.
There are many generators supported by CMake, including the ones listed in the table below.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Generators</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>MinGW Makefiles</p></td>
</tr>
<tr class="row-odd"><td><p>Unix Makefiles</p></td>
</tr>
<tr class="row-even"><td><p>MSYS Makefiles</p></td>
</tr>
<tr class="row-odd"><td><p>CodeBlocks - <em>one of the previous Makefiles</em></p></td>
</tr>
<tr class="row-even"><td><p>Eclipse CDT4 - <em>one of the previous Makefiles</em></p></td>
</tr>
<tr class="row-odd"><td><p>Ninja</p></td>
</tr>
<tr class="row-even"><td><p>Xcode</p></td>
</tr>
</tbody>
</table>
<p>To change the generator, you will need to pass one of these generators with the -G option. For example, if we
prefer Ninja to Makefiles, which are the default, we need to run the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ cmake -G Ninja ..</span>
</pre></div>
</div>
<p>This command may fail if there are different generator files in the same CMake cache folder. It is recommended to clean up
the CMake cache folder, then recreate it and reconfigure setting the generator in the first run.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ cd ..</span>
<span class="go">~/ns-3-dev$ rm -R cmake-cache &amp;&amp; mkdir cmake-cache &amp;&amp; cd cmake-cache</span>
<span class="go">~/ns-3-dev/cmake-cache$ cmake -DCMAKE_BUILD_TYPE=release -G Ninja ..</span>
</pre></div>
</div>
<p>After configuring for the first time, settings will be initialized to their
default values, and then you can use the <code class="docutils literal notranslate"><span class="pre">ccmake</span></code> command to manually change them:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ ccmake .</span>
<span class="go">CMAKE_BUILD_TYPE                 release</span>
<span class="go">CMAKE_INSTALL_PREFIX             /usr/local</span>
<span class="go">NS3_ASSERT                       OFF</span>
<span class="go">...</span>
<span class="go">NS3_EXAMPLES                     ON</span>
<span class="go">...</span>
<span class="go">NS3_LOG                          OFF</span>
<span class="go">NS3_TESTS                        ON</span>
<span class="go">NS3_VERBOSE                      OFF</span>
<span class="go">...</span>

<span class="go">CMAKE_BUILD_TYPE: Choose the type of build, options are: None Debug Release RelWithDebInfo MinSizeRel ...</span>
<span class="go">Keys: [enter] Edit an entry [d] Delete an entry                                                                                             CMake Version 3.22.1</span>
<span class="go">      [l] Show log output   [c] Configure</span>
<span class="go">      [h] Help              [q] Quit without generating</span>
<span class="go">      [t] Toggle advanced mode (currently off)</span>
</pre></div>
</div>
<p>After moving the cursor and setting the desired values, type <code class="docutils literal notranslate"><span class="pre">c</span></code> to configure CMake.</p>
<p>If you prefer doing everything with a non-interactive command, look at the main <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>
file in the ns-3-dev directory. It contains most of the option flags and their default values.
To enable both examples and tests, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ cmake -DNS3_EXAMPLES=ON -DNS3_TESTS=ON ..</span>
</pre></div>
</div>
</section>
</section>
<section id="manually-refresh-the-cmake-cache">
<span id="id2"></span><h4><span class="section-number">4.3.2. </span>Manually refresh the CMake cache<a class="headerlink" href="#manually-refresh-the-cmake-cache" title="Link to this heading">¶</a></h4>
<p>After the project has been configured, calling <code class="docutils literal notranslate"><span class="pre">CMake</span></code> will
<a class="reference internal" href="#manually-refresh-the-cmake-cache"><span class="std std-ref">refresh the CMake cache</span></a>.
The refresh is required to discover new targets: libraries, executables and/or modules
that were created since the last run.</p>
<p>The refresh is done by running the CMake command from the CMake cache folder.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ cmake ..</span>
</pre></div>
</div>
<p>Previous settings stored in the CMakeCache.txt will be preserved, while new modules will be
scanned and targets will be added.</p>
<p>The cache can also be refreshed with the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> wrapper script:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 configure</span>
</pre></div>
</div>
</section>
<section id="building-the-project">
<h4><span class="section-number">4.3.3. </span>Building the project<a class="headerlink" href="#building-the-project" title="Link to this heading">¶</a></h4>
<p>There are three ways of building the project:
using the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> script, calling <code class="docutils literal notranslate"><span class="pre">CMake</span></code> and
calling the underlying build system (e.g. Ninja) directly.
The last way is omitted, since each underlying build system
has its own unique command-line syntax.</p>
<section id="building-the-project-with-ns3">
<h5><span class="section-number">4.3.3.1. </span>Building the project with <code class="docutils literal notranslate"><span class="pre">ns3</span></code><a class="headerlink" href="#building-the-project-with-ns3" title="Link to this heading">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">ns3</span></code> wrapper script makes life easier for command line users, accepting module names without
the <code class="docutils literal notranslate"><span class="pre">lib</span></code> prefix and scratch files without the <code class="docutils literal notranslate"><span class="pre">scratch_</span></code> prefix. The following command can
be used to build the entire project:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 build</span>
</pre></div>
</div>
<p>To build specific targets, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 build target_name</span>
</pre></div>
</div>
</section>
<section id="building-the-project-with-cmake">
<h5><span class="section-number">4.3.3.2. </span>Building the project with CMake<a class="headerlink" href="#building-the-project-with-cmake" title="Link to this heading">¶</a></h5>
<p>The build process of targets (either libraries, executables or custom tasks) can be done
invoking CMake build. To build all the targets, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ cmake --build .</span>
</pre></div>
</div>
<p>Notice the single dot now refers to the <code class="docutils literal notranslate"><span class="pre">cmake-cache</span></code> directory, where the underlying
build system files are stored (referred inside CMake as <code class="docutils literal notranslate"><span class="pre">PROJECT_BINARY_DIR</span></code> or
<code class="docutils literal notranslate"><span class="pre">CMAKE_BINARY_DIR</span></code>, which have slightly different uses if working with sub-projects).</p>
<p>To build specific targets, run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ cmake --build . --target target_name</span>
</pre></div>
</div>
<p>Where target_name is a valid target name. Module libraries are prefixed with <code class="docutils literal notranslate"><span class="pre">lib</span></code> (e.g. libcore),
executables from the scratch folder are prefixed with <code class="docutils literal notranslate"><span class="pre">scratch_</span></code> (e.g. scratch_scratch-simulator).
Executables targets have their source file name without the “.cc” prefix
(e.g. sample-simulator.cc =&gt; sample-simulator).</p>
</section>
</section>
<section id="adding-a-new-module">
<h4><span class="section-number">4.3.4. </span>Adding a new module<a class="headerlink" href="#adding-a-new-module" title="Link to this heading">¶</a></h4>
<p>Adding a module is the only case where
<a class="reference internal" href="#manually-refresh-the-cmake-cache"><span class="std std-ref">manually refreshing the CMake cache</span></a> is required.</p>
<p>More information on how to create a new module are provided in <a class="reference internal" href="index.html#adding-a-new-module-to-ns3"><span class="std std-ref">Adding a New Module to ns-3</span></a>.</p>
</section>
<section id="migrating-a-waf-module-to-cmake">
<h4><span class="section-number">4.3.5. </span>Migrating a Waf module to CMake<a class="headerlink" href="#migrating-a-waf-module-to-cmake" title="Link to this heading">¶</a></h4>
<p>If your module does not have external dependencies, porting is very easy.
Start by copying the module Wscript, rename them to CMakeLists.txt and then open it.</p>
<p>We are going to use the aodv module as an example:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">bld</span><span class="p">):</span>
  <span class="n">module</span> <span class="o">=</span> <span class="n">bld</span><span class="o">.</span><span class="n">create_ns3_module</span><span class="p">(</span><span class="s1">&#39;aodv&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;internet&#39;</span><span class="p">,</span> <span class="s1">&#39;wifi&#39;</span><span class="p">])</span>
  <span class="n">module</span><span class="o">.</span><span class="n">includes</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
  <span class="n">module</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">&#39;model/aodv-id-cache.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-dpd.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-rtable.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-rqueue.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-packet.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-neighbor.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-routing-protocol.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;helper/aodv-helper.cc&#39;</span><span class="p">,</span>
      <span class="p">]</span>

  <span class="n">aodv_test</span> <span class="o">=</span> <span class="n">bld</span><span class="o">.</span><span class="n">create_ns3_module_test_library</span><span class="p">(</span><span class="s1">&#39;aodv&#39;</span><span class="p">)</span>
  <span class="n">aodv_test</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">&#39;test/aodv-id-cache-test-suite.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;test/aodv-test-suite.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;test/aodv-regression.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;test/bug-772.cc&#39;</span><span class="p">,</span>
      <span class="s1">&#39;test/loopback.cc&#39;</span><span class="p">,</span>
      <span class="p">]</span>

  <span class="c1"># Tests encapsulating example programs should be listed here</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bld</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ENABLE_EXAMPLES&#39;</span><span class="p">]):</span>
      <span class="n">aodv_test</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
      <span class="c1">#   &#39;test/aodv-examples-test-suite.cc&#39;,</span>
          <span class="p">])</span>

  <span class="n">headers</span> <span class="o">=</span> <span class="n">bld</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="s1">&#39;ns3header&#39;</span><span class="p">)</span>
  <span class="n">headers</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="s1">&#39;aodv&#39;</span>
  <span class="n">headers</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s1">&#39;model/aodv-id-cache.h&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-dpd.h&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-rtable.h&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-rqueue.h&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-packet.h&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-neighbor.h&#39;</span><span class="p">,</span>
      <span class="s1">&#39;model/aodv-routing-protocol.h&#39;</span><span class="p">,</span>
      <span class="s1">&#39;helper/aodv-helper.h&#39;</span><span class="p">,</span>
      <span class="p">]</span>

  <span class="k">if</span> <span class="n">bld</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ENABLE_EXAMPLES&#39;</span><span class="p">]:</span>
      <span class="n">bld</span><span class="o">.</span><span class="n">recurse</span><span class="p">(</span><span class="s1">&#39;examples&#39;</span><span class="p">)</span>

  <span class="n">bld</span><span class="o">.</span><span class="n">ns3_python_bindings</span><span class="p">()</span>
</pre></div>
</div>
<p>We can see the module name is <code class="docutils literal notranslate"><span class="pre">aodv</span></code> and it depends on the <code class="docutils literal notranslate"><span class="pre">internet</span></code> and the <code class="docutils literal notranslate"><span class="pre">wifi</span></code> libraries,
plus the lists of files (<code class="docutils literal notranslate"><span class="pre">module.source</span></code>, <code class="docutils literal notranslate"><span class="pre">headers.source</span></code> and <code class="docutils literal notranslate"><span class="pre">module_test.source</span></code>).</p>
<p>This translates to the following CMake lines:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">aodv</span><span class="w"> </span><span class="c"># aodv module, which can later be linked to examples and modules with ${libaodv}</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="c"># equivalent to module.source</span>
<span class="w">    </span><span class="s">helper/aodv-helper.cc</span>
<span class="w">    </span><span class="s">model/aodv-dpd.cc</span>
<span class="w">    </span><span class="s">model/aodv-id-cache.cc</span>
<span class="w">    </span><span class="s">model/aodv-neighbor.cc</span>
<span class="w">    </span><span class="s">model/aodv-packet.cc</span>
<span class="w">    </span><span class="s">model/aodv-routing-protocol.cc</span>
<span class="w">    </span><span class="s">model/aodv-rqueue.cc</span>
<span class="w">    </span><span class="s">model/aodv-rtable.cc</span>
<span class="w">  </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="c"># equivalent to headers.source</span>
<span class="w">    </span><span class="s">helper/aodv-helper.h</span>
<span class="w">    </span><span class="s">model/aodv-dpd.h</span>
<span class="w">    </span><span class="s">model/aodv-id-cache.h</span>
<span class="w">    </span><span class="s">model/aodv-neighbor.h</span>
<span class="w">    </span><span class="s">model/aodv-packet.h</span>
<span class="w">    </span><span class="s">model/aodv-routing-protocol.h</span>
<span class="w">    </span><span class="s">model/aodv-rqueue.h</span>
<span class="w">    </span><span class="s">model/aodv-rtable.h</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span><span class="w"> </span><span class="c"># depends on internet and wifi,</span>
<span class="w">                    </span><span class="o">${</span><span class="nv">libwifi</span><span class="o">}</span><span class="w">     </span><span class="c"># but both are prefixed with lib in CMake</span>
<span class="w">  </span><span class="s">TEST_SOURCES</span><span class="w"> </span><span class="c"># equivalent to module_test.source</span>
<span class="w">    </span><span class="s">test/aodv-id-cache-test-suite.cc</span>
<span class="w">    </span><span class="s">test/aodv-regression.cc</span>
<span class="w">    </span><span class="s">test/aodv-test-suite.cc</span>
<span class="w">    </span><span class="s">test/loopback.cc</span>
<span class="w">    </span><span class="s">test/bug-772.cc</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If your module depends on external libraries, check the section
<a class="reference internal" href="#linking-third-party-libraries">Linking third-party libraries</a>.</p>
<p>Python bindings are generated at runtime for all built modules
if NS3_PYTHON_BINDINGS is enabled.</p>
<p>Next, we need to port the examples wscript. Repeat the copy, rename and open
steps. We should have something like the following:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">bld</span><span class="p">):</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">bld</span><span class="o">.</span><span class="n">create_ns3_program</span><span class="p">(</span><span class="s1">&#39;aodv&#39;</span><span class="p">,</span>
                                 <span class="p">[</span><span class="s1">&#39;wifi&#39;</span><span class="p">,</span> <span class="s1">&#39;internet&#39;</span><span class="p">,</span> <span class="s1">&#39;aodv&#39;</span><span class="p">,</span> <span class="s1">&#39;internet-apps&#39;</span><span class="p">])</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;aodv.cc&#39;</span>
</pre></div>
</div>
<p>This means we create an example named <code class="docutils literal notranslate"><span class="pre">aodv</span></code> which depends on <code class="docutils literal notranslate"><span class="pre">wifi</span></code>, <code class="docutils literal notranslate"><span class="pre">internet</span></code>,
<code class="docutils literal notranslate"><span class="pre">aodv</span></code> and <code class="docutils literal notranslate"><span class="pre">internet-apps</span></code> module, and has a single source file <code class="docutils literal notranslate"><span class="pre">aodv.cc</span></code>.
This translates into the following CMake:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_lib_example</span><span class="p">(</span>
<span class="w">  </span><span class="s">NAME</span><span class="w"> </span><span class="s">aodv</span><span class="w"> </span><span class="c"># example named aodv</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">aodv.cc</span><span class="w"> </span><span class="c"># single source file aodv.cc</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="c"># depends on wifi, internet, aodv and internet-apps</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libwifi</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libaodv</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libinternet-apps</span><span class="o">}</span>
<span class="p">)</span>
</pre></div>
</div>
<section id="migrating-definitions-compilation-and-linking-options">
<h5><span class="section-number">4.3.5.1. </span>Migrating definitions, compilation and linking options<a class="headerlink" href="#migrating-definitions-compilation-and-linking-options" title="Link to this heading">¶</a></h5>
<p>If your Waf modules had additional definitions, compilation or linking flags,
you also need to translate them to CMake. The easiest way to accomplish that
is using the CMake counterparts <em>BEFORE</em> defining your target.</p>
<p>If you, for example, had the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">append_value</span><span class="p">(</span><span class="s2">&quot;CXXFLAGS&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;-fopenmp&quot;</span><span class="p">,</span> <span class="s2">&quot;-I/usr/local/include/e2sim&quot;</span><span class="p">])</span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">append_value</span><span class="p">(</span><span class="s2">&quot;CXXDEFINES&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;LAPACK&quot;</span><span class="p">,</span> <span class="s2">&quot;LUSOLVER=LAPACK&quot;</span><span class="p">])</span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">append_value</span><span class="p">(</span><span class="s2">&quot;LINKFLAGS&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;-llapack&quot;</span><span class="p">,</span> <span class="s2">&quot;-L/usr/local/src/GoToBLAS2&quot;</span><span class="p">,</span> <span class="s2">&quot;-lblas&quot;</span><span class="p">,</span> <span class="s2">&quot;-Lsrc/common&quot;</span><span class="p">,</span> <span class="s2">&quot;-lthyme&quot;</span><span class="p">])</span>
<span class="n">conf</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">append_value</span><span class="p">(</span><span class="s2">&quot;LIB&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;e2sim&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>You would need to replace it with the following counterparts:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># The settings below will impact all future target declarations</span>
<span class="c"># in the current subdirectory and its subdirectories</span>
<span class="c">#</span>
<span class="c"># a.k.a. the module, its examples and tests will have the definitions,</span>
<span class="c"># compilation options and will be linked to the specified libraries</span>
<span class="nb">add_compile_options</span><span class="p">(</span><span class="s">-fopenmp</span><span class="p">)</span><span class="w"> </span><span class="c"># CXXFLAGS counterpart</span>
<span class="nb">include_directories</span><span class="p">(</span><span class="s">/usr/local/include/e2sim</span><span class="p">)</span><span class="w"> </span><span class="c"># CXXFLAGS -I counterpart</span>
<span class="nb">add_definitions</span><span class="p">(</span><span class="s">-DLAPACK</span><span class="w"> </span><span class="s">-DLUSOLVER=LAPACK</span><span class="p">)</span><span class="w"> </span><span class="c"># CXXDEFINES counterpart</span>
<span class="nb">link_directories</span><span class="p">(</span><span class="s">/usr/local/src/GoToBLAS2</span><span class="w"> </span><span class="s">src/common</span><span class="p">)</span><span class="w"> </span><span class="c"># LINKFLAGS -L counterpart</span>
<span class="nb">link_libraries</span><span class="p">(</span><span class="s">lapack</span><span class="w"> </span><span class="s">blas</span><span class="w"> </span><span class="s">thyme</span><span class="w"> </span><span class="s">e2sim</span><span class="p">)</span><span class="w"> </span><span class="c"># LINKFLAGS -l or LIB counterpart</span>

<span class="c"># Target definition after changing settings</span>
<span class="nb">build_lib_example</span><span class="p">(</span>
<span class="w">    </span><span class="s">NAME</span><span class="w"> </span><span class="s">hypothetical-module</span>
<span class="w">    </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">hypothetical-module-source.cc</span>
<span class="w">    </span><span class="s">LIBRARIES_TO_LINK</span>
<span class="w">      </span><span class="c"># depends on wifi, internet, aodv and internet-apps modules</span>
<span class="w">      </span><span class="o">${</span><span class="nv">libwifi</span><span class="o">}</span>
<span class="w">      </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span>
<span class="w">      </span><span class="o">${</span><span class="nv">libaodv</span><span class="o">}</span>
<span class="w">      </span><span class="o">${</span><span class="nv">libinternet-apps</span><span class="o">}</span>
<span class="w">      </span><span class="c"># and lapack, blas, thyme, e2sim external libraries</span>
<span class="w">  </span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="running-programs">
<h4><span class="section-number">4.3.6. </span>Running programs<a class="headerlink" href="#running-programs" title="Link to this heading">¶</a></h4>
<p>Running programs with the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> wrapper script is pretty simple. To run the
scratch program produced by <code class="docutils literal notranslate"><span class="pre">scratch/scratch-simulator.cc</span></code>, you need the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 run scratch-simulator --no-build</span>
</pre></div>
</div>
<p>Notice the <code class="docutils literal notranslate"><span class="pre">--no-build</span></code> indicates that the program should only be executed, and not built
before execution.</p>
<p>To familiarize users with CMake, <code class="docutils literal notranslate"><span class="pre">ns3</span></code> can also print the underlying CMake
and command line commands used by adding the <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> flag.
Removing the <code class="docutils literal notranslate"><span class="pre">--no-build</span></code> flag and adding <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> to the same example,
produces the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 --dry-run run scratch-simulator</span>
<span class="go">The following commands would be executed:</span>
<span class="go">cd cmake-cache; cmake --build . -j 15 --target scratch_scratch-simulator ; cd ..</span>
<span class="go">export PATH=$PATH:~/ns-3-dev/build/lib</span>
<span class="go">export PYTHONPATH=~/ns-3-dev/build/bindings/python</span>
<span class="go">export LD_LIBRARY_PATH=~/ns-3-dev/build/lib</span>
<span class="go">./build/scratch/ns3-dev-scratch-simulator</span>
</pre></div>
</div>
<p>In the CMake build command line, notice the scratch-simulator has a <code class="docutils literal notranslate"><span class="pre">scratch_</span></code> prefix.
That is true for all the CMake scratch targets. This is done to guarantee globally unique names.
Similarly, library-related targets have <code class="docutils literal notranslate"><span class="pre">lib</span></code> as a prefix (e.g. <code class="docutils literal notranslate"><span class="pre">libcore</span></code>, <code class="docutils literal notranslate"><span class="pre">libnetwork</span></code>).</p>
<p>The next few lines exporting variables guarantee the executable can find python dependencies
(<code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code>) and linked libraries (<code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> and <code class="docutils literal notranslate"><span class="pre">PATH</span></code> on Unix-like, and
<code class="docutils literal notranslate"><span class="pre">PATH</span></code> on Windows). This is not necessary in platforms that support <a class="reference external" href="https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_RPATH.html">RPATH</a>.</p>
<p>Notice that when the scratch-simulator program is called on the last line, it has
a <code class="docutils literal notranslate"><span class="pre">ns3-&lt;version&gt;</span></code> prefix and could also have a build type suffix.
This is valid for all libraries and executables, but omitted in <code class="docutils literal notranslate"><span class="pre">ns3</span></code> for simplicity.</p>
<p>Debugging can be done with GDB. Again, we have the two ways to run the program.
Using the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> wrapper:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 run scratch-simulator --no-build --gdb</span>
</pre></div>
</div>
<p>Or directly:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ export PATH=$PATH:~/ns-3-dev/build/lib</span>
<span class="go">~/ns-3-dev/cmake-cache$ export PYTHONPATH=~/ns-3-dev/build/bindings/python</span>
<span class="go">~/ns-3-dev/cmake-cache$ export LD_LIBRARY_PATH=~/ns-3-dev/build/lib</span>
<span class="go">~/ns-3-dev/cmake-cache$ gdb ../build/scratch/ns3-dev-scratch-simulator</span>
</pre></div>
</div>
</section>
<section id="modifying-files">
<h4><span class="section-number">4.3.7. </span>Modifying files<a class="headerlink" href="#modifying-files" title="Link to this heading">¶</a></h4>
<p>As CMake is not a build system on itself, but a meta build system, it requires
frequent refreshes, also known as reconfigurations. Those refreshes are triggered
automatically in the following cases:</p>
<ul class="simple">
<li><p>Changes in linked libraries</p></li>
<li><p>Changes in the CMake code</p></li>
<li><p>Header changes</p></li>
<li><p>Header/source file name changes</p></li>
<li><p>Module name changes</p></li>
</ul>
<p>The following sections will detail some of these cases assuming a hypothetical module defined below.
Notice that the build_lib is the fundamental piece of every <em>ns-3</em> module, while user-settable
options and external libraries checking are optional.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">hypothetical</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w">  </span><span class="s">helper/hypothetical-helper.cc</span>
<span class="w">                </span><span class="s">model/hypothetical.cc</span>
<span class="w">  </span><span class="s">HEADER_FILES</span>
<span class="w">    </span><span class="s">helper/hypothetical-helper.h</span>
<span class="w">    </span><span class="s">model/hypothetical.h</span>
<span class="w">    </span><span class="s">model/colliding-header.h</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libcore</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>
</pre></div>
</div>
<section id="module-name-changes">
<h5><span class="section-number">4.3.7.1. </span>Module name changes<a class="headerlink" href="#module-name-changes" title="Link to this heading">¶</a></h5>
<p>Changing the module name requires changing the value of <code class="docutils literal notranslate"><span class="pre">LIBNAME</span></code>.
In the following example the name of the module seen previously is
changed from <code class="docutils literal notranslate"><span class="pre">hypothetical</span></code> to <code class="docutils literal notranslate"><span class="pre">new-hypothetical-name</span></code>:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">new-hypothetical-name</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If the module was already scanned, saving the changes and trying to build will trigger the
automatic CMake refresh. Otherwise, reconfigure the project to
<a class="reference internal" href="#manually-refresh-the-cmake-cache"><span class="std std-ref">manually refresh it</span></a>.</p>
</section>
<section id="header-source-file-name-changes">
<h5><span class="section-number">4.3.7.2. </span>Header/source file name changes<a class="headerlink" href="#header-source-file-name-changes" title="Link to this heading">¶</a></h5>
<p>Assuming the hypothetical module defined previously has a header name that collides
with a header of a different module.</p>
<p>The name of the <code class="docutils literal notranslate"><span class="pre">colliding-header.h</span></code> can be changed via the filesystem to
<code class="docutils literal notranslate"><span class="pre">non-colliding-header.h</span></code>, and the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> path needs to be updated to match
the new name. Some IDEs can do this automatically through refactoring tools.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">new-hypothetical-name</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="s">HEADER_FILES</span>
<span class="w">      </span><span class="s">helper/hypothetical-helper.h</span>
<span class="w">      </span><span class="s">model/hypothetical.h</span>
<span class="w">      </span><span class="s">model/non-colliding-header.h</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="linking-ns3-modules">
<h5><span class="section-number">4.3.7.3. </span>Linking <em>ns-3</em> modules<a class="headerlink" href="#linking-ns3-modules" title="Link to this heading">¶</a></h5>
<p>Adding a dependency to another <em>ns-3</em> module just requires adding <code class="docutils literal notranslate"><span class="pre">${lib${modulename}}</span></code>
to the <code class="docutils literal notranslate"><span class="pre">LIBRARIES_TO_LINK</span></code> list, where modulename contains the value of the <em>ns-3</em>
module which will be depended upon.</p>
<p>Note: All <em>ns-3</em> module libraries are prefixed with <code class="docutils literal notranslate"><span class="pre">lib</span></code>,
as CMake requires unique global target names.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># now ${libnew-hypothetical-name} will depend on both core and internet modules</span>
<span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">new-hypothetical-name</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libcore</span><span class="o">}</span>
<span class="w">                    </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="linking-third-party-libraries">
<span id="id3"></span><h5><span class="section-number">4.3.7.4. </span>Linking third-party libraries<a class="headerlink" href="#linking-third-party-libraries" title="Link to this heading">¶</a></h5>
<p>Depending on a third-party library is a bit more complicated as we have multiple
ways to handle that within CMake.</p>
<p>Here is a short version on how to find and use third-party libraries
that should work in most cases:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># DEPENDENCY_NAME is used as a prefix to variables set by the find_external_library macro</span>
<span class="c"># HEADER_NAME(S) is(are) the name(s) of the header(s) you want to include</span>
<span class="c"># LIBRARY_NAME(S) is(are) the name(s) of the library(ies) you want to link</span>
<span class="c"># SEARCH_PATHS are the custom paths you can give if your library is not on a system path</span>
<span class="nb">find_external_library</span><span class="p">(</span><span class="s">DEPENDENCY_NAME</span><span class="w"> </span><span class="s">SQLite3</span>
<span class="w">                      </span><span class="s">HEADER_NAME</span><span class="w"> </span><span class="s">sqlite3.h</span>
<span class="w">                      </span><span class="s">LIBRARY_NAME</span><span class="w"> </span><span class="s">sqlite3</span>
<span class="w">                      </span><span class="s">SEARCH_PATHS</span><span class="w"> </span><span class="s">/optional/search/path/to/custom/sqlite3/library</span><span class="p">)</span>

<span class="c"># If the header(s) and library(ies) are not found, a message will be printed during the configuration</span>
<span class="c"># If the header(s) and the library(ies) are found, we can use the information found by the buildsystem</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">SQLite3_FOUND</span><span class="o">}</span><span class="p">)</span><span class="w"> </span><span class="c"># Notice that the contents of DEPENDENCY_NAME became a prefix for the _FOUND variable</span>
<span class="w">    </span><span class="c"># The compiler will not be able to find the include that is not on</span>
<span class="w">    </span><span class="c"># a system include path, unless we explicitly inform it</span>

<span class="w">    </span><span class="c"># This is the equivalent of -I/optional/search/path/to/custom/sqlite3/include</span>
<span class="w">    </span><span class="c"># and AFFECTS ALL the targets in the CURRENT DIRECTORY and ITS SUBDIRECTORIES</span>
<span class="w">    </span><span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">SQLite3_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>

<span class="w">    </span><span class="c"># The compiler should be able to locate the headers, but it still needs to be</span>
<span class="w">    </span><span class="c"># informed of the libraries that should be linked</span>

<span class="w">    </span><span class="c"># This is the equivalent of -l/optional/search/path/to/custom/sqlite3/library/libsqlite3.so</span>
<span class="w">    </span><span class="c"># and AFFECTS ALL the targets in the CURRENT DIRECTORY and ITS SUBDIRECTORIES</span>
<span class="w">    </span><span class="nb">link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">SQLite3_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>If you do not want to link the library against all the targets
(executables and other libraries) use one of the following patterns.</p>
<p><strong>If the third-party library is required</strong></p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># if the third-party library is required</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">SQLite3_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="c"># define your target</span>
<span class="w">    </span><span class="nb">build_lib</span><span class="p">(</span>
<span class="w">        </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">example</span>
<span class="w">        </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">SQLite3_LIBRARIES</span><span class="o">}</span>
<span class="w">        </span><span class="s">...</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c"># The LIBRARIES_TO_LINK will be translated into CMake&#39;s</span>
<span class="w">    </span><span class="c"># target_link_libraries(${libexample} PUBLIC ${SQLite3_LIBRARIES})</span>
<span class="w">    </span><span class="c"># which is equivalent to -l${SQLite3_LIBRARIES}</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>If the third-party library is optional</strong></p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="s">sqlite_libraries</span><span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">SQLite3_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">sqlite_libraries</span><span class="w"> </span><span class="o">${</span><span class="nv">SQLite3_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># And then define your target</span>
<span class="nb">build_lib</span><span class="p">(</span>
<span class="w">    </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">example</span>
<span class="w">    </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">sqlite_libraries</span><span class="o">}</span><span class="w"> </span><span class="c"># variable can be empty</span>
<span class="w">    </span><span class="s">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>More details on how find_external_library works and the other
ways to import third-party libraries are presented next.</p>
<p>It is recommended to use a system package managers to install libraries,
but ns-3 also supports vcpkg and CPM. More information on how to
use them is available in <a class="reference internal" href="#using-c-library-managers">Using C++ library managers</a>.</p>
<section id="linking-third-party-libraries-without-cmake-or-pkgconfig-support">
<span id="id4"></span><h6><span class="section-number">4.3.7.4.1. </span>Linking third-party libraries without CMake or PkgConfig support<a class="headerlink" href="#linking-third-party-libraries-without-cmake-or-pkgconfig-support" title="Link to this heading">¶</a></h6>
<p>When the third-party library you want to use do not export CMake files to use
<code class="docutils literal notranslate"><span class="pre">find_package</span></code> or PkgConfig files to use <code class="docutils literal notranslate"><span class="pre">pkg_check_modules</span></code>, we need to
search for the headers and libraries manually. To simplify this process,
we include the macro <code class="docutils literal notranslate"><span class="pre">find_external_library</span></code> that searches for libraries and
header include directories, exporting results similarly to <code class="docutils literal notranslate"><span class="pre">find_package</span></code>.</p>
<p>Here is how it works:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">find_external_library</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Parse arguments</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">options</span><span class="w"> </span><span class="s">QUIET</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">oneValueArgs</span><span class="w"> </span><span class="s">DEPENDENCY_NAME</span><span class="w"> </span><span class="s">HEADER_NAME</span><span class="w"> </span><span class="s">LIBRARY_NAME</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">multiValueArgs</span><span class="w"> </span><span class="s">HEADER_NAMES</span><span class="w"> </span><span class="s">LIBRARY_NAMES</span><span class="w"> </span><span class="s">PATH_SUFFIXES</span><span class="w"> </span><span class="s">SEARCH_PATHS</span><span class="p">)</span>
<span class="w">  </span><span class="nb">cmake_parse_arguments</span><span class="p">(</span>
<span class="w">    </span><span class="s2">&quot;FIND_LIB&quot;</span><span class="w"> </span><span class="s2">&quot;${options}&quot;</span><span class="w"> </span><span class="s2">&quot;${oneValueArgs}&quot;</span><span class="w"> </span><span class="s2">&quot;${multiValueArgs}&quot;</span><span class="w"> </span><span class="o">${</span><span class="nv">ARGN</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># Set the external package/dependency name</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">name</span><span class="w"> </span><span class="o">${</span><span class="nv">FIND_LIB_DEPENDENCY_NAME</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># We process individual and list of headers and libraries by transforming them</span>
<span class="w">  </span><span class="c"># into lists</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">library_names</span><span class="w"> </span><span class="s2">&quot;${FIND_LIB_LIBRARY_NAME};${FIND_LIB_LIBRARY_NAMES}&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">header_names</span><span class="w"> </span><span class="s2">&quot;${FIND_LIB_HEADER_NAME};${FIND_LIB_HEADER_NAMES}&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Just changing the parsed argument name back to something shorter</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">search_paths</span><span class="w"> </span><span class="o">${</span><span class="nv">FIND_LIB_SEARCH_PATHS</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">path_suffixes</span><span class="w"> </span><span class="s2">&quot;${FIND_LIB_PATH_SUFFIXES}&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">not_found_libraries</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">library_dirs</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">libraries</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Paths and suffixes where libraries will be searched on</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">library_search_paths</span>
<span class="w">          </span><span class="o">${</span><span class="nv">search_paths</span><span class="o">}</span>
<span class="w">          </span><span class="o">${</span><span class="nv">CMAKE_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="w"> </span><span class="c"># Search for libraries in ns-3-dev/build</span>
<span class="w">          </span><span class="o">${</span><span class="nv">CMAKE_INSTALL_PREFIX</span><span class="o">}</span><span class="w"> </span><span class="c"># Search for libraries in the install directory (e.g. /usr/)</span>
<span class="w">          </span><span class="o">$ENV{</span><span class="nv">LD_LIBRARY_PATH</span><span class="o">}</span><span class="w"> </span><span class="c"># Search for libraries in LD_LIBRARY_PATH directories</span>
<span class="w">          </span><span class="o">$ENV{</span><span class="nv">PATH</span><span class="o">}</span><span class="w"> </span><span class="c"># Search for libraries in PATH directories</span>
<span class="w">          </span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">suffixes</span><span class="w"> </span><span class="s">/build</span><span class="w"> </span><span class="s">/lib</span><span class="w"> </span><span class="s">/build/lib</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="s">/bin</span><span class="w"> </span><span class="o">${</span><span class="nv">path_suffixes</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># For each of the library names in LIBRARY_NAMES or LIBRARY_NAME</span>
<span class="w">  </span><span class="nb">foreach</span><span class="p">(</span><span class="s">library</span><span class="w"> </span><span class="o">${</span><span class="nv">library_names</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="c"># We mark this value is advanced not to pollute the configuration with</span>
<span class="w">    </span><span class="c"># ccmake with the cache variables used internally</span>
<span class="w">    </span><span class="nb">mark_as_advanced</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_library_internal_</span><span class="o">${</span><span class="nv">library</span><span class="o">}</span><span class="p">)</span>

<span class="w">    </span><span class="c"># We search for the library named ${library} and store the results in</span>
<span class="w">    </span><span class="c"># ${name}_library_internal_${library}</span>
<span class="w">    </span><span class="nb">find_library</span><span class="p">(</span>
<span class="w">      </span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_library_internal_</span><span class="o">${</span><span class="nv">library</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">library</span><span class="o">}</span>
<span class="w">      </span><span class="s">HINTS</span><span class="w"> </span><span class="o">${</span><span class="nv">library_search_paths</span><span class="o">}</span>
<span class="w">      </span><span class="s">PATH_SUFFIXES</span><span class="w"> </span><span class="o">${</span><span class="nv">suffixes</span><span class="o">}</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="c"># cmake-format: off</span>
<span class="w">    </span><span class="c"># Note: the PATH_SUFFIXES above apply to *ALL* PATHS and HINTS Which</span>
<span class="w">    </span><span class="c"># translates to CMake searching on standard library directories</span>
<span class="w">    </span><span class="c"># CMAKE_SYSTEM_PREFIX_PATH, user-settable CMAKE_PREFIX_PATH or</span>
<span class="w">    </span><span class="c"># CMAKE_LIBRARY_PATH and the directories listed above</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># e.g.  from Ubuntu 22.04 CMAKE_SYSTEM_PREFIX_PATH =</span>
<span class="w">    </span><span class="c"># /usr/local;/usr;/;/usr/local;/usr/X11R6;/usr/pkg;/opt</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># Searched directories without suffixes</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># ${CMAKE_SYSTEM_PREFIX_PATH}[0] = /usr/local/</span>
<span class="w">    </span><span class="c"># ${CMAKE_SYSTEM_PREFIX_PATH}[1] = /usr</span>
<span class="w">    </span><span class="c"># ${CMAKE_SYSTEM_PREFIX_PATH}[2] = /</span>
<span class="w">    </span><span class="c"># ...</span>
<span class="w">    </span><span class="c"># ${CMAKE_SYSTEM_PREFIX_PATH}[6] = /opt</span>
<span class="w">    </span><span class="c"># ${LD_LIBRARY_PATH}[0]</span>
<span class="w">    </span><span class="c"># ...</span>
<span class="w">    </span><span class="c"># ${LD_LIBRARY_PATH}[m]</span>
<span class="w">    </span><span class="c"># ...</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># Searched directories with suffixes include all of the directories above</span>
<span class="w">    </span><span class="c"># plus all suffixes</span>
<span class="w">    </span><span class="c"># PATH_SUFFIXES /build /lib /build/lib / /bin # ${path_suffixes}</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># /usr/local/build</span>
<span class="w">    </span><span class="c"># /usr/local/lib</span>
<span class="w">    </span><span class="c"># /usr/local/build/lib</span>
<span class="w">    </span><span class="c"># /usr/local/bin</span>
<span class="w">    </span><span class="c"># ...</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># cmake-format: on</span>
<span class="w">    </span><span class="c"># Or enable NS3_VERBOSE to print the searched paths</span>

<span class="w">    </span><span class="c"># Print tested paths to the searched library and if it was found</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_VERBOSE</span><span class="o">}</span><span class="p">)</span>
<span class="w">      </span><span class="nb">log_find_searched_paths</span><span class="p">(</span>
<span class="w">              </span><span class="s">TARGET_TYPE</span><span class="w"> </span><span class="s">Library</span>
<span class="w">              </span><span class="s">TARGET_NAME</span><span class="w"> </span><span class="o">${</span><span class="nv">library</span><span class="o">}</span>
<span class="w">              </span><span class="s">SEARCH_RESULT</span><span class="w"> </span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_library_internal_</span><span class="o">${</span><span class="nv">library</span><span class="o">}</span>
<span class="w">              </span><span class="s">SEARCH_PATHS</span><span class="w"> </span><span class="o">${</span><span class="nv">library_search_paths</span><span class="o">}</span>
<span class="w">              </span><span class="s">SEARCH_SUFFIXES</span><span class="w"> </span><span class="o">${</span><span class="nv">suffixes</span><span class="o">}</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">    </span><span class="c"># After searching the library, the internal variable should have either the</span>
<span class="w">    </span><span class="c"># absolute path to the library or the name of the variable appended with</span>
<span class="w">    </span><span class="c"># -NOTFOUND</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="s2">&quot;${${name}_library_internal_${library}}&quot;</span><span class="w"> </span><span class="s">STREQUAL</span>
<span class="w">       </span><span class="s2">&quot;${name}_library_internal_${library}-NOTFOUND&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">      </span><span class="c"># We keep track of libraries that were not found</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">not_found_libraries</span><span class="w"> </span><span class="o">${</span><span class="nv">library</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">else</span><span class="p">()</span>
<span class="w">      </span><span class="c"># We get the name of the parent directory of the library and append the</span>
<span class="w">      </span><span class="c"># library to a list of found libraries</span>
<span class="w">      </span><span class="nb">get_filename_component</span><span class="p">(</span>
<span class="w">        </span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_library_dir_internal</span><span class="w"> </span><span class="o">${</span><span class="nv">${name</span><span class="o">}</span><span class="s">_library_internal_</span><span class="o">${</span><span class="nv">library</span><span class="o">}</span><span class="s">}</span>
<span class="w">        </span><span class="s">DIRECTORY</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="c"># e.g. lib/openflow.(so|dll|dylib|a) -&gt; lib</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">library_dirs</span><span class="w"> </span><span class="o">${</span><span class="nv">${name</span><span class="o">}</span><span class="s">_library_dir_internal}</span><span class="p">)</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">libraries</span><span class="w"> </span><span class="o">${</span><span class="nv">${name</span><span class="o">}</span><span class="s">_library_internal_</span><span class="o">${</span><span class="nv">library</span><span class="o">}</span><span class="s">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endforeach</span><span class="p">()</span>

<span class="w">  </span><span class="c"># For each library that was found (e.g. /usr/lib/pthread.so), get their parent</span>
<span class="w">  </span><span class="c"># directory (/usr/lib) and its parent (/usr)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">parent_dirs</span><span class="p">)</span>
<span class="w">  </span><span class="nb">foreach</span><span class="p">(</span><span class="s">libdir</span><span class="w"> </span><span class="o">${</span><span class="nv">library_dirs</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">get_filename_component</span><span class="p">(</span><span class="s">parent_libdir</span><span class="w"> </span><span class="o">${</span><span class="nv">libdir</span><span class="o">}</span><span class="w"> </span><span class="s">DIRECTORY</span><span class="p">)</span>
<span class="w">    </span><span class="nb">get_filename_component</span><span class="p">(</span><span class="s">parent_parent_libdir</span><span class="w"> </span><span class="o">${</span><span class="nv">parent_libdir</span><span class="o">}</span><span class="w"> </span><span class="s">DIRECTORY</span><span class="p">)</span>
<span class="w">    </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">parent_dirs</span><span class="w"> </span><span class="o">${</span><span class="nv">libdir</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">parent_libdir</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">parent_parent_libdir</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endforeach</span><span class="p">()</span>

<span class="w">  </span><span class="c"># If we already found a library somewhere, limit the search paths for the header</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">parent_dirs</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">header_search_paths</span><span class="w"> </span><span class="o">${</span><span class="nv">parent_dirs</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">header_skip_system_prefix</span><span class="w"> </span><span class="s">NO_CMAKE_SYSTEM_PATH</span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">header_search_paths</span>
<span class="w">            </span><span class="o">${</span><span class="nv">search_paths</span><span class="o">}</span>
<span class="w">            </span><span class="o">${</span><span class="nv">CMAKE_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="w"> </span><span class="c"># Search for headers in ns-3-dev/build</span>
<span class="w">            </span><span class="o">${</span><span class="nv">CMAKE_INSTALL_PREFIX</span><span class="o">}</span><span class="w"> </span><span class="c"># Search for headers in the install</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">not_found_headers</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">include_dirs</span><span class="p">)</span>
<span class="w">  </span><span class="nb">foreach</span><span class="p">(</span><span class="s">header</span><span class="w"> </span><span class="o">${</span><span class="nv">header_names</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="c"># The same way with libraries, we mark the internal variable as advanced not</span>
<span class="w">    </span><span class="c"># to pollute ccmake configuration with variables used internally</span>
<span class="w">    </span><span class="nb">mark_as_advanced</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_header_internal_</span><span class="o">${</span><span class="nv">header</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">suffixes</span>
<span class="w">            </span><span class="s">/build</span>
<span class="w">            </span><span class="s">/include</span>
<span class="w">            </span><span class="s">/build/include</span>
<span class="w">            </span><span class="s">/build/include/</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span>
<span class="w">            </span><span class="s">/include/</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span>
<span class="w">            </span><span class="s">/</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span>
<span class="w">            </span><span class="s">/</span>
<span class="w">            </span><span class="o">${</span><span class="nv">path_suffixes</span><span class="o">}</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">    </span><span class="c"># cmake-format: off</span>
<span class="w">    </span><span class="c"># Here we search for the header file named ${header} and store the result in</span>
<span class="w">    </span><span class="c"># ${name}_header_internal_${header}</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># The same way we did with libraries, here we search on</span>
<span class="w">    </span><span class="c"># CMAKE_SYSTEM_PREFIX_PATH, along with user-settable ${search_paths}, the</span>
<span class="w">    </span><span class="c"># parent directories from the libraries, CMAKE_OUTPUT_DIRECTORY and</span>
<span class="w">    </span><span class="c"># CMAKE_INSTALL_PREFIX</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># And again, for each of them, for every suffix listed /usr/local/build</span>
<span class="w">    </span><span class="c"># /usr/local/include</span>
<span class="w">    </span><span class="c"># /usr/local/build/include</span>
<span class="w">    </span><span class="c"># /usr/local/build/include/${name}</span>
<span class="w">    </span><span class="c"># /usr/local/include/${name}</span>
<span class="w">    </span><span class="c"># ...</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># cmake-format: on</span>
<span class="w">    </span><span class="c"># Or enable NS3_VERBOSE to get the searched paths printed while configuring</span>

<span class="w">    </span><span class="nb">find_file</span><span class="p">(</span>
<span class="w">      </span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_header_internal_</span><span class="o">${</span><span class="nv">header</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">header</span><span class="o">}</span>
<span class="w">      </span><span class="s">HINTS</span><span class="w"> </span><span class="o">${</span><span class="nv">header_search_paths</span><span class="o">}</span><span class="w"> </span><span class="c"># directory (e.g. /usr/)</span>
<span class="w">      </span><span class="o">${</span><span class="nv">header_skip_system_prefix</span><span class="o">}</span>
<span class="w">      </span><span class="s">PATH_SUFFIXES</span><span class="w"> </span><span class="o">${</span><span class="nv">suffixes</span><span class="o">}</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c"># Print tested paths to the searched header and if it was found</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_VERBOSE</span><span class="o">}</span><span class="p">)</span>
<span class="w">      </span><span class="nb">log_find_searched_paths</span><span class="p">(</span>
<span class="w">              </span><span class="s">TARGET_TYPE</span><span class="w"> </span><span class="s">Header</span>
<span class="w">              </span><span class="s">TARGET_NAME</span><span class="w"> </span><span class="o">${</span><span class="nv">header</span><span class="o">}</span>
<span class="w">              </span><span class="s">SEARCH_RESULT</span><span class="w"> </span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_header_internal_</span><span class="o">${</span><span class="nv">header</span><span class="o">}</span>
<span class="w">              </span><span class="s">SEARCH_PATHS</span><span class="w"> </span><span class="o">${</span><span class="nv">header_search_paths</span><span class="o">}</span>
<span class="w">              </span><span class="s">SEARCH_SUFFIXES</span><span class="w"> </span><span class="o">${</span><span class="nv">suffixes</span><span class="o">}</span>
<span class="w">              </span><span class="s">SEARCH_SYSTEM_PREFIX</span><span class="w"> </span><span class="o">${</span><span class="nv">header_skip_system_prefix</span><span class="o">}</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">    </span><span class="c"># If the header file was not found, append to the not-found list</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="s2">&quot;${${name}_header_internal_${header}}&quot;</span><span class="w"> </span><span class="s">STREQUAL</span>
<span class="w">       </span><span class="s2">&quot;${name}_header_internal_${header}-NOTFOUND&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">not_found_headers</span><span class="w"> </span><span class="o">${</span><span class="nv">header</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">else</span><span class="p">()</span>
<span class="w">      </span><span class="c"># If the header file was found, get their directories and the parent of</span>
<span class="w">      </span><span class="c"># their directories to add as include directories</span>
<span class="w">      </span><span class="nb">get_filename_component</span><span class="p">(</span>
<span class="w">        </span><span class="s">header_include_dir</span><span class="w"> </span><span class="o">${</span><span class="nv">${name</span><span class="o">}</span><span class="s">_header_internal_</span><span class="o">${</span><span class="nv">header</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">DIRECTORY</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="c"># e.g. include/click/ (simclick.h) -&gt; #include &lt;simclick.h&gt; should work</span>
<span class="w">      </span><span class="nb">get_filename_component</span><span class="p">(</span>
<span class="w">        </span><span class="s">header_include_dir2</span><span class="w"> </span><span class="o">${</span><span class="nv">header_include_dir</span><span class="o">}</span><span class="w"> </span><span class="s">DIRECTORY</span>
<span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="c"># e.g. include/(click) -&gt; #include &lt;click/simclick.h&gt; should work</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">include_dirs</span><span class="w"> </span><span class="o">${</span><span class="nv">header_include_dir</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">header_include_dir2</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endforeach</span><span class="p">()</span>

<span class="w">  </span><span class="c"># Remove duplicate include directories</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">include_dirs</span><span class="p">)</span>
<span class="w">    </span><span class="nb">list</span><span class="p">(</span><span class="s">REMOVE_DUPLICATES</span><span class="w"> </span><span class="s">include_dirs</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="c"># If we find both library and header, we export their values</span>
<span class="w">  </span><span class="nb">if</span><span class="p">((</span><span class="s">NOT</span><span class="w"> </span><span class="s">not_found_libraries}</span><span class="p">)</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="s">not_found_headers</span><span class="p">))</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_INCLUDE_DIRS</span><span class="w"> </span><span class="s2">&quot;${include_dirs}&quot;</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_LIBRARIES</span><span class="w"> </span><span class="s2">&quot;${libraries}&quot;</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_HEADER</span><span class="w"> </span><span class="o">${</span><span class="nv">${name</span><span class="o">}</span><span class="s">_header_internal}</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_FOUND</span><span class="w"> </span><span class="s">TRUE</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">status_message</span><span class="w"> </span><span class="s2">&quot;find_external_library: ${name} was found.&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_INCLUDE_DIRS</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_LIBRARIES</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_HEADER</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="o">${</span><span class="nv">name</span><span class="o">}</span><span class="s">_FOUND</span><span class="w"> </span><span class="s">FALSE</span><span class="w"> </span><span class="s">PARENT_SCOPE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">status_message</span>
<span class="w">        </span><span class="s2">&quot;find_external_library: ${name} was not found. Missing headers: \&quot;</span><span class="o">${</span><span class="nv">not_found_headers</span><span class="o">}</span><span class="s">\&quot;</span><span class="w"> </span><span class="s">and</span><span class="w"> </span><span class="s">missing</span><span class="w"> </span><span class="s">libraries:</span><span class="w"> </span><span class="s">\&quot;${not_found_libraries}\&quot;.&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">FIND_LIB_QUIET</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;${status_message}&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>Debugging why a header or a library cannot be found is fairly tricky.
For <code class="docutils literal notranslate"><span class="pre">find_external_library</span></code> users, enabling the <code class="docutils literal notranslate"><span class="pre">NS3_VERBOSE</span></code> switch
will enable the logging of search path directories for both headers and
libraries.</p>
<p>Note: The logging provided by find_external_library is an alternative to
CMake’s own <code class="docutils literal notranslate"><span class="pre">CMAKE_FIND_DEBUG_MODE=true</span></code> introduced in CMake 3.17,
which gets used by <em>ALL</em> <code class="docutils literal notranslate"><span class="pre">find_file</span></code>, <code class="docutils literal notranslate"><span class="pre">find_library</span></code>, <code class="docutils literal notranslate"><span class="pre">find_header</span></code>,
<code class="docutils literal notranslate"><span class="pre">find_package</span></code> and <code class="docutils literal notranslate"><span class="pre">find_path</span></code> calls throughout CMake and its modules.
If you are using a recent version of CMake, it is recommended to use
<a class="reference external" href="https://cmake.org/cmake/help/latest/variable/CMAKE_FIND_DEBUG_MODE.html">CMAKE_FIND_DEBUG_MODE</a> instead.</p>
<p>A commented version of the Openflow module <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> has an
example of <code class="docutils literal notranslate"><span class="pre">find_external_library</span></code> usage.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Export a user option to specify the path to a custom</span>
<span class="c"># openflow build directory.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">NS3_WITH_OPENFLOW</span>
<span class="w">    </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="s">CACHE</span><span class="w"> </span><span class="s">PATH</span>
<span class="w">          </span><span class="s2">&quot;Build with Openflow support&quot;</span>
<span class="p">)</span>
<span class="c"># We use this variable later in the ns-3-dev scope, but</span>
<span class="c"># the value would be lost if we saved it to the</span>
<span class="c"># parent scope ns-3-dev/src or ns-3-dev/contrib.</span>
<span class="c"># We set it as an INTERNAL CACHE variable to make it globally available.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">NS3_OPENFLOW</span>
<span class="w">    </span><span class="s2">&quot;OFF&quot;</span>
<span class="w">    </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span>
<span class="w">          </span><span class="s2">&quot;ON if Openflow is found&quot;</span>
<span class="p">)</span>

<span class="c"># This is the macro that searches for headers and libraries.</span>
<span class="c"># The DEPENDENCY_NAME is the equivalent of the find_package package name.</span>
<span class="c"># Resulting variables will be prefixed with DEPENDENCY_NAME.</span>
<span class="c"># - openflow_FOUND will be set to True if both headers and libraries</span>
<span class="c">#     were found and False otherwise</span>
<span class="c"># - openflow_LIBRARIES will contain a list of absolute paths to the</span>
<span class="c">#     libraries named in LIBRARY_NAME|LIBRARY_NAMES</span>
<span class="c"># - openflow_INCLUDE_DIRS will contain a list of include directories that contain</span>
<span class="c">#     headers named in HEADER_NAME|HEADER_NAMES and directories that contain</span>
<span class="c">#     those directories.</span>
<span class="c">#     e.g. searching for core-module.h will return</span>
<span class="c">#     both ns-3-dev/build/include/ns3 and ns-3-dev/build/include,</span>
<span class="c">#     allowing users to include both &lt;core-module.h&gt; and &lt;ns3/core-module.h&gt;</span>
<span class="c"># If a user-settable variable was created, it can be searched too by</span>
<span class="c"># adding it to the SEARCH_PATHS</span>
<span class="nb">find_external_library</span><span class="p">(</span>
<span class="w">  </span><span class="s">DEPENDENCY_NAME</span><span class="w"> </span><span class="s">openflow</span>
<span class="w">  </span><span class="s">HEADER_NAME</span><span class="w"> </span><span class="s">openflow.h</span>
<span class="w">  </span><span class="s">LIBRARY_NAME</span><span class="w"> </span><span class="s">openflow</span>
<span class="w">  </span><span class="s">SEARCH_PATHS</span><span class="w"> </span><span class="o">${</span><span class="nv">NS3_WITH_OPENFLOW</span><span class="o">}</span><span class="w"> </span><span class="c"># user-settable search path, empty by default</span>
<span class="p">)</span>

<span class="c"># Before testing if the header and library were found ${openflow_FOUND},</span>
<span class="c"># test if openflow_FOUND was defined</span>
<span class="c"># If openflow_FOUND was not defined, the dependency name above doesn&#39;t match</span>
<span class="c"># the tested values below</span>
<span class="c"># If openflow_FOUND is set to FALSE, stop processing the module by returning</span>
<span class="c"># to the parent directory with return()</span>
<span class="nb">if</span><span class="p">((</span><span class="s">NOT</span>
<span class="w">    </span><span class="s">openflow_FOUND</span><span class="p">)</span>
<span class="w">   </span><span class="s">AND</span><span class="w"> </span><span class="p">(</span><span class="s">NOT</span>
<span class="w">        </span><span class="o">${</span><span class="nv">openflow_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="p">)</span>
<span class="w">  </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Openflow was not found&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">return</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># Check for the Boost header used by the openflow module</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span>
<span class="w">  </span><span class="s">boost/static_assert.hpp</span>
<span class="w">  </span><span class="s">BOOST_STATIC_ASSERT</span>
<span class="p">)</span>

<span class="c"># Stop processing the module if it was not found</span>
<span class="nb">if</span><span class="p">(</span><span class="s">NOT</span>
<span class="w">  </span><span class="s">BOOST_STATIC_ASSERT</span>
<span class="p">)</span>
<span class="w">  </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Openflow requires Boost static_assert.hpp&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">return</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># Here we consume the include directories found by</span>
<span class="c"># find_external_library</span>
<span class="c">#</span>
<span class="c"># This will make the following work:</span>
<span class="c">#  include&lt;openflow/openflow.h&gt;</span>
<span class="c">#  include&lt;openflow.h&gt;</span>
<span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">openflow_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>

<span class="c"># Manually set definitions</span>
<span class="nb">add_definitions</span><span class="p">(</span>
<span class="w">  </span><span class="s">-DNS3_OPENFLOW</span>
<span class="w">  </span><span class="s">-DENABLE_OPENFLOW</span>
<span class="p">)</span>

<span class="c"># Set the cache variable indicating Openflow is enabled as</span>
<span class="c"># all dependencies were met</span>
<span class="nb">set</span><span class="p">(</span><span class="s">NS3_OPENFLOW</span>
<span class="w">    </span><span class="s2">&quot;ON&quot;</span>
<span class="w">    </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span>
<span class="w">          </span><span class="s2">&quot;ON if Openflow is found in NS3_WITH_OPENFLOW&quot;</span>
<span class="p">)</span>

<span class="c"># Additional compilation flag to ignore a specific warning</span>
<span class="nb">add_compile_options</span><span class="p">(</span><span class="s">-Wno-stringop-truncation</span><span class="p">)</span>

<span class="c"># Call macro to create the module target</span>
<span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">openflow</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span>
<span class="w">    </span><span class="s">helper/openflow-switch-helper.cc</span>
<span class="w">    </span><span class="s">model/openflow-interface.cc</span>
<span class="w">    </span><span class="s">model/openflow-switch-net-device.cc</span>
<span class="w">  </span><span class="s">HEADER_FILES</span>
<span class="w">    </span><span class="s">helper/openflow-switch-helper.h</span>
<span class="w">    </span><span class="s">model/openflow-interface.h</span>
<span class="w">    </span><span class="s">model/openflow-switch-net-device.h</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span>
<span class="w">                    </span><span class="c"># Here we consume the list of libraries</span>
<span class="w">                    </span><span class="c"># exported by find_external_library</span>
<span class="w">                    </span><span class="o">${</span><span class="nv">openflow_LIBRARIES</span><span class="o">}</span>
<span class="w">  </span><span class="s">TEST_SOURCES</span><span class="w"> </span><span class="s">test/openflow-switch-test-suite.cc</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="linking-third-party-libraries-using-cmake-s-find-package">
<h6><span class="section-number">4.3.7.4.2. </span>Linking third-party libraries using CMake’s find_package<a class="headerlink" href="#linking-third-party-libraries-using-cmake-s-find-package" title="Link to this heading">¶</a></h6>
<p>Assume we have a module with optional features that rely on a third-party library
that provides a FindThirdPartyPackage.cmake. This <code class="docutils literal notranslate"><span class="pre">Find${Package}.cmake</span></code> file can be distributed
by <a class="reference external" href="https://github.com/Kitware/CMake/tree/master/Modules">CMake itself</a>, via library/package managers (APT, Pacman,
<a class="reference external" href="https://github.com/Microsoft/vcpkg#using-vcpkg-with-cmake">vcpkg</a>), or included to the project tree in the build-support/3rd-party directory.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">find_package(${Package})</span></code> is called, the <code class="docutils literal notranslate"><span class="pre">Find${Package}.cmake</span></code> file gets processed,
and multiple variables are set. There is no hard standard in the name of those variables, nor if
they should follow the modern CMake usage, where just linking to the library will include
associated header directories, forward compile flags and so on.</p>
<p>We assume the old CMake style is the one being used, which means we need to include the include
directories provided by the <code class="docutils literal notranslate"><span class="pre">Find${Package}.cmake</span> <span class="pre">module</span></code>, usually exported as a variable
<code class="docutils literal notranslate"><span class="pre">${Package}_INCLUDE_DIRS</span></code>, and get a list of libraries for that module so that they can be
added to the list of libraries to link of the <em>ns-3</em> modules. Libraries are usually exported as
the variable <code class="docutils literal notranslate"><span class="pre">${Package}_LIBRARIES</span></code>.</p>
<p>As an example for the above, we use the Boost library
(excerpt from <code class="docutils literal notranslate"><span class="pre">macros-and-definitions.cmake</span></code> and <code class="docutils literal notranslate"><span class="pre">src/core/CMakeLists.txt</span></code>):</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># https://cmake.org/cmake/help/v3.10/module/FindBoost.html?highlight=module%20find#module:FindBoost</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Boost</span><span class="p">)</span>

<span class="c"># It is recommended to create either an empty list that is conditionally filled</span>
<span class="c"># and later included in the LIBRARIES_TO_LINK list unconditionally</span>
<span class="nb">set</span><span class="p">(</span><span class="s">boost_libraries</span><span class="p">)</span>

<span class="c"># If Boost is found, Boost_FOUND will be set to true, which we can then test</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">Boost_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="c"># This will export Boost include directories to ALL subdirectories</span>
<span class="w">  </span><span class="c"># of the current CMAKE_CURRENT_SOURCE_DIR</span>
<span class="w">  </span><span class="c">#</span>
<span class="w">  </span><span class="c"># If calling this from the top-level directory (ns-3-dev), it will</span>
<span class="w">  </span><span class="c"># be used by all contrib/src modules, examples, etc</span>
<span class="w">  </span><span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">Boost_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># This is a trick for Boost</span>
<span class="w">  </span><span class="c"># Sometimes you want to check if specific Boost headers are available,</span>
<span class="w">  </span><span class="c"># but they would not be found if they&#39;re not in system include directories</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_REQUIRED_INCLUDES</span><span class="w"> </span><span class="o">${</span><span class="nv">Boost_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># We get the list of Boost libraries and save them in the boost_libraries list</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">boost_libraries</span><span class="w"> </span><span class="o">${</span><span class="nv">Boost_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># If Boost was found earlier, we will be able to check if Boost headers are available</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span>
<span class="w">  </span><span class="s2">&quot;boost/units/quantity.hpp&quot;</span>
<span class="w">  </span><span class="s">HAVE_BOOST_UNITS_QUANTITY</span>
<span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span>
<span class="w">  </span><span class="s2">&quot;boost/units/systems/si.hpp&quot;</span>
<span class="w">  </span><span class="s">HAVE_BOOST_UNITS_SI</span>
<span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">HAVE_BOOST_UNITS_QUANTITY</span><span class="o">}</span>
<span class="w">  </span><span class="s">AND</span><span class="w"> </span><span class="o">${</span><span class="nv">HAVE_BOOST_UNITS_SI</span><span class="o">}</span>
<span class="p">)</span>
<span class="w">  </span><span class="c"># Activate optional features that rely on Boost</span>
<span class="w">  </span><span class="nb">add_definitions</span><span class="p">(</span>
<span class="w">    </span><span class="s">-DHAVE_BOOST</span>
<span class="w">    </span><span class="s">-DHAVE_BOOST_UNITS</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="c"># In this case, the Boost libraries are header-only,</span>
<span class="w">  </span><span class="c"># but in case we needed real libraries, we could add</span>
<span class="w">  </span><span class="c"># boost_libraries to either the auxiliary libraries_to_link list</span>
<span class="w">  </span><span class="c"># or the build_lib&#39;s LIBRARIES_TO_LINK list</span>
<span class="w">  </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Boost Units have been found.&quot;</span><span class="p">)</span>
<span class="nb">else</span><span class="p">()</span>
<span class="w">  </span><span class="nb">message</span><span class="p">(</span>
<span class="w">    </span><span class="s">STATUS</span>
<span class="w">      </span><span class="s2">&quot;Boost Units are an optional feature of length.cc.&quot;</span>
<span class="w">  </span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">Find${Package}.cmake</span></code> does not exist in your module path, CMake will warn you that is the case.
If <code class="docutils literal notranslate"><span class="pre">${Package_FOUND}</span></code> is set to <code class="docutils literal notranslate"><span class="pre">False</span></code>, other variables such as the ones related to libraries and
include directories might not be set, and can result in CMake failures to configure if used.</p>
<p>In case the <code class="docutils literal notranslate"><span class="pre">Find${Package}.cmake</span></code> you need is not distributed by the upstream CMake project,
you can create your own and add it to <code class="docutils literal notranslate"><span class="pre">build-support/3rd-party</span></code>. This directory is included
to the <code class="docutils literal notranslate"><span class="pre">CMAKE_MODULE_PATH</span></code> variable, making it available for calls without needing to include
the file with the absolute path to it. To add more directories to the <code class="docutils literal notranslate"><span class="pre">CMAKE_MODULE_PATH</span></code>,
use the following:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Excerpt from build-support/macros-and-definitions.cmake</span>

<span class="c"># Add ns-3 custom modules to the module path</span>
<span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">CMAKE_MODULE_PATH</span><span class="w"> </span><span class="s2">&quot;${PROJECT_SOURCE_DIR}/build-support/custom-modules&quot;</span><span class="p">)</span>

<span class="c"># Add the 3rd-party modules to the module path</span>
<span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">CMAKE_MODULE_PATH</span><span class="w"> </span><span class="s2">&quot;${PROJECT_SOURCE_DIR}/build-support/3rd-party&quot;</span><span class="p">)</span>

<span class="c"># Add your new modules directory to the module path</span>
<span class="c"># (${PROJECT_SOURCE_DIR} is /path/to/ns-3-dev/)</span>
<span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">CMAKE_MODULE_PATH</span><span class="w"> </span><span class="s2">&quot;${PROJECT_SOURCE_DIR}/build-support/new-modules&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>One of the custom Find files currently shipped by <em>ns-3</em> is the <code class="docutils literal notranslate"><span class="pre">FindGTK3.cmake</span></code> file.
GTK3 requires Harfbuzz, which has its own <code class="docutils literal notranslate"><span class="pre">FindHarfBuzz.cmake</span></code> file. Both of them
are in the <code class="docutils literal notranslate"><span class="pre">build-support/3rd-party</span></code> directory.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># You don&#39;t need to keep adding this, this is just a demonstration</span>
<span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">CMAKE_MODULE_PATH</span><span class="w"> </span><span class="s2">&quot;${PROJECT_SOURCE_DIR}/build-support/3rd-party&quot;</span><span class="p">)</span>

<span class="c"># If the user-settable NS3_GTK3 is set, look for HarfBuzz and GTK</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_GTK3</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Use FindHarfBuzz.cmake to find HarfBuzz</span>
<span class="w">  </span><span class="nb">find_package</span><span class="p">(</span><span class="s">HarfBuzz</span><span class="w"> </span><span class="s">QUIET</span><span class="p">)</span>

<span class="w">  </span><span class="c"># If HarfBuzz is not found</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">HarfBuzz_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Harfbuzz is required by GTK3 and was not found.&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="c"># FindGTK3.cmake does some weird tricks and results in warnings,</span>
<span class="w">    </span><span class="c"># that we can only suppress this way</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_SUPPRESS_DEVELOPER_WARNINGS</span><span class="w"> </span><span class="s">1</span><span class="w"> </span><span class="s">CACHE</span><span class="w"> </span><span class="s">BOOL</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c"># If HarfBuzz is found, search for GTK</span>
<span class="w">    </span><span class="nb">find_package</span><span class="p">(</span><span class="s">GTK3</span><span class="w"> </span><span class="s">QUIET</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Remove suppressions needed for quiet operations</span>
<span class="w">    </span><span class="nb">unset</span><span class="p">(</span><span class="s">CMAKE_SUPPRESS_DEVELOPER_WARNINGS</span><span class="w"> </span><span class="s">CACHE</span><span class="p">)</span>

<span class="w">    </span><span class="c"># If GTK3 is not found, inform the user</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">GTK3_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">      </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;GTK3 was not found. Continuing without it.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">else</span><span class="p">()</span>
<span class="w">      </span><span class="c"># If an incompatible version is found, set the GTK3_FOUND flag to false,</span>
<span class="w">      </span><span class="c"># to make sure it won&#39;t be used later</span>
<span class="w">      </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">GTK3_VERSION</span><span class="o">}</span><span class="w"> </span><span class="s">VERSION_LESS</span><span class="w"> </span><span class="s">3.22</span><span class="p">)</span>
<span class="w">        </span><span class="nb">set</span><span class="p">(</span><span class="s">GTK3_FOUND</span><span class="w"> </span><span class="s">FALSE</span><span class="p">)</span>
<span class="w">        </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;GTK3 found with incompatible version ${GTK3_VERSION}&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="nb">else</span><span class="p">()</span>
<span class="w">        </span><span class="c"># A compatible GTK3 version was found</span>
<span class="w">        </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;GTK3 was found.&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>The Stats module can use the same <code class="docutils literal notranslate"><span class="pre">find_package</span></code> macro to search for SQLite3.</p>
<p>Note: we currently use a custom macro to find Python3 and SQLite3 since
<code class="docutils literal notranslate"><span class="pre">FindPython3.cmake</span></code> and <code class="docutils literal notranslate"><span class="pre">FindSQLite3.cmake</span></code> were included in CMake 3.12 and 3.14.
More details on how to use the macro are listed in
<a class="reference internal" href="#linking-third-party-libraries-without-cmake-or-pkgconfig-support">Linking third-party libraries without CMake or PkgConfig support</a>.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Set enable flag to false before checking</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ENABLE_SQLITE</span><span class="w"> </span><span class="s">False</span><span class="p">)</span>

<span class="c"># In this case, SQLite presence is only checked if the user sets</span>
<span class="c"># NS3_SQLITE to ON, but your case may be different</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_SQLITE</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="c"># FindSQLite3.cmake is used by CMake to find SQLite3</span>
<span class="w">  </span><span class="c"># QUIET flag silences most warnings from the module and let us write our own</span>
<span class="w">  </span><span class="nb">find_package</span><span class="p">(</span><span class="s">SQLite3</span><span class="w"> </span><span class="s">QUIET</span><span class="p">)</span><span class="w"> </span><span class="c"># FindSQLite3.cmake was included in CMake 3.14</span>

<span class="w">  </span><span class="c"># If SQLite3 was found, SQLite3_FOUND will be set to True, otherwise to False</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">SQLite3_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">ENABLE_SQLITE</span><span class="w"> </span><span class="s">True</span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;SQLite was not found&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># Here we declare empty lists, that only hold values if ENABLE_SQLITE is set to ON</span>
<span class="nb">set</span><span class="p">(</span><span class="s">sqlite_sources</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">sqlite_header</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">sqlite_libraries</span><span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">ENABLE_SQLITE</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="c"># If SQLite was found, add the optional source files to the lists</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">sqlite_sources</span>
<span class="w">      </span><span class="s">model/sqlite-data-output.cc</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">sqlite_headers</span>
<span class="w">      </span><span class="s">model/sqlite-data-output.h</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="c"># Include the include directories containing the sqlite3.h header</span>
<span class="w">  </span><span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">SQLite3_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Copy the list of sqlite3 libraries</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">sqlite_libraries</span>
<span class="w">      </span><span class="o">${</span><span class="nv">SQLite3_LIBRARIES</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># If the semaphore header is also found,</span>
<span class="w">  </span><span class="c"># append additional optional source files to</span>
<span class="w">  </span><span class="c"># the sqlite sources and headers lists</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">HAVE_SEMAPHORE_H</span><span class="p">)</span>
<span class="w">    </span><span class="nb">list</span><span class="p">(</span>
<span class="w">      </span><span class="s">APPEND</span>
<span class="w">      </span><span class="s">sqlite_sources</span>
<span class="w">      </span><span class="s">model/sqlite-output.cc</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="nb">list</span><span class="p">(</span>
<span class="w">      </span><span class="s">APPEND</span>
<span class="w">      </span><span class="s">sqlite_headers</span>
<span class="w">      </span><span class="s">model/sqlite-output.h</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># Sources and headers file lists for stats are quite long,</span>
<span class="c"># so we use these auxiliary lists</span>
<span class="c"># The optional sqlite_sources and sqlite_headers can be empty or not</span>
<span class="nb">set</span><span class="p">(</span><span class="s">source_files</span>
<span class="w">    </span><span class="o">${</span><span class="nv">sqlite_sources</span><span class="o">}</span>
<span class="w">    </span><span class="c"># ...</span>
<span class="w">    </span><span class="s">model/uinteger-8-probe.cc</span>
<span class="p">)</span>

<span class="nb">set</span><span class="p">(</span><span class="s">header_files</span>
<span class="w">    </span><span class="o">${</span><span class="nv">sqlite_headers</span><span class="o">}</span>
<span class="w">    </span><span class="c"># ...</span>
<span class="w">    </span><span class="s">model/uinteger-8-probe.h</span>
<span class="p">)</span>

<span class="c"># Create the stats module consuming source files</span>
<span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">stats</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="o">${</span><span class="nv">source_files</span><span class="o">}</span>
<span class="w">  </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="o">${</span><span class="nv">header_files</span><span class="o">}</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libcore</span><span class="o">}</span>
<span class="w">                    </span><span class="c"># Here we either have an empty list or</span>
<span class="w">                    </span><span class="c"># a list with the sqlite library</span>
<span class="w">                    </span><span class="o">${</span><span class="nv">sqlite_libraries</span><span class="o">}</span>
<span class="w">  </span><span class="s">TEST_SOURCES</span>
<span class="w">    </span><span class="s">test/average-test-suite.cc</span>
<span class="w">    </span><span class="s">test/basic-data-calculators-test-suite.cc</span>
<span class="w">    </span><span class="s">test/double-probe-test-suite.cc</span>
<span class="w">    </span><span class="s">test/histogram-test-suite.cc</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="linking-third-party-libraries-with-pkgconfig-support">
<h6><span class="section-number">4.3.7.4.3. </span>Linking third-party libraries with PkgConfig support<a class="headerlink" href="#linking-third-party-libraries-with-pkgconfig-support" title="Link to this heading">¶</a></h6>
<p>Assume we have a module with optional features that rely on a third-party library
that uses PkgConfig. We can look for the PkgConfig module and add the optional
source files similarly to the previous cases, as shown in the example below:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Include CMake script to use pkg-config</span>
<span class="nb">include</span><span class="p">(</span><span class="s">FindPkgConfig</span><span class="p">)</span>

<span class="c"># If pkg-config was found, search for library you want</span>
<span class="nb">if</span><span class="p">(</span><span class="s">PKG_CONFIG_FOUND</span><span class="p">)</span>
<span class="w">  </span><span class="nb">pkg_check_modules</span><span class="p">(</span><span class="s">THIRD_PARTY</span><span class="w"> </span><span class="s">libthird-party</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="nb">set</span><span class="p">(</span><span class="s">third_party_sources</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">third_party_libs</span><span class="p">)</span>
<span class="c"># Set cached variable if both pkg-config and libthird-party are found</span>
<span class="nb">if</span><span class="p">(</span><span class="s">PKG_CONFIG_FOUND</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="s">THIRD_PARTY</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Include third-party include directories for</span>
<span class="w">  </span><span class="c"># consumption of the current module and its examples</span>
<span class="w">  </span><span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">THIRD_PARTY_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Use exported CFLAGS required by the third-party library</span>
<span class="w">  </span><span class="nb">add_compile_options</span><span class="p">(</span><span class="o">${</span><span class="nv">THIRD_PARTY_CFLAGS</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Copy the list of third-party libraries</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">third_party_libs</span><span class="w"> </span><span class="o">${</span><span class="nv">THIRD_PARTY_LIBRARIES</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Add optional source files that depend on the third-party library</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">third_party_sources</span><span class="w"> </span><span class="s">model/optional-feature.cc</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># Create module using the optional source files and libraries</span>
<span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">hypothetical</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">model/hypothetical.cc</span>
<span class="w">               </span><span class="o">${</span><span class="nv">third_party_sources</span><span class="o">}</span>
<span class="w">  </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="s">model/hypothetical.h</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libcore</span><span class="o">}</span>
<span class="w">                    </span><span class="c"># Here we either have an empty list or</span>
<span class="w">                    </span><span class="c"># a list with the third-party library</span>
<span class="w">                    </span><span class="o">${</span><span class="nv">third_party_libs</span><span class="o">}</span>
<span class="w">  </span><span class="s">TEST_SOURCES</span>
<span class="w">    </span><span class="s">test/hypothetical.cc</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="using-c-library-managers">
<span id="id5"></span><h5><span class="section-number">4.3.7.5. </span>Using C++ library managers<a class="headerlink" href="#using-c-library-managers" title="Link to this heading">¶</a></h5>
<p>It is not rare to try using a library that is not available
on a certain platform or does not have a CMake-friendly
interface for us to use.</p>
<p>Some C++ package managers are fairly easy to use with CMake,
such as <a class="reference external" href="https://github.com/Microsoft/vcpkg#using-vcpkg-with-cmake">Vcpkg</a> and <a class="reference external" href="https://github.com/cpm-cmake/CPM.cmake">CPM</a>.</p>
<section id="id6">
<h6><span class="section-number">4.3.7.5.1. </span>vcpkg<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h6>
<p>Vcpkg requires <code class="docutils literal notranslate"><span class="pre">git</span></code>, <code class="docutils literal notranslate"><span class="pre">curl</span></code>, <code class="docutils literal notranslate"><span class="pre">zip</span></code>, <code class="docutils literal notranslate"><span class="pre">unzip</span></code> and <code class="docutils literal notranslate"><span class="pre">tar</span></code>,
along with the default ns-3 dependencies. The setup downloads
and builds vcpkg from their Git repository. Telemetry is disabled
by default.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ ./ns3 configure -- -DNS3_VCPKG=ON</span>
<span class="go">...</span>
<span class="go">-- vcpkg: setting up support</span>
<span class="go">Cloning into &#39;vcpkg&#39;...</span>
<span class="go">Updating files: 100% (10376/10376), done.</span>
<span class="go">Downloading vcpkg-glibc...</span>
<span class="go">vcpkg package management program version 2023-07-19-814b7ec837b59f1c8778f72351c1dd7605983cd2</span>
<span class="go">...</span>
</pre></div>
</div>
<p>Configuration will finish successfully.
For example, now we can try using the Armadillo library.
To do that, we use the following CMake statements:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Check this is not a fluke</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span>
<span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Armadillo was found? ${ARMADILLO_FOUND}&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Reconfigure ns-3 to check if Armadillo is available.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ ./ns3 configure</span>
<span class="go">...</span>
<span class="go">-- vcpkg: setting up support</span>
<span class="go">-- vcpkg: folder already exists, skipping git download</span>
<span class="go">-- vcpkg: already bootstrapped</span>
<span class="go">...</span>
<span class="go">-- Could NOT find Armadillo (missing: ARMADILLO_INCLUDE_DIR)</span>
<span class="go">-- Armadillo was found? FALSE</span>
</pre></div>
</div>
<p>As you can see, no Armadillo found.
We can now use vcpkg to install it, using the CMake
function <code class="docutils literal notranslate"><span class="pre">add_package(package_name)</span></code>. CMake
will then be able to find the installed package using <code class="docutils literal notranslate"><span class="pre">find_package</span></code>.</p>
<p>Note: some packages may require additional dependencies.
The Armadillo package requires <code class="docutils literal notranslate"><span class="pre">pkg-config</span></code> and a fortran compiler.
You will be prompted with a CMake error when a missing dependency is found.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Install Armadillo and search for it again</span>
<span class="nb">add_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span><span class="w"> </span><span class="c"># Installs Armadillo with vcpkg</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span><span class="w"> </span><span class="c"># Loads vcpkg installation of Armadillo</span>
<span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Armadillo was found? ${ARMADILLO_FOUND}&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Sadly, we will need to reconfigure ns-3 from the scratch,
since CMake <code class="docutils literal notranslate"><span class="pre">find_package</span></code> caches are problematic.
Installing the packages can take a while, and it can look like it hanged.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ ./ns3 clean</span>
<span class="go">~$ ./ns3 configure -- -DNS3_VCPKG=ON</span>
<span class="go">...</span>
<span class="go">-- vcpkg: setting up support</span>
<span class="go">-- vcpkg: folder already exists, skipping git download</span>
<span class="go">-- vcpkg: already bootstrapped</span>
<span class="go">...</span>
<span class="go">-- vcpkg: Armadillo will be installed</span>
<span class="go">-- vcpkg: Armadillo was installed</span>
<span class="go">-- Armadillo was found? TRUE</span>
</pre></div>
</div>
<p>As shown above, the Armadillo library gets installed by vcpkg
and it can be found by CMake’s <code class="docutils literal notranslate"><span class="pre">find_package</span></code> function.
We can then use it for our targets.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Install Armadillo</span>
<span class="nb">add_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span><span class="w"> </span><span class="c"># Installs Armadillo with vcpkg</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span><span class="w"> </span><span class="c"># Loads vcpkg installation of Armadillo</span>
<span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Armadillo was found? ${ARMADILLO_FOUND}&quot;</span><span class="p">)</span>

<span class="c"># Include and link Armadillo to targets</span>
<span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">ARMADILLO_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span>
<span class="nb">link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">ARMADILLO_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
</pre></div>
</div>
<p>An alternative to manually installing packages with <code class="docutils literal notranslate"><span class="pre">add_package</span></code> is
placing all packages into a <code class="docutils literal notranslate"><span class="pre">vcpkg.json</span></code> file in the ns-3 main directory.
This mode is known as the “manifest mode” in the Vcpkg manual.
Packages there will be automatically installed at the beginning of the configuration.
More information about the manifest mode can be found in <a class="reference external" href="https://learn.microsoft.com/en-us/vcpkg/users/manifests">vcpkg manifests</a> website.</p>
<p>Let us see an example of this mode starting with the <code class="docutils literal notranslate"><span class="pre">vcpkg.json</span></code> file.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;dependencies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;sqlite3&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;eigen3&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;libxml2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;gsl&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;boost-units&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>These are some of the optional dependencies used by the upstream ns-3 modules.
When configuring ns-3 with the Vcpkg support, we will see the following.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">/ns-3-dev$ ./ns3 clean</span>
<span class="go">/ns-3-dev$ ./ns3 configure -- -DNS3_VCPKG=ON</span>
<span class="go">...</span>
<span class="go">-- vcpkg: setting up support</span>
<span class="go">Cloning into &#39;vcpkg&#39;...</span>
<span class="go">Updating files: 100% (10434/10434), done.</span>
<span class="go">Downloading vcpkg-glibc...</span>
<span class="go">vcpkg package management program version 2023-08-02-6d13efa755f9b5e101712d210199e4139b4c29f6</span>

<span class="go">See LICENSE.txt for license information.</span>
<span class="go">-- vcpkg: detected a vcpkg manifest file: /ns-3-dev/vcpkg.json</span>
<span class="go">A suitable version of cmake was not found (required v3.27.1) Downloading portable cmake 3.27.1...</span>
<span class="go">Downloading cmake...</span>
<span class="go">https://github.com/Kitware/CMake/releases/download/v3.27.1/cmake-3.27.1-linux-x86_64.tar.gz-&gt;/ns-3-dev/vcpkg/downloads/cmake-3.27.1-linux-x86_64.tar.gz</span>
<span class="go">Extracting cmake...</span>
<span class="go">Detecting compiler hash for triplet x64-linux...</span>
<span class="go">The following packages will be built and installed:</span>
<span class="go">  * boost-array:x64-linux -&gt; 1.82.0#2</span>
<span class="go">  ...</span>
<span class="go">  * boost-winapi:x64-linux -&gt; 1.82.0#2</span>
<span class="go">    eigen3:x64-linux -&gt; 3.4.0#2</span>
<span class="go">    gsl:x64-linux -&gt; 2.7.1#3</span>
<span class="go">  * libiconv:x64-linux -&gt; 1.17#1</span>
<span class="go">  * liblzma:x64-linux -&gt; 5.4.3#1</span>
<span class="go">    libxml2[core,iconv,lzma,zlib]:x64-linux -&gt; 2.10.3#1</span>
<span class="go">    sqlite3[core,json1]:x64-linux -&gt; 3.42.0#1</span>
<span class="go">  * vcpkg-cmake:x64-linux -&gt; 2023-05-04</span>
<span class="go">  * vcpkg-cmake-config:x64-linux -&gt; 2022-02-06#1</span>
<span class="go">  * vcpkg-cmake-get-vars:x64-linux -&gt; 2023-03-02</span>
<span class="go">  * zlib:x64-linux -&gt; 1.2.13</span>
<span class="go">Additional packages (*) will be modified to complete this operation.</span>
<span class="go">Restored 0 package(s) from /root/.cache/vcpkg/archives in 98.7 us. Use --debug to see more details.</span>
<span class="go">Installing 1/58 boost-uninstall:x64-linux...</span>
<span class="go">...</span>
<span class="go">Installing 50/58 boost-units:x64-linux...</span>
<span class="go">Building boost-units:x64-linux...</span>
<span class="go">-- Downloading https://github.com/boostorg/units/archive/boost-1.82.0.tar.gz -&gt; boostorg-units-boost-1.82.0.tar.gz...</span>
<span class="go">-- Extracting source /ns-3-dev/vcpkg/downloads/boostorg-units-boost-1.82.0.tar.gz</span>
<span class="go">-- Using source at /ns-3-dev/vcpkg/buildtrees/boost-units/src/ost-1.82.0-a9fdcc40b2.clean</span>
<span class="go">-- Copying headers</span>
<span class="go">-- Copying headers done</span>
<span class="go">-- Installing: /ns-3-dev/vcpkg/packages/boost-units_x64-linux/share/boost-units/usage</span>
<span class="go">-- Installing: /ns-3-dev/vcpkg/packages/boost-units_x64-linux/share/boost-units/copyright</span>
<span class="go">-- Performing post-build validation</span>
<span class="go">Stored binaries in 1 destinations in 276 ms.</span>
<span class="go">Elapsed time to handle boost-units:x64-linux: 3.8 s</span>
<span class="go">Installing 51/58 vcpkg-cmake-config:x64-linux...</span>
<span class="go">Building vcpkg-cmake-config:x64-linux...</span>
<span class="go">-- Installing: /ns-3-dev/vcpkg/packages/vcpkg-cmake-config_x64-linux/share/vcpkg-cmake-config/vcpkg_cmake_config_fixup.cmake</span>
<span class="go">-- Installing: /ns-3-dev/vcpkg/packages/vcpkg-cmake-config_x64-linux/share/vcpkg-cmake-config/vcpkg-port-config.cmake</span>
<span class="go">-- Installing: /ns-3-dev/vcpkg/packages/vcpkg-cmake-config_x64-linux/share/vcpkg-cmake-config/copyright</span>
<span class="go">-- Performing post-build validation</span>
<span class="go">Stored binaries in 1 destinations in 8.58 ms.</span>
<span class="go">Elapsed time to handle vcpkg-cmake-config:x64-linux: 144 ms</span>
<span class="go">Installing 52/58 eigen3:x64-linux...</span>
<span class="go">Building eigen3:x64-linux...</span>
<span class="go">-- Downloading https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.gz -&gt; libeigen-eigen-3.4.0.tar.gz...</span>
<span class="go">-- Extracting source /ns-3-dev/vcpkg/downloads/libeigen-eigen-3.4.0.tar.gz</span>
<span class="go">-- Applying patch remove_configure_checks.patch</span>
<span class="go">-- Applying patch fix-vectorized-reductions-half.patch</span>
<span class="go">-- Using source at /ns-3-dev/vcpkg/buildtrees/eigen3/src/3.4.0-74a8d62212.clean</span>
<span class="go">-- Configuring x64-linux</span>
<span class="go">-- Building x64-linux-dbg</span>
<span class="go">-- Building x64-linux-rel</span>
<span class="go">-- Fixing pkgconfig file: /ns-3-dev/vcpkg/packages/eigen3_x64-linux/lib/pkgconfig/eigen3.pc</span>
<span class="go">CMake Error at scripts/cmake/vcpkg_find_acquire_program.cmake:163 (message):</span>
<span class="go">  Could not find pkg-config.  Please install it via your package manager:</span>

<span class="go">      sudo apt-get install pkg-config</span>
<span class="go">Call Stack (most recent call first):</span>
<span class="go">  scripts/cmake/vcpkg_fixup_pkgconfig.cmake:203 (vcpkg_find_acquire_program)</span>
<span class="go">  ports/eigen3/portfile.cmake:30 (vcpkg_fixup_pkgconfig)</span>
<span class="go">  scripts/ports.cmake:147 (include)</span>


<span class="go">error: building eigen3:x64-linux failed with: BUILD_FAILED</span>
<span class="go">Elapsed time to handle eigen3:x64-linux: 19 s</span>
<span class="go">Please ensure you&#39;re using the latest port files with `git pull` and `vcpkg update`.</span>
<span class="go">Then check for known issues at:</span>
<span class="go">    https://github.com/microsoft/vcpkg/issues?q=is%3Aissue+is%3Aopen+in%3Atitle+eigen3</span>
<span class="go">You can submit a new issue at:</span>
<span class="go">    https://github.com/microsoft/vcpkg/issues/new?title=[eigen3]+Build+error&amp;body=Copy+issue+body+from+%2Fns-3-dev%2Fvcpkg%2Finstalled%2Fvcpkg%2Fissue_body.md</span>

<span class="go">CMake Error at build-support/3rd-party/colored-messages.cmake:82 (_message):</span>
<span class="go">  vcpkg: packages defined in the manifest failed to be installed</span>
<span class="go">Call Stack (most recent call first):</span>
<span class="go">  build-support/custom-modules/ns3-vcpkg-hunter.cmake:138 (message)</span>
<span class="go">  build-support/custom-modules/ns3-vcpkg-hunter.cmake:183 (setup_vcpkg)</span>
<span class="go">  build-support/macros-and-definitions.cmake:743 (include)</span>
<span class="go">  CMakeLists.txt:149 (process_options)</span>
</pre></div>
</div>
<p>As we can see above, the setup failed during the eigen3 setup due to a missing dependency.
In this case, pkg-config. We can install it using the system package manager and then
resume the ns-3 configuration.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">/ns-3-dev$ apt install -y pkg-config</span>
<span class="go">/ns-3-dev$ ./ns3 configure -- -DNS3_VCPKG=ON</span>
<span class="go">...</span>
<span class="go">-- vcpkg: folder already exists, skipping git download</span>
<span class="go">-- vcpkg: already bootstrapped</span>
<span class="go">-- vcpkg: detected a vcpkg manifest file: /ns-3-dev/vcpkg.json</span>
<span class="go">Detecting compiler hash for triplet x64-linux...</span>
<span class="go">The following packages will be built and installed:</span>
<span class="go">    eigen3:x64-linux -&gt; 3.4.0#2</span>
<span class="go">    gsl:x64-linux -&gt; 2.7.1#3</span>
<span class="go">  * libiconv:x64-linux -&gt; 1.17#1</span>
<span class="go">  * liblzma:x64-linux -&gt; 5.4.3#1</span>
<span class="go">    libxml2[core,iconv,lzma,zlib]:x64-linux -&gt; 2.10.3#1</span>
<span class="go">    sqlite3[core,json1]:x64-linux -&gt; 3.42.0#1</span>
<span class="go">  * zlib:x64-linux -&gt; 1.2.13</span>
<span class="go">Additional packages (*) will be modified to complete this operation.</span>
<span class="go">Restored 0 package(s) from /root/.cache/vcpkg/archives in 97.6 us. Use --debug to see more details.</span>
<span class="go">Installing 1/7 eigen3:x64-linux...</span>
<span class="go">Building eigen3:x64-linux...</span>
<span class="go">-- Using cached libeigen-eigen-3.4.0.tar.gz.</span>
<span class="go">-- Cleaning sources at /ns-3-dev/vcpkg/buildtrees/eigen3/src/3.4.0-74a8d62212.clean. Use --editable to skip cleaning for the packages you specify.</span>
<span class="go">-- Extracting source /ns-3-dev/vcpkg/downloads/libeigen-eigen-3.4.0.tar.gz</span>
<span class="go">-- Applying patch remove_configure_checks.patch</span>
<span class="go">-- Applying patch fix-vectorized-reductions-half.patch</span>
<span class="go">-- Using source at /ns-3-dev/vcpkg/buildtrees/eigen3/src/3.4.0-74a8d62212.clean</span>
<span class="go">-- Configuring x64-linux</span>
<span class="go">-- Building x64-linux-dbg</span>
<span class="go">-- Building x64-linux-rel</span>
<span class="go">-- Fixing pkgconfig file: /ns-3-dev/vcpkg/packages/eigen3_x64-linux/lib/pkgconfig/eigen3.pc</span>
<span class="go">-- Fixing pkgconfig file: /ns-3-dev/vcpkg/packages/eigen3_x64-linux/debug/lib/pkgconfig/eigen3.pc</span>
<span class="go">-- Installing: /ns-3-dev/vcpkg/packages/eigen3_x64-linux/share/eigen3/copyright</span>
<span class="go">-- Performing post-build validation</span>
<span class="go">Stored binaries in 1 destinations in 1.7 s.</span>
<span class="go">Elapsed time to handle eigen3:x64-linux: 28 s</span>
<span class="go">Installing 2/7 gsl:x64-linux...</span>
<span class="go">...</span>
<span class="go">Installing 7/7 sqlite3:x64-linux...</span>
<span class="go">Building sqlite3[core,json1]:x64-linux...</span>
<span class="go">-- Downloading https://sqlite.org/2023/sqlite-amalgamation-3420000.zip -&gt; sqlite-amalgamation-3420000.zip...</span>
<span class="go">-- Extracting source /ns-3-dev/vcpkg/downloads/sqlite-amalgamation-3420000.zip</span>
<span class="go">-- Applying patch fix-arm-uwp.patch</span>
<span class="go">-- Applying patch add-config-include.patch</span>
<span class="go">-- Using source at /ns-3-dev/vcpkg/buildtrees/sqlite3/src/on-3420000-e624a7f335.clean</span>
<span class="go">-- Configuring x64-linux</span>
<span class="go">-- Building x64-linux-dbg</span>
<span class="go">-- Building x64-linux-rel</span>
<span class="go">-- Fixing pkgconfig file: /ns-3-dev/vcpkg/packages/sqlite3_x64-linux/lib/pkgconfig/sqlite3.pc</span>
<span class="go">-- Fixing pkgconfig file: /ns-3-dev/vcpkg/packages/sqlite3_x64-linux/debug/lib/pkgconfig/sqlite3.pc</span>
<span class="go">-- Installing: /ns-3-dev/vcpkg/packages/sqlite3_x64-linux/share/sqlite3/usage</span>
<span class="go">-- Performing post-build validation</span>
<span class="go">Stored binaries in 1 destinations in 430 ms.</span>
<span class="go">Elapsed time to handle sqlite3:x64-linux: 42 s</span>
<span class="go">Total install time: 2.5 min</span>
<span class="go">The package boost is compatible with built-in CMake targets:</span>

<span class="go">    find_package(Boost REQUIRED [COMPONENTS &lt;libs&gt;...])</span>
<span class="go">    target_link_libraries(main PRIVATE Boost::boost Boost::&lt;lib1&gt; Boost::&lt;lib2&gt; ...)</span>

<span class="go">eigen3 provides CMake targets:</span>

<span class="gp">    # </span>this<span class="w"> </span>is<span class="w"> </span>heuristically<span class="w"> </span>generated,<span class="w"> </span>and<span class="w"> </span>may<span class="w"> </span>not<span class="w"> </span>be<span class="w"> </span>correct
<span class="go">    find_package(Eigen3 CONFIG REQUIRED)</span>
<span class="go">    target_link_libraries(main PRIVATE Eigen3::Eigen)</span>

<span class="go">The package gsl is compatible with built-in CMake targets:</span>

<span class="go">    find_package(GSL REQUIRED)</span>
<span class="go">    target_link_libraries(main PRIVATE GSL::gsl GSL::gslcblas)</span>

<span class="go">The package libxml2 is compatible with built-in CMake targets:</span>

<span class="go">    find_package(LibXml2 REQUIRED)</span>
<span class="go">    target_link_libraries(main PRIVATE LibXml2::LibXml2)</span>

<span class="go">sqlite3 provides pkgconfig bindings.</span>
<span class="go">sqlite3 provides CMake targets:</span>

<span class="go">    find_package(unofficial-sqlite3 CONFIG REQUIRED)</span>
<span class="go">    target_link_libraries(main PRIVATE unofficial::sqlite3::sqlite3)</span>

<span class="go">-- vcpkg: packages defined in the manifest were installed</span>
<span class="go">-- find_external_library: SQLite3 was found.</span>
<span class="go">...</span>
<span class="go">-- LibXML2 was found.</span>
<span class="go">...</span>
<span class="go">-- Found Boost: /ns-3-dev/vcpkg/installed/x64-linux/include (found version &quot;1.82.0&quot;)</span>
<span class="go">...</span>
<span class="go">-- Looking for include files boost/units/quantity.hpp, boost/units/systems/si.hpp</span>
<span class="go">-- Looking for include files boost/units/quantity.hpp, boost/units/systems/si.hpp - found</span>
<span class="go">-- Boost Units have been found.</span>
<span class="go">...</span>
<span class="go">-- ---- Summary of ns-3 settings:</span>
<span class="go">Build profile                 : default</span>
<span class="go">Build directory               : /ns-3-dev/build</span>
<span class="go">Build with runtime asserts    : ON</span>
<span class="go">...</span>
<span class="go">GNU Scientific Library (GSL)  : ON</span>
<span class="go">...</span>
<span class="go">LibXml2 support               : ON</span>
<span class="go">...</span>
<span class="go">SQLite support                : ON</span>
<span class="go">Eigen3 support                : ON</span>
<span class="go">...</span>
</pre></div>
</div>
<p>From the above, we can see that the headers and libraries installed by the packages
were correctly found by CMake and the optional features were successfully enabled.</p>
<p>Note: not every vcpkg package (also known as a port) obeys
the same pattern for usage. The user of the package needs
to look into the usage file of said port for instructions.
In the case of Armadillo, the corresponding file can be found
in <a class="reference external" href="https://github.com/microsoft/vcpkg/blob/master/ports/armadillo/usage">Armadillo’s port on vcpkg</a>.</p>
<p>Vcpkg is installed to a <code class="docutils literal notranslate"><span class="pre">vcpkg</span></code> directory inside the ns-3 main directory (e.g. <code class="docutils literal notranslate"><span class="pre">ns-3-dev</span></code>).
Packages installed via vcpkg are installed to <code class="docutils literal notranslate"><span class="pre">ns-3-dev/vcpkg/installed/${VCPKG_TRIPLET}</span></code>,
which is automatically added to the <code class="docutils literal notranslate"><span class="pre">CMAKE_PREFIX_PATH</span></code>, making headers, libraries, and
pkg-config and CMake packages discoverable via <code class="docutils literal notranslate"><span class="pre">find_file</span></code>, <code class="docutils literal notranslate"><span class="pre">find_library</span></code>, <code class="docutils literal notranslate"><span class="pre">find_package</span></code>
and <code class="docutils literal notranslate"><span class="pre">pkg_check_modules</span></code>.</p>
</section>
<section id="id7">
<h6><span class="section-number">4.3.7.5.2. </span>CPM<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h6>
<p><a class="reference external" href="https://github.com/cpm-cmake/CPM.cmake">CPM</a> is a package manager made for CMake projects consuming CMake projects.
Some CMake projects however, create files during the installation step, which
is not supported by CPM, which treats the package as a CMake subproject that
we can then depend upon. CPM may require dependencies such as <code class="docutils literal notranslate"><span class="pre">git</span></code> and <code class="docutils literal notranslate"><span class="pre">tar</span></code>,
depending on the package sources used.</p>
<p>Let’s see an example trying to find the Armadillo library via CMake.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Check this is not a fluke</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span>
<span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Armadillo was found? ${ARMADILLO_FOUND}&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Reconfigure ns-3 to check if Armadillo is available.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ ./ns3 configure</span>
<span class="go">...</span>
<span class="go">-- Could NOT find Armadillo (missing: ARMADILLO_INCLUDE_DIR)</span>
<span class="go">-- Armadillo was found? FALSE</span>
</pre></div>
</div>
<p>As you can see, no Armadillo found.
We can now use CPM to install it, using the CMake
function <code class="docutils literal notranslate"><span class="pre">CPMAddPackage(package_info)</span></code>.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Install Armadillo and search for it again</span>
<span class="nb">CPMAddPackage</span><span class="p">(</span>
<span class="w">    </span><span class="s">NAME</span><span class="w"> </span><span class="s">ARMADILLO</span>
<span class="w">    </span><span class="s">GIT_TAG</span><span class="w"> </span><span class="s">6cada351248c9a967b137b9fcb3d160dad7c709b</span>
<span class="w">    </span><span class="s">GIT_REPOSITORY</span><span class="w"> </span><span class="s">https://gitlab.com/conradsnicta/armadillo-code.git</span>
<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span><span class="w"> </span><span class="c"># Loads CPM installation of Armadillo</span>
<span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Armadillo was found? ${ARMADILLO_FOUND}&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Sadly, we will need to reconfigure ns-3 from the scratch,
since CMake <code class="docutils literal notranslate"><span class="pre">find_package</span></code> caches are problematic.
Installing the packages can take a while, and it can look like it hanged.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ ./ns3 clean</span>
<span class="go">~$ ./ns3 configure -- -DNS3_CPM=ON</span>
<span class="go">...</span>
<span class="go">-- CPM: Adding package ARMADILLO@0 (6cada351248c9a967b137b9fcb3d160dad7c709b)</span>
<span class="go">-- *** set cmake policy CMP0025 to NEW</span>
<span class="go">-- CMAKE_CXX_STANDARD = 11</span>
<span class="go">-- Configuring Armadillo 12.6.1</span>
<span class="go">--</span>
<span class="go">-- *** WARNING: variable &#39;CMAKE_CXX_FLAGS&#39; is not empty; this may cause problems!</span>
<span class="go">--</span>
<span class="go">-- Detected Clang 6.0 or newer</span>
<span class="go">-- ARMA_USE_EXTERN_RNG = true</span>
<span class="go">-- CMAKE_SYSTEM_NAME          = Linux</span>
<span class="go">-- CMAKE_CXX_COMPILER_ID      = Clang</span>
<span class="go">-- CMAKE_CXX_COMPILER_VERSION = 15.0.7</span>
<span class="go">-- CMAKE_COMPILER_IS_GNUCXX   =</span>
<span class="go">--</span>
<span class="go">-- *** Options:</span>
<span class="go">-- BUILD_SHARED_LIBS         = ON</span>
<span class="go">-- OPENBLAS_PROVIDES_LAPACK  = OFF</span>
<span class="go">-- ALLOW_FLEXIBLAS_LINUX     = ON</span>
<span class="go">-- ALLOW_OPENBLAS_MACOS      = OFF</span>
<span class="go">-- ALLOW_BLAS_LAPACK_MACOS   = OFF</span>
<span class="go">-- BUILD_SMOKE_TEST          = ON</span>
<span class="go">--</span>
<span class="go">-- *** Looking for external libraries</span>
<span class="go">-- Found OpenBLAS: /usr/lib/x86_64-linux-gnu/libopenblas.so</span>
<span class="go">-- Found BLAS: /usr/lib/x86_64-linux-gnu/libblas.so</span>
<span class="go">-- Found LAPACK: /usr/lib/x86_64-linux-gnu/liblapack.so</span>
<span class="go">-- FlexiBLAS_FOUND = NO</span>
<span class="go">--       MKL_FOUND = NO</span>
<span class="go">--  OpenBLAS_FOUND = YES</span>
<span class="go">--     ATLAS_FOUND = NO</span>
<span class="go">--      BLAS_FOUND = YES</span>
<span class="go">--    LAPACK_FOUND = YES</span>
<span class="go">--</span>
<span class="go">-- *** NOTE: found both OpenBLAS and BLAS; BLAS will not be used</span>
<span class="go">--</span>
<span class="go">-- *** NOTE: if OpenBLAS is known to provide LAPACK functions, recommend to</span>
<span class="go">-- *** NOTE: rerun cmake with the OPENBLAS_PROVIDES_LAPACK option enabled:</span>
<span class="go">-- *** NOTE: cmake -D OPENBLAS_PROVIDES_LAPACK=true .</span>
<span class="go">--</span>
<span class="go">-- *** If the OpenBLAS library is installed in</span>
<span class="go">-- *** /usr/local/lib or /usr/local/lib64</span>
<span class="go">-- *** make sure the run-time linker can find it.</span>
<span class="go">-- *** On Linux systems this can be done by editing /etc/ld.so.conf</span>
<span class="go">-- *** or modifying the LD_LIBRARY_PATH environment variable.</span>
<span class="go">--</span>
<span class="go">-- Found ARPACK: /usr/lib/x86_64-linux-gnu/libarpack.so</span>
<span class="go">-- ARPACK_FOUND = YES</span>
<span class="go">-- Looking for SuperLU version 5</span>
<span class="go">-- Found SuperLU: /usr/lib/x86_64-linux-gnu/libsuperlu.so</span>
<span class="go">-- SuperLU_FOUND = YES</span>
<span class="go">-- SuperLU_INCLUDE_DIR = /usr/include/superlu</span>
<span class="go">--</span>
<span class="go">-- *** Result of configuration:</span>
<span class="go">-- *** ARMA_USE_WRAPPER    = true</span>
<span class="go">-- *** ARMA_USE_LAPACK     = true</span>
<span class="go">-- *** ARMA_USE_BLAS       = true</span>
<span class="go">-- *** ARMA_USE_ATLAS      = false</span>
<span class="go">-- *** ARMA_USE_ARPACK     = true</span>
<span class="go">-- *** ARMA_USE_EXTERN_RNG = true</span>
<span class="go">-- *** ARMA_USE_SUPERLU    = true</span>
<span class="go">--</span>
<span class="go">-- *** Armadillo wrapper library will use the following libraries:</span>
<span class="go">-- *** ARMA_LIBS = /usr/lib/x86_64-linux-gnu/libopenblas.so;/usr/lib/x86_64-linux-gnu/liblapack.so;/usr/lib/x86_64-linux-gnu/libarpack.so;/usr/lib/x86_64-linux-gnu/libsuperlu.so</span>
<span class="go">--</span>
<span class="go">-- Copying /ns-3-dev/cmake-build-release/_deps/armadillo-src/include/ to /ns-3-dev/cmake-build-release/_deps/armadillo-build/tmp/include/</span>
<span class="go">-- Generating /ns-3-dev/cmake-build-release/_deps/armadillo-build/tmp/include/config.hpp</span>
<span class="go">-- CMAKE_CXX_FLAGS           =  -fsanitize=address,leak,undefined -O2</span>
<span class="go">-- CMAKE_SHARED_LINKER_FLAGS =  -Wl,--no-as-needed</span>
<span class="go">-- CMAKE_REQUIRED_INCLUDES   = /usr/include;/usr/include/superlu</span>
<span class="go">--</span>
<span class="go">-- CMAKE_INSTALL_PREFIX     = /usr</span>
<span class="go">-- CMAKE_INSTALL_LIBDIR     = lib/x86_64-linux-gnu</span>
<span class="go">-- CMAKE_INSTALL_INCLUDEDIR = include</span>
<span class="go">-- CMAKE_INSTALL_DATADIR    = share</span>
<span class="go">-- CMAKE_INSTALL_BINDIR     = bin</span>
<span class="go">-- Generating &#39;/ns-3-dev/cmake-build-release/_deps/armadillo-build/ArmadilloConfig.cmake&#39;</span>
<span class="go">-- Generating &#39;/ns-3-dev/cmake-build-release/_deps/armadillo-build/ArmadilloConfigVersion.cmake&#39;</span>
<span class="go">-- Generating &#39;/ns-3-dev/cmake-build-release/_deps/armadillo-build/InstallFiles/ArmadilloConfig.cmake&#39;</span>
<span class="go">-- Generating &#39;/ns-3-dev/cmake-build-release/_deps/armadillo-build/InstallFiles/ArmadilloConfigVersion.cmake&#39;</span>
<span class="go">-- Copying /ns-3-dev/cmake-build-release/_deps/armadillo-src/misc/ to /ns-3-dev/cmake-build-release/_deps/armadillo-build/tmp/misc/</span>
<span class="go">-- Generating &#39;/ns-3-dev/cmake-build-release/_deps/armadillo-build/tmp/misc/armadillo.pc&#39;</span>
<span class="go">-- *** configuring smoke_test</span>
<span class="go">-- Armadillo was found? TRUE</span>
<span class="go">...</span>
</pre></div>
</div>
<p>As shown above, the Armadillo library gets installed by CPM
and it can be found by CMake’s <code class="docutils literal notranslate"><span class="pre">find_package</span></code> function.
Differently from other packages found via <code class="docutils literal notranslate"><span class="pre">find_package</span></code>,
CPM creates native CMake targets from the subprojects.
In the case of Armadillo, the target is called <code class="docutils literal notranslate"><span class="pre">armadillo</span></code>,
which we can link to our targets.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Install Armadillo</span>
<span class="nb">CPMAddPackage</span><span class="p">(</span>
<span class="w">    </span><span class="s">NAME</span><span class="w"> </span><span class="s">ARMADILLO</span>
<span class="w">    </span><span class="s">GIT_TAG</span><span class="w"> </span><span class="s">6cada351248c9a967b137b9fcb3d160dad7c709b</span>
<span class="w">    </span><span class="s">GIT_REPOSITORY</span><span class="w"> </span><span class="s">https://gitlab.com/conradsnicta/armadillo-code.git</span>
<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Armadillo</span><span class="p">)</span><span class="w"> </span><span class="c"># Loads CPM installation of Armadillo</span>
<span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Armadillo was found? ${ARMADILLO_FOUND}&quot;</span><span class="p">)</span>

<span class="c"># CPM is kind of jenky. It could get the ARMADILLO_INCLUDE_DIRS</span>
<span class="c"># from the ArmadilloConfig.cmake file in ${CMAKE_BINARY_DIR}/_deps/armadillo-build,</span>
<span class="c"># but it doesn&#39;t... So add its include directories directly from the source directory</span>
<span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="o">}</span><span class="s">/_deps/armadillo-src/include</span><span class="p">)</span>

<span class="c"># Link to Armadillo and</span>
<span class="nb">link_libraries</span><span class="p">(</span><span class="s">armadillo</span><span class="p">)</span>
</pre></div>
</div>
<p>Note: using CPM can be challenging. Users are recommended
to look at <a class="reference external" href="https://github.com/cpm-cmake/CPM.cmake/wiki/More-Snippets">CPM’s examples</a>.</p>
<p>For example, the libraries of installed packages will be placed by default in
the <code class="docutils literal notranslate"><span class="pre">ns-3-dev/build/lib</span></code> directory. On the other hand, header placement depends
on how the CMake project was setup.</p>
<p>If the package CMakeLists.txt was made to build in-source, headers will be
along the source files, which will be placed in
<code class="docutils literal notranslate"><span class="pre">${PROJECT_BINARY_DIR}/_deps/packageName-src</span></code>. When configured with the
ns3 script, <code class="docutils literal notranslate"><span class="pre">PROJECT_BINARY_DIR</span> <span class="pre">corresponds</span></code> to <code class="docutils literal notranslate"><span class="pre">ns-3-dev/cmake-cache</span></code>.</p>
<p>If the package CMakeLists.txt copies the headers to an output directory
(like ns-3 does), it will be placed in
<code class="docutils literal notranslate"><span class="pre">${PROJECT_BINARY_DIR}/_deps/packageName-build</span></code>,
possibly in an <code class="docutils literal notranslate"><span class="pre">include</span></code> subdirectory.</p>
<p>In case it was configured to copy the headers to <code class="docutils literal notranslate"><span class="pre">${CMAKE_BINARY_DIR}/include</span></code>,
the headers will land on <code class="docutils literal notranslate"><span class="pre">${PROJECT_BINARY_DIR}/include</span></code> of the most top-level
project. In our case, the top-level project is the NS3 project.</p>
<p>Since the packages get installed into the ns-3 cache directory
(<code class="docutils literal notranslate"><span class="pre">PROJECT_BINARY_DIR</span></code>), using <code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">clean</span></code> will delete them,
requiring them to be rebuilt.</p>
</section>
</section>
<section id="inclusion-of-options">
<h5><span class="section-number">4.3.7.6. </span>Inclusion of options<a class="headerlink" href="#inclusion-of-options" title="Link to this heading">¶</a></h5>
<p>There are two ways of managing module options: option switches or cached variables.
Both are present in the main CMakeLists.txt in the ns-3-dev directory and the
build-support/macros-and-definitions.cmake file.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Here are examples of ON and OFF switches</span>
<span class="c"># option(</span>
<span class="c">#        NS3_SWITCH # option switch prefixed with NS3\_</span>
<span class="c">#        &quot;followed by the description of what the option does&quot;</span>
<span class="c">#        ON # and the default value for that option</span>
<span class="c">#        )</span>
<span class="nb">option</span><span class="p">(</span><span class="s">NS3_EXAMPLES</span><span class="w"> </span><span class="s2">&quot;Enable examples to be built&quot;</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>
<span class="nb">option</span><span class="p">(</span><span class="s">NS3_TESTS</span><span class="w"> </span><span class="s2">&quot;Enable tests to be built&quot;</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>

<span class="c"># Now here is how to let the user indicate a path</span>
<span class="c"># set( # declares a value</span>
<span class="c">#     NS3_PREFIXED_VALUE # stores the option value</span>
<span class="c">#     &quot;&quot; # default value is empty in this case</span>
<span class="c">#     CACHE # stores that NS3_PREFIXED_VALUE in the CMakeCache.txt file</span>
<span class="c">#     STRING # type of the cached variable</span>
<span class="c">#     &quot;description of what this value is used for&quot;</span>
<span class="c">#     )</span>
<span class="nb">set</span><span class="p">(</span><span class="s">NS3_OUTPUT_DIRECTORY</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="s">CACHE</span><span class="w"> </span><span class="s">PATH</span><span class="w"> </span><span class="s2">&quot;Directory to store built artifacts&quot;</span><span class="p">)</span>

<span class="c"># The last case are options that can only assume predefined values</span>
<span class="c"># First we cache the default option</span>
<span class="nb">set</span><span class="p">(</span><span class="s">NS3_INT64X64</span><span class="w"> </span><span class="s2">&quot;INT128&quot;</span><span class="w"> </span><span class="s">CACHE</span><span class="w"> </span><span class="s">STRING</span><span class="w"> </span><span class="s2">&quot;Int64x64 implementation&quot;</span><span class="p">)</span>

<span class="c"># Then set a cache property for the variable indicating it can assume</span>
<span class="c"># specific values</span>
<span class="nb">set_property</span><span class="p">(</span><span class="s">CACHE</span><span class="w"> </span><span class="s">NS3_INT64X64</span><span class="w"> </span><span class="s">PROPERTY</span><span class="w"> </span><span class="s">STRINGS</span><span class="w"> </span><span class="s">INT128</span><span class="w"> </span><span class="s">CAIRO</span><span class="w"> </span><span class="s">DOUBLE</span><span class="p">)</span>
</pre></div>
</div>
<p>More details about these commands can be found in the following links:
<a class="reference external" href="https://cmake.org/cmake/help/latest/command/option.html">option</a>, <a class="reference external" href="https://cmake.org/cmake/help/latest/command/set.html">set</a>, <a class="reference external" href="https://cmake.org/cmake/help/latest/command/set_property.html">set_property</a>.</p>
</section>
<section id="changes-in-cmake-macros-and-functions">
<h5><span class="section-number">4.3.7.7. </span>Changes in CMake macros and functions<a class="headerlink" href="#changes-in-cmake-macros-and-functions" title="Link to this heading">¶</a></h5>
<p>In order for CMake to feel more familiar to Waf users, a few macros and functions
were created.</p>
<p>The most frequently used macros them can be found in
<code class="docutils literal notranslate"><span class="pre">build-support/macros-and-definitions.cmake</span></code>. This file includes build type checking,
compiler family and version checking, enabling and disabling features based
on user options, checking for dependencies of enabled features,
pre-compiling headers, filtering enabled/disabled modules and dependencies,
and more.</p>
<section id="executable-macros">
<h6><span class="section-number">4.3.7.7.1. </span>Executable macros<a class="headerlink" href="#executable-macros" title="Link to this heading">¶</a></h6>
<p>Creating an executable in CMake requires a few different macro calls.
Some of these calls are related to setting the target and built executable name,
indicating which libraries that should be linked to the executable,
where the executable should be placed after being built and installed.</p>
<p>Note that if you are trying to add a new example to your module, you should
look at the <a class="reference internal" href="#build-lib-example">build_lib_example</a> macro section.</p>
<p>If you are trying to add a new example to <code class="docutils literal notranslate"><span class="pre">~/ns-3-dev/examples</span></code>, you should
look at the <a class="reference internal" href="#build-example">build_example</a> macro section.</p>
<p>While both of the previously mentioned macros are meant to be used for examples,
in some cases additional utilities are required. Those utilities can be helpers,
such as the <code class="docutils literal notranslate"><span class="pre">raw-sock-creator</span></code> in the <code class="docutils literal notranslate"><span class="pre">fd-net-device</span></code> module, or benchmark
tools in the <code class="docutils literal notranslate"><span class="pre">~/ns-3-dev/utils</span></code> directory. In those cases, the <a class="reference internal" href="#build-exec">build_exec</a>
macro is recommended instead of direct CMake calls.</p>
<section id="executable-macros-build-exec">
<span id="build-exec"></span><h6 aria-level="7"><span class="section-number">4.3.7.7.1.1. </span>Executable macros: build_exec<a class="headerlink" href="#executable-macros-build-exec" title="Link to this heading">¶</a></h6>
<p>The <code class="docutils literal notranslate"><span class="pre">build_exec</span></code> macro bundles a series of direct CMake calls into a single macro.
The example below shows the creation of an executable named <code class="docutils literal notranslate"><span class="pre">example</span></code>, that will
later receive a version prefix (e.g. <code class="docutils literal notranslate"><span class="pre">ns3.37-</span></code>) and a build type suffix
(e.g. <code class="docutils literal notranslate"><span class="pre">-debug</span></code>), resulting in an executable file named <code class="docutils literal notranslate"><span class="pre">ns3.37-example-debug</span></code>.</p>
<p>The list of source and header files can be passed in the <code class="docutils literal notranslate"><span class="pre">SOURCE_FILES</span></code> and
<code class="docutils literal notranslate"><span class="pre">HEADER_FILES</span></code> arguments, followed by the <code class="docutils literal notranslate"><span class="pre">LIBRARIES_TO_LINK</span></code> that will be linked
to the executable.</p>
<p>That executable will be saved by default to the <code class="docutils literal notranslate"><span class="pre">CMAKE_RUNTIME_OUTPUT_DIRECTORY</span></code>
(e.g. /ns-3-dev/build/bin). To change its destination, set <code class="docutils literal notranslate"><span class="pre">EXECUTABLE_DIRECTORY_PATH</span></code>
to the desired path. The path is relative to the <code class="docutils literal notranslate"><span class="pre">CMAKE_OUTPUT_DIRECTORY</span></code>
(e.g. /ns-3-dev/build).</p>
<p>In case this executable should be installed, set <code class="docutils literal notranslate"><span class="pre">INSTALL_DIRECTORY_PATH</span></code> to the
desired destination. In case this value is empty, the executable will not be installed.
The path is relative to the <code class="docutils literal notranslate"><span class="pre">CMAKE_INSTALL_PREFIX</span></code> (e.g. /usr).</p>
<p>To set custom compiler defines for that specific executable, defines can be passed
to the <code class="docutils literal notranslate"><span class="pre">DEFINITIONS</span></code> argument.</p>
<p>Add the <code class="docutils literal notranslate"><span class="pre">STANDALONE</span></code> option to prevent linking the <em>ns-3</em> static library
(<code class="docutils literal notranslate"><span class="pre">NS3_STATIC</span></code>) and single shared library (<code class="docutils literal notranslate"><span class="pre">NS3_MONOLIB</span></code>) to the executable.
This may be necessary in case the executable redefine symbols which are part
of the <em>ns-3</em> library. This is the case for the fd-net-device creators and the tap-creator,
which include the source file <code class="docutils literal notranslate"><span class="pre">encode-decode.cc</span></code>, which is also part of fd-net-device module
and tap-bridge module, respectively.</p>
<p>Finally, to ignore precompiled headers, include <code class="docutils literal notranslate"><span class="pre">IGNORE_PCH</span></code> to the list of parameters.
You can find more information about <code class="docutils literal notranslate"><span class="pre">IGNORE_PCH</span></code> at the <a class="reference internal" href="#pch-side-effects">PCH side-effects</a> section.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_exec</span><span class="p">(</span>
<span class="w">  </span><span class="c"># necessary</span>
<span class="w">  </span><span class="s">EXECNAME</span><span class="w"> </span><span class="s">example</span><span class="w">                       </span><span class="c"># executable name = example (plus version prefix and build type suffix)</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">example.cc</span><span class="w"> </span><span class="s">example-complement.cc</span>
<span class="w">  </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="s">example.h</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libcore</span><span class="o">}</span><span class="w">           </span><span class="c"># links to core</span>
<span class="w">  </span><span class="s">EXECUTABLE_DIRECTORY_PATH</span><span class="w"> </span><span class="s">scratch</span><span class="w">          </span><span class="c"># build/scratch</span>
<span class="w">  </span><span class="c"># optional</span>
<span class="w">  </span><span class="s">EXECNAME_PREFIX</span><span class="w"> </span><span class="s">scratch_subdir_prefix_</span><span class="w"> </span><span class="c"># target name = scratch_subdir_prefix_example</span>
<span class="w">  </span><span class="s">INSTALL_DIRECTORY_PATH</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_INSTALL_BIN</span><span class="o">}</span><span class="s">/</span><span class="w">   </span><span class="c"># e.g. /usr/bin/ns3.37-scratch_subdir_prefix_example-debug</span>
<span class="w">  </span><span class="s">DEFINITIONS</span><span class="w"> </span><span class="s">-DHAVE_FEATURE=1</span><span class="w">           </span><span class="c"># defines for this specific target</span>
<span class="w">  </span><span class="s">[STANDALONE]</span><span class="w">                           </span><span class="c"># set in case you don&#39;t want the executable to be linked to ns3-static/ns3-monolib</span>
<span class="w">  </span><span class="s">IGNORE_PCH</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The same executable can be built by directly calling the following CMake macros:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="s">target_prefix</span><span class="w"> </span><span class="s">scratch_subdir_prefix_</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">target_name</span><span class="w"> </span><span class="s">example</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">output_directory</span><span class="w"> </span><span class="s">scratch</span><span class="p">)</span>

<span class="c"># Creates a target named &quot;example&quot; (target_name) prefixed with &quot;scratch_subdir_prefix_&quot; (target_prefix)</span>
<span class="c"># e.g. scratch_subdir_prefix_example</span>
<span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}</span><span class="w"> </span><span class="s">example.cc</span><span class="w"> </span><span class="s">example-complement.cc</span><span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="o">${</span><span class="nv">libcore</span><span class="o">}</span><span class="p">)</span>

<span class="c"># Create a variable with the target name prefixed with</span>
<span class="c"># the version and suffixed with the build profile suffix</span>
<span class="c"># e.g. ns3.37-scratch_subdir_prefix_example-debug</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3-exec-outputname</span><span class="w"> </span><span class="s">ns</span><span class="o">${</span><span class="nv">NS3_VER</span><span class="o">}</span><span class="s">-</span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}${</span><span class="nv">build_profile_suffix</span><span class="o">}</span><span class="p">)</span>

<span class="c"># Append the binary name to the executables list later written to the lock file,</span>
<span class="c"># which is consumed by the ns3 script and test.py</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3-execs</span><span class="w"> </span><span class="s2">&quot;${output_directory}${ns3-exec-outputname};${ns3-execs}&quot;</span>
<span class="w">   </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span><span class="w"> </span><span class="s2">&quot;list of c++ executables&quot;</span>
<span class="p">)</span>
<span class="c"># Modify the target properties to change the binary name to ns3-exec-outputname contents</span>
<span class="c"># and modify its output directory (e.g. scratch). The output directory is relative to the build directory.</span>
<span class="nb">set_target_properties</span><span class="p">(</span>
<span class="w">  </span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}</span>
<span class="w">  </span><span class="s">PROPERTIES</span><span class="w"> </span><span class="s">RUNTIME_OUTPUT_DIRECTORY</span><span class="w"> </span><span class="o">${</span><span class="nv">output_directory</span><span class="o">}</span>
<span class="w">             </span><span class="s">RUNTIME_OUTPUT_NAME</span><span class="w"> </span><span class="o">${</span><span class="nv">ns3-exec-outputname</span><span class="o">}</span>
<span class="p">)</span>
<span class="c"># Create a dependency between the target and the all-test-targets</span>
<span class="c"># (used by ctest, coverage and doxygen targets)</span>
<span class="nb">add_dependencies</span><span class="p">(</span><span class="s">all-test-targets</span><span class="w"> </span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}</span><span class="p">)</span>

<span class="c"># Create a dependency between the target and the timeTraceReport</span>
<span class="c"># (used by Clang TimeTrace to collect compilation statistics)</span>
<span class="nb">add_dependencies</span><span class="p">(</span><span class="s">timeTraceReport</span><span class="w"> </span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}</span><span class="p">)</span><span class="w"> </span><span class="c"># target used to track compilation time</span>

<span class="c"># Set target-specific compile definitions</span>
<span class="nb">target_compile_definitions</span><span class="p">(</span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="s">definitions</span><span class="p">)</span>

<span class="c"># Check whether the target should reuse or not the precompiled headers</span>
<span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">IGNORE_PCH</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">target_precompile_headers</span><span class="p">(</span>
<span class="w">          </span><span class="o">${</span><span class="nv">target_prefix</span><span class="o">}${</span><span class="nv">target_name</span><span class="o">}</span><span class="w"> </span><span class="s">REUSE_FROM</span><span class="w"> </span><span class="s">stdlib_pch_exec</span>
<span class="w">       </span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="executable-macros-build-example">
<span id="build-example"></span><h6 aria-level="7"><span class="section-number">4.3.7.7.1.2. </span>Executable macros: build_example<a class="headerlink" href="#executable-macros-build-example" title="Link to this heading">¶</a></h6>
<p>The <code class="docutils literal notranslate"><span class="pre">build_example</span></code> macro sets some of <code class="docutils literal notranslate"><span class="pre">build_exec</span></code>’s arguments based on the current
example directory (output directory) and adds the optional visualizer module as a dependency
in case it is enabled. It also performs dependency checking on the libraries passed.</p>
<p>In case one of the dependencies listed is not found, the example target will not be created.
If you are trying to add an example or a dependency to an existing example and it is not
listed by <code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">show</span> <span class="pre">targets</span></code> or your IDE, check if all its dependencies were found.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">macro</span><span class="p">(</span><span class="s">build_example</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">options</span><span class="w"> </span><span class="s">IGNORE_PCH</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">oneValueArgs</span><span class="w"> </span><span class="s">NAME</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">multiValueArgs</span><span class="w"> </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="s">LIBRARIES_TO_LINK</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Parse arguments</span>
<span class="w">  </span><span class="nb">cmake_parse_arguments</span><span class="p">(</span>
<span class="w">    </span><span class="s2">&quot;EXAMPLE&quot;</span><span class="w"> </span><span class="s2">&quot;${options}&quot;</span><span class="w"> </span><span class="s2">&quot;${oneValueArgs}&quot;</span><span class="w"> </span><span class="s2">&quot;${multiValueArgs}&quot;</span><span class="w"> </span><span class="o">${</span><span class="nv">ARGN</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># Filter examples out if they don&#39;t contain one of the filtered in modules</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NS3_FILTER_MODULE_EXAMPLES_AND_TESTS</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>
<span class="w">    </span><span class="nb">foreach</span><span class="p">(</span><span class="s">filtered_module</span><span class="w"> </span><span class="s">NS3_FILTER_MODULE_EXAMPLES_AND_TESTS</span><span class="p">)</span>
<span class="w">      </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">filtered_module</span><span class="o">}</span><span class="w"> </span><span class="s">IN_LIST</span><span class="w"> </span><span class="s">EXAMPLE_LIBRARIES_TO_LINK</span><span class="p">)</span>
<span class="w">        </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>
<span class="w">      </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">    </span><span class="nb">endforeach</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="c"># Check if any of the LIBRARIES_TO_LINK is missing to prevent configuration errors</span>
<span class="w">  </span><span class="nb">check_for_missing_libraries</span><span class="p">(</span>
<span class="w">    </span><span class="s">missing_dependencies</span><span class="w"> </span><span class="s2">&quot;${EXAMPLE_LIBRARIES_TO_LINK}&quot;</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="nb">if</span><span class="p">((</span><span class="s">NOT</span><span class="w"> </span><span class="s">missing_dependencies</span><span class="p">)</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="o">${</span><span class="nv">filtered_in</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="c"># Convert boolean into text to forward argument</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">EXAMPLE_IGNORE_PCH</span><span class="o">}</span><span class="p">)</span>
<span class="w">      </span><span class="nb">set</span><span class="p">(</span><span class="s">IGNORE_PCH</span><span class="w"> </span><span class="s">IGNORE_PCH</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">    </span><span class="c"># Create example library with sources and headers</span>
<span class="w">    </span><span class="c"># cmake-format: off</span>
<span class="w">    </span><span class="nb">build_exec</span><span class="p">(</span>
<span class="w">      </span><span class="s">EXECNAME</span><span class="w"> </span><span class="o">${</span><span class="nv">EXAMPLE_NAME</span><span class="o">}</span>
<span class="w">      </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="o">${</span><span class="nv">EXAMPLE_SOURCE_FILES</span><span class="o">}</span>
<span class="w">      </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="o">${</span><span class="nv">EXAMPLE_HEADER_FILES</span><span class="o">}</span>
<span class="w">      </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">EXAMPLE_LIBRARIES_TO_LINK</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">optional_visualizer_lib</span><span class="o">}</span>
<span class="w">      </span><span class="s">EXECUTABLE_DIRECTORY_PATH</span>
<span class="w">        </span><span class="o">${</span><span class="nv">CMAKE_RUNTIME_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/examples/</span><span class="o">${</span><span class="nv">examplefolder</span><span class="o">}</span><span class="s">/</span>
<span class="w">      </span><span class="o">${</span><span class="nv">IGNORE_PCH</span><span class="o">}</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="c"># cmake-format: on</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endmacro</span><span class="p">()</span>
</pre></div>
</div>
<p>An example on how it is used can be found in <code class="docutils literal notranslate"><span class="pre">~/ns-3-dev/examples/tutorial/CMakeLists.txt</span></code>:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_example</span><span class="p">(</span>
<span class="w">  </span><span class="s">NAME</span><span class="w"> </span><span class="s">first</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">first.cc</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libcore</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libpoint-to-point</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libapplications</span><span class="o">}</span>
<span class="w">    </span><span class="c"># If visualizer is available, the macro will add the module to this list automatically</span>
<span class="w">  </span><span class="c"># build_exec&#39;s EXECUTABLE_DIRECTORY_PATH will be set to build/examples/tutorial/</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="module-macros">
<h6><span class="section-number">4.3.7.7.2. </span>Module macros<a class="headerlink" href="#module-macros" title="Link to this heading">¶</a></h6>
<p>Module macros are located in <code class="docutils literal notranslate"><span class="pre">build-support/custom-modules/ns3-module-macros.cmake</span></code>.
This file contains macros defining a library (<code class="docutils literal notranslate"><span class="pre">build_lib</span></code>), the associated test library,
examples (<code class="docutils literal notranslate"><span class="pre">build_lib_example</span></code>) and more. It also contains the macro that builds the
module header (<code class="docutils literal notranslate"><span class="pre">write_module_header</span></code>) that includes all headers from the module
for user scripts.</p>
<p>These macros are responsible for easing the porting of modules from Waf to CMake.</p>
<section id="module-macros-build-lib">
<span id="build-lib"></span><h6 aria-level="7"><span class="section-number">4.3.7.7.2.1. </span>Module macros: build_lib<a class="headerlink" href="#module-macros-build-lib" title="Link to this heading">¶</a></h6>
<p>As <code class="docutils literal notranslate"><span class="pre">build_lib</span></code> is the most important of the macros, we detail what it does here,
block by block.</p>
<p>The first block declares the arguments received by the macro (in CMake, the
only difference is that a function has its own scope). Notice that there are
different types of arguments. Options that can only be set to ON/OFF.
Options are <code class="docutils literal notranslate"><span class="pre">OFF</span></code> by default, and are set to <code class="docutils literal notranslate"><span class="pre">ON</span></code> if the option name is added to
the arguments list (e.g. <code class="docutils literal notranslate"><span class="pre">build_lib(...</span> <span class="pre">IGNORE_PCH)</span></code>).</p>
<p>Note: You can find more information about <code class="docutils literal notranslate"><span class="pre">IGNORE_PCH</span></code> at the <a class="reference internal" href="#pch-side-effects">PCH side-effects</a> section.</p>
<p>One value arguments that receive a single value
(usually a string) and in this case used to receive the module name (<code class="docutils literal notranslate"><span class="pre">LIBNAME</span></code>).</p>
<p>Multiple value arguments receive a list of values, which we use to parse lists
of source (for the module itself and for the module tests) and
header files, plus libraries that should be linked and module features.</p>
<p>The call to <code class="docutils literal notranslate"><span class="pre">cmake_parse_arguments</span></code> will parse <code class="docutils literal notranslate"><span class="pre">${ARGN}</span></code> into these values.
The variables containing the parsing results will be prefixed with <code class="docutils literal notranslate"><span class="pre">BLIB_</span></code>
(e.g. <code class="docutils literal notranslate"><span class="pre">LIBNAME</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">BLIB_LIBNAME</span></code>).</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Argument parsing</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">options</span><span class="w"> </span><span class="s">IGNORE_PCH</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">oneValueArgs</span><span class="w"> </span><span class="s">LIBNAME</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">multiValueArgs</span><span class="w"> </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="s">TEST_SOURCES</span>
<span class="w">                    </span><span class="s">DEPRECATED_HEADER_FILES</span><span class="w"> </span><span class="s">MODULE_ENABLED_FEATURES</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nb">cmake_parse_arguments</span><span class="p">(</span>
<span class="w">    </span><span class="s2">&quot;BLIB&quot;</span><span class="w"> </span><span class="s2">&quot;${options}&quot;</span><span class="w"> </span><span class="s2">&quot;${oneValueArgs}&quot;</span><span class="w"> </span><span class="s2">&quot;${multiValueArgs}&quot;</span><span class="w"> </span><span class="o">${</span><span class="nv">ARGN</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>In the following block, we add modules in the src folder to a list
and modules in the contrib folder to a different list.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="c"># Get path src/module or contrib/module</span>
<span class="w">  </span><span class="nb">string</span><span class="p">(</span><span class="s">REPLACE</span><span class="w"> </span><span class="s2">&quot;${PROJECT_SOURCE_DIR}/&quot;</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="s">FOLDER</span>
<span class="w">                </span><span class="s2">&quot;${CMAKE_CURRENT_SOURCE_DIR}&quot;</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># Add library to a global list of libraries</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s2">&quot;${FOLDER}&quot;</span><span class="w"> </span><span class="s">MATCHES</span><span class="w"> </span><span class="s2">&quot;src&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">ns3-libs</span><span class="w"> </span><span class="s2">&quot;${lib${BLIB_LIBNAME}};${ns3-libs}&quot;</span>
<span class="w">        </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span><span class="w"> </span><span class="s2">&quot;list of processed upstream modules&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">ns3-contrib-libs</span><span class="w"> </span><span class="s2">&quot;${lib${BLIB_LIBNAME}};${ns3-contrib-libs}&quot;</span>
<span class="w">        </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span><span class="w"> </span><span class="s2">&quot;list of processed contrib modules&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>In the following block, we check if we are working with Xcode, which does
not handle correctly CMake object libraries (.o files).</p>
<p>In other platforms,
we build an object file <code class="docutils literal notranslate"><span class="pre">add_library(${lib${BLIB_LIBNAME}-obj}</span> <span class="pre">OBJECT</span> <span class="pre">&quot;${BLIB_SOURCE_FILES}...)</span></code>
and a shared library <code class="docutils literal notranslate"><span class="pre">add_library(${lib${BLIB_LIBNAME}}</span> <span class="pre">SHARED</span> <span class="pre">...)</span></code>.</p>
<p>The object library contains the actual source files (<code class="docutils literal notranslate"><span class="pre">${BLIB_SOURCE_FILES}</span></code>),
but is not linked, which mean we can reuse the object to build the static version of the libraries.
Notice the shared library uses the object file as its source files
<code class="docutils literal notranslate"><span class="pre">$&lt;TARGET_OBJECTS:${lib${BLIB_LIBNAME}-obj}</span></code>.</p>
<p>Notice that we can also reuse precompiled headers created previously to speed up the
parsing phase of the compilation.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">XCODE</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="c"># Create object library with sources and headers, that will be used in</span>
<span class="w">    </span><span class="c"># lib-ns3-static and the shared library</span>
<span class="w">    </span><span class="nb">add_library</span><span class="p">(</span>
<span class="w">      </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">-obj}</span><span class="w"> </span><span class="s">OBJECT</span><span class="w"> </span><span class="s2">&quot;${BLIB_SOURCE_FILES}&quot;</span>
<span class="w">                                      </span><span class="s2">&quot;${BLIB_HEADER_FILES}&quot;</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">PRECOMPILE_HEADERS_ENABLED</span><span class="o">}</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">IGNORE_PCH</span><span class="o">}</span><span class="p">))</span>
<span class="w">      </span><span class="nb">target_precompile_headers</span><span class="p">(</span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">-obj}</span><span class="w"> </span><span class="s">REUSE_FROM</span><span class="w"> </span><span class="s">stdlib_pch</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">    </span><span class="c"># Create shared library with previously created object library (saving</span>
<span class="w">    </span><span class="c"># compilation time for static libraries)</span>
<span class="w">    </span><span class="nb">add_library</span><span class="p">(</span>
<span class="w">      </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">SHARED</span><span class="w"> </span><span class="o">$&lt;</span><span class="nv">TARGET_OBJECTS:${lib${BLIB_LIBNAME}-obj}</span><span class="o">&gt;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="c"># Xcode and CMake don&#39;t play well when using object libraries, so we have a</span>
<span class="w">    </span><span class="c"># specific path for that</span>
<span class="w">    </span><span class="nb">add_library</span><span class="p">(</span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">SHARED</span><span class="w"> </span><span class="s2">&quot;${BLIB_SOURCE_FILES}&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">PRECOMPILE_HEADERS_ENABLED</span><span class="o">}</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">IGNORE_PCH</span><span class="o">}</span><span class="p">))</span>
<span class="w">      </span><span class="nb">target_precompile_headers</span><span class="p">(</span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">REUSE_FROM</span><span class="w"> </span><span class="s">stdlib_pch</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>In the next code block, we create an alias to <code class="docutils literal notranslate"><span class="pre">libmodule</span></code>, <code class="docutils literal notranslate"><span class="pre">ns3::libmodule</span></code>,
which can later be used when importing <em>ns-3</em> with CMake’s <code class="docutils literal notranslate"><span class="pre">find_package(ns3)</span></code>.</p>
<p>Then, we associate configured headers (<code class="docutils literal notranslate"><span class="pre">config-store-config</span></code>, <code class="docutils literal notranslate"><span class="pre">core-config.h</span></code> and
<code class="docutils literal notranslate"><span class="pre">version-defines.h</span></code>) to the core module.</p>
<p>And finally associate all of the public headers of the module to that library,
to make sure CMake will be refreshed in case one of them changes.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="nb">add_library</span><span class="p">(</span><span class="s">ns3::</span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">ALIAS</span><span class="w"> </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Associate public headers with library for installation purposes</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s2">&quot;${BLIB_LIBNAME}&quot;</span><span class="w"> </span><span class="s">STREQUAL</span><span class="w"> </span><span class="s2">&quot;core&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">config_headers</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_HEADER_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/config-store-config.h</span>
<span class="w">                      </span><span class="o">${</span><span class="nv">CMAKE_HEADER_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/core-config.h</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_ENABLE_BUILD_VERSION</span><span class="o">}</span><span class="p">)</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">config_headers</span>
<span class="w">          </span><span class="o">${</span><span class="nv">CMAKE_HEADER_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/version-defines.h</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">set_target_properties</span><span class="p">(</span>
<span class="w">    </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span>
<span class="w">    </span><span class="s">PROPERTIES</span>
<span class="w">      </span><span class="s">PUBLIC_HEADER</span>
<span class="w">      </span><span class="s2">&quot;${BLIB_HEADER_FILES};${BLIB_DEPRECATED_HEADER_FILES};${config_headers};${CMAKE_HEADER_OUTPUT_DIRECTORY}/${BLIB_LIBNAME}-module.h&quot;</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>In the next code block, we make the library a dependency to the ClangAnalyzer’s time trace report,
which measures which step of compilation took most time and which files were responsible for that.</p>
<p>Then, the <em>ns-3</em> libraries are separated from non-<em>ns-3</em> libraries, that can be propagated or not
for libraries/executables linked to the current <em>ns-3</em> module being processed.</p>
<p>The default is propagating these third-party libraries and their include directories, but this
can be turned off by setting <code class="docutils literal notranslate"><span class="pre">NS3_REEXPORT_THIRD_PARTY_LIBRARIES=OFF</span></code></p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_CLANG_TIMETRACE</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">add_dependencies</span><span class="p">(</span><span class="s">timeTraceReport</span><span class="w"> </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="c"># Split ns and non-ns libraries to manage their propagation properly</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">non_ns_libraries_to_link</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">ns_libraries_to_link</span><span class="p">)</span>

<span class="w">  </span><span class="nb">foreach</span><span class="p">(</span><span class="s">library</span><span class="w"> </span><span class="o">${</span><span class="nv">BLIB_LIBRARIES_TO_LINK</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">remove_lib_prefix</span><span class="p">(</span><span class="s2">&quot;${library}&quot;</span><span class="w"> </span><span class="s">module_name</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Check if the module exists in the ns-3 modules list</span>
<span class="w">    </span><span class="c"># or if it is a 3rd-party library</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">module_name</span><span class="o">}</span><span class="w"> </span><span class="s">IN_LIST</span><span class="w"> </span><span class="s">ns3-all-enabled-modules</span><span class="p">)</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">ns_libraries_to_link</span><span class="w"> </span><span class="o">${</span><span class="nv">library</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">else</span><span class="p">()</span>
<span class="w">      </span><span class="nb">list</span><span class="p">(</span><span class="s">APPEND</span><span class="w"> </span><span class="s">non_ns_libraries_to_link</span><span class="w"> </span><span class="o">${</span><span class="nv">library</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">    </span><span class="nb">unset</span><span class="p">(</span><span class="s">module_name</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endforeach</span><span class="p">()</span>

<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">NS3_REEXPORT_THIRD_PARTY_LIBRARIES</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="c"># ns-3 libraries are linked publicly, to make sure other modules can find</span>
<span class="w">    </span><span class="c"># each other without being directly linked</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">exported_libraries</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_PRE</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">ns_libraries_to_link</span><span class="o">}</span>
<span class="w">                          </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_POST</span><span class="o">}</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c"># non-ns-3 libraries are linked privately, not propagating unnecessary</span>
<span class="w">    </span><span class="c"># libraries such as pthread, librt, etc</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">private_libraries</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_PRE</span><span class="o">}</span>
<span class="w">                          </span><span class="o">${</span><span class="nv">non_ns_libraries_to_link</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_POST</span><span class="o">}</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c"># we don&#39;t re-export included libraries from 3rd-party modules</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">exported_include_directories</span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="c"># we export everything by default when NS3_REEXPORT_THIRD_PARTY_LIBRARIES=ON</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">exported_libraries</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_PRE</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">ns_libraries_to_link</span><span class="o">}</span>
<span class="w">                          </span><span class="o">${</span><span class="nv">non_ns_libraries_to_link</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_POST</span><span class="o">}</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">private_libraries</span><span class="p">)</span>

<span class="w">    </span><span class="c"># with NS3_REEXPORT_THIRD_PARTY_LIBRARIES, we export all 3rd-party library</span>
<span class="w">    </span><span class="c"># include directories, allowing consumers of this module to include and link</span>
<span class="w">    </span><span class="c"># the 3rd-party code with no additional setup</span>
<span class="w">    </span><span class="nb">get_target_includes</span><span class="p">(</span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">exported_include_directories</span><span class="p">)</span>
<span class="w">    </span><span class="nb">string</span><span class="p">(</span><span class="s">REPLACE</span><span class="w"> </span><span class="s2">&quot;-I&quot;</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="s">exported_include_directories</span>
<span class="w">                  </span><span class="s2">&quot;${exported_include_directories}&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="nb">string</span><span class="p">(</span><span class="s">REPLACE</span><span class="w"> </span><span class="s2">&quot;${CMAKE_OUTPUT_DIRECTORY}/include&quot;</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">                  </span><span class="s">exported_include_directories</span>
<span class="w">                  </span><span class="s2">&quot;${exported_include_directories}&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>After the lists of libraries to link that should be exported (<code class="docutils literal notranslate"><span class="pre">PUBLIC</span></code>) and
not exported (<code class="docutils literal notranslate"><span class="pre">PRIVATE</span></code>) are built, we can link them with <code class="docutils literal notranslate"><span class="pre">target_link_libraries</span></code>.</p>
<p>Next, we set the output name of the module library to <code class="docutils literal notranslate"><span class="pre">n3version-modulename</span></code> (+ optional build suffix).</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="nb">target_link_libraries</span><span class="p">(</span>
<span class="w">    </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="o">${</span><span class="nv">exported_libraries</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">private_libraries</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># set output name of library</span>
<span class="w">  </span><span class="nb">set_target_properties</span><span class="p">(</span>
<span class="w">    </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span>
<span class="w">    </span><span class="s">PROPERTIES</span><span class="w"> </span><span class="s">OUTPUT_NAME</span><span class="w"> </span><span class="s">ns</span><span class="o">${</span><span class="nv">NS3_VER</span><span class="o">}</span><span class="s">-</span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}${</span><span class="nv">build_profile_suffix</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>Next we export include directories, to let library consumers importing <em>ns-3</em> via CMake
use them just by linking to one of the <em>ns-3</em> modules.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="c"># export include directories used by this library so that it can be used by</span>
<span class="w">  </span><span class="c"># 3rd-party consumers of ns-3 using find_package(ns3) this will automatically</span>
<span class="w">  </span><span class="c"># add the build/include path to them, so that they can ns-3 headers with</span>
<span class="w">  </span><span class="c"># &lt;ns3/something.h&gt;</span>
<span class="w">  </span><span class="nb">target_include_directories</span><span class="p">(</span>
<span class="w">    </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span>
<span class="w">    </span><span class="s">PUBLIC</span><span class="w"> </span><span class="o">$&lt;</span><span class="nv">BUILD_INTERFACE:${CMAKE_OUTPUT_DIRECTORY}/include</span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">$&lt;</span><span class="nv">INSTALL_INTERFACE:include</span><span class="o">&gt;</span>
<span class="w">    </span><span class="s">INTERFACE</span><span class="w"> </span><span class="o">${</span><span class="nv">exported_include_directories</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>We append the list of third-party/external libraries for each processed module,
and append a list of object libraries that can be later used for the static <em>ns-3</em> build.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">ns3-external-libs</span><span class="w"> </span><span class="s2">&quot;${non_ns_libraries_to_link};${ns3-external-libs}&quot;</span>
<span class="w">      </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span>
<span class="w">            </span><span class="s2">&quot;list of non-ns libraries to link to NS3_STATIC and NS3_MONOLIB&quot;</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_STATIC</span><span class="o">}</span><span class="w"> </span><span class="s">OR</span><span class="w"> </span><span class="o">${</span><span class="nv">NS3_MONOLIB</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">lib-ns3-static-objs</span>
<span class="w">        </span><span class="s2">&quot;$&lt;TARGET_OBJECTS:${lib${BLIB_LIBNAME}-obj}&gt;;${lib-ns3-static-objs}&quot;</span>
<span class="w">        </span><span class="s">CACHE</span>
<span class="w">          </span><span class="s">INTERNAL</span>
<span class="w">          </span><span class="s2">&quot;list of object files from module used by NS3_STATIC and NS3_MONOLIB&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>The following block creates the <code class="docutils literal notranslate"><span class="pre">${BLIB_LIBNAME}-module.h</span></code> header for user scripts,
and copies header files from <code class="docutils literal notranslate"><span class="pre">src/module</span></code> and <code class="docutils literal notranslate"><span class="pre">contrib/module</span></code> to the <code class="docutils literal notranslate"><span class="pre">include/ns3</span></code> directory.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="c"># Write a module header that includes all headers from that module</span>
<span class="w">  </span><span class="nb">write_module_header</span><span class="p">(</span><span class="s2">&quot;${BLIB_LIBNAME}&quot;</span><span class="w"> </span><span class="s2">&quot;${BLIB_HEADER_FILES}&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Copy all header files to outputfolder/include before each build</span>
<span class="w">  </span><span class="nb">copy_headers_before_building_lib</span><span class="p">(</span>
<span class="w">    </span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_HEADER_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="w"> </span><span class="s2">&quot;${BLIB_HEADER_FILES}&quot;</span>
<span class="w">    </span><span class="s">public</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">BLIB_DEPRECATED_HEADER_FILES</span><span class="p">)</span>
<span class="w">    </span><span class="nb">copy_headers_before_building_lib</span><span class="p">(</span>
<span class="w">      </span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_HEADER_OUTPUT_DIRECTORY</span><span class="o">}</span>
<span class="w">      </span><span class="s2">&quot;${BLIB_DEPRECATED_HEADER_FILES}&quot;</span><span class="w"> </span><span class="s">deprecated</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>The following block creates the test library for the module currently being processed.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="c"># Check if the module tests should be built</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NS3_FILTER_MODULE_EXAMPLES_AND_TESTS</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}</span><span class="w"> </span><span class="s">IN_LIST</span><span class="w"> </span><span class="s">NS3_FILTER_MODULE_EXAMPLES_AND_TESTS</span><span class="p">)</span>
<span class="w">      </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="c"># Build tests if requested</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">ENABLE_TESTS</span><span class="o">}</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="o">${</span><span class="nv">filtered_in</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">list</span><span class="p">(</span><span class="s">LENGTH</span><span class="w"> </span><span class="s">BLIB_TEST_SOURCES</span><span class="w"> </span><span class="s">test_source_len</span><span class="p">)</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">test_source_len</span><span class="o">}</span><span class="w"> </span><span class="s">GREATER</span><span class="w"> </span><span class="s">0</span><span class="p">)</span>
<span class="w">      </span><span class="c"># Create BLIB_LIBNAME of output library test of module</span>
<span class="w">      </span><span class="nb">set</span><span class="p">(</span><span class="s">test</span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}</span><span class="w"> </span><span class="s">lib</span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}</span><span class="s">-test</span><span class="w"> </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="nb">set</span><span class="p">(</span><span class="s">ns3-libs-tests</span><span class="w"> </span><span class="s2">&quot;${test${BLIB_LIBNAME}};${ns3-libs-tests}&quot;</span>
<span class="w">          </span><span class="s">CACHE</span><span class="w"> </span><span class="s">INTERNAL</span><span class="w"> </span><span class="s2">&quot;list of test libraries&quot;</span>
<span class="w">      </span><span class="p">)</span>

<span class="w">      </span><span class="c"># Create shared library containing tests of the module</span>
<span class="w">      </span><span class="nb">add_library</span><span class="p">(</span><span class="o">${</span><span class="nv">test${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">SHARED</span><span class="w"> </span><span class="s2">&quot;${BLIB_TEST_SOURCES}&quot;</span><span class="p">)</span>

<span class="w">      </span><span class="c"># Link test library to the module library</span>
<span class="w">      </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_MONOLIB</span><span class="o">}</span><span class="p">)</span>
<span class="w">        </span><span class="nb">target_link_libraries</span><span class="p">(</span>
<span class="w">          </span><span class="o">${</span><span class="nv">test${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_PRE</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">lib-ns3-monolib</span><span class="o">}</span>
<span class="w">          </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_POST</span><span class="o">}</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">      </span><span class="nb">else</span><span class="p">()</span>
<span class="w">        </span><span class="nb">target_link_libraries</span><span class="p">(</span>
<span class="w">          </span><span class="o">${</span><span class="nv">test${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_PRE</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span>
<span class="w">          </span><span class="s2">&quot;${BLIB_LIBRARIES_TO_LINK}&quot;</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_POST</span><span class="o">}</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">      </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">      </span><span class="nb">set_target_properties</span><span class="p">(</span>
<span class="w">        </span><span class="o">${</span><span class="nv">test${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span>
<span class="w">        </span><span class="s">PROPERTIES</span><span class="w"> </span><span class="s">OUTPUT_NAME</span>
<span class="w">                  </span><span class="s">ns</span><span class="o">${</span><span class="nv">NS3_VER</span><span class="o">}</span><span class="s">-</span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}</span><span class="s">-test</span><span class="o">${</span><span class="nv">build_profile_suffix</span><span class="o">}</span>
<span class="w">      </span><span class="p">)</span>

<span class="w">      </span><span class="nb">target_compile_definitions</span><span class="p">(</span>
<span class="w">        </span><span class="o">${</span><span class="nv">test${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="s">NS_TEST_SOURCEDIR=</span><span class="s2">&quot;${FOLDER}/test&quot;</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">      </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">PRECOMPILE_HEADERS_ENABLED</span><span class="o">}</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">IGNORE_PCH</span><span class="o">}</span><span class="p">))</span>
<span class="w">        </span><span class="nb">target_precompile_headers</span><span class="p">(</span><span class="o">${</span><span class="nv">test${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="s">REUSE_FROM</span><span class="w"> </span><span class="s">stdlib_pch</span><span class="p">)</span>
<span class="w">      </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>The following block checks for examples subdirectories and add them to parse their
CMakeLists.txt file, creating the examples. It also scans for python examples.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="c"># Build lib examples if requested</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">ENABLE_EXAMPLES</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">foreach</span><span class="p">(</span><span class="s">example_folder</span><span class="w"> </span><span class="s">example;examples</span><span class="p">)</span>
<span class="w">      </span><span class="nb">if</span><span class="p">(</span><span class="s">EXISTS</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_CURRENT_SOURCE_DIR</span><span class="o">}</span><span class="s">/</span><span class="o">${</span><span class="nv">example_folder</span><span class="o">}</span><span class="p">)</span>
<span class="w">        </span><span class="nb">if</span><span class="p">(</span><span class="s">EXISTS</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_CURRENT_SOURCE_DIR</span><span class="o">}</span><span class="s">/</span><span class="o">${</span><span class="nv">example_folder</span><span class="o">}</span><span class="s">/CMakeLists.txt</span><span class="p">)</span>
<span class="w">          </span><span class="nb">add_subdirectory</span><span class="p">(</span><span class="o">${</span><span class="nv">example_folder</span><span class="o">}</span><span class="p">)</span>
<span class="w">        </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">        </span><span class="nb">scan_python_examples</span><span class="p">(</span><span class="o">${</span><span class="nv">CMAKE_CURRENT_SOURCE_DIR</span><span class="o">}</span><span class="s">/</span><span class="o">${</span><span class="nv">example_folder</span><span class="o">}</span><span class="p">)</span>
<span class="w">      </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">    </span><span class="nb">endforeach</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>In the next code block we add the library to the <code class="docutils literal notranslate"><span class="pre">ns3ExportTargets</span></code>, later used for installation.
We also print an additional message the folder just finished being processed if <code class="docutils literal notranslate"><span class="pre">NS3_VERBOSE</span></code> is set to <code class="docutils literal notranslate"><span class="pre">ON</span></code>.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="c"># Handle package export</span>
<span class="w">  </span><span class="nb">install</span><span class="p">(</span>
<span class="w">    </span><span class="s">TARGETS</span><span class="w"> </span><span class="o">${</span><span class="nv">lib${BLIB_LIBNAME</span><span class="o">}</span><span class="s">}</span>
<span class="w">    </span><span class="s">EXPORT</span><span class="w"> </span><span class="s">ns3ExportTargets</span>
<span class="w">    </span><span class="s">ARCHIVE</span><span class="w"> </span><span class="s">DESTINATION</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_INSTALL_LIBDIR</span><span class="o">}</span><span class="s">/</span>
<span class="w">    </span><span class="s">LIBRARY</span><span class="w"> </span><span class="s">DESTINATION</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_INSTALL_LIBDIR</span><span class="o">}</span><span class="s">/</span>
<span class="w">    </span><span class="s">PUBLIC_HEADER</span><span class="w"> </span><span class="s">DESTINATION</span><span class="w"> </span><span class="s2">&quot;${CMAKE_INSTALL_INCLUDEDIR}/ns3&quot;</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_VERBOSE</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;Processed ${FOLDER}&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="module-macros-build-lib-example">
<span id="build-lib-example"></span><h6 aria-level="7"><span class="section-number">4.3.7.7.2.2. </span>Module macros: build_lib_example<a class="headerlink" href="#module-macros-build-lib-example" title="Link to this heading">¶</a></h6>
<p>The second most important macro from a module author perspective is the <code class="docutils literal notranslate"><span class="pre">build_lib_example</span></code>, which
builds the examples for their module. As with <code class="docutils literal notranslate"><span class="pre">build_lib</span></code> we explain what it does block-by-block.</p>
<p>In the first block, arguments are parsed and we check whether the current module is in the contrib
or the src folder.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib_example</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Argument parsing</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">options</span><span class="w"> </span><span class="s">IGNORE_PCH</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">oneValueArgs</span><span class="w"> </span><span class="s">NAME</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">multiValueArgs</span><span class="w"> </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="s">LIBRARIES_TO_LINK</span><span class="p">)</span>
<span class="w">  </span><span class="nb">cmake_parse_arguments</span><span class="p">(</span><span class="s2">&quot;BLIB_EXAMPLE&quot;</span><span class="w"> </span><span class="s2">&quot;${options}&quot;</span><span class="w"> </span><span class="s2">&quot;${oneValueArgs}&quot;</span><span class="w"> </span><span class="s2">&quot;${multiValueArgs}&quot;</span><span class="w"> </span><span class="o">${</span><span class="nv">ARGN</span><span class="o">}</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Get path src/module or contrib/module</span>
<span class="w">  </span><span class="nb">string</span><span class="p">(</span><span class="s">REPLACE</span><span class="w"> </span><span class="s2">&quot;${PROJECT_SOURCE_DIR}/&quot;</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="s">FOLDER</span><span class="w"> </span><span class="s2">&quot;${CMAKE_CURRENT_SOURCE_DIR}&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">get_filename_component</span><span class="p">(</span><span class="s">FOLDER</span><span class="w"> </span><span class="o">${</span><span class="nv">FOLDER</span><span class="o">}</span><span class="w"> </span><span class="s">DIRECTORY</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>Then we check if the <em>ns-3</em> modules required by the example are enabled to be built.
If the list <code class="docutils literal notranslate"><span class="pre">missing_dependencies</span></code> is empty, we create the example. Otherwise, we skip it.
The example can be linked to the current module (<code class="docutils literal notranslate"><span class="pre">${lib${BLIB_EXAMPLE_LIBNAME}}</span></code>) and
other libraries to link (<code class="docutils literal notranslate"><span class="pre">${BLIB_EXAMPLE_LIBRARIES_TO_LINK}</span></code>) and optionally to the visualizer
module (<code class="docutils literal notranslate"><span class="pre">${optional_visualizer_lib}</span></code>).
If the visualizer module is not enabled, <code class="docutils literal notranslate"><span class="pre">optional_visualizer_lib</span></code> is empty.</p>
<p>The example can also be linked to a single <em>ns-3</em> shared library (<code class="docutils literal notranslate"><span class="pre">lib-ns3-monolib</span></code>) or
a single <em>ns-3</em> static library (<code class="docutils literal notranslate"><span class="pre">lib-ns3-static</span></code>), if either <code class="docutils literal notranslate"><span class="pre">NS3_MONOLIB=ON</span></code> or <code class="docutils literal notranslate"><span class="pre">NS3_STATIC=ON</span></code>.
Note that both of these options are handled by the <code class="docutils literal notranslate"><span class="pre">build_exec</span></code> macro.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">function</span><span class="p">(</span><span class="s">build_lib_example</span><span class="p">)</span>
<span class="w">  </span><span class="c"># ...</span>
<span class="w">  </span><span class="nb">check_for_missing_libraries</span><span class="p">(</span><span class="s">missing_dependencies</span><span class="w"> </span><span class="s2">&quot;${BLIB_EXAMPLE_LIBRARIES_TO_LINK}&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Check if a module example should be built</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NS3_FILTER_MODULE_EXAMPLES_AND_TESTS</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>
<span class="w">    </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">BLIB_LIBNAME</span><span class="o">}</span><span class="w"> </span><span class="s">IN_LIST</span><span class="w"> </span><span class="s">NS3_FILTER_MODULE_EXAMPLES_AND_TESTS</span><span class="p">)</span>
<span class="w">      </span><span class="nb">set</span><span class="p">(</span><span class="s">filtered_in</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>
<span class="w">    </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="nb">if</span><span class="p">((</span><span class="s">NOT</span><span class="w"> </span><span class="s">missing_dependencies</span><span class="p">)</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="o">${</span><span class="nv">filtered_in</span><span class="o">}</span><span class="p">)</span>
<span class="w">     </span><span class="c"># Convert boolean into text to forward argument</span>
<span class="w">     </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">BLIB_EXAMPLE_IGNORE_PCH</span><span class="o">}</span><span class="p">)</span>
<span class="w">       </span><span class="nb">set</span><span class="p">(</span><span class="s">IGNORE_PCH</span><span class="w"> </span><span class="s">IGNORE_PCH</span><span class="p">)</span>
<span class="w">     </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">     </span><span class="c"># Create executable with sources and headers</span>
<span class="w">     </span><span class="c"># cmake-format: off</span>
<span class="w">     </span><span class="nb">build_exec</span><span class="p">(</span>
<span class="w">       </span><span class="s">EXECNAME</span><span class="w"> </span><span class="o">${</span><span class="nv">BLIB_EXAMPLE_NAME</span><span class="o">}</span>
<span class="w">       </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="o">${</span><span class="nv">BLIB_EXAMPLE_SOURCE_FILES</span><span class="o">}</span>
<span class="w">       </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="o">${</span><span class="nv">BLIB_EXAMPLE_HEADER_FILES</span><span class="o">}</span>
<span class="w">       </span><span class="s">LIBRARIES_TO_LINK</span>
<span class="w">         </span><span class="o">${</span><span class="nv">lib${BLIB_EXAMPLE_LIBNAME</span><span class="o">}</span><span class="s">}</span><span class="w"> </span><span class="o">${</span><span class="nv">BLIB_EXAMPLE_LIBRARIES_TO_LINK</span><span class="o">}</span>
<span class="w">         </span><span class="o">${</span><span class="nv">optional_visualizer_lib</span><span class="o">}</span>
<span class="w">       </span><span class="s">EXECUTABLE_DIRECTORY_PATH</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_RUNTIME_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/</span><span class="o">${</span><span class="nv">FOLDER</span><span class="o">}</span><span class="s">/</span>
<span class="w">       </span><span class="o">${</span><span class="nv">IGNORE_PCH</span><span class="o">}</span>
<span class="w">     </span><span class="p">)</span>
<span class="w">     </span><span class="c"># cmake-format: on</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endfunction</span><span class="p">()</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="#build-exec">build_exec</a> macro will also set resulting folder where the example will end up
after built (e.g. build/src/module/examples). It does that by forwarding the
<code class="docutils literal notranslate"><span class="pre">EXECUTABLE_DIRECTORY_PATH</span></code> to the macro <code class="docutils literal notranslate"><span class="pre">set_runtime_outputdirectory</span></code>, which also
adds the proper <em>ns-3</em> version prefix and build type suffix to the executable.</p>
<p>As with the module libraries, we can also reuse precompiled headers here to speed up
the parsing step of compilation.
You can find more information about <code class="docutils literal notranslate"><span class="pre">IGNORE_PCH</span></code> at the <a class="reference internal" href="#pch-side-effects">PCH side-effects</a> section.</p>
</section>
</section>
<section id="user-options-and-header-checking">
<h6><span class="section-number">4.3.7.7.3. </span>User options and header checking<a class="headerlink" href="#user-options-and-header-checking" title="Link to this heading">¶</a></h6>
<p>User-settable options should be prefixed with <code class="docutils literal notranslate"><span class="pre">NS3_</span></code>, otherwise
they will not be preserved by <code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">configure</span> <span class="pre">--force-refresh</span></code>.</p>
<p>After checking if the pre-requisites of the user-settable options
are met, set the same option now prefixed with <code class="docutils literal notranslate"><span class="pre">ENABLE_</span></code>. The
following example demonstrates this pattern:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Option() means the variable NS3_GSL will be set to ON/OFF</span>
<span class="c"># The second argument is a comment explaining what this option does</span>
<span class="c"># The last argument is the default value for the user-settable option</span>
<span class="nb">option</span><span class="p">(</span><span class="s">NS3_GSL</span><span class="w"> </span><span class="s2">&quot;Enable GSL related features&quot;</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>

<span class="c"># Set the ENABLE\_ counterpart to FALSE by default</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ENABLE_GSL</span><span class="w"> </span><span class="s">FALSE</span><span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_GSL</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="c"># If the user enabled GSL, check if GSL is available</span>
<span class="w">  </span><span class="nb">find_package</span><span class="p">(</span><span class="s">GSL</span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">GSL_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">ENABLE_GSL</span><span class="w"> </span><span class="s">TRUE</span><span class="p">)</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;GSL was requested by the user and was found&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;GSL was not found and GSL features will continue disabled&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">else</span><span class="p">()</span>
<span class="w">  </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;GSL features were not requested by the user&quot;</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># Now the module can check for ENABLE_GSL before being processed</span>
<span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">ENABLE_GSL</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">return</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># Or to enable optional features</span>
<span class="nb">set</span><span class="p">(</span><span class="s">gsl_sources</span><span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">ENABLE_GSL</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">gsl_sources</span><span class="w"> </span><span class="s">model/gsl_features.cc</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>Here are examples of how to do the options and header checking,
followed by a header configuration:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># We always set the ENABLE\_ counterpart of NS3\_ option to FALSE before checking</span>
<span class="c">#</span>
<span class="c"># If this variable is created inside your module, use</span>
<span class="c"># set(ENABLE_MPI FALSE CACHE INTERNAL &quot;&quot;)</span>
<span class="c"># instead, to make it globally available</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ENABLE_MPI</span><span class="w"> </span><span class="s">FALSE</span><span class="p">)</span>

<span class="c"># If the user option switch is set to ON, we check</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">NS3_MPI</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Use find_package to look for MPI</span>
<span class="w">  </span><span class="nb">find_package</span><span class="p">(</span><span class="s">MPI</span><span class="w"> </span><span class="s">QUIET</span><span class="p">)</span>

<span class="w">  </span><span class="c"># If the package is optional, which is the case for MPI,</span>
<span class="w">  </span><span class="c"># we can proceed if it is not found</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">MPI_FOUND</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;MPI was not found. Continuing without it.&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nb">else</span><span class="p">()</span>
<span class="w">    </span><span class="c"># If it is false, we add necessary C++ definitions (e.g. NS3_MPI)</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;MPI was found.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">add_definitions</span><span class="p">(</span><span class="s">-DNS3_MPI</span><span class="p">)</span>

<span class="w">    </span><span class="c"># Then set ENABLE_MPI to TRUE, which can be used to check</span>
<span class="w">    </span><span class="c"># if NS3_MPI is enabled AND MPI was found</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># If this variable is created inside your module, use</span>
<span class="w">    </span><span class="c"># set(ENABLE_MPI TRUE CACHE INTERNAL &quot;&quot;)</span>
<span class="w">    </span><span class="c"># instead, to make it globally available</span>
<span class="w">    </span><span class="nb">set</span><span class="p">(</span><span class="s">ENABLE_MPI</span><span class="w"> </span><span class="s">TRUE</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># ...</span>

<span class="c"># These two standard CMake modules allow for header and function checking</span>
<span class="nb">include</span><span class="p">(</span><span class="s">CheckIncludeFileCXX</span><span class="p">)</span>
<span class="nb">include</span><span class="p">(</span><span class="s">CheckFunctionExists</span><span class="p">)</span>

<span class="c"># Check for required headers and functions,</span>
<span class="c"># set flags on the right argument if header in the first argument is found</span>
<span class="c"># if they are not found, a warning is emitted</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;stdint.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_STDINT_H&quot;</span><span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;inttypes.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_INTTYPES_H&quot;</span><span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;sys/types.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_SYS_TYPES_H&quot;</span><span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;stat.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_SYS_STAT_H&quot;</span><span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;dirent.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_DIRENT_H&quot;</span><span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;stdlib.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_STDLIB_H&quot;</span><span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;signal.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_SIGNAL_H&quot;</span><span class="p">)</span>
<span class="nb">check_include_file_cxx</span><span class="p">(</span><span class="s2">&quot;netpacket/packet.h&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_PACKETH&quot;</span><span class="p">)</span>
<span class="nb">check_function_exists</span><span class="p">(</span><span class="s2">&quot;getenv&quot;</span><span class="w"> </span><span class="s2">&quot;HAVE_GETENV&quot;</span><span class="p">)</span>

<span class="c"># This is the CMake command to open up a file template (in this case a header</span>
<span class="c"># passed as the first argument), then fill its fields with values stored in</span>
<span class="c"># CMake variables and save the resulting file to the target destination</span>
<span class="c"># (in the second argument)</span>
<span class="nb">configure_file</span><span class="p">(</span>
<span class="w">  </span><span class="s">build-support/core-config-template.h</span>
<span class="w">  </span><span class="o">${</span><span class="nv">CMAKE_HEADER_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/core-config.h</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The configure_file command is not very clear by itself, as you do not know which
values are being used. So we need to check the template.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef NS3_CORE_CONFIG_H</span>
<span class="cp">#define NS3_CORE_CONFIG_H</span>

<span class="c1">// Defined if HAVE_UINT128_T is defined in CMake</span>
<span class="cp">#cmakedefine   HAVE_UINT128_T</span>
<span class="c1">// Set to 1 if HAVE__UINT128_T is defined in CMake, 0 otherwise</span>
<span class="cp">#cmakedefine01 HAVE___UINT128_T</span>
<span class="cp">#cmakedefine   INT64X64_USE_128</span>
<span class="cp">#cmakedefine   INT64X64_USE_DOUBLE</span>
<span class="cp">#cmakedefine   INT64X64_USE_CAIRO</span>
<span class="cp">#cmakedefine01 HAVE_STDINT_H</span>
<span class="cp">#cmakedefine01 HAVE_INTTYPES_H</span>
<span class="cp">#cmakedefine   HAVE_SYS_INT_TYPES_H</span>
<span class="cp">#cmakedefine01 HAVE_SYS_TYPES_H</span>
<span class="cp">#cmakedefine01 HAVE_SYS_STAT_H</span>
<span class="cp">#cmakedefine01 HAVE_DIRENT_H</span>
<span class="cp">#cmakedefine01 HAVE_STDLIB_H</span>
<span class="cp">#cmakedefine01 HAVE_GETENV</span>
<span class="cp">#cmakedefine01 HAVE_SIGNAL_H</span>

<span class="cm">/*</span>
<span class="cm">* #cmakedefine turns into:</span>
<span class="cm">* //#define HAVE_FLAG // if HAVE_FLAG is not defined in CMake (e.g. unset(HAVE_FLAG))</span>
<span class="cm">* #define HAVE_FLAG // if HAVE_FLAG is defined in CMake (e.g. set(HAVE_FLAG))</span>
<span class="cm">*</span>
<span class="cm">* #cmakedefine01 turns into:</span>
<span class="cm">* #define HAVE_FLAG 0 // if HAVE_FLAG is not defined in CMake</span>
<span class="cm">* #define HAVE_FLAG 1 // if HAVE_FLAG is defined in CMake</span>
<span class="cm">*/</span>

<span class="cp">#endif </span><span class="c1">//NS3_CORE_CONFIG_H</span>
</pre></div>
</div>
</section>
<section id="custom-targets">
<h6><span class="section-number">4.3.7.7.4. </span>Custom targets<a class="headerlink" href="#custom-targets" title="Link to this heading">¶</a></h6>
<p>Another common thing to do is implement custom targets that run specific commands and
manage dependencies. Here is an example for Doxygen:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># This command hides DOXYGEN from some CMake cache interfaces</span>
<span class="nb">mark_as_advanced</span><span class="p">(</span><span class="s">DOXYGEN</span><span class="p">)</span>

<span class="c"># This custom macro checks for dependencies CMake find_package and program</span>
<span class="c"># dependencies and return the missing dependencies in the third argument</span>
<span class="nb">check_deps</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="s2">&quot;doxygen;dot;dia&quot;</span><span class="w"> </span><span class="s">doxygen_docs_missing_deps</span><span class="p">)</span>

<span class="c"># If the variable contains missing dependencies, we stop processing doxygen targets</span>
<span class="nb">if</span><span class="p">(</span><span class="s">doxygen_docs_missing_deps</span><span class="p">)</span>
<span class="w">  </span><span class="nb">message</span><span class="p">(</span>
<span class="w">    </span><span class="s">STATUS</span>
<span class="w">      </span><span class="s2">&quot;docs: doxygen documentation not enabled due to missing dependencies: ${doxygen_docs_missing_deps}&quot;</span>
<span class="w">  </span><span class="p">)</span>
<span class="nb">else</span><span class="p">()</span>
<span class="w">  </span><span class="c"># We checked this already exists, but we need the path to the executable</span>
<span class="w">  </span><span class="nb">find_package</span><span class="p">(</span><span class="s">Doxygen</span><span class="w"> </span><span class="s">QUIET</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Get introspected doxygen</span>
<span class="w">  </span><span class="nb">add_custom_target</span><span class="p">(</span>
<span class="w">    </span><span class="s">run-print-introspected-doxygen</span>
<span class="w">    </span><span class="s">COMMAND</span>
<span class="w">      </span><span class="o">${</span><span class="nv">CMAKE_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/utils/ns</span><span class="o">${</span><span class="nv">NS3_VER</span><span class="o">}</span><span class="s">-print-introspected-doxygen</span><span class="o">${</span><span class="nv">build_profile_suffix</span><span class="o">}</span>
<span class="w">      </span><span class="s">&gt;</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/doc/introspected-doxygen.h</span>
<span class="w">    </span><span class="s">COMMAND</span>
<span class="w">      </span><span class="o">${</span><span class="nv">CMAKE_OUTPUT_DIRECTORY</span><span class="o">}</span><span class="s">/utils/ns</span><span class="o">${</span><span class="nv">NS3_VER</span><span class="o">}</span><span class="s">-print-introspected-doxygen</span><span class="o">${</span><span class="nv">build_profile_suffix</span><span class="o">}</span>
<span class="w">      </span><span class="s">--output-text</span><span class="w"> </span><span class="s">&gt;</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/doc/ns3-object.txt</span>
<span class="w">    </span><span class="s">DEPENDS</span><span class="w"> </span><span class="s">print-introspected-doxygen</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># Run test.py with NS_COMMANDLINE_INTROSPECTION=.. to print examples</span>
<span class="w">  </span><span class="c"># introspected commandline</span>
<span class="w">  </span><span class="nb">add_custom_target</span><span class="p">(</span>
<span class="w">    </span><span class="s">run-introspected-command-line</span>
<span class="w">    </span><span class="s">COMMAND</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_COMMAND</span><span class="o">}</span><span class="w"> </span><span class="s">-E</span><span class="w"> </span><span class="s">env</span><span class="w"> </span><span class="s">NS_COMMANDLINE_INTROSPECTION=..</span>
<span class="w">            </span><span class="o">${</span><span class="nv">Python_EXECUTABLE</span><span class="o">}</span><span class="w"> </span><span class="s">./test.py</span><span class="w"> </span><span class="s">--no-build</span><span class="w"> </span><span class="s">--constrain=example</span>
<span class="w">    </span><span class="s">WORKING_DIRECTORY</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span>
<span class="w">    </span><span class="s">DEPENDS</span><span class="w"> </span><span class="s">all-test-targets</span><span class="w"> </span><span class="c"># all-test-targets only exists if ENABLE_TESTS is</span>
<span class="w">                             </span><span class="c"># set to ON</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># This file header is written during configuration</span>
<span class="w">  </span><span class="nb">file</span><span class="p">(</span>
<span class="w">    </span><span class="s">WRITE</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/doc/introspected-command-line.h</span>
<span class="w">    </span><span class="s2">&quot;/* This file is automatically generated by</span>
<span class="s2">CommandLine::PrintDoxygenUsage() from the CommandLine configuration</span>
<span class="s2">in various example programs.  Do not edit this file!  Edit the</span>
<span class="s2">CommandLine configuration in those files instead.</span>
<span class="s2">*/</span>
<span class="s2">\n&quot;</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="c"># After running test.py for the introspected commandline above,</span>
<span class="w">  </span><span class="c"># merge outputs and concatenate to the header file created during</span>
<span class="w">  </span><span class="c"># configuration</span>
<span class="w">  </span><span class="nb">add_custom_target</span><span class="p">(</span>
<span class="w">    </span><span class="s">assemble-introspected-command-line</span>
<span class="w">    </span><span class="c"># works on CMake 3.18 or newer &gt; COMMAND ${CMAKE_COMMAND} -E cat</span>
<span class="w">    </span><span class="c"># ${PROJECT_SOURCE_DIR}/testpy-output/*.command-line &gt;</span>
<span class="w">    </span><span class="c"># ${PROJECT_SOURCE_DIR}/doc/introspected-command-line.h</span>
<span class="w">    </span><span class="s">COMMAND</span><span class="w"> </span><span class="o">${</span><span class="nv">cat_command</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/testpy-output/*.command-line</span>
<span class="w">            </span><span class="s">&gt;</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/doc/introspected-command-line.h</span><span class="w"> </span><span class="s">2&gt;</span><span class="w"> </span><span class="s">NULL</span>
<span class="w">    </span><span class="s">DEPENDS</span><span class="w"> </span><span class="s">run-introspected-command-line</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># Create a target that updates the doxygen version</span>
<span class="w">  </span><span class="nb">add_custom_target</span><span class="p">(</span>
<span class="w">    </span><span class="s">update_doxygen_version</span>
<span class="w">    </span><span class="s">COMMAND</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/doc/ns3_html_theme/get_version.sh</span>
<span class="w">    </span><span class="s">WORKING_DIRECTORY</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># Create a doxygen target that builds the documentation and only runs</span>
<span class="w">  </span><span class="c"># after the version target above was executed, the introspected doxygen</span>
<span class="w">  </span><span class="c"># and command line were extracted</span>
<span class="w">  </span><span class="nb">add_custom_target</span><span class="p">(</span>
<span class="w">    </span><span class="s">doxygen</span>
<span class="w">    </span><span class="s">COMMAND</span><span class="w"> </span><span class="o">${</span><span class="nv">DOXYGEN_EXECUTABLE</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/doc/doxygen.conf</span>
<span class="w">    </span><span class="s">WORKING_DIRECTORY</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span>
<span class="w">    </span><span class="s">DEPENDS</span><span class="w"> </span><span class="s">update_doxygen_version</span><span class="w"> </span><span class="s">run-print-introspected-doxygen</span>
<span class="w">            </span><span class="s">assemble-introspected-command-line</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># Create a doxygen target that only needs to run the version target</span>
<span class="w">  </span><span class="c"># which doesn&#39;t trigger compilation of examples neither the execution of test.py</span>
<span class="w">  </span><span class="c"># nor print-introspected-doxygen</span>
<span class="w">  </span><span class="nb">add_custom_target</span><span class="p">(</span>
<span class="w">    </span><span class="s">doxygen-no-build</span>
<span class="w">    </span><span class="s">COMMAND</span><span class="w"> </span><span class="o">${</span><span class="nv">DOXYGEN_EXECUTABLE</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/doc/doxygen.conf</span>
<span class="w">    </span><span class="s">WORKING_DIRECTORY</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span>
<span class="w">    </span><span class="s">DEPENDS</span><span class="w"> </span><span class="s">update_doxygen_version</span>
<span class="w">  </span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="project-wide-compiler-and-linker-flags">
<h6><span class="section-number">4.3.7.7.5. </span>Project-wide compiler and linker flags<a class="headerlink" href="#project-wide-compiler-and-linker-flags" title="Link to this heading">¶</a></h6>
<p>Different compilers and links accept different flags, which must be
known during configuration time. Some of these flags are
handled directly by CMake:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># equivalent to -fPIC for libraries and -fPIE for executables</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_POSITION_INDEPENDENT_CODE</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>

<span class="c"># link-time optimization flags such as -flto and -flto=thin</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_INTERPROCEDURAL_OPTIMIZATION</span><span class="w"> </span><span class="s">TRUE</span><span class="p">)</span>

<span class="c"># C++ standard flag to use</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD_MINIMUM</span><span class="w"> </span><span class="s">17</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD_REQUIRED</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>

<span class="nb">add_library</span><span class="p">(</span><span class="s">static_lib</span><span class="w"> </span><span class="s">STATIC</span><span class="p">)</span><span class="w"> </span><span class="c"># equivalent to -static flag</span>
<span class="nb">add_library</span><span class="p">(</span><span class="s">shared_lib</span><span class="w"> </span><span class="s">SHARED</span><span class="p">)</span><span class="w"> </span><span class="c"># equivalent to -shared flags</span>
</pre></div>
</div>
<p>Other flags need to be handled manually and change based on
the compiler used. The most commonly used are handled in
<code class="docutils literal notranslate"><span class="pre">build-support/macros-and-definitions.cmake</span></code>.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="s">LIB_AS_NEEDED_PRE</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">LIB_AS_NEEDED_POST</span><span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">GCC</span><span class="o">}</span><span class="w"> </span><span class="s">AND</span><span class="w"> </span><span class="s">NOT</span><span class="w"> </span><span class="s">APPLE</span><span class="p">)</span>
<span class="w">  </span><span class="c"># using GCC</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">LIB_AS_NEEDED_PRE</span><span class="w"> </span><span class="s">-Wl,--no-as-needed</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">LIB_AS_NEEDED_POST</span><span class="w"> </span><span class="s">-Wl,--as-needed</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">LIB_AS_NEEDED_PRE_STATIC</span><span class="w"> </span><span class="s">-Wl,--whole-archive,-Bstatic</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">LIB_AS_NEEDED_POST_STATIC</span><span class="w"> </span><span class="s">-Wl,--no-whole-archive</span><span class="p">)</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">LIB_AS_NEEDED_POST_STATIC_DYN</span><span class="w"> </span><span class="s">-Wl,-Bdynamic,--no-whole-archive</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">LIB_AS_NEEDED</span></code> values are used to force linking of all symbols,
and not only those explicitly used by the applications, which is necessary
since simulation scripts don’t directly use most of the symbols exported
by the modules. Their use can be seen in the <code class="docutils literal notranslate"><span class="pre">utils/CMakeLists.txt</span></code>:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">target_link_libraries</span><span class="p">(</span>
<span class="w">    </span><span class="s">test-runner</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_PRE</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">ns3-libs-tests</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">LIB_AS_NEEDED_POST</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">ns3-libs</span><span class="o">}</span><span class="w"> </span><span class="o">${</span><span class="nv">ns3-contrib-libs</span><span class="o">}</span>
<span class="w">  </span><span class="p">)</span>
</pre></div>
</div>
<p>This will ensure test-runner linking to <code class="docutils literal notranslate"><span class="pre">ns3-libs-tests</span></code> (list containing all
module test libraries) with all symbols, which will make it able to find and run
all tests. The other two lists <code class="docutils literal notranslate"><span class="pre">ns3-libs</span></code> (src modules) and <code class="docutils literal notranslate"><span class="pre">ns3-contrib-libs</span></code>
(contrib modules) don’t need to be completely linked since the tests libraries are
already linked to them.</p>
<p>Other project-wide compiler-dependent flags can be set during compiler checking.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Check if the compiler is GCC</span>
<span class="nb">set</span><span class="p">(</span><span class="s">GCC</span><span class="w"> </span><span class="s">FALSE</span><span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="s2">&quot;${CMAKE_CXX_COMPILER_ID}&quot;</span><span class="w"> </span><span class="s">MATCHES</span><span class="w"> </span><span class="s2">&quot;GNU&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="c"># Check if GCC is a supported version</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">CMAKE_CXX_COMPILER_VERSION</span><span class="w"> </span><span class="s">VERSION_LESS</span><span class="w"> </span><span class="o">${</span><span class="nv">GNU_MinVersion</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="nb">message</span><span class="p">(</span>
<span class="w">      </span><span class="s">FATAL_ERROR</span>
<span class="w">        </span><span class="s2">&quot;GNU ${CMAKE_CXX_COMPILER_VERSION} ${below_minimum_msg} ${GNU_MinVersion}&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>
<span class="w">  </span><span class="c"># If GCC is up-to-date, set flag to true and continue</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">GCC</span><span class="w"> </span><span class="s">TRUE</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Disable semantic interposition</span>
<span class="w">  </span><span class="nb">add_definitions</span><span class="p">(</span><span class="s">-fno-semantic-interposition</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">-fno-semantic-interposition</span></code> flag <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/777">disables semantic interposition</a>, which can
reduce overhead of function calls in shared libraries built with <code class="docutils literal notranslate"><span class="pre">-fPIC</span></code>.
This is the default behaviour for Clang. The inlined <em>ns-3</em> calls will not be
correctly interposed by the <code class="docutils literal notranslate"><span class="pre">LD_PRELOAD</span></code> trick, which is not know to be used by <em>ns-3</em> users.
To re-enable semantic interposition, comment out the line and reconfigure the project.</p>
<p>Note: the most common use of the <code class="docutils literal notranslate"><span class="pre">LD_PRELOAD</span></code> trick is to use custom memory allocators,
and this continues to work since the interposed symbols are from the standard libraries,
which are compiled with semantic interposition.</p>
<p>Some modules may require special flags. The Openflow module for example
may require <code class="docutils literal notranslate"><span class="pre">-Wno-stringop-truncation</span></code> flag to prevent an warning that
is treated as error to prevent the compilation from proceeding. The flag
can be passed to the entire module with the following:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_compile_options</span><span class="p">(</span><span class="s">-Wno-stringop-truncation</span><span class="p">)</span>

<span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">openflow</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span>
<span class="w">    </span><span class="s">helper/openflow-switch-helper.cc</span>
<span class="w">    </span><span class="s">model/openflow-interface.cc</span>
<span class="w">    </span><span class="s">model/openflow-switch-net-device.cc</span>
<span class="w">  </span><span class="s">HEADER_FILES</span>
<span class="w">    </span><span class="s">helper/openflow-switch-helper.h</span>
<span class="w">    </span><span class="s">model/openflow-interface.h</span>
<span class="w">    </span><span class="s">model/openflow-switch-net-device.h</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span>
<span class="w">                    </span><span class="o">${</span><span class="nv">openflow_LIBRARIES</span><span class="o">}</span>
<span class="w">  </span><span class="s">TEST_SOURCES</span><span class="w"> </span><span class="s">test/openflow-switch-test-suite.cc</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If a flag prevents your compiler from compiling, wrap the flag inside a
compiler check. The currently checked compilers are <code class="docutils literal notranslate"><span class="pre">GCC</span></code> and <code class="docutils literal notranslate"><span class="pre">CLANG</span></code>
(includes both upstream LLVM Clang and Apple Clang).</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="o">${</span><span class="nv">FAILING_COMPILER</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">add_compile_options</span><span class="p">(</span><span class="s">-Wno-stringop-truncation</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="c"># or</span>

<span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">ONLY_COMPILER_THAT_SUPPORTS_UNIQUE_FLAG</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">add_compile_options</span><span class="p">(</span><span class="s">-unique_flag</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="ccache-and-precompiled-headers">
<h4><span class="section-number">4.3.8. </span>CCache and Precompiled Headers<a class="headerlink" href="#ccache-and-precompiled-headers" title="Link to this heading">¶</a></h4>
<p>There are a few ways of speeding up the build of <em>ns-3</em> and its modules.
Partially rebuilding only changed modules is one of the ways, and
this is already handled by the build system.</p>
<p>However, cleaning up the build and cmake cache directories removes
the intermediate and final files that could be used to skip the build
of unchanged modules.</p>
<p>In this case, <a class="reference external" href="https://ccache.dev/">CCache</a> is recommended. It acts as a compiler and stores the
intermediate and final object files and libraries on a cache artifact directory.</p>
<p>Note: for ease of use, CCache is enabled by default if found by the build system.</p>
<p>The cache artifact directory of CCACHE can be set by changing the
<code class="docutils literal notranslate"><span class="pre">CCACHE_BASEDIR</span></code> environment variable.</p>
<p>The CCache artifact cache is separated per directory, to prevent incompatible
artifacts, which may depend on different working directories <code class="docutils literal notranslate"><span class="pre">CWD</span></code> to work properly
from getting mixed and producing binaries that will start running from a different directory.</p>
<p>Note: to reuse CCache artifacts from different directories,
set the <code class="docutils literal notranslate"><span class="pre">CCACHE_NOHASHDIR</span></code> environment variable to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
<p>A different way of speeding up builds is by using Precompiled Headers (<a class="reference external" href="https://gcc.gnu.org/onlinedocs/gcc/Precompiled-Headers.html">PCHs</a>).
PCHs drastically reduce parsing times of C and C++ headers by precompiling their symbols,
which are imported instead of re-parsing the same headers again and again,
for each compilation unit (.cc file).</p>
<p>Note: for ease of use, PCH is enabled by default if supported. It can be manually disabled
by setting <code class="docutils literal notranslate"><span class="pre">NS3_PRECOMPILE_HEADERS</span></code> to <code class="docutils literal notranslate"><span class="pre">OFF</span></code>.</p>
<section id="setting-up-and-adding-new-headers-to-the-pch">
<h5><span class="section-number">4.3.8.1. </span>Setting up and adding new headers to the PCH<a class="headerlink" href="#setting-up-and-adding-new-headers-to-the-pch" title="Link to this heading">¶</a></h5>
<p>When both CCache and PCH are used together, there is a set of settings that must be
properly configured, otherwise timestamps built into the PCH can invalidate the CCache
artifacts, forcing a new build of unmodified modules/programs.</p>
<p>Compiler settings required by PCH and CCache are set in the PCH block in macros-and-definitions.cmake.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">PRECOMPILE_HEADERS_ENABLED</span><span class="o">}</span><span class="p">)</span>
<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="s">CLANG</span><span class="p">)</span>
<span class="w">    </span><span class="c"># Clang adds a timestamp to the PCH, which prevents ccache from working</span>
<span class="w">    </span><span class="c"># correctly</span>
<span class="w">    </span><span class="c"># https://github.com/ccache/ccache/issues/539#issuecomment-664198545</span>
<span class="w">    </span><span class="nb">add_definitions</span><span class="p">(</span><span class="s">-Xclang</span><span class="w"> </span><span class="s">-fno-pch-timestamp</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="nb">if</span><span class="p">(</span><span class="o">${</span><span class="nv">XCODE</span><span class="o">}</span><span class="p">)</span>
<span class="w">    </span><span class="c"># XCode is weird and messes up with the PCH, requiring this flag</span>
<span class="w">    </span><span class="c"># https://github.com/ccache/ccache/issues/156</span>
<span class="w">    </span><span class="nb">add_definitions</span><span class="p">(</span><span class="s">-Xclang</span><span class="w"> </span><span class="s">-fno-validate-pch</span><span class="p">)</span>
<span class="w">  </span><span class="nb">endif</span><span class="p">()</span>

<span class="w">  </span><span class="c"># Headers that will be compiled into the PCH</span>
<span class="w">  </span><span class="c"># Only worth for frequently included headers</span>
<span class="w">  </span><span class="nb">set</span><span class="p">(</span><span class="s">precompiled_header_libraries</span>
<span class="w">      </span><span class="s">&lt;algorithm&gt;</span>
<span class="w">      </span><span class="s">&lt;cstdlib&gt;</span>
<span class="w">      </span><span class="s">&lt;cstring&gt;</span>
<span class="w">      </span><span class="s">&lt;exception&gt;</span>
<span class="w">      </span><span class="s">&lt;fstream&gt;</span>
<span class="w">      </span><span class="s">&lt;iostream&gt;</span>
<span class="w">      </span><span class="s">&lt;limits&gt;</span>
<span class="w">      </span><span class="s">&lt;list&gt;</span>
<span class="w">      </span><span class="s">&lt;map&gt;</span>
<span class="w">      </span><span class="s">&lt;math.h&gt;</span>
<span class="w">      </span><span class="s">&lt;ostream&gt;</span>
<span class="w">      </span><span class="s">&lt;set&gt;</span>
<span class="w">      </span><span class="s">&lt;sstream&gt;</span>
<span class="w">      </span><span class="s">&lt;stdint.h&gt;</span>
<span class="w">      </span><span class="s">&lt;stdlib.h&gt;</span>
<span class="w">      </span><span class="s">&lt;string&gt;</span>
<span class="w">      </span><span class="s">&lt;unordered_map&gt;</span>
<span class="w">      </span><span class="s">&lt;vector&gt;</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># PCHs can be reused by similar targets (libraries or executables)</span>
<span class="w">  </span><span class="c"># We have a PCH for libraries, compiled with the -fPIC flag</span>
<span class="w">  </span><span class="nb">add_library</span><span class="p">(</span><span class="s">stdlib_pch</span><span class="w"> </span><span class="s">OBJECT</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/build-support/empty.cc</span><span class="p">)</span>
<span class="w">  </span><span class="nb">target_precompile_headers</span><span class="p">(</span>
<span class="w">    </span><span class="s">stdlib_pch</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="s2">&quot;${precompiled_header_libraries}&quot;</span>
<span class="w">  </span><span class="p">)</span>

<span class="w">  </span><span class="c"># And another PCH for executables, compiled with the -fPIE flag</span>
<span class="w">  </span><span class="nb">add_executable</span><span class="p">(</span>
<span class="w">    </span><span class="s">stdlib_pch_exec</span><span class="w"> </span><span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/build-support/empty-main.cc</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nb">target_precompile_headers</span><span class="p">(</span>
<span class="w">    </span><span class="s">stdlib_pch_exec</span><span class="w"> </span><span class="s">PUBLIC</span><span class="w"> </span><span class="s2">&quot;${precompiled_header_libraries}&quot;</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="nb">set_runtime_outputdirectory</span><span class="p">(</span><span class="s">stdlib_pch_exec</span><span class="w"> </span><span class="o">${</span><span class="nv">CMAKE_BINARY_DIR</span><span class="o">}</span><span class="s">/</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>The CCache settings required to work with PCH are set in the main CMakeLists.txt file:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># Use ccache if available</span>
<span class="nb">mark_as_advanced</span><span class="p">(</span><span class="s">CCACHE</span><span class="p">)</span>
<span class="nb">find_program</span><span class="p">(</span><span class="s">CCACHE</span><span class="w"> </span><span class="s">ccache</span><span class="p">)</span>
<span class="nb">if</span><span class="p">(</span><span class="s">NOT</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;${CCACHE}&quot;</span><span class="w"> </span><span class="s">STREQUAL</span><span class="w"> </span><span class="s2">&quot;CCACHE-NOTFOUND&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="nb">set_property</span><span class="p">(</span><span class="s">GLOBAL</span><span class="w"> </span><span class="s">PROPERTY</span><span class="w"> </span><span class="s">RULE_LAUNCH_COMPILE</span><span class="w"> </span><span class="s">ccache</span><span class="p">)</span>
<span class="w">  </span><span class="nb">message</span><span class="p">(</span><span class="s">STATUS</span><span class="w"> </span><span class="s2">&quot;CCache is enabled.&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="c"># Changes user-wide settings from CCache to make it ignore:</span>
<span class="w">  </span><span class="c"># - PCH definitions,</span>
<span class="w">  </span><span class="c"># - time related macros that could bake timestamps into cached artifacts,</span>
<span class="w">  </span><span class="c"># - source file creation and modification timestamps,</span>
<span class="w">  </span><span class="c">#    forcing it to check for content changes instead</span>
<span class="w">  </span><span class="nb">execute_process</span><span class="p">(</span>
<span class="w">    </span><span class="s">COMMAND</span>
<span class="w">      </span><span class="o">${</span><span class="nv">CCACHE</span><span class="o">}</span><span class="w"> </span><span class="s">--set-config</span>
<span class="w">      </span><span class="s">sloppiness=pch_defines,time_macros,include_file_mtime,include_file_ctime</span>
<span class="w">  </span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</div>
<p>Note: you can use the following commands to manually check
and restore the CCache sloppiness settings.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~$ ccache --get-config sloppiness</span>
<span class="go">include_file_mtime, include_file_ctime, time_macros, pch_defines</span>
<span class="go">~$ ccache --set-config sloppiness=&quot;&quot;</span>
<span class="go">~$ ccache --get-config sloppiness</span>

<span class="go">~$</span>
</pre></div>
</div>
<p>The PCHs can be reused later with one of the following.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_library</span><span class="p">(</span><span class="s">example_lib</span><span class="w"> </span><span class="s">example_lib.cc</span><span class="p">)</span>
<span class="nb">target_precompile_headers</span><span class="p">(</span><span class="s">example_lib</span><span class="w"> </span><span class="s">REUSE_FROM</span><span class="w"> </span><span class="s">stdlib_pch</span><span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span><span class="s">example_exec</span><span class="w"> </span><span class="s">example_exec.cc</span><span class="p">)</span>
<span class="nb">target_precompile_headers</span><span class="p">(</span><span class="s">example_exec</span><span class="w"> </span><span class="s">REUSE_FROM</span><span class="w"> </span><span class="s">stdlib_pch_exec</span><span class="p">)</span>
</pre></div>
</div>
<p>If if you have problems with the build times when the PCH is enabled,
you can diagnose issues with CCache by clearing the cache statistics (<code class="docutils literal notranslate"><span class="pre">ccache</span> <span class="pre">-z</span></code>),
then cleaning, configuring, building, and finally printing the CCache statistics (<code class="docutils literal notranslate"><span class="pre">ccache</span> <span class="pre">-s</span></code>).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ccache -z</span>
<span class="go">./ns3 clean</span>
<span class="go">./ns3 configure</span>
<span class="go">./ns3 build</span>
<span class="go">ccache -s</span>
</pre></div>
</div>
<p>If you have changed any compiler flag, the cache hit rate should be very low.
Repeat the same commands once more.
If the cache hit rate is at 100%, it means everything is working as it should.</p>
</section>
<section id="possible-side-effects-fixes-and-ignore-pch">
<span id="pch-side-effects"></span><h5><span class="section-number">4.3.8.2. </span>Possible side-effects, fixes and IGNORE_PCH<a class="headerlink" href="#possible-side-effects-fixes-and-ignore-pch" title="Link to this heading">¶</a></h5>
<p>Precompiled headers can cause symbol collisions due to includes reordering or unwanted includes,
which can lead to attempts to redefine functions, macros, types or variables.
An example of such side-effect is shown below.</p>
<p>In order to exemplify how precompiled headers can cause issues, assume the following inclusion order from
<code class="docutils literal notranslate"><span class="pre">ns-3-dev/src/aodv/model/aodv-routing-protocol.cc</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="cp">#define NS_LOG_APPEND_CONTEXT                                   \</span>
<span class="cp">if (m_ipv4) { std::clog &lt;&lt; &quot;[node &quot; &lt;&lt; m_ipv4-&gt;GetObject&lt;Node&gt; ()-&gt;GetId () &lt;&lt; &quot;] &quot;; }</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;aodv-routing-protocol.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/log.h&quot;</span>
<span class="p">...</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">NS_LOG_APPEND_CONTEXT</span></code> macro definition comes before the <code class="docutils literal notranslate"><span class="pre">ns3/log.h</span></code> inclusion,
and that is the expected way of using <code class="docutils literal notranslate"><span class="pre">NS_LOG_APPEND_CONTEXT</span></code>, since we have the following
guards on <code class="docutils literal notranslate"><span class="pre">ns3/log-macros-enabled.h</span></code>, which is included by <code class="docutils literal notranslate"><span class="pre">ns3/log.h</span></code> when logs are enabled.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="cp">#ifndef NS_LOG_APPEND_CONTEXT</span>
<span class="cp">#define NS_LOG_APPEND_CONTEXT</span>
<span class="cp">#endif </span><span class="cm">/* NS_LOG_APPEND_CONTEXT */</span>
<span class="p">...</span>
</pre></div>
</div>
<p>By adding <code class="docutils literal notranslate"><span class="pre">&lt;ns3/log.h&gt;</span></code> to the list of headers to precompile (<code class="docutils literal notranslate"><span class="pre">precompiled_header_libraries</span></code>)
in <code class="docutils literal notranslate"><span class="pre">ns-3-dev/build-support/macros-and-definitions.cmake</span></code>, the <code class="docutils literal notranslate"><span class="pre">ns3/log.h</span></code> header will
now be part of the PCH, which gets included before any parsing of the code is done.
This means the equivalent inclusion order would be different than what was originally intended,
as shown below:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cmake_pch.hxx&quot;</span><span class="c1"> // PCH includes ns3/log.h before defining ``NS_LOG_APPEND_CONTEXT`` below</span>
<span class="p">...</span>
<span class="cp">#define NS_LOG_APPEND_CONTEXT                                   \</span>
<span class="cp">if (m_ipv4) { std::clog &lt;&lt; &quot;[node &quot; &lt;&lt; m_ipv4-&gt;GetObject&lt;Node&gt; ()-&gt;GetId () &lt;&lt; &quot;] &quot;; }</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;aodv-routing-protocol.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/log.h&quot;</span><span class="c1"> // isn&#39;t processed since ``NS3_LOG_H`` was already defined by the PCH</span>
<span class="p">...</span>
</pre></div>
</div>
<p>While trying to build with the redefined symbols in the debug build, where warnings are treated
as errors, the build may fail with an error similar to the following from GCC 11.2:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">FAILED: src/aodv/CMakeFiles/libaodv-obj.dir/model/aodv-routing-protocol.cc.o</span>
<span class="go">ccache /usr/bin/c++ ... -DNS3_LOG_ENABLE -Wall -Werror -include /ns-3-dev/cmake-build-debug/CMakeFiles/stdlib_pch.dir/cmake_pch.hxx</span>
<span class="go">/ns-3-dev/src/aodv/model/aodv-routing-protocol.cc:28: error: &quot;NS_LOG_APPEND_CONTEXT&quot; redefined [-Werror]</span>
<span class="go">   28 | #define NS_LOG_APPEND_CONTEXT                                   \</span>
<span class="go">      |</span>
<span class="go">In file included from /ns-3-dev/src/core/model/log.h:32,</span>
<span class="go">                 from /ns-3-dev/src/core/model/fatal-error.h:29,</span>
<span class="go">                 from /ns-3-dev/build/include/ns3/assert.h:56,</span>
<span class="go">                 from /ns-3-dev/build/include/ns3/buffer.h:26,</span>
<span class="go">                 from /ns-3-dev/build/include/ns3/packet.h:24,</span>
<span class="go">                 from /ns-3-dev/cmake-build-debug/CMakeFiles/stdlib_pch.dir/cmake_pch.hxx:23,</span>
<span class="go">                 from &lt;command-line&gt;:</span>
<span class="go">/ns-3-dev/src/core/model/log-macros-enabled.h:146: note: this is the location of the previous definition</span>
<span class="go">  146 | #define NS_LOG_APPEND_CONTEXT</span>
<span class="go">      |</span>
<span class="go">cc1plus: all warnings being treated as errors</span>
</pre></div>
</div>
<p>One of the ways to fix this issue in particular is undefining <code class="docutils literal notranslate"><span class="pre">NS_LOG_APPEND_CONTEXT</span></code> before redefining it in
<code class="docutils literal notranslate"><span class="pre">/ns-3-dev/src/aodv/model/aodv-routing-protocol.cc</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cmake_pch.hxx&quot;</span><span class="c1"> // PCH includes ns3/log.h before defining NS_LOG_APPEND_CONTEXT below</span>
<span class="p">...</span>
<span class="cp">#undef NS_LOG_APPEND_CONTEXT </span><span class="c1">// undefines symbol previously defined in the PCH</span>
<span class="cp">#define NS_LOG_APPEND_CONTEXT                                   \</span>
<span class="cp">if (m_ipv4) { std::clog &lt;&lt; &quot;[node &quot; &lt;&lt; m_ipv4-&gt;GetObject&lt;Node&gt; ()-&gt;GetId () &lt;&lt; &quot;] &quot;; }</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;aodv-routing-protocol.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/log.h&quot;</span><span class="c1"> // isn&#39;t processed since ``NS3_LOG_H`` was already defined by the PCH</span>
<span class="p">...</span>
</pre></div>
</div>
<p>If the <code class="docutils literal notranslate"><span class="pre">IGNORE_PCH</span></code> option is set in the <a class="reference internal" href="#build-lib">build_lib</a>, <a class="reference internal" href="#build-lib-example">build_lib_example</a>, <a class="reference internal" href="#build-exec">build_exec</a> and the <a class="reference internal" href="#build-example">build_example</a>
macros, the PCH is not included in their targets, continuing to build as we normally would without the PCH.
This is only a workaround for the issue, which can be helpful when the same macro names, class names,
global variables and others are redefined by different components that can’t be modified safely.</p>
</section>
</section>
</section>
<span id="document-logging-asserts"></span><section id="logging">
<h3><span class="section-number">4.4. </span>Logging<a class="headerlink" href="#logging" title="Link to this heading">¶</a></h3>
<p>The <em>ns-3</em> logging facility can be used to monitor or debug the progress
of simulation programs.  Logging output can be enabled by program statements
in your <code class="docutils literal notranslate"><span class="pre">main()</span></code> program or by the use of the <code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code> environment variable.</p>
<p>Logging statements are not compiled into <code class="docutils literal notranslate"><span class="pre">optimized</span></code> builds of <em>ns-3</em>.  To use
logging, one must use the <code class="docutils literal notranslate"><span class="pre">default</span></code> or <code class="docutils literal notranslate"><span class="pre">debug</span></code> build profiles of <em>ns-3</em>.</p>
<p>The project makes no guarantee about whether logging output will remain
the same over time.  Users are cautioned against building simulation output
frameworks on top of logging code, as the output and the way the output
is enabled may change over time.</p>
<section id="overview">
<h4><span class="section-number">4.4.1. </span>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h4>
<p><em>ns-3</em> logging statements are typically used to log various program
execution events, such as the occurrence of simulation events or the
use of a particular function.</p>
<p>For example, this code snippet is from <code class="docutils literal notranslate"><span class="pre">TcpSocketBase::EnterCwr()</span></code> and informs the user that
the model is reducing the congestion window and changing state:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NS_LOG_INFO</span><span class="p">(</span><span class="s">&quot;Enter CWR recovery mode; set cwnd to &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">m_tcb</span><span class="o">-&gt;</span><span class="n">m_cWnd</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, ssthresh to &quot;</span>
<span class="w">                                                    </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">m_tcb</span><span class="o">-&gt;</span><span class="n">m_ssThresh</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, recover to &quot;</span>
<span class="w">                                                    </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">m_recover</span><span class="p">);</span>
</pre></div>
</div>
<p>If logging has been enabled for the <code class="docutils literal notranslate"><span class="pre">Ipv4L3Protocol</span></code> component at a severity
of <code class="docutils literal notranslate"><span class="pre">INFO</span></code> or above (see below about log severity), the statement
will be printed out; otherwise, it will be suppressed.</p>
<p>The logging implementation is enabled in <code class="docutils literal notranslate"><span class="pre">debug</span></code> and <code class="docutils literal notranslate"><span class="pre">default</span></code>
builds, but disabled in all other build profiles,
so that it does not impact the execution speed of more optimized profiles.</p>
<p>You can try the example program <cite>log-example.cc</cite> in <cite>src/core/example</cite>
with various values for the <cite>NS_LOG</cite> environment variable to see the
effect of the options discussed below.</p>
</section>
<section id="enabling-output">
<h4><span class="section-number">4.4.2. </span>Enabling Output<a class="headerlink" href="#enabling-output" title="Link to this heading">¶</a></h4>
<p>There are two ways that users typically control log output.  The
first is by setting the <code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code> environment variable; e.g.:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>first
</pre></div>
</div>
<p>will run the <code class="docutils literal notranslate"><span class="pre">first</span></code> tutorial program with all logging output.  (The
specifics of the <code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code> format will be discussed below.)</p>
<p>This can be made more granular by selecting individual components:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;Ipv4L3Protocol&quot;</span><span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>first
</pre></div>
</div>
<p>The output can be further tailored with prefix options.</p>
<p>The second way to enable logging is to use explicit statements in your
program, such as in the <code class="docutils literal notranslate"><span class="pre">first</span></code> tutorial program:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">LogComponentEnable</span><span class="p">(</span><span class="s">&quot;UdpEchoClientApplication&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">LOG_LEVEL_INFO</span><span class="p">);</span>
<span class="w">  </span><span class="n">LogComponentEnable</span><span class="p">(</span><span class="s">&quot;UdpEchoServerApplication&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">LOG_LEVEL_INFO</span><span class="p">);</span>
<span class="w">  </span><span class="p">...</span>
</pre></div>
</div>
<p>(The meaning of <code class="docutils literal notranslate"><span class="pre">LOG_LEVEL_INFO</span></code>, and other possible values,
will be discussed below.)</p>
</section>
<section id="ns-log-syntax">
<h4><span class="section-number">4.4.3. </span><code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code> Syntax<a class="headerlink" href="#ns-log-syntax" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code> environment variable contains a list of log components
and options.  Log components are separated by `:’ characters:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;&lt;log-component&gt;:&lt;log-component&gt;...&quot;</span>
</pre></div>
</div>
<p>Options for each log component are given as flags after
each log component:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;&lt;log-component&gt;=&lt;option&gt;|&lt;option&gt;...:&lt;log-component&gt;...&quot;</span>
</pre></div>
</div>
<p>Options control the severity and level for that component,
and whether optional information should be included, such as the
simulation time, simulation node, function name, and the symbolic severity.</p>
<section id="log-components">
<h5><span class="section-number">4.4.3.1. </span>Log Components<a class="headerlink" href="#log-components" title="Link to this heading">¶</a></h5>
<p>Generally a log component refers to a single source code <code class="docutils literal notranslate"><span class="pre">.cc</span></code> file,
and encompasses the entire file.</p>
<p>Some helpers have special methods to enable the logging of all components
in a module, spanning different compilation units, but logically grouped
together, such as the <em>ns-3</em> wifi code:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">WifiHelper</span><span class="w"> </span><span class="n">wifiHelper</span><span class="p">;</span>
<span class="n">wifiHelper</span><span class="p">.</span><span class="n">EnableLogComponents</span><span class="p">();</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code> log component wildcard `*’ will enable all components.</p>
<p>To see what log components are defined, any of these will work:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;print-list&quot;</span><span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>...

$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span><span class="w">  </span><span class="c1"># a token not matching any log-component</span>
</pre></div>
</div>
<p>The first form will print the name and enabled flags for all log components
which are linked in; try it with <code class="docutils literal notranslate"><span class="pre">scratch-simulator</span></code>.
The second form prints all registered log components,
then exit with an error.</p>
</section>
<section id="severity-and-level-options">
<h5><span class="section-number">4.4.3.2. </span>Severity and Level Options<a class="headerlink" href="#severity-and-level-options" title="Link to this heading">¶</a></h5>
<p>Individual messages belong to a single “severity class,” set by the macro
creating the message.  In the example above,
<code class="docutils literal notranslate"><span class="pre">NS_LOG_INFO(..)</span></code> creates the message in the <code class="docutils literal notranslate"><span class="pre">LOG_INFO</span></code> severity class.</p>
<p>The following severity classes are defined as <code class="docutils literal notranslate"><span class="pre">enum</span></code> constants:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Severity Class</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_NONE</span></code></p></td>
<td><p>The default, no logging</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_ERROR</span></code></p></td>
<td><p>Serious error messages only</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_WARN</span></code></p></td>
<td><p>Warning messages</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_INFO</span></code></p></td>
<td><p>Info about the model changing state</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_FUNCTION</span></code></p></td>
<td><p>Function tracing</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_LOGIC</span></code></p></td>
<td><p>For tracing key decision points or branches in a function</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_DEBUG</span></code></p></td>
<td><p>For use in debugging</p></td>
</tr>
</tbody>
</table>
<p>Typically one wants to see messages at a given severity class <em>and higher</em>.
This is done by defining inclusive logging “levels”:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Level</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_LEVEL_ERROR</span></code></p></td>
<td><p>Only <code class="docutils literal notranslate"><span class="pre">LOG_ERROR</span></code> severity class messages.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_LEVEL_WARN</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">LOG_WARN</span></code> and above.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_LEVEL_INFO</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">LOG_INFO</span></code> and above.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_LEVEL_FUNCTION</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">LOG_FUNCTION</span></code> and above.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_LEVEL_LOGIC</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">LOG_LOGIC</span></code> and above.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_LEVEL_DEBUG</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">LOG_DEBUG</span></code> and above.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_LEVEL_ALL</span></code></p></td>
<td><p>All severity classes.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_ALL</span></code></p></td>
<td><p>Synonym for <code class="docutils literal notranslate"><span class="pre">LOG_LEVEL_ALL</span></code></p></td>
</tr>
</tbody>
</table>
<p>The severity class and level options can be given in the <code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code>
environment variable by these tokens:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Class</p></th>
<th class="head"><p>Level</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">error</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">level_error</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">warn</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">level_warn</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">info</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">level_info</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">function</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">level_function</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">logic</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">level_logic</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">debug</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">level_debug</span></code></p></td>
</tr>
<tr class="row-even"><td></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">level_all</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">all</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">*</span></code></div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Using a severity class token enables log messages at that severity only.
For example, <code class="docutils literal notranslate"><span class="pre">NS_LOG=&quot;*=warn&quot;</span></code> won’t output messages with severity <code class="docutils literal notranslate"><span class="pre">error</span></code>.
<code class="docutils literal notranslate"><span class="pre">NS_LOG=&quot;*=level_debug&quot;</span></code> will output messages at severity levels
<code class="docutils literal notranslate"><span class="pre">debug</span></code> and above.</p>
<p>Severity classes and levels can be combined with the `|’ operator:
<code class="docutils literal notranslate"><span class="pre">NS_LOG=&quot;*=level_warn|debug&quot;</span></code> will output messages at severity levels
<code class="docutils literal notranslate"><span class="pre">error</span></code>, <code class="docutils literal notranslate"><span class="pre">warn</span></code> and <code class="docutils literal notranslate"><span class="pre">debug</span></code>, but not <code class="docutils literal notranslate"><span class="pre">info</span></code>, <code class="docutils literal notranslate"><span class="pre">function</span></code>, or <code class="docutils literal notranslate"><span class="pre">logic</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code> severity level wildcard `*’ and <code class="docutils literal notranslate"><span class="pre">all</span></code>
are synonyms for <code class="docutils literal notranslate"><span class="pre">level_all</span></code>.</p>
<p>For log components merely mentioned in <code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;&lt;log-component&gt;:...&quot;</span>
</pre></div>
</div>
<p>the default severity is <code class="docutils literal notranslate"><span class="pre">LOG_LEVEL_ALL</span></code>.</p>
</section>
<section id="prefix-options">
<h5><span class="section-number">4.4.3.3. </span>Prefix Options<a class="headerlink" href="#prefix-options" title="Link to this heading">¶</a></h5>
<p>A number of prefixes can help identify
where and when a message originated, and at what severity.</p>
<p>The available prefix options (as <code class="docutils literal notranslate"><span class="pre">enum</span></code> constants) are</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Prefix Symbol</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_PREFIX_FUNC</span></code></p></td>
<td><p>Prefix the name of the calling function.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_PREFIX_TIME</span></code></p></td>
<td><p>Prefix the simulation time.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_PREFIX_NODE</span></code></p></td>
<td><p>Prefix the node id.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_PREFIX_LEVEL</span></code></p></td>
<td><p>Prefix the severity level.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_PREFIX_ALL</span></code></p></td>
<td><p>Enable all prefixes.</p></td>
</tr>
</tbody>
</table>
<p>The prefix options are described briefly below.</p>
<p>The options can be given in the <code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code>
environment variable by these tokens:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Token</p></th>
<th class="head"><p>Alternate</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">prefix_func</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">func</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">prefix_time</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">time</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">prefix_node</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">node</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">prefix_level</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">level</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">prefix_all</span></code></p></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">all</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">*</span></code></div>
</div>
</td>
</tr>
</tbody>
</table>
<p>For log components merely mentioned in <code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;&lt;log-component&gt;:...&quot;</span>
</pre></div>
</div>
<p>the default prefix options are <code class="docutils literal notranslate"><span class="pre">LOG_PREFIX_ALL</span></code>.</p>
<section id="severity-prefix">
<h6><span class="section-number">4.4.3.3.1. </span>Severity Prefix<a class="headerlink" href="#severity-prefix" title="Link to this heading">¶</a></h6>
<p>The severity class of a message can be included with the options
<code class="docutils literal notranslate"><span class="pre">prefix_level</span></code> or <code class="docutils literal notranslate"><span class="pre">level</span></code>.  For example, this value of <code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code>
enables logging for all log components (`*’) and all severity
classes (<code class="docutils literal notranslate"><span class="pre">=all</span></code>), and prefixes the message with the severity
class (<code class="docutils literal notranslate"><span class="pre">|prefix_level</span></code>).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;*=all|prefix_level&quot;</span><span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>scratch-simulator
Scratch<span class="w"> </span>Simulator
<span class="o">[</span>ERROR<span class="o">]</span><span class="w"> </span>error<span class="w"> </span>message
<span class="o">[</span>WARN<span class="o">]</span><span class="w"> </span>warn<span class="w"> </span>message
<span class="o">[</span>INFO<span class="o">]</span><span class="w"> </span>info<span class="w"> </span>message
<span class="o">[</span>FUNCT<span class="o">]</span><span class="w"> </span><span class="k">function</span><span class="w"> </span>message
<span class="o">[</span>LOGIC<span class="o">]</span><span class="w"> </span>logic<span class="w"> </span>message
<span class="o">[</span>DEBUG<span class="o">]</span><span class="w"> </span>debug<span class="w"> </span>message
</pre></div>
</div>
</section>
<section id="time-prefix">
<h6><span class="section-number">4.4.3.3.2. </span>Time Prefix<a class="headerlink" href="#time-prefix" title="Link to this heading">¶</a></h6>
<p>The simulation time can be included with the options
<code class="docutils literal notranslate"><span class="pre">prefix_time</span></code> or <code class="docutils literal notranslate"><span class="pre">time</span></code>.  This prints the simulation time in seconds.</p>
</section>
<section id="node-prefix">
<h6><span class="section-number">4.4.3.3.3. </span>Node Prefix<a class="headerlink" href="#node-prefix" title="Link to this heading">¶</a></h6>
<p>The simulation node id can be included with the options
<code class="docutils literal notranslate"><span class="pre">prefix_node</span></code> or <code class="docutils literal notranslate"><span class="pre">node</span></code>.</p>
</section>
<section id="function-prefix">
<h6><span class="section-number">4.4.3.3.4. </span>Function Prefix<a class="headerlink" href="#function-prefix" title="Link to this heading">¶</a></h6>
<p>The name of the calling function can be included with the options
<code class="docutils literal notranslate"><span class="pre">prefix_func</span></code> or <code class="docutils literal notranslate"><span class="pre">func</span></code>.</p>
</section>
</section>
<section id="ns-log-wildcards">
<h5><span class="section-number">4.4.3.4. </span><code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code> Wildcards<a class="headerlink" href="#ns-log-wildcards" title="Link to this heading">¶</a></h5>
<p>The log component wildcard `*’ will enable all components.  To
enable all components at a specific severity level
use <code class="docutils literal notranslate"><span class="pre">*=&lt;severity&gt;</span></code>.</p>
<p>The severity level option wildcard `*’ is a synonym for <code class="docutils literal notranslate"><span class="pre">all</span></code>.
This must occur before any `|’ characters separating options.
To enable all severity classes, use <code class="docutils literal notranslate"><span class="pre">&lt;log-component&gt;=*</span></code>,
or <code class="docutils literal notranslate"><span class="pre">&lt;log-component&gt;=*|&lt;options&gt;</span></code>.</p>
<p>The option wildcard `*’ or token <code class="docutils literal notranslate"><span class="pre">all</span></code> enables all prefix options,
but must occur <em>after</em> a `|’ character.  To enable a specific
severity class or level, and all prefixes, use
<code class="docutils literal notranslate"><span class="pre">&lt;log-component&gt;=&lt;severity&gt;|*</span></code>.</p>
<p>The combined option wildcard <code class="docutils literal notranslate"><span class="pre">**</span></code> enables all severities and all prefixes;
for example, <code class="docutils literal notranslate"><span class="pre">&lt;log-component&gt;=**</span></code>.</p>
<p>The uber-wildcard <code class="docutils literal notranslate"><span class="pre">***</span></code> enables all severities and all prefixes
for all log components.  These are all equivalent:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;***&quot;</span><span class="w"> </span>...<span class="w">      </span>$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;*=all|*&quot;</span><span class="w"> </span>...<span class="w">        </span>$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;*=*|all&quot;</span><span class="w"> </span>...
$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;*=**&quot;</span><span class="w"> </span>...<span class="w">     </span>$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;*=level_all|*&quot;</span><span class="w"> </span>...<span class="w">  </span>$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;*=*|prefix_all&quot;</span><span class="w"> </span>...
$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;*=*|*&quot;</span><span class="w"> </span>...
</pre></div>
</div>
<p>Be advised:  even the trivial <code class="docutils literal notranslate"><span class="pre">scratch-simulator</span></code> produces over
46K lines of output with <code class="docutils literal notranslate"><span class="pre">NS_LOG=&quot;***&quot;</span></code>!</p>
</section>
</section>
<section id="how-to-add-logging-to-your-code">
<h4><span class="section-number">4.4.4. </span>How to add logging to your code<a class="headerlink" href="#how-to-add-logging-to-your-code" title="Link to this heading">¶</a></h4>
<p>Adding logging to your code is very simple:</p>
<ol class="arabic simple">
<li><p>Invoke the <code class="docutils literal notranslate"><span class="pre">NS_LOG_COMPONENT_DEFINE(...);</span></code> macro
inside of <code class="docutils literal notranslate"><span class="pre">namespace</span> <span class="pre">ns3</span></code>.</p></li>
</ol>
<blockquote>
<div><p>Create a unique string identifier (usually based on the name of the file
and/or class defined within the file) and register it with a macro call
such as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">ns3</span><span class="w"> </span><span class="p">{</span>

<span class="n">NS_LOG_COMPONENT_DEFINE</span><span class="p">(</span><span class="s">&quot;Ipv4L3Protocol&quot;</span><span class="p">);</span>
<span class="p">...</span>
</pre></div>
</div>
<p>This registers <code class="docutils literal notranslate"><span class="pre">Ipv4L3Protocol</span></code> as a log component.</p>
<p>(The macro was carefully written to permit inclusion either within or
outside of namespace <code class="docutils literal notranslate"><span class="pre">ns3</span></code>, and usage will vary across the codebase, but
the original intent was to register this <em>outside</em> of namespace <code class="docutils literal notranslate"><span class="pre">ns3</span></code>
at file global scope.)</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Add logging statements (macro calls) to your functions and function bodies.</p></li>
</ol>
<p>In case you want to add logging statements to the methods of your template class
(which are defined in an header file):</p>
<ol class="arabic simple">
<li><p>Invoke the <code class="docutils literal notranslate"><span class="pre">NS_LOG_TEMPLATE_DECLARE;</span></code> macro in the private section of
your class declaration. For instance:</p></li>
</ol>
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Item</span><span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Queue</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">QueueBase</span>
<span class="p">{</span>
<span class="p">...</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">m_packets</span><span class="p">;</span><span class="w">           </span><span class="c1">//!&lt; the items in the queue</span>
<span class="w">  </span><span class="n">NS_LOG_TEMPLATE_DECLARE</span><span class="p">;</span><span class="w">                  </span><span class="c1">//!&lt; the log component</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This requires you to perform these steps for all the subclasses of your class.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Invoke the <code class="docutils literal notranslate"><span class="pre">NS_LOG_TEMPLATE_DEFINE(...);</span></code> macro in the constructor of
your class by providing the name of a log component registered by calling
the <code class="docutils literal notranslate"><span class="pre">NS_LOG_COMPONENT_DEFINE(...);</span></code> macro in some module. For instance:</p></li>
</ol>
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Item</span><span class="o">&gt;</span>
<span class="n">Queue</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;::</span><span class="n">Queue</span><span class="p">()</span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">NS_LOG_TEMPLATE_DEFINE</span><span class="p">(</span><span class="s">&quot;Queue&quot;</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>Add logging statements (macro calls) to the methods of your class.</p></li>
</ol>
<p>In case you want to add logging statements to a static member template
(which is defined in an header file):</p>
<ol class="arabic simple">
<li><p>Invoke the <code class="docutils literal notranslate"><span class="pre">NS_LOG_STATIC_TEMPLATE_DEFINE</span> <span class="pre">(...);</span></code> macro in your static
method by providing the name of a log component registered by calling
the <code class="docutils literal notranslate"><span class="pre">NS_LOG_COMPONENT_DEFINE(...);</span></code> macro in some module. For instance:</p></li>
</ol>
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">Item</span><span class="o">&gt;</span>
<span class="kt">void</span>
<span class="n">NetDeviceQueue</span><span class="o">::</span><span class="n">PacketEnqueued</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Queue</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">queue</span><span class="p">,</span>
<span class="w">                               </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">NetDeviceQueueInterface</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ndqi</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">txq</span><span class="p">,</span><span class="w"> </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">Item</span><span class="o">&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>

<span class="w">  </span><span class="n">NS_LOG_STATIC_TEMPLATE_DEFINE</span><span class="p">(</span><span class="s">&quot;NetDeviceQueueInterface&quot;</span><span class="p">);</span>
<span class="p">...</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Add logging statements (macro calls) to your static method.</p></li>
</ol>
<section id="logging-macros">
<h5><span class="section-number">4.4.4.1. </span>Logging Macros<a class="headerlink" href="#logging-macros" title="Link to this heading">¶</a></h5>
<blockquote>
<div><p>The logging macros and associated severity levels are</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Severity Class</p></th>
<th class="head"><p>Macro</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_NONE</span></code></p></td>
<td><p>(none needed)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_ERROR</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">NS_LOG_ERROR(...);</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_WARN</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">NS_LOG_WARN(...);</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_INFO</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">NS_LOG_INFO(...);</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_FUNCTION</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">NS_LOG_FUNCTION(...);</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_LOGIC</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">NS_LOG_LOGIC(...);</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">LOG_DEBUG</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">NS_LOG_DEBUG(...);</span></code></p></td>
</tr>
</tbody>
</table>
<p>The macros function as output streamers, so anything you can send to
<code class="docutils literal notranslate"><span class="pre">std::cout</span></code>, joined by <code class="docutils literal notranslate"><span class="pre">&lt;&lt;</span></code> operators, is allowed:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">MyClass::Check</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">NS_LOG_FUNCTION</span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">item</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arg</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">NS_LOG_ERROR</span><span class="p">(</span><span class="s">&quot;encountered bad value &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&lt;&lt;</span>
<span class="w">                   </span><span class="s">&quot; while checking &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">NS_LOG_FUNCTION</span></code> automatically inserts a `<code class="docutils literal notranslate"><span class="pre">,</span></code>’
(comma-space) separator between each of its arguments.
This simplifies logging of function arguments;
just concatenate them with <code class="docutils literal notranslate"><span class="pre">&lt;&lt;</span></code> as in the example above.</p>
</div></blockquote>
</section>
<section id="unconditional-logging">
<h5><span class="section-number">4.4.4.2. </span>Unconditional Logging<a class="headerlink" href="#unconditional-logging" title="Link to this heading">¶</a></h5>
<p>As a convenience, the <code class="docutils literal notranslate"><span class="pre">NS_LOG_UNCOND(...);</span></code> macro will always log its
arguments, even if the associated log-component is not enabled at any
severity.  This macro does not use any of the prefix options.  Recall
that logging is only enabled in <code class="docutils literal notranslate"><span class="pre">debug</span></code>, <code class="docutils literal notranslate"><span class="pre">default</span></code> and <code class="docutils literal notranslate"><span class="pre">relwithdebinfo</span></code>
builds, so this macro will only produce output in the same builds.</p>
<p>The <em>ns-3</em> model libraries do not typically use the <code class="docutils literal notranslate"><span class="pre">NS_LOG_UNCOND(...)</span></code> macro;
it is provided for users for assistance with debugging.</p>
</section>
<section id="guidelines">
<h5><span class="section-number">4.4.4.3. </span>Guidelines<a class="headerlink" href="#guidelines" title="Link to this heading">¶</a></h5>
<ul class="simple">
<li><p>Start every significant class method with <code class="docutils literal notranslate"><span class="pre">NS_LOG_FUNCTION(this</span> <span class="pre">&lt;&lt;</span> <span class="pre">args...);</span></code>
This enables easy function call tracing.</p>
<ul>
<li><p>Exception 1:  don’t log operators or explicit copy constructors,
since these will cause infinite recursion and stack overflow.</p></li>
<li><p>Exception 2:  For simple methods such as getters, avoid function
logging because it tends to overload the logging output.</p></li>
<li><p>For methods without arguments use the same form:
<code class="docutils literal notranslate"><span class="pre">NS_LOG_FUNCTION(this);</span></code></p></li>
<li><p>For static functions:</p>
<ul>
<li><p>With arguments use <code class="docutils literal notranslate"><span class="pre">NS_LOG_FUNCTION(...);</span></code> as normal.</p></li>
<li><p>Without arguments use <code class="docutils literal notranslate"><span class="pre">NS_LOG_FUNCTION_NOARGS();</span></code></p></li>
</ul>
</li>
</ul>
</li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">NS_LOG_ERROR</span></code> for serious error conditions that probably
invalidate the simulation execution.  Note that in <em>ns-3</em>, we typically
abort the simulation under such conditions rather than log it as
an error (which might go undetected if the user is not using logging).
The <code class="docutils literal notranslate"><span class="pre">NS_ABORT_MSG_IF/UNLESS(cond,msg)</span></code> macros and variants, as well
as the lower-level <code class="docutils literal notranslate"><span class="pre">NS_FATAL_ERROR(msg)</span></code> macro, can be used to terminate
the simulation with an error message.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">NS_LOG_WARN</span></code> for unusual conditions that are not considered
invalid.  An example might be that some resource has been exhausted
(e.g., the DHCP server has run out of addresses to allocate).
Please give some hints as to the nature of the problem and how
it might be corrected.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">NS_LOG_INFO</span></code> for events that cause a state change in the model.
Avoid using it for logging periodic events that are not causing a
state change (e.g., a Wi-Fi beacon is sent, but all nodes are already
associated to the access point).  Try to be efficient in using it;
for instance, sending a message is usually an important state change event,
but try to capture this event with one single log message at the <code class="docutils literal notranslate"><span class="pre">INFO</span></code>
level rather than multiple.  If multiple log messages are desired to
fully capture the event and all of its consequences,  use <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code> level
for the additional messages.  The intent of this log level is to allow a
user to examine the normal operation of a model without becoming overwhelmed
by the output.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NS_LOG_LOGIC</span></code> is used to trace important logic branches or decision points
within a function, without dumping all details of the variable states,
called function return values, individual iterations, etc.  It may be useful
to think of it as a less granular level of function logging than <code class="docutils literal notranslate"><span class="pre">DEBUG,</span></code>
and may not be used by all models (some authors may choose to only use
<code class="docutils literal notranslate"><span class="pre">DEBUG</span></code> level for full logging).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NS_LOG_DEBUG</span></code> is usually used for full voluminous debugging, and contains
much more information than <code class="docutils literal notranslate"><span class="pre">NS_LOG_INFO</span></code>, such as the detailed execution
logic of functions and the values that variables take within those functions.</p></li>
<li><p>Test that your logging changes do not break the code.
Run some example programs with all log components turned on (e.g.
<code class="docutils literal notranslate"><span class="pre">NS_LOG=&quot;***&quot;</span></code>).</p></li>
<li><p>Use a unary operator (preferred) or an explicit cast for any variable of type uint8_t or int8_t,
e.g., <code class="docutils literal notranslate"><span class="pre">NS_LOG_DEBUG(&quot;Variable</span> <span class="pre">i</span> <span class="pre">is</span> <span class="pre">&quot;</span> <span class="pre">&lt;&lt;</span> <span class="pre">+i);</span></code>.
e.g., <code class="docutils literal notranslate"><span class="pre">NS_LOG_DEBUG(&quot;Variable</span> <span class="pre">i</span> <span class="pre">is</span> <span class="pre">&quot;</span> <span class="pre">&lt;&lt;</span> <span class="pre">static_cast&lt;int&gt;(i));</span></code> or
Without the cast, the integer is interpreted as a char, and the result
will be most likely not in line with the expectations.
This is a well documented C++ ‘feature’.</p></li>
</ul>
</section>
</section>
<section id="controlling-timestamp-precision">
<h4><span class="section-number">4.4.5. </span>Controlling timestamp precision<a class="headerlink" href="#controlling-timestamp-precision" title="Link to this heading">¶</a></h4>
<p>Timestamps are printed out in units of seconds.  When used with the default
<em>ns-3</em> time resolution of nanoseconds, the default timestamp precision is 9
digits, with fixed format, to allow for 9 digits to be consistently printed
to the right of the decimal point.  Example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="mf">0.000123456</span><span class="n">s</span><span class="w"> </span><span class="n">RandomVariableStream</span><span class="o">:</span><span class="n">SetAntithetic</span><span class="p">(</span><span class="mh">0x805040</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>When the <em>ns-3</em> simulation uses higher time resolution such as picoseconds
or femtoseconds, the precision is expanded accordingly; e.g. for picosecond:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="mf">0.000123456789</span><span class="n">s</span><span class="w"> </span><span class="n">RandomVariableStream</span><span class="o">:</span><span class="n">SetAntithetic</span><span class="p">(</span><span class="mh">0x805040</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>When the <em>ns-3</em> simulation uses a time resolution lower than microseconds,
the default C++ precision is used.</p>
<p>An example program at <code class="docutils literal notranslate"><span class="pre">src/core/examples/sample-log-time-format.cc</span></code>
demonstrates how to change the timestamp formatting.</p>
<p>The maximum useful precision is 20 decimal digits, since Time is signed 64
bits.</p>
</section>
<section id="asserts">
<h4><span class="section-number">4.4.6. </span>Asserts<a class="headerlink" href="#asserts" title="Link to this heading">¶</a></h4>
<p>The <em>ns-3</em> assert facility can be used to validate that invariant conditions
are met during execution. If the condition is not met an error message is given
and the program stops, printing the location of the failed assert.</p>
<p>The assert implementation is enabled in <code class="docutils literal notranslate"><span class="pre">debug</span></code> and <code class="docutils literal notranslate"><span class="pre">default</span></code>
builds, but disabled in all other build profiles to improve execution speed.</p>
<section id="how-to-add-asserts-to-your-code">
<h5><span class="section-number">4.4.6.1. </span>How to add asserts to your code<a class="headerlink" href="#how-to-add-asserts-to-your-code" title="Link to this heading">¶</a></h5>
<p>There is only one macro one should use:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NS_ASSERT_MSG</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">condition</span></code> should be the invariant you want to test, as a
boolean expression.  The <code class="docutils literal notranslate"><span class="pre">message</span></code> should explain what the
condition means and/or the possible source of the error.</p>
<p>There is a variant available without a message, <code class="docutils literal notranslate"><span class="pre">NS_ASSERT(condition)</span></code>,
but we recommend using the message variant in ns-3 library code,
as a well-crafted message can help users figure out how to fix the underlying
issue with their script.</p>
<p>In either case if the condition evaluates to <code class="docutils literal notranslate"><span class="pre">false</span></code> the assert will print
an error message to <code class="docutils literal notranslate"><span class="pre">std::cerr</span></code> containing the following
information:</p>
<ul class="simple">
<li><p>Error message: “NS_ASSERT failed, “</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">condition</span></code> expression: “cond=”<code class="docutils literal notranslate"><span class="pre">condition</span></code>”</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">message</span></code>: “msg=”<code class="docutils literal notranslate"><span class="pre">message</span></code>”</p></li>
<li><p>The simulation time and node, as would be printed by logging.
These are printed independent of the flags or prefix set on any
logging component.</p></li>
<li><p>The file and line containing the assert: “file=``file``, line=``line``</p></li>
</ul>
<p>Here is an example which doesn’t assert:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>assert-example
<span class="o">[</span><span class="m">0</span>/2<span class="o">]</span><span class="w"> </span>Re-checking<span class="w"> </span>globbed<span class="w"> </span>directories...
ninja:<span class="w"> </span>no<span class="w"> </span>work<span class="w"> </span>to<span class="w"> </span><span class="k">do</span>.
NS_ASSERT_MSG<span class="w"> </span>example
<span class="w">  </span><span class="k">if</span><span class="w"> </span>an<span class="w"> </span>argument<span class="w"> </span>is<span class="w"> </span>given<span class="w"> </span>this<span class="w"> </span>example<span class="w"> </span>will<span class="w"> </span>assert.
</pre></div>
</div>
<p>and here is an example which does:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>assert-example<span class="w"> </span>--<span class="w"> </span>foo
<span class="o">[</span><span class="m">0</span>/2<span class="o">]</span><span class="w"> </span>Re-checking<span class="w"> </span>globbed<span class="w"> </span>directories...
ninja:<span class="w"> </span>no<span class="w"> </span>work<span class="w"> </span>to<span class="w"> </span><span class="k">do</span>.
NS_ASSERT_MSG<span class="w"> </span>example
<span class="w">  </span><span class="k">if</span><span class="w"> </span>an<span class="w"> </span>argument<span class="w"> </span>is<span class="w"> </span>given<span class="w"> </span>this<span class="w"> </span>example<span class="w"> </span>will<span class="w"> </span>assert.
NS_ASSERT<span class="w"> </span>failed,<span class="w"> </span><span class="nv">cond</span><span class="o">=</span><span class="s2">&quot;argc == 1&quot;</span>,<span class="w"> </span><span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;An argument was given, so we assert&quot;</span>,<span class="w"> </span><span class="nv">file</span><span class="o">=</span>/Users/barnes26/Code/netsim/ns3/repos/ns-3-dev/src/core/examples/assert-example.cc,<span class="w"> </span><span class="nv">line</span><span class="o">=</span><span class="m">44</span>
NS_FATAL,<span class="w"> </span>terminating
terminate<span class="w"> </span>called<span class="w"> </span>without<span class="w"> </span>an<span class="w"> </span>active<span class="w"> </span>exception
Command<span class="w"> </span><span class="s1">&#39;build/debug/src/core/examples/ns3-dev-assert-example-debug foo&#39;</span><span class="w"> </span>died<span class="w"> </span>with<span class="w"> </span>&lt;Signals.SIGABRT:<span class="w"> </span><span class="m">6</span>&gt;.
</pre></div>
</div>
<p>You can try the example program <cite>assert-example.cc</cite> in <cite>src/core/example</cite>
with or without arguments to see the action of <code class="docutils literal notranslate"><span class="pre">NS_ASSERT_MSG</span></code>.</p>
</section>
</section>
</section>
<span id="document-tests"></span><section id="tests">
<h3><span class="section-number">4.5. </span>Tests<a class="headerlink" href="#tests" title="Link to this heading">¶</a></h3>
<div class="toctree-wrapper compound">
<span id="document-test-overview"></span><section id="overview">
<h4><span class="section-number">4.5.1. </span>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h4>
<p>This chapter is concerned with the testing and validation of <em>ns-3</em> software.</p>
<p>This chapter provides</p>
<ul class="simple">
<li><p>background about terminology and software testing</p></li>
<li><p>a description of the ns-3 testing framework</p></li>
<li><p>a guide to model developers or new model contributors for how to write tests</p></li>
</ul>
</section>
<span id="document-test-background"></span><section id="background">
<h4><span class="section-number">4.5.2. </span>Background<a class="headerlink" href="#background" title="Link to this heading">¶</a></h4>
<p><strong>This chapter may be skipped by readers familiar with the basics of
software testing.</strong></p>
<p>Writing defect-free software is a difficult proposition.  There are many
dimensions to the problem and there is much confusion regarding what is
meant by different terms in different contexts.  We have found it worthwhile
to spend a little time reviewing the subject and defining some terms.</p>
<p>Software testing may be loosely defined as the process of executing a program
with the intent of finding errors.  When one enters a discussion regarding
software testing, it quickly becomes apparent that there are many distinct
mind-sets with which one can approach the subject.</p>
<p>For example, one could break the process into broad functional categories
like ‘’correctness testing,’’ ‘’performance testing,’’ ‘’robustness testing’’
and ‘’security testing.’’  Another way to look at the problem is by life-cycle:
‘’requirements testing,’’ ‘’design testing,’’ ‘’acceptance testing,’’ and
‘’maintenance testing.’’  Yet another view is by the scope of the tested system.
In this case one may speak of ‘’unit testing,’’ ‘’component testing,’’
‘’integration testing,’’ and ‘’system testing.’’  These terms are also not
standardized in any way, and so ‘’maintenance testing’’ and ‘’regression
testing’’ may be heard interchangeably.  Additionally, these terms are often
misused.</p>
<p>There are also a number of different philosophical approaches to software
testing.  For example, some organizations advocate writing test programs
before actually implementing the desired software, yielding ‘’test-driven
development.’’  Some organizations advocate testing from a customer perspective
as soon as possible, following a parallel with the agile development process:
‘’test early and test often.’’  This is sometimes called ‘’agile testing.’’  It
seems that there is at least one approach to testing for every development
methodology.</p>
<p>The <em>ns-3</em> project is not in the business of advocating for any one of
these processes, but the project as a whole has requirements that help inform
the test process.</p>
<p>Like all major software products, <em>ns-3</em> has a number of qualities that
must be present for the product to succeed.  From a testing perspective, some
of these qualities that must be addressed are that <em>ns-3</em> must be
‘’correct,’’ ‘’robust,’’  ‘’performant’’ and ‘’maintainable.’’  Ideally there
should be metrics for each of these dimensions that are checked by the tests
to identify when the product fails to meet its expectations / requirements.</p>
<section id="correctness">
<h5><span class="section-number">4.5.2.1. </span>Correctness<a class="headerlink" href="#correctness" title="Link to this heading">¶</a></h5>
<p>The essential purpose of testing is to determine that a piece of software
behaves ‘’correctly.’’  For <em>ns-3</em> this means that if we simulate
something, the simulation should faithfully represent some physical entity or
process to a specified accuracy and precision.</p>
<p>It turns out that there are two perspectives from which one can view
correctness.  Verifying that a particular model is implemented according
to its specification is generically called <em>verification</em>.  The process of
deciding that the model is correct for its intended use is generically called
<em>validation</em>.</p>
</section>
<section id="validation-and-verification">
<h5><span class="section-number">4.5.2.2. </span>Validation and Verification<a class="headerlink" href="#validation-and-verification" title="Link to this heading">¶</a></h5>
<p>A computer model is a mathematical or logical representation of something. It
can represent a vehicle, an elephant (see
<a class="reference external" href="http://simutools.org/2009/">David Harel’s talk about modeling an elephant at SIMUTools 2009</a>, or a networking card.  Models can also represent
processes such as global warming, freeway traffic flow or a specification of a
networking protocol.  Models can be completely faithful representations of a
logical process specification, but they necessarily can never completely
simulate a physical object or process.  In most cases, a number of
simplifications are made to the model to make simulation computationally
tractable.</p>
<p>Every model has a <em>target system</em> that it is attempting to simulate.  The
first step in creating a simulation model is to identify this target system and
the level of detail and accuracy that the simulation is desired to reproduce.
In the case of a logical process, the target system may be identified as ‘’TCP
as defined by RFC 793.’’  In this case, it will probably be desirable to create
a model that completely and faithfully reproduces RFC 793.  In the case of a
physical process this will not be possible. If, for example, you would like to
simulate a wireless networking card, you may determine that you need,  ‘’an
accurate MAC-level implementation of the 802.11 specification and […] a
not-so-slow PHY-level model of the 802.11a specification.’’</p>
<p>Once this is done, one can develop an abstract model of the target system.  This
is typically an exercise in managing the tradeoffs between complexity, resource
requirements and accuracy.  The process of developing an abstract model has been
called <em>model qualification</em> in the literature.  In the case of a TCP
protocol, this process results in a design for a collection of objects,
interactions and behaviors that will fully implement RFC 793 in <em>ns-3</em>.
In the case of the wireless card, this process results in a number of tradeoffs
to allow the physical layer to be simulated and the design of a network device
and channel for ns-3, along with the desired objects, interactions and behaviors.</p>
<p>This abstract model is then developed into an <em>ns-3</em> model that
implements the abstract model as a computer program.  The process of getting the
implementation to agree with the abstract model is called <em>model
verification</em> in the literature.</p>
<p>The process so far is open loop. What remains is to make a determination that a
given ns-3 model has some connection to some reality – that a model is an
accurate representation of a real system, whether a logical process or a physical
entity.</p>
<p>If one is going to use a simulation model to try and predict how some real
system is going to behave, there must be some reason to believe your results –
i.e., can one trust that an inference made from the model translates into a
correct prediction for the real system.  The process of getting the ns-3 model
behavior to agree with the desired target system behavior as defined by the model
qualification process is called <em>model validation</em> in the literature. In the
case of a TCP implementation, you may want to compare the behavior of your ns-3
TCP model to some reference implementation in order to validate your model.  In
the case of a wireless physical layer simulation, you may want to compare the
behavior of your model to that of real hardware in a controlled setting,</p>
<p>The <em>ns-3</em> testing environment provides tools to allow for both model
validation and testing, and encourages the publication of validation results.</p>
</section>
<section id="robustness">
<h5><span class="section-number">4.5.2.3. </span>Robustness<a class="headerlink" href="#robustness" title="Link to this heading">¶</a></h5>
<p>Robustness is the quality of being able to withstand stresses, or changes in
environments, inputs or calculations, etc.  A system or design is ‘’robust’’
if it can deal with such changes with minimal loss of functionality.</p>
<p>This kind of testing is usually done with a particular focus.  For example, the
system as a whole can be run on many different system configurations to
demonstrate that it can perform correctly in a large number of environments.</p>
<p>The system can be also be stressed by operating close to or beyond capacity by
generating or simulating resource exhaustion of various kinds.  This genre of
testing is called ‘’stress testing.’’</p>
<p>The system and its components may be exposed to so-called ‘’clean tests’’ that
demonstrate a positive result – that is that the system operates correctly in
response to a large variation of expected configurations.</p>
<p>The system and its components may also be exposed to ‘’dirty tests’’ which
provide inputs outside the expected range.  For example, if a module expects a
zero-terminated string representation of an integer, a dirty test might provide
an unterminated string of random characters to verify that the system does not
crash as a result of this unexpected input.  Unfortunately, detecting such
‘’dirty’’ input and taking preventive measures to ensure the system does not
fail catastrophically can require a huge amount of development overhead.  In
order to reduce development time, a decision was taken early on in the project
to minimize the amount of parameter validation and error handling in the
<em>ns-3</em> codebase.  For this reason, we do not spend much time on dirty
testing – it would just uncover the results of the design decision we know
we took.</p>
<p>We do want to demonstrate that <em>ns-3</em> software does work across some set
of conditions.  We borrow a couple of definitions to narrow this down a bit.
The <em>domain of applicability</em> is a set of prescribed conditions for which
the model has been tested, compared against reality to the extent possible, and
judged  suitable for use.  The <em>range of accuracy</em> is an agreement between
the computerized model and reality within a domain of applicability.</p>
<p>The <em>ns-3</em> testing environment provides tools to allow for setting up
and running test environments over multiple systems (buildbot) and provides
classes to encourage clean tests to verify the operation of the system over the
expected ‘’domain of applicability’’ and ‘’range of accuracy.’’</p>
</section>
<section id="performant">
<h5><span class="section-number">4.5.2.4. </span>Performant<a class="headerlink" href="#performant" title="Link to this heading">¶</a></h5>
<p>Okay, ‘’performant’’ isn’t a real English word.  It is, however, a very concise
neologism that is quite often used to describe what we want <em>ns-3</em> to
be: powerful and fast enough to get the job done.</p>
<p>This is really about the broad subject of software performance testing.  One of
the key things that is done is to compare two systems to find which performs
better (cf benchmarks).  This is used to demonstrate that, for example,
<em>ns-3</em> can perform a basic kind of simulation at least as fast as a
competing tool, or can be used to identify parts of the system that perform
badly.</p>
<p>In the <em>ns-3</em> test framework, we provide support for timing various kinds
of tests.</p>
</section>
<section id="maintainability">
<h5><span class="section-number">4.5.2.5. </span>Maintainability<a class="headerlink" href="#maintainability" title="Link to this heading">¶</a></h5>
<p>A software product must be maintainable.  This is, again, a very broad
statement, but a testing framework can help with the task.  Once a model has
been developed, validated and verified, we can repeatedly execute the suite
of tests for the entire system to ensure that it remains valid and verified
over its lifetime.</p>
<p>When a feature stops functioning as intended after some kind of change to the
system is integrated, it is called generically a <em>regression</em>.
Originally the
term regression referred to a change that caused a previously fixed bug to
reappear, but the term has evolved to describe any kind of change that breaks
existing functionality.  There are many kinds of regressions that may occur
in practice.</p>
<p>A <em>local regression</em> is one in which a change affects the changed component
directly.  For example, if a component is modified to allocate and free memory
but stale pointers are used, the component itself fails.</p>
<p>A <em>remote regression</em> is one in which a change to one component breaks
functionality in another component.  This reflects violation of an implied but
possibly unrecognized contract between components.</p>
<p>An <em>unmasked regression</em> is one that creates a situation where a previously
existing bug that had no affect is suddenly exposed in the system.  This may
be as simple as exercising a code path for the first time.</p>
<p>A <em>performance regression</em> is one that causes the performance requirements
of the system to be violated.  For example, doing some work in a low level
function that may be repeated large numbers of times may suddenly render the
system unusable from certain perspectives.</p>
<p>The <em>ns-3</em> testing framework provides tools for automating the process
used to validate and verify the code in nightly test suites to help quickly
identify possible regressions.</p>
</section>
</section>
<span id="document-test-framework"></span><section id="testing-framework">
<h4><span class="section-number">4.5.3. </span>Testing framework<a class="headerlink" href="#testing-framework" title="Link to this heading">¶</a></h4>
<p><em>ns-3</em> consists of a simulation core engine, a set of models, example programs,
and tests.  Over time, new contributors contribute models, tests, and
examples.  A Python test program <code class="docutils literal notranslate"><span class="pre">test.py</span></code> serves as the test
execution manager; <code class="docutils literal notranslate"><span class="pre">test.py</span></code> can run test code and examples to
look for regressions, can output the results into a number of forms, and
can manage code coverage analysis tools.  On top of this, we layer
<em>buildslaves</em> that are automated build robots that perform
robustness testing by running the test framework on different systems
and with different configuration options.</p>
<section id="buildslaves">
<h5><span class="section-number">4.5.3.1. </span>Buildslaves<a class="headerlink" href="#buildslaves" title="Link to this heading">¶</a></h5>
<p>At the highest level of <em>ns-3</em> testing are the buildslaves (build robots).
If you are unfamiliar with
this system look at <a class="reference external" href="https://ns-buildmaster.ee.washington.edu:8010/">https://ns-buildmaster.ee.washington.edu:8010/</a>.
This is an open-source automated system that allows <em>ns-3</em> to be rebuilt
and tested daily.  By running the buildbots on a number
of different systems we can ensure that <em>ns-3</em> builds and executes
properly on all of its supported systems.</p>
<p>Users (and developers) typically will not interact with the buildslave system other
than to read its messages regarding test results.  If a failure is detected in
one of the automated build and test jobs, the buildbot will send an email to the
<em>ns-commits</em> mailing list.  This email will look something like</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[Ns-commits] Build failed in Jenkins: daily-ubuntu-without-valgrind » Ubuntu-64-15.04 #926

...
281 of 285 tests passed (281 passed, 3 skipped, 1 failed, 0 crashed, 0 valgrind errors)
List of SKIPped tests:
  ns3-tcp-cwnd
  ns3-tcp-interoperability
  nsc-tcp-loss
List of FAILed tests:
  random-variable-stream-generators
+ exit 1
Build step &#39;Execute shell&#39; marked build as failure
</pre></div>
</div>
<p>In the full details URL shown in the email, one can find links to the detailed test output.</p>
<p>The buildslave system will do its job quietly if there are no errors, and the
system will undergo build and test cycles every day to verify that all is well.</p>
</section>
<section id="test-py">
<h5><span class="section-number">4.5.3.2. </span>Test.py<a class="headerlink" href="#test-py" title="Link to this heading">¶</a></h5>
<p>The buildbots use a Python program, <code class="docutils literal notranslate"><span class="pre">test.py</span></code>, that is responsible for
running all of the tests and collecting the resulting reports into a human-
readable form.  This program is also available for use by users and developers
as well.</p>
<p><code class="docutils literal notranslate"><span class="pre">test.py</span></code> is very flexible in allowing the user to specify the number
and kind of tests to run; and also the amount and kind of output to generate.</p>
<p>Before running <code class="docutils literal notranslate"><span class="pre">test.py</span></code>, make sure that ns3’s examples and tests
have been built by doing the following</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>configure<span class="w"> </span>--enable-examples<span class="w"> </span>--enable-tests
$<span class="w"> </span>./ns3<span class="w"> </span>build
</pre></div>
</div>
<p>By default, <code class="docutils literal notranslate"><span class="pre">test.py</span></code> will run all available tests and report status
back in a very concise form.  Running the command</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py
</pre></div>
</div>
<p>will result in a number of <code class="docutils literal notranslate"><span class="pre">PASS</span></code>, <code class="docutils literal notranslate"><span class="pre">FAIL</span></code>, <code class="docutils literal notranslate"><span class="pre">CRASH</span></code> or <code class="docutils literal notranslate"><span class="pre">SKIP</span></code>
indications followed by the kind of test that was run and its display name.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Waf: Entering directory `/home/craigdo/repos/ns-3-allinone-test/ns-3-dev/build&#39;
Waf: Leaving directory `/home/craigdo/repos/ns-3-allinone-test/ns-3-dev/build&#39;
&#39;build&#39; finished successfully (0.939s)
FAIL: TestSuite propagation-loss-model
PASS: TestSuite object-name-service
PASS: TestSuite pcap-file-object
PASS: TestSuite ns3-tcp-cwnd
...
PASS: TestSuite ns3-tcp-interoperability
PASS: Example csma-broadcast
PASS: Example csma-multicast
</pre></div>
</div>
<p>This mode is intended to be used by users who are interested in determining if
their distribution is working correctly, and by developers who are interested
in determining if changes they have made have caused any regressions.</p>
<p>There are a number of options available to control the behavior of <code class="docutils literal notranslate"><span class="pre">test.py</span></code>.
if you run <code class="docutils literal notranslate"><span class="pre">test.py</span> <span class="pre">--help</span></code> you should see a command summary like:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Usage: test.py [options]

Options:
  -h, --help            show this help message and exit
  -b BUILDPATH, --buildpath=BUILDPATH
                        specify the path where ns-3 was built (defaults to the
                        build directory for the current variant)
  -c KIND, --constrain=KIND
                        constrain the test-runner by kind of test
  -e EXAMPLE, --example=EXAMPLE
                        specify a single example to run (no relative path is
                        needed)
  -d, --duration        print the duration of each test suite and example
  -e EXAMPLE, --example=EXAMPLE
                        specify a single example to run (no relative path is
                        needed)
  -u, --update-data     If examples use reference data files, get them to re-
                        generate them
  -f FULLNESS, --fullness=FULLNESS
                        choose the duration of tests to run: QUICK, EXTENSIVE,
                        or TAKES_FOREVER, where EXTENSIVE includes QUICK and
                        TAKES_FOREVER includes QUICK and EXTENSIVE (only QUICK
                        tests are run by default)
  -g, --grind           run the test suites and examples using valgrind
  -k, --kinds           print the kinds of tests available
  -l, --list            print the list of known tests
  -m, --multiple        report multiple failures from test suites and test
                        cases
  -n, --nobuild           do not run ns3 before starting testing
  -p PYEXAMPLE, --pyexample=PYEXAMPLE
                        specify a single python example to run (with relative
                        path)
  -r, --retain          retain all temporary files (which are normally
                        deleted)
  -s TEST-SUITE, --suite=TEST-SUITE
                        specify a single test suite to run
  -t TEXT-FILE, --text=TEXT-FILE
                        write detailed test results into TEXT-FILE.txt
  -v, --verbose         print progress and informational messages
  -w HTML-FILE, --web=HTML-FILE, --html=HTML-FILE
                        write detailed test results into HTML-FILE.html
  -x XML-FILE, --xml=XML-FILE
                        write detailed test results into XML-FILE.xml
</pre></div>
</div>
<p>If one specifies an optional output style, one can generate detailed descriptions
of the tests and status.  Available styles are <code class="docutils literal notranslate"><span class="pre">text</span></code> and <code class="docutils literal notranslate"><span class="pre">HTML</span></code>.
The buildbots will select the HTML option to generate HTML test reports for the
nightly builds using</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>--html<span class="o">=</span>nightly.html
</pre></div>
</div>
<p>In this case, an HTML file named ‘’nightly.html’’ would be created with a pretty
summary of the testing done.  A ‘’human readable’’ format is available for users
interested in the details.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>--text<span class="o">=</span>results.txt
</pre></div>
</div>
<p>In the example above, the test suite checking the <em>ns-3</em> wireless
device propagation loss models failed.  By default no further information is
provided.</p>
<p>To further explore the failure, <code class="docutils literal notranslate"><span class="pre">test.py</span></code> allows a single test suite
to be specified.  Running the command</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>--suite<span class="o">=</span>propagation-loss-model
</pre></div>
</div>
<p>or equivalently</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>-s<span class="w"> </span>propagation-loss-model
</pre></div>
</div>
<p>results in that single test suite being run.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>FAIL: TestSuite propagation-loss-model
</pre></div>
</div>
<p>To find detailed information regarding the failure, one must specify the kind
of output desired.  For example, most people will probably be interested in
a text file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>--suite<span class="o">=</span>propagation-loss-model<span class="w"> </span>--text<span class="o">=</span>results.txt
</pre></div>
</div>
<p>This will result in that single test suite being run with the test status written to
the file ‘’results.txt’’.</p>
<p>You should find something similar to the following in that file</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>FAIL: Test Suite &#39;&#39;propagation-loss-model&#39;&#39; (real 0.02 user 0.01 system 0.00)
PASS: Test Case &quot;Check ... Friis ... model ...&quot; (real 0.01 user 0.00 system 0.00)
FAIL: Test Case &quot;Check ... Log Distance ... model&quot; (real 0.01 user 0.01 system 0.00)
  Details:
    Message:   Got unexpected SNR value
    Condition: [long description of what actually failed]
    Actual:    176.395
    Limit:     176.407 +- 0.0005
    File:      ../src/test/ns3wifi/propagation-loss-models-test-suite.cc
    Line:      360
</pre></div>
</div>
<p>Notice that the Test Suite is composed of two Test Cases.  The first test case
checked the Friis propagation loss model and passed.  The second test case
failed checking the Log Distance propagation model.  In this case, an SNR of
176.395 was found, and the test expected a value of 176.407 correct to three
decimal places.  The file which implemented the failing test is listed as well
as the line of code which triggered the failure.</p>
<p>If you desire, you could just as easily have written an HTML file using the
<code class="docutils literal notranslate"><span class="pre">--html</span></code> option as described above.</p>
<p>Typically a user will run all tests at least once after downloading
<em>ns-3</em> to ensure that his or her environment has been built correctly
and is generating correct results according to the test suites.  Developers
will typically run the test suites before and after making a change to ensure
that they have not introduced a regression with their changes.  In this case,
developers may not want to run all tests, but only a subset.  For example,
the developer might only want to run the unit tests periodically while making
changes to a repository.  In this case, <code class="docutils literal notranslate"><span class="pre">test.py</span></code> can be told to constrain
the types of tests being run to a particular class of tests.  The following
command will result in only the unit tests being run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>--constrain<span class="o">=</span>unit
</pre></div>
</div>
<p>To see a quick list of the legal kinds of constraints, you can ask for them
to be listed.  The following command</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>--kinds
</pre></div>
</div>
<p>will result in the following list being displayed:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Waf: Entering directory `/home/craigdo/repos/ns-3-allinone-test/ns-3-dev/build&#39;
Waf: Leaving directory `/home/craigdo/repos/ns-3-allinone-test/ns-3-dev/build&#39;
&#39;build&#39; finished successfully (0.939s)Waf: Entering directory `/home/craigdo/repos/ns-3-allinone-test/ns-3-dev/build&#39;
core:        Run all TestSuite-based tests (exclude examples)
example:     Examples (to see if example programs run successfully)
performance: Performance Tests (check to see if the system is as fast as expected)
system:      System Tests (spans modules to check integration of modules)
unit:        Unit Tests (within modules to check basic functionality)
</pre></div>
</div>
<p>Any of these kinds of test can be provided as a constraint using the <code class="docutils literal notranslate"><span class="pre">--constraint</span></code>
option.</p>
<p>To see a quick list of all of the test suites available, you can ask for them
to be listed.  The following command,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>--list
</pre></div>
</div>
<p>will result in a list of the test suite being displayed, similar to</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Waf: Entering directory `/home/craigdo/repos/ns-3-allinone-test/ns-3-dev/build&#39;
Waf: Leaving directory `/home/craigdo/repos/ns-3-allinone-test/ns-3-dev/build&#39;
&#39;build&#39; finished successfully (0.939s)

Test Type    Test Name
---------    ---------
performance  many-uniform-random-variables-one-get-value-call
performance  one-uniform-random-variable-many-get-value-calls
performance  type-id-perf
system       buildings-pathloss-test
system       buildings-shadowing-test
system       devices-mesh-dot11s-regression
system       devices-mesh-flame-regression
system       epc-gtpu
...
unit         wimax-phy-layer
unit         wimax-service-flow
unit         wimax-ss-mac-layer
unit         wimax-tlv
example      adhoc-aloha-ideal-phy
example      adhoc-aloha-ideal-phy-matrix-propagation-loss-model
example      adhoc-aloha-ideal-phy-with-microwave-oven
example      aodv
...
</pre></div>
</div>
<p>Any of these listed suites can be selected to be run by itself using the
<code class="docutils literal notranslate"><span class="pre">--suite</span></code> option as shown above.</p>
<p>To run multiple test suites at once it is possible to use a ‘Unix filename pattern matching’
style, e.g.,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>../test.py<span class="w"> </span>-s<span class="w"> </span><span class="s1">&#39;ipv6*&#39;</span>
</pre></div>
</div>
<p>Note the use of quotes. The result is similar to</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>PASS: TestSuite ipv6-protocol
PASS: TestSuite ipv6-packet-info-tag
PASS: TestSuite ipv6-list-routing
PASS: TestSuite ipv6-extension-header
PASS: TestSuite ipv6-address-generator
PASS: TestSuite ipv6-raw
PASS: TestSuite ipv6-dual-stack
PASS: TestSuite ipv6-fragmentation
PASS: TestSuite ipv6-address-helper
PASS: TestSuite ipv6-address
PASS: TestSuite ipv6-forwarding
PASS: TestSuite ipv6-ripng
</pre></div>
</div>
<p>Similarly to test suites, one can run a single C++ example program
using the <code class="docutils literal notranslate"><span class="pre">--example</span></code> option.  Note that the relative path for the
example does not need to be included and that the executables built
for C++ examples do not have extensions.  Furthermore, the example
must be registered as an example to the test framework; it is not
sufficient to create an example and run it through test.py; it must
be added to the relevant <code class="docutils literal notranslate"><span class="pre">examples-to-run.py</span></code> file, explained below.
Entering</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>--example<span class="o">=</span>udp-echo
</pre></div>
</div>
<p>results in that single example being run.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>PASS: Example examples/udp/udp-echo
</pre></div>
</div>
<p>You can specify the directory where <em>ns-3</em> was built using the
<code class="docutils literal notranslate"><span class="pre">--buildpath</span></code> option as follows.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>--buildpath<span class="o">=</span>/home/craigdo/repos/ns-3-allinone-test/ns-3-dev/build/debug<span class="w"> </span>--example<span class="o">=</span>wifi-simple-adhoc
</pre></div>
</div>
<p>One can run a single Python example program using the <code class="docutils literal notranslate"><span class="pre">--pyexample</span></code>
option.  Note that the relative path for the example must be included
and that Python examples do need their extensions.  Entering</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>--pyexample<span class="o">=</span>examples/tutorial/first.py
</pre></div>
</div>
<p>results in that single example being run.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>PASS: Example examples/tutorial/first.py
</pre></div>
</div>
<p>Because Python examples are not built, you do not need to specify the
directory where <em>ns-3</em> was built to run them.</p>
<p>Normally when example programs are executed, they write a large amount of trace
file data.  This is normally saved to the base directory of the distribution
(e.g., /home/user/ns-3-dev).  When <code class="docutils literal notranslate"><span class="pre">test.py</span></code> runs an example, it really
is completely unconcerned with the trace files.  It just wants to to determine
if the example can be built and run without error.  Since this is the case, the
trace files are written into a <code class="docutils literal notranslate"><span class="pre">/tmp/unchecked-traces</span></code> directory.  If you
run the above example, you should be able to find the associated
<code class="docutils literal notranslate"><span class="pre">udp-echo.tr</span></code> and <code class="docutils literal notranslate"><span class="pre">udp-echo-n-1.pcap</span></code> files there.</p>
<p>The list of available examples is defined by the contents of the ‘’examples’’
directory in the distribution.  If you select an example for execution using
the <code class="docutils literal notranslate"><span class="pre">--example</span></code> option, <code class="docutils literal notranslate"><span class="pre">test.py</span></code> will not make any attempt to decide
if the example has been configured or not, it will just try to run it and
report the result of the attempt.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">test.py</span></code> runs, by default it will first ensure that the system has
been completely built.  This can be defeated by selecting the <code class="docutils literal notranslate"><span class="pre">--nobuild</span></code>
option.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>--list<span class="w"> </span>--nobuild
</pre></div>
</div>
<p>will result in a list of the currently built test suites being displayed, similar to:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>propagation-loss-model
ns3-tcp-cwnd
ns3-tcp-interoperability
pcap-file
object-name-service
random-variable-stream-generators
</pre></div>
</div>
<p>Note the absence of the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> build messages.</p>
<p><code class="docutils literal notranslate"><span class="pre">test.py</span></code> also supports running the test suites and examples under valgrind.
Valgrind is a flexible program for debugging and profiling Linux executables.  By
default, valgrind runs a tool called memcheck, which performs a range of memory-
checking functions, including detecting accesses to uninitialised memory, misuse
of allocated memory (double frees, access after free, etc.) and detecting memory
leaks.  This can be selected by using the <code class="docutils literal notranslate"><span class="pre">--grind</span></code> option.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>--grind
</pre></div>
</div>
<p>As it runs, <code class="docutils literal notranslate"><span class="pre">test.py</span></code> and the programs that it runs indirectly, generate large
numbers of temporary files.  Usually, the content of these files is not interesting,
however in some cases it can be useful (for debugging purposes) to view these files.
<code class="docutils literal notranslate"><span class="pre">test.py</span></code> provides a <code class="docutils literal notranslate"><span class="pre">--retain</span></code> option which will cause these temporary
files to be kept after the run is completed.  The files are saved in a directory
named <code class="docutils literal notranslate"><span class="pre">testpy-output</span></code> under a subdirectory named according to the current Coordinated
Universal Time (also known as Greenwich Mean Time).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>--retain
</pre></div>
</div>
<p>Finally, <code class="docutils literal notranslate"><span class="pre">test.py</span></code> provides a <code class="docutils literal notranslate"><span class="pre">--verbose</span></code> option which will print
large amounts of information about its progress.  It is not expected that this
will be terribly useful unless there is an error.  In this case, you can get
access to the standard output and standard error reported by running test suites
and examples.  Select verbose in the following way:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>--verbose
</pre></div>
</div>
<p>All of these options can be mixed and matched.  For example, to run all of the
<em>ns-3</em> core test suites under valgrind, in verbose mode, while generating an HTML
output file, one would do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>--verbose<span class="w"> </span>--grind<span class="w"> </span>--constrain<span class="o">=</span>core<span class="w"> </span>--html<span class="o">=</span>results.html
</pre></div>
</div>
</section>
<section id="testtaxonomy">
<h5><span class="section-number">4.5.3.3. </span>TestTaxonomy<a class="headerlink" href="#testtaxonomy" title="Link to this heading">¶</a></h5>
<p>As mentioned above, tests are grouped into a number of broadly defined
classifications to allow users to selectively run tests to address the different
kinds of testing that need to be done.</p>
<ul class="simple">
<li><p>Build Verification Tests</p></li>
<li><p>Unit Tests</p></li>
<li><p>System Tests</p></li>
<li><p>Examples</p></li>
<li><p>Performance Tests</p></li>
</ul>
<p>Moreover, each test is further classified according to the expected time needed to
run it. Tests are classified as:</p>
<ul class="simple">
<li><p>QUICK</p></li>
<li><p>EXTENSIVE</p></li>
<li><p>TAKES_FOREVER</p></li>
</ul>
<p>Note that specifying EXTENSIVE fullness will also run tests in QUICK category.
Specifying TAKES_FOREVER will run tests in EXTENSIVE and QUICK categories.
By default, only QUICK tests are ran.</p>
<p>As a rule of thumb, tests that must be run to ensure <em>ns-3</em> coherence should be
QUICK (i.e., take a few seconds). Tests that could be skipped, but are nice to do
can be EXTENSIVE; these are tests that typically need minutes. TAKES_FOREVER is
left for tests that take a really long time, in the order of several minutes.
The main classification goal is to be able to run the buildbots in a reasonable
time, and still be able to perform more extensive tests when needed.</p>
<section id="unit-tests">
<h6><span class="section-number">4.5.3.3.1. </span>Unit Tests<a class="headerlink" href="#unit-tests" title="Link to this heading">¶</a></h6>
<p>Unit tests are more involved tests that go into detail to make sure that a
piece of code works as advertised in isolation.  There is really no reason
for this kind of test to be built into an <em>ns-3</em> module.  It turns out, for
example, that the unit tests for the object name service are about the same
size as the object name service code itself.  Unit tests are tests that
check a single bit of functionality that are not built into the <em>ns-3</em> code,
but live in the same directory as the code it tests.  It is possible that
these tests check integration of multiple implementation files in a module
as well.  The file src/core/test/names-test-suite.cc is an example of this kind
of test.  The file src/network/test/pcap-file-test-suite.cc is another example
that uses a known good pcap file as a test vector file.  This file is stored
locally in the src/network directory.</p>
</section>
<section id="system-tests">
<h6><span class="section-number">4.5.3.3.2. </span>System Tests<a class="headerlink" href="#system-tests" title="Link to this heading">¶</a></h6>
<p>System tests are those that involve more than one module in the system.  We
have some of this kind of test running in our current regression framework,
but they are typically overloaded examples.  We provide a new place
for this kind of test in the directory <code class="docutils literal notranslate"><span class="pre">src/test</span></code>.  The file
<code class="docutils literal notranslate"><span class="pre">src/test/ns3tcp/ns3tcp-loss-test-suite.cc</span></code> is an example of this kind of
test.  It uses NSC TCP to test the <em>ns-3</em> TCP implementation.  Often there
will be test vectors required for this kind of test, and they are stored in
the directory where the test lives.  For example,
<code class="docutils literal notranslate"><span class="pre">ns3tcp-loss-NewReno0-response-vectors.pcap</span></code> is a file consisting of a number of TCP
headers that are used as the expected responses of the <em>ns-3</em> TCP under test.</p>
<p>Note that Unit Tests are often preferable to System Tests, as they are more
independent from small changes in the modules that are not the goal of the test.</p>
</section>
<section id="examples">
<h6><span class="section-number">4.5.3.3.3. </span>Examples<a class="headerlink" href="#examples" title="Link to this heading">¶</a></h6>
<p>The examples are tested by the framework to make sure they built and
will run.  Limited checking is done on examples; currently the pcap
files are just written off into /tmp to be discarded.  If the example
runs (don’t crash) and the exit status is zero, the example will pass
the smoke test.</p>
</section>
<section id="performance-tests">
<h6><span class="section-number">4.5.3.3.4. </span>Performance Tests<a class="headerlink" href="#performance-tests" title="Link to this heading">¶</a></h6>
<p>Performance tests are those which exercise a particular part of the system
and determine if the tests have executed to completion in a reasonable time.</p>
</section>
</section>
<section id="running-tests">
<h5><span class="section-number">4.5.3.4. </span>Running Tests<a class="headerlink" href="#running-tests" title="Link to this heading">¶</a></h5>
<p>Tests are typically run using the high level <code class="docutils literal notranslate"><span class="pre">test.py</span></code> program. To get a list of the available command-line options, run <code class="docutils literal notranslate"><span class="pre">test.py</span> <span class="pre">--help</span></code></p>
<p>The test program <code class="docutils literal notranslate"><span class="pre">test.py</span></code> will run both tests and those examples that
have been added to the list to check.  The difference between tests
and examples is as follows.  Tests generally check that specific simulation
output or events conforms to expected behavior.  In contrast, the output
of examples is not checked, and the test program merely checks the exit
status of the example program to make sure that it runs without error.</p>
<p>Briefly, to run all tests, first one must configure tests during configuration
stage, and also (optionally) examples if examples are to be checked:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>configure<span class="w"> </span>--enable-examples<span class="w"> </span>--enable-tests
</pre></div>
</div>
<p>Then, build <em>ns-3</em>, and after it is built, just run <code class="docutils literal notranslate"><span class="pre">test.py</span></code>.  <code class="docutils literal notranslate"><span class="pre">test.py</span> <span class="pre">-h</span></code>
will show a number of configuration options that modify the behavior
of test.py.</p>
<p>The program <code class="docutils literal notranslate"><span class="pre">test.py</span></code> invokes, for C++ tests and examples, a lower-level
C++ program called <code class="docutils literal notranslate"><span class="pre">test-runner</span></code> to actually run the tests.  As discussed
below, this <code class="docutils literal notranslate"><span class="pre">test-runner</span></code> can be a helpful way to debug tests.</p>
</section>
<section id="debugging-tests">
<h5><span class="section-number">4.5.3.5. </span>Debugging Tests<a class="headerlink" href="#debugging-tests" title="Link to this heading">¶</a></h5>
<p>The debugging of the test programs is best performed running the low-level
test-runner program. The test-runner is the bridge from generic Python
code to <em>ns-3</em> code. It is written in C++ and uses the automatic test
discovery process in the <em>ns-3</em> code to find and allow execution of all
of the various tests.</p>
<p>The main reason why <code class="docutils literal notranslate"><span class="pre">test.py</span></code> is not suitable for debugging is that it is
not allowed for logging to be turned on using the <code class="docutils literal notranslate"><span class="pre">NS_LOG</span></code> environmental
variable when test.py runs.  This limitation does not apply to the test-runner
executable. Hence, if you want to see logging output from your tests, you
have to run them using the test-runner directly.</p>
<p>In order to execute the test-runner, you run it like any other <em>ns-3</em> executable
– using <code class="docutils literal notranslate"><span class="pre">ns3</span></code>.  To get a list of available options, you can type:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span><span class="s2">&quot;test-runner --help&quot;</span>
</pre></div>
</div>
<p>You should see something like the following</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Usage: /home/craigdo/repos/ns-3-allinone-test/ns-3-dev/build/utils/ns3-dev-test-runner-debug [OPTIONS]

Options:
--help                 : print these options
--print-test-name-list : print the list of names of tests available
--list                 : an alias for --print-test-name-list
--print-test-types     : print the type of tests along with their names
--print-test-type-list : print the list of types of tests available
--print-temp-dir       : print name of temporary directory before running
                         the tests
--test-type=TYPE       : process only tests of type TYPE
--test-name=NAME       : process only test whose name matches NAME
--suite=NAME           : an alias (here for compatibility reasons only)
                         for --test-name=NAME
--assert-on-failure    : when a test fails, crash immediately (useful
                         when running under a debugger
--stop-on-failure      : when a test fails, stop immediately
--fullness=FULLNESS    : choose the duration of tests to run: QUICK,
                         EXTENSIVE, or TAKES_FOREVER, where EXTENSIVE
                         includes QUICK and TAKES_FOREVER includes
                         QUICK and EXTENSIVE (only QUICK tests are
                         run by default)
--verbose              : print details of test execution
--xml                  : format test run output as xml
--tempdir=DIR          : set temp dir for tests to store output files
--datadir=DIR          : set data dir for tests to read reference files
--out=FILE             : send test result to FILE instead of standard output
--append=FILE          : append test result to FILE instead of standard output
</pre></div>
</div>
<p>There are a number of things available to you which will be familiar to you if
you have looked at <code class="docutils literal notranslate"><span class="pre">test.py</span></code>.  This should be expected since the test-
runner is just an interface between <code class="docutils literal notranslate"><span class="pre">test.py</span></code> and <em>ns-3</em>.  You
may notice that example-related commands are missing here.  That is because
the examples are really not <em>ns-3</em> tests.  <code class="docutils literal notranslate"><span class="pre">test.py</span></code> runs them
as if they were to present a unified testing environment, but they are really
completely different and not to be found here.</p>
<p>The first new option that appears here, but not in test.py is the <code class="docutils literal notranslate"><span class="pre">--assert-on-failure</span></code>
option.  This option is useful when debugging a test case when running under a
debugger like <code class="docutils literal notranslate"><span class="pre">gdb</span></code>.  When selected, this option tells the underlying
test case to cause a segmentation violation if an error is detected.  This has
the nice side-effect of causing program execution to stop (break into the
debugger) when an error is detected.  If you are using gdb, you could use this
option something like,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>shell
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>build/utils
$<span class="w"> </span>gdb<span class="w"> </span>ns3-dev-test-runner-debug
$<span class="w"> </span>run<span class="w"> </span>--suite<span class="o">=</span>global-value<span class="w"> </span>--assert-on-failure
</pre></div>
</div>
<p>If an error is then found in the global-value test suite, a segfault would be
generated and the (source level) debugger would stop at the <code class="docutils literal notranslate"><span class="pre">NS_TEST_ASSERT_MSG</span></code>
that detected the error.</p>
<p>To run one of the tests directly from the test-runner
using <code class="docutils literal notranslate"><span class="pre">ns3</span></code>, you will need to specify the test suite to run.
So you could use the shell and do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span><span class="s2">&quot;test-runner --suite=pcap-file&quot;</span>
</pre></div>
</div>
<p><em>ns-3</em> logging is available when you run it this way, such as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nv">NS_LOG</span><span class="o">=</span><span class="s2">&quot;Packet&quot;</span><span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span><span class="s2">&quot;test-runner --suite=pcap-file&quot;</span>
</pre></div>
</div>
<section id="test-output">
<h6><span class="section-number">4.5.3.5.1. </span>Test output<a class="headerlink" href="#test-output" title="Link to this heading">¶</a></h6>
<p>Many test suites need to write temporary files (such as pcap files)
in the process of running the tests.  The tests then need a temporary directory
to write to.  The Python test utility (test.py) will provide a temporary file
automatically, but if run stand-alone this temporary directory must be provided.
It can be annoying to continually have to provide
a <code class="docutils literal notranslate"><span class="pre">--tempdir</span></code>, so the test runner will figure one out for you if you don’t
provide one.  It first looks for environment variables named <code class="docutils literal notranslate"><span class="pre">TMP</span></code> and
<code class="docutils literal notranslate"><span class="pre">TEMP</span></code> and uses those.  If neither <code class="docutils literal notranslate"><span class="pre">TMP</span></code> nor <code class="docutils literal notranslate"><span class="pre">TEMP</span></code> are defined
it picks <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>.  The code then tacks on an identifier indicating what
created the directory (ns-3) then the time (hh.mm.ss) followed by a large random
number.  The test runner creates a directory of that name to be used as the
temporary directory.  Temporary files then go into a directory that will be
named something like</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/tmp/ns-3.10.25.37.61537845
</pre></div>
</div>
<p>The time is provided as a hint so that you can relatively easily reconstruct
what directory was used if you need to go back and look at the files that were
placed in that directory.</p>
<p>Another class of output is test output like pcap traces that are generated
to compare to reference output.  The test program will typically delete
these after the test suites all run.  To disable the deletion of test
output, run <code class="docutils literal notranslate"><span class="pre">test.py</span></code> with the “retain” option:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>-r
</pre></div>
</div>
<p>and test output can be found in the <code class="docutils literal notranslate"><span class="pre">testpy-output/</span></code> directory.</p>
</section>
<section id="reporting-of-test-failures">
<h6><span class="section-number">4.5.3.5.2. </span>Reporting of test failures<a class="headerlink" href="#reporting-of-test-failures" title="Link to this heading">¶</a></h6>
<p>When you run a test suite using the test-runner it will run the test
and report PASS or FAIL.
To run more quietly, you need to specify an output file to which the tests will write their status using the <code class="docutils literal notranslate"><span class="pre">--out</span></code> option.
Try,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span><span class="s2">&quot;test-runner --suite=pcap-file --out=myfile.txt&quot;</span>
</pre></div>
</div>
</section>
<section id="debugging-test-suite-failures">
<h6><span class="section-number">4.5.3.5.3. </span>Debugging test suite failures<a class="headerlink" href="#debugging-test-suite-failures" title="Link to this heading">¶</a></h6>
<p>To debug test crashes, such as</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>CRASH: TestSuite wifi-interference
</pre></div>
</div>
<p>You can access the underlying test-runner program via gdb as follows, and
then pass the “–basedir=`pwd`” argument to run (you can also pass other
arguments as needed, but basedir is the minimum needed):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span><span class="s2">&quot;test-runner&quot;</span><span class="w"> </span>--command-template<span class="o">=</span><span class="s2">&quot;gdb %s&quot;</span>
Waf:<span class="w"> </span>Entering<span class="w"> </span>directory<span class="w"> </span><span class="sb">`</span>/home/tomh/hg/sep09/ns-3-allinone/ns-3-dev-678/build<span class="s1">&#39;</span>
<span class="s1">Waf: Leaving directory `/home/tomh/hg/sep09/ns-3-allinone/ns-3-dev-678/build&#39;</span>
<span class="s1">&#39;build&#39;</span><span class="w"> </span>finished<span class="w"> </span>successfully<span class="w"> </span><span class="o">(</span><span class="m">0</span>.380s<span class="o">)</span>
GNU<span class="w"> </span>gdb<span class="w"> </span><span class="m">6</span>.8-debian
Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2008</span><span class="w"> </span>Free<span class="w"> </span>Software<span class="w"> </span>Foundation,<span class="w"> </span>Inc.
L<span class="w"> </span>cense<span class="w"> </span>GPLv3+:<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>version<span class="w"> </span><span class="m">3</span><span class="w"> </span>or<span class="w"> </span>later<span class="w"> </span>&lt;http://gnu.org/licenses/gpl.html&gt;
This<span class="w"> </span>is<span class="w"> </span>free<span class="w"> </span>software:<span class="w"> </span>you<span class="w"> </span>are<span class="w"> </span>free<span class="w"> </span>to<span class="w"> </span>change<span class="w"> </span>and<span class="w"> </span>redistribute<span class="w"> </span>it.
There<span class="w"> </span>is<span class="w"> </span>NO<span class="w"> </span>WARRANTY,<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>extent<span class="w"> </span>permitted<span class="w"> </span>by<span class="w"> </span>law.<span class="w">  </span>Type<span class="w"> </span><span class="s2">&quot;show copying&quot;</span>
and<span class="w"> </span><span class="s2">&quot;show warranty&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>details.
This<span class="w"> </span>GDB<span class="w"> </span>was<span class="w"> </span>configured<span class="w"> </span>as<span class="w"> </span><span class="s2">&quot;x86_64-linux-gnu&quot;</span>...
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>r<span class="w"> </span>--suite<span class="o">=</span>
Starting<span class="w"> </span>program:<span class="w"> </span>&lt;..&gt;/build/utils/ns3-dev-test-runner-debug<span class="w"> </span>--suite<span class="o">=</span>wifi-interference
<span class="o">[</span>Thread<span class="w"> </span>debugging<span class="w"> </span>using<span class="w"> </span>libthread_db<span class="w"> </span>enabled<span class="o">]</span>
assert<span class="w"> </span>failed.<span class="w"> </span><span class="nv">file</span><span class="o">=</span>../src/core/model/type-id.cc,<span class="w"> </span><span class="nv">line</span><span class="o">=</span><span class="m">138</span>,<span class="w"> </span><span class="nv">cond</span><span class="o">=</span><span class="s2">&quot;uid &lt;= m_information.size() &amp;&amp; uid != 0&quot;</span>
...
</pre></div>
</div>
<p>Here is another example of how to use valgrind to debug a memory problem
such as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>VALGR:<span class="w"> </span>TestSuite<span class="w"> </span>devices-mesh-dot11s-regression

$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>test-runner<span class="w"> </span>--command-template<span class="o">=</span><span class="s2">&quot;valgrind %s --suite=devices-mesh-dot11s-regression&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="class-testrunner">
<h5><span class="section-number">4.5.3.6. </span>Class TestRunner<a class="headerlink" href="#class-testrunner" title="Link to this heading">¶</a></h5>
<p>The executables that run dedicated test programs use a TestRunner class.  This
class provides for automatic test registration and listing, as well as a way to
execute the individual tests.  Individual test suites use C++ global
constructors
to add themselves to a collection of test suites managed by the test runner.
The test runner is used to list all of the available tests and to select a test
to be run.  This is a quite simple class that provides three static methods to
provide or Adding and Getting test suites to a collection of tests.  See the
doxygen for class <code class="docutils literal notranslate"><span class="pre">ns3::TestRunner</span></code> for details.</p>
</section>
<section id="test-suite">
<h5><span class="section-number">4.5.3.7. </span>Test Suite<a class="headerlink" href="#test-suite" title="Link to this heading">¶</a></h5>
<p>All <em>ns-3</em> tests are classified into Test Suites and Test Cases.  A
test suite is a collection of test cases that completely exercise a given kind
of functionality.  As described above, test suites can be classified as,</p>
<ul class="simple">
<li><p>Build Verification Tests</p></li>
<li><p>Unit Tests</p></li>
<li><p>System Tests</p></li>
<li><p>Examples</p></li>
<li><p>Performance Tests</p></li>
</ul>
<p>This classification is exported from the TestSuite class.  This class is quite
simple, existing only as a place to export this type and to accumulate test
cases.  From a user perspective, in order to create a new TestSuite in the
system one only has to define a new class that inherits from class <code class="docutils literal notranslate"><span class="pre">TestSuite</span></code>
and perform these two duties.</p>
<p>The following code will define a new class that can be run by <code class="docutils literal notranslate"><span class="pre">test.py</span></code>
as a ‘’unit’’ test with the display name, <code class="docutils literal notranslate"><span class="pre">my-test-suite-name</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MySuite</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TestSuite</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">MyTestSuite</span><span class="p">();</span>
<span class="p">};</span>

<span class="n">MyTestSuite</span><span class="o">::</span><span class="n">MyTestSuite</span><span class="p">()</span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">TestSuite</span><span class="p">(</span><span class="s">&quot;my-test-suite-name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UNIT</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">AddTestCase</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MyTestCase</span><span class="p">,</span><span class="w"> </span><span class="n">TestCase</span><span class="o">::</span><span class="n">QUICK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">MyTestSuite</span><span class="w"> </span><span class="n">myTestSuite</span><span class="p">;</span>
</pre></div>
</div>
<p>The base class takes care of all of the registration and reporting required to
be a good citizen in the test framework.</p>
<p>Avoid putting initialization logic into the test suite or test case
constructors.  This is
because an instance of the test suite is created at run time
(due to the static variable above) regardless of whether the test is being
run or not.  Instead, the TestCase provides a virtual <code class="docutils literal notranslate"><span class="pre">DoSetup</span></code> method
that can be specialized to perform setup before <code class="docutils literal notranslate"><span class="pre">DoRun</span></code> is called.</p>
</section>
<section id="test-case">
<h5><span class="section-number">4.5.3.8. </span>Test Case<a class="headerlink" href="#test-case" title="Link to this heading">¶</a></h5>
<p>Individual tests are created using a TestCase class.  Common models for the use
of a test case include “one test case per feature”, and “one test case per method.”
Mixtures of these models may be used.</p>
<p>In order to create a new test case in the system, all one has to do is to inherit
from the  <code class="docutils literal notranslate"><span class="pre">TestCase</span></code> base class, override the constructor to give the test
case a name and override the <code class="docutils literal notranslate"><span class="pre">DoRun</span></code> method to run the test.  Optionally,
override also the <code class="docutils literal notranslate"><span class="pre">DoSetup</span></code> method.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyTestCase</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TestCase</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">MyTestCase</span><span class="p">();</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">DoSetup</span><span class="p">();</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">DoRun</span><span class="p">();</span>
<span class="p">};</span>

<span class="n">MyTestCase</span><span class="o">::</span><span class="n">MyTestCase</span><span class="p">()</span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">TestCase</span><span class="p">(</span><span class="s">&quot;Check some bit of functionality&quot;</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">MyTestCase</span><span class="o">::</span><span class="n">DoRun</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">NS_TEST_ASSERT_MSG_EQ</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Some failure message&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="utilities">
<h5><span class="section-number">4.5.3.9. </span>Utilities<a class="headerlink" href="#utilities" title="Link to this heading">¶</a></h5>
<p>There are a number of utilities of various kinds that are also part of the
testing framework.  Examples include a generalized pcap file useful for
storing test vectors; a generic container useful for transient storage of
test vectors during test execution; and tools for generating presentations
based on validation and verification testing results.</p>
<p>These utilities are not documented here, but for example, please see
how the TCP tests found in <code class="docutils literal notranslate"><span class="pre">src/test/ns3tcp/</span></code> use pcap files and reference
output.</p>
</section>
</section>
<span id="document-how-to-write-tests"></span><section id="how-to-write-tests">
<h4><span class="section-number">4.5.4. </span>How to write tests<a class="headerlink" href="#how-to-write-tests" title="Link to this heading">¶</a></h4>
<p>A primary goal of the ns-3 project is to help users to improve the
validity and credibility of their results.  There are many elements
to obtaining valid models and simulations, and testing is a major
component.  If you contribute models or examples to ns-3, you may
be asked to contribute test code.  Models that you contribute will be
used for many years by other people, who probably have no idea upon
first glance whether the model is correct.  The test code that you
write for your model will help to avoid future regressions in
the output and will aid future users in understanding the verification
and bounds of applicability of your models.</p>
<p>There are many ways to verify the correctness of a model’s implementation.
In this section,
we hope to cover some common cases that can be used as a guide to
writing new tests.</p>
<section id="sample-testsuite-skeleton">
<h5><span class="section-number">4.5.4.1. </span>Sample TestSuite skeleton<a class="headerlink" href="#sample-testsuite-skeleton" title="Link to this heading">¶</a></h5>
<p>When starting from scratch (i.e. not adding a TestCase to an existing
TestSuite), these things need to be decided up front:</p>
<ul class="simple">
<li><p>What the test suite will be called</p></li>
<li><p>What type of test it will be (Build Verification Test, Unit Test,
System Test, or Performance Test)</p></li>
<li><p>Where the test code will live (either in an existing ns-3 module or
separately in src/test/ directory).  You will have to edit the wscript
file in that directory to compile your new code, if it is a new file.</p></li>
</ul>
<p>A program called <code class="docutils literal notranslate"><span class="pre">utils/create-module.py</span></code> is a good starting point.
This program can be invoked such as <code class="docutils literal notranslate"><span class="pre">create-module.py</span> <span class="pre">router</span></code> for
a hypothetical new module called <code class="docutils literal notranslate"><span class="pre">router</span></code>.  Once you do this, you
will see a <code class="docutils literal notranslate"><span class="pre">router</span></code> directory, and a <code class="docutils literal notranslate"><span class="pre">test/router-test-suite.cc</span></code>
test suite.  This file can be a starting point for your initial test.
This is a working test suite, although the actual tests performed are
trivial.  Copy it over to your module’s test directory, and do a global
substitution of “Router” in that file for something pertaining to
the model that you want to test.  You can also edit things such as a
more descriptive test case name.</p>
<p>You also need to add a block into your wscript to get this test to
compile:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">module_test</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;test/router-test-suite.cc&#39;</span><span class="p">,</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>Before you actually start making this do useful things, it may help
to try to run the skeleton.  Make sure that ns-3 has been configured with
the “–enable-tests” option.  Let’s assume that your new test suite
is called “router” such as here:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">RouterTestSuite</span><span class="o">::</span><span class="n">RouterTestSuite</span><span class="p">()</span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">TestSuite</span><span class="p">(</span><span class="s">&quot;router&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UNIT</span><span class="p">)</span>
</pre></div>
</div>
<p>Try this command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./test.py<span class="w"> </span>-s<span class="w"> </span>router
</pre></div>
</div>
<p>Output such as below should be produced:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>PASS: TestSuite router
1 of 1 tests passed (1 passed, 0 skipped, 0 failed, 0 crashed, 0 valgrind errors)
</pre></div>
</div>
<p>See src/lte/test/test-lte-antenna.cc for a worked example.</p>
</section>
<section id="test-macros">
<h5><span class="section-number">4.5.4.2. </span>Test macros<a class="headerlink" href="#test-macros" title="Link to this heading">¶</a></h5>
<p>There are a number of macros available for checking test program
output with expected output.  These macros are defined in
<code class="docutils literal notranslate"><span class="pre">src/core/model/test.h</span></code>.</p>
<p>The main set of macros that are used include the following:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NS_TEST_ASSERT_MSG_EQ</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
<span class="n">NS_TEST_ASSERT_MSG_NE</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
<span class="n">NS_TEST_ASSERT_MSG_LT</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
<span class="n">NS_TEST_ASSERT_MSG_GT</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
<span class="n">NS_TEST_ASSERT_MSG_EQ_TOL</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">,</span><span class="w"> </span><span class="n">tol</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
<p>The first argument <code class="docutils literal notranslate"><span class="pre">actual</span></code> is the value under test, the second value
<code class="docutils literal notranslate"><span class="pre">limit</span></code> is the expected value (or the value to test against), and the
last argument <code class="docutils literal notranslate"><span class="pre">msg</span></code> is the error message to print out if the test fails.</p>
<p>The first four macros above test for equality, inequality, less than, or
greater than, respectively.  The fifth macro above tests for equality,
but within a certain tolerance.  This variant is useful when testing
floating point numbers for equality against a limit, where you want to
avoid a test failure due to rounding errors.</p>
<p>Finally, there are variants of the above where the keyword <code class="docutils literal notranslate"><span class="pre">ASSERT</span></code>
is replaced by <code class="docutils literal notranslate"><span class="pre">EXPECT</span></code>.  These variants are designed specially for
use in methods (especially callbacks) returning void.  Reserve their
use for callbacks that you use in your test programs; otherwise,
use the <code class="docutils literal notranslate"><span class="pre">ASSERT</span></code> variants.</p>
</section>
<section id="how-to-add-an-example-program-to-the-test-suite">
<h5><span class="section-number">4.5.4.3. </span>How to add an example program to the test suite<a class="headerlink" href="#how-to-add-an-example-program-to-the-test-suite" title="Link to this heading">¶</a></h5>
<p>There are two methods for adding an example program to the the test
suite.  Normally an example is added using only one of these methods
to avoid running the example twice.</p>
<p>First, you can “smoke test” that examples compile and run successfully
to completion (without memory leaks) using the <code class="docutils literal notranslate"><span class="pre">examples-to-run.py</span></code>
script located in your module’s test directory.  Briefly, by including
an instance of this file in your test directory, you can cause the
test runner to execute the examples listed.  It is usually best to
make sure that you select examples that have reasonably short run
times so as to not bog down the tests.  See the example in
<code class="docutils literal notranslate"><span class="pre">src/lte/test/</span></code> directory.  The exit status of the example will be
checked when run and a non-zero exit status can be used to indicate
that the example has failed.  This is the easiest way to add an example
to the test suite but has limited checks.</p>
<p>The second method you can use to add an example to the test suite is
more complicated but enables checking of the example output
(<code class="docutils literal notranslate"><span class="pre">std::out</span></code> and <code class="docutils literal notranslate"><span class="pre">std::err</span></code>).  This approach uses the test suite
framework with a specialized <code class="docutils literal notranslate"><span class="pre">TestSuite</span></code> or <code class="docutils literal notranslate"><span class="pre">TestCase</span></code> class
designed to run an example and compare the output with a specified
known “good” reference file.  To use an example program as a test you
need to create a test suite file and add it to the appropriate list in
your module wscript file. The “good” output reference file needs to be
generated for detecting regressions.</p>
<p>If you are thinking about using this class, strongly consider using a
standard test instead.  The TestSuite class has better checking using
the <code class="docutils literal notranslate"><span class="pre">NS_TEST_*</span></code> macros and in almost all cases is the better approach.
If your test can be done with a TestSuite class you will be asked by
the reviewers to rewrite the test when you do a pull request.</p>
<p>Let’s assume your module is called <code class="docutils literal notranslate"><span class="pre">mymodule</span></code>, and the example
program is <code class="docutils literal notranslate"><span class="pre">mymodule/examples/mod-example.cc</span></code>.  First you should
create a test file <code class="docutils literal notranslate"><span class="pre">mymodule/test/mymodule-examples-test-suite.cc</span></code>
which looks like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/example-as-test.h&quot;</span>
<span class="k">static</span><span class="w"> </span><span class="n">ns3</span><span class="o">::</span><span class="n">ExampleAsTestSuite</span><span class="w"> </span><span class="n">g_modExampleOne</span><span class="p">(</span><span class="s">&quot;mymodule-example-mod-example-one&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mod-example&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">NS_TEST_SOURCEDIR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;--arg-one&quot;</span><span class="p">);</span>
<span class="k">static</span><span class="w"> </span><span class="n">ns3</span><span class="o">::</span><span class="n">ExampleAsTestSuite</span><span class="w"> </span><span class="n">g_modExampleTwo</span><span class="p">(</span><span class="s">&quot;mymodule-example-mod-example-two&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mod-example&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">NS_TEST_SOURCEDIR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;--arg-two&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>The arguments to the constructor are the name of the test suite, the
example to run, the directory that contains the “good” reference file
(the macro <code class="docutils literal notranslate"><span class="pre">NS_TEST_SOURCEDIR</span></code> is normally the correct directory),
and command line arguments for the example.  In the preceding code the
same example is run twice with different arguments.</p>
<p>You then need to add that newly created test suite file to the list of
test sources in <code class="docutils literal notranslate"><span class="pre">mymodule/wscript</span></code>.  Building of examples
is an option so you need to guard the inclusion of the test suite:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">bld</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ENABLE_EXAMPLES&#39;</span><span class="p">]):</span>
   <span class="n">module</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;model/mymodule-examples-test-suite.cc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Since you modified a wscript file you need to reconfigure and rebuild
everything.</p>
<p>You just added new tests so you will need to generate the “good”
output reference files that will be used to verify the example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./test.py<span class="w"> </span>--suite<span class="o">=</span><span class="s2">&quot;mymodule-example-*&quot;</span><span class="w"> </span>--update
</pre></div>
</div>
<p>This will run all tests starting with “mymodule-example-” and save new
“good” reference files.  Updating the reference files should be done
when you create the test and whenever output changes.  When updating
the reference output you should inspect it to ensure that it is valid.
The reference files should be committed with the new test.</p>
<p>This completes the process of adding a new example.</p>
<p>You can now run the test with the standard <code class="docutils literal notranslate"><span class="pre">test.py</span></code> script.  For
example to run the suites you just added:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./test.py<span class="w"> </span>--suite<span class="o">=</span><span class="s2">&quot;mymodule-example-*&quot;</span>
</pre></div>
</div>
<p>This will run all <code class="docutils literal notranslate"><span class="pre">mymodule-example-...</span></code> tests and report whether they
produce output matching the reference files.</p>
<p>You can also add multiple examples as test cases to a <code class="docutils literal notranslate"><span class="pre">TestSuite</span></code>
using <code class="docutils literal notranslate"><span class="pre">ExampleAsTestCase</span></code>.  See
<code class="docutils literal notranslate"><span class="pre">src/core/test/examples-as-tests-test-suite.cc</span></code> for examples of
setting examples as tests.</p>
<p>When setting up an example for use by this class you should be very
careful about what output the example generates.  For example, writing
output which includes simulation time (especially high resolution
time) makes the test sensitive to potentially minor changes in event
times.  This makes the reference output hard to verify and hard to
keep up-to-date.  Output as little as needed for the example and
include only behavioral state that is important for determining if the
example has run correctly.</p>
</section>
<section id="testing-de-serialization-of-headers">
<h5><span class="section-number">4.5.4.4. </span>Testing (de)serialization of Headers<a class="headerlink" href="#testing-de-serialization-of-headers" title="Link to this heading">¶</a></h5>
<p>Implementing serialization and deserialization of Headers is often prone to
errors. A generic approach to test these operations is to start from a given
Header, serialize the given header in a buffer, then create a new header by
deserializing from the buffer and serialize the new header into a second buffer.
If everything is correct, the two buffers have the same size and the same content.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">HeaderSerializationTestCase</span></code> class enables to perform such a test in an
easy manner. Test cases willing to exploit such an approach have to inherit from
<code class="docutils literal notranslate"><span class="pre">HeaderSerializationTestCase</span></code> instead of <code class="docutils literal notranslate"><span class="pre">TestCase</span></code> and pass a Header object
to the <code class="docutils literal notranslate"><span class="pre">TestHeaderSerialization</span></code> method (along with arguments that may be
needed to construct the new header that is going to be deserialized).</p>
<p>Note that such an approach is not restricted to Header subclasses, but it is
available for all classes that provide (de)serialization operations, such as
the wifi Information Elements.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/header-serialization-test.h&quot;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BasicMultiLinkElementTest</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">HeaderSerializationTestCase</span>
<span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">};</span>
<span class="kt">void</span>
<span class="nf">BasicMultiLinkElementTest::DoRun</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">MultiLinkElement</span><span class="w"> </span><span class="n">mle</span><span class="p">(</span><span class="n">WIFI_MAC_MGT_BEACON</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// Fill in the Multi-Link Element</span>
<span class="w">  </span><span class="n">TestHeaderSerialization</span><span class="p">(</span><span class="n">mle</span><span class="p">,</span><span class="w"> </span><span class="n">WIFI_MAC_MGT_BEACON</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Examples of this approach are found, e.g., in <code class="docutils literal notranslate"><span class="pre">src/wifi/test/wifi-eht-info-elems-test.cc</span></code></p>
</section>
<section id="testing-for-boolean-outcomes">
<h5><span class="section-number">4.5.4.5. </span>Testing for boolean outcomes<a class="headerlink" href="#testing-for-boolean-outcomes" title="Link to this heading">¶</a></h5>
</section>
<section id="testing-outcomes-when-randomness-is-involved">
<h5><span class="section-number">4.5.4.6. </span>Testing outcomes when randomness is involved<a class="headerlink" href="#testing-outcomes-when-randomness-is-involved" title="Link to this heading">¶</a></h5>
</section>
<section id="testing-output-data-against-a-known-distribution">
<h5><span class="section-number">4.5.4.7. </span>Testing output data against a known distribution<a class="headerlink" href="#testing-output-data-against-a-known-distribution" title="Link to this heading">¶</a></h5>
</section>
<section id="providing-non-trivial-input-vectors-of-data">
<h5><span class="section-number">4.5.4.8. </span>Providing non-trivial input vectors of data<a class="headerlink" href="#providing-non-trivial-input-vectors-of-data" title="Link to this heading">¶</a></h5>
</section>
<section id="storing-and-referencing-non-trivial-output-data">
<h5><span class="section-number">4.5.4.9. </span>Storing and referencing non-trivial output data<a class="headerlink" href="#storing-and-referencing-non-trivial-output-data" title="Link to this heading">¶</a></h5>
</section>
<section id="presenting-your-output-test-data">
<h5><span class="section-number">4.5.4.10. </span>Presenting your output test data<a class="headerlink" href="#presenting-your-output-test-data" title="Link to this heading">¶</a></h5>
</section>
</section>
</div>
</section>
<span id="document-new-models"></span><section id="creating-a-new-ns3-model">
<h3><span class="section-number">4.6. </span>Creating a new <em>ns-3</em> model<a class="headerlink" href="#creating-a-new-ns3-model" title="Link to this heading">¶</a></h3>
<p>This chapter walks through the design process of an <em>ns-3</em> model.  In many
research cases, users will not be satisfied to merely adapt existing models, but
may want to extend the core of the simulator in a novel way. We will use the
example of adding an ErrorModel to a simple <em>ns-3</em> link as a motivating example
of how one might approach this problem and proceed through a design and
implementation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Documentation</p>
<p>Here we focus on the process of creating new models
and new modules, and some of the design choices involved.
For the sake of clarity, we defer discussion of the
<em>mechanics</em> of documenting models and source code to the
<a class="reference internal" href="index.html#document-documentation"><span class="doc">Documentation</span></a> chapter.</p>
</div>
<section id="design-approach">
<h4><span class="section-number">4.6.1. </span>Design Approach<a class="headerlink" href="#design-approach" title="Link to this heading">¶</a></h4>
<p>Consider how you want it to work; what should it do. Think about these things:</p>
<ul class="simple">
<li><p><em>functionality:</em>  What functionality should it have?  What attributes or
configuration is exposed to the user?</p></li>
<li><p><em>reusability:</em>  How much should others be able to reuse my design?  Can I
reuse code from <em>ns-2</em> to get started?  How does a user integrate the model
with the rest of another simulation?</p></li>
<li><p><em>dependencies:</em>  How can I reduce the introduction of outside dependencies on
my new code as much as possible (to make it more modular)?  For instance,
should I avoid any dependence on IPv4 if I want it to also be used by IPv6?
Should I avoid any dependency on IP at all?</p></li>
</ul>
<p>Do not be hesitant to contact the <cite>ns-3-users</cite> or <cite>ns-developers</cite> list if you have
questions. In particular, it is important to think about the public API of your
new model and ask for feedback. It also helps to let others know of your work in
case you are interested in collaborators.</p>
<section id="example-errormodel">
<h5><span class="section-number">4.6.1.1. </span>Example: <cite>ErrorModel</cite><a class="headerlink" href="#example-errormodel" title="Link to this heading">¶</a></h5>
<p>An error model exists in <em>ns-2</em>. It allows packets to be passed to a stateful
object that determines, based on a random variable, whether the packet is
corrupted.  The caller can then decide what to do with the packet (drop it,
etc.).</p>
<p>The main API of the error model is a function to pass a packet to, and the
return value of this function is a boolean that tells the caller whether any
corruption occurred.  Note that depending on the error model, the packet data
buffer may or may not be corrupted.  Let’s call this function “IsCorrupt()”.</p>
<p>So far, in our design, we have:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ErrorModel</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w"> </span><span class="cm">/**</span>
<span class="cm">  * \returns true if the Packet is to be considered as errored/corrupted</span>
<span class="cm">  * \param pkt Packet to apply error model to</span>
<span class="cm">  */</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">IsCorrupt</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Packet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pkt</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Note that we do not pass a const pointer, thereby allowing the function to
modify the packet if IsCorrupt() returns true. Not all error models will
actually modify the packet; whether or not the packet data buffer is corrupted
should be documented.</p>
<p>We may also want specialized versions of this, such as in <em>ns-2</em>, so although it
is not the only design choice for polymorphism, we assume that we will subclass
a base class ErrorModel for specialized classes, such as RateErrorModel,
ListErrorModel, etc, such as is done in <em>ns-2</em>.</p>
<p>You may be thinking at this point, “Why not make IsCorrupt() a virtual method?”.
That is one approach; the other is to make the public non-virtual function
indirect through a private virtual function (this in C++ is known as the non
virtual interface idiom and is adopted in the <em>ns-3</em> ErrorModel class).</p>
<p>Next, should this device have any dependencies on IP or other protocols?  We do
not want to create dependencies on Internet protocols (the error model should be
applicable to non-Internet protocols too), so we’ll keep that in mind later.</p>
<p>Another consideration is how objects will include this error model.  We envision
putting an explicit setter in certain NetDevice implementations, for example.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Attach a receive ErrorModel to the PointToPointNetDevice.</span>
<span class="cm"> *</span>
<span class="cm"> * The PointToPointNetDevice may optionally include an ErrorModel in</span>
<span class="cm"> * the packet receive chain.</span>
<span class="cm"> *</span>
<span class="cm"> * @see ErrorModel</span>
<span class="cm"> * @param em Ptr to the ErrorModel.</span>
<span class="cm"> */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">PointToPointNetDevice::SetReceiveErrorModel</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">ErrorModel</span><span class="o">&gt;</span><span class="w"> </span><span class="n">em</span><span class="p">);</span>
</pre></div>
</div>
<p>Again, this is not the only choice we have (error models could be aggregated to
lots of other objects), but it satisfies our primary use case, which is to allow
a user to force errors on otherwise successful packet transmissions, at the
NetDevice level.</p>
<p>After some thinking and looking at existing <em>ns-2</em> code, here is a sample API of
a base class and first subclass that could be posted for initial review:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ErrorModel</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">ErrorModel</span><span class="p">();</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">ErrorModel</span><span class="p">();</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">IsCorrupt</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Packet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pkt</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">Reset</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">Enable</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">Disable</span><span class="p">();</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">IsEnabled</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">DoCorrupt</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Packet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pkt</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">DoReset</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span><span class="w"> </span><span class="nc">ErrorUnit</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">EU_BIT</span><span class="p">,</span>
<span class="w">    </span><span class="n">EU_BYTE</span><span class="p">,</span>
<span class="w">    </span><span class="n">EU_PKT</span>
<span class="w">  </span><span class="p">};</span>

<span class="c1">// Determine which packets are errored corresponding to an underlying</span>
<span class="c1">// random variable distribution, an error rate, and unit for the rate.</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RateErrorModel</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ErrorModel</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">RateErrorModel</span><span class="p">();</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">RateErrorModel</span><span class="p">();</span>
<span class="w">  </span><span class="k">enum</span><span class="w"> </span><span class="nc">ErrorUnit</span><span class="w"> </span><span class="n">GetUnit</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">SetUnit</span><span class="p">(</span><span class="k">enum</span><span class="w"> </span><span class="nc">ErrorUnit</span><span class="w"> </span><span class="n">error_unit</span><span class="p">);</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="nf">GetRate</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">SetRate</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">rate</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">SetRandomVariable</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">RandomVariable</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ranvar</span><span class="p">);</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">DoCorrupt</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Packet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pkt</span><span class="p">);</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">DoReset</span><span class="p">();</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
</section>
<section id="scaffolding">
<h4><span class="section-number">4.6.2. </span>Scaffolding<a class="headerlink" href="#scaffolding" title="Link to this heading">¶</a></h4>
<p>Let’s say that you are ready to start implementing; you have a fairly clear
picture of what you want to build, and you may have solicited some initial
review or suggestions from the list.  One way to approach the next step
(implementation) is to create scaffolding and fill in the details as the design
matures.</p>
<p>This section walks through many of the steps you should consider to define
scaffolding, or a non-functional skeleton of what your model will eventually
implement. It is usually good practice to not wait to get these details
integrated at the end, but instead to plumb a skeleton of your model into the
system early and then add functions later once the API and integration seems
about right.</p>
<p>Note that you will want to modify a few things in the below presentation for
your model since if you follow the error model verbatim, the code you produce
will collide with the existing error model. The below is just an outline of how
ErrorModel was built that you can adapt to other models.</p>
<section id="review-the-ns3-coding-style-document">
<h5><span class="section-number">4.6.2.1. </span>Review the <em>ns-3</em> Coding Style Document<a class="headerlink" href="#review-the-ns3-coding-style-document" title="Link to this heading">¶</a></h5>
<p>At this point, you may want to pause and read the <em>ns-3</em> coding style document,
especially if you are considering to contribute your code back to the project.
The coding style document is linked off the main project page: <a class="reference external" href="http://www.nsnam.org/developers/contributing-code/coding-style/">ns-3 coding
style</a>.</p>
</section>
<section id="decide-where-in-the-source-tree-the-model-should-reside">
<h5><span class="section-number">4.6.2.2. </span>Decide Where in the Source Tree the Model Should Reside<a class="headerlink" href="#decide-where-in-the-source-tree-the-model-should-reside" title="Link to this heading">¶</a></h5>
<p>All of the <em>ns-3</em> model source code is in the directory <code class="docutils literal notranslate"><span class="pre">src/</span></code>.  You will need
to choose which subdirectory it resides in. If it is new model code of some
sort, it makes sense to put it into the <code class="docutils literal notranslate"><span class="pre">src/</span></code> directory somewhere,
particularly for ease of integrating with the build system.</p>
<p>In the case of the error model, it is very related to the packet class, so it
makes sense to implement this in the <code class="docutils literal notranslate"><span class="pre">src/network/</span></code> module where <em>ns-3</em>
packets are implemented.</p>
</section>
<section id="cmake-and-cmakelists-txt">
<h5><span class="section-number">4.6.2.3. </span><cite>cmake</cite> and <cite>CMakeLists.txt</cite><a class="headerlink" href="#cmake-and-cmakelists-txt" title="Link to this heading">¶</a></h5>
<p><em>ns-3</em> uses the <a class="reference external" href="https://cmake.org/">CMake</a> build system.
You will want to integrate your new <em>ns-3</em> uses the CMake build system. You will
want to integrate your new source files into this system. This requires that you
add your files to the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file found in each directory.</p>
<p>Let’s start with empty files error-model.h and error-model.cc, and add this to
<code class="docutils literal notranslate"><span class="pre">src/network/CMakeLists.txt</span></code>. It is really just a matter of adding the .cc file to the
rest of the source files, and the .h file to the list of the header files.</p>
<p>Now, pop up to the top level directory and type “./test.py”.  You
shouldn’t have broken anything by this operation.</p>
</section>
<section id="include-guards">
<h5><span class="section-number">4.6.2.4. </span>Include Guards<a class="headerlink" href="#include-guards" title="Link to this heading">¶</a></h5>
<p>Next, let’s add some <a class="reference external" href="http://en.wikipedia.org/wiki/Include_guard">include guards</a> in our header file.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef ERROR_MODEL_H</span>
<span class="cp">#define ERROR_MODEL_H</span>
<span class="p">...</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="namespace-ns3">
<h5><span class="section-number">4.6.2.5. </span><cite>namespace ns3</cite><a class="headerlink" href="#namespace-ns3" title="Link to this heading">¶</a></h5>
<p><em>ns-3</em> uses the <em>ns-3</em> <a class="reference external" href="http://en.wikipedia.org/wiki/Namespace_(computer_science)#Use_in_common_languages">namespace</a>
to isolate its symbols from other namespaces. Typically, a user will next put
an <em>ns-3</em> namespace block in both the cc and h file.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">ns3</span><span class="w"> </span><span class="p">{</span>
<span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>At this point, we have some skeletal files in which we can start defining
our new classes. The header file looks like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef ERROR_MODEL_H</span>
<span class="cp">#define ERROR_MODEL_H</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">ns3</span><span class="w"> </span><span class="p">{</span>

<span class="p">}</span><span class="w"> </span><span class="c1">// namespace ns3</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>while the <code class="docutils literal notranslate"><span class="pre">error-model.cc</span></code> file simply looks like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;error-model.h&quot;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">ns3</span><span class="w"> </span><span class="p">{</span>

<span class="p">}</span><span class="w"> </span><span class="c1">// namespace ns3</span>
</pre></div>
</div>
<p>These files should compile since they don’t really have any contents.  We’re now
ready to start adding classes.</p>
</section>
</section>
<section id="initial-implementation">
<h4><span class="section-number">4.6.3. </span>Initial Implementation<a class="headerlink" href="#initial-implementation" title="Link to this heading">¶</a></h4>
<p>At this point, we’re still working on some scaffolding, but we can begin to
define our classes, with the functionality to be added later.</p>
<section id="inherit-from-the-object-class">
<h5><span class="section-number">4.6.3.1. </span>Inherit from the <cite>Object</cite> Class?<a class="headerlink" href="#inherit-from-the-object-class" title="Link to this heading">¶</a></h5>
<p>This is an important design step; whether to use class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code> as a
base class for your new classes.</p>
<p>As described in the chapter on the <em>ns-3</em> <a class="reference internal" href="index.html#object-model"><span class="std std-ref">Object model</span></a>, classes that
inherit from class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code> get special properties:</p>
<ul class="simple">
<li><p>the <em>ns-3</em> type and attribute system (see <a class="reference internal" href="index.html#attributes"><span class="std std-ref">Configuration and Attributes</span></a>)</p></li>
<li><p>an object aggregation system</p></li>
<li><p>a smart-pointer reference counting system (class Ptr)</p></li>
</ul>
<p>Classes that derive from class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ObjectBase</span></code>} get the first two
properties above, but do not get smart pointers. Classes that derive from class
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">RefCountBase</span></code> get only the smart-pointer reference counting system.</p>
<p>In practice, class <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code> is the variant of the three above that
the <em>ns-3</em> developer will most commonly encounter.</p>
<p>In our case, we want to make use of the attribute system, and we will be passing
instances of this object across the <em>ns-3</em> public API, so class
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Object</span></code> is appropriate for us.</p>
</section>
<section id="initial-classes">
<h5><span class="section-number">4.6.3.2. </span>Initial Classes<a class="headerlink" href="#initial-classes" title="Link to this heading">¶</a></h5>
<p>One way to proceed is to start by defining the bare minimum functions and see if
they will compile. Let’s review what all is needed to implement when we derive
from class Object.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef ERROR_MODEL_H</span>
<span class="cp">#define ERROR_MODEL_H</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/object.h&quot;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">ns3</span><span class="w"> </span><span class="p">{</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ErrorModel</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Object</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">GetTypeId</span><span class="p">();</span>

<span class="w">  </span><span class="n">ErrorModel</span><span class="p">();</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">ErrorModel</span><span class="p">();</span>
<span class="p">};</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RateErrorModel</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ErrorModel</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">GetTypeId</span><span class="p">();</span>

<span class="w">  </span><span class="n">RateErrorModel</span><span class="p">();</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">RateErrorModel</span><span class="p">();</span>
<span class="p">};</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>A few things to note here. We need to include <code class="docutils literal notranslate"><span class="pre">object.h</span></code>. The convention in
<em>ns-3</em> is that if the header file is co-located in the same directory, it may be
included without any path prefix. Therefore, if we were implementing ErrorModel
in <code class="docutils literal notranslate"><span class="pre">src/core/model</span></code> directory, we could have just said “<code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&quot;object.h&quot;</span></code>”.
But we are in <code class="docutils literal notranslate"><span class="pre">src/network/model</span></code>, so we must include it as “<code class="docutils literal notranslate"><span class="pre">#include</span>
<span class="pre">&quot;ns3/object.h&quot;</span></code>”. Note also that this goes outside the namespace declaration.</p>
<p>Second, each class must implement a static public member function called
<code class="docutils literal notranslate"><span class="pre">GetTypeId()</span></code>.</p>
<p>Third, it is a good idea to implement constructors and destructors rather than
to let the compiler generate them, and to make the destructor virtual. In C++,
note also that copy assignment operator and copy constructors are auto-generated
if they are not defined, so if you do not want those, you should implement those
as private members. This aspect of C++ is discussed in Scott Meyers’ Effective
C++ book. item 45.</p>
<p>Let’s now look at some corresponding skeletal implementation code in the .cc
file.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;error-model.h&quot;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">ns3</span><span class="w"> </span><span class="p">{</span>

<span class="n">NS_OBJECT_ENSURE_REGISTERED</span><span class="p">(</span><span class="n">ErrorModel</span><span class="p">);</span>

<span class="n">TypeId</span><span class="w"> </span><span class="nf">ErrorModel::GetTypeId</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeId</span><span class="p">(</span><span class="s">&quot;ns3::ErrorModel&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">SetParent</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">SetGroupName</span><span class="p">(</span><span class="s">&quot;Network&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">ErrorModel</span><span class="o">::</span><span class="n">ErrorModel</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">ErrorModel</span><span class="o">::~</span><span class="n">ErrorModel</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">NS_OBJECT_ENSURE_REGISTERED</span><span class="p">(</span><span class="n">RateErrorModel</span><span class="p">);</span>

<span class="n">TypeId</span><span class="w"> </span><span class="nf">RateErrorModel::GetTypeId</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeId</span><span class="p">(</span><span class="s">&quot;ns3::RateErrorModel&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">SetParent</span><span class="o">&lt;</span><span class="n">ErrorModel</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">SetGroupName</span><span class="p">(</span><span class="s">&quot;Network&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddConstructor</span><span class="o">&lt;</span><span class="n">RateErrorModel</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">RateErrorModel</span><span class="o">::</span><span class="n">RateErrorModel</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">RateErrorModel</span><span class="o">::~</span><span class="n">RateErrorModel</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p>What is the <code class="docutils literal notranslate"><span class="pre">GetTypeId()</span></code> function? This function does a few things.  It
registers a unique string into the TypeId system. It establishes  the hierarchy
of objects in the attribute system (via <code class="docutils literal notranslate"><span class="pre">SetParent</span></code>). It also declares that
certain objects can be created via the object creation framework
(<code class="docutils literal notranslate"><span class="pre">AddConstructor</span></code>).</p>
<p>The macro <code class="docutils literal notranslate"><span class="pre">NS_OBJECT_ENSURE_REGISTERED(classname)</span></code> is needed also once for
every class that defines a new GetTypeId method, and it does the actual
registration of the class into the system.  The <a class="reference internal" href="index.html#object-model"><span class="std std-ref">Object model</span></a> chapter
discusses this in more detail.</p>
</section>
<section id="including-external-files">
<h5><span class="section-number">4.6.3.3. </span>Including External Files<a class="headerlink" href="#including-external-files" title="Link to this heading">¶</a></h5>
</section>
<section id="logging-support">
<h5><span class="section-number">4.6.3.4. </span>Logging Support<a class="headerlink" href="#logging-support" title="Link to this heading">¶</a></h5>
<p><em>Here, write a bit about adding |ns3| logging macros. Note that
LOG_COMPONENT_DEFINE is done outside the namespace ns3</em></p>
</section>
<section id="constructor-empty-function-prototypes">
<h5><span class="section-number">4.6.3.5. </span>Constructor, Empty Function Prototypes<a class="headerlink" href="#constructor-empty-function-prototypes" title="Link to this heading">¶</a></h5>
</section>
<section id="key-variables-default-values-attributes">
<h5><span class="section-number">4.6.3.6. </span>Key Variables (Default Values, Attributes)<a class="headerlink" href="#key-variables-default-values-attributes" title="Link to this heading">¶</a></h5>
</section>
<section id="test-program-1">
<h5><span class="section-number">4.6.3.7. </span>Test Program 1<a class="headerlink" href="#test-program-1" title="Link to this heading">¶</a></h5>
</section>
<section id="object-framework">
<h5><span class="section-number">4.6.3.8. </span>Object Framework<a class="headerlink" href="#object-framework" title="Link to this heading">¶</a></h5>
</section>
</section>
<section id="adding-a-sample-script">
<h4><span class="section-number">4.6.4. </span>Adding a Sample Script<a class="headerlink" href="#adding-a-sample-script" title="Link to this heading">¶</a></h4>
<p>At this point, one may want to try to take the basic scaffolding defined above
and add it into the system. Performing this step now allows one to use a simpler
model when plumbing into the system and may also reveal whether any design or
API modifications need to be made. Once this is done, we will return to building
out the functionality of the ErrorModels themselves.</p>
<section id="add-basic-support-in-the-class">
<h5><span class="section-number">4.6.4.1. </span>Add Basic Support in the Class<a class="headerlink" href="#add-basic-support-in-the-class" title="Link to this heading">¶</a></h5>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/* point-to-point-net-device.h */</span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">ErrorModel</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/**</span>
<span class="cm">   * Error model for receive packet events</span>
<span class="cm">   */</span>
<span class="w">  </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">ErrorModel</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_receiveErrorModel</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="add-accessor">
<h5><span class="section-number">4.6.4.2. </span>Add Accessor<a class="headerlink" href="#add-accessor" title="Link to this heading">¶</a></h5>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">PointToPointNetDevice::SetReceiveErrorModel</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">ErrorModel</span><span class="o">&gt;</span><span class="w"> </span><span class="n">em</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">NS_LOG_FUNCTION</span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">em</span><span class="p">);</span>
<span class="w">  </span><span class="n">m_receiveErrorModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">em</span><span class="p">;</span>
<span class="p">}</span>

<span class="w">   </span><span class="p">.</span><span class="n">AddAttribute</span><span class="p">(</span><span class="s">&quot;ReceiveErrorModel&quot;</span><span class="p">,</span>
<span class="w">                   </span><span class="s">&quot;The receiver error model used to simulate packet loss&quot;</span><span class="p">,</span>
<span class="w">                   </span><span class="n">PointerValue</span><span class="p">(),</span>
<span class="w">                   </span><span class="n">MakePointerAccessor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PointToPointNetDevice</span><span class="o">::</span><span class="n">m_receiveErrorModel</span><span class="p">),</span>
<span class="w">                   </span><span class="n">MakePointerChecker</span><span class="o">&lt;</span><span class="n">ErrorModel</span><span class="o">&gt;</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="plumb-into-the-system">
<h5><span class="section-number">4.6.4.3. </span>Plumb Into the System<a class="headerlink" href="#plumb-into-the-system" title="Link to this heading">¶</a></h5>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">PointToPointNetDevice::Receive</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Packet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">NS_LOG_FUNCTION</span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">packet</span><span class="p">);</span>
<span class="w">  </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">protocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">m_receiveErrorModel</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">m_receiveErrorModel</span><span class="o">-&gt;</span><span class="n">IsCorrupt</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="c1">//</span>
<span class="c1">// If we have an error model and it indicates that it is time to lose a</span>
<span class="c1">// corrupted packet, don&#39;t forward this packet up, let it go.</span>
<span class="c1">//</span>
<span class="w">      </span><span class="n">m_dropTrace</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="c1">//</span>
<span class="c1">// Hit the receive trace hook, strip off the point-to-point protocol header</span>
<span class="c1">// and forward this packet up the protocol stack.</span>
<span class="c1">//</span>
<span class="w">      </span><span class="n">m_rxTrace</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
<span class="w">      </span><span class="n">ProcessHeader</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span><span class="w"> </span><span class="n">protocol</span><span class="p">);</span>
<span class="w">      </span><span class="n">m_rxCallback</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">packet</span><span class="p">,</span><span class="w"> </span><span class="n">protocol</span><span class="p">,</span><span class="w"> </span><span class="n">GetRemote</span><span class="p">());</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">m_promiscCallback</span><span class="p">.</span><span class="n">IsNull</span><span class="p">())</span>
<span class="w">        </span><span class="p">{</span><span class="w">           </span><span class="n">m_promiscCallback</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">packet</span><span class="p">,</span><span class="w"> </span><span class="n">protocol</span><span class="p">,</span><span class="w"> </span><span class="n">GetRemote</span><span class="p">(),</span>
<span class="w">                      </span><span class="n">GetAddress</span><span class="p">(),</span><span class="w"> </span><span class="n">NetDevice</span><span class="o">::</span><span class="n">PACKET_HOST</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="create-null-functional-script">
<h5><span class="section-number">4.6.4.4. </span>Create Null Functional Script<a class="headerlink" href="#create-null-functional-script" title="Link to this heading">¶</a></h5>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/* simple-error-model.cc */</span>

<span class="w">  </span><span class="c1">// Error model</span>
<span class="w">  </span><span class="c1">// We want to add an error model to node 3&#39;s NetDevice</span>
<span class="w">  </span><span class="c1">// We can obtain a handle to the NetDevice via the channel and node</span>
<span class="w">  </span><span class="c1">// pointers</span>
<span class="w">  </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">PointToPointNetDevice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">nd3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PointToPointTopology</span><span class="o">::</span><span class="n">GetNetDevice</span>
<span class="w">   </span><span class="p">(</span><span class="n">n3</span><span class="p">,</span><span class="w"> </span><span class="n">channel2</span><span class="p">);</span>
<span class="w">  </span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">ErrorModel</span><span class="o">&gt;</span><span class="w"> </span><span class="n">em</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Create</span><span class="o">&lt;</span><span class="n">ErrorModel</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">  </span><span class="n">nd3</span><span class="o">-&gt;</span><span class="n">SetReceiveErrorModel</span><span class="p">(</span><span class="n">em</span><span class="p">);</span>


<span class="kt">bool</span>
<span class="nf">ErrorModel::DoCorrupt</span><span class="p">(</span><span class="n">Packet</span><span class="o">&amp;</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">NS_LOG_FUNCTION</span><span class="p">;</span>
<span class="w">  </span><span class="n">NS_LOG_UNCOND</span><span class="p">(</span><span class="s">&quot;Corrupt!&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>At this point, we can run the program with our trivial ErrorModel plumbed into
the receive path of the PointToPointNetDevice. It prints out the string
“Corrupt!” for each packet received at node n3. Next, we return to the error
model to add in a subclass that performs more interesting error modeling.</p>
</section>
</section>
<section id="add-a-subclass">
<h4><span class="section-number">4.6.5. </span>Add a Subclass<a class="headerlink" href="#add-a-subclass" title="Link to this heading">¶</a></h4>
<p>The trivial base class ErrorModel does not do anything interesting, but it
provides a useful base class interface (<code class="docutils literal notranslate"><span class="pre">Corrupt()</span></code> and <code class="docutils literal notranslate"><span class="pre">Reset()</span></code>), forwarded to
virtual functions that can be subclassed. Let’s next consider what we call a
BasicErrorModel which is based on the <em>ns-2</em> ErrorModel class (in
<code class="docutils literal notranslate"><span class="pre">ns-2/queue/errmodel.{cc,h}</span></code>).</p>
<p>What properties do we want this to have, from a user interface perspective? We
would like for the user to be able to trivially swap out the type of ErrorModel
used in the NetDevice. We would also like the capability to set configurable
parameters.</p>
<p>Here are a few simple requirements we will consider:</p>
<ul class="simple">
<li><p>Ability to set the random variable that governs the losses (default is
UniformVariable)</p></li>
<li><p>Ability to set the unit (bit, byte, packet, time) of granularity over which
errors are applied.</p></li>
<li><p>Ability to set the rate of errors (e.g. 10^-3) corresponding to the above unit
of granularity.</p></li>
<li><p>Ability to enable/disable (default is enabled)</p></li>
</ul>
<section id="how-to-subclass">
<h5><span class="section-number">4.6.5.1. </span>How to Subclass<a class="headerlink" href="#how-to-subclass" title="Link to this heading">¶</a></h5>
<p>We declare BasicErrorModel to be a subclass of ErrorModel as follows,:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BasicErrorModel</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ErrorModel</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">GetTypeId</span><span class="p">();</span>
<span class="w">  </span><span class="p">...</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="c1">// Implement base class pure virtual functions</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">DoCorrupt</span><span class="p">(</span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Packet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">DoReset</span><span class="p">();</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and configure the subclass GetTypeId function by setting a unique TypeId string
and setting the Parent to ErrorModel:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">TypeId</span><span class="w"> </span><span class="nf">RateErrorModel::GetTypeId</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TypeId</span><span class="p">(</span><span class="s">&quot;ns3::RateErrorModel&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">SetParent</span><span class="o">&lt;</span><span class="n">ErrorModel</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">SetGroupName</span><span class="p">(</span><span class="s">&quot;Network&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">AddConstructor</span><span class="o">&lt;</span><span class="n">RateErrorModel</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">  </span><span class="p">...</span>
</pre></div>
</div>
</section>
</section>
<section id="build-core-functions-and-unit-tests">
<h4><span class="section-number">4.6.6. </span>Build Core Functions and Unit Tests<a class="headerlink" href="#build-core-functions-and-unit-tests" title="Link to this heading">¶</a></h4>
<section id="assert-macros">
<h5><span class="section-number">4.6.6.1. </span>Assert Macros<a class="headerlink" href="#assert-macros" title="Link to this heading">¶</a></h5>
</section>
<section id="writing-unit-tests">
<h5><span class="section-number">4.6.6.2. </span>Writing Unit Tests<a class="headerlink" href="#writing-unit-tests" title="Link to this heading">¶</a></h5>
</section>
</section>
</section>
<span id="document-new-modules"></span><section id="adding-a-new-module-to-ns3">
<span id="id1"></span><h3><span class="section-number">4.7. </span>Adding a New Module to <em>ns-3</em><a class="headerlink" href="#adding-a-new-module-to-ns3" title="Link to this heading">¶</a></h3>
<p>When you have created a group of related classes, examples, and tests,
they can be combined together into an <em>ns-3</em> module so that they can be
used with existing <em>ns-3</em> modules and by other researchers.</p>
<p>This chapter walks you through the steps necessary to add a new module
to <em>ns-3</em>.</p>
<section id="step-0-module-layout">
<span id="step-0"></span><h4><span class="section-number">4.7.1. </span>Step 0 - Module Layout<a class="headerlink" href="#step-0-module-layout" title="Link to this heading">¶</a></h4>
<p>All modules can be found in the <code class="docutils literal notranslate"><span class="pre">src</span></code> directory.  Each module can be
found in a directory that has the same name as the module.  For
example, the <code class="docutils literal notranslate"><span class="pre">spectrum</span></code> module can be found here: <code class="docutils literal notranslate"><span class="pre">src/spectrum</span></code>.
We’ll be quoting from the <code class="docutils literal notranslate"><span class="pre">spectrum</span></code> module for illustration.</p>
<p>A prototypical module has the following directory structure and
required files:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>src/
  module-name/
    bindings/
    doc/
    examples/
      CMakeLists.txt
    helper/
    model/
    test/
      examples-to-run.py
    CMakeLists.txt
</pre></div>
</div>
<p>Not all directories will be present in each module.</p>
</section>
<section id="step-1-create-a-module-skeleton">
<h4><span class="section-number">4.7.2. </span>Step 1 - Create a Module Skeleton<a class="headerlink" href="#step-1-create-a-module-skeleton" title="Link to this heading">¶</a></h4>
<p>A python program is provided in the <code class="docutils literal notranslate"><span class="pre">utils</span></code> directory that
will create a skeleton for a new module.  For the purposes
of this discussion we will assume that your new module
is called <code class="docutils literal notranslate"><span class="pre">new-module</span></code>.  From the top directory, do the following
to create the new module:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./utils/create-module.py<span class="w"> </span>new-module
</pre></div>
</div>
<p>By default <code class="docutils literal notranslate"><span class="pre">create-module.py</span></code> creates the module skeleton in the
<code class="docutils literal notranslate"><span class="pre">src</span></code> directory.  However, it can also create modules in <code class="docutils literal notranslate"><span class="pre">contrib</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./utils/create-module.py<span class="w"> </span>contrib/new-contrib
</pre></div>
</div>
<p>Let’s assume we’ve created our new module in <code class="docutils literal notranslate"><span class="pre">src</span></code>.
<code class="docutils literal notranslate"><span class="pre">cd</span></code> into <code class="docutils literal notranslate"><span class="pre">src/new-module</span></code>; you will find this directory layout:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ cd new-module
$ ls
doc examples  helper  model  test  CMakeLists.txt
</pre></div>
</div>
<p>In more detail, the <code class="docutils literal notranslate"><span class="pre">create-module.py</span></code> script will create the
directories as well as initial skeleton <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>, <code class="docutils literal notranslate"><span class="pre">.h</span></code>, <code class="docutils literal notranslate"><span class="pre">.cc</span></code>
and <code class="docutils literal notranslate"><span class="pre">.rst</span></code> files.  The complete module with skeleton files looks like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>src/
  new-module/
    doc/
  new-module.rst
examples/
  new-module-example.cc
  CMakeLists.txt
helper/
  new-module-helper.cc
  new-module-helper.h
model/
  new-module.cc
  new-module.h
test/
  new-module-test-suite.cc
CMakeLists.txt
</pre></div>
</div>
<p>(If required the <code class="docutils literal notranslate"><span class="pre">bindings/</span></code> directory listed in
<a class="reference internal" href="#step-0"><span class="std std-ref">Step-0</span></a> will be created automatically during
the build.)</p>
<p>We next walk through how to customize this module.  Informing <code class="docutils literal notranslate"><span class="pre">ns3</span></code>
about the files which make up your module is done by editing the two
<code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> files.  We will walk through the main steps in this chapter.</p>
<p>All <em>ns-3</em> modules depend on the <code class="docutils literal notranslate"><span class="pre">core</span></code> module and usually on
other modules.  This dependency is specified in the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file
(at the top level of the module, not the separate <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file
in the <code class="docutils literal notranslate"><span class="pre">examples</span></code> directory!).  In the skeleton <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>
the call that will declare your new module to <code class="docutils literal notranslate"><span class="pre">ns3</span></code> will look
like this (before editing):</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">new-module</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">helper/new-module-helper.cc</span>
<span class="w">               </span><span class="s">model/new-module.cc</span>
<span class="w">  </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="s">helper/new-module-helper.h</span>
<span class="w">               </span><span class="s">model/new-module.h</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libcore</span><span class="o">}</span>
<span class="w">  </span><span class="s">TEST_SOURCES</span><span class="w"> </span><span class="s">test/new-module-test-suite.cc</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Let’s assume that <code class="docutils literal notranslate"><span class="pre">new-module</span></code> depends on the <code class="docutils literal notranslate"><span class="pre">internet</span></code>,
<code class="docutils literal notranslate"><span class="pre">mobility</span></code>, and <code class="docutils literal notranslate"><span class="pre">aodv</span></code> modules.  After editing it the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file
should look like:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">new-module</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">helper/new-module-helper.cc</span>
<span class="w">               </span><span class="s">model/new-module.cc</span>
<span class="w">  </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="s">helper/new-module-helper.h</span>
<span class="w">               </span><span class="s">model/new-module.h</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libmobility</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libaodv</span><span class="o">}</span>
<span class="w">  </span><span class="s">TEST_SOURCES</span><span class="w"> </span><span class="s">test/new-module-test-suite.cc</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Note that only first level module dependencies should be listed, which
is why we removed <code class="docutils literal notranslate"><span class="pre">core</span></code>; the <code class="docutils literal notranslate"><span class="pre">internet</span></code> module in turn depends on
<code class="docutils literal notranslate"><span class="pre">core</span></code>.</p>
<p>Your module will most likely have model source files.  Initial skeletons
(which will compile successfully) are created in <code class="docutils literal notranslate"><span class="pre">model/new-module.cc</span></code>
and <code class="docutils literal notranslate"><span class="pre">model/new-module.h</span></code>.</p>
<p>If your module will have helper source files, then they will go into
the <code class="docutils literal notranslate"><span class="pre">helper/</span></code> directory; again, initial skeletons are created
in that directory.</p>
<p>Finally, it is good practice to write tests and examples.  These will
almost certainly be required for new modules to be accepted into
the official <em>ns-3</em> source tree.  A skeleton
test suite and test case is created in the <code class="docutils literal notranslate"><span class="pre">test/</span></code> directory.
The skeleton test suite will contain the below constructor,
which declares a new unit test named <code class="docutils literal notranslate"><span class="pre">new-module</span></code>,
with a single test case consisting of the class <code class="docutils literal notranslate"><span class="pre">NewModuleTestCase1</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">NewModuleTestSuite</span><span class="o">::</span><span class="n">NewModuleTestSuite</span><span class="p">()</span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">TestSuite</span><span class="p">(</span><span class="s">&quot;new-module&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UNIT</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">AddTestCase</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">NewModuleTestCase1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="step-3-declare-source-files">
<h4><span class="section-number">4.7.3. </span>Step 3 - Declare Source Files<a class="headerlink" href="#step-3-declare-source-files" title="Link to this heading">¶</a></h4>
<p>The public header and source code files for your new module
should be specified in the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file by modifying it with
your text editor.</p>
<p>As an example, after declaring the <code class="docutils literal notranslate"><span class="pre">spectrum</span></code> module,
the <code class="docutils literal notranslate"><span class="pre">src/spectrum/CMakeLists.txt</span></code> specifies the source code files
with the following:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="s">source_files</span>
<span class="w">  </span><span class="s">helper/adhoc-aloha-noack-ideal-phy-helper.cc</span>
<span class="w">  </span><span class="s">helper/spectrum-analyzer-helper.cc</span>
<span class="w">  </span><span class="s">helper/spectrum-helper.cc</span>
<span class="w">  </span><span class="s">...</span>
<span class="p">)</span>

<span class="nb">set</span><span class="p">(</span><span class="s">header_files</span>
<span class="w">  </span><span class="s">helper/adhoc-aloha-noack-ideal-phy-helper.h</span>
<span class="w">  </span><span class="s">helper/spectrum-analyzer-helper.h</span>
<span class="w">  </span><span class="s">helper/spectrum-helper.h</span>
<span class="w">  </span><span class="s">...</span>
<span class="p">)</span>

<span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">spectrum</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="o">${</span><span class="nv">source_files</span><span class="o">}</span>
<span class="w">  </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="o">${</span><span class="nv">header_files</span><span class="o">}</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span><span class="w"> </span><span class="o">${</span><span class="nv">libpropagation</span><span class="o">}</span>
<span class="w">                    </span><span class="o">${</span><span class="nv">libantenna</span><span class="o">}</span>
<span class="w">  </span><span class="s">TEST_SOURCES</span>
<span class="w">    </span><span class="s">test/spectrum-ideal-phy-test.cc</span>
<span class="w">    </span><span class="s">test/spectrum-interference-test.cc</span>
<span class="w">    </span><span class="s">test/spectrum-value-test.cc</span>
<span class="w">    </span><span class="s">test/spectrum-waveform-generator-test.cc</span>
<span class="w">    </span><span class="s">test/three-gpp-channel-test-suite.cc</span>
<span class="w">    </span><span class="s">test/tv-helper-distribution-test.cc</span>
<span class="w">    </span><span class="s">test/tv-spectrum-transmitter-test.cc</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Note: the <code class="docutils literal notranslate"><span class="pre">source_files</span></code> and <code class="docutils literal notranslate"><span class="pre">header_files</span></code> lists are not necessary.
They are used keep the <code class="docutils literal notranslate"><span class="pre">build_lib</span></code> macro readable for modules with many
source files.</p>
<p>The objects resulting from compiling these sources will be assembled
into a link library, which will be linked to any programs relying on this
module.</p>
<p>But how do such programs learn the public API of our new module?  Read on!</p>
</section>
<section id="step-4-declare-public-header-files">
<h4><span class="section-number">4.7.4. </span>Step 4 - Declare Public Header Files<a class="headerlink" href="#step-4-declare-public-header-files" title="Link to this heading">¶</a></h4>
<p>The header files defining the public API of your model and helpers
also should be specified in the <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file.</p>
<p>Continuing with the <code class="docutils literal notranslate"><span class="pre">spectrum</span></code> model illustration,
the public header files are specified with the following stanza.
(Note that the variable <code class="docutils literal notranslate"><span class="pre">header_files</span></code> tells
<code class="docutils literal notranslate"><span class="pre">CMake</span></code> to install this module’s headers with the other <em>ns-3</em> headers):</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="s">header_files</span>
<span class="w">    </span><span class="s">helper/adhoc-aloha-noack-ideal-phy-helper.h</span>
<span class="w">    </span><span class="s">helper/spectrum-analyzer-helper.h</span>
<span class="w">    </span><span class="s">...</span>
<span class="w">    </span><span class="s">model/tv-spectrum-transmitter.h</span>
<span class="w">    </span><span class="s">model/waveform-generator.h</span>
<span class="w">    </span><span class="s">model/wifi-spectrum-value-helper.h</span>
<span class="p">)</span>

<span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">spectrum</span>
<span class="w">  </span><span class="s">...</span>
<span class="w">  </span><span class="s">HEADER_FILES</span><span class="w"> </span><span class="o">${</span><span class="nv">header_files</span><span class="o">}</span>
<span class="w">  </span><span class="s">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If the list of headers is short, use the following instead:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">spectrum</span>
<span class="w">  </span><span class="s">...</span>
<span class="w">  </span><span class="s">HEADER_FILES</span>
<span class="w">    </span><span class="s">helper/adhoc-aloha-noack-ideal-phy-helper.h</span>
<span class="w">    </span><span class="s">helper/spectrum-analyzer-helper.h</span>
<span class="w">    </span><span class="s">...</span>
<span class="w">    </span><span class="s">model/tv-spectrum-transmitter.h</span>
<span class="w">    </span><span class="s">model/waveform-generator.h</span>
<span class="w">    </span><span class="s">model/wifi-spectrum-value-helper.h</span>
<span class="w">  </span><span class="s">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Headers made public in this way will be accessible to users of your model
with include statements like</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ns3/spectrum-model.h&quot;</span>
</pre></div>
</div>
<p>Headers used strictly internally in your implementation should not
be included here.  They are still accessible to your implementation by
include statements like</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;my-module-implementation.h&quot;</span>
</pre></div>
</div>
</section>
<section id="step-5-declare-tests">
<h4><span class="section-number">4.7.5. </span>Step 5 - Declare Tests<a class="headerlink" href="#step-5-declare-tests" title="Link to this heading">¶</a></h4>
<p>If your new module has tests, then they must be specified in your
<code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file by modifying it with your text editor.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">spectrum</span></code> model tests are specified with the following stanza:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="nb">build_lib</span><span class="p">(</span>
<span class="w">  </span><span class="s">LIBNAME</span><span class="w"> </span><span class="s">spectrum</span>
<span class="w">  </span><span class="s">...</span>
<span class="w">  </span><span class="s">TEST_SOURCES</span>
<span class="w">    </span><span class="s">test/spectrum-ideal-phy-test.cc</span>
<span class="w">    </span><span class="s">test/spectrum-interference-test.cc</span>
<span class="w">    </span><span class="s">test/spectrum-value-test.cc</span>
<span class="w">    </span><span class="s">test/spectrum-waveform-generator-test.cc</span>
<span class="w">    </span><span class="s">test/three-gpp-channel-test-suite.cc</span>
<span class="w">    </span><span class="s">test/tv-helper-distribution-test.cc</span>
<span class="w">    </span><span class="s">test/tv-spectrum-transmitter-test.cc</span>
<span class="p">)</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="index.html#document-tests"><span class="doc">Tests</span></a> for more information on how to write test cases.</p>
</section>
<section id="step-6-declare-examples">
<h4><span class="section-number">4.7.6. </span>Step 6 - Declare Examples<a class="headerlink" href="#step-6-declare-examples" title="Link to this heading">¶</a></h4>
<p>If your new module has examples, then they must be specified in your
<code class="docutils literal notranslate"><span class="pre">examples/CMakeLists.txt</span></code> file.  (The skeleton top-level <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> will
recursively include <code class="docutils literal notranslate"><span class="pre">examples/CMakeLists.txt</span></code> only if the examples were
enabled at configure time.)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">spectrum</span></code> model defines it’s first example in
<code class="docutils literal notranslate"><span class="pre">src/spectrum/examples/CMakeLists.txt</span></code> with</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_lib_example</span><span class="p">(</span>
<span class="w">  </span><span class="s">NAME</span><span class="w"> </span><span class="s">adhoc-aloha-ideal-phy</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">adhoc-aloha-ideal-phy.cc</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libspectrum</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libmobility</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libapplications</span><span class="o">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Note that the variable <code class="docutils literal notranslate"><span class="pre">libraries_to_link</span></code> is the list of modules that
the program being created depends on; again, don’t forget to include
<code class="docutils literal notranslate"><span class="pre">new-module</span></code> in the list.  It’s best practice to list only the direct
module dependencies, and let <code class="docutils literal notranslate"><span class="pre">CMake</span></code> deduce the full dependency tree.</p>
<p>Occasionally, for clarity, you may want to split the implementation
for your example among several source files.  In this case, just
include those files as additional explicit sources of the example:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">build_lib_example</span><span class="p">(</span>
<span class="w">  </span><span class="s">NAME</span><span class="w"> </span><span class="s">new-module-example</span>
<span class="w">  </span><span class="s">SOURCE_FILES</span><span class="w"> </span><span class="s">new-module-example.cc</span>
<span class="w">  </span><span class="s">LIBRARIES_TO_LINK</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libspectrum</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libmobility</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libinternet</span><span class="o">}</span>
<span class="w">    </span><span class="o">${</span><span class="nv">libapplications</span><span class="o">}</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="step-7-examples-run-as-tests">
<h4><span class="section-number">4.7.7. </span>Step 7 - Examples Run as Tests<a class="headerlink" href="#step-7-examples-run-as-tests" title="Link to this heading">¶</a></h4>
<p>In addition to running explicit test code, the test framework
can also be instrumented to run full example programs to
try to catch regressions in the examples.  However, not all examples
are suitable for regression tests.  The file <code class="docutils literal notranslate"><span class="pre">test/examples-to-run.py</span></code>
controls the invocation of the examples when the test framework runs.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">spectrum</span></code> model examples run by <code class="docutils literal notranslate"><span class="pre">test.py</span></code> are specified in
<code class="docutils literal notranslate"><span class="pre">src/spectrum/test/examples-to-run.py</span></code> using the following
two lists of C++ and Python examples:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># A list of C++ examples to run in order to ensure that they remain</span>
<span class="c1"># buildable and runnable over time.  Each tuple in the list contains</span>
<span class="c1">#</span>
<span class="c1">#     (example_name, do_run, do_valgrind_run).</span>
<span class="c1">#</span>
<span class="c1"># See test.py for more information.</span>
<span class="n">cpp_examples</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;adhoc-aloha-ideal-phy&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;adhoc-aloha-ideal-phy-with-microwave-oven&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;adhoc-aloha-ideal-phy-matrix-propagation-loss-model&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># A list of Python examples to run in order to ensure that they remain</span>
<span class="c1"># runnable over time.  Each tuple in the list contains</span>
<span class="c1">#</span>
<span class="c1">#     (example_name, do_run).</span>
<span class="c1">#</span>
<span class="c1"># See test.py for more information.</span>
<span class="n">python_examples</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;sample-simulator.py&quot;</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>As indicated in the comment, each entry in the C++ list of examples to run
contains the tuple <code class="docutils literal notranslate"><span class="pre">(example_name,</span> <span class="pre">do_run,</span> <span class="pre">do_valgrind_run)</span></code>, where</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">example_name</span></code> is the executable to be run,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">do_run</span></code> is a condition under which to run the example, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">do_valgrind_run</span></code> is a condition under which to run the example
under valgrind.  (This is needed because NSC causes illegal instruction
crashes with some tests when they are run under valgrind.)</p></li>
</ul>
<p>Note that the two conditions are Python statements that
can depend on <code class="docutils literal notranslate"><span class="pre">ns3</span></code> configuration variables.  For example, using the
NSC_ENABLED variable that was defined up until ns-3.35:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s2">&quot;tcp-nsc-lfn&quot;</span><span class="p">,</span> <span class="s2">&quot;NSC_ENABLED == True&quot;</span><span class="p">,</span> <span class="s2">&quot;NSC_ENABLED == False&quot;</span><span class="p">),</span>
</pre></div>
</div>
<p>Each entry in the Python list of examples to run contains the tuple
<code class="docutils literal notranslate"><span class="pre">(example_name,</span> <span class="pre">do_run)</span></code>, where, as for the C++ examples,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">example_name</span></code> is the Python script to be run, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">do_run</span></code> is a condition under which to run the example.</p></li>
</ul>
<p>Again, the condition is a Python statement that can
depend on <code class="docutils literal notranslate"><span class="pre">ns3</span></code> configuration variables.  For example,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s2">&quot;realtime-udp-echo.py&quot;</span><span class="p">,</span> <span class="s2">&quot;ENABLE_REAL_TIME == False&quot;</span><span class="p">),</span>
</pre></div>
</div>
</section>
<section id="step-8-configure-and-build">
<h4><span class="section-number">4.7.8. </span>Step 8 - Configure and Build<a class="headerlink" href="#step-8-configure-and-build" title="Link to this heading">¶</a></h4>
<p>You can now configure, build and test your module as normal.
You must reconfigure the project as a first step so that <code class="docutils literal notranslate"><span class="pre">ns3</span></code>
caches the new information in your <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> files,
or else your new module will not be included in the build.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>configure<span class="w"> </span>--enable-examples<span class="w"> </span>--enable-tests
$<span class="w"> </span>./ns3<span class="w"> </span>build
$<span class="w"> </span>./test.py
</pre></div>
</div>
<p>Look for your new module’s test suite (and example programs,
if your module has any enabled) in the test output.</p>
</section>
<section id="step-9-python-bindings">
<h4><span class="section-number">4.7.9. </span>Step 9 - Python Bindings<a class="headerlink" href="#step-9-python-bindings" title="Link to this heading">¶</a></h4>
<p>Adding Python bindings to your module is optional.</p>
<p>If you want to include Python bindings (needed only if you want
to write Python ns-3 programs instead of C++ ns-3 programs), you
should scan your module to generate new bindings for the Python
API (covered elsewhere in this manual), and they will be used
if NS3_PYTHON_BINDINGS is set to ON.</p>
</section>
</section>
<span id="document-documentation"></span><section id="creating-documentation">
<h3><span class="section-number">4.8. </span>Creating Documentation<a class="headerlink" href="#creating-documentation" title="Link to this heading">¶</a></h3>
<p><em>ns-3</em> supplies two kinds of documentation:  expository “user-guide”-style
chapters, and source code API documentation.</p>
<p>The “user-guide” chapters are written by hand in <a class="reference external" href="http://sphinx-doc.org/rest.html">reStructuredText</a>
format (<code class="docutils literal notranslate"><span class="pre">.rst</span></code>), which is processed by the Python documentation
system <a class="reference external" href="http://sphinx-doc.org/">Sphinx</a> to generate web pages and pdf files.
The API documentation is generated from the source code itself,
using <a class="reference external" href="http://www.doxygen.org/">Doxygen</a>, to generate cross-linked web pages.
Both of these are important:  the Sphinx chapters explain the <em>why</em>
and overview of using a model; the API documentation explains the
<em>how</em> details.</p>
<p>This chapter gives a quick overview of these
tools, emphasizing preferred usage and customizations for <em>ns-3</em>.</p>
<p>To build all the standard documentation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>docs
</pre></div>
</div>
<p>For more specialized options, read on.</p>
<section id="documenting-with-sphinx">
<h4><span class="section-number">4.8.1. </span>Documenting with Sphinx<a class="headerlink" href="#documenting-with-sphinx" title="Link to this heading">¶</a></h4>
<p>We use <a class="reference external" href="http://sphinx-doc.org/">Sphinx</a> to generate expository chapters describing
the design and usage of each module.  Right now you are reading the
<a class="reference internal" href="index.html#document-documentation"><span class="doc">Documentation</span></a> Chapter.
If you are reading the html version, the
<a class="reference external" href="_sources/documentation.txt">Show Source</a> link in the sidebar
will show you the reStructuredText source for this chapter.</p>
<section id="adding-new-chapters">
<h5><span class="section-number">4.8.1.1. </span>Adding New Chapters<a class="headerlink" href="#adding-new-chapters" title="Link to this heading">¶</a></h5>
<p>Adding a new chapter takes three steps (described in more detail below):</p>
<ol class="arabic simple">
<li><p>Choose <a class="reference internal" href="#where">Where?</a> the documentation file(s) will live.</p></li>
<li><p><a class="reference internal" href="#link">Link</a> from an existing page to the new documentation.</p></li>
<li><p>Add the new file to the <a class="reference internal" href="#makefile">Makefile</a>.</p></li>
</ol>
<section id="where">
<h6><span class="section-number">4.8.1.1.1. </span>Where?<a class="headerlink" href="#where" title="Link to this heading">¶</a></h6>
<p>Documentation for a specific module, <code class="docutils literal notranslate"><span class="pre">foo</span></code>, should normally go in
<code class="docutils literal notranslate"><span class="pre">src/foo/doc/</span></code>.  For example <code class="docutils literal notranslate"><span class="pre">src/foo/doc/foo.rst</span></code> would be the
top-level document for the module.  The <code class="docutils literal notranslate"><span class="pre">utils/create-module.py</span></code> script
will create this file for you.</p>
<p>Some models require several <code class="docutils literal notranslate"><span class="pre">.rst</span></code> files, and figures; these should
all go in the <code class="docutils literal notranslate"><span class="pre">src/foo/doc/</span></code> directory.  The docs are actually built
by a Sphinx Makefile.  For especially involved
documentation, it may be helpful to have a local <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>
in the <code class="docutils literal notranslate"><span class="pre">src/foo/doc/</span></code> directory to
simplify building the documentation for this module
(<a class="reference external" href="http://www.nsnam.org/docs/models/html/antenna.html">Antenna</a> is an example).  Setting this up
is not particularly hard, but is beyond the scope of this chapter.</p>
<p>In some cases, documentation spans multiple models; the
<a class="reference external" href="http://www.nsnam.org/docs/models/html/network.html">Network</a> chapter is an example.  In these cases
adding the <code class="docutils literal notranslate"><span class="pre">.rst</span></code> files directly to <code class="docutils literal notranslate"><span class="pre">doc/models/source/</span></code> might
be appropriate.</p>
</section>
<section id="link">
<h6><span class="section-number">4.8.1.1.2. </span>Link<a class="headerlink" href="#link" title="Link to this heading">¶</a></h6>
<p>Sphinx has to know <em>where</em> your new chapter should appear.  In most
cases, a new model chapter should appear the in <cite>Models</cite> book.
To add your chapter there, edit <code class="docutils literal notranslate"><span class="pre">doc/models/source/index.rst</span></code></p>
<div class="highlight-rest notranslate"><div class="highlight"><pre><span></span><span class="p">..</span> <span class="ow">toctree</span><span class="p">::</span>
   <span class="nc">:maxdepth:</span> 1

  organization
  animation
  antenna
  aodv
  applications
<span class="cp">  ...</span>
</pre></div>
</div>
<p>Add the name of your document (without the <code class="docutils literal notranslate"><span class="pre">.rst</span></code> extension) to
this list.  Please keep the Model chapters in alphabetical order,
to ease visual scanning for specific chapters.</p>
</section>
<section id="makefile">
<h6><span class="section-number">4.8.1.1.3. </span>Makefile<a class="headerlink" href="#makefile" title="Link to this heading">¶</a></h6>
<p>You also have to add your document to the appropriate <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>,
so <code class="docutils literal notranslate"><span class="pre">make</span></code> knows to check it for updates.  The Models book Makefile
is <code class="docutils literal notranslate"><span class="pre">doc/models/Makefile</span></code>, the Manual book Makefile is
<code class="docutils literal notranslate"><span class="pre">doc/manual/Makefile</span></code>.</p>
<div class="highlight-make notranslate"><div class="highlight"><pre><span></span><span class="c"># list all model library .rst files that need to be copied to $SOURCETEMP</span>
<span class="nv">SOURCES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>source/conf.py<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>source/_static<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>source/index.rst<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>source/replace.txt<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>source/organization.rst<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>...
<span class="w">        </span><span class="k">$(</span>SRC<span class="k">)</span>/antenna/doc/source/antenna.rst<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>...
</pre></div>
</div>
<p>You add your <code class="docutils literal notranslate"><span class="pre">.rst</span></code> files to the <code class="docutils literal notranslate"><span class="pre">SOURCES</span></code> variable.  To add figures,
read the comments in the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> to see which variable should contain
your image files.  Again, please keep these in alphabetical order.</p>
</section>
</section>
<section id="building-sphinx-docs">
<h5><span class="section-number">4.8.1.2. </span>Building Sphinx Docs<a class="headerlink" href="#building-sphinx-docs" title="Link to this heading">¶</a></h5>
<p>Building the Sphinx documentation is pretty simple.
To build all the Sphinx documentation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>sphinx
</pre></div>
</div>
<p>To build just the Models documentation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>make<span class="w"> </span>-C<span class="w"> </span>doc/models<span class="w"> </span>html
</pre></div>
</div>
<p>To see the generated documentation point your browser at
<code class="docutils literal notranslate"><span class="pre">doc/models/build/html</span></code>.</p>
<p>As you can see, Sphinx uses Make to guide the process.
The default target builds all enabled output forms, which in
<em>ns-3</em> are the multi-page <code class="docutils literal notranslate"><span class="pre">html</span></code>, single-page <code class="docutils literal notranslate"><span class="pre">singlehtml</span></code>, and pdf
(<code class="docutils literal notranslate"><span class="pre">latex</span></code>).  To build just the multi-page html, you add the <code class="docutils literal notranslate"><span class="pre">html</span></code> target:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>make<span class="w"> </span>-C<span class="w"> </span>doc/models<span class="w"> </span>html
</pre></div>
</div>
<p>This can be helpful to reduce the build time (and the size of the
build chatter) as you are writing your chapter.</p>
<p>Before committing your documentation to the repo, please check
that it builds without errors or warnings.  The build process
generates lots of output (mostly normal chatter from LaTeX),
which can make it difficult to see if there are any Sphinx
warnings or errors.  To find important warnings and errors
build just the <code class="docutils literal notranslate"><span class="pre">html</span></code> version, then search the build log
for <code class="docutils literal notranslate"><span class="pre">warning</span></code> or <code class="docutils literal notranslate"><span class="pre">error</span></code>.</p>
</section>
<section id="ns3-specifics">
<h5><span class="section-number">4.8.1.3. </span><em>ns-3</em> Specifics<a class="headerlink" href="#ns3-specifics" title="Link to this heading">¶</a></h5>
<p>The Sphinx <a class="reference external" href="http://sphinx-doc.org/contents.html">documentation</a> and <a class="reference external" href="http://sphinx-doc.org/tutorial.html">tutorial</a> are pretty good.  We won’t duplicate
the basics here, instead focusing on preferred usage for <em>ns-3</em>.</p>
<ul>
<li><p>Start documents with these two lines:</p>
<div class="highlight-rest notranslate"><div class="highlight"><pre><span></span><span class="p">..</span> <span class="ow">include</span><span class="p">::</span> replace.txt
<span class="p">..</span> <span class="ow">highlight</span><span class="p">::</span> cpp
</pre></div>
</div>
<p>The first line enables some simple replacements.  For example,
typing <code class="docutils literal notranslate"><span class="pre">|ns3|</span></code> renders as <em>ns-3</em>.
The second sets the default source code highlighting language explicitly
for the file, since the parser guess isn’t always accurate.
(It’s also possible to set the language explicitly for a single code block,
see below.)</p>
</li>
<li><p>Sections:</p>
<p>Sphinx is pretty liberal about marking section headings.  By convention,
we prefer this hierarchy:</p>
<div class="highlight-rest notranslate"><div class="highlight"><pre><span></span><span class="cp">.. heading hierarchy:</span>
<span class="cp">   ------------- Chapter</span>
<span class="cp">   ************* Section (#.#)</span>
<span class="cp">   ============= Subsection (#.#.#)</span>
<span class="cp">   ############# Sub-subsection</span>
</pre></div>
</div>
</li>
<li><p>Syntax Highlighting:</p>
<p>To use the default syntax highlighter, simply start a sourcecode block:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Sphinx Source</p></th>
<th class="head"><p>Rendered Output</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="highlight-rest notranslate"><div class="highlight"><pre><span></span>The <span class="s">``Frobnitz``</span> is accessed by<span class="se">::</span>

<span class="s">  Foo::Frobnitz frob;</span>
<span class="s">  frob.Set(...);</span>
</pre></div>
</div>
</td>
<td><p>The <code class="docutils literal notranslate"><span class="pre">Frobnitz</span></code> is accessed by:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Foo</span><span class="o">::</span><span class="n">Frobnitz</span><span class="w"> </span><span class="n">frob</span><span class="p">;</span>
<span class="n">frob</span><span class="p">.</span><span class="n">Set</span><span class="p">(...);</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
<p>To use a specific syntax highlighter, for example, <code class="docutils literal notranslate"><span class="pre">bash</span></code> shell commands:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Sphinx Source</p></th>
<th class="head"><p>Rendered Output</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="highlight-rest notranslate"><div class="highlight"><pre><span></span><span class="p">..</span> <span class="ow">sourcecode</span><span class="p">::</span> bash

   $ ls
</pre></div>
</div>
</td>
<td><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ls
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p>Shorthand Notations:</p>
<p>These shorthands are defined:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Sphinx Source</p></th>
<th class="head"><p>Rendered Output</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="highlight-rest notranslate"><div class="highlight"><pre><span></span>|ns3|
</pre></div>
</div>
</td>
<td><p><em>ns-3</em></p></td>
</tr>
<tr class="row-odd"><td><div class="highlight-rest notranslate"><div class="highlight"><pre><span></span>|ns2|
</pre></div>
</div>
</td>
<td><p><em>ns-2</em></p></td>
</tr>
<tr class="row-even"><td><div class="highlight-rest notranslate"><div class="highlight"><pre><span></span>|check|
</pre></div>
</div>
</td>
<td><p><img class="math" src="_images/math/eb43d5592546eaaff233c50b390d221dc5c75cd9.png" alt="\checkmark"/></p></td>
</tr>
<tr class="row-odd"><td><div class="highlight-rest notranslate"><div class="highlight"><pre><span></span><span class="na">:rfc:</span><span class="nv">`6282`</span>
</pre></div>
</div>
</td>
<td><p><span class="target" id="index-0"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc6282.html"><strong>RFC 6282</strong></a></p></td>
</tr>
</tbody>
</table>
</li>
</ul>
</section>
</section>
<section id="documenting-with-doxygen">
<h4><span class="section-number">4.8.2. </span>Documenting with Doxygen<a class="headerlink" href="#documenting-with-doxygen" title="Link to this heading">¶</a></h4>
<p>We use <a class="reference external" href="http://www.doxygen.org/">Doxygen</a> to generate <a class="reference external" href="https://www.nsnam.org/docs/doxygen">browsable</a> API documentation.  Doxygen
provides a number of useful features:</p>
<ul class="simple">
<li><p>Summary table of all class members.</p></li>
<li><p>Graphs of inheritance and collaboration for all classes.</p></li>
<li><p>Links to the source code implementing each function.</p></li>
<li><p>Links to every place a member is used.</p></li>
<li><p>Links to every object used in implementing a function.</p></li>
<li><p>Grouping of related classes, such as all the classes related to
a specific protocol.</p></li>
</ul>
<p>In addition, we use the <code class="docutils literal notranslate"><span class="pre">TypeId</span></code> system to add to the documentation
for every class</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">Config</span></code> paths by which such objects can be reached.</p></li>
<li><p>Documentation for any <code class="docutils literal notranslate"><span class="pre">Attributes</span></code>, including <code class="docutils literal notranslate"><span class="pre">Attributes</span></code>
defined in parent classes.</p></li>
<li><p>Documentation for any <code class="docutils literal notranslate"><span class="pre">Trace</span></code> sources defined by the class.</p></li>
<li><p>The memory footprint for each class.</p></li>
</ul>
<p>Doxygen operates by scanning the source code, looking for
specially marked comments.  It also creates a cross reference,
indicating <em>where</em> each file, class, method, and variable is used.</p>
<section id="preferred-style">
<h5><span class="section-number">4.8.2.1. </span>Preferred Style<a class="headerlink" href="#preferred-style" title="Link to this heading">¶</a></h5>
<p>The preferred style for Doxygen comments is the JavaDoc style:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> *  Brief description of this class or method.</span>
<span class="cm"> *  Adjacent lines become a single paragraph.</span>
<span class="cm"> *</span>
<span class="cm"> *  Longer description, with lots of details.</span>
<span class="cm"> *</span>
<span class="cm"> *  Blank lines separate paragraphs.</span>
<span class="cm"> *</span>
<span class="cm"> *  Explain what the class or method does, using what algorithm.</span>
<span class="cm"> *  Explain the units of arguments and return values.</span>
<span class="cm"> *</span>
<span class="cm"> *  \note Note any limitations or gotchas.</span>
<span class="cm"> *</span>
<span class="cm"> *  (For functions with arguments or return valued:)</span>
<span class="cm"> *  \param [in] foo Brief noun phrase describing this argument. Note</span>
<span class="cm"> *                  that we indicate if the argument is input,</span>
<span class="cm"> *                  output, or both.</span>
<span class="cm"> *  \param [in,out] bar Note Sentence case, and terminating period.</span>
<span class="cm"> *  \param [in] baz Indicate boolean values with \c true or \c false.</span>
<span class="cm"> *  \return Brief noun phrase describing the value.</span>
<span class="cm"> *</span>
<span class="cm"> *  \internal</span>
<span class="cm"> *</span>
<span class="cm"> *  You can also discuss internal implementation details.</span>
<span class="cm"> *  Understanding this material shouldn&#39;t be necessary to using</span>
<span class="cm"> *  the class or method.</span>
<span class="cm"> */</span>
<span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">ExampleFunction</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">bar</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">baz</span><span class="p">);</span>
</pre></div>
</div>
<p>In this style the Doxygen comment block begins with two `*’ characters:
<code class="docutils literal notranslate"><span class="pre">/**</span></code>, and precedes the item being documented.</p>
<p>For items needing only a brief description, either of these short forms
is appropriate:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/** Destructor implementation. */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">DoDispose</span><span class="p">();</span>

<span class="kt">int</span><span class="w"> </span><span class="n">m_count</span><span class="p">;</span><span class="w">  </span><span class="c1">//!&lt; Count of ...</span>
</pre></div>
</div>
<p>Note the special form of the end of line comment, <code class="docutils literal notranslate"><span class="pre">//!&lt;</span></code>, indicating
that it refers to the <em>preceding</em> item.</p>
<p>Some items to note:</p>
<ul class="simple">
<li><p>Use sentence case, including the initial capital.</p></li>
<li><p>Use punctuation, especially `.’s at the end of sentences or phrases.</p></li>
<li><dl class="simple">
<dt>The <code class="docutils literal notranslate"><span class="pre">\brief</span></code> tag is not needed; the first sentence will be</dt><dd><p>used as the brief description.</p>
</dd>
</dl>
</li>
</ul>
<p>Every class, method, typedef, member variable, function argument
and return value should be documented in all source code files
which form the formal API and implementation for <em>ns-3</em>, such as
<code class="docutils literal notranslate"><span class="pre">src/&lt;module&gt;/model/*</span></code>, <code class="docutils literal notranslate"><span class="pre">src/&lt;module&gt;/helper/*</span></code> and
<code class="docutils literal notranslate"><span class="pre">src/&lt;module&gt;/utils/*</span></code>.  Documentation for items in <code class="docutils literal notranslate"><span class="pre">src/&lt;module&gt;/test/*</span></code>
and <code class="docutils literal notranslate"><span class="pre">src/&lt;module&gt;/examples/*</span></code> is preferred, but not required.</p>
</section>
<section id="useful-features">
<h5><span class="section-number">4.8.2.2. </span>Useful Features<a class="headerlink" href="#useful-features" title="Link to this heading">¶</a></h5>
<ul>
<li><p>Inherited members will automatically inherit docs from the parent,
(but can be replaced by local documentation).</p>
<ol class="arabic">
<li><p>Document the base class.</p></li>
<li><p>In the sub class mark inherited functions with an ordinary comment:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Inherited methods</span>
<span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">FooBar</span><span class="p">();</span>
<span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">BarFoo</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">baz</span><span class="p">);</span>
</pre></div>
</div>
<p>This doesn’t work for static functions; see <code class="docutils literal notranslate"><span class="pre">GetTypeId</span></code>, below, for an
example.</p>
</li>
</ol>
</li>
</ul>
</section>
<section id="building-doxygen-docs">
<h5><span class="section-number">4.8.2.3. </span>Building Doxygen Docs<a class="headerlink" href="#building-doxygen-docs" title="Link to this heading">¶</a></h5>
<p>Building the Doxygen documentation is pretty simple:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>doxygen
</pre></div>
</div>
<p>This builds using the default configuration, which generates
documentation sections for <em>all</em> items, even if they do not have
explicit comment documentation blocks.  This has the effect of
suppressing warnings for undocumented items, but makes sure everything
appears in the generated output, which is usually what you want for
general use.  Note that we generate documentation even for modules
which are disabled, to make it easier to see all the features
available in <em>ns-3</em>.</p>
<p>When writing documentation, it’s often more useful to see which items
are generating warnings, typically about missing documentation.  To
see the full warnings list, use the <code class="docutils literal notranslate"><span class="pre">doc/doxygen.warnings.report.sh</span></code>
script:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>doc/doxygen.warnings.report.sh

doxygen.warnings.report.sh:
Building<span class="w"> </span>and<span class="w"> </span>running<span class="w"> </span>print-introspected-doxygen...done.
Rebuilding<span class="w"> </span>doxygen<span class="w"> </span><span class="o">(</span>v1.8.10<span class="o">)</span><span class="w"> </span>docs<span class="w"> </span>with<span class="w"> </span>full<span class="w"> </span>errors...done.


Report<span class="w"> </span>of<span class="w"> </span>Doxygen<span class="w"> </span>warnings
----------------------------------------

<span class="o">(</span>All<span class="w"> </span>counts<span class="w"> </span>are<span class="w"> </span>lower<span class="w"> </span>bounds.<span class="o">)</span>

Warnings<span class="w"> </span>by<span class="w"> </span>module/directory:

Count<span class="w"> </span>Directory
-----<span class="w"> </span>----------------------------------
<span class="m">3414</span><span class="w"> </span>src/lte/model
<span class="m">1532</span><span class="w"> </span>src/wimax/model
<span class="w"> </span><span class="m">825</span><span class="w"> </span>src/lte/test
....
<span class="w">   </span><span class="m">1</span><span class="w"> </span>src/applications/test
<span class="w"> </span><span class="m">97</span><span class="w"> </span>additional<span class="w"> </span>undocumented<span class="w"> </span>parameters.
----------------------------------------
<span class="w"> </span><span class="m">12460</span><span class="w"> </span>total<span class="w"> </span>warnings
<span class="w">   </span><span class="m">100</span><span class="w"> </span>directories<span class="w"> </span>with<span class="w"> </span>warnings


Warnings<span class="w"> </span>by<span class="w"> </span>file<span class="w"> </span><span class="o">(</span>alphabetical<span class="o">)</span>

Count<span class="w"> </span>File
-----<span class="w"> </span>----------------------------------
<span class="w">  </span><span class="m">15</span><span class="w"> </span>examples/routing/manet-routing-compare.cc
<span class="w">  </span><span class="m">26</span><span class="w"> </span>examples/stats/wifi-example-apps.h
<span class="w">  </span><span class="m">12</span><span class="w"> </span>examples/tutorial/fifth.cc
....
<span class="w">  </span><span class="m">17</span><span class="w"> </span>utils/python-unit-tests.py
----------------------------------------
<span class="w">   </span><span class="m">771</span><span class="w"> </span>files<span class="w"> </span>with<span class="w"> </span>warnings


Warnings<span class="w"> </span>by<span class="w"> </span>file<span class="w"> </span><span class="o">(</span>numerical<span class="o">)</span>

Count<span class="w"> </span>File
-----<span class="w"> </span>----------------------------------
<span class="w"> </span><span class="m">273</span><span class="w"> </span>src/lte/model/lte-rrc-sap.h
<span class="w"> </span><span class="m">272</span><span class="w"> </span>src/core/model/simulator.h
<span class="w"> </span><span class="m">221</span><span class="w"> </span>src/netanim/model/animation-interface.h
....
<span class="w">   </span><span class="m">1</span><span class="w"> </span>src/wimax/model/ul-job.cc
----------------------------------------
<span class="w">   </span><span class="m">771</span><span class="w"> </span>files<span class="w"> </span>with<span class="w"> </span>warnings


Doxygen<span class="w"> </span>Warnings<span class="w"> </span>Summary
----------------------------------------
<span class="w">   </span><span class="m">100</span><span class="w"> </span>directories
<span class="w">   </span><span class="m">771</span><span class="w"> </span>files
<span class="w"> </span><span class="m">12460</span><span class="w"> </span>warnings
</pre></div>
</div>
<p>(This snippet has <em>a lot</em> of lines suppressed!)</p>
<p>The script modifies the configuration to show all warnings, and to
shorten the run time.  (It shortens the run time primarily by
disabling creation of diagrams, such as call trees, and doesn’t
generate documentation for undocumented items, in order to trigger the
warnings.)  As you can see, at this writing we have <em>a lot</em> of
undocumented items.  The report summarizes warnings by module
<code class="docutils literal notranslate"><span class="pre">src/*/*</span></code>, and by file, in alphabetically and numerical order.</p>
<p>The script has a few options to pare things down and make the output more
manageable.  For help, use the <code class="docutils literal notranslate"><span class="pre">-h</span></code> option.  Having run it once
to do the Doxygen build and generate the full warnings log,
you can reprocess the log file with various “filters,”
without having to do the full Doxygen build again by
using the <code class="docutils literal notranslate"><span class="pre">-s</span></code> option.  You can exclude warnings
from <code class="docutils literal notranslate"><span class="pre">*/examples/*</span></code> files (<code class="docutils literal notranslate"><span class="pre">-e</span></code> option), and/or <code class="docutils literal notranslate"><span class="pre">*/test/*</span></code> files
(<code class="docutils literal notranslate"><span class="pre">-t</span></code>).  Just to be clear, all of the filter options do the complete
fast doxygen build; they just filter doxygen log and warnings output.</p>
<p>Perhaps the most useful option when writing documentation comments
is <code class="docutils literal notranslate"><span class="pre">-m</span> <span class="pre">&lt;module&gt;</span></code>, which will limit the report to just files matching
<code class="docutils literal notranslate"><span class="pre">src/&lt;module&gt;/*</span></code>, and follow the report with the actual warning lines.
Combine with <code class="docutils literal notranslate"><span class="pre">-et</span></code> and you can focus on the warnings that are most
urgent in a single module:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>doc/doxygen.warnings.report.sh<span class="w"> </span>-m<span class="w"> </span>mesh/helper
...
Doxygen<span class="w"> </span>Warnings<span class="w"> </span>Summary
----------------------------------------
<span class="w">  </span><span class="m">1</span><span class="w"> </span>directories
<span class="w">  </span><span class="m">3</span><span class="w"> </span>files
<span class="m">149</span><span class="w"> </span>warnings


Filtered<span class="w"> </span><span class="nv">Warnings</span>
<span class="o">========================================</span>
src/mesh/helper/dot11s/dot11s-installer.h:72:<span class="w"> </span>warning:<span class="w"> </span>Member<span class="w"> </span>m_root<span class="w"> </span><span class="o">(</span>variable<span class="o">)</span><span class="w"> </span>of<span class="w"> </span>class<span class="w"> </span>ns3::Dot11sStack<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>documented.
src/mesh/helper/dot11s/dot11s-installer.h:35:<span class="w"> </span>warning:<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span>of<span class="w"> </span>member<span class="w"> </span>ns3::Dot11sStack::GetTypeId<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>documented
src/mesh/helper/dot11s/dot11s-installer.h:56:<span class="w"> </span>warning:<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span>of<span class="w"> </span>member<span class="w"> </span>ns3::Dot11sStack::InstallStack<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>documented
src/mesh/helper/flame/lfame-installer.h:40:<span class="w"> </span>warning:<span class="w"> </span>Member<span class="w"> </span>GetTypeId<span class="o">()</span><span class="w"> </span><span class="o">(</span><span class="k">function</span><span class="o">)</span><span class="w"> </span>of<span class="w"> </span>class<span class="w"> </span>ns3::FlameStack<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>documented.
src/mesh/helper/flame/flame-installer.h:60:<span class="w"> </span>warning:<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">type</span><span class="w"> </span>of<span class="w"> </span>member<span class="w"> </span>ns3::FlameStack::InstallStack<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>documented
src/mesh/helper/mesh-helper.h:213:<span class="w"> </span>warning:<span class="w"> </span>Member<span class="w"> </span>m_nInterfaces<span class="w"> </span><span class="o">(</span>variable<span class="o">)</span><span class="w"> </span>of<span class="w"> </span>class<span class="w"> </span>ns3::MeshHelper<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>documented.
src/mesh/helper/mesh-helper.h:214:<span class="w"> </span>warning:<span class="w"> </span>Member<span class="w"> </span>m_spreadChannelPolicy<span class="w"> </span><span class="o">(</span>variable<span class="o">)</span><span class="w"> </span>of<span class="w"> </span>class<span class="w"> </span>ns3::MeshHelper<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>documented.
src/mesh/helper/mesh-helper.h:215:<span class="w"> </span>warning:<span class="w"> </span>Member<span class="w"> </span>m_stack<span class="w"> </span><span class="o">(</span>variable<span class="o">)</span><span class="w"> </span>of<span class="w"> </span>class<span class="w"> </span>ns3::MeshHelper<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>documented.
src/mesh/helper/mesh-helper.h:216:<span class="w"> </span>warning:<span class="w"> </span>Member<span class="w"> </span>m_stackFactory<span class="w"> </span><span class="o">(</span>variable<span class="o">)</span><span class="w"> </span>of<span class="w"> </span>class<span class="w"> </span>ns3::MeshHelper<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>documented.
src/mesh/helper/mesh-helper.h:209:<span class="w"> </span>warning:<span class="w"> </span>parameters<span class="w"> </span>of<span class="w"> </span>member<span class="w"> </span>ns3::MeshHelper::CreateInterface<span class="w"> </span>are<span class="w"> </span>not<span class="w"> </span><span class="o">(</span>all<span class="o">)</span><span class="w"> </span>documented
src/mesh/helper/mesh-helper.h:119:<span class="w"> </span>warning:<span class="w"> </span>parameters<span class="w"> </span>of<span class="w"> </span>member<span class="w"> </span>ns3::MeshHelper::SetStandard<span class="w"> </span>are<span class="w"> </span>not<span class="w"> </span><span class="o">(</span>all<span class="o">)</span><span class="w"> </span>documented
</pre></div>
</div>
<p>Finally, note that undocumented items (classes, methods, functions,
typedefs, <em>etc.</em> won’t produce documentation when you build with
<code class="docutils literal notranslate"><span class="pre">doxygen.warnings.report.sh</span></code>, and only the outermost item
will produce a warning.  As a result, if you don’t see documentation
for a class method in the generated documentation, the class itself
probably needs documentation.</p>
<p>Now it’s just a matter of understanding the code, and writing some
docs!</p>
</section>
<section id="id1">
<h5><span class="section-number">4.8.2.4. </span><em>ns-3</em> Specifics<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h5>
<p>As for Sphinx, the Doxygen <a class="reference external" href="https://www.doxygen.nl/index.html">docs</a> and <a class="reference external" href="https://www.doxygen.nl/manual/commands.html">reference</a> are pretty good.
We won’t duplicate the basics here, instead focusing on preferred
usage for <em>ns-3</em>.</p>
<ul>
<li><p>Use Doxygen <code class="docutils literal notranslate"><span class="pre">Modules</span></code> to group related items.</p>
<p>In the main header for a module, create a Doxgyen group:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> *  \defgroup foo Foo protocol.</span>
<span class="cm"> *  Implementation of the Foo protocol.</span>
<span class="cm"> */</span>
</pre></div>
</div>
<p>The symbol <code class="docutils literal notranslate"><span class="pre">foo</span></code> is how other items can add themselves to this group.
The string following that will be the title for the group.  Any further
text will be the detailed description for the group page.</p>
</li>
<li><p>Document each file, assigning it to the relevant group.  In a header file:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> *  \file</span>
<span class="cm"> *  \ingroup foo</span>
<span class="cm"> *  Class Foo declaration.</span>
<span class="cm"> */</span>
</pre></div>
</div>
<p>or in the corresponding <code class="docutils literal notranslate"><span class="pre">.cc</span></code> file:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> *  \file</span>
<span class="cm"> *  \ingroup foo</span>
<span class="cm"> *  Class FooBar implementation.</span>
<span class="cm"> */</span>
</pre></div>
</div>
</li>
<li><p>Mark each associated class as belonging to the group:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> *  \ingroup foo</span>
<span class="cm"> *</span>
<span class="cm"> *  FooBar packet type.</span>
<span class="cm">*/</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FooBar</span>
</pre></div>
</div>
</li>
<li><p>Did you know <code class="docutils literal notranslate"><span class="pre">typedefs</span></code> can have formal arguments?  This enables
documentation of function pointer signatures:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> *  Bar callback function signature.</span>
<span class="cm"> *</span>
<span class="cm"> *  \param ale The size of a pint of ale, in Imperial ounces.</span>
<span class="cm"> */</span>
<span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">BarCallback</span><span class="p">)(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ale</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Copy the <code class="docutils literal notranslate"><span class="pre">Attribute</span></code> help strings from the <code class="docutils literal notranslate"><span class="pre">GetTypeId</span></code> method to use
as the brief descriptions of associated members.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\bugid{298}</span></code> will create a link to bug 298 in our Bugzilla.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\p</span> <span class="pre">foo</span></code> in a description will format <code class="docutils literal notranslate"><span class="pre">foo</span></code>
the same as the <code class="docutils literal notranslate"><span class="pre">\param</span> <span class="pre">foo</span></code> parameter, making it clear that you
are referring to an actual argument.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">\RFC{301}</span></code> will create a link to RFC 301.</p></li>
<li><p>Document the direction of function arguments with <code class="docutils literal notranslate"><span class="pre">\param</span> <span class="pre">[in]</span></code>, <em>etc</em>.
The allowed values of the direction token are <code class="docutils literal notranslate"><span class="pre">[in]</span></code>, <code class="docutils literal notranslate"><span class="pre">[out]</span></code>, and
<code class="docutils literal notranslate"><span class="pre">[in,out]</span></code> (note the explicit square brackets), as discussed in the
Doxygen docs for <code class="docutils literal notranslate"><span class="pre">\param</span></code>.</p></li>
<li><p>Document template arguments with <code class="docutils literal notranslate"><span class="pre">\tparam</span></code>, just as you use <code class="docutils literal notranslate"><span class="pre">\param</span></code>
for function arguments.</p></li>
<li><p>For template arguments, indicate if they will be deduced or must be given
explicitly:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * A templated function.</span>
<span class="cm"> * \tparam T \explicit The return type.</span>
<span class="cm"> * \tparam U \deduced The argument type.</span>
<span class="cm"> * \param [in] a The argument.</span>
<span class="cm"> */</span>
<span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">U</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">Function</span><span class="p">(</span><span class="n">U</span><span class="w"> </span><span class="n">a</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">\tparam</span> <span class="pre">U</span> <span class="pre">\deduced</span></code> because the type <code class="docutils literal notranslate"><span class="pre">U</span></code> can be deduced at
the site where the template is invoked.  Basically deduction can only
be done for function arguments.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">\tparam</span> <span class="pre">T</span> <span class="pre">\explicit</span></code> because the type <code class="docutils literal notranslate"><span class="pre">T</span></code> can’t be deduced;
it must be given explicitly at the invocation site, as in
<code class="docutils literal notranslate"><span class="pre">Create&lt;MyObject&gt;(...)</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">\internal</span></code> should be used only to set off a discussion of implementation
details, not to mark <code class="docutils literal notranslate"><span class="pre">private</span></code> functions (they are already marked,
as <code class="docutils literal notranslate"><span class="pre">private</span></code>!)</p></li>
<li><p>Don’t create classes with trivial names, such as <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">A</span></code>,
even in test suites.  These cause all instances of the class name
literal `A’ to be rendered as links.</p></li>
</ul>
<p>As noted above, static functions don’t inherit the documentation
of the same functions in the parent class.  <em>ns-3</em> uses a few static
functions ubiquitously; the suggested documentation block for these
cases is:</p>
<ul>
<li><p>Default constructor/destructor:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">MyClass</span><span class="p">();</span><span class="w">   </span><span class="c1">//!&lt; Default constructor</span>
<span class="o">~</span><span class="n">MyClass</span><span class="p">();</span><span class="w">  </span><span class="c1">//!&lt; Destructor</span>
</pre></div>
</div>
</li>
<li><p>Dummy destructor and DoDispose:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/** Dummy destructor, see DoDispose. */</span>
<span class="o">~</span><span class="n">MyClass</span><span class="p">();</span>

<span class="cm">/** Destructor implementation */</span>
<span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">DoDispose</span><span class="p">();</span>
</pre></div>
</div>
</li>
<li><p>GetTypeId:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> *  Register this type.</span>
<span class="cm"> *  \return The object TypeId.</span>
<span class="cm"> */</span>
<span class="k">static</span><span class="w"> </span><span class="n">TypeId</span><span class="w"> </span><span class="nf">GetTypeId</span><span class="p">();</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
</section>
<span id="document-profiling"></span><section id="profiling">
<h3><span class="section-number">4.9. </span>Profiling<a class="headerlink" href="#profiling" title="Link to this heading">¶</a></h3>
<p>Memory profiling is essential to identify issues that
may cause memory corruption, which may lead to all sorts of
side-effects, such as crashing after many hours of simulation and
producing wrong results that invalidate the entire simulation.</p>
<p>It also can help tracking sources of excessive memory allocations,
the size of these allocations and memory usage during simulation.
These can affect simulation performance, or limit the complexity
and the number of concurrent simulations.</p>
<p>Performance profiling on the other hand is essential for
high-performance applications, as it allows for the identification
of bottlenecks and their mitigation.</p>
<p>Another type of profiling is related to system calls. They
can be used to debug issues and identify hotspots that
may cause performance issues in specific conditions. Excessive
calls results in more context switches, which interrupt the
simulations, ultimately slowing them down.</p>
<p>Other than profiling the simulations, which can highlight bottlenecks
in the simulator, we can also profile the compilation process.
This allows us to identify and fix bottlenecks, which speed up
build times.</p>
<section id="memory-profilers">
<h4><span class="section-number">4.9.1. </span>Memory Profilers<a class="headerlink" href="#memory-profilers" title="Link to this heading">¶</a></h4>
<p>Memory profilers are tools that help identifying memory related
issues.</p>
<p>There are two well known tools for finding bugs such as uninitialized memory usage,
out-of-bound accesses, dereferencing null pointers and other memory-related bugs:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://valgrind.org/">Valgrind</a></p>
<ul>
<li><p>Pros: very rich tooling, no need to recompile programs to profile the program.</p></li>
<li><p>Cons: very slow and limited to Linux and MacOS.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://github.com/google/sanitizers/wiki">Sanitizers</a></p>
<ul>
<li><p>Pros: sanitizers are distributed along with compilers, such as GCC, Clang and MSVC.
They are widely available, cross platform and faster than Valgrind.</p></li>
<li><p>Cons: false positives, high memory usage, memory sanitizer is incompatible
with other sanitizers (e.g. address sanitizer), requiring two instrumented
compilations and two test runs. The memory sanitizer requires Clang.</p></li>
</ul>
</li>
</ul>
<p>There are also tools to count memory allocations, track memory usage and memory leaks,
such as: <a class="reference external" href="https://apps.kde.org/heaptrack/">Heaptrack</a>, <a class="reference external" href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/ManagingMemory/Articles/FindingLeaks.html">MacOS’s leaks</a>, <a class="reference external" href="https://github.com/koute/bytehound">Bytehound</a> and <a class="reference external" href="https://github.com/gperftools/gperftools">gperftools</a>.</p>
<p>An overview on how to use <a class="reference external" href="https://valgrind.org/">Valgrind</a>, <a class="reference external" href="https://github.com/google/sanitizers/wiki">Sanitizers</a> and
<a class="reference external" href="https://apps.kde.org/heaptrack/">Heaptrack</a> is provided in the following sections.</p>
<section id="id1">
<h5><span class="section-number">4.9.1.1. </span>Valgrind<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h5>
<p><a class="reference external" href="https://valgrind.org/">Valgrind</a> is suite of profiling tools, being the main tool called Memcheck.
To check for memory errors including leaks, one can call valgrind directly:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">valgrind --leak-check=yes ./relative/path/to/program argument1 argument2</span>
</pre></div>
</div>
<p>Or can use the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> script:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./ns3 run &quot;program argument1 argument2&quot; --valgrind</span>
</pre></div>
</div>
<p>Additional Valgrind options are listed on its <a class="reference external" href="https://valgrind.org/docs/manual/mc-manual.html">manual</a>.</p>
</section>
<section id="id2">
<h5><span class="section-number">4.9.1.2. </span>Sanitizers<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h5>
<p><a class="reference external" href="https://github.com/google/sanitizers/wiki">Sanitizers</a> are a suite of libraries made by Google and part of the LLVM project,
used to profile programs at runtime and find issues related to undefined behavior,
memory corruption (out-of-bound access, uninitialized memory use), leaks, race
conditions and others.</p>
<p>Sanitizers are shipped with most modern compilers and can be used by instructing the
compiler to link the required libraries and instrument the code.</p>
<p>To build ns-3 with sanitizers, enable the <code class="docutils literal notranslate"><span class="pre">NS3_SANITIZE</span></code> option. This can be done
directly via CMake:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake_cache/$ cmake -DNS3_SANITIZE=ON ..</span>
</pre></div>
</div>
<p>Or via the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> wrapper:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 configure --enable-sanitizers</span>
</pre></div>
</div>
<p>The memory sanitizer can be enabled with <code class="docutils literal notranslate"><span class="pre">NS3_SANITIZE_MEMORY</span></code>, but it is not
compatible with <code class="docutils literal notranslate"><span class="pre">NS3_SANITIZE</span></code> and only works with the Clang compiler.</p>
<p>Sanitizers were used to find issues in multiple occasions:</p>
<ul>
<li><p>A global buffer overflow in the LTE module</p>
<ul class="simple">
<li><p>When the wrong index (-1) was used to access a <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">[][]</span></code> variable, a different variable that is stored closely in memory was accessed.</p></li>
<li><p>In the best case scenario, this results in reading an incorrect value that causes the program to fail</p></li>
<li><p>In the worst case scenario, this value is overwritten corrupting the program memory</p></li>
<li><p>The likely scenario: wrong value is read and the program continued running, potentially producing incorrect results</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/src/lte/model/lte-amc.cc:303:43: runtime error: index -1 out of bounds for type &#39;int [110][27]&#39;</span>
<span class="go">=================================================================</span>
<span class="go">==51636==ERROR: AddressSanitizer: global-buffer-overflow on address 0x7fe78cc2dbbc at pc 0x7fe78ba65e65 bp 0x7ffde70b25c0 sp 0x7ffde70b25b0</span>
<span class="go">READ of size 4 at 0x7fe78cc2dbbc thread T0</span>
<span class="gp">    #</span><span class="m">0</span><span class="w"> </span>0x7fe78ba65e64<span class="w"> </span><span class="k">in</span><span class="w"> </span>ns3::LteAmc::GetDlTbSizeFromMcs<span class="o">(</span>int,<span class="w"> </span>int<span class="o">)</span><span class="w"> </span>~/ns-3-dev/src/lte/model/lte-amc.cc:303
<span class="gp">    #</span><span class="m">1</span><span class="w"> </span>0x7fe78c538aba<span class="w"> </span><span class="k">in</span><span class="w"> </span>ns3::TdTbfqFfMacScheduler::DoSchedDlTriggerReq<span class="o">(</span>ns3::FfMacSchedSapProvider::SchedDlTriggerReqParameters<span class="w"> </span>const<span class="p">&amp;</span><span class="o">)</span><span class="w"> </span>~/ns-3-dev/src/lte/model/tdtbfq-ff-mac-scheduler.cc:1160
<span class="gp">    #</span><span class="m">2</span><span class="w"> </span>0x7fe78c564736<span class="w"> </span><span class="k">in</span><span class="w"> </span>ns3::MemberSchedSapProvider&lt;ns3::TdTbfqFfMacScheduler&gt;::SchedDlTriggerReq<span class="o">(</span>ns3::FfMacSchedSapProvider::SchedDlTriggerReqParameters<span class="w"> </span>const<span class="p">&amp;</span><span class="o">)</span><span class="w"> </span>~/ns-3-dev/build/include/ns3/ff-mac-sched-sap.h:409
<span class="gp">    #</span><span class="m">3</span><span class="w"> </span>0x7fe78c215596<span class="w"> </span><span class="k">in</span><span class="w"> </span>ns3::LteEnbMac::DoSubframeIndication<span class="o">(</span>unsigned<span class="w"> </span>int,<span class="w"> </span>unsigned<span class="w"> </span>int<span class="o">)</span><span class="w"> </span>~/ns-3-dev/src/lte/model/lte-enb-mac.cc:588
<span class="gp">    #</span><span class="m">4</span><span class="w"> </span>0x7fe78c20921d<span class="w"> </span><span class="k">in</span><span class="w"> </span>ns3::EnbMacMemberLteEnbPhySapUser::SubframeIndication<span class="o">(</span>unsigned<span class="w"> </span>int,<span class="w"> </span>unsigned<span class="w"> </span>int<span class="o">)</span><span class="w"> </span>~/ns-3-dev/src/lte/model/lte-enb-mac.cc:297
<span class="gp">    #</span><span class="m">5</span><span class="w"> </span>0x7fe78b924105<span class="w"> </span><span class="k">in</span><span class="w"> </span>ns3::LteEnbPhy::StartSubFrame<span class="o">()</span><span class="w"> </span>~/ns-3-dev/src/lte/model/lte-enb-phy.cc:764
<span class="gp">    #</span><span class="m">6</span><span class="w"> </span>0x7fe78b949d54<span class="w"> </span><span class="k">in</span><span class="w"> </span>ns3::MakeEvent&lt;void<span class="w"> </span><span class="o">(</span>ns3::LteEnbPhy::*<span class="o">)()</span>,<span class="w"> </span>ns3::LteEnbPhy*&gt;<span class="o">(</span>void<span class="w"> </span><span class="o">(</span>ns3::LteEnbPhy::*<span class="o">)()</span>,<span class="w"> </span>ns3::LteEnbPhy*<span class="o">)</span>::EventMemberImpl0::Notify<span class="o">()</span><span class="w"> </span><span class="o">(</span>~/ns-3-dev/build/lib/libns3-dev-lte-deb.so+0x3a9cd54<span class="o">)</span>
<span class="gp">    #</span><span class="m">7</span><span class="w"> </span>0x7fe795252022<span class="w"> </span><span class="k">in</span><span class="w"> </span>ns3::EventImpl::Invoke<span class="o">()</span><span class="w"> </span>~/ns-3-dev/src/core/model/event-impl.cc:51
<span class="gp">    #</span><span class="m">8</span><span class="w"> </span>0x7fe795260de2<span class="w"> </span><span class="k">in</span><span class="w"> </span>ns3::DefaultSimulatorImpl::ProcessOneEvent<span class="o">()</span><span class="w"> </span>~/ns-3-dev/src/core/model/default-simulator-impl.cc:151
<span class="gp">    #</span><span class="m">9</span><span class="w"> </span>0x7fe795262dbd<span class="w"> </span><span class="k">in</span><span class="w"> </span>ns3::DefaultSimulatorImpl::Run<span class="o">()</span><span class="w"> </span>~/ns-3-dev/src/core/model/default-simulator-impl.cc:204
<span class="gp">    #</span><span class="m">10</span><span class="w"> </span>0x7fe79525436f<span class="w"> </span><span class="k">in</span><span class="w"> </span>ns3::Simulator::Run<span class="o">()</span><span class="w"> </span>~/ns-3-dev/src/core/model/simulator.cc:176
<span class="gp">    #</span><span class="m">11</span><span class="w"> </span>0x7fe7b0f77ee2<span class="w"> </span><span class="k">in</span><span class="w"> </span>LteDistributedFfrAreaTestCase::DoRun<span class="o">()</span><span class="w"> </span>~/ns-3-dev/src/lte/test/lte-test-frequency-reuse.cc:1777
<span class="gp">    #</span><span class="m">12</span><span class="w"> </span>0x7fe7952d125a<span class="w"> </span><span class="k">in</span><span class="w"> </span>ns3::TestCase::Run<span class="o">(</span>ns3::TestRunnerImpl*<span class="o">)</span><span class="w"> </span>~/ns-3-dev/src/core/model/test.cc:363
<span class="gp">    #</span><span class="m">13</span><span class="w"> </span>0x7fe7952d0f4d<span class="w"> </span><span class="k">in</span><span class="w"> </span>ns3::TestCase::Run<span class="o">(</span>ns3::TestRunnerImpl*<span class="o">)</span><span class="w"> </span>~/ns-3-dev/src/core/model/test.cc:357
<span class="gp">    #</span><span class="m">14</span><span class="w"> </span>0x7fe7952e39c0<span class="w"> </span><span class="k">in</span><span class="w"> </span>ns3::TestRunnerImpl::Run<span class="o">(</span>int,<span class="w"> </span>char**<span class="o">)</span><span class="w"> </span>~/ns-3-dev/src/core/model/test.cc:1094
<span class="gp">    #</span><span class="m">15</span><span class="w"> </span>0x7fe7952e427e<span class="w"> </span><span class="k">in</span><span class="w"> </span>ns3::TestRunner::Run<span class="o">(</span>int,<span class="w"> </span>char**<span class="o">)</span><span class="w"> </span>~/ns-3-dev/src/core/model/test.cc:1118
<span class="gp">    #</span><span class="m">16</span><span class="w"> </span>0x564a13d67c9c<span class="w"> </span><span class="k">in</span><span class="w"> </span>main<span class="w"> </span>~/ns-3-dev/utils/test-runner.cc:23
<span class="gp">    #</span><span class="m">17</span><span class="w"> </span>0x7fe793cde0b2<span class="w"> </span><span class="k">in</span><span class="w"> </span>__libc_start_main<span class="w"> </span><span class="o">(</span>/lib/x86_64-linux-gnu/libc.so.6+0x270b2<span class="o">)</span>
<span class="gp">    #</span><span class="m">18</span><span class="w"> </span>0x564a13d67bbd<span class="w"> </span><span class="k">in</span><span class="w"> </span>_start<span class="w"> </span><span class="o">(</span>~/ns-3-dev/build/utils/test-runner+0xae0bbd<span class="o">)</span>
<span class="go">0x7fe78cc2dbbc is located 40 bytes to the right of global variable &#39;McsToItbsUl&#39; defined in &#39;~/ns-3-dev/src/lte/model/lte-amc.cc:105:18&#39; (0x7fe78cc2db20) of size 116</span>
<span class="go">0x7fe78cc2dbbc is located 4 bytes to the left of global variable &#39;TransportBlockSizeTable&#39; defined in &#39;~/ns-3-dev/src/lte/model/lte-amc.cc:118:18&#39; (0x7fe78cc2dbc0) of size 11880</span>
<span class="go">SUMMARY: AddressSanitizer: global-buffer-overflow ~/ns-3-dev/src/lte/model/lte-amc.cc:303 in ns3::LteAmc::GetDlTbSizeFromMcs(int, int)</span>
<span class="go">Shadow bytes around the buggy address:</span>
<span class="go">  0x0ffd7197db50: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 f9</span>
<span class="go">  0x0ffd7197db60: f9 f9 f9 f9 00 00 00 00 00 00 00 00 00 00 00 00</span>
<span class="go">=&gt;0x0ffd7197db70: 00 00 04 f9 f9 f9 f9[f9]00 00 00 00 00 00 00 00</span>
<span class="go">Shadow byte legend (one shadow byte represents 8 application bytes):</span>
<span class="go">  Addressable:           00</span>
<span class="go">  Partially addressable: 01 02 03 04 05 06 07</span>
<span class="go">  Global redzone:        f9</span>
<span class="go">==51636==ABORTING</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The output above shows the type of error (<code class="docutils literal notranslate"><span class="pre">global-buffer-overflow</span></code>),
the stack-trace of where the bug happened (<code class="docutils literal notranslate"><span class="pre">LteAmc::GetDlTbSizeFromMcs</span></code>),
affected variables (<code class="docutils literal notranslate"><span class="pre">McsToItbsUl</span></code> and <code class="docutils literal notranslate"><span class="pre">TransportBlockSizeTable</span></code>),
and a shadow bytes map, showing the wrong access between square brackets.</p></li>
<li><p>The the global redzone (f9) shadow bytes are empty memory allocated between global variables (00s and 04s),
which are left there to be corrupted by the bugged program.
Any eventual corruption is then traced back to the source, without affecting the program execution.</p></li>
<li><p>The adopted solution in merge request <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/703">MR703</a> was to fix one of the schedulers that could produce the index value of -1,
and updating the asserts to catch the illegal index value.</p></li>
</ul>
</li>
<li><p>A wrong downcast in the Wimax module:</p>
<ul class="simple">
<li><p>The pointer was casted incorrectly to U16TlvValue instead of U8TvlValue, which could have different sizes in memory
leading to the program reading the wrong memory address.
Reading the wrong memory address can result in unexpected or invalid values being read, which could change the
program flow and corrupt memory, producing wrong simulation results or crashing the program.</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/src/wimax/model/service-flow.cc:159:86: runtime error: downcast of address 0x6020000148b0 which does not point to an object of type &#39;U16TlvValue&#39;</span>
<span class="go">0x6020000148b0: note: object is of type &#39;ns3::U8TlvValue&#39;</span>
<span class="go">48 00 00 36  c8 09 02 62 5c 7f 00 00  00 be be be be be be be  03 00 00 00 00 00 00 04  10 00 00 00</span>
<span class="go">              ^~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="go">              vptr for &#39;ns3::U8TlvValue&#39;</span>
<span class="go">~/ns-3-dev/src/wimax/model/service-flow.cc:159:99: runtime error: member call on address 0x6020000148b0 which does not point to an object of type &#39;U16TlvValue&#39;</span>
<span class="go">0x6020000148b0: note: object is of type &#39;ns3::U8TlvValue&#39;</span>
<span class="go">48 00 00 36  c8 09 02 62 5c 7f 00 00  00 be be be be be be be  03 00 00 00 00 00 00 04  10 00 00 00</span>
<span class="go">              ^~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="go">              vptr for &#39;ns3::U8TlvValue&#39;</span>
<span class="go">~/ns-3-dev/src/wimax/model/wimax-tlv.cc:589:10: runtime error: member access within address 0x6020000148b0 which does not point to an object of type &#39;U16TlvValue&#39;</span>
<span class="go">0x6020000148b0: note: object is of type &#39;ns3::U8TlvValue&#39;</span>
<span class="go">48 00 00 36  c8 09 02 62 5c 7f 00 00  00 be be be be be be be  03 00 00 00 00 00 00 04  10 00 00 00</span>
<span class="go">              ^~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="go">              vptr for &#39;ns3::U8TlvValue&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The bug was fixed with the correct cast in merge request <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/704">MR704</a>.</p></li>
</ul>
</li>
</ul>
</section>
<section id="id3">
<h5><span class="section-number">4.9.1.3. </span>Heaptrack<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h5>
<p><a class="reference external" href="https://apps.kde.org/heaptrack/">Heaptrack</a> is an utility made by <a class="reference external" href="https://kde.org">KDE</a> to trace memory allocations
along with stack traces, allowing developers to identify code responsible
for possible memory leaks and unnecessary allocations.</p>
<p>For the examples below we used the default configuration of ns-3,
with the output going to the <code class="docutils literal notranslate"><span class="pre">build</span></code> directory. The actual executable
for the <code class="docutils literal notranslate"><span class="pre">wifi-he-network</span></code> example is <code class="docutils literal notranslate"><span class="pre">./build/examples/wireless/ns3-dev-wifi-he-network</span></code>, which is what is
executed by <code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">run</span> <span class="pre">wifi-he-network</span></code>.</p>
<p>To collect information of a program (in this case the <code class="docutils literal notranslate"><span class="pre">wifi-he-network</span></code>
example), run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~ns-3-dev/$ heaptrack ./build/examples/wireless/ns3-dev-wifi-he-network --simulationTime=0.3 --frequency=5 --useRts=1 --minExpectedThroughput=6 --maxExpectedThroughput=745</span>
</pre></div>
</div>
<p>If you prefer to use the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> wrapper, try:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~ns-3-dev/$ ./ns3 run &quot;wifi-he-network --simulationTime=0.3 --frequency=5 --useRts=1 --minExpectedThroughput=6 --maxExpectedThroughput=745&quot; --heaptrack --no-build</span>
</pre></div>
</div>
<p>In both cases, heaptrack will print to the terminal the output file:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~ns-3-dev/$ ./ns3 run &quot;wifi-he-network --simulationTime=0.3 --frequency=5 --useRts=1 --minExpectedThroughput=6 --maxExpectedThroughput=745&quot; --heaptrack --no-build</span>
<span class="go">heaptrack output will be written to &quot;~ns-3-dev/heaptrack.ns3-dev-wifi-he-network.210305.zst&quot;</span>
<span class="go">starting application, this might take some time...</span>
<span class="go">MCS value               Channel width           GI                      Throughput</span>
<span class="go">0                       20 MHz                  3200 ns                 5.91733 Mbit/s</span>
<span class="go">0                       20 MHz                  1600 ns                 5.91733 Mbit/s</span>
<span class="go">...</span>
<span class="go">11                      160 MHz                 1600 ns                 479.061 Mbit/s</span>
<span class="go">11                      160 MHz                 800 ns                  524.459 Mbit/s</span>
<span class="go">heaptrack stats:</span>
<span class="go">        allocations:            149185947</span>
<span class="go">        leaked allocations:     10467</span>
<span class="go">        temporary allocations:  21145932</span>
<span class="go">Heaptrack finished! Now run the following to investigate the data:</span>

<span class="go">    heaptrack --analyze &quot;~/ns-3-dev/heaptrack.ns3-dev-wifi-he-network.210305.zst&quot;</span>
</pre></div>
</div>
<p>The output above shows a summary of the stats collected: ~149 million allocations,
~21 million temporary allocations and ~10 thousand possible leaked allocations.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">heaptrack-gui</span></code> is installed, running <code class="docutils literal notranslate"><span class="pre">heaptrack</span></code> will launch it. If it is not installed,
the command line interface will be used.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ heaptrack --analyze &quot;~/ns-3-dev/heaptrack.ns3-dev-wifi-he-network.210305.zst&quot;</span>
<span class="go">reading file &quot;~/ns-3-dev/heaptrack.ns3-dev-wifi-he-network.210305.zst&quot; - please wait, this might take some time...</span>
<span class="go">Debuggee command was: ~/ns-3-dev/build/examples/wireless/ns3-dev-wifi-he-network --simulationTime=0.3 --frequency=5 --useRts=1 --minExpectedThroughput=6 --maxExpectedThroughput=745</span>
<span class="go">finished reading file, now analyzing data:</span>

<span class="go">MOST CALLS TO ALLOCATION FUNCTIONS</span>
<span class="go">23447502 calls to allocation functions with 1.12MB peak consumption from</span>
<span class="go">ns3::Packet::Copy() const</span>
<span class="go">in ~/ns-3-dev/build/lib/libns3-dev-network.so</span>
<span class="go">4320000 calls with 0B peak consumption from:</span>
<span class="go">    ns3::UdpSocketImpl::DoSendTo(ns3::Ptr&lt;&gt;, ns3::Ipv4Address, unsigned short, unsigned char)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-internet.so</span>
<span class="go">    ns3::UdpSocketImpl::DoSend(ns3::Ptr&lt;&gt;)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-internet.so</span>
<span class="go">    ns3::UdpSocketImpl::Send(ns3::Ptr&lt;&gt;, unsigned int)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-internet.so</span>
<span class="go">    ns3::Socket::Send(ns3::Ptr&lt;&gt;)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-network.so</span>
<span class="go">    ns3::UdpClient::Send()</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-applications.so</span>
<span class="go">    ns3::DefaultSimulatorImpl::ProcessOneEvent()</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-core.so</span>
<span class="go">    ns3::DefaultSimulatorImpl::Run()</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-core.so</span>
<span class="go">    main</span>
<span class="go">    in ~/ns-3-dev/build/examples/wireless/ns3-dev-wifi-he-network</span>

<span class="go">...</span>

<span class="go">MOST TEMPORARY ALLOCATIONS</span>
<span class="go">6182320 temporary allocations of 6182701 allocations in total (99.99%) from</span>
<span class="go">ns3::QueueDisc::DropBeforeEnqueue(ns3::Ptr&lt;&gt;, char const*)</span>
<span class="go">in ~/ns-3-dev/build/lib/libns3-dev-traffic-control.so</span>
<span class="go">1545580 temporary allocations of 1545580 allocations in total (100.00%) from:</span>
<span class="go">    std::_Function_handler&lt;&gt;::_M_invoke(std::_Any_data const&amp;, ns3::Ptr&lt;&gt;&amp;&amp;, char const*&amp;&amp;)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-traffic-control.so</span>
<span class="go">    std::function&lt;&gt;::operator()(ns3::Ptr&lt;&gt;, char const*) const</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-traffic-control.so</span>
<span class="go">    ns3::MemPtrCallbackImpl&lt;&gt;::operator()(ns3::Ptr&lt;&gt;, char const*)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-traffic-control.so</span>
<span class="go">    ns3::TracedCallback&lt;&gt;::operator()(ns3::Ptr&lt;&gt;, char const*) const</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-traffic-control.so</span>
<span class="go">    ns3::QueueDisc::DropBeforeEnqueue(ns3::Ptr&lt;&gt;, char const*)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-traffic-control.so</span>
<span class="go">    ns3::CoDelQueueDisc::DoEnqueue(ns3::Ptr&lt;&gt;)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-traffic-control.so</span>
<span class="go">    ns3::QueueDisc::Enqueue(ns3::Ptr&lt;&gt;)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-traffic-control.so</span>
<span class="go">    ns3::FqCoDelQueueDisc::DoEnqueue(ns3::Ptr&lt;&gt;)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-traffic-control.so</span>
<span class="go">    ns3::QueueDisc::Enqueue(ns3::Ptr&lt;&gt;)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-traffic-control.so</span>
<span class="go">    ns3::TrafficControlLayer::Send(ns3::Ptr&lt;&gt;, ns3::Ptr&lt;&gt;)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-traffic-control.so</span>
<span class="go">    ns3::Ipv4Interface::Send(ns3::Ptr&lt;&gt;, ns3::Ipv4Header const&amp;, ns3::Ipv4Address)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-internet.so</span>
<span class="go">    ns3::Ipv4L3Protocol::SendRealOut(ns3::Ptr&lt;&gt;, ns3::Ptr&lt;&gt;, ns3::Ipv4Header const&amp;)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-internet.so</span>
<span class="go">    ns3::Ipv4L3Protocol::Send(ns3::Ptr&lt;&gt;, ns3::Ipv4Address, ns3::Ipv4Address, unsigned char, ns3::Ptr&lt;&gt;)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-internet.so</span>
<span class="go">    ns3::UdpL4Protocol::Send(ns3::Ptr&lt;&gt;, ns3::Ipv4Address, ns3::Ipv4Address, unsigned short, unsigned short, ns3::Ptr&lt;&gt;)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-internet.so</span>
<span class="go">    ns3::UdpSocketImpl::DoSendTo(ns3::Ptr&lt;&gt;, ns3::Ipv4Address, unsigned short, unsigned char)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-internet.so</span>
<span class="go">    ns3::UdpSocketImpl::DoSend(ns3::Ptr&lt;&gt;)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-internet.so</span>
<span class="go">    ns3::UdpSocketImpl::Send(ns3::Ptr&lt;&gt;, unsigned int)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-internet.so</span>
<span class="go">    ns3::Socket::Send(ns3::Ptr&lt;&gt;)</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-network.so</span>
<span class="go">    ns3::UdpClient::Send()</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-applications.so</span>
<span class="go">    ns3::DefaultSimulatorImpl::ProcessOneEvent()</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-core.so</span>
<span class="go">    ns3::DefaultSimulatorImpl::Run()</span>
<span class="go">    in ~/ns-3-dev/build/lib/libns3-dev-core.so</span>
<span class="go">    main</span>
<span class="go">    in ~/ns-3-dev/build/examples/wireless/ns3-dev-wifi-he-network</span>

<span class="go">...</span>

<span class="go">total runtime: 156.30s.</span>
<span class="go">calls to allocation functions: 149185947 (954466/s)</span>
<span class="go">temporary memory allocations: 21757614 (139201/s)</span>
<span class="go">peak heap memory consumption: 4.87MB</span>
<span class="go">peak RSS (including heaptrack overhead): 42.02MB</span>
<span class="go">total memory leaked: 895.45KB</span>
</pre></div>
</div>
<p>The terminal output above lists the most frequently called functions that allocated memory.</p>
<p>Here is a short description of what each line of the last block of the output means:</p>
<ul class="simple">
<li><p>Allocation functions are all functions that allocated memory, either explicitly
via C-style <code class="docutils literal notranslate"><span class="pre">malloc</span></code> and C++ <code class="docutils literal notranslate"><span class="pre">new</span></code>, or implicitly via RAII and automatic conversions.</p></li>
<li><p>Temporary memory allocations are allocations that are followed by the
deallocation without modifying the data.</p></li>
<li><p>Peak heap memory is the maximum memory allocated by the program throughout its execution.
The memory allocator may reuse memory freed by previous destructors, <code class="docutils literal notranslate"><span class="pre">del</span></code> and <code class="docutils literal notranslate"><span class="pre">free</span></code> calls,
reducing the number of system calls and maximum memory allocated.</p></li>
<li><p>RSS is the Resident Set Size, which is the amount of physical memory occupied by the process.</p></li>
<li><p>Total memory leak refers to memory allocated but never freed. This includes static initialization,
so it is not uncommon to be different than 0KB. However this does not mean the program does not
have memory leaks. Other memory profilers such as Valgrind and memory sanitizers are better
suited to track down memory leaks.</p></li>
</ul>
<p>Based on the stack trace, it is fairly easy to locate the corresponding code and act on it to
reduce the number of allocations.</p>
<p>In the case of <code class="docutils literal notranslate"><span class="pre">ns3::QueueDisc::DropBeforeEnqueue</span></code> shown above, the
allocations were caused by the transformation of C strings (<code class="docutils literal notranslate"><span class="pre">char*</span></code>) into C++ strings
(std::string) before performing the search in ns3::QueueDisc::Stats maps.
These unnecessary allocations were prevented by making use of the transparent
comparator <code class="docutils literal notranslate"><span class="pre">std::less&lt;&gt;</span></code>, part of merge request <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/830">MR830</a>.</p>
<p>Heaptrack also has a GUI that provides the same information printed by the command line interface,
but in a more interactive way.</p>
<img alt="_images/heaptrack.png" src="_images/heaptrack.png" />
<p>Heaptrack was used in merge request <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/830">MR830</a> to track and reduce the number of allocations
in the <code class="docutils literal notranslate"><span class="pre">wifi-he-network</span></code> example mentioned above. About 29 million unnecessary allocations
were removed, which translates to a 20% reduction. This resulted in a 1.07x speedup of the
test suite with Valgrind (<code class="docutils literal notranslate"><span class="pre">./test.py</span> <span class="pre">-d</span> <span class="pre">-g</span></code>) and 1.02x speedup without it.</p>
</section>
<section id="memray">
<h5><span class="section-number">4.9.1.4. </span>Memray<a class="headerlink" href="#memray" title="Link to this heading">¶</a></h5>
<p><a class="reference external" href="https://bloomberg.github.io/memray/">Memray</a> is an utility made by Bloomberg to trace memory allocations of Python programs,
including native code called by them. Along with stack traces, developers can trace down
possible memory leaks and unnecessary allocations.</p>
<p>Note: Memray is ineffective for profiling the ns-3 python bindings since Cppyy hides away
the calls to the ns-3 module libraries. However, it is still useful for python scripts
in general, for example ones used to parse and consolidate simulation results.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ns3</span></code> script includes a run option to launch Python programs with Memray.
Memray can produce different types of reports, such as a flamegraph in HTML, or
text reports (<code class="docutils literal notranslate"><span class="pre">summary</span></code> and <code class="docutils literal notranslate"><span class="pre">stats</span></code>).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/$ ./ns3 run sample-rng-plot.py --memray</span>
<span class="go">Writing profile results into memray.output</span>
<span class="go">Memray WARNING: Correcting symbol for aligned_alloc from 0x7fd97023c890 to 0x7fd97102fce0</span>
<span class="go">[memray] Successfully generated profile results.</span>

<span class="go">You can now generate reports from the stored allocation records.</span>
<span class="go">Some example commands to generate reports:</span>

<span class="go">/usr/bin/python3 -m memray flamegraph memray.output</span>
<span class="go">~/ns-3-dev$ /usr/bin/python3 -m memray stats memray.output</span>
<span class="go">   Total allocations:</span>
<span class="go">         5364235</span>

<span class="go">   Total memory allocated:</span>
<span class="go">         10.748GB</span>

<span class="go">   Histogram of allocation size:</span>
<span class="go">         min: 0.000B</span>
<span class="go">         ----------------------------------------------</span>
<span class="go">         &lt; 8.000B   :  264149 |||</span>
<span class="go">         &lt; 78.000B  : 2051906 |||||||||||||||||||||||</span>
<span class="go">         &lt; 699.000B : 2270941 |||||||||||||||||||||||||</span>
<span class="go">         &lt; 6.064KB  :  608993 |||||||</span>
<span class="go">         &lt; 53.836KB :  165307 ||</span>
<span class="go">         &lt; 477.912KB:    2220 |</span>
<span class="go">         &lt; 4.143MB  :     511 |</span>
<span class="go">         &lt; 36.779MB :     188 |</span>
<span class="go">         &lt; 326.492MB:      19 |</span>
<span class="go">         &lt;=2.830GB  :       1 |</span>
<span class="go">         ----------------------------------------------</span>
<span class="go">         max: 2.830GB</span>

<span class="go">   Allocator type distribution:</span>
<span class="go">          MALLOC: 4647765</span>
<span class="go">          CALLOC: 435525</span>
<span class="go">          REALLOC: 277736</span>
<span class="go">          POSIX_MEMALIGN: 2686</span>
<span class="go">          MMAP: 523</span>

<span class="go">   Top 5 largest allocating locations (by size):</span>
<span class="go">         - include:/usr/local/lib/python3.10/dist-packages/cppyy/__init__.py:243 -&gt; 8.814GB</span>
<span class="go">         - &lt;stack trace unavailable&gt; -&gt; 746.999MB</span>
<span class="go">         - show:~/.local/lib/python3.10/site-packages/matplotlib/backends/backend_gtk4.py:340 -&gt; 263.338MB</span>
<span class="go">         - load_library:/usr/local/lib/python3.10/dist-packages/cppyy/__init__.py:235 -&gt; 245.684MB</span>
<span class="go">         - __init__:/usr/lib/python3.10/ctypes/__init__.py:374 -&gt; 225.797MB</span>

<span class="go">   Top 5 largest allocating locations (by number of allocations):</span>
<span class="go">         - include:/usr/local/lib/python3.10/dist-packages/cppyy/__init__.py:243 -&gt; 2246145</span>
<span class="go">         - show:~/.local/lib/python3.10/site-packages/matplotlib/backends/backend_gtk4.py:340 -&gt; 1264614</span>
<span class="go">         - &lt;stack trace unavailable&gt; -&gt; 1098543</span>
<span class="go">         - __init__:~/.local/lib/python3.10/site-packages/matplotlib/backends/backend_gtk4.py:61 -&gt; 89466</span>
<span class="go">         - run:/usr/lib/python3/dist-packages/gi/overrides/Gio.py:42 -&gt; 79582</span>
</pre></div>
</div>
</section>
</section>
<section id="performance-profilers">
<h4><span class="section-number">4.9.2. </span>Performance Profilers<a class="headerlink" href="#performance-profilers" title="Link to this heading">¶</a></h4>
<p>Performance profilers are programs that collect runtime information and help to
identify performance bottlenecks. In some cases, they can point out hotspots
and suggest solutions.</p>
<p>There are many tools to profile your program, including:</p>
<ul class="simple">
<li><p>profilers from CPU manufacturers, such as <a class="reference external" href="https://www.amd.com/en/developer/uprof.html">AMD uProf</a> and <a class="reference external" href="https://www.intel.com/content/www/us/en/develop/documentation/get-started-with-vtune/top.html">Intel VTune</a></p></li>
<li><p>profilers from the operating systems, such as Linux’s <a class="reference external" href="https://perf.wiki.kernel.org/index.php/Tutorial">Perf</a> and <a class="reference external" href="https://docs.microsoft.com/en-us/windows-hardware/test/wpt/">Windows Performance Toolkit</a></p>
<ul>
<li><p><a class="reference external" href="https://perf.wiki.kernel.org/index.php/Tutorial">Perf</a> also has a few graphical user interfaces available, being <a class="reference external" href="https://github.com/KDAB/hotspot">Hotspot</a> one of them</p></li>
</ul>
</li>
<li><p>instrumented compilation and auxiliary tools provided by compilers, such as <a class="reference external" href="https://sourceware.org/binutils/docs/gprof/">Gprof</a></p></li>
<li><p>third-party tools, such as <a class="reference external" href="https://wiki.gnome.org/Apps/Sysprof">Sysprof</a> and <a class="reference external" href="https://oprofile.sourceforge.io/faq/">Oprofile</a></p></li>
</ul>
<p>An overview on how to use <a class="reference external" href="https://perf.wiki.kernel.org/index.php/Tutorial">Perf</a> with <a class="reference external" href="https://github.com/KDAB/hotspot">Hotspot</a>, <a class="reference external" href="https://www.amd.com/en/developer/uprof.html">AMD uProf</a> and
<a class="reference external" href="https://www.intel.com/content/www/us/en/develop/documentation/get-started-with-vtune/top.html">Intel VTune</a> is provided in the following sections.</p>
<section id="linux-perf-and-hotspot-gui">
<span id="id5"></span><h5><span class="section-number">4.9.2.1. </span>Linux Perf and Hotspot GUI<a class="headerlink" href="#linux-perf-and-hotspot-gui" title="Link to this heading">¶</a></h5>
<p><a class="reference external" href="https://perf.wiki.kernel.org/index.php/Tutorial">Perf</a> is the kernel tool to measure performance of the Linux kernel,
drivers and user-space applications.</p>
<p>Perf tracks some performance events, being some of the most important for performance:</p>
<ul class="simple">
<li><p>cycles</p>
<ul>
<li><p>Clocks (time) spent running.</p></li>
</ul>
</li>
<li><p>cache-misses</p>
<ul>
<li><p>When either data or instructions were not in the L1/L2 caches, requiring
a L3 or memory access.</p></li>
</ul>
</li>
<li><p>branch-misses</p>
<ul>
<li><p>How many branch instructions were mispredicted.
Mispredictions causes the CPU to stall and clean the pipeline,
slowing down the program.</p></li>
</ul>
</li>
<li><p>stalled-cycles-frontend</p>
<ul>
<li><p>Cycles wasted by the processor waiting for the next instruction,
usually due to instruction cache miss or mispredictions.
Starves the CPU pipeline of instructions and slows down the program.</p></li>
</ul>
</li>
<li><p>stalled-cycles-backend</p>
<ul>
<li><p>Cycles wasted waiting for pipeline resources to finish their work.
Usually waiting for memory read/write, or executing long-latency instructions.</p></li>
</ul>
</li>
</ul>
<p>Just like with <code class="docutils literal notranslate"><span class="pre">heaptrack</span></code>, perf can be executed using the <code class="docutils literal notranslate"><span class="pre">ns3</span></code> wrapper
command template. In the following command we output perf data from <code class="docutils literal notranslate"><span class="pre">wifi-he-network</span></code>
to the <code class="docutils literal notranslate"><span class="pre">perf.data</span></code> output file.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 run &quot;wifi-he-network --simulationTime=0.3 --frequency=5 --useRts=1 --minExpectedThroughput=6 --maxExpectedThroughput=745&quot; --command-template &quot;perf record -o ./perf.data --call-graph dwarf --event cycles,cache-misses,branch-misses --sample-cpu %s&quot; --no-build</span>
</pre></div>
</div>
<p>For ease of use, <code class="docutils literal notranslate"><span class="pre">ns3</span></code> also provides the <code class="docutils literal notranslate"><span class="pre">--perf</span></code> run option, that
include the recommended settings.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 run &quot;wifi-he-network --simulationTime=0.3 --frequency=5 --useRts=1 --minExpectedThroughput=6 --maxExpectedThroughput=745&quot; --perf --no-build</span>
</pre></div>
</div>
<p>When running for the first time, you may receive the following error:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 run &quot;wifi-he-network --simulationTime=0.3 --frequency=5 --useRts=1 --minExpectedThroughput=6 --maxExpectedThroughput=745&quot; --perf --no-build</span>
<span class="go">Error:</span>
<span class="go">Access to performance monitoring and observability operations is limited.</span>
<span class="go">Consider adjusting /proc/sys/kernel/perf_event_paranoid setting to open</span>
<span class="go">access to performance monitoring and observability operations for processes</span>
<span class="go">without CAP_PERFMON, CAP_SYS_PTRACE or CAP_SYS_ADMIN Linux capability.</span>
<span class="go">More information can be found at &#39;Perf events and tool security&#39; document:</span>
<span class="go">https://www.kernel.org/doc/html/latest/admin-guide/perf-security.html</span>
<span class="go">perf_event_paranoid setting is 1:</span>
<span class="go">  -1: Allow use of (almost) all events by all users</span>
<span class="go">      Ignore mlock limit after perf_event_mlock_kb without CAP_IPC_LOCK</span>
<span class="go">&gt;= 0: Disallow raw and ftrace function tracepoint access</span>
<span class="go">&gt;= 1: Disallow CPU event access</span>
<span class="go">&gt;= 2: Disallow kernel profiling</span>
<span class="go">To make the adjusted perf_event_paranoid setting permanent preserve it</span>
<span class="go">in /etc/sysctl.conf (e.g. kernel.perf_event_paranoid = &lt;setting&gt;)</span>
<span class="go">Command &#39;build/examples/wireless/ns3-dev-wifi-he-network-default record --call-graph dwarf -a -e cache-misses,branch-misses,cpu-cycles,instructions,context-switches build/examples/wireless/ns3-dev-wifi-he-network-default -n=100&#39; returned non-zero exit status 255.</span>
</pre></div>
</div>
<p>This error is related to lacking permissions to access performance events from the kernel and CPU.
As said in the error, permissions can be granted for the current session
by changing the <code class="docutils literal notranslate"><span class="pre">perf_event_paranoid</span></code> setting with <code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">0</span> <span class="pre">&gt;</span> <span class="pre">/proc/sys/kernel/perf_event_paranoid</span></code>.
This change can be made permanent by changing the setting in <code class="docutils literal notranslate"><span class="pre">/etc/sysctl.conf</span></code>, but
this is not recommended. Administrative permissions (<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">su</span></code>) are required in both cases.</p>
<p>After the program finishes, it will print recording statistics.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">MCS value               Channel width           GI                      Throughput</span>
<span class="go">0                       20 MHz                  3200 ns                 6.01067 Mbit/s</span>
<span class="go">0                       20 MHz                  1600 ns                 5.936 Mbit/s</span>
<span class="go">...</span>
<span class="go">11                      160 MHz                 1600 ns                 493.397 Mbit/s</span>
<span class="go">11                      160 MHz                 800 ns                  534.016 Mbit/s</span>
<span class="go">[ perf record: Woken up 9529 times to write data ]</span>
<span class="go">Warning:</span>
<span class="go">Processed 517638 events and lost 94 chunks!</span>

<span class="go">Check IO/CPU overload!</span>

<span class="go">Warning:</span>
<span class="go">1 out of order events recorded.</span>
<span class="go">[ perf record: Captured and wrote 2898,307 MB perf.data (436509 samples) ]</span>
</pre></div>
</div>
<p>Results saved in <code class="docutils literal notranslate"><span class="pre">perf.data</span></code> can be reviewed with the <code class="docutils literal notranslate"><span class="pre">perf</span> <span class="pre">report</span></code> command.</p>
<p><a class="reference external" href="https://github.com/KDAB/hotspot">Hotspot</a> is a GUI for Perf, that makes performance profiling more
enjoyable and productive. It can parse the <code class="docutils literal notranslate"><span class="pre">perf.data</span></code> and show in
a more friendly way.</p>
<p>To record the same perf.data from Hotspot directly, fill the fields
for working directory, path to the executable, arguments, perf
events to track and output directory for the <code class="docutils literal notranslate"><span class="pre">perf.data</span></code>.
Then run to start recording.</p>
<img alt="_images/hotspot-setup.png" src="_images/hotspot-setup.png" />
<p>The cycles per function for this program is shown in the following
image.</p>
<img alt="_images/hotspot-cycles.png" src="_images/hotspot-cycles.png" />
<p>The data is also presented in a tabular format in the bottom-up,
top-down and caller/callee tabs (top left of the screen).</p>
<img alt="_images/hotspot-top-down.png" src="_images/hotspot-top-down.png" />
<p>Hotspot was used to identify performance bottlenecks in multiple occasions:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">wifi-primary-channels</span></code> test suite was extremely slow due to unnecessary RF processing.
The adopted solution was to replace the filtering step of the entire channel to just the desired
sub-band, and assuming sub-bands are uniformly sized, saving multiplications in the integral
used to compute the power of each sub-band. This resulted in a 6x speedup with
<code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">run</span> <span class="pre">&quot;test-runner</span> <span class="pre">--fullness=TAKES_FOREVER</span> <span class="pre">--test-name=wifi-primary-channels&quot;</span></code>.
Hotspot was used along with AMD uProf to track this and other bottlenecks in <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/issues/426">issue 426</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">WifiMacQueue::TtlExceeded</span></code> dereferenced data out of cache when calling Simulator::Now().
The adopted solution was to move Simulator::Now() out of TtlExceeded and reuse the value
and inlining TtlExceeded. This resulted in a ~1.20x speedup with the test suite (<code class="docutils literal notranslate"><span class="pre">./test.py</span> <span class="pre">-d</span></code>).
Hotspot was used along with AMD uProf to track this and other bottlenecks in <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/issues/280">issue 280</a>
and merge request <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/681">MR681</a>.</p></li>
<li><p>MpduAggregator and MsduAggregator required an expensive attribute lookup to get the maximum sizes
from the RegularWifiMac. Bypassing the attribute lookup reduced cache misses and unnecessary branches.
The adopted solution was to move Simulator::Now() out of TtlExceeded and reuse the value
and inlining TtlExceeded. This resulted in a ~1.02x speedup with the test suite (<code class="docutils literal notranslate"><span class="pre">./test.py</span> <span class="pre">-d</span></code>).
More details on: merge requests <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/681">MR681</a> and <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/685">MR685</a>.</p></li>
</ol>
</section>
<section id="id6">
<h5><span class="section-number">4.9.2.2. </span>AMD uProf<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h5>
<p><a class="reference external" href="https://www.amd.com/en/developer/uprof.html">AMD uProf</a> works much like <a class="reference internal" href="#linux-perf-and-hotspot-gui">Linux Perf and Hotspot GUI</a>, but
is available in more platforms (Linux, Windows and BSD) using AMD
processors. Differently from Perf, it provides more performance
trackers for finer analysis.</p>
<p>To use it, open uProf then click to profile an application. If you
have already profile an application, you can reuse those settings for
another application by clicking in one of the items in the <code class="docutils literal notranslate"><span class="pre">Recently</span> <span class="pre">Used</span>
<span class="pre">Configurations</span></code> section.</p>
<img alt="_images/uprof-start.png" src="_images/uprof-start.png" />
<p>Fill the fields with the application path, the arguments and
the working directory.</p>
<p>You may need to add the LD_LIBRARY_PATH environment variable
(or PATH on Windows), pointing it to the library output
directory (e.g. <code class="docutils literal notranslate"><span class="pre">ns-3-dev/build/lib</span></code>).</p>
<p>Then click next:</p>
<img alt="_images/uprof-profile-application.png" src="_images/uprof-profile-application.png" />
<p>Now select custom events and pick the events you want.</p>
<dl class="simple">
<dt>The recommended ones for performance profiling are:</dt><dd><ul class="simple">
<li><p>CYCLES_NOT_IN_HALT</p>
<ul>
<li><p>Clocks (time) spent running.</p></li>
</ul>
</li>
<li><p>RETIRED_INST</p>
<ul>
<li><p>How many instructions were completed.</p></li>
<li><p>These do not count mispredictions, stalls, etc.</p></li>
<li><p>Instructions per clock (IPC) = RETIRED_INST / CYCLES_NOT_IN_HALT</p></li>
</ul>
</li>
<li><p>RETIRED_BR_INST_MISP</p>
<ul>
<li><p>How many branch instructions were mispredicted.</p></li>
<li><p>Mispredictions causes the CPU to stall and clean the pipeline,
slowing down the program.</p></li>
</ul>
</li>
<li><p>L2_CACHE_MISS.FROM_L1_IC_MISS</p>
<ul>
<li><p>L2 cache misses caused by instruction L1 cache misses.</p></li>
<li><p>Results in L3/memory accesses due to missing instructions in L1/L2.</p></li>
</ul>
</li>
<li><p>L2_CACHE_MISS.FROM_L1_DC_MISS</p>
<ul>
<li><p>L2 cache misses caused by data L1 cache misses.</p></li>
<li><p>Results in L3/memory accesses due to missing instructions in L1/L2</p></li>
</ul>
</li>
<li><p>MISALIGNED_LOADS</p>
<ul>
<li><p>Loads not aligned with processor words.</p></li>
<li><p>Might result in additional cache and memory accesses.</p></li>
</ul>
</li>
</ul>
</dd>
</dl>
<img alt="_images/uprof-select-events.png" src="_images/uprof-select-events.png" />
<p>Now click in advanced options to enable collection of the call stack.</p>
<img alt="_images/uprof-collect-callstack.png" src="_images/uprof-collect-callstack.png" />
<p>Then click <code class="docutils literal notranslate"><span class="pre">Start</span> <span class="pre">Profile</span></code> and wait for the program to end.
After it finishes you will be greeted with a hotspot summary screen,
but the <code class="docutils literal notranslate"><span class="pre">Analyze</span></code> tab (top of the screen) has sub-tabs with more
relevant information.</p>
<p>In the following image the metrics are shown per module, including the
C library (libc.so.6) which provides the <code class="docutils literal notranslate"><span class="pre">malloc</span></code> and <code class="docutils literal notranslate"><span class="pre">free</span></code> functions.
Values can be shown in terms of samples or percentages for easier reading
and to decide where to optimize.</p>
<img alt="_images/uprof-stats.png" src="_images/uprof-stats.png" />
<p>Here are a few cases where AMD uProf was used to identify performance bottlenecks:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">WifiMacQueue::TtlExceeded</span></code> dereferenced data out of cache when calling Simulator::Now().
The adopted solution was to move Simulator::Now() out of TtlExceeded and reuse the value
and inlining TtlExceeded. This resulted in a ~1.20x speedup with the test suite (<code class="docutils literal notranslate"><span class="pre">./test.py</span> <span class="pre">-d</span></code>).
More details on: <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/issues/280">issue 280</a> and merge request <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/681">MR681</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">wifi-primary-channels</span></code> test suite was extremely slow due to unnecessary RF processing.
The adopted solution was to replace the filtering step of the entire channel to just the desired
sub-band, and assuming sub-bands are uniformly sized, saving multiplications in the integral
used to compute the power of each sub-band. This resulted in a 6x speedup with
<code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">run</span> <span class="pre">&quot;test-runner</span> <span class="pre">--fullness=TAKES_FOREVER</span> <span class="pre">--test-name=wifi-primary-channels&quot;</span></code>.
More details on: <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/issues/426">issue 426</a> and merge request <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/677">MR677</a>.</p></li>
<li><p>Continuing the work on <code class="docutils literal notranslate"><span class="pre">wifi-primary-channels</span></code> test suite, profiling showed an excessive
number of cache misses in <code class="docutils literal notranslate"><span class="pre">InterferenceHelper::GetNextPosition</span></code>.
This function searches for an iterator on a map, which is very fast
if the map is small and fits in the cache, which was not the case. After reviewing the code,
it was noticed in most cases this call was unnecessary as the iterator was already known.
The adopted solution was to reuse the iterator whenever possible.
This resulted in a 1.78x speedup on top of the previous 6x with
<code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">run</span> <span class="pre">&quot;test-runner</span> <span class="pre">--fullness=TAKES_FOREVER</span> <span class="pre">--test-name=wifi-primary-channels&quot;</span></code>.
More details on: <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/issues/426">issue 426</a> and merge requests <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/677">MR677</a> and <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/680">MR680</a>.</p></li>
<li><p>Position-Independent Code libraries (<code class="docutils literal notranslate"><span class="pre">-fPIC</span></code>) have an additional layer of indirection that increases
instruction cache misses. The adopted solution was to disable <a class="reference external" href="https://maskray.me/blog/2021-05-09-fno-semantic-interposition">semantic interposition</a> with flag
<code class="docutils literal notranslate"><span class="pre">-fno-semantic-interposition</span></code> on GCC. This is the default setting on Clang. This results in
approximately 1.14x speedup with <code class="docutils literal notranslate"><span class="pre">./test.py</span> <span class="pre">-d</span></code>. More details on: <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/777">MR777</a>.</p></li>
</ol>
<p>Note: all speedups above were measured on the same machine. Results may differ based on clock speeds,
cache sizes, number of cores, memory bandwidth and latency, storage throughput and latency.</p>
</section>
<section id="id8">
<h5><span class="section-number">4.9.2.3. </span>Intel VTune<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h5>
<p><a class="reference external" href="https://www.intel.com/content/www/us/en/develop/documentation/get-started-with-vtune/top.html">Intel VTune</a> works much like <a class="reference internal" href="#linux-perf-and-hotspot-gui">Linux Perf and Hotspot GUI</a>, but
is available in more platforms (Linux, Windows and Mac) using Intel
processors. Differently from Perf, it provides more performance
trackers for finer analysis.</p>
<p>When you open the program, you will be greeted by the landing page
shown in the following image. To start a new profiling project, click
in the <code class="docutils literal notranslate"><span class="pre">Configure</span> <span class="pre">Analysis</span></code> button. If you already have a project,
right-click the entry and click to configure analysis to reuse the
settings.</p>
<img alt="_images/vtune-landing.png" src="_images/vtune-landing.png" />
<p>A configuration page will open, where you can fill the fields with
the path to the program, arguments, and set working directory and
environment variables.</p>
<p>Note: in this example on Windows using MinGW,
we need to define the <code class="docutils literal notranslate"><span class="pre">PATH</span></code> environment variable with the paths
to both <code class="docutils literal notranslate"><span class="pre">~/ns-3-dev/build/lib</span></code> and the MinGW binaries folder
(<code class="docutils literal notranslate"><span class="pre">~/msys64/mingw64/bin</span></code>), which contains essential libraries.
On Linux-like systems you will need to define the
<code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> environment variable instead of <code class="docutils literal notranslate"><span class="pre">PATH</span></code>.</p>
<p>Clicking on the <code class="docutils literal notranslate"><span class="pre">Performance</span> <span class="pre">Snapshot</span></code> shows the different profiling
options.</p>
<img alt="_images/vtune-configure.png" src="_images/vtune-configure.png" />
<p>If executed as is, a quicker profiling will be executed to
determine what areas should be profiled with more details.
For the specific example, it is indicated that there are
microarchitectural bottlenecks and low parallelism
(not a surprise since ns-3 is single-threaded).</p>
<img alt="_images/vtune-perf-snapshot.png" src="_images/vtune-perf-snapshot.png" />
<p>If the <code class="docutils literal notranslate"><span class="pre">microarchitecture</span> <span class="pre">exploration</span></code> option is selected, cycles,
branch mispredictions, cache misses and other metrics will be collected.</p>
<img alt="_images/vtune-select-uarch-profiling.png" src="_images/vtune-select-uarch-profiling.png" />
<p>After executing the <code class="docutils literal notranslate"><span class="pre">microarchitecture</span> <span class="pre">exploration</span></code>, a summary will
be shown. Hovering the mouse over the red flags will explain what
each sentence means and how it impacts performance.</p>
<img alt="_images/vtune-uarch-profiling-summary.png" src="_images/vtune-uarch-profiling-summary.png" />
<p>Clicking in the <code class="docutils literal notranslate"><span class="pre">Bottom-up</span></code> tab shows all the information per module.
A plethora of stats such as CPU time, instructions retired,
retiring percentage (how many of the dispatched instructions
were executed until the end, usually lower than 100% because of branch
mispredictions), bad speculation, cache misses, unused load ports,
and more.</p>
<p>The stats for the wifi module are shown below. The retiring
metric indicates about 40% of dispatched instructions are
executed. The diagram on the right shows the bottleneck is
in the front-end of the pipeline (red), due to high
instruction cache misses, translation lookaside buffer (TLB)
overhead and unknown branches (most likely callbacks).</p>
<img alt="_images/vtune-uarch-wifi-stats.png" src="_images/vtune-uarch-wifi-stats.png" />
<p>The stats for the core module are shown below.
More specifically for the ns3::Object::DoGetObject function.
Metrics indicates about 63% of bad speculations.
The diagram on the right shows that there are bottlenecks
both in the front-end and due to bad speculation (red).</p>
<img alt="_images/vtune-uarch-core-stats.png" src="_images/vtune-uarch-core-stats.png" />
</section>
</section>
<section id="system-calls-profilers">
<h4><span class="section-number">4.9.3. </span>System calls profilers<a class="headerlink" href="#system-calls-profilers" title="Link to this heading">¶</a></h4>
<p>System call profilers collect information on which system
calls were made by a program, how long they took to be
fulfilled and how many of them resulted in errors.</p>
<p>There are many system call profilers, including <a class="reference external" href="https://github.com/opendtrace/documentation">dtrace</a>, <a class="reference external" href="https://strace.io/">strace</a> and <a class="reference external" href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon">procmon</a>.</p>
<p>An overview on how to use <a class="reference external" href="https://strace.io/">strace</a> is provided in the following section.</p>
<section id="id9">
<h5><span class="section-number">4.9.3.1. </span>Strace<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h5>
<p>The <a class="reference external" href="https://strace.io/">strace</a> is a system calls (syscalls) profiler for Linux. It can filter
specific syscalls, or gather stats during the execution.</p>
<p>To collect statistics, use <code class="docutils literal notranslate"><span class="pre">strace</span> <span class="pre">-c</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~ns-3-dev/$ ./ns3 run &quot;wifi-he-network --simulationTime=0.3 --frequency=5 --useRts=1 --minExpectedThroughput=6 --maxExpectedThroughput=745&quot; --command-template &quot;strace -c %s&quot; --no-build</span>
<span class="go">MCS value               Channel width           GI                      Throughput</span>
<span class="go">0                       20 MHz                  3200 ns                 5.91733 Mbit/s</span>
<span class="go">...</span>
<span class="go">11                      160 MHz                 800 ns                  524.459 Mbit/s</span>
<span class="gp">% </span><span class="nb">time</span><span class="w">     </span>seconds<span class="w">  </span>usecs/call<span class="w">     </span>calls<span class="w">    </span>errors<span class="w"> </span>syscall
<span class="go">------ ----------- ----------- --------- --------- ----------------</span>
<span class="go"> 37.62    0.004332          13       326       233 openat</span>
<span class="go"> 35.46    0.004083           9       415           mmap</span>
<span class="go">...</span>
<span class="go">------ ----------- ----------- --------- --------- ----------------</span>
<span class="go">100.00    0.011515           8      1378       251 total</span>
</pre></div>
</div>
<p>In the example above, the syscalls are listed in the right, after
the time spent on each syscall, number of calls and errors.</p>
<p>The errors can be caused due to multiple reasons and may not
be a problem. To check if they were problems, strace can log the
syscalls with <code class="docutils literal notranslate"><span class="pre">strace</span> <span class="pre">-o</span> <span class="pre">calls.log</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~ns-3-dev/$ ./ns3 run &quot;wifi-he-network --simulationTime=0.3 --frequency=5 --useRts=1 --minExpectedThroughput=6 --maxExpectedThroughput=745&quot; --command-template &quot;strace -o calls.log %s&quot; --no-build</span>
<span class="go">MCS value               Channel width           GI                      Throughput</span>
<span class="go">0                       20 MHz                  3200 ns                 5.91733 Mbit/s</span>
<span class="go">...</span>
<span class="go">11                      160 MHz                 800 ns                  524.459 Mbit/s</span>
</pre></div>
</div>
<p>Looking at the <code class="docutils literal notranslate"><span class="pre">calls.log</span></code> file, we can see different sections. In the
following section, the example is executed (<code class="docutils literal notranslate"><span class="pre">execve</span></code>), architecture is checked (<code class="docutils literal notranslate"><span class="pre">arch_prctl</span></code>),
memory is mapped for execution (<code class="docutils literal notranslate"><span class="pre">mmap</span></code>) and LD_PRELOAD use is checked.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">execve(&quot;~/ns-3-dev/build/examples/wireless/ns3-dev-wifi-he-network&quot;, [&quot;~/ns-3-dev/b&quot;..., &quot;--simulationTime=0.3&quot;, &quot;--frequency=5&quot;, &quot;--useRts=1&quot;, &quot;--minExpectedThroughput=6&quot;, &quot;--maxExpectedThroughput=745&quot;], 0x7fffb0f91ad8 /* 3 vars */) = 0</span>
<span class="go">brk(NULL)                               = 0x563141b37000</span>
<span class="go">arch_prctl(0x3001 /* ARCH_??? */, 0x7ffff8d63a50) = -1 EINVAL (Invalid argument)</span>
<span class="go">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f103c2e9000</span>
<span class="go">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span>
</pre></div>
</div>
<p>Then the program searches for the wifi module library and fails multiple times (the errors seen in the table above).</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">openat(AT_FDCWD, &quot;~/ns-3-dev/build/lib/glibc-hwcaps/x86-64-v3/libns3-dev-wifi.so&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span>
<span class="go">newfstatat(AT_FDCWD, &quot;~/ns-3-dev/build/lib/glibc-hwcaps/x86-64-v3&quot;, 0x7ffff8d62c80, 0) = -1 ENOENT (No such file or directory)</span>
<span class="go">...</span>
<span class="go">openat(AT_FDCWD, &quot;~/ns-3-dev/build/lib/x86_64/libns3-dev-wifi.so&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span>
<span class="go">newfstatat(AT_FDCWD, &quot;~/ns-3-dev/build/lib/x86_64&quot;, 0x7ffff8d62c80, 0) = -1 ENOENT (No such file or directory)</span>
</pre></div>
</div>
<p>The library is finally found and its header is read:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">openat(AT_FDCWD, &quot;~/ns-3-dev/build/lib/libns3-dev-wifi.so&quot;, O_RDONLY|O_CLOEXEC) = 3</span>
<span class="go">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0py\30\0\0\0\0\0&quot;..., 832) = 832</span>
</pre></div>
</div>
<p>Then other modules that wifi depends on are loaded, then execution of the program continues to the main
function of the simulation.</p>
<p>Strace was used to track down issues found while running the <code class="docutils literal notranslate"><span class="pre">lena-radio-link-failure</span></code> example.
Its <code class="docutils literal notranslate"><span class="pre">strace</span> <span class="pre">-c</span></code> table was the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">% </span><span class="nb">time</span><span class="w">     </span>seconds<span class="w">  </span>usecs/call<span class="w">     </span>calls<span class="w">    </span>errors<span class="w"> </span>syscall
<span class="go">------ ----------- ----------- --------- --------- ----------------</span>
<span class="go"> 31,51    0,246243           2    103480       942 openat</span>
<span class="go"> 30,23    0,236284           2    102360           write</span>
<span class="go"> 19,90    0,155493           1    102538           close</span>
<span class="go"> 16,65    0,130132           1    102426           lseek</span>
<span class="go">  1,05    0,008186          18       437           mmap</span>
<span class="go">  0,21    0,001671          16        99           newfstatat</span>
<span class="go">  0,20    0,001595          11       134           mprotect</span>
<span class="go">  0,18    0,001391          14        98           read</span>
<span class="go">...</span>
<span class="go">------ ----------- ----------- --------- --------- ----------------</span>
<span class="go">100,00    0,781554           1    411681       951 total</span>
</pre></div>
</div>
<p>Notice the number of <code class="docutils literal notranslate"><span class="pre">openat</span></code>, <code class="docutils literal notranslate"><span class="pre">write</span></code>, <code class="docutils literal notranslate"><span class="pre">close</span></code> and <code class="docutils literal notranslate"><span class="pre">lseek</span></code> calls
are much more frequent than the other calls. These mean
<code class="docutils literal notranslate"><span class="pre">lena-radio-link-failure</span></code> is opening, then seeking, then writing,
then closing at least one file handler.</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">strace</span></code>, we can easily find the most frequently used file handlers.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~ns-3-dev/$./ns3 run &quot;lena-radio-link-failure --numberOfEnbs=2 --useIdealRrc=0 --interSiteDistance=700 --simTime=17&quot; --command-template=&quot;strace %s&quot;</span>
<span class="go">...</span>
<span class="go">openat(AT_FDCWD, &quot;DlTxPhyStats.txt&quot;, O_WRONLY|O_CREAT|O_APPEND, 0666) = 3</span>
<span class="go">lseek(3, 0, SEEK_END)                   = 9252</span>
<span class="go">write(3, &quot;635\t1\t1\t1\t0\t20\t1191\t0\t1\t0\n&quot;, 26) = 26</span>
<span class="go">close(3)                                = 0</span>
<span class="go">openat(AT_FDCWD, &quot;DlMacStats.txt&quot;, O_WRONLY|O_CREAT|O_APPEND, 0666) = 3</span>
<span class="go">lseek(3, 0, SEEK_END)                   = 11100</span>
<span class="go">write(3, &quot;0.635\t1\t1\t64\t6\t1\t20\t1191\t0\t0\t0\n&quot;, 31) = 31</span>
<span class="go">close(3)                                = 0</span>
<span class="go">openat(AT_FDCWD, &quot;UlMacStats.txt&quot;, O_WRONLY|O_CREAT|O_APPEND, 0666) = 3</span>
<span class="go">lseek(3, 0, SEEK_END)                   = 8375</span>
<span class="go">write(3, &quot;0.635\t1\t1\t64\t6\t1\t0\t85\t0\n&quot;, 24) = 24</span>
<span class="go">close(3)                                = 0</span>
<span class="go">openat(AT_FDCWD, &quot;DlRsrpSinrStats.txt&quot;, O_WRONLY|O_CREAT|O_APPEND, 0666) = 3</span>
<span class="go">lseek(3, 0, SEEK_END)                   = 16058</span>
<span class="go">write(3, &quot;0.635214\t1\t1\t1\t6.88272e-15\t22.99&quot;..., 37) = 37</span>
<span class="go">close(3)                                = 0</span>
<span class="go">openat(AT_FDCWD, &quot;UlTxPhyStats.txt&quot;, O_WRONLY|O_CREAT|O_APPEND, 0666) = 3</span>
<span class="go">...</span>
</pre></div>
</div>
<p>With the name of the files, we can look at the code that manipulates them.</p>
<p>The issue above was found in <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/777">MR777</a>, were performance for some LTE examples
regressed for no apparent reason. The flame graph below, produced by <a class="reference external" href="https://www.amd.com/en/developer/uprof.html">AMD uProf</a>,
contains four large columns/”flames” in red, which
correspond to the <code class="docutils literal notranslate"><span class="pre">write</span></code>, <code class="docutils literal notranslate"><span class="pre">openat</span></code>, <code class="docutils literal notranslate"><span class="pre">close</span></code> and <code class="docutils literal notranslate"><span class="pre">lseek</span></code> syscalls.</p>
<img alt="_images/uprof-strace-lte.png" src="_images/uprof-strace-lte.png" />
<p>Upon closer inspection, these syscalls take a long time to complete due to
the underlying filesystem of the machine running the example (NTFS mount
using the ntfs-3g FUSE filesystem). In other words, the bottleneck only
exists when running the example in slow file systems
(e.g. FUSE and network file systems).</p>
<p>The merge request <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/814">MR814</a> addressed the issue by keeping the files open
throughout the simulation. That alone resulted in a 1.75x speedup.</p>
</section>
</section>
<section id="compilation-profilers">
<h4><span class="section-number">4.9.4. </span>Compilation Profilers<a class="headerlink" href="#compilation-profilers" title="Link to this heading">¶</a></h4>
<p>Compilation profilers can help identifying which steps of the compilation
are slowing it down. These profilers are built into the compilers themselves,
only requiring third-party tools to consolidate the results.</p>
<p>The GCC feature is mentioned and exemplified, but is not the recommended
compilation profiling method. For that, Clang is recommended.</p>
<section id="gcc">
<h5><span class="section-number">4.9.4.1. </span>GCC<a class="headerlink" href="#gcc" title="Link to this heading">¶</a></h5>
<p>GCC has a special flag <code class="docutils literal notranslate"><span class="pre">-ftime-report</span></code>, which makes it print a table
with time spent per compilation phase for each compiled file. The printed
output for a file is shown below. The line of <code class="docutils literal notranslate"><span class="pre">---</span></code> was inserted for clarity.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Time variable                      usr           sys          wall               GGC</span>
<span class="go">phase setup            :   0.00 (  0%)   0.00 (  0%)   0.01 (  1%)    1478 kB (  2%)</span>
<span class="go">phase parsing          :   0.31 ( 46%)   0.17 ( 85%)   0.48 ( 55%)   55432 kB ( 71%)</span>
<span class="go">phase lang. deferred   :   0.03 (  4%)   0.00 (  0%)   0.03 (  3%)    4287 kB (  5%)</span>
<span class="go">phase opt and generate :   0.32 ( 48%)   0.03 ( 15%)   0.35 ( 40%)   16635 kB ( 21%)</span>
<span class="go">phase last asm         :   0.01 (  1%)   0.00 (  0%)   0.01 (  1%)     769 kB (  1%)</span>
<span class="go">------------------------------------------------------------------------------------</span>
<span class="go">|name lookup           :   0.05 (  7%)   0.02 ( 10%)   0.04 (  5%)    2468 kB (  3%)</span>
<span class="go">|overload resolution   :   0.05 (  7%)   0.00 (  0%)   0.05 (  6%)    4217 kB (  5%)</span>
<span class="go">dump files             :   0.00 (  0%)   0.00 (  0%)   0.01 (  1%)       0 kB (  0%)</span>
<span class="go">callgraph construction :   0.01 (  1%)   0.00 (  0%)   0.01 (  1%)    2170 kB (  3%)</span>
<span class="go">...</span>
<span class="go">preprocessing          :   0.05 (  7%)   0.06 ( 30%)   0.10 ( 11%)    1751 kB (  2%)</span>
<span class="go">parser (global)        :   0.06 (  9%)   0.03 ( 15%)   0.07 (  8%)   16303 kB ( 21%)</span>
<span class="go">parser struct body     :   0.06 (  9%)   0.04 ( 20%)   0.08 (  9%)   12525 kB ( 16%)</span>
<span class="go">parser enumerator list :   0.01 (  1%)   0.00 (  0%)   0.00 (  0%)     112 kB (  0%)</span>
<span class="go">parser function body   :   0.02 (  3%)   0.02 ( 10%)   0.02 (  2%)    3039 kB (  4%)</span>
<span class="go">parser inl. func. body :   0.03 (  4%)   0.00 (  0%)   0.01 (  1%)    2024 kB (  3%)</span>
<span class="go">parser inl. meth. body :   0.02 (  3%)   0.01 (  5%)   0.06 (  7%)    5792 kB (  7%)</span>
<span class="go">template instantiation :   0.09 ( 13%)   0.01 (  5%)   0.13 ( 15%)   12274 kB ( 16%)</span>
<span class="go">...</span>
<span class="go">symout                 :   0.01 (  1%)   0.00 (  0%)   0.02 (  2%)    8114 kB ( 10%)</span>
<span class="go">...</span>
<span class="go">TOTAL                  :   0.67          0.20          0.88          78612 kB</span>
</pre></div>
</div>
<p>In the table above, the first few lines show the five main compilations steps: <code class="docutils literal notranslate"><span class="pre">setup</span></code>,
<code class="docutils literal notranslate"><span class="pre">parsing</span></code>, <code class="docutils literal notranslate"><span class="pre">lang.</span> <span class="pre">deferred</span></code> (C++ specific transformations),
<code class="docutils literal notranslate"><span class="pre">opt(imize)</span> <span class="pre">and</span> <span class="pre">generate</span> <span class="pre">(code)</span></code>, <code class="docutils literal notranslate"><span class="pre">last</span> <span class="pre">asm</span></code> (produce binary code).</p>
<p>The lines below the <code class="docutils literal notranslate"><span class="pre">---</span></code> line show sub-steps of the five main compilation steps.
For this specific case, parsing global definitions (21%) and structures (16%),
<code class="docutils literal notranslate"><span class="pre">template</span> <span class="pre">instantiation</span></code> (16%) and generating the code in <code class="docutils literal notranslate"><span class="pre">symout</span></code> (10%).</p>
<p>Aggregating the data into a meaningful output to help focus where to improve is not that easy
and it is <a class="reference external" href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=92396">not a priority</a> for GCC developers.</p>
<p>It is recommended to use the Clang alternative.</p>
</section>
<section id="clang">
<span id="id10"></span><h5><span class="section-number">4.9.4.2. </span>Clang<a class="headerlink" href="#clang" title="Link to this heading">¶</a></h5>
<p>Clang can output very similar results with the <code class="docutils literal notranslate"><span class="pre">-ftime-trace</span></code> flag, but can also aggregate
it in a more meaningful way. With the help of the third-party tool <a class="reference external" href="https://github.com/aras-p/ClangBuildAnalyzer">ClangBuildAnalyzer</a>,
we can have really good insights on where to spend time trying to speed up the compilation.</p>
<p>Support for building with <code class="docutils literal notranslate"><span class="pre">-ftime-trace</span></code>, compiling <a class="reference external" href="https://github.com/aras-p/ClangBuildAnalyzer">ClangBuildAnalyzer</a> and producing a
report for the project have been baked into the CMake project of ns-3, and can be enabled
with <code class="docutils literal notranslate"><span class="pre">-DNS3_CLANG_TIMETRACE=ON</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake_cache$ cmake -DNS3_CLANG_TIMETRACE=ON ..</span>
</pre></div>
</div>
<p>Or via <code class="docutils literal notranslate"><span class="pre">ns3</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 configure -- -DNS3_CLANG_TIMETRACE=ON</span>
</pre></div>
</div>
<p>The entire procedure looks like the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ CXX=&quot;clang++&quot; ./ns3 configure -d release --enable-examples --enable-tests -- -DNS3_CLANG_TIMETRACE=ON</span>
<span class="go">~/ns-3-dev$ ./ns3 build timeTraceReport</span>
<span class="go">~/ns-3-dev$ cat ClangBuildAnalyzerReport.txt</span>
<span class="go">Analyzing build trace from &#39;~/ns-3-dev/cmake_cache/clangBuildAnalyzerReport.bin&#39;...</span>
<span class="go">**** Time summary:</span>
<span class="go">Compilation (2993 times):</span>
<span class="go">  Parsing (frontend):         2476.1 s</span>
<span class="go">  Codegen &amp; opts (backend):   1882.9 s</span>

<span class="go">**** Files that took longest to parse (compiler frontend):</span>
<span class="go">  8966 ms: src/test/CMakeFiles/libtest.dir/traced/traced-callback-typedef-test-suite.cc.o</span>
<span class="go">  6633 ms: src/wifi/examples/CMakeFiles/wifi-bianchi.dir/wifi-bianchi.cc.o</span>
<span class="go">...</span>

<span class="go">**** Files that took longest to codegen (compiler backend):</span>
<span class="go">36430 ms: src/wifi/CMakeFiles/libwifi-test.dir/test/block-ack-test-suite.cc.o</span>
<span class="go">24941 ms: src/wifi/CMakeFiles/libwifi-test.dir/test/wifi-mac-ofdma-test.cc.o</span>
<span class="go">...</span>

<span class="go">**** Templates that took longest to instantiate:</span>
<span class="go">12651 ms: std::unordered_map&lt;int, int&gt; (615 times, avg 20 ms)</span>
<span class="go">10950 ms: std::_Hashtable&lt;int, std::pair&lt;const int, int&gt;, std::allocator&lt;std::... (615 times, avg 17 ms)</span>
<span class="go">10712 ms: std::__detail::__hyperg&lt;long double&gt; (1172 times, avg 9 ms)</span>
<span class="go">...</span>

<span class="go">**** Template sets that took longest to instantiate:</span>
<span class="go">111660 ms: std::list&lt;$&gt; (27141 times, avg 4 ms)</span>
<span class="go"> 79892 ms: std::_List_base&lt;$&gt; (27140 times, avg 2 ms)</span>
<span class="go"> 75131 ms: std::map&lt;$&gt; (11752 times, avg 6 ms)</span>
<span class="go"> 65214 ms: std::allocator&lt;$&gt; (66622 times, avg 0 ms)</span>
<span class="go">...</span>

<span class="go">**** Functions that took longest to compile:</span>
<span class="go">  7206 ms: OfdmaAckSequenceTest::CheckResults(ns3::Time, ns3::Time, unsigned ch... (~/ns-3-dev/src/wifi/test/wifi-mac-ofdma-test.cc)</span>
<span class="go">  6146 ms: PieQueueDiscTestCase::RunPieTest(ns3::QueueSizeUnit) (~/ns-3-dev/src/traffic-control/test/pie-queue-disc-test-suite.cc)</span>
<span class="go">...</span>

<span class="go">**** Function sets that took longest to compile / optimize:</span>
<span class="go">14801 ms: std::__cxx11::basic_string&lt;$&gt; ns3::CallbackImplBase::GetCppTypeid&lt;$&gt;() (2342 times, avg 6 ms)</span>
<span class="go">12013 ms: ns3::CallbackImpl&lt;$&gt;::DoGetTypeid[abi:cxx11]() (1283 times, avg 9 ms)</span>
<span class="go">10034 ms: ns3::Ptr&lt;$&gt;::~Ptr() (5975 times, avg 1 ms)</span>
<span class="go"> 8932 ms: ns3::Callback&lt;$&gt;::DoAssign(ns3::Ptr&lt;$&gt;) (591 times, avg 15 ms)</span>
<span class="go"> 6318 ms: ns3::CallbackImpl&lt;$&gt;::DoGetTypeid() (431 times, avg 14 ms)</span>
<span class="go">...</span>

<span class="go">*** Expensive headers:</span>
<span class="go">293609 ms: ~/ns-3-dev/build/include/ns3/log.h (included 1404 times, avg 209 ms), included via:</span>
<span class="go">  cqa-ff-mac-scheduler.cc.o  (758 ms)</span>
<span class="go">  ipv6-list-routing.cc.o  (746 ms)</span>
<span class="go">  ...</span>

<span class="go">239884 ms: ~/ns-3-dev/build/include/ns3/nstime.h (included 1093 times, avg 219 ms), included via:</span>
<span class="go">  lte-enb-rrc.cc.o lte-enb-rrc.h  (891 ms)</span>
<span class="go">  wifi-acknowledgment.cc.o wifi-acknowledgment.h  (877 ms)</span>
<span class="go">  ...</span>

<span class="go">216218 ms: ~/ns-3-dev/build/include/ns3/object.h (included 1205 times, avg 179 ms), included via:</span>
<span class="go">  energy-source-container.cc.o energy-source-container.h energy-source.h  (1192 ms)</span>
<span class="go">  phased-array-model.cc.o phased-array-model.h  (1135 ms)</span>
<span class="go">  ...</span>

<span class="go">206801 ms: ~/ns-3-dev/build/include/ns3/core-module.h (included 195 times, avg 1060 ms), included via:</span>
<span class="go">  sample-show-progress.cc.o  (1973 ms)</span>
<span class="go">  length-example.cc.o  (1848 ms)</span>
<span class="go">  ...</span>

<span class="go">193116 ms: /usr/bin/../lib/gcc/x86_64-linux-gnu/11/../../../../include/c++/11/bits/basic_string.h (included 1499 times, avg 128 ms), included via:</span>
<span class="go">  model-typeid-creator.h attribute-default-iterator.h type-id.h attribute.h string  (250 ms)</span>
<span class="go">  li-ion-energy-source-helper.h energy-model-helper.h attribute.h string  (243 ms)</span>
<span class="go">  ...</span>

<span class="go">185075 ms: /usr/bin/../lib/gcc/x86_64-linux-gnu/11/../../../../include/c++/11/bits/ios_base.h (included 1495 times, avg 123 ms), included via:</span>
<span class="go">  iomanip  (403 ms)</span>
<span class="go">  mpi-test-fixtures.h iomanip  (364 ms)</span>
<span class="go">  ...</span>

<span class="go">169464 ms: ~/ns-3-dev/build/include/ns3/ptr.h (included 1399 times, avg 121 ms), included via:</span>
<span class="go">  lte-test-rlc-um-e2e.cc.o config.h  (568 ms)</span>
<span class="go">  lte-test-rlc-um-transmitter.cc.o simulator.h event-id.h  (560 ms)</span>
<span class="go">  ...</span>


<span class="go">  done in 2.8s.</span>
</pre></div>
</div>
<p>The output printed out contain a summary of time spent on parsing and on code generation, along
with multiple lists for different tracked categories. From the summary, it is clear that parsing times
are very high when compared to the optimization time (<code class="docutils literal notranslate"><span class="pre">-O3</span></code>). Skipping the others categories and going straight
to the expensive headers section, we can better understand why parsing times are so high, with some headers
adding as much as 5 minutes of CPU time to the parsing time.</p>
<p>Precompiled headers (<code class="docutils literal notranslate"><span class="pre">-DNS3_PRECOMPILE_HEADERS=ON</span></code>) can <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/731#note_687176503">drastically speed up parsing times</a>,
however, they can increase ccache misses, reducing the time of the first
compilation at the cost of increasing recompilation times.</p>
</section>
<section id="id11">
<h5><span class="section-number">4.9.4.3. </span>NinjaTracing<a class="headerlink" href="#id11" title="Link to this heading">¶</a></h5>
<p>If the Ninja generator is being used (<code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">configure</span> <span class="pre">-G</span> <span class="pre">Ninja</span></code>), its build log
can be used to identify targets slowing down the build process. The <a class="reference external" href="https://github.com/nico/ninjatracing">NinjaTracing</a>
utility is used to convert the log format into a tracing Json file.</p>
<p>The following steps show how it can be used:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 configure --enable-ninja-tracing</span>
<span class="go">~/ns-3-dev$ ./ns3 build</span>
<span class="go">~/ns-3-dev$ ./ns3 build ninjaTrace</span>
</pre></div>
</div>
<p>The output <code class="docutils literal notranslate"><span class="pre">ninja_performance_trace.json</span></code> should be located in the <code class="docutils literal notranslate"><span class="pre">~/ns-3-dev</span></code> directory.
You can then visualize the results using the <code class="docutils literal notranslate"><span class="pre">about:tracing</span></code> panel available in
Chromium-based browser or with a compatible trace viewer such as <a class="reference external" href="https://ui.perfetto.dev/">Perfetto UI</a>.</p>
<p>It can also be used in conjunction with the <a class="reference internal" href="#clang">Clang</a> time-trace feature for more granular
information from within the compiler and linker.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ CXX=clang++ ./ns3 configure --enable-ninja-tracing -- -DNS3_CLANG_TIMETRACE=ON</span>
<span class="go">~/ns-3-dev$ ./ns3 build</span>
<span class="go">~/ns-3-dev$ ./ns3 build ninjaTrace</span>
</pre></div>
</div>
</section>
</section>
<section id="cmake-profiler">
<h4><span class="section-number">4.9.5. </span>CMake Profiler<a class="headerlink" href="#cmake-profiler" title="Link to this heading">¶</a></h4>
<p>CMake has a built-in tracer that permits tracking hotspots in the CMake files slowing down the
project configuration. To use the tracer, call cmake directly from a clean CMake cache directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev/cmake-cache$ cmake .. --profiling-format=google-trace --profiling-output=../cmake_performance_trace.log</span>
</pre></div>
</div>
<p>Or using the ns3 wrapper:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ ./ns3 configure --trace-performance</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">cmake_performance_trace.log</span></code> file will be generated in the ns-3-dev directory.
The tracing results can be visualized using the <code class="docutils literal notranslate"><span class="pre">about:tracing</span></code> panel available
in Chromium-based browsers or a compatible trace viewer such as <a class="reference external" href="https://ui.perfetto.dev/">Perfetto UI</a>.</p>
<p>After opening the trace file, select the traced process and click on
any of the blocks to inspect the different stacks and find hotspots.
An auxiliary panel containing the function/macro name, arguments
and location can be shown, providing enough information to trace
back the location of each specific call.</p>
<p>Just like in performance profilers, visual inspection makes it easier
to identify hotspots and focus on trying to optimize what matters most.</p>
<p>The trace below was generated during the discussion of <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/issues/588">issue #588</a>,
while investigating the long configuration times, especially when using HDDs.</p>
<p>The single largest contributor was CMake’s <code class="docutils literal notranslate"><span class="pre">configure_file</span></code>, used to keeping
up-to-date copies of headers in the output directory.</p>
<img alt="_images/perfetto-trace-cmake.png" src="_images/perfetto-trace-cmake.png" />
<p>In <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/merge_requests/911">MR911</a>, alternatives such as stub headers that include the original header
files, keeping them in their respective modules, and symlinking headers to the
output directory were used to reduce the configuration overhead.</p>
<p>Note: when testing I/O bottlenecks, you may want to drop filesystem caches,
otherwise the cache may hide the issues. In Linux, the caches can be cleared
using the following command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ sudo sysctl vm.drop_caches=3</span>
</pre></div>
</div>
</section>
</section>
<span id="document-working-with-gitlab-ci-local"></span><section id="working-with-gitlab-ci-local">
<h3><span class="section-number">4.10. </span>Working with gitlab-ci-local<a class="headerlink" href="#working-with-gitlab-ci-local" title="Link to this heading">¶</a></h3>
<p>The ns-3 project repository is currently hosted in GitLab, which includes
<a class="reference external" href="https://docs.gitlab.com/ee/ci/">continuous integration (CI)</a> tools to automate build, tests, packaging and
distribution of software. The CI works based on jobs, that are defined
on YAML files.</p>
<p>The ns-3 GitLab CI files are located in <code class="docutils literal notranslate"><span class="pre">ns-3-dev/utils/tests/</span></code>.
The main GitLab CI file is <code class="docutils literal notranslate"><span class="pre">gitlab-ci.yml</span></code>. The different jobs
are used to check if a multitude of compilers and package versions
are compatible with the current ns-3 build, which is why a build is
usually followed by a test run. Other CI jobs build and warn about
missing the documentation.</p>
<p>The GitLab CI jobs are executed based on <a class="reference external" href="https://docs.gitlab.com/ee/ci/introduction/index.html#continuous-integration">pipelines</a> containing a
sequence of job batches. Jobs within a batch can be executed in parallel.
These <a class="reference external" href="https://docs.gitlab.com/ee/ci/introduction/index.html#continuous-integration">pipelines</a> can be triggered manually, or scheduled to run automatically
per commit and/or based on a time period
(ns-3 has <a class="reference external" href="https://gitlab.com/nsnam/ns-3-dev/-/pipeline_schedules">daily and weekly pipelines</a> scheduled).</p>
<p>The GitLab CI free tier is very slow, taking a lot of time to identify
issues during active merge request development.</p>
<p>Note: the free tier
now requires a credit card due to <a class="reference external" href="https://about.gitlab.com/blog/2021/05/17/prevent-crypto-mining-abuse/">crypto miners abuse</a>.</p>
<p><a class="reference external" href="https://github.com/firecow/gitlab-ci-local">GitLab-CI-local</a> is a tool that allows an user to use the <a class="reference external" href="https://docs.gitlab.com/ee/ci/">GitLab CI</a>
configuration files locally, allowing for the debugging of CI settings
and pipelines without requiring pushes to test repositories or main
repositories that fill up the CI job queues with failed jobs due to
script errors.</p>
<p>GitLab-CI-local relies on <a class="reference external" href="https://docs.docker.com/desktop/">Docker</a> to setup the environment to execute
the jobs.</p>
<p>Note: Docker is usually setup in root mode, requiring
frequent use of administrative permissions/sudo. However,
this is highly discouraged. You can configure Docker to run
in <a class="reference external" href="https://docs.docker.com/engine/security/rootless/">rootless mode</a>. From this point onwards, we assume Docker is configured
in <a class="reference external" href="https://docs.docker.com/engine/security/rootless/">rootless mode</a>.</p>
<p>After installing both <a class="reference external" href="https://docs.docker.com/desktop/">Docker</a> in <a class="reference external" href="https://docs.docker.com/engine/security/rootless/">rootless mode</a> and <a class="reference external" href="https://github.com/firecow/gitlab-ci-local">GitLab-CI-local</a>,
the ns-3 jobs can be listed using the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/ns-3-dev$<span class="w"> </span>gitlab-ci-local<span class="w"> </span>--file<span class="w"> </span>./utils/tests/gitlab-ci.yml<span class="w"> </span>--list
parsing<span class="w"> </span>and<span class="w"> </span>downloads<span class="w"> </span>finished<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">226</span><span class="w"> </span>ms
name<span class="w">                                   </span>description<span class="w">  </span>stage<span class="w">          </span>when<span class="w">        </span>allow_failure<span class="w">  </span>needs
weekly-build-ubuntu-18.04-debug<span class="w">                     </span>build<span class="w">          </span>on_success<span class="w">  </span><span class="nb">false</span>

...

weekly-build-clang-11-optimized<span class="w">                     </span>build<span class="w">          </span>on_success<span class="w">  </span><span class="nb">false</span>
cppyy-22.04<span class="w">                                         </span>build<span class="w">          </span>on_success<span class="w">  </span><span class="nb">false</span>
per-commit-compile-debug<span class="w">                            </span>build<span class="w">          </span>on_success<span class="w">  </span><span class="nb">false</span>
per-commit-compile-release<span class="w">                          </span>build<span class="w">          </span>on_success<span class="w">  </span><span class="nb">false</span>
per-commit-compile-optimized<span class="w">                        </span>build<span class="w">          </span>on_success<span class="w">  </span><span class="nb">false</span>
daily-test-debug<span class="w">                                    </span><span class="nb">test</span><span class="w">           </span>on_success<span class="w">  </span><span class="nb">false</span>
daily-test-release<span class="w">                                  </span><span class="nb">test</span><span class="w">           </span>on_success<span class="w">  </span><span class="nb">false</span>
daily-test-optimized<span class="w">                                </span><span class="nb">test</span><span class="w">           </span>on_success<span class="w">  </span><span class="nb">false</span>
daily-test-optimized-valgrind<span class="w">                       </span><span class="nb">test</span><span class="w">           </span>on_success<span class="w">  </span><span class="nb">false</span>
weekly-test-debug-valgrind<span class="w">                          </span><span class="nb">test</span><span class="w">           </span>on_success<span class="w">  </span><span class="nb">false</span>
weekly-test-release-valgrind<span class="w">                        </span><span class="nb">test</span><span class="w">           </span>on_success<span class="w">  </span><span class="nb">false</span>
weekly-test-optimized-valgrind<span class="w">                      </span><span class="nb">test</span><span class="w">           </span>on_success<span class="w">  </span><span class="nb">false</span>
weekly-test-takes-forever-optimized<span class="w">                 </span><span class="nb">test</span><span class="w">           </span>on_success<span class="w">  </span><span class="nb">false</span>
doxygen<span class="w">                                             </span>documentation<span class="w">  </span>on_success<span class="w">  </span><span class="nb">false</span>
manual<span class="w">                                              </span>documentation<span class="w">  </span>on_success<span class="w">  </span><span class="nb">false</span>
tutorial<span class="w">                                            </span>documentation<span class="w">  </span>on_success<span class="w">  </span><span class="nb">false</span>
models<span class="w">                                              </span>documentation<span class="w">  </span>on_success<span class="w">  </span><span class="nb">false</span>
</pre></div>
</div>
<p>To execute the <code class="docutils literal notranslate"><span class="pre">per-commit-compile-release</span></code> job, or any of the others listed above, use
the following command.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ gitlab-ci-local --file ./utils/tests/gitlab-ci.yml per-commit-compile-release</span>
</pre></div>
</div>
<p>WARNING: if you do not specify the job name, all jobs that can be executed in parallel will be
executed at the same time. You may run out of disk, memory or both.</p>
<p>Some jobs might require a previous job to complete successfully before getting started.
The doxygen job is one of these.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ gitlab-ci-local --file ./utils/tests/gitlab-ci.yml doxygen</span>
<span class="go">Using fallback git user.name</span>
<span class="go">Using fallback git user.email</span>
<span class="go">parsing and downloads finished in 202 ms</span>
<span class="go">doxygen                               starting archlinux:latest (documentation)</span>
<span class="go">doxygen                               pulled archlinux:latest in 64 ms</span>
<span class="go">doxygen                               &gt; still running...</span>
<span class="go">doxygen                               &gt; still running...</span>
<span class="go">doxygen                               copied to container in 20 s</span>
<span class="go">doxygen                               imported cache &#39;ccache-&#39; in 3.67 s</span>
<span class="go">~/ns-3-dev/.gitlab-ci-local/artifacts/pybindgen doesn&#39;t exist, did you forget --needs</span>
</pre></div>
</div>
<p>As instructed by the previous command output, you can add the <code class="docutils literal notranslate"><span class="pre">--needs</span></code> to build required
jobs before proceeding. However, doing so will run all jobs as the <code class="docutils literal notranslate"><span class="pre">doxygen</span></code> is only supposed
to run after weekly jobs are successfully executed.</p>
<p>Another option is to run the specific job that produces the required artifact. In this case
the <code class="docutils literal notranslate"><span class="pre">pybindgen</span></code> job.</p>
<p>Note: Pybindgen has been replaced by Cppyy, which does not produce artifacts to be consumed
by other jobs. However, the example is kept for reference.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">~/ns-3-dev$ gitlab-ci-local --file ./utils/tests/gitlab-ci.yml pybindgen</span>
<span class="go">Using fallback git user.name</span>
<span class="go">Using fallback git user.email</span>
<span class="go">parsing and downloads finished in 202 ms</span>
<span class="go">pybindgen                               starting archlinux:latest (build)</span>

<span class="go">...</span>

<span class="go">pybindgen                             $ git diff src &gt; pybindgen_new.patch</span>
<span class="go">pybindgen                             exported artifacts in 911 ms</span>
<span class="go">pybindgen                             copied artifacts to cwd in 56 ms</span>
<span class="go">pybindgen                             finished in 5.77 min</span>

<span class="go"> PASS  pybindgen</span>
</pre></div>
</div>
<p>Then run the doxygen job again:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/ns-3-dev$<span class="w"> </span>gitlab-ci-local<span class="w"> </span>--file<span class="w"> </span>./utils/tests/gitlab-ci.yml<span class="w"> </span>doxygen
Using<span class="w"> </span>fallback<span class="w"> </span>git<span class="w"> </span>user.name
Using<span class="w"> </span>fallback<span class="w"> </span>git<span class="w"> </span>user.email
parsing<span class="w"> </span>and<span class="w"> </span>downloads<span class="w"> </span>finished<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">170</span><span class="w"> </span>ms
doxygen<span class="w">                               </span>starting<span class="w"> </span>archlinux:latest<span class="w"> </span><span class="o">(</span>documentation<span class="o">)</span>

...

doxygen<span class="w">                               </span>&gt;<span class="w">      </span><span class="m">1</span><span class="w"> </span>files<span class="w"> </span>with<span class="w"> </span>warnings
doxygen<span class="w">                               </span>&gt;<span class="w"> </span>Doxygen<span class="w"> </span>Warnings<span class="w"> </span>Summary
doxygen<span class="w">                               </span>&gt;<span class="w"> </span>----------------------------------------
doxygen<span class="w">                               </span>&gt;<span class="w">      </span><span class="m">1</span><span class="w"> </span>directories
doxygen<span class="w">                               </span>&gt;<span class="w">      </span><span class="m">1</span><span class="w"> </span>files
doxygen<span class="w">                               </span>&gt;<span class="w">     </span><span class="m">23</span><span class="w"> </span>warnings
doxygen<span class="w">                               </span>&gt;<span class="w"> </span><span class="k">done</span>.
doxygen<span class="w">                               </span>exported<span class="w"> </span>cache<span class="w"> </span>ns-3-ccache-storage/<span class="w"> </span><span class="s1">&#39;ccache-&#39;</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">6</span>.86<span class="w"> </span>s
doxygen<span class="w">                               </span>exported<span class="w"> </span>artifacts<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">954</span><span class="w"> </span>ms
doxygen<span class="w">                               </span>copied<span class="w"> </span>artifacts<span class="w"> </span>to<span class="w"> </span>cwd<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">59</span><span class="w"> </span>ms
doxygen<span class="w">                               </span>finished<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">15</span><span class="w"> </span>min

<span class="w"> </span>PASS<span class="w">  </span>doxygen
</pre></div>
</div>
<p>Artifacts built by the CI jobs will be stored in separate subfolders
based on the job name.</p>
<p><code class="docutils literal notranslate"><span class="pre">~/ns-3-dev/.gitlab-ci-local/artifacts/jobname</span></code></p>
</section>
</div>
</section>
<span id="document-utilities"></span><section id="utilities">
<span id="id1"></span><h2><span class="section-number">5. </span>Utilities<a class="headerlink" href="#utilities" title="Link to this heading">¶</a></h2>
<section id="print-introspected-doxygen">
<h3><span class="section-number">5.1. </span>Print-introspected-doxygen<a class="headerlink" href="#print-introspected-doxygen" title="Link to this heading">¶</a></h3>
<p><cite>print-introspected-doxygen</cite> is used to generate doxygen documentation
using various TypeIds defined throughout the <em>ns-3</em> source code.
The tool returns the various config paths, attributes, trace sources,
etc. for the various files in <em>ns-3</em>.</p>
<section id="invocation">
<h4><span class="section-number">5.1.1. </span>Invocation<a class="headerlink" href="#invocation" title="Link to this heading">¶</a></h4>
<p>This tool is run automatically by the build system when generating
the Doxygen API docs, so you don’t normally have to run it by hand.</p>
<p>However, since it does give a fair bit of information about TypeIds
it can be useful to run from the command line and
search for specific information.</p>
<p>To run it, simply open terminal and type</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>print-introspected-doxygen
</pre></div>
</div>
<p>This will give all the output, formatted for Doxygen, which can be viewed
in a text editor.</p>
<p>One way to use this is to capture it to a file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>print-introspected-doxygen<span class="w"> </span>&gt;<span class="w"> </span>doc.html
</pre></div>
</div>
<p>Some users might prefer to use tools like grep
to locate the required piece of information from the documentation
instead of using an editor. For such uses-cases and more,
<cite>print-introspected-doxygen</cite> can return plain text:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span><span class="s2">&quot;print-introspected-doxygen --output-text&quot;</span>
</pre></div>
</div>
<p>(Note the quotes around the inner command and options.)</p>
<blockquote>
<div><p>$ ./ns3 run “print-introspected-doxygen –output-text” | grep “hello”</p>
</div></blockquote>
<p>This will output the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>*<span class="w"> </span>HelloInterval:<span class="w"> </span>HELLO<span class="w"> </span>messages<span class="w"> </span>emission<span class="w"> </span>interval.
*<span class="w"> </span>DeletePeriod:<span class="w"> </span>DeletePeriod<span class="w"> </span>is<span class="w"> </span>intended<span class="w"> </span>to<span class="w"> </span>provide<span class="w"> </span>an<span class="w"> </span>upper<span class="w"> </span>bound<span class="w"> </span>on<span class="w"> </span>the<span class="w"> </span><span class="nb">time</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>which<span class="w"> </span>an<span class="w"> </span>upstream<span class="w"> </span>node<span class="w"> </span>A<span class="w"> </span>can<span class="w"> </span>have<span class="w"> </span>a<span class="w"> </span>neighbor<span class="w"> </span>B<span class="w"> </span>as<span class="w"> </span>an<span class="w"> </span>active<span class="w"> </span>next<span class="w"> </span>hop<span class="w"> </span><span class="k">for</span><span class="w"> </span>destination<span class="w"> </span>D,<span class="w"> </span><span class="k">while</span><span class="w"> </span>B<span class="w"> </span>has<span class="w"> </span>invalidated<span class="w"> </span>the<span class="w"> </span>route<span class="w"> </span>to<span class="w"> </span>D.<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="w"> </span>*<span class="w"> </span>max<span class="w"> </span><span class="o">(</span>HelloInterval,<span class="w"> </span>ActiveRouteTimeout<span class="o">)</span>
*<span class="w"> </span>AllowedHelloLoss:<span class="w"> </span>Number<span class="w"> </span>of<span class="w"> </span>hello<span class="w"> </span>messages<span class="w"> </span>which<span class="w"> </span>may<span class="w"> </span>be<span class="w"> </span>loss<span class="w"> </span><span class="k">for</span><span class="w"> </span>valid<span class="w"> </span>link.
*<span class="w"> </span>EnableHello:<span class="w"> </span>Indicates<span class="w"> </span>whether<span class="w"> </span>a<span class="w"> </span>hello<span class="w"> </span>messages<span class="w"> </span>enable.
*<span class="w"> </span>HelloInterval:<span class="w"> </span>HELLO<span class="w"> </span>messages<span class="w"> </span>emission<span class="w"> </span>interval.
*<span class="w"> </span>HelloInterval:<span class="w"> </span>HELLO<span class="w"> </span>messages<span class="w"> </span>emission<span class="w"> </span>interval.
*<span class="w"> </span>DeletePeriod:<span class="w"> </span>DeletePeriod<span class="w"> </span>is<span class="w"> </span>intended<span class="w"> </span>to<span class="w"> </span>provide<span class="w"> </span>an<span class="w"> </span>upper<span class="w"> </span>bound<span class="w"> </span>on<span class="w"> </span>the<span class="w"> </span><span class="nb">time</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>which<span class="w"> </span>an<span class="w"> </span>upstream<span class="w"> </span>node<span class="w"> </span>A<span class="w"> </span>can<span class="w"> </span>have<span class="w"> </span>a<span class="w"> </span>neighbor<span class="w"> </span>B<span class="w"> </span>as<span class="w"> </span>an<span class="w"> </span>active<span class="w"> </span>next<span class="w"> </span>hop<span class="w"> </span><span class="k">for</span><span class="w"> </span>destination<span class="w"> </span>D,<span class="w"> </span><span class="k">while</span><span class="w"> </span>B<span class="w"> </span>has<span class="w"> </span>invalidated<span class="w"> </span>the<span class="w"> </span>route<span class="w"> </span>to<span class="w"> </span>D.<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="w"> </span>*<span class="w"> </span>max<span class="w"> </span><span class="o">(</span>HelloInterval,<span class="w"> </span>ActiveRouteTimeout<span class="o">)</span>
*<span class="w"> </span>AllowedHelloLoss:<span class="w"> </span>Number<span class="w"> </span>of<span class="w"> </span>hello<span class="w"> </span>messages<span class="w"> </span>which<span class="w"> </span>may<span class="w"> </span>be<span class="w"> </span>loss<span class="w"> </span><span class="k">for</span><span class="w"> </span>valid<span class="w"> </span>link.
*<span class="w"> </span>EnableHello:<span class="w"> </span>Indicates<span class="w"> </span>whether<span class="w"> </span>a<span class="w"> </span>hello<span class="w"> </span>messages<span class="w"> </span>enable.
*<span class="w"> </span>HelloInterval:<span class="w"> </span>HELLO<span class="w"> </span>messages<span class="w"> </span>emission<span class="w"> </span>interval.
</pre></div>
</div>
</section>
</section>
<section id="bench-scheduler">
<h3><span class="section-number">5.2. </span>bench-scheduler<a class="headerlink" href="#bench-scheduler" title="Link to this heading">¶</a></h3>
<p>This tool is used to benchmark the scheduler algorithms used in <em>ns-3</em>.</p>
<section id="command-line-arguments">
<h4><span class="section-number">5.2.1. </span>Command-line Arguments<a class="headerlink" href="#command-line-arguments" title="Link to this heading">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span><span class="s2">&quot;bench-scheduler --help&quot;</span>
bench-scheduler<span class="w"> </span><span class="o">[</span>Program<span class="w"> </span>Options<span class="o">]</span><span class="w"> </span><span class="o">[</span>General<span class="w"> </span>Arguments<span class="o">]</span>

Benchmark<span class="w"> </span>the<span class="w"> </span>simulator<span class="w"> </span>scheduler.

Event<span class="w"> </span>intervals<span class="w"> </span>are<span class="w"> </span>taken<span class="w"> </span>from<span class="w"> </span>one<span class="w"> </span>of:
<span class="w">  </span>an<span class="w"> </span>exponential<span class="w"> </span>distribution,<span class="w"> </span>with<span class="w"> </span>mean<span class="w"> </span><span class="m">100</span><span class="w"> </span>ns,
<span class="w">  </span>an<span class="w"> </span>ascii<span class="w"> </span>file,<span class="w"> </span>given<span class="w"> </span>by<span class="w"> </span>the<span class="w"> </span>--file<span class="o">=</span><span class="s2">&quot;&lt;filename&gt;&quot;</span><span class="w"> </span>argument,
<span class="w">  </span>or<span class="w"> </span>standard<span class="w"> </span>input,<span class="w"> </span>by<span class="w"> </span>the<span class="w"> </span>argument<span class="w"> </span>--file<span class="o">=</span><span class="s2">&quot;-&quot;</span>
In<span class="w"> </span>the<span class="w"> </span><span class="k">case</span><span class="w"> </span>of<span class="w"> </span>either<span class="w"> </span>--file<span class="w"> </span>form,<span class="w"> </span>the<span class="w"> </span>input<span class="w"> </span>is<span class="w"> </span>expected
to<span class="w"> </span>be<span class="w"> </span>ascii,<span class="w"> </span>giving<span class="w"> </span>the<span class="w"> </span>relative<span class="w"> </span>event<span class="w"> </span><span class="nb">times</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>ns.

Program<span class="w"> </span>Options:
--all:<span class="w">     </span>use<span class="w"> </span>all<span class="w"> </span>schedulers<span class="w"> </span><span class="o">[</span>false<span class="o">]</span>
--cal:<span class="w">     </span>use<span class="w"> </span>CalendarSheduler<span class="w"> </span><span class="o">[</span>false<span class="o">]</span>
--calrev:<span class="w">  </span>reverse<span class="w"> </span>ordering<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>CalendarScheduler<span class="w"> </span><span class="o">[</span>false<span class="o">]</span>
--heap:<span class="w">    </span>use<span class="w"> </span>HeapScheduler<span class="w"> </span><span class="o">[</span>false<span class="o">]</span>
--list:<span class="w">    </span>use<span class="w"> </span>ListSheduler<span class="w"> </span><span class="o">[</span>false<span class="o">]</span>
--map:<span class="w">     </span>use<span class="w"> </span>MapScheduler<span class="w"> </span><span class="o">(</span>default<span class="o">)</span><span class="w"> </span><span class="o">[</span>true<span class="o">]</span>
--pri:<span class="w">     </span>use<span class="w"> </span>PriorityQueue<span class="w"> </span><span class="o">[</span>false<span class="o">]</span>
--debug:<span class="w">   </span><span class="nb">enable</span><span class="w"> </span>debugging<span class="w"> </span>output<span class="w"> </span><span class="o">[</span>false<span class="o">]</span>
--pop:<span class="w">     </span>event<span class="w"> </span>population<span class="w"> </span>size<span class="w"> </span><span class="o">(</span>default<span class="w"> </span>1E5<span class="o">)</span><span class="w"> </span><span class="o">[</span><span class="m">100000</span><span class="o">]</span>
--total:<span class="w">   </span>total<span class="w"> </span>number<span class="w"> </span>of<span class="w"> </span>events<span class="w"> </span>to<span class="w"> </span>run<span class="w"> </span><span class="o">(</span>default<span class="w"> </span>1E6<span class="o">)</span><span class="w"> </span><span class="o">[</span><span class="m">1000000</span><span class="o">]</span>
--runs:<span class="w">    </span>number<span class="w"> </span>of<span class="w"> </span>runs<span class="w"> </span><span class="o">(</span>default<span class="w"> </span><span class="m">1</span><span class="o">)</span><span class="w"> </span><span class="o">[</span><span class="m">1</span><span class="o">]</span>
--file:<span class="w">    </span>file<span class="w"> </span>of<span class="w"> </span>relative<span class="w"> </span>event<span class="w"> </span><span class="nb">times</span>
--prec:<span class="w">    </span>printed<span class="w"> </span>output<span class="w"> </span>precision<span class="w"> </span><span class="o">[</span><span class="m">6</span><span class="o">]</span>

General<span class="w"> </span>Arguments:
...
</pre></div>
</div>
<p>You can change the Scheduler being benchmarked by passing
the appropriate flags, for example if you want to
benchmark the CalendarScheduler pass <cite>–cal</cite> to the program.</p>
<p>The default total number of events, runs or population size
can be overridden by passing <cite>–total=value</cite>, <cite>–runs=value</cite>
and <cite>–pop=value</cite> respectively.</p>
<p>If you want to use an event distribution which is stored in a file,
you can pass the file option by <cite>–file=FILE_NAME</cite>.</p>
<p><cite>–prec</cite> can be used to change the output precision value and
<cite>–debug</cite> as the name suggests enables debugging.</p>
</section>
<section id="id2">
<h4><span class="section-number">5.2.2. </span>Invocation<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h4>
<p>To run it, simply open the terminal and type</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>bench-scheduler<span class="w"> </span>--<span class="w"> </span>--runs<span class="o">=</span><span class="m">5</span>
</pre></div>
</div>
<p>It will show something like this depending upon the scheduler being benchmarked:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bench-scheduler:<span class="w">  </span>Benchmark<span class="w"> </span>the<span class="w"> </span>simulator<span class="w"> </span>scheduler
<span class="w">  </span>Event<span class="w"> </span>population<span class="w"> </span>size:<span class="w">        </span><span class="m">100000</span>
<span class="w">  </span>Total<span class="w"> </span>events<span class="w"> </span>per<span class="w"> </span>run:<span class="w">         </span><span class="m">1000000</span>
<span class="w">  </span>Number<span class="w"> </span>of<span class="w"> </span>runs<span class="w"> </span>per<span class="w"> </span>scheduler:<span class="w"> </span><span class="m">5</span>
<span class="w">  </span>Event<span class="w"> </span><span class="nb">time</span><span class="w"> </span>distribution:<span class="w">      </span>default<span class="w"> </span>exponential

ns3::MapScheduler<span class="w"> </span><span class="o">(</span>default<span class="o">)</span>
Run<span class="w"> </span><span class="c1">#       Initialization:                     Simulation:</span>
Time<span class="w"> </span><span class="o">(</span>s<span class="o">)</span><span class="w">    </span>Rate<span class="w"> </span><span class="o">(</span>ev/s<span class="o">)</span><span class="w"> </span>Per<span class="w"> </span><span class="o">(</span>s/ev<span class="o">)</span><span class="w">  </span>Time<span class="w"> </span><span class="o">(</span>s<span class="o">)</span><span class="w">    </span>Rate<span class="w"> </span><span class="o">(</span>ev/s<span class="o">)</span><span class="w"> </span>Per<span class="w"> </span><span class="o">(</span>s/ev<span class="o">)</span>
-----------<span class="w"> </span>-----------<span class="w"> </span>-----------<span class="w"> </span>-----------<span class="w"> </span>-----------<span class="w"> </span>-----------<span class="w"> </span>-----------
prime<span class="w">       </span><span class="m">0</span>.01<span class="w">        </span>1e+06<span class="w">       </span>1e-06<span class="w">       </span><span class="m">5</span>.51<span class="w">        </span><span class="m">1</span>.81488e+06<span class="w"> </span><span class="m">5</span>.51e-07
<span class="m">0</span><span class="w">           </span><span class="m">0</span><span class="w">           </span>inf<span class="w">         </span><span class="m">0</span><span class="w">           </span><span class="m">6</span>.25<span class="w">        </span><span class="m">1</span>.6e+06<span class="w">     </span><span class="m">6</span>.25e-07
<span class="m">1</span><span class="w">           </span><span class="m">0</span><span class="w">           </span>inf<span class="w">         </span><span class="m">0</span><span class="w">           </span><span class="m">6</span>.52<span class="w">        </span><span class="m">1</span>.53374e+06<span class="w"> </span><span class="m">6</span>.52e-07
<span class="m">2</span><span class="w">           </span><span class="m">0</span>.01<span class="w">        </span>1e+06<span class="w">       </span>1e-06<span class="w">       </span><span class="m">7</span>.28<span class="w">        </span><span class="m">1</span>.37363e+06<span class="w"> </span><span class="m">7</span>.28e-07
<span class="m">3</span><span class="w">           </span><span class="m">0</span><span class="w">           </span>inf<span class="w">         </span><span class="m">0</span><span class="w">           </span><span class="m">7</span>.72<span class="w">        </span><span class="m">1</span>.29534e+06<span class="w"> </span><span class="m">7</span>.72e-07
<span class="m">4</span><span class="w">           </span><span class="m">0</span>.01<span class="w">        </span>1e+06<span class="w">       </span>1e-06<span class="w">       </span><span class="m">8</span>.16<span class="w">        </span><span class="m">1</span>.22549e+06<span class="w"> </span><span class="m">8</span>.16e-07
average<span class="w">     </span><span class="m">0</span>.004<span class="w">       </span>nan<span class="w">         </span>4e-07<span class="w">       </span><span class="m">7</span>.186<span class="w">       </span><span class="m">1</span>.40564e+06<span class="w"> </span><span class="m">7</span>.186e-07
stdev<span class="w">       </span><span class="m">0</span>.00489898<span class="w">  </span>nan<span class="w">         </span><span class="m">4</span>.89898e-07<span class="w"> </span><span class="m">0</span>.715866<span class="w">    </span><span class="m">141302</span><span class="w">      </span><span class="m">7</span>.15866e-08
</pre></div>
</div>
<p>Suppose we had to benchmark <cite>CalendarScheduler</cite> instead, we would have written</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>bench-scheduler<span class="w"> </span>--<span class="w"> </span>--runs<span class="o">=</span><span class="m">5</span><span class="w"> </span>--cal<span class="s2">&quot;</span>
</pre></div>
</div>
<p>And the output would look something like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bench-scheduler:<span class="w">  </span>Benchmark<span class="w"> </span>the<span class="w"> </span>simulator<span class="w"> </span>scheduler
<span class="w">  </span>Event<span class="w"> </span>population<span class="w"> </span>size:<span class="w">        </span><span class="m">10000</span>
<span class="w">  </span>Total<span class="w"> </span>events<span class="w"> </span>per<span class="w"> </span>run:<span class="w">         </span><span class="m">10000000</span>
<span class="w">  </span>Number<span class="w"> </span>of<span class="w"> </span>runs<span class="w"> </span>per<span class="w"> </span>scheduler:<span class="w"> </span><span class="m">5</span>
<span class="w">  </span>Event<span class="w"> </span><span class="nb">time</span><span class="w"> </span>distribution:<span class="w">      </span>default<span class="w"> </span>exponential

ns3::CalendarScheduler:<span class="w"> </span>insertion<span class="w"> </span>order:<span class="w"> </span>normal
Run<span class="w"> </span><span class="c1">#       Initialization:                     Simulation:</span>
Time<span class="w"> </span><span class="o">(</span>s<span class="o">)</span><span class="w">    </span>Rate<span class="w"> </span><span class="o">(</span>ev/s<span class="o">)</span><span class="w"> </span>Per<span class="w"> </span><span class="o">(</span>s/ev<span class="o">)</span><span class="w">  </span>Time<span class="w"> </span><span class="o">(</span>s<span class="o">)</span><span class="w">    </span>Rate<span class="w"> </span><span class="o">(</span>ev/s<span class="o">)</span><span class="w"> </span>Per<span class="w"> </span><span class="o">(</span>s/ev<span class="o">)</span>
-----------<span class="w"> </span>-----------<span class="w"> </span>-----------<span class="w"> </span>-----------<span class="w"> </span>-----------<span class="w"> </span>-----------<span class="w"> </span>-----------
prime<span class="w">       </span><span class="m">0</span>.01<span class="w">        </span>1e+06<span class="w">       </span>1e-06<span class="w">       </span><span class="m">8</span>.14<span class="w">        </span><span class="m">1</span>.2285e+06<span class="w">  </span><span class="m">8</span>.14e-07
<span class="m">0</span><span class="w">           </span><span class="m">0</span>.01<span class="w">        </span>1e+06<span class="w">       </span>1e-06<span class="w">       </span><span class="m">17</span>.14<span class="w">       </span><span class="m">583431</span><span class="w">      </span><span class="m">1</span>.714e-06
<span class="m">1</span><span class="w">           </span><span class="m">0</span>.02<span class="w">        </span><span class="m">500000</span><span class="w">      </span>2e-06<span class="w">       </span><span class="m">23</span>.33<span class="w">       </span><span class="m">428633</span><span class="w">      </span><span class="m">2</span>.333e-06
<span class="m">2</span><span class="w">           </span><span class="m">0</span>.02<span class="w">        </span><span class="m">500000</span><span class="w">      </span>2e-06<span class="w">       </span><span class="m">33</span>.2<span class="w">        </span><span class="m">301205</span><span class="w">      </span><span class="m">3</span>.32e-06
<span class="m">3</span><span class="w">           </span><span class="m">0</span>.03<span class="w">        </span><span class="m">333333</span><span class="w">      </span>3e-06<span class="w">       </span><span class="m">42</span>.98<span class="w">       </span><span class="m">232666</span><span class="w">      </span><span class="m">4</span>.298e-06
<span class="m">4</span><span class="w">           </span><span class="m">0</span>.05<span class="w">        </span><span class="m">200000</span><span class="w">      </span>5e-06<span class="w">       </span><span class="m">57</span>.1<span class="w">        </span><span class="m">175131</span><span class="w">      </span><span class="m">5</span>.71e-06
average<span class="w">     </span><span class="m">0</span>.026<span class="w">       </span><span class="m">506667</span><span class="w">      </span><span class="m">2</span>.6e-06<span class="w">     </span><span class="m">34</span>.75<span class="w">       </span><span class="m">344213</span><span class="w">      </span><span class="m">3</span>.475e-06
stdev<span class="w">       </span><span class="m">0</span>.0135647<span class="w">   </span><span class="m">271129</span><span class="w">      </span><span class="m">1</span>.35647e-06<span class="w"> </span><span class="m">14</span>.214<span class="w">      </span><span class="m">146446</span><span class="w">      </span><span class="m">1</span>.4214e-06
</pre></div>
</div>
</section>
</section>
</section>
<span id="document-support"></span><section id="support">
<h2><span class="section-number">6. </span>Support<a class="headerlink" href="#support" title="Link to this heading">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-enable-modules"></span><section id="enabling-subsets-of-ns3-modules">
<h3><span class="section-number">6.1. </span>Enabling Subsets of <em>ns-3</em> Modules<a class="headerlink" href="#enabling-subsets-of-ns3-modules" title="Link to this heading">¶</a></h3>
<p>As with most software projects, <em>ns-3</em> is ever growing larger in terms of number of modules, lines of code, and memory footprint.  Users, however, may only use a few of those modules at a time.  For this reason, users may want to explicitly enable only the subset of the possible <em>ns-3</em> modules that they actually need for their research.</p>
<p>This chapter discusses how to enable only the <em>ns-3</em> modules that you are interested in using.</p>
<section id="how-to-enable-a-subset-of-ns3-s-modules">
<h4><span class="section-number">6.1.1. </span>How to enable a subset of <em>ns-3</em>’s modules<a class="headerlink" href="#how-to-enable-a-subset-of-ns3-s-modules" title="Link to this heading">¶</a></h4>
<p>If shared libraries are being built, then enabling a module will cause at least one library to be built:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>libns3-modulename.so
</pre></div>
</div>
<p>If the module has a test library and test libraries are being built, then</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>libns3-modulename-test.so
</pre></div>
</div>
<p>will be built, too.  Other modules that the module depends on and their test libraries will also be built.</p>
<p>By default, all modules are built in <em>ns-3</em>.  There are two ways to enable a subset of these modules:</p>
<ol class="arabic simple">
<li><p>Using ns3’s –enable-modules option</p></li>
<li><p>Using the <em>ns-3</em> configuration file</p></li>
</ol>
<section id="enable-modules-using-ns3-s-enable-modules-option">
<h5><span class="section-number">6.1.1.1. </span>Enable modules using ns3’s –enable-modules option<a class="headerlink" href="#enable-modules-using-ns3-s-enable-modules-option" title="Link to this heading">¶</a></h5>
<p>To enable only the core module with example and tests, for example,
try these commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>clean
$<span class="w"> </span>./ns3<span class="w"> </span>configure<span class="w"> </span>--enable-examples<span class="w"> </span>--enable-tests<span class="w"> </span>--enable-modules<span class="o">=</span>core
$<span class="w"> </span>./ns3<span class="w"> </span>build
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>build/lib
$<span class="w"> </span>ls
</pre></div>
</div>
<p>and the following libraries should be present:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>libns3-core.so
libns3-core-test.so
</pre></div>
</div>
<p>Note the <code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">clean</span></code> step is done here only to make it more obvious which module libraries were built.  You don’t have to do <code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">clean</span></code> in order to enable subsets of modules.</p>
<p>Running test.py will cause only those tests that depend on module core to be run:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>24 of 24 tests passed (24 passed, 0 skipped, 0 failed, 0 crashed, 0 valgrind errors)
</pre></div>
</div>
<p>Repeat the above steps for the “network” module instead of the “core” module, and the following will be built, since network depends on core:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>libns3-core.so       libns3-network.so
libns3-core-test.so  libns3-network-test.so
</pre></div>
</div>
<p>Running test.py will cause those tests that depend on only the core and network modules to be run:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>31 of 31 tests passed (31 passed, 0 skipped, 0 failed, 0 crashed, 0 valgrind errors)
</pre></div>
</div>
</section>
<section id="enable-modules-using-the-ns3-configuration-file">
<h5><span class="section-number">6.1.1.2. </span>Enable modules using the <em>ns-3</em> configuration file<a class="headerlink" href="#enable-modules-using-the-ns3-configuration-file" title="Link to this heading">¶</a></h5>
<p>A configuration file, .ns3rc, has been added to <em>ns-3</em> that allows users to specify which modules are to be included in the build.</p>
<p>When enabling a subset of <em>ns-3</em> modules, the precedence rules are as follows:</p>
<ol class="arabic simple">
<li><p>the –enable-modules configure string overrides any .ns3rc file</p></li>
<li><p>the .ns3rc file in the top level <em>ns-3</em> directory is next consulted, if present</p></li>
<li><p>the system searches for ~/.ns3rc if the above two are unspecified</p></li>
</ol>
<p>If none of the above limits the modules to be built, all modules that CMake knows about will be built.</p>
<p>The maintained version of the .ns3rc file in the <em>ns-3</em> source code repository resides in the <code class="docutils literal notranslate"><span class="pre">utils</span></code> directory.  The reason for this is if it were in the top-level directory of the repository, it would be prone to accidental checkins from maintainers that enable the modules they want to use.  Therefore, users need to manually copy the .ns3rc from the <code class="docutils literal notranslate"><span class="pre">utils</span></code> directory to their preferred place (top level directory or their home directory) to enable persistent modular build configuration.</p>
<p>Assuming that you are in the top level <em>ns-3</em> directory, you can get a copy of the .ns3rc file that is in the <code class="docutils literal notranslate"><span class="pre">utils</span></code> directory as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cp<span class="w"> </span>utils/.ns3rc<span class="w"> </span>.
</pre></div>
</div>
<p>The .ns3rc file should now be in your top level <em>ns-3</em> directory, and it contains the following:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># A list of the modules that will be enabled when ns-3 is run.</span>
<span class="c"># Modules that depend on the listed modules will be enabled also.</span>
<span class="c">#</span>
<span class="c"># All modules can be enabled by emptying the list.</span>
<span class="c"># To list modules, append the modules separated by space or semicolon; e.g.:</span>
<span class="c"># set(ns3rc_enabled_modules core propagation)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_enabled_modules</span><span class="p">)</span>

<span class="c"># A list of the modules that will be disabled when ns-3 is run.</span>
<span class="c"># Modules that depend on the listed modules will be disabled also.</span>
<span class="c">#</span>
<span class="c"># If the list is empty, no module will be disabled.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_disabled_modules</span><span class="p">)</span>

<span class="c"># Set this equal to ON if you want examples to be run.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_examples_enabled</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>

<span class="c"># Set this equal to ON if you want tests to be run.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_tests_enabled</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>

<span class="c"># Override other ns-3 settings by setting their values below</span>
<span class="c"># Note: command-line settings will also be overridden.</span>
<span class="c">#set(NS3_LOG ON)</span>
</pre></div>
</div>
<p>Use your favorite editor to modify the .ns3rc file to only enable the core module with examples and tests like this:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># A list of the modules that will be enabled when ns-3 is run.</span>
<span class="c"># Modules that depend on the listed modules will be enabled also.</span>
<span class="c">#</span>
<span class="c"># All modules can be enabled by emptying the list.</span>
<span class="c"># To list modules, append the modules separated by space or semicolon; e.g.:</span>
<span class="c"># set(ns3rc_enabled_modules core propagation)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_enabled_modules</span><span class="w"> </span><span class="s">core</span><span class="p">)</span>

<span class="c"># A list of the modules that will be disabled when ns-3 is run.</span>
<span class="c"># Modules that depend on the listed modules will be disabled also.</span>
<span class="c">#</span>
<span class="c"># If the list is empty, no module will be disabled.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_disabled_modules</span><span class="p">)</span>

<span class="c"># Set this equal to ON if you want examples to be run.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_examples_enabled</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>

<span class="c"># Set this equal to ON if you want tests to be run.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_tests_enabled</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>

<span class="c"># Override other ns-3 settings by setting their values below</span>
<span class="c"># Note: command-line settings will also be overridden.</span>
<span class="c">#set(NS3_LOG ON)</span>
</pre></div>
</div>
<p>Only the core module will be enabled now if you try these commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>clean
$<span class="w"> </span>./ns3<span class="w"> </span>configure
$<span class="w"> </span>./ns3<span class="w"> </span>build
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>build/lib/
$<span class="w"> </span>ls
</pre></div>
</div>
<p>and the following libraries should be present:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>libns3-core.so
libns3-core-test.so
</pre></div>
</div>
<p>Note the <code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">clean</span></code> step is done here only to make it more obvious which module libraries were built.  You don’t have to do <code class="docutils literal notranslate"><span class="pre">./ns3</span> <span class="pre">clean</span></code> in order to enable subsets of modules.</p>
<p>Running test.py will cause only those tests that depend on module core to be run:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>24 of 24 tests passed (24 passed, 0 skipped, 0 failed, 0 crashed, 0 valgrind errors)
</pre></div>
</div>
<p>Repeat the above steps for the “network” module instead of the “core” module, and the following will be built, since network depends on core:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>libns3-core.so       libns3-network.so
libns3-core-test.so  libns3-network-test.so
</pre></div>
</div>
<p>Running test.py will cause those tests that depend on only the core and network modules to be run:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>31 of 31 tests passed (31 passed, 0 skipped, 0 failed, 0 crashed, 0 valgrind errors)
</pre></div>
</div>
<p>As the comment in the sample <code class="docutils literal notranslate"><span class="pre">.ns3rc</span></code> file suggests, users may list multiple enabled modules by
separating each requested module by space or semicolon; e.g.:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_enabled_modules</span><span class="w"> </span><span class="s">core</span><span class="w"> </span><span class="s">propagation</span><span class="p">)</span>
</pre></div>
</div>
<p>The following also works (but note that a comma delimiter will not work with this CMake list):</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_enabled_modules</span><span class="w"> </span><span class="s">core;propagation</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
<span id="document-enable-tests"></span><section id="enabling-disabling-ns3-tests-and-examples">
<h3><span class="section-number">6.2. </span>Enabling/disabling <em>ns-3</em> Tests and Examples<a class="headerlink" href="#enabling-disabling-ns3-tests-and-examples" title="Link to this heading">¶</a></h3>
<p>The <em>ns-3</em> distribution includes many examples and tests that are used to validate the <em>ns-3</em> system.  Users, however, may not always want these examples and tests to be run for their installation of <em>ns-3</em>.</p>
<p>This chapter discusses how to build <em>ns-3</em> with or without its examples and tests.</p>
<section id="how-to-enable-disable-examples-and-tests-in-ns3">
<h4><span class="section-number">6.2.1. </span>How to enable/disable examples and tests in <em>ns-3</em><a class="headerlink" href="#how-to-enable-disable-examples-and-tests-in-ns3" title="Link to this heading">¶</a></h4>
<p>There are 3 ways to enable/disable examples and tests in <em>ns-3</em>:</p>
<ol class="arabic simple">
<li><p>Using build.py when <em>ns-3</em> is built for the first time</p></li>
<li><p>Using ns3 once <em>ns-3</em> has been built</p></li>
<li><p>Using the <em>ns-3</em> configuration file once <em>ns-3</em> has been built</p></li>
</ol>
<section id="enable-disable-examples-and-tests-using-build-py">
<h5><span class="section-number">6.2.1.1. </span>Enable/disable examples and tests using build.py<a class="headerlink" href="#enable-disable-examples-and-tests-using-build-py" title="Link to this heading">¶</a></h5>
<p>You can use build.py to enable/disable examples and tests when <em>ns-3</em> is built for the first time.</p>
<p>By default, examples and tests are not built in <em>ns-3</em>.</p>
<p>From the ns-3-allinone directory, you can build <em>ns-3</em> without any
examples or tests simply by doing:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./build.py
</pre></div>
</div>
<p>Running test.py in the top level <em>ns-3</em> directory now will cause no examples or tests to be run:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>0 of 0 tests passed (0 passed, 0 skipped, 0 failed, 0 crashed, 0 valgrind errors)
</pre></div>
</div>
<p>If you would like build <em>ns-3</em> with examples and tests, then do the following from the ns-3-allinone directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./build.py<span class="w"> </span>--enable-examples<span class="w"> </span>--enable-tests
</pre></div>
</div>
<p>Running test.py in the top level <em>ns-3</em> directory will cause all of the examples and tests to be run:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>170 of 170 tests passed (170 passed, 0 skipped, 0 failed, 0 crashed, 0 valgrind errors)
</pre></div>
</div>
</section>
<section id="enable-disable-examples-and-tests-using-ns3">
<h5><span class="section-number">6.2.1.2. </span>Enable/disable examples and tests using ns3<a class="headerlink" href="#enable-disable-examples-and-tests-using-ns3" title="Link to this heading">¶</a></h5>
<p>You can use ns3 to enable/disable examples and tests once <em>ns-3</em> has been built.</p>
<p>By default, examples and tests are not built in <em>ns-3</em>.</p>
<p>From the top level <em>ns-3</em> directory, you can build <em>ns-3</em> without any
examples or tests simply by doing:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>configure
$<span class="w"> </span>./ns3<span class="w"> </span>build
</pre></div>
</div>
<p>Running test.py now will cause no examples or tests to be run:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>0 of 0 tests passed (0 passed, 0 skipped, 0 failed, 0 crashed, 0 valgrind errors)
</pre></div>
</div>
<p>If you would like build <em>ns-3</em> with examples and tests, then do the following from the top level <em>ns-3</em> directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>configure<span class="w"> </span>--enable-examples<span class="w"> </span>--enable-tests
$<span class="w"> </span>./ns3<span class="w"> </span>build
</pre></div>
</div>
<p>Running test.py will cause all of the examples and tests to be run:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>170 of 170 tests passed (170 passed, 0 skipped, 0 failed, 0 crashed, 0 valgrind errors)
</pre></div>
</div>
</section>
<section id="enable-disable-examples-and-tests-using-the-ns3-configuration-file">
<h5><span class="section-number">6.2.1.3. </span>Enable/disable examples and tests using the <em>ns-3</em> configuration file<a class="headerlink" href="#enable-disable-examples-and-tests-using-the-ns3-configuration-file" title="Link to this heading">¶</a></h5>
<p>A configuration file, .ns3rc, has been added to <em>ns-3</em> that allows users to specify whether examples and tests should be built or not.  You can use this file to enable/disable examples and tests once <em>ns-3</em> has been built.</p>
<p>When enabling disabling examples and tests, the precedence rules are as follows:</p>
<ol class="arabic simple">
<li><p>the –enable-examples/–disable-examples configure strings override any .ns3rc file</p></li>
<li><p>the –enable-tests/–disable-tests configure strings override any .ns3rc file</p></li>
<li><p>the .ns3rc file in the top level <em>ns-3</em> directory is next consulted, if present</p></li>
<li><p>the system searches for ~/.ns3rc if the .ns3rc file was not found in the previous step</p></li>
</ol>
<p>If none of the above exists, then examples and tests will not be built.</p>
<p>The maintained version of the .ns3rc file in the <em>ns-3</em> source code repository resides in the <code class="docutils literal notranslate"><span class="pre">utils</span></code> directory.  The reason for this is if it were in the top-level directory of the repository, it would be prone to accidental checkins from maintainers that enable the modules they want to use.  Therefore, users need to manually copy the .ns3rc from the <code class="docutils literal notranslate"><span class="pre">utils</span></code> directory to their preferred place (top level directory or their home directory) to enable persistent enabling of examples and tests.</p>
<p>Assuming that you are in the top level <em>ns-3</em> directory, you can get a copy of the .ns3rc file that is in the <code class="docutils literal notranslate"><span class="pre">utils</span></code> directory as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cp<span class="w"> </span>utils/.ns3rc<span class="w"> </span>.
</pre></div>
</div>
<p>The .ns3rc file should now be in your top level <em>ns-3</em> directory, and it contains the following:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># A list of the modules that will be enabled when ns-3 is run.</span>
<span class="c"># Modules that depend on the listed modules will be enabled also.</span>
<span class="c">#</span>
<span class="c"># All modules can be enabled by emptying the list.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_enabled_modules</span><span class="p">)</span>

<span class="c"># A list of the modules that will be disabled when ns-3 is run.</span>
<span class="c"># Modules that depend on the listed modules will be disabled also.</span>
<span class="c">#</span>
<span class="c"># If the list is empty, no module will be disabled.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_disabled_modules</span><span class="p">)</span>

<span class="c"># Set this equal to ON if you want examples to be run.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_examples_enabled</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>

<span class="c"># Set this equal to ON if you want tests to be run.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_tests_enabled</span><span class="w"> </span><span class="s">OFF</span><span class="p">)</span>

<span class="c"># Override other ns-3 settings by setting their values below</span>
<span class="c"># Note: command-line settings will also be overridden.</span>
<span class="c">#set(NS3_LOG ON)</span>
</pre></div>
</div>
<p>From the top level <em>ns-3</em> directory, you can build <em>ns-3</em> without any
examples or tests simply by doing:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>configure
$<span class="w"> </span>./ns3<span class="w"> </span>build
</pre></div>
</div>
<p>Running test.py now will cause no examples or tests to be run:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>0 of 0 tests passed (0 passed, 0 skipped, 0 failed, 0 crashed, 0 valgrind errors)
</pre></div>
</div>
<p>If you would like build <em>ns-3</em> with examples and tests, use your
favorite editor to change the values in the .ns3rc file for
ns3rc_examples_enabled and ns3rc_tests_enabled file to be True:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># A list of the modules that will be enabled when ns-3 is run.</span>
<span class="c"># Modules that depend on the listed modules will be enabled also.</span>
<span class="c">#</span>
<span class="c"># All modules can be enabled by emptying the list.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_enabled_modules</span><span class="p">)</span>

<span class="c"># A list of the modules that will be disabled when ns-3 is run.</span>
<span class="c"># Modules that depend on the listed modules will be disabled also.</span>
<span class="c">#</span>
<span class="c"># If the list is empty, no module will be disabled.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_disabled_modules</span><span class="p">)</span>

<span class="c"># Set this equal to ON if you want examples to be run.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_examples_enabled</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>

<span class="c"># Set this equal to ON if you want tests to be run.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_tests_enabled</span><span class="w"> </span><span class="s">ON</span><span class="p">)</span>

<span class="c"># Override other ns-3 settings by setting their values below</span>
<span class="c"># Note: command-line settings will also be overridden.</span>
<span class="c">#set(NS3_LOG ON)</span>
</pre></div>
</div>
<p>From the top level <em>ns-3</em> directory, you can build <em>ns-3</em> with examples
and tests simply by doing:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>configure
$<span class="w"> </span>./ns3<span class="w"> </span>build
</pre></div>
</div>
<p>Running test.py will cause all of the examples and tests to be run:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>170 of 170 tests passed (170 passed, 0 skipped, 0 failed, 0 crashed, 0 valgrind errors)
</pre></div>
</div>
</section>
<section id="enable-examples-and-tests-that-depend-on-a-set-of-modules-using-ns3">
<h5><span class="section-number">6.2.1.4. </span>Enable examples and tests that depend on a set of modules using <em>ns-3</em><a class="headerlink" href="#enable-examples-and-tests-that-depend-on-a-set-of-modules-using-ns3" title="Link to this heading">¶</a></h5>
<p>As seen above, the following command only builds the requested modules (core and wifi),
plus any modules that are implicitly needed (e.g., network), and the resulting compatible examples and tests:</p>
<div class="highlight-terminal notranslate"><div class="highlight"><pre><span></span>./ns3 configure --enable-modules=&quot;wifi;core&quot; --enable-examples --enable-tests
</pre></div>
</div>
<p>However, when developing a new module, you may prefer to use the following alternative, which builds
all module libraries, but will filter out any examples and tests from modules that are not explicitly listed.</p>
<div class="highlight-terminal notranslate"><div class="highlight"><pre><span></span>./ns3 configure --filter-module-examples-and-tests=&quot;wifi;core&quot; --enable-examples --enable-tests
</pre></div>
</div>
<p>The first command will generally lead to a shorter build time, but the second option will provide better
coverage, by building additional test cases and examples directly related to the specified modules.</p>
</section>
<section id="enable-examples-and-tests-that-depend-on-a-set-of-modules-using-the-ns3-configuration-file">
<h5><span class="section-number">6.2.1.5. </span>Enable examples and tests that depend on a set of modules using the <em>ns-3</em> configuration file<a class="headerlink" href="#enable-examples-and-tests-that-depend-on-a-set-of-modules-using-the-ns3-configuration-file" title="Link to this heading">¶</a></h5>
<p>As seen above, examples and tests can be enabled for just a subset of the available modules via the
<code class="docutils literal notranslate"><span class="pre">ns3</span></code> script. The same can be accomplished via the <code class="docutils literal notranslate"><span class="pre">.ns3rc</span></code> configuration file.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># A list of the modules that will be enabled when ns-3 is run.</span>
<span class="c"># Modules that depend on the listed modules will be enabled also.</span>
<span class="c">#</span>
<span class="c"># All modules can be enabled by emptying the list.</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ns3rc_enabled_modules</span><span class="p">)</span>

<span class="c"># ...</span>

<span class="c"># Override other ns-3 settings by setting their values below</span>
<span class="c"># Note: command-line settings will also be overridden.</span>
<span class="c">#set(NS3_LOG ON)</span>

<span class="c"># The following will build core and wifi tests, plus their examples</span>
<span class="c"># and examples on /ns-3-dev/examples that depend on either of them</span>
<span class="nb">set</span><span class="p">(</span><span class="s">NS3_FILTER_MODULE_EXAMPLES_AND_TESTS</span><span class="w"> </span><span class="s">wifi</span><span class="w"> </span><span class="s">core</span><span class="p">)</span><span class="w"> </span><span class="c"># &lt;==</span>
</pre></div>
</div>
</section>
</section>
</section>
<span id="document-troubleshoot"></span><section id="troubleshooting">
<h3><span class="section-number">6.3. </span>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading">¶</a></h3>
<p>This chapter posts some information about possibly common errors in building
or running <em>ns-3</em> programs.</p>
<p>Please note that the wiki
(<a class="reference external" href="http://www.nsnam.org/wiki/Troubleshooting">http://www.nsnam.org/wiki/Troubleshooting</a>) may have contributed
items.</p>
<section id="build-errors">
<h4><span class="section-number">6.3.1. </span>Build errors<a class="headerlink" href="#build-errors" title="Link to this heading">¶</a></h4>
</section>
<section id="run-time-errors">
<h4><span class="section-number">6.3.2. </span>Run-time errors<a class="headerlink" href="#run-time-errors" title="Link to this heading">¶</a></h4>
<p>Sometimes, errors can occur with a program after a successful build. These are
run-time errors, and can commonly occur when memory is corrupted or pointer
values are unexpectedly null.</p>
<p>Here is an example of what might occur:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>tcp-point-to-point
Entering<span class="w"> </span>directory<span class="w"> </span><span class="s1">&#39;/home/tomh/ns-3-nsc/build&#39;</span>
Compilation<span class="w"> </span>finished<span class="w"> </span>successfully
Command<span class="w"> </span><span class="o">[</span><span class="s1">&#39;/home/tomh/ns-3-nsc/build/debug/examples/tcp-point-to-point&#39;</span><span class="o">]</span><span class="w"> </span>exited<span class="w"> </span>with<span class="w"> </span>code<span class="w"> </span>-11
</pre></div>
</div>
<p>The error message says that the program terminated unsuccessfuly, but it is
not clear from this information what might be wrong. To examine more
closely, try running it under the <a class="reference external" href="https://access.redhat.com/documentation/en-us/red_hat_developer_toolset/9/html/user_guide/chap-gdb">gdb debugger</a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>tcp-point-to-point<span class="w"> </span>--gdb
Entering<span class="w"> </span>directory<span class="w"> </span><span class="s1">&#39;/home/tomh/ns-3-nsc/build&#39;</span>
Compilation<span class="w"> </span>finished<span class="w"> </span>successfully
GNU<span class="w"> </span>gdb<span class="w"> </span>Red<span class="w"> </span>Hat<span class="w"> </span>Linux<span class="w"> </span><span class="o">(</span><span class="m">6</span>.3.0.0-1.134.fc5rh<span class="o">)</span>
Copyright<span class="w"> </span><span class="m">2004</span><span class="w"> </span>Free<span class="w"> </span>Software<span class="w"> </span>Foundation,<span class="w"> </span>Inc.
GDB<span class="w"> </span>is<span class="w"> </span>free<span class="w"> </span>software,<span class="w"> </span>covered<span class="w"> </span>by<span class="w"> </span>the<span class="w"> </span>GNU<span class="w"> </span>General<span class="w"> </span>Public<span class="w"> </span>License,<span class="w"> </span>and<span class="w"> </span>you<span class="w"> </span>are
welcome<span class="w"> </span>to<span class="w"> </span>change<span class="w"> </span>it<span class="w"> </span>and/or<span class="w"> </span>distribute<span class="w"> </span>copies<span class="w"> </span>of<span class="w"> </span>it<span class="w"> </span>under<span class="w"> </span>certain<span class="w"> </span>conditions.
Type<span class="w"> </span><span class="s2">&quot;show copying&quot;</span><span class="w"> </span>to<span class="w"> </span>see<span class="w"> </span>the<span class="w"> </span>conditions.
There<span class="w"> </span>is<span class="w"> </span>absolutely<span class="w"> </span>no<span class="w"> </span>warranty<span class="w"> </span><span class="k">for</span><span class="w"> </span>GDB.<span class="w">  </span>Type<span class="w"> </span><span class="s2">&quot;show warranty&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>details.
This<span class="w"> </span>GDB<span class="w"> </span>was<span class="w"> </span>configured<span class="w"> </span>as<span class="w"> </span><span class="s2">&quot;i386-redhat-linux-gnu&quot;</span>...Using<span class="w"> </span>host<span class="w"> </span>libthread_db
library<span class="w"> </span><span class="s2">&quot;/lib/libthread_db.so.1&quot;</span>.

<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>run
Starting<span class="w"> </span>program:<span class="w"> </span>/home/tomh/ns-3-nsc/build/debug/examples/tcp-point-to-point
Reading<span class="w"> </span>symbols<span class="w"> </span>from<span class="w"> </span>shared<span class="w"> </span>object<span class="w"> </span><span class="nb">read</span><span class="w"> </span>from<span class="w"> </span>target<span class="w"> </span>memory...done.
Loaded<span class="w"> </span>system<span class="w"> </span>supplied<span class="w"> </span>DSO<span class="w"> </span>at<span class="w"> </span>0xf5c000

Program<span class="w"> </span>received<span class="w"> </span>signal<span class="w"> </span>SIGSEGV,<span class="w"> </span>Segmentation<span class="w"> </span>fault.
0x0804aa12<span class="w"> </span><span class="k">in</span><span class="w"> </span>main<span class="w"> </span><span class="o">(</span><span class="nv">argc</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">argv</span><span class="o">=</span>0xbfdfefa4<span class="o">)</span>
<span class="w">    </span>at<span class="w"> </span>../examples/tcp-point-to-point.cc:136
<span class="m">136</span><span class="w">       </span>Ptr&lt;Socket&gt;<span class="w"> </span><span class="nv">localSocket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>socketFactory-&gt;CreateSocket<span class="o">()</span><span class="p">;</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>localSocket
<span class="nv">$1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="nv">m_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x3c5d65<span class="o">}</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>p<span class="w"> </span>socketFactory
<span class="nv">$2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="nv">m_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0x0<span class="o">}</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>quit
The<span class="w"> </span>program<span class="w"> </span>is<span class="w"> </span>running.<span class="w">  </span>Exit<span class="w"> </span>anyway?<span class="w"> </span><span class="o">(</span>y<span class="w"> </span>or<span class="w"> </span>n<span class="o">)</span><span class="w"> </span>y
</pre></div>
</div>
<p>Note first the way the program was invoked– pass the command to run as an
argument to the command template “gdb %s”.</p>
<p>This tells us that there was an attempt to dereference a null pointer
socketFactory.</p>
<p>Let’s look around line 136 of tcp-point-to-point, as gdb suggests:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Ptr</span><span class="o">&lt;</span><span class="n">SocketFactory</span><span class="o">&gt;</span><span class="w"> </span><span class="n">socketFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n2</span><span class="o">-&gt;</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">SocketFactory</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Tcp</span><span class="o">::</span><span class="n">iid</span><span class="p">);</span>
<span class="n">Ptr</span><span class="o">&lt;</span><span class="n">Socket</span><span class="o">&gt;</span><span class="w"> </span><span class="n">localSocket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socketFactory</span><span class="o">-&gt;</span><span class="n">CreateSocket</span><span class="p">();</span>
<span class="n">localSocket</span><span class="o">-&gt;</span><span class="n">Bind</span><span class="p">();</span>
</pre></div>
</div>
<p>The culprit here is that the return value of GetObject is not being checked and
may be null.</p>
<p>Sometimes you may need to use the <a class="reference external" href="http://valgrind.org">valgrind memory checker</a> for more subtle errors. Again, you invoke the use of
valgrind similarly:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./ns3<span class="w"> </span>run<span class="w"> </span>tcp-point-to-point<span class="w"> </span>--valgrind
</pre></div>
</div>
</section>
</section>
</div>
</section>
</div>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="#">Table of Contents</a></h3>
    <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-organization">1. Organization</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-simulator">2. Simulator</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-events">2.1. Events and Simulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-callbacks">2.2. Callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-object-model">2.3. Object model</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-attributes">2.4. Configuration and Attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-object-names">2.5. Object names</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-realtime">2.6. RealTime</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-features">3. Additional Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-random-variables">3.1. Random Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-hash-functions">3.2. Hash Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-tracing">3.3. Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-data-collection">3.4. Data Collection</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-statistics">3.5. Statistical Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-helpers">3.6. Helpers</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-gnuplot">3.7. Making Plots using the Gnuplot Class</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-python">3.8. Using Python to Run <em>ns-3</em></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-develop">4. Developer Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-working-with-git">4.1. Working with Git as a user</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#working-with-git-as-a-maintainer">4.2. Working with Git as a maintainer</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-working-with-cmake">4.3. Working with CMake</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-logging-asserts">4.4. Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-tests">4.5. Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-new-models">4.6. Creating a new <em>ns-3</em> model</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-new-modules">4.7. Adding a New Module to <em>ns-3</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-documentation">4.8. Creating Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-profiling">4.9. Profiling</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-working-with-gitlab-ci-local">4.10. Working with gitlab-ci-local</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-utilities">5. Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#print-introspected-doxygen">5.1. Print-introspected-doxygen</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#bench-scheduler">5.2. bench-scheduler</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-support">6. Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-enable-modules">6.1. Enabling Subsets of <em>ns-3</em> Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-enable-tests">6.2. Enabling/disabling <em>ns-3</em> Tests and Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-troubleshoot">6.3. Troubleshooting</a></li>
</ul>
</li>
</ul>

  </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
    <li class="navelem"><a href="">ns-3</a><span class="navelem">&nbsp;</span></li>
    
        <li class="nav-item nav-item-0"><a href="#">Manual</a><span class="navelem">&nbsp;</span></li>

        <li class="nav-item nav-item-this"><a href="">Manual</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2006-2019.
      Last updated on Nov 29, 2023 13:25.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>